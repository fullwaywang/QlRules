/**
 * @name linux-9c52057c698fb96f8f07e7a4bcf4801a092bda89-btrfs_mksubvol
 * @id cpp/linux/9c52057c698fb96f8f07e7a4bcf4801a092bda89/btrfs-mksubvol
 * @description linux-9c52057c698fb96f8f07e7a4bcf4801a092bda89-fs/btrfs/ioctl.c-btrfs_mksubvol CVE-2012-5374
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vname_689, Parameter vnamelen_689, Variable vdir_694, Variable verror_696, ExprStmt target_2, ExprStmt target_3, ExprStmt target_4, FunctionCall target_5, IfStmt target_6, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_696
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("btrfs_check_dir_item_collision")
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="root"
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("BTRFS_I")
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdir_694
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="i_ino"
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdir_694
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vname_689
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnamelen_689
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_5.getArgument(0).(VariableAccess).getLocation())
		and target_6.getCondition().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vname_689, Parameter vnamelen_689, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("dentry *")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("lookup_one_len")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vname_689
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="dentry"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("path *")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vnamelen_689
}

predicate func_3(Parameter vname_689, Parameter vnamelen_689, Variable verror_696, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_696
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("create_snapshot")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("btrfs_root *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("dentry *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vname_689
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnamelen_689
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("u64 *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("bool")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget().getType().hasName("btrfs_qgroup_inherit **")
}

predicate func_4(Variable vdir_694, Variable verror_696, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_696
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("btrfs_may_create")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdir_694
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("dentry *")
}

predicate func_5(Variable vdir_694, FunctionCall target_5) {
		target_5.getTarget().hasName("BTRFS_I")
		and target_5.getArgument(0).(VariableAccess).getTarget()=vdir_694
		and target_5.getParent().(PointerFieldAccess).getParent().(PointerFieldAccess).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("down_read")
}

predicate func_6(Variable verror_696, IfStmt target_6) {
		target_6.getCondition().(VariableAccess).getTarget()=verror_696
}

from Function func, Parameter vname_689, Parameter vnamelen_689, Variable vdir_694, Variable verror_696, ExprStmt target_2, ExprStmt target_3, ExprStmt target_4, FunctionCall target_5, IfStmt target_6
where
not func_0(vname_689, vnamelen_689, vdir_694, verror_696, target_2, target_3, target_4, target_5, target_6, func)
and func_2(vname_689, vnamelen_689, target_2)
and func_3(vname_689, vnamelen_689, verror_696, target_3)
and func_4(vdir_694, verror_696, target_4)
and func_5(vdir_694, target_5)
and func_6(verror_696, target_6)
and vname_689.getType().hasName("char *")
and vnamelen_689.getType().hasName("int")
and vdir_694.getType().hasName("inode *")
and verror_696.getType().hasName("int")
and vname_689.getFunction() = func
and vnamelen_689.getFunction() = func
and vdir_694.(LocalVariable).getFunction() = func
and verror_696.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
