/**
 * @name linux-742ab6df974ae8384a2dd213db1a3a06cf6d8936-vmx_enable_fb_clear
 * @id cpp/linux/742ab6df974ae8384a2dd213db1a3a06cf6d8936/vmx-enable-fb-clear
 * @description linux-742ab6df974ae8384a2dd213db1a3a06cf6d8936-arch/x86/kvm/vmx/vmx.c-vmx_enable_fb_clear CVE-2022-23816
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvmx_393, FunctionCall target_0) {
	target_0.getTarget().hasName("wrmsrl")
	and not target_0.getTarget().hasName("__wrmsr")
	and target_0.getArgument(0).(Literal).getValue()="291"
	and target_0.getArgument(1).(PointerFieldAccess).getTarget().getName()="msr_ia32_mcu_opt_ctrl"
	and target_0.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmx_393
}

predicate func_1(Parameter vvmx_393) {
exists(BinaryBitwiseOperation target_1 |
	target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="msr_ia32_mcu_opt_ctrl"
	and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmx_393
	and target_1.getRightOperand().(Literal).getValue()="32"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall)
}

from Function func, Parameter vvmx_393, FunctionCall target_0
where
func_0(vvmx_393, target_0)
and not func_1(vvmx_393)
and vvmx_393.getType().hasName("vcpu_vmx *")
and vvmx_393.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
