/**
 * @name linux-182d679b2298d62bf42bb14b12a8067b8e17b617-joydev_handle_JSIOCSBTNMAP
 * @id cpp/linux/182d679b2298d62bf42bb14b12a8067b8e17b617/joydev-handle-jsiocsbtnmap
 * @description linux-182d679b2298d62bf42bb14b12a8067b8e17b617-drivers/input/joydev.c-joydev_handle_JSIOCSBTNMAP CVE-2021-3612
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlen_477, ExprStmt target_3, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(RemExpr).getLeftOperand().(VariableAccess).getTarget()=vlen_477
	and target_0.getCondition().(RemExpr).getRightOperand().(SizeofExprOperator).getValue()="2"
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_3.getLocation()))
}

predicate func_1(Parameter vlen_477, Variable vi_480, Parameter vjoydev_476, BlockStmt target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, RelationalOperation target_2) {
exists(LogicalAndExpr target_1 |
	target_1.getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_480
	and target_1.getLeftOperand().(RelationalOperation).getGreaterOperand().(DivExpr).getLeftOperand().(VariableAccess).getTarget()=vlen_477
	and target_1.getLeftOperand().(RelationalOperation).getGreaterOperand().(DivExpr).getRightOperand().(Literal).getValue()="2"
	and target_1.getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_480
	and target_1.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nkey"
	and target_1.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjoydev_476
	and target_1.getParent().(ForStmt).getStmt()=target_4
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_1.getLeftOperand().(RelationalOperation).getGreaterOperand().(DivExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_1.getLeftOperand().(RelationalOperation).getGreaterOperand().(DivExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_6.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
	and target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
	and target_1.getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_2.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_2(Variable vi_480, Parameter vjoydev_476, BlockStmt target_4, RelationalOperation target_2) {
	 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
	and target_2.getLesserOperand().(VariableAccess).getTarget()=vi_480
	and target_2.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nkey"
	and target_2.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjoydev_476
	and target_2.getParent().(ForStmt).getStmt()=target_4
}

predicate func_3(Parameter vlen_477, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_477
	and target_3.getExpr().(AssignExpr).getRValue().(BuiltInChooseExpr).getChild(0).(LogicalAndExpr).getValue()="0"
	and target_3.getExpr().(AssignExpr).getRValue().(BuiltInChooseExpr).getChild(1).(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vlen_477
	and target_3.getExpr().(AssignExpr).getRValue().(BuiltInChooseExpr).getChild(1).(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(SizeofExprOperator).getValue()="1024"
	and target_3.getExpr().(AssignExpr).getRValue().(BuiltInChooseExpr).getChild(1).(ConditionalExpr).getThen().(VariableAccess).getTarget()=vlen_477
	and target_3.getExpr().(AssignExpr).getRValue().(BuiltInChooseExpr).getChild(1).(ConditionalExpr).getElse().(SizeofExprOperator).getValue()="1024"
}

predicate func_4(Variable vi_480, BlockStmt target_4) {
	target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("__u16 *")
	and target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_480
	and target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="767"
	and target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("__u16 *")
	and target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_480
	and target_4.getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="256"
	and target_4.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_4.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_4.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out"
}

predicate func_5(Parameter vlen_477, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("__u16 *")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("memdup_user")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("void *")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlen_477
}

predicate func_6(Parameter vlen_477, Parameter vjoydev_476, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_6.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="keypam"
	and target_6.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjoydev_476
	and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("__u16 *")
	and target_6.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vlen_477
}

predicate func_7(Variable vi_480, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_480
	and target_7.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

from Function func, Parameter vlen_477, Variable vi_480, Parameter vjoydev_476, RelationalOperation target_2, ExprStmt target_3, BlockStmt target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7
where
not func_0(vlen_477, target_3, func)
and not func_1(vlen_477, vi_480, vjoydev_476, target_4, target_5, target_6, target_7, target_2)
and func_2(vi_480, vjoydev_476, target_4, target_2)
and func_3(vlen_477, target_3)
and func_4(vi_480, target_4)
and func_5(vlen_477, target_5)
and func_6(vlen_477, vjoydev_476, target_6)
and func_7(vi_480, target_7)
and vlen_477.getType().hasName("size_t")
and vi_480.getType().hasName("int")
and vjoydev_476.getType().hasName("joydev *")
and vlen_477.getFunction() = func
and vi_480.(LocalVariable).getFunction() = func
and vjoydev_476.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
