commit 313891e4ee57cf42d1ae46a0de1cef6e3f607070	313891e4ee57cf42d1ae46a0de1cef6e3f607070
Author: Zelin Liu <zelin@chromium.org>
Date:   Wed Jul 19 01:36:43 2023 +0000

    Create browser test to use frame origin instead of URL
    
    RFH GetLastCommittedOrigin() is not always the origin of
    GetLastCommittedUrl(). In the case of a pop up window. The origin will
    be the parent's origin, but URL will be initialized to about::blank.
    
    In this CL, we add a test to ensure CreateChooserTitle uses the frame's
    origin instead of URL. This test is done using a browsertest as it is
    difficult to recreate this scenario in a unit test setup.
    
    Bug: 1459281
    Change-Id: If6d92760f30d09c704ec6f78f6aa531b6f12d7e8
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4692263
    Reviewed-by: Reilly Grant <reillyg@chromium.org>
    Commit-Queue: Zelin Liu <zelin@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1172114}

diff --git a/chrome/browser/chooser_controller/title_util_browsertest.cc b/chrome/browser/chooser_controller/title_util_browsertest.cc
new file mode 100644
index 0000000000000..20c0d4a1b80f2
--- /dev/null
+++ b/chrome/browser/chooser_controller/title_util_browsertest.cc
@@ -0,0 +1,65 @@
+// Copyright 2023 The Chromium Authors
+// Use of this source code is governed by a BSD-style license that can be
+// found in the LICENSE file.
+
+#include "chrome/browser/chooser_controller/title_util.h"
+
+#include "base/files/file_path.h"
+#include "base/strings/strcat.h"
+#include "chrome/browser/ui/browser.h"
+#include "chrome/browser/ui/test/popup_test_base.h"
+#include "components/strings/grit/components_strings.h"
+#include "components/url_formatter/elide_url.h"
+#include "content/public/browser/render_frame_host.h"
+#include "content/public/test/browser_test.h"
+#include "net/test/embedded_test_server/embedded_test_server.h"
+#include "url/origin.h"
+
+constexpr int kTitleResourceId = IDS_USB_DEVICE_CHOOSER_PROMPT;
+
+class CreateChooserTitlePopUpBrowserTest
+    : public PopupTestBase,
+      public ::testing::WithParamInterface<bool> {
+ protected:
+  void SetUp() override {
+    server_ = std::make_unique<net::EmbeddedTestServer>(
+        net::EmbeddedTestServer::TYPE_HTTPS);
+    base::FilePath server_root(FILE_PATH_LITERAL("chrome/test/data"));
+    server_->AddDefaultHandlers(server_root);
+    CHECK(server_->Start());
+    PopupTestBase::SetUp();
+  }
+
+  net::EmbeddedTestServer* server() { return server_.get(); }
+
+ private:
+  std::unique_ptr<net::EmbeddedTestServer> server_;
+};
+
+GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST(
+    CreateChooserTitlePopUpBrowserTest);
+
+IN_PROC_BROWSER_TEST_F(CreateChooserTitlePopUpBrowserTest,
+                       DISABLED_UseOriginNotUrl) {
+  ASSERT_TRUE(
+      NavigateToURL(browser()->tab_strip_model()->GetActiveWebContents(),
+                    server()->GetURL("/simple.html")));
+
+  std::string script("open('', '_blank', 'popup,fullscreen')");
+  Browser* popup_browser = OpenPopup(browser(), script);
+  ASSERT_TRUE(popup_browser);
+  content::RenderFrameHost* rfh = popup_browser->tab_strip_model()
+                                      ->GetActiveWebContents()
+                                      ->GetPrimaryMainFrame();
+  ASSERT_TRUE(rfh);
+
+  EXPECT_EQ(rfh->GetLastCommittedOrigin(), server()->GetOrigin());
+  EXPECT_TRUE(rfh->GetLastCommittedURL().IsAboutBlank());
+
+  std::u16string expected_string =
+      base::StrCat({url_formatter::FormatOriginForSecurityDisplay(
+                        server()->GetOrigin(),
+                        url_formatter::SchemeDisplay::OMIT_CRYPTOGRAPHIC),
+                    u" wants to connect"});
+  EXPECT_EQ(expected_string, CreateChooserTitle(rfh, kTitleResourceId));
+}
diff --git a/chrome/test/BUILD.gn b/chrome/test/BUILD.gn
index 5c65cc23e7ff5..0055528dfa5bd 100644
--- a/chrome/test/BUILD.gn
+++ b/chrome/test/BUILD.gn
@@ -1938,6 +1938,7 @@ if (!is_android) {
       "../browser/cart/cart_service_browsertest.cc",
       "../browser/cart/fetch_discount_worker_browsertest.cc",
       "../browser/chained_back_navigation_tracker_browsertest.cc",
+      "../browser/chooser_controller/title_util_browsertest.cc",
       "../browser/chrome_back_forward_cache_browsertest.cc",
       "../browser/chrome_content_browser_client_browsertest.cc",
       "../browser/chrome_data_use_measurement_browsertest.cc",
