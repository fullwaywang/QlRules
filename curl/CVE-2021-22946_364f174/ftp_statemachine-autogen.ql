/**
 * @name curl-364f174724ef115-ftp_statemachine
 * @id cpp/curl/364f174724ef115/ftp-statemachine
 * @description curl-364f174724ef115-lib/ftp.c-ftp_statemachine CVE-2021-22946
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vconn_2663, Variable vftpcode_2667, Variable vftpc_2668, Parameter vdata_2662, EqualityOperation target_1, AddressOfExpr target_2, LogicalAndExpr target_3, EqualityOperation target_4, SwitchStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8) {
	exists(IfStmt target_0 |
		target_0.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getTarget().getName()="use_ssl"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="set"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_2662
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(ValueFieldAccess).getTarget().getName()="ftp_use_control_ssl"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_2663
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("ftp_state_user_resp")
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_2662
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vftpcode_2667
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="state"
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vftpc_2668
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
		and target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_4.getAnOperand().(VariableAccess).getLocation())
		and target_5.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vftpcode_2667, EqualityOperation target_1) {
		target_1.getAnOperand().(VariableAccess).getTarget()=vftpcode_2667
		and target_1.getAnOperand().(Literal).getValue()="230"
}

predicate func_2(Parameter vconn_2663, AddressOfExpr target_2) {
		target_2.getOperand().(ValueFieldAccess).getTarget().getName()="ftpc"
		and target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="proto"
		and target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_2663
}

predicate func_3(Parameter vconn_2663, Parameter vdata_2662, LogicalAndExpr target_3) {
		target_3.getAnOperand().(ValueFieldAccess).getTarget().getName()="use_ssl"
		and target_3.getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="set"
		and target_3.getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_2662
		and target_3.getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ftp_use_control_ssl"
		and target_3.getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_3.getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_2663
}

predicate func_4(Variable vftpcode_2667, EqualityOperation target_4) {
		target_4.getAnOperand().(VariableAccess).getTarget()=vftpcode_2667
		and target_4.getAnOperand().(Literal).getValue()="220"
}

predicate func_5(Variable vftpcode_2667, Variable vftpc_2668, Parameter vdata_2662, SwitchStmt target_5) {
		target_5.getExpr().(PointerFieldAccess).getTarget().getName()="state"
		and target_5.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vftpc_2668
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vftpcode_2667
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="230"
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("ftp_state_user_resp")
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_2662
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vftpcode_2667
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="state"
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vftpc_2668
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vftpcode_2667
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="220"
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("Curl_failf")
}

predicate func_6(Variable vftpc_2668, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="count3"
		and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vftpc_2668
		and target_6.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_7(Variable vftpcode_2667, Parameter vdata_2662, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("CURLcode")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ftp_readresp")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_2662
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("curl_socket_t")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("pingpong *")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vftpcode_2667
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("size_t")
}

predicate func_8(Variable vftpcode_2667, Parameter vdata_2662, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("Curl_failf")
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_2662
		and target_8.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Got a %03d ftp-server response when 220 was expected"
		and target_8.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vftpcode_2667
}

from Function func, Parameter vconn_2663, Variable vftpcode_2667, Variable vftpc_2668, Parameter vdata_2662, EqualityOperation target_1, AddressOfExpr target_2, LogicalAndExpr target_3, EqualityOperation target_4, SwitchStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8
where
not func_0(vconn_2663, vftpcode_2667, vftpc_2668, vdata_2662, target_1, target_2, target_3, target_4, target_5, target_6, target_7, target_8)
and func_1(vftpcode_2667, target_1)
and func_2(vconn_2663, target_2)
and func_3(vconn_2663, vdata_2662, target_3)
and func_4(vftpcode_2667, target_4)
and func_5(vftpcode_2667, vftpc_2668, vdata_2662, target_5)
and func_6(vftpc_2668, target_6)
and func_7(vftpcode_2667, vdata_2662, target_7)
and func_8(vftpcode_2667, vdata_2662, target_8)
and vconn_2663.getType().hasName("connectdata *")
and vftpcode_2667.getType().hasName("int")
and vftpc_2668.getType().hasName("ftp_conn *")
and vdata_2662.getType().hasName("Curl_easy *")
and vconn_2663.getFunction() = func
and vftpcode_2667.(LocalVariable).getFunction() = func
and vftpc_2668.(LocalVariable).getFunction() = func
and vdata_2662.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
