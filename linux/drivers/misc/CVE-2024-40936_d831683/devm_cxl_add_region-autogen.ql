/**
 * @name linux-d8316838aa0686da63a8be4194b7a17b0103ae4a-devm_cxl_add_region
 * @id cpp/linux/d8316838aa0686da63a8be4194b7a17b0103ae4a/devm-cxl-add-region
 * @description linux-d8316838aa0686da63a8be4194b7a17b0103ae4a-drivers/cxl/core/region.c-devm_cxl_add_region CVE-2024-40936
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcxlrd_2179, ValueFieldAccess target_0) {
	exists(ValueFieldAccess obj_0 | obj_0=target_0.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="cxlsd"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vcxlrd_2179
		)
		and obj_0.getTarget().getName()="cxld"
	)
	and target_0.getTarget().getName()="dev"
}

predicate func_1(Parameter vmode_2181, SwitchStmt target_1) {
	exists(BlockStmt obj_0 | obj_0=target_1.getStmt() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getStmt(4) |
			exists(StmtExpr obj_2 | obj_2=obj_1.getExpr() |
				exists(BlockStmt obj_3 | obj_3=obj_2.getStmt() |
					obj_3.getStmt(0).(DoStmt).getCondition() instanceof Literal
					and obj_3.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_err")
				)
			)
		)
		and exists(ReturnStmt obj_4 | obj_4=obj_0.getStmt(5) |
			exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
				obj_5.getTarget().hasName("ERR_PTR")
				and obj_5.getArgument(0).(UnaryMinusExpr).getValue()="-22"
			)
		)
		and obj_0.getStmt(3).(SwitchCase).toString() = "default: "
	)
	and target_1.getExpr().(VariableAccess).getTarget()=vmode_2181
}

/*predicate func_4(VariableAccess target_13, Function func, BreakStmt target_4) {
	target_4.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_13
	and target_4.getEnclosingFunction() = func
}

*/
/*predicate func_5(Function func, SwitchCase target_5) {
	target_5.toString() = "default: "
	and target_5.getEnclosingFunction() = func
}

*/
/*predicate func_6(Parameter vmode_2181, VariableAccess target_13, ExprStmt target_6) {
	exists(StmtExpr obj_0 | obj_0=target_6.getExpr() |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(ExprStmt obj_2 | obj_2=obj_1.getStmt(1) |
				exists(FunctionCall obj_3 | obj_3=obj_2.getExpr() |
					obj_3.getTarget().hasName("_dev_err")
					and obj_3.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
					and obj_3.getArgument(1).(StringLiteral).getValue()="unsupported mode %d\n"
					and obj_3.getArgument(2).(VariableAccess).getTarget()=vmode_2181
				)
			)
			and obj_1.getStmt(0).(DoStmt).getCondition() instanceof Literal
		)
	)
	and target_6.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_13
}

*/
/*predicate func_7(Function func, DoStmt target_7) {
	target_7.getCondition() instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getValue()="1"
	and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, IfStmt target_8) {
	target_8.getCondition().(LogicalAndExpr).getValue()="1"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(LogicalAndExpr target_14, Function func, DeclStmt target_9) {
	target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(LogicalAndExpr target_14, Function func, DeclStmt target_10) {
	target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Parameter vmode_2181, ExprStmt target_11) {
	exists(FunctionCall obj_0 | obj_0=target_11.getExpr() |
		obj_0.getTarget().hasName("_dev_err")
		and obj_0.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
		and obj_0.getArgument(1).(StringLiteral).getValue()="unsupported mode %d\n"
		and obj_0.getArgument(2).(VariableAccess).getTarget()=vmode_2181
	)
}

*/
/*predicate func_12(VariableAccess target_13, Function func, ReturnStmt target_12) {
	exists(FunctionCall obj_0 | obj_0=target_12.getExpr() |
		obj_0.getTarget().hasName("ERR_PTR")
		and obj_0.getArgument(0).(UnaryMinusExpr).getValue()="-22"
	)
	and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_13
	and target_12.getEnclosingFunction() = func
}

*/
predicate func_13(Parameter vmode_2181, VariableAccess target_13) {
	target_13.getTarget()=vmode_2181
}

predicate func_14(Function func, LogicalAndExpr target_14) {
	target_14.getValue()="1"
	and target_14.getEnclosingFunction() = func
}

from Function func, Parameter vmode_2181, Parameter vcxlrd_2179, ValueFieldAccess target_0, SwitchStmt target_1, VariableAccess target_13, LogicalAndExpr target_14
where
func_0(vcxlrd_2179, target_0)
and func_1(vmode_2181, target_1)
and func_13(vmode_2181, target_13)
and func_14(func, target_14)
and vmode_2181.getType().hasName("cxl_decoder_mode")
and vcxlrd_2179.getType().hasName("cxl_root_decoder *")
and vmode_2181.getFunction() = func
and vcxlrd_2179.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
