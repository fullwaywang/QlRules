/**
 * @name linux-42146ee5286f16f1674a84f7c274dcca65c6ff2e-ena_com_rx_pkt
 * @id cpp/linux/42146ee5286f16f1674a84f7c274dcca65c6ff2e/ena-com-rx-pkt
 * @description linux-42146ee5286f16f1674a84f7c274dcca65c6ff2e-drivers/net/ethernet/amazon/ena/ena_eth_com.c-ena_com_rx_pkt CVE-2024-40999
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vnb_hw_desc_540, Parameter vio_cq_532, EqualityOperation target_6, PointerFieldAccess target_7) {
exists(AssignExpr target_0 |
	exists(FunctionCall obj_0 | obj_0=target_0.getRValue() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(2) |
			exists(VariableAccess obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getTarget()=vnb_hw_desc_540
				and obj_2.getLocation().isBefore(target_6.getLeftOperand().(VariableAccess).getLocation())
			)
		)
		and obj_0.getTarget().hasName("ena_com_cdesc_rx_pkt_get")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vio_cq_532
		and obj_0.getArgument(1) instanceof AddressOfExpr
		and obj_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_7.getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	)
	and target_0.getLValue().(VariableAccess).getType().hasName("int")
)
}

predicate func_1(IfStmt target_8, Function func) {
exists(IfStmt target_1 |
	exists(FunctionCall obj_0 | obj_0=target_1.getCondition() |
		exists(NotExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(NotExpr obj_2 | obj_2=obj_1.getOperand() |
				exists(EqualityOperation obj_3 | obj_3=obj_2.getOperand() |
					obj_3.getLeftOperand().(VariableAccess).getType().hasName("int")
					and obj_3.getRightOperand().(Literal).getValue()="0"
				)
			)
		)
		and obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(1).(Literal).getValue()="0"
	)
	and target_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-14"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_8.getLocation())
)
}

predicate func_2(Variable vcdesc_idx_539, AddressOfExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vcdesc_idx_539
	and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_3(Parameter vio_cq_532, VariableAccess target_3) {
	target_3.getTarget()=vio_cq_532
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_4(Variable vnb_hw_desc_540, VariableAccess target_4) {
	exists(AssignExpr obj_0 | obj_0=target_4.getParent() |
		obj_0.getLValue() = target_4
		and obj_0.getRValue() instanceof FunctionCall
	)
	and target_4.getTarget()=vnb_hw_desc_540
}

predicate func_5(Variable vnb_hw_desc_540, Parameter vio_cq_532, AssignExpr target_5) {
	exists(FunctionCall obj_0 | obj_0=target_5.getRValue() |
		obj_0.getTarget().hasName("ena_com_cdesc_rx_pkt_get")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vio_cq_532
		and obj_0.getArgument(1) instanceof AddressOfExpr
	)
	and target_5.getLValue().(VariableAccess).getTarget()=vnb_hw_desc_540
}

predicate func_6(Variable vnb_hw_desc_540, EqualityOperation target_6) {
	target_6.getLeftOperand().(VariableAccess).getTarget()=vnb_hw_desc_540
	and target_6.getRightOperand().(Literal).getValue()="0"
}

predicate func_7(Parameter vio_cq_532, PointerFieldAccess target_7) {
	exists(FunctionCall obj_0 | obj_0=target_7.getQualifier() |
		obj_0.getTarget().hasName("ena_com_io_cq_to_ena_dev")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vio_cq_532
	)
	and target_7.getTarget().getName()="net_device"
}

predicate func_8(Variable vnb_hw_desc_540, IfStmt target_8) {
	exists(EqualityOperation obj_0 | obj_0=target_8.getCondition() |
		obj_0.getLeftOperand().(VariableAccess).getTarget()=vnb_hw_desc_540
		and obj_0.getRightOperand().(Literal).getValue()="0"
	)
	and exists(BlockStmt obj_1 | obj_1=target_8.getThen() |
		exists(ExprStmt obj_2 | obj_2=obj_1.getStmt(0) |
			exists(AssignExpr obj_3 | obj_3=obj_2.getExpr() |
				exists(PointerFieldAccess obj_4 | obj_4=obj_3.getLValue() |
					obj_4.getTarget().getName()="descs"
					and obj_4.getQualifier().(VariableAccess).getTarget().getType().hasName("ena_com_rx_ctx *")
				)
				and obj_3.getRValue().(VariableAccess).getTarget()=vnb_hw_desc_540
			)
		)
		and obj_1.getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	)
}

from Function func, Variable vcdesc_idx_539, Variable vnb_hw_desc_540, Parameter vio_cq_532, AddressOfExpr target_2, VariableAccess target_3, VariableAccess target_4, AssignExpr target_5, EqualityOperation target_6, PointerFieldAccess target_7, IfStmt target_8
where
not func_0(vnb_hw_desc_540, vio_cq_532, target_6, target_7)
and not func_1(target_8, func)
and func_2(vcdesc_idx_539, target_2)
and func_3(vio_cq_532, target_3)
and func_4(vnb_hw_desc_540, target_4)
and func_5(vnb_hw_desc_540, vio_cq_532, target_5)
and func_6(vnb_hw_desc_540, target_6)
and func_7(vio_cq_532, target_7)
and func_8(vnb_hw_desc_540, target_8)
and vcdesc_idx_539.getType().hasName("u16")
and vnb_hw_desc_540.getType().hasName("u16")
and vio_cq_532.getType().hasName("ena_com_io_cq *")
and vcdesc_idx_539.(LocalVariable).getFunction() = func
and vnb_hw_desc_540.(LocalVariable).getFunction() = func
and vio_cq_532.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
