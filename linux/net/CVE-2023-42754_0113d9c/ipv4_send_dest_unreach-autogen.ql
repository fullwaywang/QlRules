/**
 * @name linux-0113d9c9d1ccc07f5a3710dac4aa24b6d711278c-ipv4_send_dest_unreach
 * @id cpp/linux/0113d9c9d1ccc07f5a3710dac4aa24b6d711278c/ipv4-send-dest-unreach
 * @description linux-0113d9c9d1ccc07f5a3710dac4aa24b6d711278c-ipv4_send_dest_unreach CVE-2023-42754
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vskb_1214, FunctionCall target_4, ValueFieldAccess target_5) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("net_device *")
		and target_0.getRValue().(ConditionalExpr).getCondition() instanceof ValueFieldAccess
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getTarget().getName()="dev"
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1214
		and target_0.getRValue().(ConditionalExpr).getElse().(ValueFieldAccess).getTarget().getName()="dev"
		and target_0.getRValue().(ConditionalExpr).getElse().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dst"
		and target_0.getRValue().(ConditionalExpr).getElse().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("skb_rtable")
		and target_0.getRValue().(ConditionalExpr).getElse().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1214
		and target_4.getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getRValue().(ConditionalExpr).getThen().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vskb_1214, Variable vopt_1216, Variable vres_1217, RelationalOperation target_6, ValueFieldAccess target_5, ExprStmt target_7, ExprStmt target_8, AddressOfExpr target_9, IfStmt target_11) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_1217
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__ip_options_compile")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("dev_net")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("net_device *")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vopt_1216
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vskb_1214
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(4)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_9.getOperand().(VariableAccess).getLocation())
		and target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getCondition().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vskb_1214, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="dev"
		and target_3.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1214
}

predicate func_4(Parameter vskb_1214, FunctionCall target_4) {
		target_4.getTarget().hasName("ip_hdr")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vskb_1214
}

predicate func_5(Parameter vskb_1214, ValueFieldAccess target_5) {
		target_5.getTarget().getName()="(unknown field)"
		and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1214
}

predicate func_6(Parameter vskb_1214, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="ihl"
		and target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ip_hdr")
		and target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1214
		and target_6.getLesserOperand().(Literal).getValue()="5"
}

predicate func_7(Parameter vskb_1214, Variable vopt_1216, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("__icmp_send")
		and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1214
		and target_7.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="3"
		and target_7.getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
		and target_7.getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_7.getExpr().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vopt_1216
}

predicate func_8(Parameter vskb_1214, Variable vopt_1216, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="optlen"
		and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1216
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ihl"
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ip_hdr")
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1214
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(MulExpr).getRightOperand().(Literal).getValue()="4"
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_8.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(SizeofTypeOperator).getValue()="20"
}

predicate func_9(Parameter vskb_1214, Variable vopt_1216, AddressOfExpr target_9) {
		target_9.getOperand().(VariableAccess).getTarget()=vopt_1216
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__icmp_send")
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1214
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="3"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
}

predicate func_11(Variable vres_1217, IfStmt target_11) {
		target_11.getCondition().(VariableAccess).getTarget()=vres_1217
}

from Function func, Parameter vskb_1214, Variable vopt_1216, Variable vres_1217, ValueFieldAccess target_3, FunctionCall target_4, ValueFieldAccess target_5, RelationalOperation target_6, ExprStmt target_7, ExprStmt target_8, AddressOfExpr target_9, IfStmt target_11
where
not func_0(vskb_1214, target_4, target_5)
and not func_1(vskb_1214, vopt_1216, vres_1217, target_6, target_5, target_7, target_8, target_9, target_11)
and func_3(vskb_1214, target_3)
and func_4(vskb_1214, target_4)
and func_5(vskb_1214, target_5)
and func_6(vskb_1214, target_6)
and func_7(vskb_1214, vopt_1216, target_7)
and func_8(vskb_1214, vopt_1216, target_8)
and func_9(vskb_1214, vopt_1216, target_9)
and func_11(vres_1217, target_11)
and vskb_1214.getType().hasName("sk_buff *")
and vopt_1216.getType().hasName("ip_options")
and vres_1217.getType().hasName("int")
and vskb_1214.getFunction() = func
and vopt_1216.(LocalVariable).getFunction() = func
and vres_1217.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
