/**
 * @name linux-e9e3d724e2145f5039b423c290ce2b2c3d8f94bc-__nfs4_proc_set_acl
 * @id cpp/linux/e9e3d724e2145f5039b423c290ce2b2c3d8f94bc/--nfs4-proc-set-acl
 * @description linux-e9e3d724e2145f5039b423c290ce2b2c3d8f94bc-fs/nfs/nfs4proc.c-__nfs4_proc_set_acl CVE-2011-1090
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbuf_3408, Parameter vbuflen_3408, FunctionCall target_0) {
		target_0.getTarget().hasName("buf_to_pages")
		and not target_0.getTarget().hasName("put_page")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vbuf_3408
		and target_0.getArgument(1).(VariableAccess).getTarget()=vbuflen_3408
		and target_0.getArgument(2) instanceof ValueFieldAccess
		and target_0.getArgument(3) instanceof AddressOfExpr
}

predicate func_2(Parameter vbuf_3408, Parameter vbuflen_3408) {
	exists(AssignExpr target_2 |
		target_2.getLValue().(VariableAccess).getType().hasName("int")
		and target_2.getRValue().(FunctionCall).getTarget().hasName("buf_to_pages_noslab")
		and target_2.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuf_3408
		and target_2.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbuflen_3408
		and target_2.getRValue().(FunctionCall).getArgument(2) instanceof ValueFieldAccess
		and target_2.getRValue().(FunctionCall).getArgument(3) instanceof AddressOfExpr)
}

predicate func_3(Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
		and target_3.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_3.getThen().(ReturnStmt).getExpr().(VariableAccess).getType().hasName("int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Variable vpages_3411, Function func) {
	exists(ForStmt target_4 |
		target_4.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("int")
		and target_4.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
		and target_4.getUpdate().(PostfixDecrExpr).getOperand().(VariableAccess).getType().hasName("int")
		and target_4.getStmt().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_page")
		and target_4.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vpages_3411
		and target_4.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
		and target_4.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4)
}

/*predicate func_5(Variable vpages_3411) {
	exists(ArrayExpr target_5 |
		target_5.getArrayBase().(VariableAccess).getTarget()=vpages_3411
		and target_5.getArrayOffset().(SubExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
		and target_5.getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall)
}

*/
predicate func_6(Variable varg_3412, ValueFieldAccess target_6) {
		target_6.getTarget().getName()="acl_pages"
		and target_6.getQualifier().(VariableAccess).getTarget()=varg_3412
}

predicate func_7(Variable varg_3412, AddressOfExpr target_7) {
		target_7.getOperand().(ValueFieldAccess).getTarget().getName()="acl_pgbase"
		and target_7.getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=varg_3412
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_8(Parameter vbuf_3408, VariableAccess target_8) {
		target_8.getTarget()=vbuf_3408
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_9(Parameter vbuflen_3408, VariableAccess target_9) {
		target_9.getTarget()=vbuflen_3408
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Parameter vbuf_3408, Parameter vbuflen_3408, Variable vpages_3411, Variable varg_3412, FunctionCall target_0, ValueFieldAccess target_6, AddressOfExpr target_7, VariableAccess target_8, VariableAccess target_9
where
func_0(vbuf_3408, vbuflen_3408, target_0)
and not func_2(vbuf_3408, vbuflen_3408)
and not func_3(func)
and not func_4(vpages_3411, func)
and func_6(varg_3412, target_6)
and func_7(varg_3412, target_7)
and func_8(vbuf_3408, target_8)
and func_9(vbuflen_3408, target_9)
and vbuf_3408.getType().hasName("const void *")
and vbuflen_3408.getType().hasName("size_t")
and vpages_3411.getType().hasName("page *[16]")
and varg_3412.getType().hasName("nfs_setaclargs")
and vbuf_3408.getFunction() = func
and vbuflen_3408.getFunction() = func
and vpages_3411.(LocalVariable).getFunction() = func
and varg_3412.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
