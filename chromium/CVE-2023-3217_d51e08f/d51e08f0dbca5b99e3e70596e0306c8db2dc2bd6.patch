commit d51e08f0dbca5b99e3e70596e0306c8db2dc2bd6	d51e08f0dbca5b99e3e70596e0306c8db2dc2bd6
Author: Alexander Cooper <alcooper@chromium.org>
Date:   Thu Jun 1 23:40:25 2023 +0000

    Fix DCHECK when there is already a pending xr session request
    
    It is possible to racily force two session requests to get served to the
    same runtime. This results in a DCHECK because we expect to only have
    one outstanding request at a time. For now, this softens the DCHECK into
    simply an immediate reject, but future work will investigate
    strengthening the guarantees from the Browser process that we cannot
    get multiple session requests.
    
    Fixed: 1450601
    Change-Id: Ic2b372a26156229092053d1734de9e62487b53ee
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4582708
    Reviewed-by: Brandon Jones <bajones@chromium.org>
    Commit-Queue: Alexander Cooper <alcooper@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1152234}

diff --git a/device/vr/openxr/openxr_device.cc b/device/vr/openxr/openxr_device.cc
index 275c7b493268c..82e27050eddfb 100644
--- a/device/vr/openxr/openxr_device.cc
+++ b/device/vr/openxr/openxr_device.cc
@@ -137,7 +137,14 @@ void OpenXrDevice::EnsureRenderLoop() {
 void OpenXrDevice::RequestSession(
     mojom::XRRuntimeSessionOptionsPtr options,
     mojom::XRRuntime::RequestSessionCallback callback) {
-  DCHECK(!request_session_callback_);
+  // TODO(https://crbug.com/1450707): Strengthen the guarantees from the browser
+  // process that we will not get a session request while one is pending.
+  if (request_session_callback_) {
+    LOG(ERROR) << __func__
+               << " New session request while processing previous request.";
+    std::move(callback).Run(nullptr);
+    return;
+  }
 
   OpenXrCreateInfo create_info;
   create_info.render_process_id = options->render_process_id;
