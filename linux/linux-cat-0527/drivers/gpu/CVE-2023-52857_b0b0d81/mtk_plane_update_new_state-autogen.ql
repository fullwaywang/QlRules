/**
 * @name linux-b0b0d811eac6b4c52cb9ad632fa6384cf48869e7-mtk_plane_update_new_state
 * @id cpp/linux/b0b0d811eac6b4c52cb9ad632fa6384cf48869e7/mtk-plane-update-new-state
 * @description linux-b0b0d811eac6b4c52cb9ad632fa6384cf48869e7-drivers/gpu/drm/mediatek/mtk_drm_plane.c-mtk_plane_update_new_state CVE-2023-52857
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getType().hasName("int")
	and target_0.getRValue() instanceof MulExpr
	and target_0.getEnclosingFunction() = func)
}

predicate func_2(EqualityOperation target_20, Function func) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_2.getExpr().(AssignExpr).getRValue() instanceof MulExpr
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vaddr_141, EqualityOperation target_20, ExprStmt target_21) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_141
	and target_3.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getType().hasName("int")
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_21.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_5(Function func) {
exists(AssignExpr target_5 |
	target_5.getLValue().(VariableAccess).getType().hasName("int")
	and target_5.getRValue().(AddExpr).getLeftOperand() instanceof MulExpr
	and target_5.getRValue().(AddExpr).getRightOperand() instanceof MulExpr
	and target_5.getEnclosingFunction() = func)
}

predicate func_7(EqualityOperation target_20, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_7.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand() instanceof MulExpr
	and target_7.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand() instanceof MulExpr
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(10)=target_7
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_7.getEnclosingFunction() = func)
}

predicate func_8(Variable vaddr_141, EqualityOperation target_20) {
exists(ExprStmt target_8 |
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vaddr_141
	and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand() instanceof AddExpr
	and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getType().hasName("int")
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(11)=target_8
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20)
}

predicate func_10(Variable vfb_136, Parameter vnew_state_133, Variable vaddr_141, MulExpr target_10) {
	target_10.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="x1"
	and target_10.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_10.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_state_133
	and target_10.getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="16"
	and target_10.getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="cpp"
	and target_10.getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="format"
	and target_10.getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfb_136
	and target_10.getRightOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_10.getParent().(AssignAddExpr).getRValue() = target_10
	and target_10.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_141
}

predicate func_11(Parameter vnew_state_133, Variable vpitch_139, Variable vaddr_141, MulExpr target_11) {
	target_11.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="y1"
	and target_11.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_11.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_state_133
	and target_11.getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="16"
	and target_11.getRightOperand().(VariableAccess).getTarget()=vpitch_139
	and target_11.getParent().(AssignAddExpr).getRValue() = target_11
	and target_11.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_141
}

predicate func_12(Variable vhdr_pitch_143, Variable vy_offset_in_blocks_161, MulExpr target_12) {
	target_12.getLeftOperand().(VariableAccess).getTarget()=vhdr_pitch_143
	and target_12.getRightOperand().(VariableAccess).getTarget()=vy_offset_in_blocks_161
}

predicate func_13(Variable vx_offset_in_blocks_160, MulExpr target_13) {
	target_13.getLeftOperand().(Literal).getValue()="16"
	and target_13.getRightOperand().(VariableAccess).getTarget()=vx_offset_in_blocks_160
}

predicate func_14(Variable vaddr_141, Variable vhdr_size_1_162, AddExpr target_14) {
	target_14.getLeftOperand().(VariableAccess).getTarget()=vaddr_141
	and target_14.getRightOperand().(VariableAccess).getTarget()=vhdr_size_1_162
}

predicate func_15(Variable vpitch_139, Variable vy_offset_in_blocks_161, MulExpr target_15) {
	target_15.getLeftOperand().(VariableAccess).getTarget()=vpitch_139
	and target_15.getRightOperand().(VariableAccess).getTarget()=vy_offset_in_blocks_161
}

predicate func_16(Variable vfb_136, Variable vx_offset_in_blocks_160, MulExpr target_16) {
	target_16.getLeftOperand().(MulExpr).getLeftOperand().(MulExpr).getValue()="256"
	and target_16.getLeftOperand().(MulExpr).getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="cpp"
	and target_16.getLeftOperand().(MulExpr).getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_16.getLeftOperand().(MulExpr).getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="format"
	and target_16.getLeftOperand().(MulExpr).getRightOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfb_136
	and target_16.getLeftOperand().(MulExpr).getRightOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_16.getRightOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vx_offset_in_blocks_160
	and target_16.getRightOperand().(AddExpr).getRightOperand().(Literal).getValue()="1"
}

predicate func_17(Variable vaddr_141, VariableAccess target_17) {
	target_17.getTarget()=vaddr_141
}

predicate func_18(Variable vaddr_141, AddExpr target_18) {
	target_18.getLeftOperand().(VariableAccess).getTarget()=vaddr_141
	and target_18.getRightOperand() instanceof MulExpr
}

predicate func_19(Function func, AddExpr target_19) {
	target_19.getLeftOperand() instanceof AddExpr
	and target_19.getRightOperand() instanceof MulExpr
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Function func, EqualityOperation target_20) {
	target_20.getLeftOperand().(VariableAccess).getTarget().getType().hasName("u64")
	and target_20.getRightOperand().(BitwiseOrExpr).getValue()="0"
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Variable vaddr_141, ExprStmt target_21) {
	target_21.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_141
	and target_21.getExpr().(AssignAddExpr).getRValue() instanceof MulExpr
}

from Function func, Variable vfb_136, Parameter vnew_state_133, Variable vpitch_139, Variable vaddr_141, Variable vhdr_pitch_143, Variable vx_offset_in_blocks_160, Variable vy_offset_in_blocks_161, Variable vhdr_size_1_162, MulExpr target_10, MulExpr target_11, MulExpr target_12, MulExpr target_13, AddExpr target_14, MulExpr target_15, MulExpr target_16, VariableAccess target_17, AddExpr target_18, AddExpr target_19, EqualityOperation target_20, ExprStmt target_21
where
not func_0(func)
and not func_2(target_20, func)
and not func_3(vaddr_141, target_20, target_21)
and not func_5(func)
and not func_7(target_20, func)
and not func_8(vaddr_141, target_20)
and func_10(vfb_136, vnew_state_133, vaddr_141, target_10)
and func_11(vnew_state_133, vpitch_139, vaddr_141, target_11)
and func_12(vhdr_pitch_143, vy_offset_in_blocks_161, target_12)
and func_13(vx_offset_in_blocks_160, target_13)
and func_14(vaddr_141, vhdr_size_1_162, target_14)
and func_15(vpitch_139, vy_offset_in_blocks_161, target_15)
and func_16(vfb_136, vx_offset_in_blocks_160, target_16)
and func_17(vaddr_141, target_17)
and func_18(vaddr_141, target_18)
and func_19(func, target_19)
and func_20(func, target_20)
and func_21(vaddr_141, target_21)
and vfb_136.getType().hasName("drm_framebuffer *")
and vnew_state_133.getType().hasName("drm_plane_state *")
and vpitch_139.getType().hasName("unsigned int")
and vaddr_141.getType().hasName("dma_addr_t")
and vhdr_pitch_143.getType().hasName("unsigned int")
and vx_offset_in_blocks_160.getType().hasName("int")
and vy_offset_in_blocks_161.getType().hasName("int")
and vhdr_size_1_162.getType().hasName("int")
and vfb_136.(LocalVariable).getFunction() = func
and vnew_state_133.getFunction() = func
and vpitch_139.(LocalVariable).getFunction() = func
and vaddr_141.(LocalVariable).getFunction() = func
and vhdr_pitch_143.(LocalVariable).getFunction() = func
and vx_offset_in_blocks_160.(LocalVariable).getFunction() = func
and vy_offset_in_blocks_161.(LocalVariable).getFunction() = func
and vhdr_size_1_162.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
