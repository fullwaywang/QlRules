/**
 * @name linux-96054569190bdec375fe824e48ca1f4e3b53dd36-do_sigbus
 * @id cpp/linux/96054569190bdec375fe824e48ca1f4e3b53dd36/do-sigbus
 * @description linux-96054569190bdec375fe824e48ca1f4e3b53dd36-arch/x86/mm/fault.c-do_sigbus CVE-2010-2240
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(NotExpr target_2, Function func) {
	exists(ReturnStmt target_0 |
		target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Parameter vaddress_795, Parameter verror_code_795, Parameter vregs_795, NotExpr target_2, ExprStmt target_1) {
		target_1.getExpr().(FunctionCall).getTarget().hasName("no_context")
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vregs_795
		and target_1.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=verror_code_795
		and target_1.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vaddress_795
		and target_1.getParent().(IfStmt).getCondition()=target_2
}

predicate func_2(Parameter verror_code_795, NotExpr target_2) {
		target_2.getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=verror_code_795
}

from Function func, Parameter vaddress_795, Parameter verror_code_795, Parameter vregs_795, ExprStmt target_1, NotExpr target_2
where
not func_0(target_2, func)
and func_1(vaddress_795, verror_code_795, vregs_795, target_2, target_1)
and func_2(verror_code_795, target_2)
and vaddress_795.getType().hasName("unsigned long")
and verror_code_795.getType().hasName("unsigned long")
and vregs_795.getType().hasName("pt_regs *")
and vaddress_795.getFunction() = func
and verror_code_795.getFunction() = func
and vregs_795.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
