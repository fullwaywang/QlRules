/**
 * @name linux-06e7e776ca4d36547e503279aeff996cbb292c16-l2cap_parse_conf_req
 * @id cpp/linux/06e7e776ca4d36547e503279aeff996cbb292c16/l2cap-parse-conf-req
 * @description linux-06e7e776ca4d36547e503279aeff996cbb292c16-net/bluetooth/l2cap_core.c-l2cap_parse_conf_req CVE-2017-1000410
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vremote_efs_3330, VariableAccess target_2, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vremote_efs_3330
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_2
}

predicate func_1(Variable volen_3326, Variable vval_3327, Variable vefs_3329, EqualityOperation target_3, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vefs_3329
	and target_1.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vval_3327
	and target_1.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=volen_3326
	and target_1.getParent().(IfStmt).getCondition()=target_3
}

predicate func_2(Variable vtype_3326, VariableAccess target_2) {
	target_2.getTarget()=vtype_3326
}

predicate func_3(Variable volen_3326, EqualityOperation target_3) {
	target_3.getLeftOperand().(VariableAccess).getTarget()=volen_3326
	and target_3.getRightOperand().(SizeofExprOperator).getValue()="16"
}

from Function func, Variable vtype_3326, Variable volen_3326, Variable vval_3327, Variable vefs_3329, Variable vremote_efs_3330, ExprStmt target_0, ExprStmt target_1, VariableAccess target_2, EqualityOperation target_3
where
func_0(vremote_efs_3330, target_2, target_0)
and func_1(volen_3326, vval_3327, vefs_3329, target_3, target_1)
and func_2(vtype_3326, target_2)
and func_3(volen_3326, target_3)
and vtype_3326.getType().hasName("int")
and volen_3326.getType().hasName("int")
and vval_3327.getType().hasName("unsigned long")
and vefs_3329.getType().hasName("l2cap_conf_efs")
and vremote_efs_3330.getType().hasName("u8")
and vtype_3326.(LocalVariable).getFunction() = func
and volen_3326.(LocalVariable).getFunction() = func
and vval_3327.(LocalVariable).getFunction() = func
and vefs_3329.(LocalVariable).getFunction() = func
and vremote_efs_3330.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
