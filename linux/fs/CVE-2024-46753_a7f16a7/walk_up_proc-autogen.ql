/**
 * @name linux-a7f16a7a709845855cb5a0e080a52bda5873f9de-walk_up_proc
 * @id cpp/linux/a7f16a7a709845855cb5a0e080a52bda5873f9de/walk-up-proc
 * @description linux-a7f16a7a709845855cb5a0e080a52bda5873f9de-fs/btrfs/extent-tree.c-walk_up_proc CVE-2024-46753
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vret_5696, VariableAccess target_0) {
	exists(NotExpr obj_0 | obj_0=target_0.getParent() |
		exists(NotExpr obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getParent() |
				exists(IfStmt obj_3 | obj_3=obj_2.getParent() |
					exists(FunctionCall obj_4 | obj_4=obj_3.getCondition() |
						obj_4.getTarget().hasName("__builtin_expect")
						and obj_4.getArgument(1) instanceof Literal
					)
				)
			)
		)
	)
	and target_0.getTarget()=vret_5696
}

predicate func_1(Function func, FunctionCall target_1) {
	target_1.getTarget().hasName("__builtin_unreachable")
	and not target_1.getTarget().hasName("_btrfs_printk")
	and target_1.getEnclosingFunction() = func
}

predicate func_2(DoStmt target_16, Function func, ExprStmt target_2) {
	target_2.getExpr() instanceof FunctionCall
	and target_16.getLocation().isBefore(target_2.getLocation())
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vtrans_5690, Variable vret_5696, EqualityOperation target_17, ExprStmt target_18, ExprStmt target_19) {
exists(IfStmt target_3 |
	exists(BlockStmt obj_0 | obj_0=target_3.getThen() |
		exists(DoStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(2) |
					exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
						obj_4.getTarget().hasName("__btrfs_abort_transaction")
						and obj_4.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
						and obj_4.getArgument(1).(VariableAccess).getType().hasName("const char[13]")
						and obj_4.getArgument(2) instanceof Literal
						and obj_4.getArgument(3).(VariableAccess).getTarget()=vret_5696
						and obj_4.getArgument(4).(VariableAccess).getType().hasName("bool")
					)
				)
				and obj_2.getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_and_set_bit")
			)
			and obj_1.getCondition() instanceof Literal
		)
		and obj_0.getStmt(1).(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_5696
	)
	and exists(BlockStmt obj_5 | obj_5=target_3.getParent() |
		exists(IfStmt obj_6 | obj_6=obj_5.getParent() |
			obj_6.getThen().(BlockStmt).getStmt(1)=target_3
			and obj_6.getCondition()=target_17
		)
	)
	and target_3.getCondition().(VariableAccess).getTarget()=vret_5696
	and target_3.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getCondition().(VariableAccess).getLocation())
)
}

/*predicate func_4(Parameter vtrans_5690, DoStmt target_20, ExprStmt target_19) {
exists(NotExpr target_4 |
	exists(FunctionCall obj_0 | obj_0=target_4.getOperand() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(1) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="fs_info"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vtrans_5690
				)
				and obj_2.getTarget().getName()="fs_state"
			)
		)
		and obj_0.getTarget().hasName("test_and_set_bit")
	)
	and target_4.getParent().(IfStmt).getThen()=target_20
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getOperand().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

*/
/*predicate func_5(FunctionCall target_21, Function func) {
exists(ExprStmt target_5 |
	exists(BlockStmt obj_0 | obj_0=target_5.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(0)=target_5
			and obj_1.getCondition()=target_21
		)
	)
	and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_5.getEnclosingFunction() = func
)
}

*/
/*predicate func_6(Parameter vtrans_5690, Variable vret_5696, FunctionCall target_21, NotExpr target_22) {
exists(IfStmt target_6 |
	exists(StmtExpr obj_0 | obj_0=target_6.getCondition() |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(IfStmt obj_2 | obj_2=obj_1.getStmt(1) |
				exists(FunctionCall obj_3 | obj_3=obj_2.getCondition() |
					obj_3.getTarget().hasName("__builtin_expect")
					and obj_3.getArgument(1) instanceof Literal
				)
				and obj_2.getThen().(DoStmt).getCondition() instanceof Literal
			)
			and exists(ExprStmt obj_4 | obj_4=obj_1.getStmt(2) |
				exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
					obj_5.getTarget().hasName("__builtin_expect")
					and obj_5.getArgument(1) instanceof Literal
				)
			)
		)
	)
	and exists(BlockStmt obj_6 | obj_6=target_6.getElse() |
		exists(ExprStmt obj_7 | obj_7=obj_6.getStmt(0) |
			exists(FunctionCall obj_8 | obj_8=obj_7.getExpr() |
				exists(PointerFieldAccess obj_9 | obj_9=obj_8.getArgument(0) |
					obj_9.getTarget().getName()="fs_info"
					and obj_9.getQualifier().(VariableAccess).getTarget()=vtrans_5690
				)
				and obj_8.getTarget().hasName("_btrfs_printk")
				and obj_8.getArgument(1).(StringLiteral).getValue()="3Transaction aborted (error %d)"
				and obj_8.getArgument(2).(VariableAccess).getTarget()=vret_5696
			)
		)
	)
	and exists(BlockStmt obj_10 | obj_10=target_6.getParent() |
		exists(IfStmt obj_11 | obj_11=obj_10.getParent() |
			obj_11.getThen().(BlockStmt).getStmt(1)=target_6
			and obj_11.getCondition()=target_21
		)
	)
	and target_22.getOperand().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_6.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
)
}

*/
/*predicate func_7(AsmStmt target_23, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
	and target_7.getLocation().isBefore(target_23.getLocation())
	and target_7.getEnclosingFunction() = func
)
}

*/
/*predicate func_8(AsmStmt target_23, Function func) {
exists(DoStmt target_8 |
	exists(BlockStmt obj_0 | obj_0=target_8.getStmt() |
		exists(AsmStmt obj_1 | obj_1=obj_0.getStmt(0) |
			obj_1.getChild(0) instanceof StringLiteral
			and obj_1.getChild(1) instanceof Literal
			and obj_1.getChild(2).(VariableAccess).getType().hasName("int")
			and obj_1.getChild(3) instanceof SizeofTypeOperator
		)
	)
	and target_8.getCondition() instanceof Literal
	and target_8.getLocation().isBefore(target_23.getLocation())
	and target_8.getEnclosingFunction() = func
)
}

*/
/*predicate func_9(AsmStmt target_23, Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
	and target_9.getLocation().isBefore(target_23.getLocation())
	and target_9.getEnclosingFunction() = func
)
}

*/
/*predicate func_14(Parameter vtrans_5690, Variable vret_5696, ExprStmt target_18) {
exists(ExprStmt target_14 |
	exists(FunctionCall obj_0 | obj_0=target_14.getExpr() |
		obj_0.getTarget().hasName("__btrfs_abort_transaction")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
		and obj_0.getArgument(1).(VariableAccess).getType().hasName("const char[13]")
		and obj_0.getArgument(2) instanceof Literal
		and obj_0.getArgument(3).(VariableAccess).getTarget()=vret_5696
		and obj_0.getArgument(4).(VariableAccess).getType().hasName("bool")
		and obj_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	)
)
}

*/
predicate func_15(Function func, SizeofTypeOperator target_15) {
	target_15.getType() instanceof LongType
	and target_15.getValue()="12"
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, DoStmt target_16) {
	exists(BlockStmt obj_0 | obj_0=target_16.getStmt() |
		exists(AsmStmt obj_1 | obj_1=obj_0.getStmt(0) |
			obj_1.getChild(0) instanceof StringLiteral
			and obj_1.getChild(1) instanceof Literal
			and obj_1.getChild(2) instanceof Literal
			and obj_1.getChild(3) instanceof SizeofTypeOperator
		)
	)
	and target_16.getCondition() instanceof Literal
	and target_16.getEnclosingFunction() = func
}

predicate func_17(BlockStmt target_24, Function func, EqualityOperation target_17) {
	target_17.getLeftOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_17.getRightOperand().(Literal).getValue()="0"
	and target_17.getParent().(IfStmt).getThen()=target_24
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Parameter vtrans_5690, Variable vret_5696, ExprStmt target_18) {
	exists(AssignExpr obj_0 | obj_0=target_18.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("btrfs_qgroup_trace_leaf_items")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
			and obj_1.getArgument(1).(VariableAccess).getTarget().getType().hasName("extent_buffer *")
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vret_5696
	)
}

predicate func_19(Parameter vtrans_5690, Variable vret_5696, ExprStmt target_19) {
	exists(AssignExpr obj_0 | obj_0=target_19.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("btrfs_dec_ref")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
			and obj_1.getArgument(1).(VariableAccess).getTarget().getType().hasName("btrfs_root *")
			and obj_1.getArgument(2).(VariableAccess).getTarget().getType().hasName("extent_buffer *")
			and obj_1.getArgument(3).(Literal).getValue()="0"
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vret_5696
	)
}

predicate func_20(Function func, DoStmt target_20) {
	exists(BlockStmt obj_0 | obj_0=target_20.getStmt() |
		exists(DoStmt obj_1 | obj_1=obj_0.getStmt(1) |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(AsmStmt obj_3 | obj_3=obj_2.getStmt(0) |
					obj_3.getChild(0) instanceof StringLiteral
					and obj_3.getChild(1) instanceof Literal
					and obj_3.getChild(2) instanceof Literal
					and obj_3.getChild(3) instanceof SizeofTypeOperator
				)
			)
			and obj_1.getCondition() instanceof Literal
		)
		and obj_0.getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="3532"
	)
	and target_20.getCondition() instanceof Literal
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Variable vret_5696, FunctionCall target_21) {
	target_21.getTarget().hasName("__builtin_expect")
	and target_21.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_5696
	and target_21.getArgument(1) instanceof Literal
}

predicate func_22(Variable vret_5696, NotExpr target_22) {
	target_22.getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_5696
}

predicate func_23(Function func, AsmStmt target_23) {
	target_23.getChild(0) instanceof StringLiteral
	and target_23.getChild(1) instanceof Literal
	and target_23.getChild(2) instanceof Literal
	and target_23.getChild(3) instanceof SizeofTypeOperator
	and target_23.getEnclosingFunction() = func
}

predicate func_24(Parameter vtrans_5690, Variable vret_5696, BlockStmt target_24) {
	exists(IfStmt obj_0 | obj_0=target_24.getStmt(0) |
		exists(BitwiseAndExpr obj_1 | obj_1=obj_0.getCondition() |
			exists(ArrayExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getArrayBase() |
					obj_3.getTarget().getName()="flags"
					and obj_3.getQualifier().(VariableAccess).getTarget().getType().hasName("walk_control *")
				)
				and obj_2.getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
			)
			and obj_1.getRightOperand().(BinaryBitwiseOperation).getValue()="256"
		)
		and exists(ExprStmt obj_4 | obj_4=obj_0.getThen() |
			exists(AssignExpr obj_5 | obj_5=obj_4.getExpr() |
				exists(FunctionCall obj_6 | obj_6=obj_5.getRValue() |
					obj_6.getTarget().hasName("btrfs_dec_ref")
					and obj_6.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
					and obj_6.getArgument(1).(VariableAccess).getTarget().getType().hasName("btrfs_root *")
					and obj_6.getArgument(2).(VariableAccess).getTarget().getType().hasName("extent_buffer *")
					and obj_6.getArgument(3).(Literal).getValue()="1"
				)
				and obj_5.getLValue().(VariableAccess).getTarget()=vret_5696
			)
		)
		and exists(ExprStmt obj_7 | obj_7=obj_0.getElse() |
			exists(AssignExpr obj_8 | obj_8=obj_7.getExpr() |
				exists(FunctionCall obj_9 | obj_9=obj_8.getRValue() |
					obj_9.getTarget().hasName("btrfs_dec_ref")
					and obj_9.getArgument(0).(VariableAccess).getTarget()=vtrans_5690
					and obj_9.getArgument(1).(VariableAccess).getTarget().getType().hasName("btrfs_root *")
					and obj_9.getArgument(2).(VariableAccess).getTarget().getType().hasName("extent_buffer *")
					and obj_9.getArgument(3).(Literal).getValue()="0"
				)
				and obj_8.getLValue().(VariableAccess).getTarget()=vret_5696
			)
		)
	)
}

from Function func, Parameter vtrans_5690, Variable vret_5696, VariableAccess target_0, FunctionCall target_1, ExprStmt target_2, SizeofTypeOperator target_15, DoStmt target_16, EqualityOperation target_17, ExprStmt target_18, ExprStmt target_19, DoStmt target_20, FunctionCall target_21, NotExpr target_22, AsmStmt target_23, BlockStmt target_24
where
func_0(vret_5696, target_0)
and func_1(func, target_1)
and func_2(target_16, func, target_2)
and not func_3(vtrans_5690, vret_5696, target_17, target_18, target_19)
and func_15(func, target_15)
and func_16(func, target_16)
and func_17(target_24, func, target_17)
and func_18(vtrans_5690, vret_5696, target_18)
and func_19(vtrans_5690, vret_5696, target_19)
and func_20(func, target_20)
and func_21(vret_5696, target_21)
and func_22(vret_5696, target_22)
and func_23(func, target_23)
and func_24(vtrans_5690, vret_5696, target_24)
and vtrans_5690.getType().hasName("btrfs_trans_handle *")
and vret_5696.getType().hasName("int")
and vtrans_5690.getFunction() = func
and vret_5696.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
