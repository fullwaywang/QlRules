/**
 * @name linux-82981930125abfd39d7c8378a9cfdf5e1be2002b-sock_setsockopt
 * @id cpp/linux/82981930125abfd39d7c8378a9cfdf5e1be2002b/sock-setsockopt
 * @description linux-82981930125abfd39d7c8378a9cfdf5e1be2002b-net/core/sock.c-sock_setsockopt CVE-2012-6704
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vval_534) {
exists(StmtExpr target_0 |
	target_0.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_0.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_0.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("u32")
	and target_0.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("u32")
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534)
}

/*predicate func_1(Function func) {
exists(ConditionalExpr target_1 |
	target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_1.getThen().(VariableAccess).getType().hasName("u32")
	and target_1.getElse().(VariableAccess).getType().hasName("u32")
	and target_1.getEnclosingFunction() = func)
}

*/
predicate func_4(Variable vsk_533) {
exists(StmtExpr target_4 |
	target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("u32")
	and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("u32")
	and target_4.getParent().(AssignExpr).getRValue() = target_4
	and target_4.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_4.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533)
}

/*predicate func_5(Function func) {
exists(ConditionalExpr target_5 |
	target_5.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_5.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_5.getThen().(VariableAccess).getType().hasName("u32")
	and target_5.getElse().(VariableAccess).getType().hasName("u32")
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_8(Variable vsk_533) {
exists(StmtExpr target_8 |
	target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("u32")
	and target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("u32")
	and target_8.getParent().(AssignExpr).getRValue() = target_8
	and target_8.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_8.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533)
}

/*predicate func_9(Function func) {
exists(ConditionalExpr target_9 |
	target_9.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_9.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_9.getThen().(VariableAccess).getType().hasName("u32")
	and target_9.getElse().(VariableAccess).getType().hasName("u32")
	and target_9.getEnclosingFunction() = func)
}

*/
predicate func_12(Variable vsk_533, VariableAccess target_37) {
exists(ExprStmt target_12 |
	target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_rcvbuf"
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_12.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("u32")
	and target_12.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("u32")
	and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_37)
}

/*predicate func_13(Variable vval_534) {
exists(StmtExpr target_13 |
	target_13.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
	and target_13.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u32")
	and target_13.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("u32")
	and target_13.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("u32")
	and target_13.getParent().(AssignExpr).getRValue() = target_13
	and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534)
}

*/
predicate func_16(Variable vsk_533, PointerFieldAccess target_16) {
	target_16.getTarget().getName()="sk_rcvbuf"
	and target_16.getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_16.getParent().(AssignExpr).getLValue() = target_16
	and target_16.getParent().(AssignExpr).getRValue() instanceof AddExpr
}

predicate func_17(Variable vval_534, ExprStmt target_39, MulExpr target_17) {
	target_17.getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_17.getRightOperand().(Literal).getValue()="2"
	and target_17.getParent().(LTExpr).getGreaterOperand().(Literal).getValue()="2048"
	and target_17.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_39
}

predicate func_18(Variable vsk_533, Variable vval_534, MulExpr target_18) {
	target_18.getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_18.getRightOperand().(Literal).getValue()="2"
	and target_18.getParent().(AssignExpr).getRValue() = target_18
	and target_18.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_18.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
}

predicate func_19(ExprStmt target_40, Function func, AddExpr target_19) {
	target_19.getValue()="2288"
	and target_19.getParent().(LTExpr).getLesserOperand() instanceof MulExpr
	and target_19.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_40
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable vval_534, Variable vsysctl_rmem_max, VariableAccess target_20) {
	target_20.getTarget()=vval_534
	and target_20.getParent().(AssignExpr).getLValue() = target_20
	and target_20.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsysctl_rmem_max
}

predicate func_21(Variable vval_534, Variable vsysctl_wmem_max, ExprStmt target_41, VariableAccess target_21) {
	target_21.getTarget()=vval_534
	and target_21.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget()=vsysctl_wmem_max
	and target_21.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_41
}

/*predicate func_22(Variable vval_534, Variable vsysctl_wmem_max, ExprStmt target_41, VariableAccess target_22) {
	target_22.getTarget()=vsysctl_wmem_max
	and target_22.getParent().(GTExpr).getGreaterOperand().(VariableAccess).getTarget()=vval_534
	and target_22.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_41
}

*/
predicate func_24(Variable vval_534, Variable vsysctl_rmem_max, ExprStmt target_42, VariableAccess target_24) {
	target_24.getTarget()=vval_534
	and target_24.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget()=vsysctl_rmem_max
	and target_24.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_42
}

/*predicate func_25(Variable vval_534, Variable vsysctl_rmem_max, ExprStmt target_42, VariableAccess target_25) {
	target_25.getTarget()=vsysctl_rmem_max
	and target_25.getParent().(GTExpr).getGreaterOperand().(VariableAccess).getTarget()=vval_534
	and target_25.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_42
}

*/
predicate func_26(Variable vval_534, Variable vsysctl_wmem_max, VariableAccess target_37, IfStmt target_26) {
	target_26.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vval_534
	and target_26.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vsysctl_wmem_max
	and target_26.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
	and target_26.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsysctl_wmem_max
	and target_26.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_37
}

/*predicate func_27(Variable vval_534, Variable vsysctl_wmem_max, VariableAccess target_27) {
	target_27.getTarget()=vsysctl_wmem_max
	and target_27.getParent().(AssignExpr).getRValue() = target_27
	and target_27.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
}

*/
predicate func_28(Variable vsk_533, VariableAccess target_37, IfStmt target_28) {
	target_28.getCondition().(RelationalOperation).getLesserOperand() instanceof MulExpr
	and target_28.getCondition().(RelationalOperation).getGreaterOperand() instanceof Literal
	and target_28.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_28.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_28.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="2048"
	and target_28.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_28.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_28.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof MulExpr
	and target_28.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_37
}

/*predicate func_30(Variable vsk_533, ExprStmt target_39, ExprStmt target_43, PointerFieldAccess target_30) {
	target_30.getTarget().getName()="sk_sndbuf"
	and target_30.getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_39.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_30.getQualifier().(VariableAccess).getLocation())
	and target_30.getQualifier().(VariableAccess).getLocation().isBefore(target_43.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_31(Variable vval_534, Variable vsysctl_rmem_max, VariableAccess target_37, IfStmt target_31) {
	target_31.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vval_534
	and target_31.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vsysctl_rmem_max
	and target_31.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
	and target_31.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsysctl_rmem_max
	and target_31.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_37
}

/*predicate func_32(Variable vval_534, Variable vsysctl_rmem_max, VariableAccess target_32) {
	target_32.getTarget()=vsysctl_rmem_max
	and target_32.getParent().(AssignExpr).getRValue() = target_32
	and target_32.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
}

*/
predicate func_33(Variable vsk_533, Variable vval_534, VariableAccess target_37, IfStmt target_33) {
	target_33.getCondition().(RelationalOperation).getLesserOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_33.getCondition().(RelationalOperation).getLesserOperand().(MulExpr).getRightOperand().(Literal).getValue()="2"
	and target_33.getCondition().(RelationalOperation).getGreaterOperand() instanceof AddExpr
	and target_33.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_rcvbuf"
	and target_33.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_33.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getValue()="2288"
	and target_33.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_rcvbuf"
	and target_33.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_33.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_33.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(MulExpr).getRightOperand().(Literal).getValue()="2"
	and target_33.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_37
}

/*predicate func_34(Variable vval_534, ExprStmt target_40, ExprStmt target_42, MulExpr target_34) {
	target_34.getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_34.getRightOperand().(Literal).getValue()="2"
	and target_34.getParent().(LTExpr).getGreaterOperand() instanceof AddExpr
	and target_34.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_40
	and target_42.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_34.getLeftOperand().(VariableAccess).getLocation())
}

*/
/*predicate func_35(Variable vsk_533, AssignExpr target_35) {
	target_35.getLValue().(PointerFieldAccess).getTarget().getName()="sk_rcvbuf"
	and target_35.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_35.getRValue().(AddExpr).getValue()="2288"
}

*/
/*predicate func_36(Variable vsk_533, Variable vval_534, AssignExpr target_36) {
	target_36.getLValue().(PointerFieldAccess).getTarget().getName()="sk_rcvbuf"
	and target_36.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_36.getRValue().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vval_534
	and target_36.getRValue().(MulExpr).getRightOperand().(Literal).getValue()="2"
}

*/
predicate func_37(Parameter voptname_530, VariableAccess target_37) {
	target_37.getTarget()=voptname_530
}

predicate func_39(Variable vsk_533, ExprStmt target_39) {
	target_39.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sk_sndbuf"
	and target_39.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_39.getExpr().(AssignExpr).getRValue() instanceof Literal
}

predicate func_40(Function func, ExprStmt target_40) {
	target_40.getExpr() instanceof AssignExpr
	and target_40.getEnclosingFunction() = func
}

predicate func_41(Variable vval_534, Variable vsysctl_wmem_max, ExprStmt target_41) {
	target_41.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
	and target_41.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsysctl_wmem_max
}

predicate func_42(Variable vval_534, Variable vsysctl_rmem_max, ExprStmt target_42) {
	target_42.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vval_534
	and target_42.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsysctl_rmem_max
}

predicate func_43(Variable vsk_533, ExprStmt target_43) {
	target_43.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="sk_write_space"
	and target_43.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_533
	and target_43.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vsk_533
}

from Function func, Parameter voptname_530, Variable vsk_533, Variable vval_534, Variable vsysctl_wmem_max, Variable vsysctl_rmem_max, PointerFieldAccess target_16, MulExpr target_17, MulExpr target_18, AddExpr target_19, VariableAccess target_20, VariableAccess target_21, VariableAccess target_24, IfStmt target_26, IfStmt target_28, IfStmt target_31, IfStmt target_33, VariableAccess target_37, ExprStmt target_39, ExprStmt target_40, ExprStmt target_41, ExprStmt target_42, ExprStmt target_43
where
not func_0(vval_534)
and not func_4(vsk_533)
and not func_8(vsk_533)
and not func_12(vsk_533, target_37)
and func_16(vsk_533, target_16)
and func_17(vval_534, target_39, target_17)
and func_18(vsk_533, vval_534, target_18)
and func_19(target_40, func, target_19)
and func_20(vval_534, vsysctl_rmem_max, target_20)
and func_21(vval_534, vsysctl_wmem_max, target_41, target_21)
and func_24(vval_534, vsysctl_rmem_max, target_42, target_24)
and func_26(vval_534, vsysctl_wmem_max, target_37, target_26)
and func_28(vsk_533, target_37, target_28)
and func_31(vval_534, vsysctl_rmem_max, target_37, target_31)
and func_33(vsk_533, vval_534, target_37, target_33)
and func_37(voptname_530, target_37)
and func_39(vsk_533, target_39)
and func_40(func, target_40)
and func_41(vval_534, vsysctl_wmem_max, target_41)
and func_42(vval_534, vsysctl_rmem_max, target_42)
and func_43(vsk_533, target_43)
and voptname_530.getType().hasName("int")
and vsk_533.getType().hasName("sock *")
and vval_534.getType().hasName("int")
and vsysctl_wmem_max.getType().hasName("__u32")
and vsysctl_rmem_max.getType().hasName("__u32")
and voptname_530.getFunction() = func
and vsk_533.(LocalVariable).getFunction() = func
and vval_534.(LocalVariable).getFunction() = func
and not vsysctl_wmem_max.getParentScope+() = func
and not vsysctl_rmem_max.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
