/**
 * @name linux-f67b15037a7a50c57f72e69a6d59941ad90a0f0f-modify_user_hw_breakpoint
 * @id cpp/linux/f67b15037a7a50c57f72e69a6d59941ad90a0f0f/modify-user-hw-breakpoint
 * @description linux-f67b15037a7a50c57f72e69a6d59941ad90a0f0f-kernel/events/hw_breakpoint.c-modify_user_hw_breakpoint CVE-2018-1000199
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbp_433, ValueFieldAccess target_0) {
	target_0.getTarget().getName()="bp_addr"
	and target_0.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_1(IfStmt target_29, Function func, ExprStmt target_1) {
	target_1.getExpr() instanceof AssignExpr
	and target_29.getLocation().isBefore(target_1.getLocation())
	and target_1.getEnclosingFunction() = func
}

predicate func_3(Parameter vbp_433, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="attr"
	and target_3.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_4(Parameter vbp_433, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="attr"
	and target_4.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_5(Parameter vbp_433, ValueFieldAccess target_5) {
	target_5.getTarget().getName()="disabled"
	and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_6(Parameter vbp_433, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="attr"
	and target_6.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_7(Parameter vattr_433, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="disabled"
	and target_7.getQualifier().(VariableAccess).getTarget()=vattr_433
	and target_7.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_8(Parameter vbp_433, Variable verr_438, FunctionCall target_8) {
	target_8.getTarget().hasName("validate_hw_breakpoint")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vbp_433
	and target_8.getParent().(AssignExpr).getRValue() = target_8
	and target_8.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_438
}

predicate func_9(Parameter vbp_433, NotExpr target_30, ExprStmt target_9) {
	target_9.getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
	and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
	and target_9.getParent().(IfStmt).getCondition()=target_30
}

predicate func_10(Variable verr_438, VariableAccess target_11, ReturnStmt target_10) {
	target_10.getExpr().(VariableAccess).getTarget()=verr_438
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

predicate func_11(Variable verr_438, BlockStmt target_31, VariableAccess target_11) {
	target_11.getTarget()=verr_438
	and target_11.getParent().(IfStmt).getThen()=target_31
}

predicate func_14(Function func, DeclStmt target_14) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Function func, DeclStmt target_15) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Function func, DeclStmt target_16) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(PointerFieldAccess target_7, Function func, GotoStmt target_17) {
	target_17.getName() ="end"
	and target_17.getParent().(IfStmt).getCondition()=target_7
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Variable verr_438, AssignExpr target_18) {
	target_18.getLValue().(VariableAccess).getTarget()=verr_438
	and target_18.getRValue() instanceof FunctionCall
}

predicate func_19(Variable verr_438, ExprStmt target_9, VariableAccess target_19) {
	target_19.getTarget()=verr_438
	and target_19.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_9
}

predicate func_20(Parameter vbp_433, Variable vold_addr_435, Variable vold_len_436, Variable vold_type_437, Variable verr_438, Function func, IfStmt target_20) {
	target_20.getCondition().(VariableAccess).getTarget()=verr_438
	and target_20.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_20.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_addr_435
	and target_20.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_type"
	and target_20.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_20.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_20.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_type_437
	and target_20.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
	and target_20.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_20.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_20.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
	and target_20.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="disabled"
	and target_20.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_20.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_20.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
	and target_20.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
	and target_20.getThen().(BlockStmt).getStmt(4) instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

predicate func_21(Parameter vbp_433, ExprStmt target_9, ExprStmt target_23, PointerFieldAccess target_21) {
	target_21.getTarget().getName()="attr"
	and target_21.getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_21.getQualifier().(VariableAccess).getLocation())
	and target_21.getQualifier().(VariableAccess).getLocation().isBefore(target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

/*predicate func_22(Variable vold_addr_435, VariableAccess target_22) {
	target_22.getTarget()=vold_addr_435
	and target_22.getParent().(AssignExpr).getRValue() = target_22
	and target_22.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

*/
predicate func_23(Parameter vbp_433, Variable vold_type_437, ExprStmt target_23) {
	target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_type"
	and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_23.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_type_437
}

/*predicate func_24(Parameter vbp_433, Variable vold_len_436, VariableAccess target_11, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_24.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
	and target_24.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

*/
/*predicate func_25(Parameter vbp_433, Variable vold_len_436, ExprStmt target_23, DeclStmt target_14, ValueFieldAccess target_25) {
	target_25.getTarget().getName()="bp_len"
	and target_25.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_25.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_25.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_25.getParent().(AssignExpr).getLValue() = target_25
	and target_25.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
	and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_25.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_26(Parameter vbp_433, Variable vold_len_436, VariableAccess target_26) {
	target_26.getTarget()=vold_len_436
	and target_26.getParent().(AssignExpr).getRValue() = target_26
	and target_26.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
	and target_26.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_26.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_26.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
}

*/
/*predicate func_27(Parameter vbp_433, VariableAccess target_11, IfStmt target_27) {
	target_27.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="disabled"
	and target_27.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_27.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
	and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
	and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

*/
predicate func_28(Parameter vattr_433, Function func, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_28.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="disabled"
	and target_28.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vattr_433
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_28
}

predicate func_29(Parameter vattr_433, IfStmt target_29) {
	target_29.getCondition().(PointerFieldAccess).getTarget().getName()="disabled"
	and target_29.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vattr_433
	and target_29.getThen() instanceof GotoStmt
}

predicate func_30(Variable verr_438, NotExpr target_30) {
	target_30.getOperand().(VariableAccess).getTarget()=verr_438
}

predicate func_31(Variable vold_addr_435, BlockStmt target_31) {
	target_31.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_31.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_addr_435
	and target_31.getStmt(1) instanceof ExprStmt
	and target_31.getStmt(2) instanceof ExprStmt
	and target_31.getStmt(3) instanceof IfStmt
}

from Function func, Parameter vbp_433, Parameter vattr_433, Variable vold_addr_435, Variable vold_len_436, Variable vold_type_437, Variable verr_438, ValueFieldAccess target_0, ExprStmt target_1, PointerFieldAccess target_3, PointerFieldAccess target_4, ValueFieldAccess target_5, PointerFieldAccess target_6, PointerFieldAccess target_7, FunctionCall target_8, ExprStmt target_9, ReturnStmt target_10, VariableAccess target_11, DeclStmt target_14, DeclStmt target_15, DeclStmt target_16, GotoStmt target_17, AssignExpr target_18, VariableAccess target_19, IfStmt target_20, PointerFieldAccess target_21, ExprStmt target_23, ExprStmt target_28, IfStmt target_29, NotExpr target_30, BlockStmt target_31
where
func_0(vbp_433, target_0)
and func_1(target_29, func, target_1)
and func_3(vbp_433, target_3)
and func_4(vbp_433, target_4)
and func_5(vbp_433, target_5)
and func_6(vbp_433, target_6)
and func_7(vattr_433, target_7)
and func_8(vbp_433, verr_438, target_8)
and func_9(vbp_433, target_30, target_9)
and func_10(verr_438, target_11, target_10)
and func_11(verr_438, target_31, target_11)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(func, target_16)
and func_17(target_7, func, target_17)
and func_18(verr_438, target_18)
and func_19(verr_438, target_9, target_19)
and func_20(vbp_433, vold_addr_435, vold_len_436, vold_type_437, verr_438, func, target_20)
and func_21(vbp_433, target_9, target_23, target_21)
and func_23(vbp_433, vold_type_437, target_23)
and func_28(vattr_433, func, target_28)
and func_29(vattr_433, target_29)
and func_30(verr_438, target_30)
and func_31(vold_addr_435, target_31)
and vbp_433.getType().hasName("perf_event *")
and vattr_433.getType().hasName("perf_event_attr *")
and vold_addr_435.getType().hasName("u64")
and vold_len_436.getType().hasName("u64")
and vold_type_437.getType().hasName("int")
and verr_438.getType().hasName("int")
and vbp_433.getFunction() = func
and vattr_433.getFunction() = func
and vold_addr_435.(LocalVariable).getFunction() = func
and vold_len_436.(LocalVariable).getFunction() = func
and vold_type_437.(LocalVariable).getFunction() = func
and verr_438.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
