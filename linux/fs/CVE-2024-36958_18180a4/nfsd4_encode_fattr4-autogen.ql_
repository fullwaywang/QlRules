/**
 * @name linux-18180a4550d08be4eb0387fe83f02f703f92d4e7-nfsd4_encode_fattr4
 * @id cpp/linux/18180a4550d08be4eb0387fe83f02f703f92d4e7/nfsd4-encode-fattr4
 * @description linux-18180a4550d08be4eb0387fe83f02f703f92d4e7-fs/nfsd/nfs4xdr.c-nfsd4_encode_fattr4 CVE-2024-36958
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vargs_3494, IfStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="acl"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_3494
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vargs_3494, IfStmt target_1) {
	target_1.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u32[3]")
	and target_1.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_1.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="524544"
	and target_1.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget().getType().hasName("svc_fh *")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("svc_fh *")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofTypeOperator).getType() instanceof LongType
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofTypeOperator).getValue()="384"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264"
	and target_1.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="fhp"
	and target_1.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_3494
	and target_1.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("svc_fh *")
}

from Function func, Variable vargs_3494, ExprStmt target_0, IfStmt target_1
where
func_0(vargs_3494, target_1, target_0)
and func_1(vargs_3494, target_1)
and vargs_3494.getType().hasName("nfsd4_fattr_args")
and vargs_3494.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
