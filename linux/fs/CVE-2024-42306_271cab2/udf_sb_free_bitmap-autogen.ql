/**
 * @name linux-271cab2ca00652bc984e269cf1208699a1e09cdd-udf_sb_free_bitmap
 * @id cpp/linux/271cab2ca00652bc984e269cf1208699a1e09cdd/udf-sb-free-bitmap
 * @description linux-271cab2ca00652bc984e269cf1208699a1e09cdd-fs/udf/super.c-udf_sb_free_bitmap CVE-2024-42306
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_265, Parameter vbitmap_263, ExprStmt target_1, PostfixIncrExpr target_2, ArrayExpr target_3) {
exists(IfStmt target_0 |
	exists(NotExpr obj_0 | obj_0=target_0.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getOperand() |
			exists(ArrayExpr obj_2 | obj_2=obj_1.getArgument(0) |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getArrayBase() |
					obj_3.getTarget().getName()="s_block_bitmap"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vbitmap_263
				)
				and obj_2.getArrayOffset().(VariableAccess).getTarget()=vi_265
			)
			and obj_1.getTarget().hasName("IS_ERR_OR_NULL")
		)
	)
	and target_0.getThen() instanceof ExprStmt
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(ArrayExpr).getArrayOffset().(VariableAccess).getLocation())
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_3.getArrayOffset().(VariableAccess).getLocation())
)
}

predicate func_1(Variable vi_265, Parameter vbitmap_263, ExprStmt target_1) {
	exists(FunctionCall obj_0 | obj_0=target_1.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getArrayBase() |
				obj_2.getTarget().getName()="s_block_bitmap"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vbitmap_263
			)
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_265
		)
		and obj_0.getTarget().hasName("brelse")
	)
}

predicate func_2(Variable vi_265, PostfixIncrExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vi_265
}

predicate func_3(Variable vi_265, Parameter vbitmap_263, ArrayExpr target_3) {
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getArrayBase() |
		obj_0.getTarget().getName()="s_block_bitmap"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vbitmap_263
	)
	and target_3.getArrayOffset().(VariableAccess).getTarget()=vi_265
}

from Function func, Variable vi_265, Parameter vbitmap_263, ExprStmt target_1, PostfixIncrExpr target_2, ArrayExpr target_3
where
not func_0(vi_265, vbitmap_263, target_1, target_2, target_3)
and func_1(vi_265, vbitmap_263, target_1)
and func_2(vi_265, target_2)
and func_3(vi_265, vbitmap_263, target_3)
and vi_265.getType().hasName("int")
and vbitmap_263.getType().hasName("udf_bitmap *")
and vi_265.(LocalVariable).getFunction() = func
and vbitmap_263.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
