/**
 * @name linux-45c08a752982116f3287afcd1bd9c50f4fab0c28-nfs4_get_vfs_file
 * @id cpp/linux/45c08a752982116f3287afcd1bd9c50f4fab0c28/nfs4-get-vfs-file
 * @description linux-45c08a752982116f3287afcd1bd9c50f4fab0c28-fs/nfsd/nfs4state.c-nfs4_get_vfs_file CVE-2023-52909
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcur_fh_5210, Variable vnf_5213, Variable vstatus_5214, Variable vaccess_5216, Parameter vrqstp_5209, FunctionCall target_0) {
	exists(AssignExpr obj_0 | obj_0=target_0.getParent() |
		obj_0.getRValue() = target_0
		and obj_0.getLValue().(VariableAccess).getTarget()=vstatus_5214
	)
	and target_0.getTarget().hasName("nfsd_file_acquire")
	and not target_0.getTarget().hasName("nfsd_file_acquire_opened")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vrqstp_5209
	and target_0.getArgument(1).(VariableAccess).getTarget()=vcur_fh_5210
	and target_0.getArgument(2).(VariableAccess).getTarget()=vaccess_5216
	and target_0.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnf_5213
}

predicate func_1(Parameter vopen_5211, BlockStmt target_9, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="op_filp"
	and target_1.getQualifier().(VariableAccess).getTarget()=vopen_5211
	and target_1.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_9
}

predicate func_2(Variable vstatus_5214, NotExpr target_10, IfStmt target_2) {
	exists(EqualityOperation obj_0 | obj_0=target_2.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRightOperand() |
			obj_1.getTarget().hasName("__builtin_bswap32")
			and obj_1.getValue()="0"
		)
		and obj_0.getLeftOperand().(VariableAccess).getTarget()=vstatus_5214
	)
	and target_2.getThen().(GotoStmt).getName() ="out_put_access"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

predicate func_3(Parameter vcur_fh_5210, Parameter vopen_5211, Variable vnf_5213, Variable vstatus_5214, Variable vaccess_5216, Parameter vrqstp_5209, NotExpr target_11, IfStmt target_3) {
	exists(NotExpr obj_0 | obj_0=target_3.getCondition() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getOperand() |
			obj_1.getTarget().getName()="op_filp"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vopen_5211
		)
	)
	and exists(BlockStmt obj_2 | obj_2=target_3.getThen() |
		exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(0) |
			exists(AssignExpr obj_4 | obj_4=obj_3.getExpr() |
				obj_4.getLValue().(VariableAccess).getTarget()=vstatus_5214
				and obj_4.getRValue() instanceof FunctionCall
			)
		)
		and obj_2.getStmt(1) instanceof IfStmt
	)
	and exists(BlockStmt obj_5 | obj_5=target_3.getElse() |
		exists(ExprStmt obj_6 | obj_6=obj_5.getStmt(0) |
			exists(AssignExpr obj_7 | obj_7=obj_6.getExpr() |
				exists(FunctionCall obj_8 | obj_8=obj_7.getRValue() |
					obj_8.getTarget().hasName("nfsd_file_create")
					and obj_8.getArgument(0).(VariableAccess).getTarget()=vrqstp_5209
					and obj_8.getArgument(1).(VariableAccess).getTarget()=vcur_fh_5210
					and obj_8.getArgument(2).(VariableAccess).getTarget()=vaccess_5216
					and obj_8.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnf_5213
				)
				and obj_7.getLValue().(VariableAccess).getTarget()=vstatus_5214
			)
		)
		and exists(IfStmt obj_9 | obj_9=obj_5.getStmt(1) |
			exists(EqualityOperation obj_10 | obj_10=obj_9.getCondition() |
				exists(FunctionCall obj_11 | obj_11=obj_10.getRightOperand() |
					obj_11.getTarget().hasName("__builtin_bswap32")
					and obj_11.getValue()="0"
				)
				and obj_10.getLeftOperand().(VariableAccess).getTarget()=vstatus_5214
			)
			and obj_9.getThen().(GotoStmt).getName() ="out_put_access"
		)
		and exists(ExprStmt obj_12 | obj_12=obj_5.getStmt(2) |
			exists(AssignExpr obj_13 | obj_13=obj_12.getExpr() |
				exists(PointerFieldAccess obj_14 | obj_14=obj_13.getLValue() |
					obj_14.getTarget().getName()="nf_file"
					and obj_14.getQualifier().(VariableAccess).getTarget()=vnf_5213
				)
				and exists(PointerFieldAccess obj_15 | obj_15=obj_13.getRValue() |
					obj_15.getTarget().getName()="op_filp"
					and obj_15.getQualifier().(VariableAccess).getTarget()=vopen_5211
				)
			)
		)
		and exists(ExprStmt obj_16 | obj_16=obj_5.getStmt(3) |
			exists(AssignExpr obj_17 | obj_17=obj_16.getExpr() |
				exists(PointerFieldAccess obj_18 | obj_18=obj_17.getLValue() |
					obj_18.getTarget().getName()="op_filp"
					and obj_18.getQualifier().(VariableAccess).getTarget()=vopen_5211
				)
				and obj_17.getRValue().(Literal).getValue()="0"
			)
		)
		and exists(ExprStmt obj_19 | obj_19=obj_5.getStmt(4) |
			exists(FunctionCall obj_20 | obj_20=obj_19.getExpr() |
				obj_20.getTarget().hasName("trace_nfsd_file_create")
				and obj_20.getArgument(0).(VariableAccess).getTarget()=vrqstp_5209
				and obj_20.getArgument(1).(VariableAccess).getTarget()=vaccess_5216
				and obj_20.getArgument(2).(VariableAccess).getTarget()=vnf_5213
			)
		)
	)
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

/*predicate func_4(Parameter vcur_fh_5210, Variable vnf_5213, Variable vstatus_5214, Variable vaccess_5216, Parameter vrqstp_5209, NotExpr target_10, ExprStmt target_4) {
	exists(AssignExpr obj_0 | obj_0=target_4.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("nfsd_file_create")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vrqstp_5209
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vcur_fh_5210
			and obj_1.getArgument(2).(VariableAccess).getTarget()=vaccess_5216
			and obj_1.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnf_5213
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vstatus_5214
	)
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_5(Variable vstatus_5214, NotExpr target_10, IfStmt target_5) {
	exists(EqualityOperation obj_0 | obj_0=target_5.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRightOperand() |
			obj_1.getTarget().hasName("__builtin_bswap32")
			and obj_1.getValue()="0"
		)
		and obj_0.getLeftOperand().(VariableAccess).getTarget()=vstatus_5214
	)
	and target_5.getThen().(GotoStmt).getName() ="out_put_access"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_6(Parameter vopen_5211, Variable vnf_5213, NotExpr target_10, ExprStmt target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="nf_file"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vnf_5213
		)
		and exists(PointerFieldAccess obj_2 | obj_2=obj_0.getRValue() |
			obj_2.getTarget().getName()="op_filp"
			and obj_2.getQualifier().(VariableAccess).getTarget()=vopen_5211
		)
	)
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_7(Parameter vopen_5211, NotExpr target_10, ExprStmt target_7) {
	exists(AssignExpr obj_0 | obj_0=target_7.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="op_filp"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vopen_5211
		)
		and obj_0.getRValue().(Literal).getValue()="0"
	)
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_8(Variable vnf_5213, Variable vaccess_5216, Parameter vrqstp_5209, NotExpr target_10, ExprStmt target_8) {
	exists(FunctionCall obj_0 | obj_0=target_8.getExpr() |
		obj_0.getTarget().hasName("trace_nfsd_file_create")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vrqstp_5209
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vaccess_5216
		and obj_0.getArgument(2).(VariableAccess).getTarget()=vnf_5213
	)
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
predicate func_9(Variable vstatus_5214, BlockStmt target_9) {
	exists(ExprStmt obj_0 | obj_0=target_9.getStmt(0) |
		exists(AssignExpr obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getLValue().(VariableAccess).getTarget()=vstatus_5214
			and obj_1.getRValue() instanceof FunctionCall
		)
	)
	and target_9.getStmt(1) instanceof IfStmt
}

predicate func_10(Parameter vopen_5211, NotExpr target_10) {
	exists(PointerFieldAccess obj_0 | obj_0=target_10.getOperand() |
		obj_0.getTarget().getName()="op_filp"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vopen_5211
	)
}

predicate func_11(BlockStmt target_12, Function func, NotExpr target_11) {
	exists(ArrayExpr obj_0 | obj_0=target_11.getOperand() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getArrayBase() |
			obj_1.getTarget().getName()="fi_fds"
			and obj_1.getQualifier().(VariableAccess).getTarget().getType().hasName("nfs4_file *")
		)
		and obj_0.getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	)
	and target_11.getParent().(IfStmt).getThen()=target_12
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Function func, BlockStmt target_12) {
	exists(ExprStmt obj_0 | obj_0=target_12.getStmt(0) |
		exists(FunctionCall obj_1 | obj_1=obj_0.getExpr() |
			exists(AddressOfExpr obj_2 | obj_2=obj_1.getArgument(0) |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getOperand() |
					obj_3.getTarget().getName()="fi_lock"
					and obj_3.getQualifier().(VariableAccess).getTarget().getType().hasName("nfs4_file *")
				)
			)
			and obj_1.getTarget().hasName("spin_unlock")
		)
	)
	and exists(ExprStmt obj_4 | obj_4=target_12.getStmt(2) |
		exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
			exists(AddressOfExpr obj_6 | obj_6=obj_5.getArgument(0) |
				exists(PointerFieldAccess obj_7 | obj_7=obj_6.getOperand() |
					obj_7.getTarget().getName()="fi_lock"
					and obj_7.getQualifier().(VariableAccess).getTarget().getType().hasName("nfs4_file *")
				)
			)
			and obj_5.getTarget().hasName("spin_lock")
		)
	)
	and target_12.getStmt(1) instanceof IfStmt
	and target_12.getEnclosingFunction() = func
}

from Function func, Parameter vcur_fh_5210, Parameter vopen_5211, Variable vnf_5213, Variable vstatus_5214, Variable vaccess_5216, Parameter vrqstp_5209, FunctionCall target_0, PointerFieldAccess target_1, IfStmt target_2, IfStmt target_3, BlockStmt target_9, NotExpr target_10, NotExpr target_11, BlockStmt target_12
where
func_0(vcur_fh_5210, vnf_5213, vstatus_5214, vaccess_5216, vrqstp_5209, target_0)
and func_1(vopen_5211, target_9, target_1)
and func_2(vstatus_5214, target_10, target_2)
and func_3(vcur_fh_5210, vopen_5211, vnf_5213, vstatus_5214, vaccess_5216, vrqstp_5209, target_11, target_3)
and func_9(vstatus_5214, target_9)
and func_10(vopen_5211, target_10)
and func_11(target_12, func, target_11)
and func_12(func, target_12)
and vcur_fh_5210.getType().hasName("svc_fh *")
and vopen_5211.getType().hasName("nfsd4_open *")
and vnf_5213.getType().hasName("nfsd_file *")
and vstatus_5214.getType().hasName("__be32")
and vaccess_5216.getType().hasName("int")
and vrqstp_5209.getType().hasName("svc_rqst *")
and vcur_fh_5210.getFunction() = func
and vopen_5211.getFunction() = func
and vnf_5213.(LocalVariable).getFunction() = func
and vstatus_5214.(LocalVariable).getFunction() = func
and vaccess_5216.(LocalVariable).getFunction() = func
and vrqstp_5209.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
