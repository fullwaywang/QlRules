/**
 * @name frr-b08afc81c60607a4f736f418f2e3eb06087f1a35-bgp_update_receive
 * @id cpp/frr/b08afc81c60607a4f736f418f2e3eb06087f1a35/bgp-update-receive
 * @description frr-b08afc81c60607a4f736f418f2e3eb06087f1a35-bgpd/bgp_packet.c-bgp_update_receive CVE-2023-46752
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vupdate_len_2178, Variable vwithdraw_len_2179, Variable vnlris_2189, BlockStmt target_5, LogicalAndExpr target_0) {
		target_0.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vupdate_len_2178
		and target_0.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vwithdraw_len_2179
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getTarget().getName()="length"
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_2189
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_0.getParent().(LogicalOrExpr).getAnOperand() instanceof EqualityOperation
		and target_0.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_5
}

predicate func_1(Variable vattr_parse_ret_2281, BlockStmt target_5, LogicalOrExpr target_1) {
		target_1.getAnOperand() instanceof LogicalAndExpr
		and target_1.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2281
		and target_1.getParent().(IfStmt).getThen()=target_5
}

predicate func_2(Variable vnlris_2189, Variable vattr_parse_ret_2281, Variable vafi_2402, Variable vsafi_2403, NotExpr target_6, IfStmt target_2) {
		target_2.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2281
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vafi_2402
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="afi"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_2189
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsafi_2403
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="safi"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_2189
		and target_2.getParent().(IfStmt).getParent().(IfStmt).getCondition()=target_6
}

/*predicate func_3(Variable vnlris_2189, Variable vafi_2402, EqualityOperation target_7, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vafi_2402
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="afi"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_2189
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
/*predicate func_4(Variable vnlris_2189, Variable vsafi_2403, EqualityOperation target_7, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsafi_2403
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="safi"
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_2189
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
predicate func_5(Function func, BlockStmt target_5) {
		target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("peer *")
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="32"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("peer *")
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="64"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("bool")
		and target_5.getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Function func, NotExpr target_6) {
		target_6.getOperand().(VariableAccess).getTarget().getType().hasName("bgp_size_t")
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vattr_parse_ret_2281, BlockStmt target_8, EqualityOperation target_7) {
		target_7.getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2281
		and target_7.getAnOperand() instanceof EnumConstantAccess
		and target_7.getParent().(IfStmt).getThen()=target_8
}

predicate func_8(Function func, BlockStmt target_8) {
		target_8.getStmt(0) instanceof ExprStmt
		and target_8.getStmt(1) instanceof ExprStmt
		and target_8.getEnclosingFunction() = func
}

from Function func, Variable vupdate_len_2178, Variable vwithdraw_len_2179, Variable vnlris_2189, Variable vattr_parse_ret_2281, Variable vafi_2402, Variable vsafi_2403, LogicalAndExpr target_0, LogicalOrExpr target_1, IfStmt target_2, BlockStmt target_5, NotExpr target_6, EqualityOperation target_7, BlockStmt target_8
where
func_0(vupdate_len_2178, vwithdraw_len_2179, vnlris_2189, target_5, target_0)
and func_1(vattr_parse_ret_2281, target_5, target_1)
and func_2(vnlris_2189, vattr_parse_ret_2281, vafi_2402, vsafi_2403, target_6, target_2)
and func_5(func, target_5)
and func_6(func, target_6)
and func_7(vattr_parse_ret_2281, target_8, target_7)
and func_8(func, target_8)
and vupdate_len_2178.getType().hasName("bgp_size_t")
and vwithdraw_len_2179.getType().hasName("bgp_size_t")
and vnlris_2189.getType().hasName("bgp_nlri[4]")
and vattr_parse_ret_2281.getType().hasName("bgp_attr_parse_ret")
and vafi_2402.getType().hasName("afi_t")
and vsafi_2403.getType().hasName("safi_t")
and vupdate_len_2178.(LocalVariable).getFunction() = func
and vwithdraw_len_2179.(LocalVariable).getFunction() = func
and vnlris_2189.(LocalVariable).getFunction() = func
and vattr_parse_ret_2281.(LocalVariable).getFunction() = func
and vafi_2402.(LocalVariable).getFunction() = func
and vsafi_2403.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
