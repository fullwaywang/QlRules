/**
 * @name linux-8b8addf891de8a00e4d39fc32f93f7c5eb8feceb-arch_pick_mmap_layout
 * @id cpp/linux/8b8addf891de8a00e4d39fc32f93f7c5eb8feceb/arch-pick-mmap-layout
 * @description linux-8b8addf891de8a00e4d39fc32f93f7c5eb8feceb-arch/x86/mm/mmap.c-arch_pick_mmap_layout CVE-2016-3672
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vrandom_factor_114, ExprStmt target_3) {
exists(AddExpr target_0 |
	target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("test_ti_thread_flag")
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("current_thread_info")
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="29"
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getThen().(Literal).getValue()="3221225472"
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getElse().(Literal).getValue()="4294959104"
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getElse().(SubExpr).getValue()="140737488351232"
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(DivExpr).getRightOperand().(Literal).getValue()="3"
	and target_0.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(SubExpr).getValue()="4095"
	and target_0.getLeftOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073709547520"
	and target_0.getRightOperand().(VariableAccess).getTarget()=vrandom_factor_114
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="mmap_legacy_base"
	and target_0.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("mm_struct *")
	and target_0.getRightOperand().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vrandom_factor_114, VariableAccess target_1) {
	target_1.getTarget()=vrandom_factor_114
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_2(Variable vrandom_factor_114, FunctionCall target_2) {
	target_2.getTarget().hasName("mmap_legacy_base")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vrandom_factor_114
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="mmap_legacy_base"
	and target_2.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("mm_struct *")
}

predicate func_3(Variable vrandom_factor_114, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="mmap_base"
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("mm_struct *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("mmap_base")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrandom_factor_114
}

from Function func, Variable vrandom_factor_114, VariableAccess target_1, FunctionCall target_2, ExprStmt target_3
where
not func_0(vrandom_factor_114, target_3)
and func_1(vrandom_factor_114, target_1)
and func_2(vrandom_factor_114, target_2)
and func_3(vrandom_factor_114, target_3)
and vrandom_factor_114.getType().hasName("unsigned long")
and vrandom_factor_114.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
