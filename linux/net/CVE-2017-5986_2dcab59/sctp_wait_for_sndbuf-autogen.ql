/**
 * @name linux-2dcab598484185dea7ec22219c76dcdd59e3cb90-sctp_wait_for_sndbuf
 * @id cpp/linux/2dcab598484185dea7ec22219c76dcdd59e3cb90/sctp-wait-for-sndbuf
 * @description linux-2dcab598484185dea7ec22219c76dcdd59e3cb90-net/sctp/socket.c-sctp_wait_for_sndbuf CVE-2017-5986
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vsk_7399, Parameter vasoc_7396, EqualityOperation target_1) {
		target_1.getAnOperand().(VariableAccess).getTarget()=vsk_7399
		and target_1.getAnOperand().(ValueFieldAccess).getTarget().getName()="sk"
		and target_1.getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="base"
		and target_1.getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vasoc_7396
		and target_1.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_2(Function func, GotoStmt target_2) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Function func, DoStmt target_3) {
		target_3.getCondition() instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof EqualityOperation
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
		and target_3.getEnclosingFunction() = func
}

/*predicate func_4(DoStmt target_5, Function func, FunctionCall target_4) {
		target_4.getTarget().hasName("__builtin_expect")
		and target_4.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof EqualityOperation
		and target_4.getArgument(1) instanceof Literal
		and target_4.getParent().(IfStmt).getThen()=target_5
		and target_4.getEnclosingFunction() = func
}

*/
/*predicate func_5(FunctionCall target_4, Function func, DoStmt target_5) {
		target_5.getCondition() instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_5.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_5.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
		and target_5.getParent().(IfStmt).getCondition()=target_4
		and target_5.getEnclosingFunction() = func
}

*/
/*predicate func_6(Function func, AsmStmt target_6) {
		target_6.getChild(0) instanceof StringLiteral
		and target_6.getChild(1) instanceof Literal
		and target_6.getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_6.getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_6.getEnclosingFunction() = func
}

*/
/*predicate func_7(Function func, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
		and target_7.getEnclosingFunction() = func
}

*/
from Function func, Variable vsk_7399, Parameter vasoc_7396, EqualityOperation target_1, GotoStmt target_2, DoStmt target_3
where
func_1(vsk_7399, vasoc_7396, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and vsk_7399.getType().hasName("sock *")
and vasoc_7396.getType().hasName("sctp_association *")
and vsk_7399.(LocalVariable).getFunction() = func
and vasoc_7396.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
