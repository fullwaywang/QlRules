/**
 * @name linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-expand_stack
 * @id cpp/linux/1be7107fbe18eed3e319a6c3e83c78254b693acb/expand-stack
 * @description linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-include/linux/mm.h-expand_stack CVE-2017-1000379
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, DeclStmt target_0) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

predicate func_1(Parameter vaddress_2387, Function func, ExprStmt target_1) {
		target_1.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=vaddress_2387
		and target_1.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709547520"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Parameter vvma_2387, Variable vprev_2389, Function func, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vprev_2389
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="vm_prev"
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_2387
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Parameter vaddress_2387, Variable vprev_2389, Function func, IfStmt target_3) {
		target_3.getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vprev_2389
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vprev_2389
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vaddress_2387
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vprev_2389
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

/*predicate func_4(Variable vprev_2389, LogicalAndExpr target_5, IfStmt target_4) {
		target_4.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
		and target_4.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vprev_2389
		and target_4.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
		and target_4.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

*/
predicate func_5(Variable vprev_2389, LogicalAndExpr target_5) {
		target_5.getAnOperand().(VariableAccess).getTarget()=vprev_2389
		and target_5.getAnOperand() instanceof EqualityOperation
}

from Function func, Parameter vaddress_2387, Parameter vvma_2387, Variable vprev_2389, DeclStmt target_0, ExprStmt target_1, ExprStmt target_2, IfStmt target_3, LogicalAndExpr target_5
where
func_0(func, target_0)
and func_1(vaddress_2387, func, target_1)
and func_2(vvma_2387, vprev_2389, func, target_2)
and func_3(vaddress_2387, vprev_2389, func, target_3)
and func_5(vprev_2389, target_5)
and vaddress_2387.getType().hasName("unsigned long")
and vvma_2387.getType().hasName("vm_area_struct *")
and vprev_2389.getType().hasName("vm_area_struct *")
and vaddress_2387.getFunction() = func
and vvma_2387.getFunction() = func
and vprev_2389.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
