/**
 * @name linux-f1ce3986baa62cffc3c5be156994de87524bab99-ne_create_vm_ioctl
 * @id cpp/linux/f1ce3986baa62cffc3c5be156994de87524bab99/ne-create-vm-ioctl
 * @description linux-f1ce3986baa62cffc3c5be156994de87524bab99-ne_create_vm_ioctl CVE-2021-3543
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vslot_uid_1535, Variable vne_enclave_1541, ExprStmt target_11, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
		and target_0.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vslot_uid_1535
		and target_0.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="slot_uid"
		and target_0.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vne_enclave_1541
		and target_0.getCondition().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_0.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
		and target_0.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-14"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_0.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_4(Variable venclave_file_1539, FunctionCall target_4) {
		target_4.getTarget().hasName("fput")
		and target_4.getArgument(0).(VariableAccess).getTarget()=venclave_file_1539
}

*/
/*predicate func_5(Variable venclave_fd_1538, FunctionCall target_5) {
		target_5.getTarget().hasName("put_unused_fd")
		and target_5.getArgument(0).(VariableAccess).getTarget()=venclave_fd_1538
}

*/
predicate func_6(Variable venclave_file_1539, Function func, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("fput")
		and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venclave_file_1539
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable venclave_fd_1538, Function func, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("put_unused_fd")
		and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venclave_fd_1538
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vne_enclave_1541, VariableAccess target_8) {
		target_8.getTarget()=vne_enclave_1541
}

predicate func_9(Parameter vslot_uid_1535, VariableAccess target_9) {
		target_9.getTarget()=vslot_uid_1535
}

predicate func_10(Parameter vslot_uid_1535, Variable vne_enclave_1541, AssignExpr target_10) {
		target_10.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vslot_uid_1535
		and target_10.getRValue().(PointerFieldAccess).getTarget().getName()="slot_uid"
		and target_10.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vne_enclave_1541
}

predicate func_11(Variable vne_enclave_1541, ExprStmt target_11) {
		target_11.getExpr().(FunctionCall).getTarget().hasName("free_cpumask_var")
		and target_11.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="vcpu_ids"
		and target_11.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vne_enclave_1541
}

from Function func, Parameter vslot_uid_1535, Variable venclave_fd_1538, Variable venclave_file_1539, Variable vne_enclave_1541, ExprStmt target_6, ExprStmt target_7, VariableAccess target_8, VariableAccess target_9, AssignExpr target_10, ExprStmt target_11
where
not func_0(vslot_uid_1535, vne_enclave_1541, target_11, func)
and func_6(venclave_file_1539, func, target_6)
and func_7(venclave_fd_1538, func, target_7)
and func_8(vne_enclave_1541, target_8)
and func_9(vslot_uid_1535, target_9)
and func_10(vslot_uid_1535, vne_enclave_1541, target_10)
and func_11(vne_enclave_1541, target_11)
and vslot_uid_1535.getType().hasName("u64 *")
and venclave_fd_1538.getType().hasName("int")
and venclave_file_1539.getType().hasName("file *")
and vne_enclave_1541.getType().hasName("ne_enclave *")
and vslot_uid_1535.getFunction() = func
and venclave_fd_1538.(LocalVariable).getFunction() = func
and venclave_file_1539.(LocalVariable).getFunction() = func
and vne_enclave_1541.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
