/**
 * @name linux-a231ae6bb50e7c0a9e9efd7b0d10687f1d71b3a3-svcxdr_decode_sattr3
 * @id cpp/linux/a231ae6bb50e7c0a9e9efd7b0d10687f1d71b3a3/svcxdr-decode-sattr3
 * @description linux-a231ae6bb50e7c0a9e9efd7b0d10687f1d71b3a3-fs/nfsd/nfs3xdr.c-svcxdr_decode_sattr3 CVE-2022-48829
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vnewsize_252, VariableAccess target_0) {
	target_0.getTarget()=vnewsize_252
}

predicate func_1(Variable vnewsize_252, Variable v__UNIQUE_ID___x1615_257, Variable v__UNIQUE_ID___y1616_257, BuiltInChooseExpr target_1) {
	exists(ConditionalExpr obj_0 | obj_0=target_1.getChild(1) |
		exists(RelationalOperation obj_1 | obj_1=obj_0.getCondition() |
			obj_1.getLesserOperand().(VariableAccess).getTarget()=vnewsize_252
			and obj_1.getGreaterOperand().(BinaryBitwiseOperation).getValue()="9223372036854775807"
		)
		and obj_0.getThen().(VariableAccess).getTarget()=vnewsize_252
		and obj_0.getElse().(BinaryBitwiseOperation).getValue()="9223372036854775807"
	)
	and exists(StmtExpr obj_2 | obj_2=target_1.getChild(2) |
		exists(BlockStmt obj_3 | obj_3=obj_2.getStmt() |
			exists(ExprStmt obj_4 | obj_4=obj_3.getStmt(2) |
				exists(ConditionalExpr obj_5 | obj_5=obj_4.getExpr() |
					exists(RelationalOperation obj_6 | obj_6=obj_5.getCondition() |
						obj_6.getLesserOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___x1615_257
						and obj_6.getGreaterOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___y1616_257
					)
					and obj_5.getThen().(VariableAccess).getTarget()=v__UNIQUE_ID___x1615_257
					and obj_5.getElse().(VariableAccess).getTarget()=v__UNIQUE_ID___y1616_257
				)
			)
		)
	)
	and exists(AssignExpr obj_7 | obj_7=target_1.getParent() |
		exists(PointerFieldAccess obj_8 | obj_8=obj_7.getLValue() |
			obj_8.getTarget().getName()="ia_size"
			and obj_8.getQualifier().(VariableAccess).getTarget().getType().hasName("iattr *")
		)
		and obj_7.getRValue() = target_1
	)
	and target_1.getChild(0).(LogicalAndExpr).getValue()="0"
}

/*predicate func_4(Variable v__UNIQUE_ID___x1615_257, Variable v__UNIQUE_ID___y1616_257, ExprStmt target_4) {
	exists(ConditionalExpr obj_0 | obj_0=target_4.getExpr() |
		exists(RelationalOperation obj_1 | obj_1=obj_0.getCondition() |
			obj_1.getLesserOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___x1615_257
			and obj_1.getGreaterOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___y1616_257
		)
		and obj_0.getThen().(VariableAccess).getTarget()=v__UNIQUE_ID___x1615_257
		and obj_0.getElse().(VariableAccess).getTarget()=v__UNIQUE_ID___y1616_257
	)
}

*/
from Function func, Variable vnewsize_252, Variable v__UNIQUE_ID___x1615_257, Variable v__UNIQUE_ID___y1616_257, VariableAccess target_0, BuiltInChooseExpr target_1
where
func_0(vnewsize_252, target_0)
and func_1(vnewsize_252, v__UNIQUE_ID___x1615_257, v__UNIQUE_ID___y1616_257, target_1)
and vnewsize_252.getType().hasName("u64")
and v__UNIQUE_ID___x1615_257.getType().hasName("u64")
and v__UNIQUE_ID___y1616_257.getType().hasName("u64")
and vnewsize_252.(LocalVariable).getFunction() = func
and v__UNIQUE_ID___x1615_257.(LocalVariable).getFunction() = func
and v__UNIQUE_ID___y1616_257.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
