/**
 * @name linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-perf_event_for_each
 * @id cpp/linux/f63a8daa5812afef4f06c962351687e1ff9ccb2b/perf-event-for-each
 * @description linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-kernel/events/core.c-perf_event_for_each CVE-2016-6787
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable v__ret_warn_once_3734, VariableAccess target_0) {
	target_0.getTarget()=v__ret_warn_once_3734
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_1(ExprStmt target_16, Function func) {
exists(DoStmt target_1 |
	target_1.getCondition() instanceof Literal
	and target_1.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_16.getLocation()))
}

predicate func_2(Function func) {
exists(LogicalAndExpr target_2 |
	target_2.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_2.getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("lock_is_held")
	and target_2.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dep_map"
	and target_2.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier() instanceof AddressOfExpr
	and target_2.getEnclosingFunction() = func)
}

/*predicate func_3(Function func) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("lock_is_held")
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dep_map"
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier() instanceof AddressOfExpr
	and target_3.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
	and target_3.getEnclosingFunction() = func)
}

*/
predicate func_4(Variable vctx_3731, AddressOfExpr target_4) {
	target_4.getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_3731
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_8(Variable vctx_3731, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="parent_ctx"
	and target_8.getQualifier().(VariableAccess).getTarget()=vctx_3731
}

predicate func_9(Variable v__warned_3734, Variable v__ret_warn_once_3734, IfStmt target_9) {
	target_9.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_once_3734
	and target_9.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_9.getThen().(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_9.getThen().(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_9.getThen().(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("warn_slowpath_null")
	and target_9.getThen().(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_9.getThen().(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_9.getThen().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_3734
}

/*predicate func_10(Variable v__ret_warn_once_3734, NotExpr target_10) {
	target_10.getOperand().(VariableAccess).getTarget()=v__ret_warn_once_3734
	and target_10.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_10.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
}

*/
predicate func_12(Variable v__warned_3734, NotExpr target_12) {
	target_12.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_3734
}

predicate func_13(Variable v__ret_warn_once_3734, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_13.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_once_3734
	and target_13.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_14(Function func, ExprStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_14.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_14.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Variable vctx_3731, Function func, ExprStmt target_15) {
	target_15.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_3731
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Function func, ExprStmt target_16) {
	target_16.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof IfStmt
	and target_16.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
	and target_16.getEnclosingFunction() = func
}

from Function func, Variable vctx_3731, Variable v__warned_3734, Variable v__ret_warn_once_3734, VariableAccess target_0, AddressOfExpr target_4, PointerFieldAccess target_8, IfStmt target_9, NotExpr target_12, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16
where
func_0(v__ret_warn_once_3734, target_0)
and not func_1(target_16, func)
and not func_2(func)
and func_4(vctx_3731, target_4)
and func_8(vctx_3731, target_8)
and func_9(v__warned_3734, v__ret_warn_once_3734, target_9)
and func_12(v__warned_3734, target_12)
and func_13(v__ret_warn_once_3734, target_13)
and func_14(func, target_14)
and func_15(vctx_3731, func, target_15)
and func_16(func, target_16)
and vctx_3731.getType().hasName("perf_event_context *")
and v__warned_3734.getType().hasName("bool")
and v__ret_warn_once_3734.getType().hasName("int")
and vctx_3731.(LocalVariable).getFunction() = func
and v__warned_3734.(LocalVariable).getFunction() = func
and v__ret_warn_once_3734.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
