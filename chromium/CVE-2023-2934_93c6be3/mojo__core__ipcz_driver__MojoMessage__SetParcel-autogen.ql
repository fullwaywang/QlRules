/**
 * @name chromium-93c6be3a42e702101af2f528bf79d624cd3bfed9-mojo__core__ipcz_driver__MojoMessage__SetParcel
 * @id cpp/chromium/93c6be3a42e702101af2f528bf79d624cd3bfed9/mojocoreipczdrivermojomessagesetparcel
 * @description chromium-93c6be3a42e702101af2f528bf79d624cd3bfed9-mojo/core/ipcz_driver/mojo_message.cc-mojo__core__ipcz_driver__MojoMessage__SetParcel CVE-2023-2934
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtrue_if_passed, ConstructorCall target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getArgument(0) |
		obj_0.getTarget().hasName("log_message")
		and obj_0.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
	)
}

predicate func_1(Variable vnum_handles_106, Variable vresult_107, SwitchStmt target_27, ExprStmt target_1) {
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		exists(VariableCall obj_1 | obj_1=obj_0.getRValue() |
			exists(ReferenceFieldAccess obj_2 | obj_2=obj_1.getExpr() |
				obj_2.getTarget().getName()="EndGet"
				and obj_2.getQualifier().(FunctionCall).getTarget().hasName("GetIpczAPI")
			)
			and exists(FunctionCall obj_3 | obj_3=obj_1.getArgument(0) |
				exists(PointerFieldAccess obj_4 | obj_4=obj_3.getQualifier() |
					obj_4.getTarget().getName()="parcel_"
					and obj_4.getQualifier().(ThisExpr).getType() instanceof PointerType
				)
				and obj_3.getTarget().hasName("get")
			)
			and exists(FunctionCall obj_5 | obj_5=obj_1.getArgument(5) |
				exists(PointerFieldAccess obj_6 | obj_6=obj_5.getQualifier() |
					obj_6.getTarget().getName()="handles_"
					and obj_6.getQualifier().(ThisExpr).getType() instanceof PointerType
				)
				and obj_5.getTarget().hasName("data")
			)
			and obj_1.getArgument(1).(Literal).getValue()="0"
			and obj_1.getArgument(2).(VariableAccess).getTarget()=vnum_handles_106
			and obj_1.getArgument(3) instanceof Literal
			and obj_1.getArgument(4).(Literal).getValue()="0"
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vresult_107
	)
	and target_1.getLocation().isBefore(target_27.getLocation())
}

predicate func_2(SwitchStmt target_15, Function func, ExprStmt target_2) {
	target_2.getExpr() instanceof AssignExpr
	and target_2.getLocation().isBefore(target_15.getLocation())
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vnum_bytes_105, AddressOfExpr target_28) {
exists(RelationalOperation target_3 |
	 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getGreaterOperand().(VariableAccess).getTarget()=vnum_bytes_105
	and target_3.getLesserOperand() instanceof Literal
	and target_3.getParent().(IfStmt).getThen() instanceof EmptyStmt
	and target_28.getOperand().(VariableAccess).getLocation().isBefore(target_3.getGreaterOperand().(VariableAccess).getLocation())
)
}

predicate func_4(Variable vnum_bytes_105) {
exists(FunctionCall target_4 |
	exists(PointerFieldAccess obj_0 | obj_0=target_4.getQualifier() |
		obj_0.getTarget().getName()="data_storage_"
		and obj_0.getQualifier() instanceof ThisExpr
	)
	and exists(FunctionCall obj_1 | obj_1=target_4.getArgument(0) |
		obj_1.getTarget().hasName("AllocNonScannable")
		and obj_1.getArgument(0).(VariableAccess).getTarget()=vnum_bytes_105
	)
	and target_4.getTarget().hasName("reset")
)
}

predicate func_5(Variable vdata_104, Variable vnum_bytes_105, ConstructorCall target_10) {
exists(FunctionCall target_5 |
	exists(FunctionCall obj_0 | obj_0=target_5.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="data_storage_"
			and obj_1.getQualifier().(ThisExpr).getType() instanceof PointerType
		)
		and obj_0.getTarget().hasName("get")
	)
	and exists(VariableAccess obj_2 | obj_2=target_5.getArgument(2) |
		obj_2.getTarget()=vnum_bytes_105
		and obj_2.getLocation().isBefore(target_10.getArgument(0).(VariableAccess).getLocation())
	)
	and target_5.getTarget().hasName("memcpy")
	and target_5.getArgument(1).(VariableAccess).getTarget()=vdata_104
)
}

predicate func_6(Function func) {
exists(FunctionCall target_6 |
	exists(PointerFieldAccess obj_0 | obj_0=target_6.getQualifier() |
		obj_0.getTarget().getName()="data_storage_"
		and obj_0.getQualifier().(ThisExpr).getType() instanceof PointerType
	)
	and target_6.getTarget().hasName("reset")
	and target_6.getEnclosingFunction() = func
)
}

predicate func_7(Function func) {
exists(FunctionCall target_7 |
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getQualifier() |
		obj_0.getTarget().getName()="data_storage_"
		and obj_0.getQualifier().(ThisExpr).getType() instanceof PointerType
	)
	and target_7.getTarget().hasName("get")
	and target_7.getParent().(ConstructorCall).getParent().(ExprStmt).getExpr() instanceof ConstructorCall
	and target_7.getEnclosingFunction() = func
)
}

predicate func_8(Variable vnum_bytes_105, SwitchStmt target_27, AddressOfExpr target_28, Function func) {
exists(ExprStmt target_8 |
	exists(AssignExpr obj_0 | obj_0=target_8.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="data_storage_size_"
			and obj_1.getQualifier().(ThisExpr).getType() instanceof PointerType
		)
		and obj_0.getRValue().(VariableAccess).getTarget()=vnum_bytes_105
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_27.getLocation())
	and target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_28.getOperand().(VariableAccess).getLocation())
)
}

predicate func_10(Variable vnum_bytes_105, ConstructorCall target_10) {
	target_10.getArgument(0).(VariableAccess).getTarget()=vnum_bytes_105
}

predicate func_11(Function func, ThisExpr target_11) {
	target_11.getType() instanceof PointerType
	and target_11.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
	and target_11.getEnclosingFunction() = func
}

predicate func_13(Variable vdata_104, VariableAccess target_13) {
	target_13.getTarget()=vdata_104
	and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Variable vdata_104, Variable vnum_bytes_105, Variable vnum_handles_106, Variable vresult_107, AssignExpr target_14) {
	exists(VariableCall obj_0 | obj_0=target_14.getRValue() |
		exists(ReferenceFieldAccess obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getTarget().getName()="BeginGet"
			and obj_1.getQualifier().(FunctionCall).getTarget().hasName("GetIpczAPI")
		)
		and exists(FunctionCall obj_2 | obj_2=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
				obj_3.getTarget().getName()="parcel_"
				and obj_3.getQualifier() instanceof ThisExpr
			)
			and obj_2.getTarget().hasName("get")
		)
		and obj_0.getArgument(1).(Literal).getValue()="0"
		and obj_0.getArgument(2).(Literal).getValue()="0"
		and obj_0.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdata_104
		and obj_0.getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnum_bytes_105
		and obj_0.getArgument(5).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnum_handles_106
	)
	and target_14.getLValue().(VariableAccess).getTarget()=vresult_107
}

predicate func_15(Variable vtrue_if_passed, Function func, SwitchStmt target_15) {
	exists(BlockStmt obj_0 | obj_0=target_15.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(ConditionDeclExpr obj_2 | obj_2=obj_1.getCondition() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getChild(0) |
					obj_3.getTarget().hasName("operator bool")
					and obj_3.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
				)
			)
			and obj_1.getElse().(ExprStmt).getExpr() instanceof ConstructorCall
		)
		and obj_0.getStmt(0).(SwitchCase).getExpr() instanceof Literal
		and obj_0.getStmt(1).(SwitchCase).toString() = "default: "
	)
	and target_15.getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

/*predicate func_16(Function func, SwitchCase target_16) {
	target_16.getExpr() instanceof Literal
	and target_16.getEnclosingFunction() = func
}

*/
/*predicate func_17(Function func, SwitchCase target_17) {
	target_17.toString() = "default: "
	and target_17.getEnclosingFunction() = func
}

*/
/*predicate func_18(Variable vtrue_if_passed, FunctionCall target_29, ConditionDeclExpr target_18) {
	exists(FunctionCall obj_0 | obj_0=target_18.getChild(0) |
		obj_0.getTarget().hasName("operator bool")
		and obj_0.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
	)
	and target_18.getParent().(IfStmt).getThen() instanceof EmptyStmt
	and target_29.getQualifier().(VariableAccess).getLocation().isBefore(target_18.getChild(0).(FunctionCall).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_19(ConditionDeclExpr target_18, Function func, EmptyStmt target_19) {
	target_19.getParent().(IfStmt).getCondition()=target_18
	and target_19.getEnclosingFunction() = func
}

*/
predicate func_20(Variable vtrue_if_passed, VariableAccess target_20) {
	target_20.getTarget()=vtrue_if_passed
	and target_20.getParent().(FunctionCall).getParent().(ConstructorCall).getParent().(ExprStmt).getExpr() instanceof ConstructorCall
}

predicate func_21(Variable vtrue_if_passed, Function func, SwitchStmt target_21) {
	exists(BlockStmt obj_0 | obj_0=target_21.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(ConditionDeclExpr obj_2 | obj_2=obj_1.getCondition() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getChild(0) |
					obj_3.getTarget().hasName("operator bool")
					and obj_3.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
				)
			)
			and exists(ExprStmt obj_4 | obj_4=obj_1.getElse() |
				exists(ConstructorCall obj_5 | obj_5=obj_4.getExpr() |
					exists(FunctionCall obj_6 | obj_6=obj_5.getArgument(0) |
						obj_6.getTarget().hasName("log_message")
						and obj_6.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
					)
				)
			)
		)
		and obj_0.getStmt(0).(SwitchCase).getExpr() instanceof Literal
		and obj_0.getStmt(1).(SwitchCase).toString() = "default: "
	)
	and target_21.getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

/*predicate func_22(Function func, SwitchCase target_22) {
	target_22.getExpr() instanceof Literal
	and target_22.getEnclosingFunction() = func
}

*/
/*predicate func_23(Function func, SwitchCase target_23) {
	target_23.toString() = "default: "
	and target_23.getEnclosingFunction() = func
}

*/
/*predicate func_24(Variable vtrue_if_passed, Literal target_31, IfStmt target_24) {
	exists(ConditionDeclExpr obj_0 | obj_0=target_24.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getChild(0) |
			obj_1.getTarget().hasName("operator bool")
			and obj_1.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
		)
	)
	and exists(ExprStmt obj_2 | obj_2=target_24.getElse() |
		exists(ConstructorCall obj_3 | obj_3=obj_2.getExpr() |
			exists(FunctionCall obj_4 | obj_4=obj_3.getArgument(0) |
				obj_4.getTarget().hasName("log_message")
				and obj_4.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
			)
		)
	)
	and target_24.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_31
}

*/
/*predicate func_25(Variable vtrue_if_passed, ConstructorCall target_25) {
	exists(FunctionCall obj_0 | obj_0=target_25.getArgument(0) |
		obj_0.getTarget().hasName("log_message")
		and obj_0.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
	)
}

*/
predicate func_26(Variable vdata_104, FunctionCall target_26) {
	exists(AssignExpr obj_0 | obj_0=target_26.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="data_"
			and obj_1.getQualifier().(ThisExpr).getType() instanceof PointerType
		)
		and obj_0.getRValue() = target_26
	)
	and target_26.getTarget().hasName("make_span")
	and target_26.getArgument(0).(VariableAccess).getTarget()=vdata_104
	and target_26.getArgument(1) instanceof ConstructorCall
}

predicate func_27(Variable vtrue_if_passed, Function func, SwitchStmt target_27) {
	exists(BlockStmt obj_0 | obj_0=target_27.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(ConditionDeclExpr obj_2 | obj_2=obj_1.getCondition() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getChild(0) |
					obj_3.getTarget().hasName("operator bool")
					and obj_3.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
				)
			)
			and exists(ExprStmt obj_4 | obj_4=obj_1.getElse() |
				exists(ConstructorCall obj_5 | obj_5=obj_4.getExpr() |
					exists(FunctionCall obj_6 | obj_6=obj_5.getArgument(0) |
						obj_6.getTarget().hasName("log_message")
						and obj_6.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
					)
				)
			)
		)
		and obj_0.getStmt(0).(SwitchCase).getExpr() instanceof Literal
		and obj_0.getStmt(1).(SwitchCase).toString() = "default: "
	)
	and target_27.getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_27
}

predicate func_28(Variable vnum_bytes_105, AddressOfExpr target_28) {
	target_28.getOperand().(VariableAccess).getTarget()=vnum_bytes_105
	and target_28.getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
}

predicate func_29(Variable vtrue_if_passed, FunctionCall target_29) {
	target_29.getTarget().hasName("log_message")
	and target_29.getQualifier().(VariableAccess).getTarget()=vtrue_if_passed
}

from Function func, Variable vdata_104, Variable vnum_bytes_105, Variable vnum_handles_106, Variable vresult_107, Variable vtrue_if_passed, ConstructorCall target_0, ExprStmt target_1, ExprStmt target_2, ConstructorCall target_10, ThisExpr target_11, VariableAccess target_13, AssignExpr target_14, SwitchStmt target_15, VariableAccess target_20, SwitchStmt target_21, FunctionCall target_26, SwitchStmt target_27, AddressOfExpr target_28, FunctionCall target_29
where
func_0(vtrue_if_passed, target_0)
and func_1(vnum_handles_106, vresult_107, target_27, target_1)
and func_2(target_15, func, target_2)
and not func_3(vnum_bytes_105, target_28)
and not func_4(vnum_bytes_105)
and not func_5(vdata_104, vnum_bytes_105, target_10)
and not func_6(func)
and not func_7(func)
and not func_8(vnum_bytes_105, target_27, target_28, func)
and func_10(vnum_bytes_105, target_10)
and func_11(func, target_11)
and func_13(vdata_104, target_13)
and func_14(vdata_104, vnum_bytes_105, vnum_handles_106, vresult_107, target_14)
and func_15(vtrue_if_passed, func, target_15)
and func_20(vtrue_if_passed, target_20)
and func_21(vtrue_if_passed, func, target_21)
and func_26(vdata_104, target_26)
and func_27(vtrue_if_passed, func, target_27)
and func_28(vnum_bytes_105, target_28)
and func_29(vtrue_if_passed, target_29)
and vdata_104.getType().hasName("const void *")
and vnum_bytes_105.getType().hasName("size_t")
and vnum_handles_106.getType().hasName("size_t")
and vresult_107.getType().hasName("IpczResult")
and vtrue_if_passed.getType().hasName("CheckOpResult")
and vdata_104.(LocalVariable).getFunction() = func
and vnum_bytes_105.(LocalVariable).getFunction() = func
and vnum_handles_106.(LocalVariable).getFunction() = func
and vresult_107.(LocalVariable).getFunction() = func
and not vtrue_if_passed.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
