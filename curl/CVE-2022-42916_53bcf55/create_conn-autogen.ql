/**
 * @name curl-53bcf55b4538067e6-create_conn
 * @id cpp/curl/53bcf55b4538067e6/create-conn
 * @description curl-53bcf55b4538067e6-lib/url.c-create_conn CVE-2022-42916
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, Function func, ExprStmt target_0) {
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="host"
		and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

predicate func_1(Variable vresult_3608, ExprStmt target_0, Function func, IfStmt target_1) {
		target_1.getCondition().(VariableAccess).getTarget()=vresult_3608
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getCondition().(VariableAccess).getLocation())
}

predicate func_2(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, Function func, IfStmt target_2) {
		target_2.getCondition().(ValueFieldAccess).getTarget().getName()="conn_to_host"
		and target_2.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_2.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="conn_to_host"
		and target_2.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_3608
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, ValueFieldAccess target_11, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="conn_to_host"
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

/*predicate func_4(Variable vresult_3608, ValueFieldAccess target_11, ExprStmt target_3, IfStmt target_4) {
		target_4.getCondition().(VariableAccess).getTarget()=vresult_3608
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
		and target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getCondition().(VariableAccess).getLocation())
}

*/
predicate func_5(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, Function func, IfStmt target_5) {
		target_5.getCondition().(ValueFieldAccess).getTarget().getName()="httpproxy"
		and target_5.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_5.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_5.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_3608
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, ValueFieldAccess target_12, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="http_proxy"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

/*predicate func_7(Variable vresult_3608, ValueFieldAccess target_12, ExprStmt target_6, IfStmt target_7) {
		target_7.getCondition().(VariableAccess).getTarget()=vresult_3608
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
		and target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getCondition().(VariableAccess).getLocation())
}

*/
predicate func_8(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, Function func, IfStmt target_8) {
		target_8.getCondition().(ValueFieldAccess).getTarget().getName()="socksproxy"
		and target_8.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_8.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_8.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_3608
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, ValueFieldAccess target_13, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3608
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_3604
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="socks_proxy"
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
		and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
}

/*predicate func_10(Variable vresult_3608, ValueFieldAccess target_13, ExprStmt target_9, IfStmt target_10) {
		target_10.getCondition().(VariableAccess).getTarget()=vresult_3608
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
		and target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getCondition().(VariableAccess).getLocation())
}

*/
predicate func_11(Variable vconn_3609, ValueFieldAccess target_11) {
		target_11.getTarget().getName()="conn_to_host"
		and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
}

predicate func_12(Variable vconn_3609, ValueFieldAccess target_12) {
		target_12.getTarget().getName()="httpproxy"
		and target_12.getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
}

predicate func_13(Variable vconn_3609, ValueFieldAccess target_13) {
		target_13.getTarget().getName()="socksproxy"
		and target_13.getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3609
}

from Function func, Variable vresult_3608, Variable vconn_3609, Parameter vdata_3604, ExprStmt target_0, IfStmt target_1, IfStmt target_2, ExprStmt target_3, IfStmt target_5, ExprStmt target_6, IfStmt target_8, ExprStmt target_9, ValueFieldAccess target_11, ValueFieldAccess target_12, ValueFieldAccess target_13
where
func_0(vresult_3608, vconn_3609, vdata_3604, func, target_0)
and func_1(vresult_3608, target_0, func, target_1)
and func_2(vresult_3608, vconn_3609, vdata_3604, func, target_2)
and func_3(vresult_3608, vconn_3609, vdata_3604, target_11, target_3)
and func_5(vresult_3608, vconn_3609, vdata_3604, func, target_5)
and func_6(vresult_3608, vconn_3609, vdata_3604, target_12, target_6)
and func_8(vresult_3608, vconn_3609, vdata_3604, func, target_8)
and func_9(vresult_3608, vconn_3609, vdata_3604, target_13, target_9)
and func_11(vconn_3609, target_11)
and func_12(vconn_3609, target_12)
and func_13(vconn_3609, target_13)
and vresult_3608.getType().hasName("CURLcode")
and vconn_3609.getType().hasName("connectdata *")
and vdata_3604.getType().hasName("Curl_easy *")
and vresult_3608.(LocalVariable).getFunction() = func
and vconn_3609.(LocalVariable).getFunction() = func
and vdata_3604.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
