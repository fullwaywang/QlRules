/**
 * @name linux-0e5cc9a40ada6046e6bc3bdfcd0c0d7e4b706b14-udf_symlink_filler
 * @id cpp/linux/0e5cc9a40ada6046e6bc3bdfcd0c0d7e4b706b14/udf-symlink-filler
 * @description linux-0e5cc9a40ada6046e6bc3bdfcd0c0d7e4b706b14-fs/udf/symlink.c-udf_symlink_filler CVE-2014-9731
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinode_80, Variable vsymlink_82, Variable verr_83, Variable vp_84, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getTarget()=verr_83
		and target_0.getRValue().(FunctionCall).getTarget().hasName("udf_pc_to_char")
		and target_0.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_0.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_0.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsymlink_82
		and target_0.getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="i_size"
		and target_0.getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_0.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vp_84
		and target_0.getRValue().(FunctionCall).getArgument(4).(BinaryBitwiseOperation).getValue()="4096"
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLValue().(VariableAccess).getLocation()))
}

predicate func_1(Variable verr_83, ReturnStmt target_11, Function func) {
	exists(IfStmt target_1 |
		target_1.getCondition().(VariableAccess).getTarget()=verr_83
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getCondition().(VariableAccess).getLocation().isBefore(target_11.getExpr().(VariableAccess).getLocation()))
}

predicate func_2(Variable vinode_80, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="i_sb"
		and target_2.getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_3(Variable vinode_80, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="i_size"
		and target_3.getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Variable vsymlink_82, VariableAccess target_4) {
		target_4.getTarget()=vsymlink_82
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Variable vp_84, VariableAccess target_5) {
		target_5.getTarget()=vp_84
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Variable vinode_80, Variable vsymlink_82, Variable vp_84, FunctionCall target_6) {
		target_6.getTarget().hasName("udf_pc_to_char")
		and target_6.getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_6.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_6.getArgument(1).(VariableAccess).getTarget()=vsymlink_82
		and target_6.getArgument(2).(PointerFieldAccess).getTarget().getName()="i_size"
		and target_6.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_6.getArgument(3).(VariableAccess).getTarget()=vp_84
}

predicate func_7(Variable vinode_80, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("buffer_head *")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sb_bread")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_80
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("uint32_t")
}

predicate func_8(Variable vsymlink_82, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsymlink_82
		and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="b_data"
		and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("buffer_head *")
}

predicate func_9(Variable verr_83, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_83
		and target_9.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-5"
}

predicate func_11(Variable verr_83, ReturnStmt target_11) {
		target_11.getExpr().(VariableAccess).getTarget()=verr_83
}

from Function func, Variable vinode_80, Variable vsymlink_82, Variable verr_83, Variable vp_84, PointerFieldAccess target_2, PointerFieldAccess target_3, VariableAccess target_4, VariableAccess target_5, FunctionCall target_6, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9, ReturnStmt target_11
where
not func_0(vinode_80, vsymlink_82, verr_83, vp_84, target_7, target_8, target_9)
and not func_1(verr_83, target_11, func)
and func_2(vinode_80, target_2)
and func_3(vinode_80, target_3)
and func_4(vsymlink_82, target_4)
and func_5(vp_84, target_5)
and func_6(vinode_80, vsymlink_82, vp_84, target_6)
and func_7(vinode_80, target_7)
and func_8(vsymlink_82, target_8)
and func_9(verr_83, target_9)
and func_11(verr_83, target_11)
and vinode_80.getType().hasName("inode *")
and vsymlink_82.getType().hasName("unsigned char *")
and verr_83.getType().hasName("int")
and vp_84.getType().hasName("unsigned char *")
and vinode_80.(LocalVariable).getFunction() = func
and vsymlink_82.(LocalVariable).getFunction() = func
and verr_83.(LocalVariable).getFunction() = func
and vp_84.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
