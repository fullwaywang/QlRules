commit b4d09af9194d20a7f9f16995a062f5d8e3d32840	b4d09af9194d20a7f9f16995a062f5d8e3d32840
Author: Donatas Abraitis <donatas@opensourcerouting.org>
Date:   Sun Aug 20 21:37:25 2023 +0300

    bgpd: Check the length of the rcv software version
    
    Make sure we don't exceed the maximum of BGP_MAX_SOFT_VERSION.
    
    The Capability Length SHOULD be no greater than 64.
    
    Reported-by: Iggy Frankovic <iggyfran@amazon.com>
    Signed-off-by: Donatas Abraitis <donatas@opensourcerouting.org>

diff --git a/bgpd/bgp_open.c b/bgpd/bgp_open.c
index e826548e6..9cb88a2d6 100644
--- a/bgpd/bgp_open.c
+++ b/bgpd/bgp_open.c
@@ -911,8 +911,18 @@ static int bgp_capability_software_version(struct peer *peer,
 		return -1;
 	}
 
-	if (len) {
+	if (len > BGP_MAX_SOFT_VERSION) {
+		flog_warn(EC_BGP_CAPABILITY_INVALID_LENGTH,
+			  "%s: Received Software Version, but the length is too big, truncating, from peer %s",
+			  __func__, peer->host);
+		stream_get(str, s, BGP_MAX_SOFT_VERSION);
+		stream_forward_getp(s, len - BGP_MAX_SOFT_VERSION);
+		len = BGP_MAX_SOFT_VERSION;
+	} else if (len) {
 		stream_get(str, s, len);
+	}
+
+	if (len) {
 		str[len] = '\0';
 
 		XFREE(MTYPE_BGP_SOFT_VERSION, peer->soft_version);
