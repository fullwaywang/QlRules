/**
 * @name linux-a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8-ieee80211_deliver_skb
 * @id cpp/linux/a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8/ieee80211-deliver-skb
 * @description linux-a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8-net/mac80211/rx.c-ieee80211_deliver_skb CVE-2020-26139
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsdata_2581, Variable vehdr_2584, Parameter vrx_2579, BlockStmt target_2, LogicalAndExpr target_4, AddressOfExpr target_5, ExprStmt target_6) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand() instanceof LogicalAndExpr
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="h_proto"
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2584
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="control_port_protocol"
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sdata"
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrx_2579
	and target_0.getParent().(LogicalAndExpr).getLeftOperand() instanceof LogicalAndExpr
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdata_2581
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="sta"
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="vlan"
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_5.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable vsdata_2581, BlockStmt target_2, LogicalAndExpr target_1) {
	target_1.getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_1.getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_1.getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdata_2581
	and target_1.getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_1.getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_1.getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdata_2581
	and target_1.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_1.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdata_2581
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdata_2581
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="sta"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="vlan"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vsdata_2581, Variable vehdr_2584, BlockStmt target_2) {
	target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("is_multicast_ether_addr")
	and target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2584
	and target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("ieee80211_vif_get_num_mcast_if")
	and target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsdata_2581
	and target_2.getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_2.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_2.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_copy")
	and target_2.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_2.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_2.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition().(Literal).getValue()="0"
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("is_multicast_ether_addr")
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ether_addr_equal")
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="h_source"
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("sta_info *")
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sta_info_get")
	and target_2.getStmt(0).(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget().getType().hasName("sta_info *")
}

predicate func_4(Variable vsdata_2581, Variable vehdr_2584, LogicalAndExpr target_4) {
	target_4.getLeftOperand().(FunctionCall).getTarget().hasName("is_multicast_ether_addr")
	and target_4.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_4.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2584
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("ieee80211_vif_get_num_mcast_if")
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsdata_2581
	and target_4.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
}

predicate func_5(Parameter vrx_2579, AddressOfExpr target_5) {
	target_5.getOperand().(ValueFieldAccess).getTarget().getName()="syncp"
	and target_5.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rx_stats"
	and target_5.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sta"
	and target_5.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrx_2579
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("u64_stats_update_end")
}

predicate func_6(Parameter vrx_2579, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("ieee80211_deliver_skb_to_local_stack")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vrx_2579
}

from Function func, Variable vsdata_2581, Variable vehdr_2584, Parameter vrx_2579, LogicalAndExpr target_1, BlockStmt target_2, LogicalAndExpr target_4, AddressOfExpr target_5, ExprStmt target_6
where
not func_0(vsdata_2581, vehdr_2584, vrx_2579, target_2, target_4, target_5, target_6)
and func_1(vsdata_2581, target_2, target_1)
and func_2(vsdata_2581, vehdr_2584, target_2)
and func_4(vsdata_2581, vehdr_2584, target_4)
and func_5(vrx_2579, target_5)
and func_6(vrx_2579, target_6)
and vsdata_2581.getType().hasName("ieee80211_sub_if_data *")
and vehdr_2584.getType().hasName("ethhdr *")
and vrx_2579.getType().hasName("ieee80211_rx_data *")
and vsdata_2581.(LocalVariable).getFunction() = func
and vehdr_2584.(LocalVariable).getFunction() = func
and vrx_2579.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
