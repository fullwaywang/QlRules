/**
 * @name linux-6daca13d2e72bedaaacfc08f873114c9307d5aea-encrypt_authorizer
 * @id cpp/linux/6daca13d2e72bedaaacfc08f873114c9307d5aea/encrypt-authorizer
 * @description linux-6daca13d2e72bedaaacfc08f873114c9307d5aea-net/ceph/auth_x.c-encrypt_authorizer CVE-2018-1128
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmsg_b_301, Literal target_0) {
	target_0.getValue()="1"
	and not target_0.getValue()="2"
	and target_0.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="struct_v"
	and target_0.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
}

predicate func_1(Function func, SizeofExprOperator target_1) {
	target_1.getValue()="9"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="454"
	and not target_2.getValue()="455"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vmsg_b_301, ExprStmt target_9, ExprStmt target_10, SizeofExprOperator target_1, Function func) {
exists(IfStmt target_3 |
	target_3.getCondition().(VariableAccess).getType().hasName("u64 *")
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="have_challenge"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="server_challenge_plus_one"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getType().hasName("u64 *")
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(Literal).getValue()="1"
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="have_challenge"
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="server_challenge_plus_one"
	and target_3.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
	and target_3.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_9.getLocation())
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(ExprStmt target_11, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(VariableAccess).getType().hasName("u64 *")
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_4.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getElse().(BlockStmt).getStmt(1) instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_11.getLocation()))
}

/*predicate func_5(Variable v__ret_warn_on_319, ExprStmt target_7) {
exists(IfStmt target_5 |
	target_5.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_5.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_319
	and target_5.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_5.getThen().(DoStmt).getCondition() instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_5.getLocation().isBefore(target_7.getLocation()))
}

*/
predicate func_7(Variable v__ret_warn_on_319, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_7.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_319
	and target_7.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

predicate func_8(Parameter vau_298, Variable vp_302, Function func, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_len"
	and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vec"
	and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="buf"
	and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vau_298
	and target_8.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vp_302
	and target_8.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(ValueFieldAccess).getTarget().getName()="iov_base"
	and target_8.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vec"
	and target_8.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="buf"
	and target_8.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vau_298
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vau_298, Variable vp_302, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_x_encrypt")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="session_key"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vau_298
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vp_302
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("void *")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vp_302
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3) instanceof SizeofExprOperator
}

predicate func_10(Parameter vau_298, Variable vmsg_b_301, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="nonce"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_b_301
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="nonce"
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vau_298
}

predicate func_11(Function func, ExprStmt target_11) {
	target_11.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_11.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_11.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_11.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_11.getEnclosingFunction() = func
}

from Function func, Parameter vau_298, Variable vmsg_b_301, Variable vp_302, Variable v__ret_warn_on_319, Literal target_0, SizeofExprOperator target_1, Literal target_2, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11
where
func_0(vmsg_b_301, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and not func_3(vmsg_b_301, target_9, target_10, target_1, func)
and not func_4(target_11, func)
and func_7(v__ret_warn_on_319, target_7)
and func_8(vau_298, vp_302, func, target_8)
and func_9(vau_298, vp_302, target_9)
and func_10(vau_298, vmsg_b_301, target_10)
and func_11(func, target_11)
and vau_298.getType().hasName("ceph_x_authorizer *")
and vmsg_b_301.getType().hasName("ceph_x_authorize_b *")
and vp_302.getType().hasName("void *")
and v__ret_warn_on_319.getType().hasName("int")
and vau_298.getFunction() = func
and vmsg_b_301.(LocalVariable).getFunction() = func
and vp_302.(LocalVariable).getFunction() = func
and v__ret_warn_on_319.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
