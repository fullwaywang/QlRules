/**
 * @name linux-9056d6489f5a41cfbb67f719d2c0ce61ead72d9f-gc_data_segment
 * @id cpp/linux/9056d6489f5a41cfbb67f719d2c0ce61ead72d9f/gc-data-segment
 * @description linux-9056d6489f5a41cfbb67f719d2c0ce61ead72d9f-fs/f2fs/gc.c-gc_data_segment CVE-2021-44879
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinode_1417, LogicalOrExpr target_1) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand() instanceof LogicalOrExpr
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="8192"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="24576"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1417
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="4096"
	and target_0.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
	and target_0.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1417
	and target_0.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
	and target_0.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="49152"
	and target_0.getParent().(IfStmt).getThen() instanceof ContinueStmt
	and target_0.getRightOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vinode_1417, LogicalOrExpr target_1) {
	target_1.getLeftOperand().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_1.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1417
	and target_1.getRightOperand().(FunctionCall).getTarget().hasName("is_bad_inode")
	and target_1.getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1417
	and target_1.getParent().(IfStmt).getThen() instanceof ContinueStmt
}

from Function func, Variable vinode_1417, LogicalOrExpr target_1
where
not func_0(vinode_1417, target_1)
and func_1(vinode_1417, target_1)
and vinode_1417.getType().hasName("inode *")
and vinode_1417.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
