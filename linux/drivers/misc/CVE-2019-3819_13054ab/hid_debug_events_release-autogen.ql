/**
 * @name linux-13054abbaa4f1fd4e6f3b4b63439ec033b4c8035-hid_debug_events_release
 * @id cpp/linux/13054abbaa4f1fd4e6f3b4b63439ec033b4c8035/hid-debug-events-release
 * @description linux-13054abbaa4f1fd4e6f3b4b63439ec033b4c8035-drivers/hid/hid-debug.c-hid_debug_events_release CVE-2019-3819
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vlist_1197, FunctionCall target_0) {
		target_0.getTarget().hasName("kfree")
		and not target_0.getTarget().hasName("__kfifo_free")
		and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="hid_debug_buf"
		and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlist_1197
}

predicate func_1(Function func) {
	exists(StmtExpr target_1 |
		target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getValue()="1"
		and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__kfifo_free")
		and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("__kfifo *")
		and target_1.getEnclosingFunction() = func)
}

predicate func_3(Variable vlist_1197, VariableAccess target_3) {
		target_3.getTarget()=vlist_1197
		and target_3.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Variable vlist_1197, FunctionCall target_0, VariableAccess target_3
where
func_0(vlist_1197, target_0)
and not func_1(func)
and func_3(vlist_1197, target_3)
and vlist_1197.getType().hasName("hid_debug_list *")
and vlist_1197.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
