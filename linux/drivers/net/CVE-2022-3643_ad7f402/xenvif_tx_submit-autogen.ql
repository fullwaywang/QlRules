/**
 * @name linux-ad7f402ae4f466647c3a669b8a6f3e5d4271c84a-xenvif_tx_submit
 * @id cpp/linux/ad7f402ae4f466647c3a669b8a6f3e5d4271c84a/xenvif-tx-submit
 * @description linux-ad7f402ae4f466647c3a669b8a6f3e5d4271c84a-drivers/net/xen-netback/netback.c-xenvif_tx_submit CVE-2022-3643
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vskb_1111, Variable vpending_idx_1116, NotExpr target_11) {
exists(ArrayExpr target_0 |
	target_0.getArrayBase().(PointerFieldAccess).getTarget().getName()="copy_pending_idx"
	and target_0.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cb"
	and target_0.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1111
	and target_0.getArrayOffset() instanceof Literal
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpending_idx_1116
	and target_0.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable vskb_1111, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="cb"
	and target_1.getQualifier().(VariableAccess).getTarget()=vskb_1111
}

predicate func_4(Variable vskb_1111, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="pending_idx"
	and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="cb"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1111
}

predicate func_5(Variable vskb_1111, Variable vdata_len_1117, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdata_len_1117
	and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="len"
	and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1111
}

predicate func_6(Function func, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ctx"
	and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="callback_struct"
	and target_6.getExpr().(AssignExpr).getRValue() instanceof Literal
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vtxp_1115, Variable vpending_idx_1116, Variable vdata_len_1117, Parameter vqueue_1107, IfStmt target_7) {
	target_7.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vdata_len_1117
	and target_7.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="size"
	and target_7.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="offset"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vdata_len_1117
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vdata_len_1117
	and target_7.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("xenvif_idx_release")
	and target_7.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vqueue_1107
	and target_7.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpending_idx_1116
	and target_7.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="0"
}

/*predicate func_8(Variable vtxp_1115, Variable vdata_len_1117, RelationalOperation target_12, ExprStmt target_8) {
	target_8.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="offset"
	and target_8.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
	and target_8.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vdata_len_1117
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
/*predicate func_9(Variable vtxp_1115, Variable vdata_len_1117, RelationalOperation target_12, ExprStmt target_9) {
	target_9.getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_9.getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
	and target_9.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vdata_len_1117
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
/*predicate func_10(Variable vpending_idx_1116, Parameter vqueue_1107, RelationalOperation target_12, ExprStmt target_10) {
	target_10.getExpr().(FunctionCall).getTarget().hasName("xenvif_idx_release")
	and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vqueue_1107
	and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpending_idx_1116
	and target_10.getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
predicate func_11(Variable vskb_1111, Parameter vqueue_1107, NotExpr target_11) {
	target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("xenvif_tx_check_gop")
	and target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vqueue_1107
	and target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vskb_1111
	and target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("gnttab_map_grant_ref *")
	and target_11.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("gnttab_copy *")
}

predicate func_12(Variable vtxp_1115, Variable vdata_len_1117, RelationalOperation target_12) {
	 (target_12 instanceof GTExpr or target_12 instanceof LTExpr)
	and target_12.getLesserOperand().(VariableAccess).getTarget()=vdata_len_1117
	and target_12.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="size"
	and target_12.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtxp_1115
}

from Function func, Variable vskb_1111, Variable vtxp_1115, Variable vpending_idx_1116, Variable vdata_len_1117, Parameter vqueue_1107, PointerFieldAccess target_1, PointerFieldAccess target_4, ExprStmt target_5, ExprStmt target_6, IfStmt target_7, NotExpr target_11, RelationalOperation target_12
where
not func_0(vskb_1111, vpending_idx_1116, target_11)
and func_1(vskb_1111, target_1)
and func_4(vskb_1111, target_4)
and func_5(vskb_1111, vdata_len_1117, target_5)
and func_6(func, target_6)
and func_7(vtxp_1115, vpending_idx_1116, vdata_len_1117, vqueue_1107, target_7)
and func_11(vskb_1111, vqueue_1107, target_11)
and func_12(vtxp_1115, vdata_len_1117, target_12)
and vskb_1111.getType().hasName("sk_buff *")
and vtxp_1115.getType().hasName("xen_netif_tx_request *")
and vpending_idx_1116.getType().hasName("u16")
and vdata_len_1117.getType().hasName("unsigned int")
and vqueue_1107.getType().hasName("xenvif_queue *")
and vskb_1111.(LocalVariable).getFunction() = func
and vtxp_1115.(LocalVariable).getFunction() = func
and vpending_idx_1116.(LocalVariable).getFunction() = func
and vdata_len_1117.(LocalVariable).getFunction() = func
and vqueue_1107.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
