/**
 * @name linux-67f0d6d9883c13174669f88adac4f0ee656cc16a-rb_per_cpu_empty
 * @id cpp/linux/67f0d6d9883c13174669f88adac4f0ee656cc16a/rb-per-cpu-empty
 * @description linux-67f0d6d9883c13174669f88adac4f0ee656cc16a-rb_per_cpu_empty CVE-2021-3679
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vreader_3875, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="read"
		and target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreader_3875
		and target_0.getCondition().(EqualityOperation).getAnOperand() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_2(Function func) {
	exists(IfStmt target_2 |
		target_2.getCondition() instanceof EqualityOperation
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2)
}

predicate func_3(Variable vhead_3876, Variable vcommit_3877, NotExpr target_14, LogicalAndExpr target_12, Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcommit_3877
		and target_3.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vhead_3876
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_14.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_3.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_3.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_4(Function func) {
	exists(ReturnStmt target_4 |
		target_4.getExpr().(EqualityOperation).getAnOperand() instanceof FunctionCall
		and target_4.getExpr().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4)
}

predicate func_6(Variable vreader_3875, PointerFieldAccess target_6) {
		target_6.getTarget().getName()="read"
		and target_6.getQualifier().(VariableAccess).getTarget()=vreader_3875
}

predicate func_7(Variable vreader_3875, FunctionCall target_7) {
		target_7.getTarget().hasName("rb_page_commit")
		and target_7.getArgument(0).(VariableAccess).getTarget()=vreader_3875
}

predicate func_8(Variable vreader_3875, Variable vcommit_3877, EqualityOperation target_8) {
		target_8.getAnOperand().(VariableAccess).getTarget()=vcommit_3877
		and target_8.getAnOperand().(VariableAccess).getTarget()=vreader_3875
}

predicate func_9(Variable vcommit_3877, FunctionCall target_9) {
		target_9.getTarget().hasName("rb_page_commit")
		and target_9.getArgument(0).(VariableAccess).getTarget()=vcommit_3877
}

predicate func_10(Variable vcommit_3877, VariableAccess target_10) {
		target_10.getTarget()=vcommit_3877
}

predicate func_11(Variable vhead_3876, VariableAccess target_11) {
		target_11.getTarget()=vhead_3876
}

predicate func_12(Variable vreader_3875, Variable vhead_3876, Variable vcommit_3877, LogicalAndExpr target_12) {
		target_12.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="read"
		and target_12.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreader_3875
		and target_12.getAnOperand().(EqualityOperation).getAnOperand() instanceof FunctionCall
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand() instanceof EqualityOperation
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcommit_3877
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vhead_3876
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="read"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhead_3876
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand() instanceof FunctionCall
}

predicate func_14(Variable vhead_3876, NotExpr target_14) {
		target_14.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vhead_3876
}

from Function func, Variable vreader_3875, Variable vhead_3876, Variable vcommit_3877, PointerFieldAccess target_6, FunctionCall target_7, EqualityOperation target_8, FunctionCall target_9, VariableAccess target_10, VariableAccess target_11, LogicalAndExpr target_12, NotExpr target_14
where
not func_0(vreader_3875, func)
and not func_2(func)
and not func_3(vhead_3876, vcommit_3877, target_14, target_12, func)
and not func_4(func)
and func_6(vreader_3875, target_6)
and func_7(vreader_3875, target_7)
and func_8(vreader_3875, vcommit_3877, target_8)
and func_9(vcommit_3877, target_9)
and func_10(vcommit_3877, target_10)
and func_11(vhead_3876, target_11)
and func_12(vreader_3875, vhead_3876, vcommit_3877, target_12)
and func_14(vhead_3876, target_14)
and vreader_3875.getType().hasName("buffer_page *")
and vhead_3876.getType().hasName("buffer_page *")
and vcommit_3877.getType().hasName("buffer_page *")
and vreader_3875.(LocalVariable).getFunction() = func
and vhead_3876.(LocalVariable).getFunction() = func
and vcommit_3877.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
