/**
 * @name linux-99a83db5a605137424e1efe29dc0573d6a5b6316-update_mds_branch_idle
 * @id cpp/linux/99a83db5a605137424e1efe29dc0573d6a5b6316/update-mds-branch-idle
 * @description linux-99a83db5a605137424e1efe29dc0573d6a5b6316-arch/x86/kernel/cpu/bugs.c-update_mds_branch_idle CVE-2022-21166
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(FunctionCall target_3, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("mmio_mitigations")
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="16384"
	and target_0.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_0.getParent().(IfStmt).getCondition()=target_3
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable vmds_idle_clear, FunctionCall target_3, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("static_key_enable")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="key"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vmds_idle_clear
	and target_1.getParent().(IfStmt).getCondition()=target_3
}

predicate func_2(Variable vmds_idle_clear, FunctionCall target_3, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("static_key_disable")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="key"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vmds_idle_clear
	and target_2.getParent().(IfStmt).getCondition()=target_3
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("sched_smt_active")
	and target_3.getEnclosingFunction() = func
}

from Function func, Variable vmds_idle_clear, ExprStmt target_1, ExprStmt target_2, FunctionCall target_3
where
not func_0(target_3, func)
and func_1(vmds_idle_clear, target_3, target_1)
and func_2(vmds_idle_clear, target_3, target_2)
and func_3(func, target_3)
and vmds_idle_clear.getType().hasName("static_key_false")
and not vmds_idle_clear.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
