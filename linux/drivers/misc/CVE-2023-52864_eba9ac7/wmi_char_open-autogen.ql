/**
 * @name linux-eba9ac7abab91c8f6d351460239108bef5e7a0b6-wmi_char_open
 * @id cpp/linux/eba9ac7abab91c8f6d351460239108bef5e7a0b6/wmi-char-open
 * @description linux-eba9ac7abab91c8f6d351460239108bef5e7a0b6-drivers/platform/x86/wmi.c-wmi_char_open CVE-2023-52864
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(PointerFieldAccess).getTarget().getName()="d_iname"
	and target_0.getExpr().(PointerFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Function func, BuiltInOperationBuiltInOffsetOf target_1) {
	target_1.getValue()="1496"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func) {
exists(ValueFieldAccess target_2 |
	target_2.getTarget().getName()="char_dev"
	and target_2.getQualifier() instanceof PointerDereferenceExpr
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Function func, PointerDereferenceExpr target_3) {
	target_3.getOperand().(Literal).getValue()="0"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vwblock_962, Parameter vfilp_959, EqualityOperation target_22, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="private_data"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfilp_959
	and target_4.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vwblock_962
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

predicate func_5(Parameter vfilp_959, ReturnStmt target_23, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="private_data"
	and target_5.getQualifier().(VariableAccess).getTarget()=vfilp_959
	and target_5.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_23
}

predicate func_7(Parameter vfilp_959, ValueFieldAccess target_7) {
	target_7.getTarget().getName()="dentry"
	and target_7.getQualifier().(PointerFieldAccess).getTarget().getName()="f_path"
	and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfilp_959
}

predicate func_8(Function func, DeclStmt target_8) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vdriver_name_961, Variable vwblock_962, Variable vnext_963, Variable vwmi_block_list, ForStmt target_9) {
	target_9.getInitialization().(ExprStmt).getExpr().(CommaExpr).getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwblock_962
	and target_9.getInitialization().(ExprStmt).getExpr().(CommaExpr).getRightOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnext_963
	and target_9.getCondition().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
	and target_9.getCondition().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwblock_962
	and target_9.getCondition().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwmi_block_list
	and target_9.getUpdate().(CommaExpr).getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwblock_962
	and target_9.getUpdate().(CommaExpr).getLeftOperand().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnext_963
	and target_9.getUpdate().(CommaExpr).getRightOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnext_963
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="driver"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dev"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("strcmp")
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdriver_name_961
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="name"
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="driver"
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
}

predicate func_10(Variable vwmi_block_list, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="next"
	and target_10.getQualifier().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwmi_block_list
}

/*predicate func_14(Variable v__mptr_1_965, ExprStmt target_14) {
	target_14.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1_965
	and target_14.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="1496"
}

*/
/*predicate func_17(Variable v__mptr_2_965, ExprStmt target_17) {
	target_17.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_2_965
	and target_17.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="1496"
}

*/
/*predicate func_18(Variable vwblock_962, IfStmt target_18) {
	target_18.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="driver"
	and target_18.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dev"
	and target_18.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_18.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwblock_962
}

*/
/*predicate func_19(Variable vdriver_name_961, IfStmt target_19) {
	target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("strcmp")
	and target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdriver_name_961
	and target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="name"
	and target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="driver"
	and target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dev"
	and target_19.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_19.getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_19.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
}

*/
/*predicate func_20(EqualityOperation target_22, Function func, BreakStmt target_20) {
	target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_20.getEnclosingFunction() = func
}

*/
predicate func_21(Parameter vfilp_959, Function func, IfStmt target_21) {
	target_21.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="private_data"
	and target_21.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfilp_959
	and target_21.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-19"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_22(Function func, EqualityOperation target_22) {
	target_22.getLeftOperand() instanceof FunctionCall
	and target_22.getRightOperand() instanceof Literal
	and target_22.getEnclosingFunction() = func
}

predicate func_23(Function func, ReturnStmt target_23) {
	target_23.getExpr() instanceof UnaryMinusExpr
	and target_23.getEnclosingFunction() = func
}

from Function func, Variable vdriver_name_961, Variable vwblock_962, Variable vnext_963, Variable vwmi_block_list, Variable v__mptr_1_965, Variable v__mptr_2_965, Parameter vfilp_959, Initializer target_0, BuiltInOperationBuiltInOffsetOf target_1, PointerDereferenceExpr target_3, ExprStmt target_4, PointerFieldAccess target_5, ValueFieldAccess target_7, DeclStmt target_8, ForStmt target_9, PointerFieldAccess target_10, IfStmt target_21, EqualityOperation target_22, ReturnStmt target_23
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_2(func)
and func_3(func, target_3)
and func_4(vwblock_962, vfilp_959, target_22, target_4)
and func_5(vfilp_959, target_23, target_5)
and func_7(vfilp_959, target_7)
and func_8(func, target_8)
and func_9(vdriver_name_961, vwblock_962, vnext_963, vwmi_block_list, target_9)
and func_10(vwmi_block_list, target_10)
and func_21(vfilp_959, func, target_21)
and func_22(func, target_22)
and func_23(func, target_23)
and vdriver_name_961.getType().hasName("const char *")
and vwblock_962.getType().hasName("wmi_block *")
and vnext_963.getType().hasName("wmi_block *")
and vwmi_block_list.getType().hasName("list_head")
and v__mptr_1_965.getType().hasName("void *")
and v__mptr_2_965.getType().hasName("void *")
and vfilp_959.getType().hasName("file *")
and vdriver_name_961.(LocalVariable).getFunction() = func
and vwblock_962.(LocalVariable).getFunction() = func
and vnext_963.(LocalVariable).getFunction() = func
and not vwmi_block_list.getParentScope+() = func
and v__mptr_1_965.(LocalVariable).getFunction() = func
and v__mptr_2_965.(LocalVariable).getFunction() = func
and vfilp_959.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
