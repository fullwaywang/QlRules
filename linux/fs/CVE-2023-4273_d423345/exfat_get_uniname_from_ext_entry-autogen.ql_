/**
 * @name linux-d42334578eba1390859012ebb91e1e556d51db49-exfat_get_uniname_from_ext_entry
 * @id cpp/linux/d42334578eba1390859012ebb91e1e556d51db49/exfat-get-uniname-from-ext-entry
 * @description linux-d42334578eba1390859012ebb91e1e556d51db49-fs/exfat/dir.c-exfat_get_uniname_from_ext_entry CVE-2023-4273
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue() instanceof FunctionCall
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(ExprStmt target_4, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
	and target_1.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getType().hasName("unsigned int")
	and target_1.getLocation().isBefore(target_4.getLocation())
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(ExprStmt target_4, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_2.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="15"
	and target_2.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_2.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="255"
	and target_2.getLocation().isBefore(target_4.getLocation())
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vep_49, Parameter vuniname_33, FunctionCall target_3) {
	target_3.getTarget().hasName("exfat_extract_uni_name")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vep_49
	and target_3.getArgument(1).(VariableAccess).getTarget()=vuniname_33
}

predicate func_4(Parameter vuniname_33, ExprStmt target_4) {
	target_4.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vuniname_33
	and target_4.getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="15"
}

from Function func, Variable vep_49, Parameter vuniname_33, FunctionCall target_3, ExprStmt target_4
where
not func_0(func)
and not func_1(target_4, func)
and not func_2(target_4, func)
and func_3(vep_49, vuniname_33, target_3)
and func_4(vuniname_33, target_4)
and vep_49.getType().hasName("exfat_dentry *")
and vuniname_33.getType().hasName("unsigned short *")
and vep_49.(LocalVariable).getFunction() = func
and vuniname_33.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
