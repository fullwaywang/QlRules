/**
 * @name linux-c78193e9c7bcbf25b8237ad0dec82f805c4ea69b-next_pidmap
 * @id cpp/linux/c78193e9c7bcbf25b8237ad0dec82f805c4ea69b/next-pidmap
 * @description linux-c78193e9c7bcbf25b8237ad0dec82f805c4ea69b-include/linux/pid.h-next_pidmap CVE-2011-1593
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlast_220, ExprStmt target_3, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlast_220
		and target_0.getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getValue()="4194304"
		and target_0.getThen() instanceof ReturnStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_2(Function func, ReturnStmt target_2) {
		target_2.getExpr().(UnaryMinusExpr).getValue()="-1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Parameter vlast_220, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vlast_220
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="1"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(SubExpr).getValue()="32767"
}

from Function func, Parameter vlast_220, ReturnStmt target_2, ExprStmt target_3
where
not func_0(vlast_220, target_3, func)
and func_2(func, target_2)
and func_3(vlast_220, target_3)
and vlast_220.getType().hasName("int")
and vlast_220.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
