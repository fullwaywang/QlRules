/**
 * @name linux-3799d02ae4208af08e81310770d8754863a246a1-ip_set_create
 * @id cpp/linux/3799d02ae4208af08e81310770d8754863a246a1/ip-set-create
 * @description linux-3799d02ae4208af08e81310770d8754863a246a1-net/netfilter/ipset/ip_set_core.c-ip_set_create CVE-2024-40993
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinst_900, LogicalOrExpr target_4, ExprStmt target_5) {
exists(LogicalOrExpr target_0 |
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getRightOperand() |
		obj_0.getTarget().getName()="is_deleted"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinst_900
	)
	and target_0.getLeftOperand() instanceof LogicalOrExpr
	and target_4.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_1(Variable vinst_900, ExprStmt target_6, ExprStmt target_7) {
exists(LogicalOrExpr target_1 |
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getRightOperand() |
		obj_0.getTarget().getName()="is_deleted"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinst_900
	)
	and target_1.getLeftOperand() instanceof LogicalOrExpr
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_2(Variable vip_set_ref_lock, LogicalOrExpr target_2) {
	exists(FunctionCall obj_0 | obj_0=target_2.getLeftOperand() |
		obj_0.getTarget().hasName("lockdep_nfnl_is_held")
		and obj_0.getArgument(0).(Literal).getValue()="6"
	)
	and exists(FunctionCall obj_1 | obj_1=target_2.getRightOperand() |
		exists(AddressOfExpr obj_2 | obj_2=obj_1.getArgument(0) |
			exists(PointerFieldAccess obj_3 | obj_3=obj_2.getOperand() |
				obj_3.getTarget().getName()="dep_map"
				and obj_3.getQualifier().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vip_set_ref_lock
			)
		)
		and obj_1.getTarget().hasName("lock_is_held")
	)
}

predicate func_3(Variable vip_set_ref_lock, LogicalOrExpr target_3) {
	exists(FunctionCall obj_0 | obj_0=target_3.getLeftOperand() |
		obj_0.getTarget().hasName("lockdep_nfnl_is_held")
		and obj_0.getArgument(0).(Literal).getValue()="6"
	)
	and exists(FunctionCall obj_1 | obj_1=target_3.getRightOperand() |
		exists(AddressOfExpr obj_2 | obj_2=obj_1.getArgument(0) |
			exists(PointerFieldAccess obj_3 | obj_3=obj_2.getOperand() |
				obj_3.getTarget().getName()="dep_map"
				and obj_3.getQualifier().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vip_set_ref_lock
			)
		)
		and obj_1.getTarget().hasName("lock_is_held")
	)
}

predicate func_4(Variable vinst_900, LogicalOrExpr target_4) {
	exists(RelationalOperation obj_0 | obj_0=target_4.getLeftOperand() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getGreaterOperand() |
			obj_1.getTarget().getName()="ip_set_max"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vinst_900
		)
		and obj_0.getLesserOperand().(VariableAccess).getTarget().getType().hasName("ip_set_id_t")
	)
	and exists(EqualityOperation obj_2 | obj_2=target_4.getRightOperand() |
		obj_2.getLeftOperand().(VariableAccess).getTarget().getType().hasName("ip_set_id_t")
		and obj_2.getRightOperand().(Literal).getValue()="65535"
	)
}

predicate func_5(Variable vinst_900, ExprStmt target_5) {
	exists(PointerFieldAccess obj_0 | obj_0=target_5.getExpr() |
		obj_0.getTarget().getName()="ip_set_list"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinst_900
	)
}

predicate func_6(Variable vinst_900, ExprStmt target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="ip_set_max"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vinst_900
		)
		and obj_0.getRValue().(VariableAccess).getTarget().getType().hasName("ip_set_id_t")
	)
}

predicate func_7(Variable vinst_900, ExprStmt target_7) {
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getExpr() |
		obj_0.getTarget().getName()="ip_set_list"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinst_900
	)
}

from Function func, Variable vinst_900, Variable vip_set_ref_lock, LogicalOrExpr target_2, LogicalOrExpr target_3, LogicalOrExpr target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7
where
not func_0(vinst_900, target_4, target_5)
and not func_1(vinst_900, target_6, target_7)
and func_2(vip_set_ref_lock, target_2)
and func_3(vip_set_ref_lock, target_3)
and func_4(vinst_900, target_4)
and func_5(vinst_900, target_5)
and func_6(vinst_900, target_6)
and func_7(vinst_900, target_7)
and vinst_900.getType().hasName("ip_set_net *")
and vip_set_ref_lock.getType().hasName("rwlock_t")
and vinst_900.(LocalVariable).getFunction() = func
and not vip_set_ref_lock.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
