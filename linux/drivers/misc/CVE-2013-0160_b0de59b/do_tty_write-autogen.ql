/**
 * @name linux-b0de59b5733d18b0d1974a060860a8b5c1b36a2e-do_tty_write
 * @id cpp/linux/b0de59b5733d18b0d1974a060860a8b5c1b36a2e/do-tty-write
 * @description linux-b0de59b5733d18b0d1974a060860a8b5c1b36a2e-drivers/tty/tty_io.c-do_tty_write CVE-2013-0160
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vret_1015, Variable vwritten_1015, VariableAccess target_3, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1015
	and target_0.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vwritten_1015
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_1(VariableAccess target_3, Function func, DeclStmt target_1) {
	target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vinode_1083, VariableAccess target_3, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="i_mtime"
	and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1083
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("current_fs_time")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1083
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_3(Variable vwritten_1015, VariableAccess target_3) {
	target_3.getTarget()=vwritten_1015
}

from Function func, Variable vret_1015, Variable vwritten_1015, Variable vinode_1083, ExprStmt target_0, DeclStmt target_1, ExprStmt target_2, VariableAccess target_3
where
func_0(vret_1015, vwritten_1015, target_3, target_0)
and func_1(target_3, func, target_1)
and func_2(vinode_1083, target_3, target_2)
and func_3(vwritten_1015, target_3)
and vret_1015.getType().hasName("ssize_t")
and vwritten_1015.getType().hasName("ssize_t")
and vinode_1083.getType().hasName("inode *")
and vret_1015.(LocalVariable).getFunction() = func
and vwritten_1015.(LocalVariable).getFunction() = func
and vinode_1083.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
