/**
 * @name linux-9f46c187e2e680ecd9de7983e4d081c3391acc76-kvm_mmu_invpcid_gva
 * @id cpp/linux/9f46c187e2e680ecd9de7983e4d081c3391acc76/kvm-mmu-invpcid-gva
 * @description linux-9f46c187e2e680ecd9de7983e4d081c3391acc76-arch/x86/kvm/mmu/mmu.c-kvm_mmu_invpcid_gva CVE-2022-1789
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmmu_5468, ValueFieldAccess target_6, LogicalAndExpr target_3) {
exists(PointerFieldAccess target_0 |
	target_0.getTarget().getName()="invlpg"
	and target_0.getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(VariableAccess).getLocation())
	and target_0.getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vmmu_5468, Variable vtlb_flush_5469, IfStmt target_7, ValueFieldAccess target_8, ExprStmt target_5, ExprStmt target_9, IfStmt target_10) {
exists(IfStmt target_1 |
	target_1.getCondition() instanceof LogicalAndExpr
	and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getTarget().getName()="invlpg"
	and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen() instanceof ExprStmt
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtlb_flush_5469
	and target_1.getLocation().isBefore(target_7.getLocation())
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getCondition().(VariableAccess).getLocation()))
}

/*predicate func_2(Variable vmmu_5468, LogicalAndExpr target_3, ValueFieldAccess target_8, ExprStmt target_5) {
exists(IfStmt target_2 |
	target_2.getCondition().(PointerFieldAccess).getTarget().getName()="invlpg"
	and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_2.getThen() instanceof ExprStmt
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_3(Parameter vpcid_5466, Variable vmmu_5468, Variable vi_5470, Parameter vvcpu_5466, BlockStmt target_11, LogicalAndExpr target_3) {
	target_3.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="hpa"
	and target_3.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="prev_roots"
	and target_3.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_3.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_5470
	and target_3.getLeftOperand().(EqualityOperation).getRightOperand().(ComplementExpr).getValue()="18446744073709551615"
	and target_3.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vpcid_5466
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getTarget().hasName("kvm_get_pcid")
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_5466
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="pgd"
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="prev_roots"
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_3.getRightOperand().(EqualityOperation).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_5470
	and target_3.getParent().(IfStmt).getThen()=target_11
}

predicate func_4(Parameter vgva_5466, Variable vmmu_5468, Parameter vvcpu_5466, EqualityOperation target_12, ExprStmt target_4) {
	target_4.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="invlpg"
	and target_4.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_4.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_5466
	and target_4.getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vgva_5466
	and target_4.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="hpa"
	and target_4.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="root"
	and target_4.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

predicate func_5(Parameter vgva_5466, Variable vmmu_5468, Variable vi_5470, Parameter vvcpu_5466, LogicalAndExpr target_3, ExprStmt target_5) {
	target_5.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="invlpg"
	and target_5.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_5.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_5466
	and target_5.getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vgva_5466
	and target_5.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="hpa"
	and target_5.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="prev_roots"
	and target_5.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_5.getExpr().(VariableCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_5470
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_6(Variable vmmu_5468, ValueFieldAccess target_6) {
	target_6.getTarget().getName()="hpa"
	and target_6.getQualifier().(PointerFieldAccess).getTarget().getName()="root"
	and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
}

predicate func_7(Variable vtlb_flush_5469, IfStmt target_7) {
	target_7.getCondition() instanceof LogicalAndExpr
	and target_7.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtlb_flush_5469
}

predicate func_8(Variable vmmu_5468, Variable vi_5470, ValueFieldAccess target_8) {
	target_8.getTarget().getName()="pgd"
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="prev_roots"
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmmu_5468
	and target_8.getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_5470
}

predicate func_9(Variable vtlb_flush_5469, EqualityOperation target_12, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtlb_flush_5469
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

predicate func_10(Parameter vgva_5466, Variable vtlb_flush_5469, Parameter vvcpu_5466, IfStmt target_10) {
	target_10.getCondition().(VariableAccess).getTarget()=vtlb_flush_5469
	and target_10.getThen().(ExprStmt).getExpr().(ExprCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_5466
	and target_10.getThen().(ExprStmt).getExpr().(ExprCall).getArgument(1).(VariableAccess).getTarget()=vgva_5466
}

predicate func_11(Variable vtlb_flush_5469, BlockStmt target_11) {
	target_11.getStmt(0) instanceof ExprStmt
	and target_11.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtlb_flush_5469
}

predicate func_12(Parameter vpcid_5466, Parameter vvcpu_5466, EqualityOperation target_12) {
	target_12.getLeftOperand().(VariableAccess).getTarget()=vpcid_5466
	and target_12.getRightOperand().(FunctionCall).getTarget().hasName("kvm_get_active_pcid")
	and target_12.getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_5466
}

from Function func, Parameter vgva_5466, Parameter vpcid_5466, Variable vmmu_5468, Variable vtlb_flush_5469, Variable vi_5470, Parameter vvcpu_5466, LogicalAndExpr target_3, ExprStmt target_4, ExprStmt target_5, ValueFieldAccess target_6, IfStmt target_7, ValueFieldAccess target_8, ExprStmt target_9, IfStmt target_10, BlockStmt target_11, EqualityOperation target_12
where
not func_0(vmmu_5468, target_6, target_3)
and not func_1(vmmu_5468, vtlb_flush_5469, target_7, target_8, target_5, target_9, target_10)
and func_3(vpcid_5466, vmmu_5468, vi_5470, vvcpu_5466, target_11, target_3)
and func_4(vgva_5466, vmmu_5468, vvcpu_5466, target_12, target_4)
and func_5(vgva_5466, vmmu_5468, vi_5470, vvcpu_5466, target_3, target_5)
and func_6(vmmu_5468, target_6)
and func_7(vtlb_flush_5469, target_7)
and func_8(vmmu_5468, vi_5470, target_8)
and func_9(vtlb_flush_5469, target_12, target_9)
and func_10(vgva_5466, vtlb_flush_5469, vvcpu_5466, target_10)
and func_11(vtlb_flush_5469, target_11)
and func_12(vpcid_5466, vvcpu_5466, target_12)
and vgva_5466.getType().hasName("gva_t")
and vpcid_5466.getType().hasName("unsigned long")
and vmmu_5468.getType().hasName("kvm_mmu *")
and vtlb_flush_5469.getType().hasName("bool")
and vi_5470.getType().hasName("uint")
and vvcpu_5466.getType().hasName("kvm_vcpu *")
and vgva_5466.getFunction() = func
and vpcid_5466.getFunction() = func
and vmmu_5468.(LocalVariable).getFunction() = func
and vtlb_flush_5469.(LocalVariable).getFunction() = func
and vi_5470.(LocalVariable).getFunction() = func
and vvcpu_5466.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
