/**
 * @name linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-keyring_revoke
 * @id cpp/linux/b2a4df200d570b2c33a57e1ebfa5896e4bc81b69/keyring-revoke
 * @description linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-security/keys/keyring.c-keyring_revoke CVE-2014-3631
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkeyring_1169, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="payload"
		and target_0.getQualifier().(VariableAccess).getTarget()=vkeyring_1169
}

predicate func_1(Function func, FunctionCall target_1) {
		target_1.getTarget().hasName("lockdep_rcu_suspicious")
		and not target_1.getTarget().hasName("assoc_array_apply_edit")
		and target_1.getArgument(0) instanceof StringLiteral
		and target_1.getArgument(1) instanceof Literal
		and target_1.getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
		and target_1.getEnclosingFunction() = func
}

predicate func_3(Parameter vkeyring_1169, AddressOfExpr target_23, ExprStmt target_7) {
	exists(AssignExpr target_3 |
		target_3.getLValue().(VariableAccess).getType().hasName("assoc_array_edit *")
		and target_3.getRValue().(FunctionCall).getTarget().hasName("assoc_array_clear")
		and target_3.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="keys"
		and target_3.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
		and target_3.getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("const assoc_array_ops")
		and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_3.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Function func) {
	exists(FunctionCall target_4 |
		target_4.getTarget().hasName("IS_ERR")
		and target_4.getArgument(0).(VariableAccess).getType().hasName("assoc_array_edit *")
		and target_4.getEnclosingFunction() = func)
}

predicate func_7(Parameter vkeyring_1169, Function func, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("key_payload_reserve")
		and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkeyring_1169
		and target_7.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_9(Variable vklist_1171, Parameter vkeyring_1169, AssignExpr target_9) {
		target_9.getLValue().(VariableAccess).getTarget()=vklist_1171
		and target_9.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
		and target_9.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_9.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_9.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
}

/*predicate func_10(Variable v__warned_1173, DoStmt target_10) {
		target_10.getCondition() instanceof Literal
		and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_1173
		and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("rwsem_is_locked")
		and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_1173
		and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
}

*/
/*predicate func_12(Variable v__warned_1173, Parameter vkeyring_1169, BlockStmt target_24, LogicalAndExpr target_12) {
		target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_1173
		and target_12.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("rwsem_is_locked")
		and target_12.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_12.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
		and target_12.getParent().(IfStmt).getThen()=target_24
}

*/
/*predicate func_13(Variable v__warned_1173, VariableAccess target_13) {
		target_13.getTarget()=v__warned_1173
}

*/
/*predicate func_14(Variable v__warned_1173, AssignExpr target_14) {
		target_14.getLValue().(VariableAccess).getTarget()=v__warned_1173
}

*/
/*predicate func_15(LogicalAndExpr target_12, Function func, ExprStmt target_15) {
		target_15.getExpr() instanceof FunctionCall
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
		and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_17(Parameter vkeyring_1169, ExprStmt target_17) {
		target_17.getExpr().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_17.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_17.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
}

*/
predicate func_18(Variable vklist_1171, BlockStmt target_25, AddressOfExpr target_27, VariableAccess target_18) {
		target_18.getTarget()=vklist_1171
		and target_18.getParent().(IfStmt).getThen()=target_25
		and target_18.getLocation().isBefore(target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_19(Parameter vkeyring_1169, VariableAccess target_18, DoStmt target_19) {
		target_19.getCondition().(Literal).getValue()="0"
		and target_19.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_19.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_19.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
		and target_19.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
}

/*predicate func_21(Parameter vkeyring_1169, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
		and target_21.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

*/
predicate func_22(Variable vklist_1171, VariableAccess target_18, ExprStmt target_22) {
		target_22.getExpr().(FunctionCall).getTarget().hasName("call_rcu_sched")
		and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vklist_1171
		and target_22.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
}

predicate func_23(Parameter vkeyring_1169, AddressOfExpr target_23) {
		target_23.getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1169
}

predicate func_24(Function func, BlockStmt target_24) {
		target_24.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
		and target_24.getStmt(1) instanceof ExprStmt
		and target_24.getEnclosingFunction() = func
}

predicate func_25(Function func, BlockStmt target_25) {
		target_25.getStmt(0) instanceof DoStmt
		and target_25.getStmt(1) instanceof ExprStmt
		and target_25.getEnclosingFunction() = func
}

predicate func_27(Variable vklist_1171, AddressOfExpr target_27) {
		target_27.getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vklist_1171
}

from Function func, Variable vklist_1171, Variable v__warned_1173, Parameter vkeyring_1169, PointerFieldAccess target_0, FunctionCall target_1, ExprStmt target_7, AssignExpr target_9, VariableAccess target_18, DoStmt target_19, ExprStmt target_22, AddressOfExpr target_23, BlockStmt target_24, BlockStmt target_25, AddressOfExpr target_27
where
func_0(vkeyring_1169, target_0)
and func_1(func, target_1)
and not func_3(vkeyring_1169, target_23, target_7)
and not func_4(func)
and func_7(vkeyring_1169, func, target_7)
and func_9(vklist_1171, vkeyring_1169, target_9)
and func_18(vklist_1171, target_25, target_27, target_18)
and func_19(vkeyring_1169, target_18, target_19)
and func_22(vklist_1171, target_18, target_22)
and func_23(vkeyring_1169, target_23)
and func_24(func, target_24)
and func_25(func, target_25)
and func_27(vklist_1171, target_27)
and vklist_1171.getType().hasName("keyring_list *")
and v__warned_1173.getType().hasName("bool")
and vkeyring_1169.getType().hasName("key *")
and vklist_1171.(LocalVariable).getFunction() = func
and v__warned_1173.(LocalVariable).getFunction() = func
and vkeyring_1169.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
