/**
 * @name linux-d72e126e9a36d3d33889829df8fc90100bb0e071-tls_ctx_create
 * @id cpp/linux/d72e126e9a36d3d33889829df8fc90100bb0e071/tls-ctx-create
 * @description linux-d72e126e9a36d3d33889829df8fc90100bb0e071-net/tls/tls_main.c-tls_ctx_create CVE-2024-36489
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vctx_629, Variable v_r_a_p__v_636, ExprStmt target_1, DoStmt target_0) {
	exists(BlockStmt obj_0 | obj_0=target_0.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(LogicalAndExpr obj_2 | obj_2=obj_1.getCondition() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getLeftOperand() |
					obj_3.getTarget().hasName("__builtin_constant_p")
					and obj_3.getArgument(0).(VariableAccess).getTarget()=vctx_629
				)
				and exists(EqualityOperation obj_4 | obj_4=obj_2.getRightOperand() |
					obj_4.getLeftOperand().(VariableAccess).getTarget()=v_r_a_p__v_636
					and obj_4.getRightOperand().(Literal).getValue()="0"
				)
			)
			and exists(DoStmt obj_5 | obj_5=obj_1.getThen() |
				exists(BlockStmt obj_6 | obj_6=obj_5.getStmt() |
					obj_6.getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
					and obj_6.getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
				)
				and obj_5.getCondition().(Literal).getValue()="0"
			)
			and exists(DoStmt obj_7 | obj_7=obj_1.getElse() |
				exists(BlockStmt obj_8 | obj_8=obj_7.getStmt() |
					obj_8.getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
					and obj_8.getStmt(2).(DoStmt).getCondition().(Literal).getValue()="0"
				)
				and obj_7.getCondition().(Literal).getValue()="0"
			)
		)
	)
	and target_0.getCondition().(Literal).getValue()="0"
	and target_0.getLocation().isBefore(target_1.getLocation())
}

predicate func_1(Variable vctx_629, ExprStmt target_1) {
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="sk_proto"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vctx_629
		)
		and obj_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	)
}

from Function func, Variable vctx_629, Variable v_r_a_p__v_636, DoStmt target_0, ExprStmt target_1
where
func_0(vctx_629, v_r_a_p__v_636, target_1, target_0)
and func_1(vctx_629, target_1)
and vctx_629.getType().hasName("tls_context *")
and v_r_a_p__v_636.getType().hasName("uintptr_t")
and vctx_629.(LocalVariable).getFunction() = func
and v_r_a_p__v_636.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
