/**
 * @name linux-8f0541186e9ad1b62accc9519cc2b7a7240272a7-build_sec_desc
 * @id cpp/linux/8f0541186e9ad1b62accc9519cc2b7a7240272a7/build-sec-desc
 * @description linux-8f0541186e9ad1b62accc9519cc2b7a7240272a7-fs/ksmbd/smbacl.c-build_sec_desc CVE-2022-47942
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(BlockStmt target_11, Function func) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(SizeofTypeOperator).getValue()="8"
	and target_0.getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_0.getParent().(IfStmt).getThen()=target_11
	and target_0.getEnclosingFunction() = func)
}

predicate func_3(Variable vppdacl_ptr_944, ExprStmt target_12, ExprStmt target_13) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getType().hasName("int")
	and target_3.getRValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_3.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vppdacl_ptr_944
	and target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_4(NotExpr target_14, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("int")
	and target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_4.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_4.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_4.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getValue()="8"
	and target_4.getThen().(GotoStmt).getName() ="out"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(6)=target_4
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Parameter vuser_ns_879, Parameter vfattr_882, Variable vnowner_sid_ptr_887, Variable vngroup_sid_ptr_887, Variable vdacl_ptr_888, Variable vppdacl_ptr_944, NotExpr target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_20) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("set_ntacl_dacl")
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vuser_ns_879
	and target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdacl_ptr_888
	and target_5.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vppdacl_ptr_944
	and target_5.getExpr().(FunctionCall).getArgument(3).(SubExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_5.getExpr().(FunctionCall).getArgument(3).(SubExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getExpr().(FunctionCall).getArgument(3).(SubExpr).getRightOperand().(SizeofTypeOperator).getValue()="8"
	and target_5.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vnowner_sid_ptr_887
	and target_5.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vngroup_sid_ptr_887
	and target_5.getExpr().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vfattr_882
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(7)=target_5
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_16.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getLocation())
	and target_5.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_17.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_18.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getLocation())
	and target_5.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_6(Parameter vuser_ns_879, Parameter vfattr_882, Variable vnowner_sid_ptr_887, Variable vngroup_sid_ptr_887, Variable vdacl_ptr_888, Variable vppdacl_ptr_944) {
exists(SubExpr target_6 |
	target_6.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_6.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_6.getRightOperand().(SizeofTypeOperator).getValue()="8"
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_ntacl_dacl")
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vuser_ns_879
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdacl_ptr_888
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vppdacl_ptr_944
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnowner_sid_ptr_887
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vngroup_sid_ptr_887
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vfattr_882)
}

*/
predicate func_7(Parameter vppntsd_880, BlockStmt target_11, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="dacloffset"
	and target_7.getQualifier().(VariableAccess).getTarget()=vppntsd_880
	and target_7.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_11
}

predicate func_8(NotExpr target_14, Function func, DeclStmt target_8) {
	target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_8.getEnclosingFunction() = func
}

predicate func_9(NotExpr target_14, Function func, GotoStmt target_9) {
	target_9.getName() ="out"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Parameter vppntsd_880, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="dacloffset"
	and target_10.getQualifier().(VariableAccess).getTarget()=vppntsd_880
}

predicate func_11(Function func, BlockStmt target_11) {
	target_11.getStmt(0) instanceof GotoStmt
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Parameter vppntsd_880, Variable vppdacl_ptr_944, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vppdacl_ptr_944
	and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vppntsd_880
	and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="dacloffset"
	and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vppntsd_880
}

predicate func_13(Parameter vuser_ns_879, Parameter vfattr_882, Variable vnowner_sid_ptr_887, Variable vngroup_sid_ptr_887, Variable vdacl_ptr_888, Variable vppdacl_ptr_944, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("set_ntacl_dacl")
	and target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vuser_ns_879
	and target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdacl_ptr_888
	and target_13.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vppdacl_ptr_944
	and target_13.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnowner_sid_ptr_887
	and target_13.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vngroup_sid_ptr_887
	and target_13.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vfattr_882
}

predicate func_14(Parameter vppntsd_880, NotExpr target_14) {
	target_14.getOperand().(PointerFieldAccess).getTarget().getName()="dacloffset"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vppntsd_880
}

predicate func_15(Parameter vuser_ns_879, Parameter vfattr_882, Variable vdacl_ptr_888, ExprStmt target_15) {
	target_15.getExpr().(FunctionCall).getTarget().hasName("set_mode_dacl")
	and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vuser_ns_879
	and target_15.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdacl_ptr_888
	and target_15.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vfattr_882
}

predicate func_16(Variable vnowner_sid_ptr_887, ExprStmt target_16) {
	target_16.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("__u32")
	and target_16.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(AddExpr).getValue()="8"
	and target_16.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="num_subauth"
	and target_16.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnowner_sid_ptr_887
	and target_16.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getRightOperand().(Literal).getValue()="4"
}

predicate func_17(Variable vnowner_sid_ptr_887, Function func, ExprStmt target_17) {
	target_17.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_17.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnowner_sid_ptr_887
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

predicate func_18(Variable vngroup_sid_ptr_887, ExprStmt target_18) {
	target_18.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("__u32")
	and target_18.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(AddExpr).getValue()="8"
	and target_18.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="num_subauth"
	and target_18.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vngroup_sid_ptr_887
	and target_18.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(MulExpr).getRightOperand().(Literal).getValue()="4"
}

predicate func_19(Variable vngroup_sid_ptr_887, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vngroup_sid_ptr_887
}

predicate func_20(Variable vdacl_ptr_888, ExprStmt target_20) {
	target_20.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("__u32")
	and target_20.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_20.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdacl_ptr_888
}

from Function func, Parameter vuser_ns_879, Parameter vppntsd_880, Parameter vfattr_882, Variable vnowner_sid_ptr_887, Variable vngroup_sid_ptr_887, Variable vdacl_ptr_888, Variable vppdacl_ptr_944, PointerFieldAccess target_7, DeclStmt target_8, GotoStmt target_9, PointerFieldAccess target_10, BlockStmt target_11, ExprStmt target_12, ExprStmt target_13, NotExpr target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_20
where
not func_0(target_11, func)
and not func_3(vppdacl_ptr_944, target_12, target_13)
and not func_4(target_14, func)
and not func_5(vuser_ns_879, vfattr_882, vnowner_sid_ptr_887, vngroup_sid_ptr_887, vdacl_ptr_888, vppdacl_ptr_944, target_14, target_15, target_16, target_17, target_18, target_19, target_20)
and func_7(vppntsd_880, target_11, target_7)
and func_8(target_14, func, target_8)
and func_9(target_14, func, target_9)
and func_10(vppntsd_880, target_10)
and func_11(func, target_11)
and func_12(vppntsd_880, vppdacl_ptr_944, target_12)
and func_13(vuser_ns_879, vfattr_882, vnowner_sid_ptr_887, vngroup_sid_ptr_887, vdacl_ptr_888, vppdacl_ptr_944, target_13)
and func_14(vppntsd_880, target_14)
and func_15(vuser_ns_879, vfattr_882, vdacl_ptr_888, target_15)
and func_16(vnowner_sid_ptr_887, target_16)
and func_17(vnowner_sid_ptr_887, func, target_17)
and func_18(vngroup_sid_ptr_887, target_18)
and func_19(vngroup_sid_ptr_887, target_19)
and func_20(vdacl_ptr_888, target_20)
and vuser_ns_879.getType().hasName("user_namespace *")
and vppntsd_880.getType().hasName("smb_ntsd *")
and vfattr_882.getType().hasName("smb_fattr *")
and vnowner_sid_ptr_887.getType().hasName("smb_sid *")
and vngroup_sid_ptr_887.getType().hasName("smb_sid *")
and vdacl_ptr_888.getType().hasName("smb_acl *")
and vppdacl_ptr_944.getType().hasName("smb_acl *")
and vuser_ns_879.getFunction() = func
and vppntsd_880.getFunction() = func
and vfattr_882.getFunction() = func
and vnowner_sid_ptr_887.(LocalVariable).getFunction() = func
and vngroup_sid_ptr_887.(LocalVariable).getFunction() = func
and vdacl_ptr_888.(LocalVariable).getFunction() = func
and vppdacl_ptr_944.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
