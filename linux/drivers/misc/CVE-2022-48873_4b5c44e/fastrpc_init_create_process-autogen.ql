/**
 * @name linux-4b5c44e924a571d0ad07054de549624fbc04e4d7-fastrpc_init_create_process
 * @id cpp/linux/4b5c44e924a571d0ad07054de549624fbc04e4d7/fastrpc-init-create-process
 * @description linux-4b5c44e924a571d0ad07054de549624fbc04e4d7-drivers/misc/fastrpc.c-fastrpc_init_create_process CVE-2022-48873
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmap_989, VariableAccess target_5, ExprStmt target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getExpr() |
		obj_0.getTarget().hasName("fastrpc_map_put")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vmap_989
	)
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

predicate func_1(Variable vmap_989, Parameter vfl_983, Function func, IfStmt target_1) {
	exists(BlockStmt obj_0 | obj_0=target_1.getThen() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getExpr() |
				exists(AddressOfExpr obj_3 | obj_3=obj_2.getArgument(0) |
					exists(PointerFieldAccess obj_4 | obj_4=obj_3.getOperand() |
						obj_4.getTarget().getName()="lock"
						and obj_4.getQualifier().(VariableAccess).getTarget()=vfl_983
					)
				)
				and obj_2.getTarget().hasName("spin_lock")
			)
		)
		and exists(ExprStmt obj_5 | obj_5=obj_0.getStmt(1) |
			exists(FunctionCall obj_6 | obj_6=obj_5.getExpr() |
				exists(AddressOfExpr obj_7 | obj_7=obj_6.getArgument(0) |
					exists(PointerFieldAccess obj_8 | obj_8=obj_7.getOperand() |
						obj_8.getTarget().getName()="node"
						and obj_8.getQualifier().(VariableAccess).getTarget()=vmap_989
					)
				)
				and obj_6.getTarget().hasName("list_del")
			)
		)
		and exists(ExprStmt obj_9 | obj_9=obj_0.getStmt(2) |
			exists(FunctionCall obj_10 | obj_10=obj_9.getExpr() |
				exists(AddressOfExpr obj_11 | obj_11=obj_10.getArgument(0) |
					exists(PointerFieldAccess obj_12 | obj_12=obj_11.getOperand() |
						obj_12.getTarget().getName()="lock"
						and obj_12.getQualifier().(VariableAccess).getTarget()=vfl_983
					)
				)
				and obj_10.getTarget().hasName("spin_unlock")
			)
		)
		and obj_0.getStmt(3) instanceof ExprStmt
	)
	and target_1.getCondition().(VariableAccess).getTarget()=vmap_989
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

/*predicate func_2(Parameter vfl_983, VariableAccess target_5, ExprStmt target_2) {
	exists(FunctionCall obj_0 | obj_0=target_2.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getTarget().getName()="lock"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vfl_983
			)
		)
		and obj_0.getTarget().hasName("spin_lock")
	)
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

*/
/*predicate func_3(Variable vmap_989, VariableAccess target_5, ExprStmt target_3) {
	exists(FunctionCall obj_0 | obj_0=target_3.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getTarget().getName()="node"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vmap_989
			)
		)
		and obj_0.getTarget().hasName("list_del")
	)
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

*/
/*predicate func_4(Parameter vfl_983, VariableAccess target_5, ExprStmt target_4) {
	exists(FunctionCall obj_0 | obj_0=target_4.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getTarget().getName()="lock"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vfl_983
			)
		)
		and obj_0.getTarget().hasName("spin_unlock")
	)
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

*/
predicate func_5(Variable vmap_989, BlockStmt target_6, VariableAccess target_5) {
	target_5.getTarget()=vmap_989
	and target_5.getParent().(IfStmt).getThen()=target_6
}

predicate func_6(Function func, BlockStmt target_6) {
	target_6.getStmt(0) instanceof ExprStmt
	and target_6.getStmt(1) instanceof ExprStmt
	and target_6.getStmt(2) instanceof ExprStmt
	and target_6.getStmt(3) instanceof ExprStmt
	and target_6.getEnclosingFunction() = func
}

from Function func, Variable vmap_989, Parameter vfl_983, ExprStmt target_0, IfStmt target_1, VariableAccess target_5, BlockStmt target_6
where
func_0(vmap_989, target_5, target_0)
and func_1(vmap_989, vfl_983, func, target_1)
and func_5(vmap_989, target_6, target_5)
and func_6(func, target_6)
and vmap_989.getType().hasName("fastrpc_map *")
and vfl_983.getType().hasName("fastrpc_user *")
and vmap_989.(LocalVariable).getFunction() = func
and vfl_983.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
