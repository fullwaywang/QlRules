/**
 * @name chromium-444b0a82fb9f59dd2c3c05dfbccc56fc16c124d2-content__RenderFrameHostImpl__CreateNewWindow
 * @id cpp/chromium/444b0a82fb9f59dd2c3c05dfbccc56fc16c124d2/contentrenderframehostimplcreatenewwindow
 * @description chromium-444b0a82fb9f59dd2c3c05dfbccc56fc16c124d2-content/browser/renderer_host/render_frame_host_impl.cc-content__RenderFrameHostImpl__CreateNewWindow CVE-2023-4908
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
	target_0.getValue()="Only top-most frames can open picture-in-picture windows."
	and not target_0.getValue()="Only top-most frames from https:// or file:// URLs can open picture-in-picture windows."
	and target_0.getEnclosingFunction() = func
}

predicate func_1(BlockStmt target_3, Function func) {
exists(LogicalOrExpr target_1 |
	exists(LogicalAndExpr obj_0 | obj_0=target_1.getLeftOperand() |
		exists(NotExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getOperand() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().hasName("GetLastCommittedURL")
					and obj_3.getQualifier().(ThisExpr).getType() instanceof PointerType
				)
				and obj_2.getTarget().hasName("SchemeIs")
				and obj_2.getArgument(0).(ConstructorCall).getArgument(0).(VariableAccess).getType().hasName("const char[]")
			)
		)
		and exists(NotExpr obj_4 | obj_4=obj_0.getRightOperand() |
			exists(FunctionCall obj_5 | obj_5=obj_4.getOperand() |
				exists(FunctionCall obj_6 | obj_6=obj_5.getQualifier() |
					obj_6.getTarget().hasName("GetLastCommittedURL")
					and obj_6.getQualifier().(ThisExpr).getType() instanceof PointerType
				)
				and obj_5.getTarget().hasName("SchemeIsFile")
			)
		)
	)
	and exists(LogicalAndExpr obj_7 | obj_7=target_1.getParent() |
		exists(EqualityOperation obj_8 | obj_8=obj_7.getLeftOperand() |
			exists(PointerFieldAccess obj_9 | obj_9=obj_8.getLeftOperand() |
				obj_9.getTarget().getName()="disposition"
				and obj_9.getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget().getType().hasName("CreateNewWindowParamsPtr")
			)
		)
		and obj_7.getRightOperand() instanceof FunctionCall
		and obj_7.getParent().(IfStmt).getThen()=target_3
	)
	and target_1.getRightOperand() instanceof FunctionCall
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(BlockStmt target_3, Function func, FunctionCall target_2) {
	exists(LogicalAndExpr obj_0 | obj_0=target_2.getParent() |
		exists(EqualityOperation obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLeftOperand() |
				obj_2.getTarget().getName()="disposition"
				and obj_2.getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget().getType().hasName("CreateNewWindowParamsPtr")
			)
		)
		and obj_0.getParent().(IfStmt).getThen()=target_3
	)
	and target_2.getTarget().hasName("GetParentOrOuterDocumentOrEmbedder")
	and target_2.getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, BlockStmt target_3) {
	exists(ExprStmt obj_0 | obj_0=target_3.getStmt(0) |
		exists(FunctionCall obj_1 | obj_1=obj_0.getExpr() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="frame_host_associated_receiver_"
				and obj_2.getQualifier().(ThisExpr).getType() instanceof PointerType
			)
			and obj_1.getTarget().hasName("ReportBadMessage")
			and obj_1.getArgument(0).(ConstructorCall).getArgument(0) instanceof StringLiteral
		)
	)
	and target_3.getEnclosingFunction() = func
}

from Function func, StringLiteral target_0, FunctionCall target_2, BlockStmt target_3
where
func_0(func, target_0)
and not func_1(target_3, func)
and func_2(target_3, func, target_2)
and func_3(func, target_3)
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
