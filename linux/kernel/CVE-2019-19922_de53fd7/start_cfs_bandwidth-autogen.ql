/**
 * @name linux-de53fd7aedb100f03e5d2231cfce0e4993282425-start_cfs_bandwidth
 * @id cpp/linux/de53fd7aedb100f03e5d2231cfce0e4993282425/start-cfs-bandwidth
 * @description linux-de53fd7aedb100f03e5d2231cfce0e4993282425-kernel/sched/fair.c-start_cfs_bandwidth CVE-2019-19922
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcfs_b_5048, Variable voverrun_5050, Function func, ExprStmt target_0) {
	target_0.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_0.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_5048
	and target_0.getExpr().(AssignAddExpr).getRValue().(MulExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=voverrun_5050
	and target_0.getExpr().(AssignAddExpr).getRValue().(MulExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="1"
	and target_0.getExpr().(AssignAddExpr).getRValue().(MulExpr).getRightOperand().(FunctionCall).getTarget().hasName("ktime_to_ns")
	and target_0.getExpr().(AssignAddExpr).getRValue().(MulExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="period"
	and target_0.getExpr().(AssignAddExpr).getRValue().(MulExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_5048
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

predicate func_1(Parameter vcfs_b_5048, Function func, ExprStmt target_1) {
	target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_5048
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

from Function func, Parameter vcfs_b_5048, Variable voverrun_5050, ExprStmt target_0, ExprStmt target_1
where
func_0(vcfs_b_5048, voverrun_5050, func, target_0)
and func_1(vcfs_b_5048, func, target_1)
and vcfs_b_5048.getType().hasName("cfs_bandwidth *")
and voverrun_5050.getType().hasName("u64")
and vcfs_b_5048.getFunction() = func
and voverrun_5050.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
