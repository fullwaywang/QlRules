/**
 * @name linux-6062a8dc0517bce23e3c2f7d2fea5e22411269a3-semctl_main
 * @id cpp/linux/6062a8dc0517bce23e3c2f7d2fea5e22411269a3/semctl-main
 * @description linux-6062a8dc0517bce23e3c2f7d2fea5e22411269a3-ipc/sem.c-semctl_main CVE-2013-4483
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsma_1005, FunctionCall target_0) {
	target_0.getTarget().hasName("ipc_unlock")
	and not target_0.getTarget().hasName("sem_unlock")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_1(Function func, FunctionCall target_1) {
	target_1.getTarget().hasName("spin_lock")
	and not target_1.getTarget().hasName("sem_unlock")
	and target_1.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vsma_1005, FunctionCall target_2) {
	target_2.getTarget().hasName("ipc_unlock")
	and not target_2.getTarget().hasName("rcu_read_unlock")
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_3(Variable vsma_1005, FunctionCall target_3) {
	target_3.getTarget().hasName("ipc_unlock")
	and not target_3.getTarget().hasName("sem_unlock")
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_4(Function func, FunctionCall target_4) {
	target_4.getTarget().hasName("spin_lock")
	and not target_4.getTarget().hasName("sem_unlock")
	and target_4.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vsem_io_1009, Variable vi_1041, Variable vsma_1005, ExprStmt target_32, ForStmt target_5) {
	target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_1041
	and target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_5.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_1041
	and target_5.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="sem_nsems"
	and target_5.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_5.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_1041
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsem_io_1009
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1041
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="semval"
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="sem_base"
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_5.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1041
	and target_32.getLocation().isBefore(target_5.getLocation())
}

predicate func_6(Variable verr_1007, ExprStmt target_33, IfStmt target_6) {
	target_6.getCondition() instanceof ValueFieldAccess
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_6.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1007
	and target_6.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-43"
	and target_6.getThen().(BlockStmt).getStmt(2).(GotoStmt).getName() ="out_free"
	and target_33.getLocation().isBefore(target_6.getLocation())
}

predicate func_7(Function func) {
exists(UnaryMinusExpr target_7 |
	target_7.getValue()="-1"
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_7.getEnclosingFunction() = func)
}

predicate func_8(Variable vsma_1005) {
exists(FunctionCall target_8 |
	target_8.getTarget().hasName("sem_lock")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vsma_1005
	and target_8.getArgument(1).(Literal).getValue()="0"
	and target_8.getArgument(2).(UnaryMinusExpr).getValue()="-1")
}

predicate func_9(Function func) {
exists(UnaryMinusExpr target_9 |
	target_9.getValue()="-1"
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_9.getEnclosingFunction() = func)
}

predicate func_10(BlockStmt target_35, Function func) {
exists(NotExpr target_10 |
	target_10.getOperand() instanceof FunctionCall
	and target_10.getParent().(IfStmt).getThen()=target_35
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(ValueFieldAccess target_18, Function func) {
exists(ReturnStmt target_11 |
	target_11.getExpr().(UnaryMinusExpr).getValue()="-43"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
	and target_11.getEnclosingFunction() = func)
}

predicate func_12(Variable vsma_1005, Variable verr_1007, ForStmt target_36, ExprStmt target_37, ExprStmt target_38) {
exists(IfStmt target_12 |
	target_12.getCondition() instanceof ValueFieldAccess
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sem_unlock")
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsma_1005
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(UnaryMinusExpr).getValue()="-1"
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1007
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-43"
	and target_12.getThen().(BlockStmt).getStmt(2).(GotoStmt).getName() ="out_free"
	and target_12.getLocation().isBefore(target_36.getLocation())
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_37.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_38.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

/*predicate func_13(Function func) {
exists(UnaryMinusExpr target_13 |
	target_13.getValue()="-1"
	and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_13.getEnclosingFunction() = func)
}

*/
predicate func_14(Variable vsma_1005) {
exists(FunctionCall target_14 |
	target_14.getTarget().hasName("sem_lock")
	and target_14.getArgument(0).(VariableAccess).getTarget()=vsma_1005
	and target_14.getArgument(1).(Literal).getValue()="0"
	and target_14.getArgument(2).(UnaryMinusExpr).getValue()="-1")
}

predicate func_16(Function func) {
exists(UnaryMinusExpr target_16 |
	target_16.getValue()="-1"
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_16.getEnclosingFunction() = func)
}

predicate func_17(Variable vsma_1005, PointerFieldAccess target_17) {
	target_17.getTarget().getName()="sem_perm"
	and target_17.getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_17.getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_18(Variable vsma_1005, ValueFieldAccess target_18) {
	target_18.getTarget().getName()="deleted"
	and target_18.getQualifier().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_18.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_19(Variable vsma_1005, FunctionCall target_19) {
	target_19.getTarget().hasName("ipc_rcu_getref")
	and target_19.getArgument(0).(VariableAccess).getTarget()=vsma_1005
}

predicate func_20(Variable vsma_1005, VariableAccess target_20) {
	target_20.getTarget()=vsma_1005
	and target_20.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_21(Variable vsma_1005, VariableAccess target_21) {
	target_21.getTarget()=vsma_1005
	and target_21.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_22(Variable vsma_1005, VariableAccess target_22) {
	target_22.getTarget()=vsma_1005
	and target_22.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_23(Variable vsma_1005, VariableAccess target_23) {
	target_23.getTarget()=vsma_1005
	and target_23.getParent().(PointerFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_24(Variable vsma_1005, VariableAccess target_24) {
	target_24.getTarget()=vsma_1005
	and target_24.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_25(Variable vsma_1005, PointerFieldAccess target_25) {
	target_25.getTarget().getName()="sem_perm"
	and target_25.getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_26(Variable vsma_1005, RelationalOperation target_40, ValueFieldAccess target_26) {
	target_26.getTarget().getName()="lock"
	and target_26.getQualifier().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_26.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_26.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_26.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_40.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_27(Variable vsma_1005, PointerFieldAccess target_27) {
	target_27.getTarget().getName()="sem_perm"
	and target_27.getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_28(Variable vsma_1005, ExprStmt target_42, PointerFieldAccess target_28) {
	target_28.getTarget().getName()="sem_perm"
	and target_28.getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_28.getQualifier().(VariableAccess).getLocation().isBefore(target_42.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_29(Variable vsma_1005, ExprStmt target_37, ValueFieldAccess target_29) {
	target_29.getTarget().getName()="lock"
	and target_29.getQualifier().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_29.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_29.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_29.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_37.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_30(Variable vsma_1005, FunctionCall target_30) {
	target_30.getTarget().hasName("ipc_unlock")
	and target_30.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem_perm"
	and target_30.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_32(Function func, ExprStmt target_32) {
	target_32.getExpr() instanceof FunctionCall
	and target_32.getEnclosingFunction() = func
}

predicate func_33(Variable vsma_1005, ExprStmt target_33) {
	target_33.getExpr().(FunctionCall).getTarget().hasName("sem_lock_and_putref")
	and target_33.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsma_1005
}

predicate func_35(Variable verr_1007, ValueFieldAccess target_18, BlockStmt target_35) {
	target_35.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_35.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1007
	and target_35.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-43"
	and target_35.getStmt(2).(GotoStmt).getName() ="out_free"
	and target_35.getParent().(IfStmt).getCondition()=target_18
}

predicate func_36(Variable vsem_io_1009, Variable vsma_1005, ForStmt target_36) {
	target_36.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_36.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="semval"
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="sem_base"
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsem_io_1009
	and target_36.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_37(Variable vsma_1005, ExprStmt target_37) {
	target_37.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("sem *")
	and target_37.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="sem_base"
	and target_37.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_37.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_38(Variable verr_1007, ExprStmt target_38) {
	target_38.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1007
	and target_38.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-34"
}

predicate func_40(Variable vi_1041, Variable vsma_1005, RelationalOperation target_40) {
	 (target_40 instanceof GTExpr or target_40 instanceof LTExpr)
	and target_40.getLesserOperand().(VariableAccess).getTarget()=vi_1041
	and target_40.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="sem_nsems"
	and target_40.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
}

predicate func_42(Variable vsem_io_1009, Variable vsma_1005, ExprStmt target_42) {
	target_42.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="semval"
	and target_42.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="sem_base"
	and target_42.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsma_1005
	and target_42.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_42.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsem_io_1009
	and target_42.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

from Function func, Variable vsem_io_1009, Variable vi_1041, Variable vsma_1005, Variable verr_1007, FunctionCall target_0, FunctionCall target_1, FunctionCall target_2, FunctionCall target_3, FunctionCall target_4, ForStmt target_5, IfStmt target_6, PointerFieldAccess target_17, ValueFieldAccess target_18, FunctionCall target_19, VariableAccess target_20, VariableAccess target_21, VariableAccess target_22, VariableAccess target_23, VariableAccess target_24, PointerFieldAccess target_25, ValueFieldAccess target_26, PointerFieldAccess target_27, PointerFieldAccess target_28, ValueFieldAccess target_29, FunctionCall target_30, ExprStmt target_32, ExprStmt target_33, BlockStmt target_35, ForStmt target_36, ExprStmt target_37, ExprStmt target_38, RelationalOperation target_40, ExprStmt target_42
where
func_0(vsma_1005, target_0)
and func_1(func, target_1)
and func_2(vsma_1005, target_2)
and func_3(vsma_1005, target_3)
and func_4(func, target_4)
and func_5(vsem_io_1009, vi_1041, vsma_1005, target_32, target_5)
and func_6(verr_1007, target_33, target_6)
and not func_7(func)
and not func_8(vsma_1005)
and not func_9(func)
and not func_10(target_35, func)
and not func_11(target_18, func)
and not func_12(vsma_1005, verr_1007, target_36, target_37, target_38)
and not func_14(vsma_1005)
and not func_16(func)
and func_17(vsma_1005, target_17)
and func_18(vsma_1005, target_18)
and func_19(vsma_1005, target_19)
and func_20(vsma_1005, target_20)
and func_21(vsma_1005, target_21)
and func_22(vsma_1005, target_22)
and func_23(vsma_1005, target_23)
and func_24(vsma_1005, target_24)
and func_25(vsma_1005, target_25)
and func_26(vsma_1005, target_40, target_26)
and func_27(vsma_1005, target_27)
and func_28(vsma_1005, target_42, target_28)
and func_29(vsma_1005, target_37, target_29)
and func_30(vsma_1005, target_30)
and func_32(func, target_32)
and func_33(vsma_1005, target_33)
and func_35(verr_1007, target_18, target_35)
and func_36(vsem_io_1009, vsma_1005, target_36)
and func_37(vsma_1005, target_37)
and func_38(verr_1007, target_38)
and func_40(vi_1041, vsma_1005, target_40)
and func_42(vsem_io_1009, vsma_1005, target_42)
and vsem_io_1009.getType().hasName("ushort *")
and vi_1041.getType().hasName("int")
and vsma_1005.getType().hasName("sem_array *")
and verr_1007.getType().hasName("int")
and vsem_io_1009.(LocalVariable).getFunction() = func
and vi_1041.(LocalVariable).getFunction() = func
and vsma_1005.(LocalVariable).getFunction() = func
and verr_1007.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
