/**
 * @name linux-d5468d7afaa9c9e961e150f0455a14a9f4872a98-usbvision_probe
 * @id cpp/linux/d5468d7afaa9c9e961e150f0455a14a9f4872a98/usbvision-probe
 * @description linux-d5468d7afaa9c9e961e150f0455a14a9f4872a98-drivers/media/usb/usbvision/usbvision-video.c-usbvision_probe CVE-2015-7833
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1509"
	and not target_0.getValue()="1502"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6usbvision:[%s:%d] bridge_type %d"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="bridge_type"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("usb_usbvision *")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="1515"
	and not target_1.getValue()="1508"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6usbvision:[%s:%d] Alternate settings: %i"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="num_alt"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("usb_usbvision *")
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="1529"
	and not target_2.getValue()="1522"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6usbvision:[%s:%d] Alternate setting %i, max size= %i"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("int")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="alt_max_pkt_size"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("usb_usbvision *")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, Literal target_3) {
	target_3.getValue()="1557"
	and not target_3.getValue()="1550"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6usbvision:[%s:%d] success"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vdev_1434, Variable vifnum_1436, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="interface"
	and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="actconfig"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_1434
	and target_4.getParent().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vifnum_1436
}

predicate func_5(Variable vdev_1434, Variable vifnum_1436, Function func, IfStmt target_5) {
	target_5.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vifnum_1436
	and target_5.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_5.getCondition().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="interface"
	and target_5.getCondition().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="actconfig"
	and target_5.getCondition().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_1434
	and target_5.getCondition().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vifnum_1436
	and target_5.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-19"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

from Function func, Variable vdev_1434, Variable vifnum_1436, Literal target_0, Literal target_1, Literal target_2, Literal target_3, PointerFieldAccess target_4, IfStmt target_5
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(vdev_1434, vifnum_1436, target_4)
and func_5(vdev_1434, vifnum_1436, func, target_5)
and vdev_1434.getType().hasName("usb_device *")
and vifnum_1436.getType().hasName("__u8")
and vdev_1434.(LocalVariable).getFunction() = func
and vifnum_1436.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
