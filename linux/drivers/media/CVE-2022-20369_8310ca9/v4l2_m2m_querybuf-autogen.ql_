/**
 * @name linux-8310ca94075e784bbb06593cd6c068ee6b6e4ca6-v4l2_m2m_querybuf
 * @id cpp/linux/8310ca94075e784bbb06593cd6c068ee6b6e4ca6/v4l2-m2m-querybuf
 * @description linux-8310ca94075e784bbb06593cd6c068ee6b6e4ca6-drivers/media/v4l2-core/v4l2-mem2mem.c-v4l2_m2m_querybuf CVE-2022-20369
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vbuf_589, Variable vvq_591, RelationalOperation target_14) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("v4l2_m2m_adjust_mem_offset")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vvq_591
	and target_1.getArgument(1).(VariableAccess).getTarget()=vbuf_589
	and target_1.getArgument(1).(VariableAccess).getLocation().isBefore(target_14.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Function func) {
exists(ReturnStmt target_2 |
	target_2.getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_3(Variable vret_592, Function func, ReturnStmt target_3) {
	target_3.getExpr().(VariableAccess).getTarget()=vret_592
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_5(Parameter vbuf_589, VariableAccess target_5) {
	target_5.getTarget()=vbuf_589
}

predicate func_6(Variable vvq_591, VariableAccess target_6) {
	target_6.getTarget()=vvq_591
}

predicate func_7(Function func, Initializer target_7) {
	target_7.getExpr() instanceof Literal
	and target_7.getExpr().getEnclosingFunction() = func
}

predicate func_8(Function func, DeclStmt target_8) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vbuf_589, Variable vvq_591, BlockStmt target_15, LogicalAndExpr target_9) {
	target_9.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="memory"
	and target_9.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
	and target_9.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_9.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_9.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_591
	and target_9.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_9.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_591
	and target_9.getParent().(IfStmt).getThen()=target_15
}

predicate func_10(Parameter vbuf_589, Variable vvq_591, Variable vi_593, LogicalAndExpr target_9, IfStmt target_10) {
	target_10.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_591
	and target_10.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_591
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_593
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_593
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getUpdate().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_593
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mem_offset"
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="m"
	and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getValue()="1073741824"
	and target_10.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="offset"
	and target_10.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="m"
	and target_10.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
	and target_10.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getValue()="1073741824"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

/*predicate func_11(Parameter vbuf_589, Variable vi_593, LogicalOrExpr target_16, ForStmt target_11) {
	target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_593
	and target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_11.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_593
	and target_11.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_11.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
	and target_11.getUpdate().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_593
	and target_11.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mem_offset"
	and target_11.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="m"
	and target_11.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="planes"
	and target_11.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_593
	and target_11.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getValue()="1073741824"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

*/
/*predicate func_12(Variable vi_593, AssignExpr target_12) {
	target_12.getLValue().(VariableAccess).getTarget()=vi_593
	and target_12.getRValue().(Literal).getValue()="0"
}

*/
/*predicate func_13(Parameter vbuf_589, LogicalOrExpr target_16, ExprStmt target_13) {
	target_13.getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="offset"
	and target_13.getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="m"
	and target_13.getExpr().(AssignAddExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
	and target_13.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getValue()="1073741824"
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

*/
predicate func_14(Parameter vbuf_589, Variable vi_593, RelationalOperation target_14) {
	 (target_14 instanceof GTExpr or target_14 instanceof LTExpr)
	and target_14.getLesserOperand().(VariableAccess).getTarget()=vi_593
	and target_14.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_14.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuf_589
}

predicate func_15(Function func, BlockStmt target_15) {
	target_15.getStmt(0) instanceof IfStmt
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, LogicalOrExpr target_16) {
	target_16.getLeftOperand() instanceof EqualityOperation
	and target_16.getRightOperand() instanceof EqualityOperation
	and target_16.getEnclosingFunction() = func
}

from Function func, Parameter vbuf_589, Variable vvq_591, Variable vret_592, Variable vi_593, ReturnStmt target_3, VariableAccess target_5, VariableAccess target_6, Initializer target_7, DeclStmt target_8, LogicalAndExpr target_9, IfStmt target_10, RelationalOperation target_14, BlockStmt target_15, LogicalOrExpr target_16
where
not func_1(vbuf_589, vvq_591, target_14)
and not func_2(func)
and func_3(vret_592, func, target_3)
and func_5(vbuf_589, target_5)
and func_6(vvq_591, target_6)
and func_7(func, target_7)
and func_8(func, target_8)
and func_9(vbuf_589, vvq_591, target_15, target_9)
and func_10(vbuf_589, vvq_591, vi_593, target_9, target_10)
and func_14(vbuf_589, vi_593, target_14)
and func_15(func, target_15)
and func_16(func, target_16)
and vbuf_589.getType().hasName("v4l2_buffer *")
and vvq_591.getType().hasName("vb2_queue *")
and vret_592.getType().hasName("int")
and vi_593.getType().hasName("unsigned int")
and vbuf_589.getFunction() = func
and vvq_591.(LocalVariable).getFunction() = func
and vret_592.(LocalVariable).getFunction() = func
and vi_593.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
