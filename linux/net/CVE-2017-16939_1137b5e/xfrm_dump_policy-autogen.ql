/**
 * @name linux-1137b5e2529a8f5ca8ee709288ecba3e68044df2-xfrm_dump_policy
 * @id cpp/linux/1137b5e2529a8f5ca8ee709288ecba3e68044df2/xfrm-dump-policy
 * @description linux-1137b5e2529a8f5ca8ee709288ecba3e68044df2-net/xfrm/xfrm_user.c-xfrm_dump_policy CVE-2017-16939
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcb_1703, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="args"
	and target_0.getQualifier().(VariableAccess).getTarget()=vcb_1703
	and target_0.getParent().(ArrayExpr).getArrayOffset() instanceof Literal
}

predicate func_1(Parameter vcb_1703, AddressOfExpr target_1) {
	target_1.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="args"
	and target_1.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_1703
	and target_1.getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
}

predicate func_2(Variable v__cond_1709, Function func, DoStmt target_2) {
	target_2.getCondition() instanceof Literal
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(VariableAccess).getTarget()=v__cond_1709
	and target_2.getStmt().(BlockStmt).getStmt(3).(DoStmt).getCondition() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

/*predicate func_5(Variable v__cond_1709, IfStmt target_5) {
	target_5.getCondition().(VariableAccess).getTarget()=v__cond_1709
}

*/
/*predicate func_6(Function func, DoStmt target_6) {
	target_6.getCondition() instanceof Literal
	and target_6.getEnclosingFunction() = func
}

*/
predicate func_7(Parameter vcb_1703, Variable vwalk_1706, Function func, IfStmt target_7) {
	target_7.getCondition().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="args"
	and target_7.getCondition().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_1703
	and target_7.getCondition().(NotExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="args"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_1703
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("xfrm_policy_walk_init")
	and target_7.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vwalk_1706
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

/*predicate func_8(Parameter vcb_1703, NotExpr target_10, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="args"
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_1703
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_8.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_9(Variable vwalk_1706, NotExpr target_10, ExprStmt target_9) {
	target_9.getExpr().(FunctionCall).getTarget().hasName("xfrm_policy_walk_init")
	and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vwalk_1706
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
predicate func_10(Function func, NotExpr target_10) {
	target_10.getOperand() instanceof ArrayExpr
	and target_10.getEnclosingFunction() = func
}

from Function func, Parameter vcb_1703, Variable vwalk_1706, Variable v__cond_1709, PointerFieldAccess target_0, AddressOfExpr target_1, DoStmt target_2, IfStmt target_7, NotExpr target_10
where
func_0(vcb_1703, target_0)
and func_1(vcb_1703, target_1)
and func_2(v__cond_1709, func, target_2)
and func_7(vcb_1703, vwalk_1706, func, target_7)
and func_10(func, target_10)
and vcb_1703.getType().hasName("netlink_callback *")
and vwalk_1706.getType().hasName("xfrm_policy_walk *")
and v__cond_1709.getType().hasName("bool")
and vcb_1703.getFunction() = func
and vwalk_1706.(LocalVariable).getFunction() = func
and v__cond_1709.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
