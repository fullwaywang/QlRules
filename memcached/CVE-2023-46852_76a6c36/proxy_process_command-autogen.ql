/**
 * @name memcached-76a6c363c18cfe7b6a1524ae64202ac9db330767-proxy_process_command
 * @id cpp/memcached/76a6c363c18cfe7b6a1524ae64202ac9db330767/proxy-process-command
 * @description memcached-76a6c363c18cfe7b6a1524ae64202ac9db330767-proto_proxy.c-proxy_process_command CVE-2023-46852
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vpr_730, Parameter vc_724, EqualityOperation target_3, RelationalOperation target_4, ExprStmt target_5, NotExpr target_6) {
	exists(IfStmt target_1 |
		target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="tokens"
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(ValueFieldAccess).getTarget().getName()="keytoken"
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="20"
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("resp_start")
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("conn_set_state")
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("proxy_out_errstring")
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="resp"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vc_724
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="CLIENT_ERROR "
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="malformed request"
		and target_1.getElse() instanceof IfStmt
		and target_3.getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_6.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vpr_730, Variable vkeyoff_794, Variable vtemp_796, Variable vcur_797, Parameter vc_724, IfStmt target_2) {
		target_2.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="klen"
		and target_2.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="250"
		and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("resp_start")
		and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("conn_set_state")
		and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("proxy_out_errstring")
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="resp"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vc_724
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="CLIENT_ERROR "
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="key too long"
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="request"
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="tokens"
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayOffset().(ValueFieldAccess).getTarget().getName()="keytoken"
		and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayOffset().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="tokens"
		and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ArrayExpr).getArrayOffset().(ValueFieldAccess).getTarget().getName()="keytoken"
		and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ArrayExpr).getArrayOffset().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="request"
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vkeyoff_794
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="klen"
		and target_2.getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ValueFieldAccess).getTarget().getName()="klen"
		and target_2.getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_2.getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_2.getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="\r\n"
		and target_2.getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="2"
		and target_2.getElse().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="2"
		and target_2.getElse().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getRValue().(CharLiteral).getValue()="0"
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("proxy_process_command")
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vtemp_796
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vcur_797
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vtemp_796
		and target_2.getElse().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="1"
}

predicate func_3(Variable vpr_730, EqualityOperation target_3) {
		target_3.getAnOperand().(ValueFieldAccess).getTarget().getName()="klen"
		and target_3.getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_3.getAnOperand().(Literal).getValue()="0"
}

predicate func_4(Variable vpr_730, RelationalOperation target_4) {
		 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
		and target_4.getGreaterOperand().(ValueFieldAccess).getTarget().getName()="klen"
		and target_4.getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpr_730
		and target_4.getLesserOperand().(Literal).getValue()="250"
}

predicate func_5(Parameter vc_724, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("process_command_ascii")
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
		and target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("char *")
}

predicate func_6(Parameter vc_724, NotExpr target_6) {
		target_6.getOperand().(FunctionCall).getTarget().hasName("resp_start")
		and target_6.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_724
}

from Function func, Variable vpr_730, Variable vkeyoff_794, Variable vtemp_796, Variable vcur_797, Parameter vc_724, IfStmt target_2, EqualityOperation target_3, RelationalOperation target_4, ExprStmt target_5, NotExpr target_6
where
not func_1(vpr_730, vc_724, target_3, target_4, target_5, target_6)
and func_2(vpr_730, vkeyoff_794, vtemp_796, vcur_797, vc_724, target_2)
and func_3(vpr_730, target_3)
and func_4(vpr_730, target_4)
and func_5(vc_724, target_5)
and func_6(vc_724, target_6)
and vpr_730.getType().hasName("mcp_parser_t")
and vkeyoff_794.getType().hasName("uint32_t")
and vtemp_796.getType().hasName("char[280]")
and vcur_797.getType().hasName("char *")
and vc_724.getType().hasName("conn *")
and vpr_730.(LocalVariable).getFunction() = func
and vkeyoff_794.(LocalVariable).getFunction() = func
and vtemp_796.(LocalVariable).getFunction() = func
and vcur_797.(LocalVariable).getFunction() = func
and vc_724.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
