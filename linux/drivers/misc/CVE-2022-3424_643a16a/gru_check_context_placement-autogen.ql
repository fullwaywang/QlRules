/**
 * @name linux-643a16a0eb1d6ac23744bb6e90a00fc21148a9dc-gru_check_context_placement
 * @id cpp/linux/643a16a0eb1d6ac23744bb6e90a00fc21148a9dc/gru-check-context-placement
 * @description linux-643a16a0eb1d6ac23744bb6e90a00fc21148a9dc-drivers/misc/sgi-gru/grumain.c-gru_check_context_placement CVE-2022-3424
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1"
	and not target_0.getValue()="0"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_0.getEnclosingFunction() = func
}

predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("int")
	and target_2.getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_2.getEnclosingFunction() = func)
}

predicate func_4(Parameter vgts_719, FunctionCall target_4) {
	target_4.getTarget().hasName("gru_unload_context")
	and target_4.getArgument(0).(VariableAccess).getTarget()=vgts_719
	and target_4.getArgument(1) instanceof Literal
}

from Function func, Parameter vgts_719, Literal target_0, FunctionCall target_4
where
func_0(func, target_0)
and not func_2(func)
and func_4(vgts_719, target_4)
and vgts_719.getType().hasName("gru_thread_state *")
and vgts_719.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
