/**
 * @name openssl-338a5e7e5458edf4cf754fd831a451fb4b57d180-dtls1_reassemble_fragment
 * @id cpp/openssl/338a5e7e5458edf4cf754fd831a451fb4b57d180/dtls1-reassemble-fragment
 * @description openssl-338a5e7e5458edf4cf754fd831a451fb4b57d180-ssl/d1_both.c-dtls1_reassemble_fragment CVE-2014-3506
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmsg_hdr_586, Parameter vs_586, RelationalOperation target_4) {
	exists(LogicalOrExpr target_0 |
		target_0.getAnOperand() instanceof RelationalOperation
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getTarget().hasName("dtls1_max_handshake_message_len")
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_0.getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_1(Parameter vmsg_hdr_586, RelationalOperation target_4) {
	exists(PointerFieldAccess target_1 |
		target_1.getTarget().getName()="msg_len"
		and target_1.getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_2(Variable vmax_len_592, Parameter vs_586) {
	exists(FunctionCall target_2 |
		target_2.getTarget().hasName("dtls1_max_handshake_message_len")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_2.getParent().(GTExpr).getGreaterOperand() instanceof AddExpr
		and target_2.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget()=vmax_len_592
		and target_2.getParent().(GTExpr).getParent().(IfStmt).getThen() instanceof GotoStmt)
}

*/
predicate func_3(Parameter vmsg_hdr_586, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="frag_off"
		and target_3.getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
}

predicate func_4(Parameter vmsg_hdr_586, Variable vfrag_len_592, RelationalOperation target_4) {
		 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="frag_off"
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vfrag_len_592
		and target_4.getLesserOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_4.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_4.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_5(Parameter vs_586, VariableAccess target_5) {
		target_5.getTarget()=vs_586
}

predicate func_7(Variable vmax_len_592, Parameter vs_586, Function func, IfStmt target_7) {
		target_7.getCondition().(RelationalOperation).getLesserOperand().(AddExpr).getValue()="18444"
		and target_7.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="max_cert_list"
		and target_7.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vmax_len_592
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="max_cert_list"
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_7.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vmax_len_592
		and target_7.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getValue()="18444"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Parameter vmsg_hdr_586, Variable vfrag_len_592, Variable vmax_len_592, Function func, IfStmt target_8) {
		target_8.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="frag_off"
		and target_8.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_8.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vfrag_len_592
		and target_8.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vmax_len_592
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_9(Parameter vmsg_hdr_586, Variable vfrag_len_592, Variable vmax_len_592, ExprStmt target_15, RelationalOperation target_4, WhileStmt target_16, AddExpr target_9) {
		target_9.getAnOperand().(PointerFieldAccess).getTarget().getName()="frag_off"
		and target_9.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_9.getAnOperand().(VariableAccess).getTarget()=vfrag_len_592
		and target_9.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget()=vmax_len_592
		and target_9.getParent().(GTExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_9.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_9.getAnOperand().(VariableAccess).getLocation())
		and target_9.getAnOperand().(VariableAccess).getLocation().isBefore(target_16.getCondition().(VariableAccess).getLocation())
}

*/
/*predicate func_10(Parameter vmsg_hdr_586, Variable vfrag_len_592, Variable vmax_len_592, VariableAccess target_10) {
		target_10.getTarget()=vmax_len_592
		and target_10.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="frag_off"
		and target_10.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and target_10.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vfrag_len_592
		and target_10.getParent().(GTExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

*/
predicate func_15(Parameter vmsg_hdr_586, Function func, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="seq"
		and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_586
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Variable vfrag_len_592, Parameter vs_586, WhileStmt target_16) {
		target_16.getCondition().(VariableAccess).getTarget()=vfrag_len_592
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="ssl_read_bytes"
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(Literal).getValue()="22"
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned char[256]")
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(3).(ConditionalExpr).getElse().(VariableAccess).getTarget()=vfrag_len_592
		and target_16.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(4).(Literal).getValue()="0"
}

from Function func, Parameter vmsg_hdr_586, Variable vfrag_len_592, Variable vmax_len_592, Parameter vs_586, PointerFieldAccess target_3, RelationalOperation target_4, VariableAccess target_5, IfStmt target_7, IfStmt target_8, ExprStmt target_15, WhileStmt target_16
where
not func_0(vmsg_hdr_586, vs_586, target_4)
and func_3(vmsg_hdr_586, target_3)
and func_4(vmsg_hdr_586, vfrag_len_592, target_4)
and func_5(vs_586, target_5)
and func_7(vmax_len_592, vs_586, func, target_7)
and func_8(vmsg_hdr_586, vfrag_len_592, vmax_len_592, func, target_8)
and func_15(vmsg_hdr_586, func, target_15)
and func_16(vfrag_len_592, vs_586, target_16)
and vmsg_hdr_586.getType().hasName("hm_header_st *")
and vfrag_len_592.getType().hasName("unsigned long")
and vmax_len_592.getType().hasName("unsigned long")
and vs_586.getType().hasName("SSL *")
and vmsg_hdr_586.getFunction() = func
and vfrag_len_592.(LocalVariable).getFunction() = func
and vmax_len_592.(LocalVariable).getFunction() = func
and vs_586.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
