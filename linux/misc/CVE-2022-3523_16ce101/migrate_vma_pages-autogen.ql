/**
 * @name linux-16ce101db85db694a91380aa4c89b25530871d33-migrate_vma_pages
 * @id cpp/linux/16ce101db85db694a91380aa4c89b25530871d33/migrate-vma-pages
 * @description linux-16ce101db85db694a91380aa4c89b25530871d33-migrate_vma_pages CVE-2022-3523
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmigrate_688, Variable vnewpage_697, Variable vpage_698, Variable vmapping_699, Variable vr_700, ExprStmt target_2, ExprStmt target_3, FunctionCall target_4, FunctionCall target_5, ExprStmt target_6, FunctionCall target_7, IfStmt target_8, ExprStmt target_1) {
	exists(IfStmt target_0 |
		target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="fault_page"
		and target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmigrate_688
		and target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vpage_698
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_700
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("migrate_folio_extra")
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmapping_699
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("_compound_head")
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnewpage_697
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(FunctionCall).getTarget().hasName("_compound_head")
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_698
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="1"
		and target_0.getElse() instanceof ExprStmt
		and target_2.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_4.getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_5.getArgument(0).(VariableAccess).getLocation())
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_7.getArgument(0).(VariableAccess).getLocation())
		and target_8.getCondition().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vnewpage_697, Variable vpage_698, Variable vmapping_699, Variable vr_700, ExprStmt target_1) {
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_700
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("migrate_folio")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmapping_699
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("_compound_head")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnewpage_697
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(FunctionCall).getTarget().hasName("_compound_head")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_698
}

predicate func_2(Parameter vmigrate_688, FunctionCall target_4, ExprStmt target_2) {
		target_2.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="src"
		and target_2.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmigrate_688
		and target_2.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_2.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709551613"
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
}

predicate func_3(Parameter vmigrate_688, EqualityOperation target_10, ExprStmt target_3) {
		target_3.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="src"
		and target_3.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmigrate_688
		and target_3.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_3.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709551613"
		and target_3.getParent().(IfStmt).getCondition()=target_10
}

predicate func_4(Variable vnewpage_697, FunctionCall target_4) {
		target_4.getTarget().hasName("is_zone_device_page")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vnewpage_697
}

predicate func_5(Variable vnewpage_697, FunctionCall target_5) {
		target_5.getTarget().hasName("_compound_head")
		and target_5.getArgument(0).(VariableAccess).getTarget()=vnewpage_697
}

predicate func_6(Variable vpage_698, Variable vmapping_699, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vmapping_699
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("page_mapping")
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_698
}

predicate func_7(Variable vpage_698, FunctionCall target_7) {
		target_7.getTarget().hasName("_compound_head")
		and target_7.getArgument(0).(VariableAccess).getTarget()=vpage_698
}

predicate func_8(Parameter vmigrate_688, Variable vmapping_699, IfStmt target_8) {
		target_8.getCondition().(VariableAccess).getTarget()=vmapping_699
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="src"
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmigrate_688
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709551613"
}

predicate func_10(Variable vr_700, EqualityOperation target_10) {
		target_10.getAnOperand().(VariableAccess).getTarget()=vr_700
		and target_10.getAnOperand().(Literal).getValue()="0"
}

from Function func, Parameter vmigrate_688, Variable vnewpage_697, Variable vpage_698, Variable vmapping_699, Variable vr_700, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, FunctionCall target_4, FunctionCall target_5, ExprStmt target_6, FunctionCall target_7, IfStmt target_8, EqualityOperation target_10
where
not func_0(vmigrate_688, vnewpage_697, vpage_698, vmapping_699, vr_700, target_2, target_3, target_4, target_5, target_6, target_7, target_8, target_1)
and func_1(vnewpage_697, vpage_698, vmapping_699, vr_700, target_1)
and func_2(vmigrate_688, target_4, target_2)
and func_3(vmigrate_688, target_10, target_3)
and func_4(vnewpage_697, target_4)
and func_5(vnewpage_697, target_5)
and func_6(vpage_698, vmapping_699, target_6)
and func_7(vpage_698, target_7)
and func_8(vmigrate_688, vmapping_699, target_8)
and func_10(vr_700, target_10)
and vmigrate_688.getType().hasName("migrate_vma *")
and vnewpage_697.getType().hasName("page *")
and vpage_698.getType().hasName("page *")
and vmapping_699.getType().hasName("address_space *")
and vr_700.getType().hasName("int")
and vmigrate_688.getFunction() = func
and vnewpage_697.(LocalVariable).getFunction() = func
and vpage_698.(LocalVariable).getFunction() = func
and vmapping_699.(LocalVariable).getFunction() = func
and vr_700.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
