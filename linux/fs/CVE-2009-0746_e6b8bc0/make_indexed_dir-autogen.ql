/**
 * @name linux-e6b8bc09ba2075cd91fbffefcd2778b1a00bd76f-make_indexed_dir
 * @id cpp/linux/e6b8bc09ba2075cd91fbffefcd2778b1a00bd76f/make-indexed-dir
 * @description linux-e6b8bc09ba2075cd91fbffefcd2778b1a00bd76f-fs/ext4/namei.c-make_indexed_dir CVE-2009-0746
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbh_1352, Variable vdir_1354, Variable vroot_1358, Variable vde_1361, Variable vblocksize_1365, Variable v__func__, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, FunctionCall target_4, ExprStmt target_5, ExprStmt target_7, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vde_1361
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vroot_1358
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vblocksize_1365
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vde_1361
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vroot_1358
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vblocksize_1365
		and target_0.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_0.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(VariableAccess).getType().hasName("int")
		and target_0.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("int")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ext4_error")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdir_1354
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="invalid rec_len for '..' in inode %lu"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="i_ino"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdir_1354
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brelse")
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbh_1352
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-5"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getArgument(0).(VariableAccess).getLocation())
		and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vbh_1352, ConditionalExpr target_9, ExprStmt target_1) {
		target_1.getExpr().(FunctionCall).getTarget().hasName("brelse")
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbh_1352
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_2(Parameter vbh_1352, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="bh"
		and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dx_frame *")
		and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vbh_1352
}

predicate func_3(Variable vdir_1354, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("buffer_head *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ext4_append")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("handle_t *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdir_1354
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("ext4_lblk_t")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_4(Variable vdir_1354, FunctionCall target_4) {
		target_4.getTarget().hasName("EXT4_I")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vdir_1354
}

predicate func_5(Parameter vbh_1352, Variable vroot_1358, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vroot_1358
		and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="b_data"
		and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbh_1352
}

predicate func_7(Variable vdir_1354, Variable vblocksize_1365, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vblocksize_1365
		and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="s_blocksize"
		and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdir_1354
}

predicate func_9(Function func, ConditionalExpr target_9) {
		target_9.getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(VariableAccess).getTarget().getType().hasName("buffer_head *")
		and target_9.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget().getType().hasName("buffer_head *")
		and target_9.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getTarget().getName()="hit"
		and target_9.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getElse().(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getTarget().getName()="miss"
		and target_9.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getEnclosingFunction() = func
}

from Function func, Parameter vbh_1352, Variable vdir_1354, Variable vroot_1358, Variable vde_1361, Variable vblocksize_1365, Variable v__func__, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, FunctionCall target_4, ExprStmt target_5, ExprStmt target_7, ConditionalExpr target_9
where
not func_0(vbh_1352, vdir_1354, vroot_1358, vde_1361, vblocksize_1365, v__func__, target_1, target_2, target_3, target_4, target_5, target_7, func)
and func_1(vbh_1352, target_9, target_1)
and func_2(vbh_1352, target_2)
and func_3(vdir_1354, target_3)
and func_4(vdir_1354, target_4)
and func_5(vbh_1352, vroot_1358, target_5)
and func_7(vdir_1354, vblocksize_1365, target_7)
and func_9(func, target_9)
and vbh_1352.getType().hasName("buffer_head *")
and vdir_1354.getType().hasName("inode *")
and vroot_1358.getType().hasName("dx_root *")
and vde_1361.getType().hasName("ext4_dir_entry_2 *")
and vblocksize_1365.getType().hasName("unsigned int")
and v__func__.getType() instanceof ArrayType
and vbh_1352.getFunction() = func
and vdir_1354.(LocalVariable).getFunction() = func
and vroot_1358.(LocalVariable).getFunction() = func
and vde_1361.(LocalVariable).getFunction() = func
and vblocksize_1365.(LocalVariable).getFunction() = func
and not v__func__.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
