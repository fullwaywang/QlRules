/**
 * @name linux-bceaa90240b6019ed73b49965eac7d167610be69-dgram_recvmsg
 * @id cpp/linux/bceaa90240b6019ed73b49965eac7d167610be69/dgram-recvmsg
 * @description linux-bceaa90240b6019ed73b49965eac7d167610be69-net/ieee802154/dgram.c-dgram_recvmsg CVE-2013-7263
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsk_287, Parameter vmsg_288, Variable vskb_293, FunctionCall target_0) {
	target_0.getTarget().hasName("sock_recv_ts_and_drops")
	and not target_0.getTarget().hasName("sock_recv_timestamp")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vmsg_288
	and target_0.getArgument(1).(VariableAccess).getTarget()=vsk_287
	and target_0.getArgument(2).(VariableAccess).getTarget()=vskb_293
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="36"
	and not target_1.getValue()="1"
	and target_1.getParent().(AssignExpr).getParent().(ExprStmt).getExpr() instanceof AssignExpr
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, SizeofExprOperator target_2) {
	target_2.getValue()="20"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(ExprStmt target_32, Function func, DeclStmt target_3) {
	target_3.getLocation().isBefore(target_32.getLocation())
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vsaddr_294, ExprStmt target_33, IfStmt target_4) {
	target_4.getCondition().(VariableAccess).getTarget()=vsaddr_294
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof AssignExpr
	and target_33.getLocation().isBefore(target_4.getLocation())
}

predicate func_5(Variable verr_292, LabelStmt target_34, IfStmt target_5) {
	target_5.getCondition().(VariableAccess).getTarget()=verr_292
	and target_5.getThen() instanceof ReturnStmt
	and target_34.getLocation().isBefore(target_5.getLocation())
}

predicate func_7(Parameter vflags_288, BlockStmt target_35, ExprStmt target_36, BitwiseAndExpr target_37) {
exists(BitwiseAndExpr target_7 |
	target_7.getLeftOperand().(VariableAccess).getTarget()=vflags_288
	and target_7.getRightOperand().(Literal).getValue()="1"
	and target_7.getParent().(IfStmt).getThen()=target_35
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getLeftOperand().(VariableAccess).getLocation())
	and target_7.getLeftOperand().(VariableAccess).getLocation().isBefore(target_37.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_8(VariableAccess target_26, Function func) {
exists(GotoStmt target_8 |
	target_8.getName() ="out"
	and target_8.getParent().(IfStmt).getCondition()=target_26
	and target_8.getEnclosingFunction() = func)
}

predicate func_10(Function func) {
exists(AssignExpr target_10 |
	target_10.getLValue().(PointerFieldAccess).getTarget().getName()="sin_family"
	and target_10.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("sockaddr_in *")
	and target_10.getRValue().(Literal).getValue()="2"
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(Variable vskb_293) {
exists(AssignExpr target_11 |
	target_11.getLValue().(ValueFieldAccess).getTarget().getName()="s_addr"
	and target_11.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sin_addr"
	and target_11.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("sockaddr_in *")
	and target_11.getRValue().(PointerFieldAccess).getTarget().getName()="saddr"
	and target_11.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ip_hdr")
	and target_11.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_293)
}

predicate func_12(VariableAccess target_26, Function func) {
exists(ExprStmt target_12 |
	target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sin_port"
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("sockaddr_in *")
	and target_12.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_12
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
	and target_12.getEnclosingFunction() = func)
}

predicate func_13(VariableAccess target_26, Function func) {
exists(ExprStmt target_13 |
	target_13.getExpr().(FunctionCall).getTarget().hasName("memset")
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="__pad"
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("sockaddr_in *")
	and target_13.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_13.getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_13
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
	and target_13.getEnclosingFunction() = func)
}

predicate func_14(Function func) {
exists(PointerFieldAccess target_14 |
	target_14.getTarget().getName()="__pad"
	and target_14.getQualifier().(VariableAccess).getType().hasName("sockaddr_in *")
	and target_14.getEnclosingFunction() = func)
}

predicate func_15(Function func) {
exists(SizeofExprOperator target_15 |
	target_15.getValue()="16"
	and target_15.getEnclosingFunction() = func)
}

predicate func_16(Function func) {
exists(PointerFieldAccess target_16 |
	target_16.getTarget().getName()="cmsg_flags"
	and target_16.getQualifier().(VariableAccess).getType().hasName("inet_sock *")
	and target_16.getEnclosingFunction() = func)
}

predicate func_17(Parameter vmsg_288, Variable vskb_293, ExprStmt target_33, ExprStmt target_39) {
exists(FunctionCall target_17 |
	target_17.getTarget().hasName("ip_cmsg_recv")
	and target_17.getArgument(0).(VariableAccess).getTarget()=vmsg_288
	and target_17.getArgument(1).(VariableAccess).getTarget()=vskb_293
	and target_17.getArgument(1).(VariableAccess).getLocation().isBefore(target_39.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_18(Variable vcopied_291, Variable verr_292) {
exists(ConditionalExpr target_18 |
	target_18.getCondition().(VariableAccess).getTarget()=verr_292
	and target_18.getThen().(VariableAccess).getTarget()=verr_292
	and target_18.getElse().(VariableAccess).getTarget()=vcopied_291)
}

predicate func_19(Parameter vmsg_288, Variable vsaddr_294, PointerFieldAccess target_19) {
	target_19.getTarget().getName()="msg_name"
	and target_19.getQualifier().(VariableAccess).getTarget()=vmsg_288
	and target_19.getParent().(AssignExpr).getRValue() = target_19
	and target_19.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsaddr_294
}

predicate func_20(Variable vskb_293, VariableAccess target_20) {
	target_20.getTarget()=vskb_293
	and target_20.getParent().(FunctionCall).getParent().(PointerFieldAccess).getQualifier() instanceof FunctionCall
}

predicate func_21(Variable verr_292, ReturnStmt target_31, VariableAccess target_21) {
	target_21.getTarget()=verr_292
	and target_21.getParent().(IfStmt).getThen()=target_31
}

predicate func_22(Variable verr_292, VariableAccess target_22) {
	target_22.getTarget()=verr_292
}

predicate func_23(Variable vcopied_291, VariableAccess target_23) {
	target_23.getTarget()=vcopied_291
}

predicate func_25(Parameter vmsg_288, Variable vsaddr_294, AssignExpr target_25) {
	target_25.getLValue().(VariableAccess).getTarget()=vsaddr_294
	and target_25.getRValue().(PointerFieldAccess).getTarget().getName()="msg_name"
	and target_25.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_288
}

predicate func_26(Variable vsaddr_294, BlockStmt target_35, ExprStmt target_32, VariableAccess target_26) {
	target_26.getTarget()=vsaddr_294
	and target_26.getParent().(IfStmt).getThen()=target_35
}

predicate func_27(Variable vsaddr_294, AssignExpr target_27) {
	target_27.getLValue().(PointerFieldAccess).getTarget().getName()="family"
	and target_27.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsaddr_294
	and target_27.getRValue() instanceof Literal
}

predicate func_28(Variable vskb_293, Variable vsaddr_294, AssignExpr target_28) {
	target_28.getLValue().(PointerFieldAccess).getTarget().getName()="addr"
	and target_28.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsaddr_294
	and target_28.getRValue().(PointerFieldAccess).getTarget().getName()="sa"
	and target_28.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("mac_cb")
	and target_28.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_293
}

predicate func_29(Parameter vaddr_len_289, ExprStmt target_41, VariableAccess target_29) {
	target_29.getTarget()=vaddr_len_289
	and target_29.getParent().(IfStmt).getThen()=target_41
}

predicate func_30(Variable vsaddr_294, VariableAccess target_30) {
	target_30.getTarget()=vsaddr_294
}

predicate func_31(Variable verr_292, VariableAccess target_21, ReturnStmt target_31) {
	target_31.getExpr().(VariableAccess).getTarget()=verr_292
	and target_31.getParent().(IfStmt).getCondition()=target_21
}

predicate func_32(Function func, ExprStmt target_32) {
	target_32.getExpr() instanceof AssignExpr
	and target_32.getEnclosingFunction() = func
}

predicate func_33(Function func, ExprStmt target_33) {
	target_33.getExpr() instanceof FunctionCall
	and target_33.getEnclosingFunction() = func
}

predicate func_34(Function func, LabelStmt target_34) {
	target_34.getName() ="out"
	and target_34.getEnclosingFunction() = func
}

predicate func_35(Function func, BlockStmt target_35) {
	target_35.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_35.getStmt(1).(ExprStmt).getExpr() instanceof AssignExpr
	and target_35.getEnclosingFunction() = func
}

predicate func_36(Parameter vsk_287, Parameter vflags_288, Variable verr_292, Variable vskb_293, ExprStmt target_36) {
	target_36.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vskb_293
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_recv_datagram")
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsk_287
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_288
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int")
	and target_36.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=verr_292
}

predicate func_37(Parameter vflags_288, BitwiseAndExpr target_37) {
	target_37.getLeftOperand().(VariableAccess).getTarget()=vflags_288
	and target_37.getRightOperand().(Literal).getValue()="32"
}

predicate func_39(Variable vcopied_291, Variable vskb_293, BitwiseAndExpr target_37, ExprStmt target_39) {
	target_39.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vcopied_291
	and target_39.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="len"
	and target_39.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_293
	and target_39.getParent().(IfStmt).getCondition()=target_37
}

predicate func_41(Parameter vaddr_len_289, ExprStmt target_41) {
	target_41.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vaddr_len_289
	and target_41.getExpr().(AssignExpr).getRValue() instanceof SizeofExprOperator
}

from Function func, Parameter vsk_287, Parameter vmsg_288, Parameter vflags_288, Parameter vaddr_len_289, Variable vcopied_291, Variable verr_292, Variable vskb_293, Variable vsaddr_294, FunctionCall target_0, Literal target_1, SizeofExprOperator target_2, DeclStmt target_3, IfStmt target_4, IfStmt target_5, PointerFieldAccess target_19, VariableAccess target_20, VariableAccess target_21, VariableAccess target_22, VariableAccess target_23, AssignExpr target_25, VariableAccess target_26, AssignExpr target_27, AssignExpr target_28, VariableAccess target_29, VariableAccess target_30, ReturnStmt target_31, ExprStmt target_32, ExprStmt target_33, LabelStmt target_34, BlockStmt target_35, ExprStmt target_36, BitwiseAndExpr target_37, ExprStmt target_39, ExprStmt target_41
where
func_0(vsk_287, vmsg_288, vskb_293, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(target_32, func, target_3)
and func_4(vsaddr_294, target_33, target_4)
and func_5(verr_292, target_34, target_5)
and not func_7(vflags_288, target_35, target_36, target_37)
and not func_8(target_26, func)
and not func_10(func)
and not func_11(vskb_293)
and not func_12(target_26, func)
and not func_13(target_26, func)
and not func_14(func)
and not func_15(func)
and not func_16(func)
and not func_17(vmsg_288, vskb_293, target_33, target_39)
and not func_18(vcopied_291, verr_292)
and func_19(vmsg_288, vsaddr_294, target_19)
and func_20(vskb_293, target_20)
and func_21(verr_292, target_31, target_21)
and func_22(verr_292, target_22)
and func_23(vcopied_291, target_23)
and func_25(vmsg_288, vsaddr_294, target_25)
and func_26(vsaddr_294, target_35, target_32, target_26)
and func_27(vsaddr_294, target_27)
and func_28(vskb_293, vsaddr_294, target_28)
and func_29(vaddr_len_289, target_41, target_29)
and func_30(vsaddr_294, target_30)
and func_31(verr_292, target_21, target_31)
and func_32(func, target_32)
and func_33(func, target_33)
and func_34(func, target_34)
and func_35(func, target_35)
and func_36(vsk_287, vflags_288, verr_292, vskb_293, target_36)
and func_37(vflags_288, target_37)
and func_39(vcopied_291, vskb_293, target_37, target_39)
and func_41(vaddr_len_289, target_41)
and vsk_287.getType().hasName("sock *")
and vmsg_288.getType().hasName("msghdr *")
and vflags_288.getType().hasName("int")
and vaddr_len_289.getType().hasName("int *")
and vcopied_291.getType().hasName("size_t")
and verr_292.getType().hasName("int")
and vskb_293.getType().hasName("sk_buff *")
and vsaddr_294.getType().hasName("sockaddr_ieee802154 *")
and vsk_287.getFunction() = func
and vmsg_288.getFunction() = func
and vflags_288.getFunction() = func
and vaddr_len_289.getFunction() = func
and vcopied_291.(LocalVariable).getFunction() = func
and verr_292.(LocalVariable).getFunction() = func
and vskb_293.(LocalVariable).getFunction() = func
and vsaddr_294.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
