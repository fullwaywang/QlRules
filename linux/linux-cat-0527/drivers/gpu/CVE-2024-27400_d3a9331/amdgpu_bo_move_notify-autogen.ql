/**
 * @name linux-d3a9331a6591e9df64791e076f6591f440af51c3-amdgpu_bo_move_notify
 * @id cpp/linux/d3a9331a6591e9df64791e076f6591f440af51c3/amdgpu-bo-move-notify
 * @description linux-d3a9331a6591e9df64791e076f6591f440af51c3-drivers/gpu/drm/amd/amdgpu/amdgpu_object.c-amdgpu_bo_move_notify CVE-2024-27400
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vadev_1253, FunctionCall target_0) {
	target_0.getTarget().hasName("atomic64_inc")
	and not target_0.getTarget().hasName("trace_amdgpu_bo_move")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="num_evictions"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vadev_1253
}

predicate func_1(Parameter vbo_1251, ExprStmt target_10) {
exists(LogicalAndExpr target_1 |
	target_1.getLeftOperand() instanceof LogicalAndExpr
	and target_1.getRightOperand().(VariableAccess).getType().hasName("ttm_resource *")
	and target_1.getParent().(LogicalAndExpr).getLeftOperand() instanceof LogicalAndExpr
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mem_type"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="resource"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbo_1251
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_10)
}

predicate func_4(Function func) {
exists(ConditionalExpr target_4 |
	target_4.getCondition().(VariableAccess).getType().hasName("ttm_resource *")
	and target_4.getThen().(PointerFieldAccess).getTarget().getName()="mem_type"
	and target_4.getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ttm_resource *")
	and target_4.getElse().(UnaryMinusExpr).getValue()="4294967295"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Function func) {
exists(ConditionalExpr target_5 |
	target_5.getCondition().(VariableAccess).getType().hasName("ttm_resource *")
	and target_5.getThen().(PointerFieldAccess).getTarget().getName()="mem_type"
	and target_5.getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ttm_resource *")
	and target_5.getElse().(UnaryMinusExpr).getValue()="4294967295"
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Parameter vbo_1251, Variable vabo_1254, ExprStmt target_10, LogicalAndExpr target_6) {
	target_6.getLeftOperand().(ValueFieldAccess).getTarget().getName()="dma_buf"
	and target_6.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="base"
	and target_6.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tbo"
	and target_6.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vabo_1254
	and target_6.getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="import_attach"
	and target_6.getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="base"
	and target_6.getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tbo"
	and target_6.getRightOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vabo_1254
	and target_6.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mem_type"
	and target_6.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="resource"
	and target_6.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbo_1251
	and target_6.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_6.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_10
}

/*predicate func_7(Parameter vbo_1251, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="resource"
	and target_7.getQualifier().(VariableAccess).getTarget()=vbo_1251
}

*/
predicate func_8(Parameter vevict_1251, Function func, IfStmt target_8) {
	target_8.getCondition().(VariableAccess).getTarget()=vevict_1251
	and target_8.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vadev_1253, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="num_evictions"
	and target_9.getQualifier().(VariableAccess).getTarget()=vadev_1253
}

predicate func_10(Variable vabo_1254, ExprStmt target_10) {
	target_10.getExpr().(FunctionCall).getTarget().hasName("dma_buf_move_notify")
	and target_10.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="dma_buf"
	and target_10.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="base"
	and target_10.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tbo"
	and target_10.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vabo_1254
}

from Function func, Parameter vbo_1251, Parameter vevict_1251, Variable vadev_1253, Variable vabo_1254, FunctionCall target_0, LogicalAndExpr target_6, IfStmt target_8, PointerFieldAccess target_9, ExprStmt target_10
where
func_0(vadev_1253, target_0)
and not func_1(vbo_1251, target_10)
and not func_4(func)
and not func_5(func)
and func_6(vbo_1251, vabo_1254, target_10, target_6)
and func_8(vevict_1251, func, target_8)
and func_9(vadev_1253, target_9)
and func_10(vabo_1254, target_10)
and vbo_1251.getType().hasName("ttm_buffer_object *")
and vevict_1251.getType().hasName("bool")
and vadev_1253.getType().hasName("amdgpu_device *")
and vabo_1254.getType().hasName("amdgpu_bo *")
and vbo_1251.getFunction() = func
and vevict_1251.getFunction() = func
and vadev_1253.(LocalVariable).getFunction() = func
and vabo_1254.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
