/**
 * @name linux-a4866aa812518ed1a37d8ea0c881dc946409de94-devmem_is_allowed
 * @id cpp/linux/a4866aa812518ed1a37d8ea0c881dc946409de94/devmem-is-allowed
 * @description linux-a4866aa812518ed1a37d8ea0c881dc946409de94-arch/x86/mm/init.c-devmem_is_allowed CVE-2017-7889
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(IfStmt target_4, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition() instanceof FunctionCall
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition() instanceof RelationalOperation
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(Literal).getValue()="2"
	and target_0.getThen().(BlockStmt).getStmt(1) instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_4.getLocation()))
}

/*predicate func_1(NotExpr target_9, Function func) {
exists(ReturnStmt target_1 |
	target_1.getExpr().(Literal).getValue()="2"
	and target_1.getParent().(IfStmt).getCondition()=target_9
	and target_1.getEnclosingFunction() = func)
}

*/
predicate func_2(Parameter vpagenr_652, ReturnStmt target_10, BinaryBitwiseOperation target_11) {
exists(RelationalOperation target_2 |
	 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
	and target_2.getLesserOperand().(VariableAccess).getTarget()=vpagenr_652
	and target_2.getGreaterOperand().(Literal).getValue()="256"
	and target_2.getParent().(IfStmt).getThen()=target_10
	and target_2.getLesserOperand().(VariableAccess).getLocation().isBefore(target_11.getLeftOperand().(VariableAccess).getLocation()))
}

/*predicate func_3(Parameter vpagenr_652, ReturnStmt target_10, RelationalOperation target_3) {
	 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getLesserOperand().(VariableAccess).getTarget()=vpagenr_652
	and target_3.getGreaterOperand().(Literal).getValue()="256"
	and target_3.getParent().(IfStmt).getThen()=target_10
}

*/
predicate func_4(Parameter vpagenr_652, Function func, IfStmt target_4) {
	target_4.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vpagenr_652
	and target_4.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="256"
	and target_4.getThen().(ReturnStmt).getExpr().(Literal).getValue()="1"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(FunctionCall target_12, Function func, ReturnStmt target_5) {
	target_5.getExpr().(Literal).getValue()="0"
	and target_5.getParent().(IfStmt).getCondition()=target_12
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vpagenr_652, ReturnStmt target_7, FunctionCall target_6) {
	target_6.getTarget().hasName("page_is_ram")
	and target_6.getArgument(0).(VariableAccess).getTarget()=vpagenr_652
	and target_6.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_7
}

predicate func_7(NotExpr target_9, Function func, ReturnStmt target_7) {
	target_7.getExpr().(Literal).getValue()="1"
	and target_7.getParent().(IfStmt).getCondition()=target_9
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Function func, ReturnStmt target_8) {
	target_8.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(ReturnStmt target_7, Function func, NotExpr target_9) {
	target_9.getOperand() instanceof FunctionCall
	and target_9.getParent().(IfStmt).getThen()=target_7
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Function func, ReturnStmt target_10) {
	target_10.getExpr().(Literal).getValue()="1"
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Parameter vpagenr_652, BinaryBitwiseOperation target_11) {
	target_11.getLeftOperand().(VariableAccess).getTarget()=vpagenr_652
	and target_11.getRightOperand().(Literal).getValue()="12"
}

predicate func_12(Parameter vpagenr_652, FunctionCall target_12) {
	target_12.getTarget().hasName("iomem_is_exclusive")
	and target_12.getArgument(0).(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vpagenr_652
	and target_12.getArgument(0).(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
}

from Function func, Parameter vpagenr_652, IfStmt target_4, ReturnStmt target_5, FunctionCall target_6, ReturnStmt target_7, ReturnStmt target_8, NotExpr target_9, ReturnStmt target_10, BinaryBitwiseOperation target_11, FunctionCall target_12
where
not func_0(target_4, func)
and not func_2(vpagenr_652, target_10, target_11)
and func_4(vpagenr_652, func, target_4)
and func_5(target_12, func, target_5)
and func_6(vpagenr_652, target_7, target_6)
and func_7(target_9, func, target_7)
and func_8(func, target_8)
and func_9(target_7, func, target_9)
and func_10(func, target_10)
and func_11(vpagenr_652, target_11)
and func_12(vpagenr_652, target_12)
and vpagenr_652.getType().hasName("unsigned long")
and vpagenr_652.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
