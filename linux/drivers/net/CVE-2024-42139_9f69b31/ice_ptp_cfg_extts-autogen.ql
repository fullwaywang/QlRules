/**
 * @name linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-ice_ptp_cfg_extts
 * @id cpp/linux/9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3/ice-ptp-cfg-extts
 * @description linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-drivers/net/ethernet/intel/ice/ice_ptp.c-ice_ptp_cfg_extts CVE-2024-42139
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="22"
	and not target_0.getValue()="0"
	and target_0.getParent().(UnaryMinusExpr).getParent().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vena_1612, BlockStmt target_18, VariableAccess target_1) {
	target_1.getTarget()=vena_1612
	and vena_1612.getIndex() = 1
	and target_1.getParent().(IfStmt).getThen()=target_18
}

predicate func_2(Parameter vextts_flags_1613, ExprStmt target_19, BitwiseAndExpr target_20, VariableAccess target_2) {
	exists(BitwiseAndExpr obj_0 | obj_0=target_2.getParent() |
		obj_0.getRightOperand().(BinaryBitwiseOperation).getValue()="4"
		and obj_0.getParent().(IfStmt).getThen()=target_19
	)
	and target_2.getTarget()=vextts_flags_1613
	and vextts_flags_1613.getIndex() = 4
	and target_2.getLocation().isBefore(target_20.getLeftOperand().(VariableAccess).getLocation())
}

predicate func_3(Parameter vextts_flags_1613, ExprStmt target_21, BitwiseAndExpr target_22, VariableAccess target_3) {
	exists(BitwiseAndExpr obj_0 | obj_0=target_3.getParent() |
		obj_0.getRightOperand().(BinaryBitwiseOperation).getValue()="2"
		and obj_0.getParent().(IfStmt).getThen()=target_21
	)
	and target_3.getTarget()=vextts_flags_1613
	and vextts_flags_1613.getIndex() = 4
	and target_22.getLeftOperand().(VariableAccess).getLocation().isBefore(target_3.getLocation())
}

predicate func_4(Function func) {
exists(PointerFieldAccess target_4 |
	target_4.getTarget().getName()="ena"
	and target_4.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel *")
	and target_4.getEnclosingFunction() = func
)
}

predicate func_5(Function func) {
exists(PointerFieldAccess target_5 |
	target_5.getTarget().getName()="flags"
	and target_5.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel *")
	and target_5.getEnclosingFunction() = func
)
}

predicate func_6(Function func) {
exists(PointerFieldAccess target_6 |
	target_6.getTarget().getName()="flags"
	and target_6.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel *")
	and target_6.getEnclosingFunction() = func
)
}

predicate func_7(Function func) {
exists(PointerFieldAccess target_7 |
	target_7.getTarget().getName()="gpio_pin"
	and target_7.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel *")
	and target_7.getEnclosingFunction() = func
)
}

predicate func_8(ExprStmt target_23, Function func) {
exists(IfStmt target_8 |
	exists(ExprStmt obj_0 | obj_0=target_8.getThen() |
		exists(StmtExpr obj_1 | obj_1=obj_0.getExpr() |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(6) |
					exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
						obj_4.getTarget().hasName("__builtin_memcpy")
						and obj_4.getArgument(1).(VariableAccess).getType().hasName("ice_extts_channel *")
						and obj_4.getArgument(2).(VariableAccess).getType().hasName("size_t")
					)
				)
			)
		)
	)
	and target_8.getCondition().(VariableAccess).getType().hasName("bool")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_23.getLocation())
)
}

/*predicate func_9(ExprStmt target_21, Function func) {
exists(FunctionCall target_9 |
	exists(NotExpr obj_0 | obj_0=target_9.getArgument(0) |
		exists(NotExpr obj_1 | obj_1=obj_0.getOperand() |
			exists(LogicalAndExpr obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getLeftOperand().(VariableAccess).getType().hasName("bool")
				and obj_2.getRightOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
			)
		)
	)
	and target_9.getTarget().hasName("__builtin_expect")
	and target_9.getArgument(1) instanceof Literal
	and target_9.getParent().(IfStmt).getThen()=target_21
	and target_9.getEnclosingFunction() = func
)
}

*/
/*predicate func_10(BitwiseAndExpr target_20, Function func) {
exists(ExprStmt target_10 |
	exists(BlockStmt obj_0 | obj_0=target_10.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(0)=target_10
			and obj_1.getCondition()=target_20
		)
	)
	and target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_10.getEnclosingFunction() = func
)
}

*/
/*predicate func_11(BitwiseAndExpr target_20, Function func) {
exists(ExprStmt target_11 |
	exists(BlockStmt obj_0 | obj_0=target_11.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(1)=target_11
			and obj_1.getCondition()=target_20
		)
	)
	and target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_11.getEnclosingFunction() = func
)
}

*/
predicate func_12(Parameter vpf_1612, PointerFieldAccess target_12) {
	target_12.getTarget().getName()="ptp"
	and target_12.getQualifier().(VariableAccess).getTarget()=vpf_1612
}

predicate func_13(Parameter vchan_1612, ReturnStmt target_16, VariableAccess target_13) {
	exists(GTExpr obj_0 | obj_0=target_13.getParent() |
		obj_0.getLesserOperand() instanceof ValueFieldAccess
		and obj_0.getParent().(IfStmt).getThen()=target_16
	)
	and target_13.getTarget()=vchan_1612
}

predicate func_15(Parameter vpf_1612, Parameter vchan_1612, ReturnStmt target_16, RelationalOperation target_15) {
	exists(ValueFieldAccess obj_0 | obj_0=target_15.getLesserOperand() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="ptp"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vpf_1612
			)
			and obj_1.getTarget().getName()="info"
		)
		and obj_0.getTarget().getName()="n_ext_ts"
	)
	and  (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
	and target_15.getGreaterOperand().(VariableAccess).getTarget()=vchan_1612
	and target_15.getParent().(IfStmt).getThen()=target_16
}

predicate func_16(RelationalOperation target_15, Function func, ReturnStmt target_16) {
	target_16.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_16.getParent().(IfStmt).getCondition()=target_15
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Parameter vgpio_pin_1612, VariableAccess target_17) {
	exists(MulExpr obj_0 | obj_0=target_17.getParent() |
		exists(AddExpr obj_1 | obj_1=obj_0.getParent() |
			exists(PointerAddExpr obj_2 | obj_2=obj_1.getParent() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getParent() |
					exists(ExprStmt obj_4 | obj_4=obj_3.getParent() |
						exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
							obj_5.getTarget().hasName("writel")
							and obj_5.getArgument(0).(VariableAccess).getTarget().getType().hasName("u32")
							and obj_5.getArgument(1).(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hw_addr"
						)
					)
				)
			)
		)
	)
	and target_17.getTarget()=vgpio_pin_1612
}

predicate func_18(Parameter vextts_flags_1613, BlockStmt target_18) {
	exists(ExprStmt obj_0 | obj_0=target_18.getStmt(0) |
		exists(AssignOrExpr obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
			and obj_1.getRValue().(BinaryBitwiseOperation).getValue()="4096"
		)
	)
	and exists(ExprStmt obj_2 | obj_2=target_18.getStmt(1) |
		exists(AssignExpr obj_3 | obj_3=obj_2.getExpr() |
			obj_3.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
			and obj_3.getRValue().(BinaryBitwiseOperation).getValue()="16"
		)
	)
	and exists(IfStmt obj_4 | obj_4=target_18.getStmt(2) |
		exists(BitwiseAndExpr obj_5 | obj_5=obj_4.getCondition() |
			obj_5.getLeftOperand().(VariableAccess).getTarget()=vextts_flags_1613
			and obj_5.getRightOperand().(BinaryBitwiseOperation).getValue()="4"
		)
		and exists(ExprStmt obj_6 | obj_6=obj_4.getThen() |
			exists(AssignOrExpr obj_7 | obj_7=obj_6.getExpr() |
				obj_7.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
				and obj_7.getRValue().(BinaryBitwiseOperation).getValue()="2"
			)
		)
	)
}

predicate func_19(Function func, ExprStmt target_19) {
	exists(AssignOrExpr obj_0 | obj_0=target_19.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
		and obj_0.getRValue().(BinaryBitwiseOperation).getValue()="2"
	)
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Parameter vextts_flags_1613, BitwiseAndExpr target_20) {
	target_20.getLeftOperand().(VariableAccess).getTarget()=vextts_flags_1613
	and target_20.getRightOperand().(BinaryBitwiseOperation).getValue()="2"
}

predicate func_21(Function func, ExprStmt target_21) {
	exists(AssignOrExpr obj_0 | obj_0=target_21.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
		and obj_0.getRValue().(BinaryBitwiseOperation).getValue()="1"
	)
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Parameter vextts_flags_1613, BitwiseAndExpr target_22) {
	target_22.getLeftOperand().(VariableAccess).getTarget()=vextts_flags_1613
	and target_22.getRightOperand().(BinaryBitwiseOperation).getValue()="4"
}

predicate func_23(Parameter vgpio_pin_1612, ExprStmt target_23) {
	exists(FunctionCall obj_0 | obj_0=target_23.getExpr() |
		exists(PointerArithmeticOperation obj_1 | obj_1=obj_0.getArgument(1) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLeftOperand() |
				obj_2.getTarget().getName()="hw_addr"
				and obj_2.getQualifier().(VariableAccess).getTarget().getType().hasName("ice_hw *")
			)
			and exists(AddExpr obj_3 | obj_3=obj_1.getRightOperand() |
				exists(MulExpr obj_4 | obj_4=obj_3.getRightOperand() |
					obj_4.getLeftOperand().(VariableAccess).getTarget()=vgpio_pin_1612
					and obj_4.getRightOperand().(Literal).getValue()="4"
				)
				and obj_3.getLeftOperand().(Literal).getValue()="557256"
			)
		)
		and obj_0.getTarget().hasName("writel")
		and obj_0.getArgument(0).(VariableAccess).getTarget().getType().hasName("u32")
	)
}

from Function func, Parameter vpf_1612, Parameter vena_1612, Parameter vchan_1612, Parameter vgpio_pin_1612, Parameter vextts_flags_1613, Literal target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, PointerFieldAccess target_12, VariableAccess target_13, RelationalOperation target_15, ReturnStmt target_16, VariableAccess target_17, BlockStmt target_18, ExprStmt target_19, BitwiseAndExpr target_20, ExprStmt target_21, BitwiseAndExpr target_22, ExprStmt target_23
where
func_0(func, target_0)
and func_1(vena_1612, target_18, target_1)
and func_2(vextts_flags_1613, target_19, target_20, target_2)
and func_3(vextts_flags_1613, target_21, target_22, target_3)
and not func_4(func)
and not func_5(func)
and not func_6(func)
and not func_7(func)
and not func_8(target_23, func)
and func_12(vpf_1612, target_12)
and func_13(vchan_1612, target_16, target_13)
and func_15(vpf_1612, vchan_1612, target_16, target_15)
and func_16(target_15, func, target_16)
and func_17(vgpio_pin_1612, target_17)
and func_18(vextts_flags_1613, target_18)
and func_19(func, target_19)
and func_20(vextts_flags_1613, target_20)
and func_21(func, target_21)
and func_22(vextts_flags_1613, target_22)
and func_23(vgpio_pin_1612, target_23)
and vpf_1612.getType().hasName("ice_pf *")
and vena_1612.getType().hasName("bool")
and vchan_1612.getType().hasName("unsigned int")
and vgpio_pin_1612.getType().hasName("u32")
and vextts_flags_1613.getType().hasName("unsigned int")
and vpf_1612.getFunction() = func
and vena_1612.getFunction() = func
and vchan_1612.getFunction() = func
and vgpio_pin_1612.getFunction() = func
and vextts_flags_1613.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
