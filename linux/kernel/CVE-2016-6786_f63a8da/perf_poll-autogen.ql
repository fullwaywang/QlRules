/**
 * @name linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-perf_poll
 * @id cpp/linux/f63a8daa5812afef4f06c962351687e1ff9ccb2b/perf-poll
 * @description linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-kernel/events/core.c-perf_poll CVE-2016-6786
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="16"
	and not target_0.getValue()="1"
	and target_0.getParent() instanceof Initializer
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vevent_3681, Parameter vfile_3679, Parameter vwait_3679, FunctionCall target_1) {
	target_1.getTarget().hasName("poll_wait")
	and not target_1.getTarget().hasName("rcu_read_lock")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vfile_3679
	and target_1.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="waitq"
	and target_1.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_1.getArgument(2).(VariableAccess).getTarget()=vwait_3679
}

predicate func_2(Variable vevent_3681, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="mmap_mutex"
	and target_2.getQualifier().(VariableAccess).getTarget()=vevent_3681
}

predicate func_3(Variable vrb_3682, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="poll"
	and target_3.getQualifier().(VariableAccess).getTarget()=vrb_3682
}

predicate func_4(Variable vevent_3681, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="mmap_mutex"
	and target_4.getQualifier().(VariableAccess).getTarget()=vevent_3681
}

predicate func_5(ExprStmt target_37, Function func, ExprStmt target_5) {
	target_5.getExpr() instanceof AssignExpr
	and target_37.getLocation().isBefore(target_5.getLocation())
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Variable vevent_3681, IfStmt target_38, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mmap_mutex"
	and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_38.getLocation().isBefore(target_6.getLocation())
}

predicate func_8(Variable vevent_3681, FunctionCall target_31) {
exists(AssignExpr target_8 |
	target_8.getLValue().(VariableAccess).getType().hasName("task_struct *")
	and target_8.getRValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="owner"
	and target_8.getRValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_8.getRValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_31.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_9(ExprStmt target_39, Function func) {
exists(DoStmt target_9 |
	target_9.getCondition() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getLocation().isBefore(target_39.getLocation()))
}

predicate func_11(FunctionCall target_31, Function func) {
exists(DoStmt target_11 |
	target_11.getCondition() instanceof Literal
	and target_11.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("atomic_inc")
	and target_11.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="usage"
	and target_11.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("task_struct *")
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_31
	and target_11.getEnclosingFunction() = func)
}

predicate func_13(Function func) {
exists(FunctionCall target_13 |
	target_13.getTarget().hasName("rcu_read_unlock")
	and target_13.getEnclosingFunction() = func)
}

predicate func_15(VariableAccess target_34, Function func) {
exists(ExprStmt target_15 |
	target_15.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("task_struct *")
	and target_15.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_15.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_15
	and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_34
	and target_15.getEnclosingFunction() = func)
}

predicate func_17(Variable vevent_3681, VariableAccess target_34, AddressOfExpr target_40) {
exists(IfStmt target_17 |
	target_17.getCondition().(PointerFieldAccess).getTarget().getName()="owner"
	and target_17.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_del_init")
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="owner_entry"
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_17
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_34
	and target_17.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_40.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_18(Variable vevent_3681, AddressOfExpr target_40) {
exists(FunctionCall target_18 |
	target_18.getTarget().hasName("list_del_init")
	and target_18.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="owner_entry"
	and target_18.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_18.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_40.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_19(VariableAccess target_34, Function func) {
exists(ExprStmt target_19 |
	target_19.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("task_struct *")
	and target_19.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_19
	and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_34
	and target_19.getEnclosingFunction() = func)
}

predicate func_21(Function func) {
exists(FunctionCall target_21 |
	target_21.getTarget().hasName("put_task_struct")
	and target_21.getArgument(0).(VariableAccess).getType().hasName("task_struct *")
	and target_21.getEnclosingFunction() = func)
}

predicate func_22(Variable vevent_3681, VariableAccess target_22) {
	target_22.getTarget()=vevent_3681
	and target_22.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_23(Variable vevent_3681, VariableAccess target_23) {
	target_23.getTarget()=vevent_3681
	and target_23.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_23.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mmap_mutex"
	and target_23.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_24(Variable vevent_3681, VariableAccess target_24) {
	target_24.getTarget()=vevent_3681
}

predicate func_28(Function func, DeclStmt target_28) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_28
}

predicate func_29(Function func, DeclStmt target_29) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_29
}

predicate func_30(Variable vevent_3681, PointerFieldAccess target_30) {
	target_30.getTarget().getName()="waitq"
	and target_30.getQualifier().(VariableAccess).getTarget()=vevent_3681
}

predicate func_31(Variable vevent_3681, ReturnStmt target_41, FunctionCall target_31) {
	target_31.getTarget().hasName("is_event_hup")
	and target_31.getArgument(0).(VariableAccess).getTarget()=vevent_3681
	and target_31.getParent().(IfStmt).getThen()=target_41
}

predicate func_32(Variable vevents_3683, DeclStmt target_29, VariableAccess target_32) {
	target_32.getTarget()=vevents_3683
}

predicate func_33(Variable vevent_3681, Variable vrb_3682, AssignExpr target_33) {
	target_33.getLValue().(VariableAccess).getTarget()=vrb_3682
	and target_33.getRValue().(PointerFieldAccess).getTarget().getName()="rb"
	and target_33.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
}

predicate func_34(Variable vrb_3682, ExprStmt target_42, ExprStmt target_5, AddressOfExpr target_43, VariableAccess target_34) {
	target_34.getTarget()=vrb_3682
	and target_34.getParent().(IfStmt).getThen()=target_42
	and target_34.getLocation().isBefore(target_43.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_35(Variable vrb_3682, Variable vevents_3683, AssignExpr target_35) {
	target_35.getLValue().(VariableAccess).getTarget()=vevents_3683
	and target_35.getRValue().(FunctionCall).getTarget().hasName("atomic_xchg")
	and target_35.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="poll"
	and target_35.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_3682
	and target_35.getRValue().(FunctionCall).getArgument(1) instanceof Literal
}

predicate func_36(Variable vevents_3683, ExprStmt target_42, Function func, ReturnStmt target_36) {
	target_36.getExpr().(VariableAccess).getTarget()=vevents_3683
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_36
}

predicate func_37(Variable vevent_3681, ExprStmt target_37) {
	target_37.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_37.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mmap_mutex"
	and target_37.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_37.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

predicate func_38(Variable vrb_3682, IfStmt target_38) {
	target_38.getCondition().(VariableAccess).getTarget()=vrb_3682
	and target_38.getThen().(ExprStmt).getExpr() instanceof AssignExpr
}

predicate func_39(Function func, ExprStmt target_39) {
	target_39.getExpr() instanceof FunctionCall
	and target_39.getEnclosingFunction() = func
}

predicate func_40(Variable vevent_3681, AddressOfExpr target_40) {
	target_40.getOperand().(PointerFieldAccess).getTarget().getName()="mmap_mutex"
	and target_40.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3681
	and target_40.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
}

predicate func_41(Variable vevents_3683, FunctionCall target_31, ReturnStmt target_41) {
	target_41.getExpr().(VariableAccess).getTarget()=vevents_3683
	and target_41.getParent().(IfStmt).getCondition()=target_31
}

predicate func_42(Function func, ExprStmt target_42) {
	target_42.getExpr() instanceof AssignExpr
	and target_42.getEnclosingFunction() = func
}

predicate func_43(Variable vrb_3682, AddressOfExpr target_43) {
	target_43.getOperand().(PointerFieldAccess).getTarget().getName()="poll"
	and target_43.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_3682
}

from Function func, Variable vevent_3681, Variable vrb_3682, Variable vevents_3683, Parameter vfile_3679, Parameter vwait_3679, Literal target_0, FunctionCall target_1, PointerFieldAccess target_2, PointerFieldAccess target_3, PointerFieldAccess target_4, ExprStmt target_5, ExprStmt target_6, VariableAccess target_22, VariableAccess target_23, VariableAccess target_24, DeclStmt target_28, DeclStmt target_29, PointerFieldAccess target_30, FunctionCall target_31, VariableAccess target_32, AssignExpr target_33, VariableAccess target_34, AssignExpr target_35, ReturnStmt target_36, ExprStmt target_37, IfStmt target_38, ExprStmt target_39, AddressOfExpr target_40, ReturnStmt target_41, ExprStmt target_42, AddressOfExpr target_43
where
func_0(func, target_0)
and func_1(vevent_3681, vfile_3679, vwait_3679, target_1)
and func_2(vevent_3681, target_2)
and func_3(vrb_3682, target_3)
and func_4(vevent_3681, target_4)
and func_5(target_37, func, target_5)
and func_6(vevent_3681, target_38, target_6)
and not func_8(vevent_3681, target_31)
and not func_9(target_39, func)
and not func_11(target_31, func)
and not func_13(func)
and not func_15(target_34, func)
and not func_17(vevent_3681, target_34, target_40)
and not func_19(target_34, func)
and not func_21(func)
and func_22(vevent_3681, target_22)
and func_23(vevent_3681, target_23)
and func_24(vevent_3681, target_24)
and func_28(func, target_28)
and func_29(func, target_29)
and func_30(vevent_3681, target_30)
and func_31(vevent_3681, target_41, target_31)
and func_32(vevents_3683, target_29, target_32)
and func_33(vevent_3681, vrb_3682, target_33)
and func_34(vrb_3682, target_42, target_5, target_43, target_34)
and func_35(vrb_3682, vevents_3683, target_35)
and func_36(vevents_3683, target_42, func, target_36)
and func_37(vevent_3681, target_37)
and func_38(vrb_3682, target_38)
and func_39(func, target_39)
and func_40(vevent_3681, target_40)
and func_41(vevents_3683, target_31, target_41)
and func_42(func, target_42)
and func_43(vrb_3682, target_43)
and vevent_3681.getType().hasName("perf_event *")
and vrb_3682.getType().hasName("ring_buffer *")
and vevents_3683.getType().hasName("unsigned int")
and vfile_3679.getType().hasName("file *")
and vwait_3679.getType().hasName("poll_table *")
and vevent_3681.(LocalVariable).getFunction() = func
and vrb_3682.(LocalVariable).getFunction() = func
and vevents_3683.(LocalVariable).getFunction() = func
and vfile_3679.getFunction() = func
and vwait_3679.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
