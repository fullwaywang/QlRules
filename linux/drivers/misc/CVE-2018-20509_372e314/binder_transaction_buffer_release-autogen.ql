/**
 * @name linux-372e3147df7016ebeaa372939e8774a1292db558-binder_transaction_buffer_release
 * @id cpp/linux/372e3147df7016ebeaa372939e8774a1292db558/binder-transaction-buffer-release
 * @description linux-372e3147df7016ebeaa372939e8774a1292db558-drivers/android/binder.c-binder_transaction_buffer_release CVE-2018-20509
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
	target_0.getValue()="3binder: transaction release %d bad handle %d\n"
	and not target_0.getValue()="3binder: transaction release %d bad handle %d, ret = %d\n"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, StringLiteral target_1) {
	target_1.getValue()="6binder:         ref %d desc %d (node %d)\n"
	and not target_1.getValue()="6binder:         ref %d desc %d\n"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vhdr_1096, Variable vref_1127, FunctionCall target_2) {
	target_2.getTarget().hasName("binder_dec_ref")
	and not target_2.getTarget().hasName("binder_dec_ref_for_handle")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vref_1127
	and target_2.getArgument(1).(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_2.getArgument(1).(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_1096
	and target_2.getArgument(1).(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
}

predicate func_4(Parameter vproc_1074, ExprStmt target_22) {
exists(AssignExpr target_4 |
	target_4.getLValue().(VariableAccess).getType().hasName("int")
	and target_4.getRValue().(FunctionCall).getTarget().hasName("binder_dec_ref_for_handle")
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vproc_1074
	and target_4.getRValue().(FunctionCall).getArgument(1) instanceof ValueFieldAccess
	and target_4.getRValue().(FunctionCall).getArgument(2) instanceof EqualityOperation
	and target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("binder_ref_data")
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_5(Function func) {
exists(AddressOfExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("binder_ref_data")
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_8(Function func) {
exists(ValueFieldAccess target_8 |
	target_8.getTarget().getName()="debug_id"
	and target_8.getQualifier().(VariableAccess).getType().hasName("binder_ref_data")
	and target_8.getEnclosingFunction() = func)
}

predicate func_9(Function func) {
exists(ValueFieldAccess target_9 |
	target_9.getTarget().getName()="desc"
	and target_9.getQualifier().(VariableAccess).getType().hasName("binder_ref_data")
	and target_9.getEnclosingFunction() = func)
}

predicate func_10(Variable vfp_1126, ValueFieldAccess target_10) {
	target_10.getTarget().getName()="handle"
	and target_10.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1126
}

predicate func_11(Variable vhdr_1096, EqualityOperation target_11) {
	target_11.getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_11.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_1096
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_12(Parameter vproc_1074, VariableAccess target_12) {
	target_12.getTarget()=vproc_1074
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Parameter vproc_1074, Variable vref_1127, AssignExpr target_14) {
	target_14.getLValue().(VariableAccess).getTarget()=vref_1127
	and target_14.getRValue().(FunctionCall).getTarget().hasName("binder_get_ref")
	and target_14.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vproc_1074
	and target_14.getRValue().(FunctionCall).getArgument(1) instanceof ValueFieldAccess
	and target_14.getRValue().(FunctionCall).getArgument(2) instanceof EqualityOperation
}

predicate func_15(Variable vref_1127, BlockStmt target_23, EqualityOperation target_15) {
	target_15.getLeftOperand().(VariableAccess).getTarget()=vref_1127
	and target_15.getRightOperand().(Literal).getValue()="0"
	and target_15.getParent().(IfStmt).getThen()=target_23
}

predicate func_16(Variable vref_1127, PointerFieldAccess target_16) {
	target_16.getTarget().getName()="debug_id"
	and target_16.getQualifier().(VariableAccess).getTarget()=vref_1127
}

predicate func_17(Variable vref_1127, PointerFieldAccess target_17) {
	target_17.getTarget().getName()="desc"
	and target_17.getQualifier().(VariableAccess).getTarget()=vref_1127
}

predicate func_18(Variable vref_1127, PointerFieldAccess target_18) {
	target_18.getTarget().getName()="debug_id"
	and target_18.getQualifier().(PointerFieldAccess).getTarget().getName()="node"
	and target_18.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vref_1127
}

predicate func_19(Function func, ExprStmt target_19) {
	target_19.getExpr() instanceof FunctionCall
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable vhdr_1096, EqualityOperation target_11, PointerFieldAccess target_20) {
	target_20.getTarget().getName()="type"
	and target_20.getQualifier().(VariableAccess).getTarget()=vhdr_1096
	and target_11.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getQualifier().(VariableAccess).getLocation())
}

predicate func_22(Parameter vproc_1074, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("task_close_fd")
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vproc_1074
	and target_22.getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="fd"
	and target_22.getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_22.getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("binder_fd_object *")
}

predicate func_23(Variable vfp_1126, BlockStmt target_23) {
	target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
	and target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="handle"
	and target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_23.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1126
}

from Function func, Parameter vproc_1074, Variable vhdr_1096, Variable vfp_1126, Variable vref_1127, StringLiteral target_0, StringLiteral target_1, FunctionCall target_2, ValueFieldAccess target_10, EqualityOperation target_11, VariableAccess target_12, AssignExpr target_14, EqualityOperation target_15, PointerFieldAccess target_16, PointerFieldAccess target_17, PointerFieldAccess target_18, ExprStmt target_19, PointerFieldAccess target_20, ExprStmt target_22, BlockStmt target_23
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(vhdr_1096, vref_1127, target_2)
and not func_4(vproc_1074, target_22)
and not func_8(func)
and not func_9(func)
and func_10(vfp_1126, target_10)
and func_11(vhdr_1096, target_11)
and func_12(vproc_1074, target_12)
and func_14(vproc_1074, vref_1127, target_14)
and func_15(vref_1127, target_23, target_15)
and func_16(vref_1127, target_16)
and func_17(vref_1127, target_17)
and func_18(vref_1127, target_18)
and func_19(func, target_19)
and func_20(vhdr_1096, target_11, target_20)
and func_22(vproc_1074, target_22)
and func_23(vfp_1126, target_23)
and vproc_1074.getType().hasName("binder_proc *")
and vhdr_1096.getType().hasName("binder_object_header *")
and vfp_1126.getType().hasName("flat_binder_object *")
and vref_1127.getType().hasName("binder_ref *")
and vproc_1074.getFunction() = func
and vhdr_1096.(LocalVariable).getFunction() = func
and vfp_1126.(LocalVariable).getFunction() = func
and vref_1127.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
