/**
 * @name linux-b2d057560b8107c633b39aabe517ff9d93f285e3-__inet_hash_connect
 * @id cpp/linux/b2d057560b8107c633b39aabe517ff9d93f285e3/--inet-hash-connect
 * @description linux-b2d057560b8107c633b39aabe517ff9d93f285e3-net/ipv4/inet_hashtables.c-__inet_hash_connect CVE-2022-1012
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

/*predicate func_1(ExprStmt target_10, Function func) {
exists(DoStmt target_1 |
	target_1.getCondition().(Literal).getValue()="0"
	and target_1.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_1.getLocation().isBefore(target_10.getLocation())
	and target_1.getEnclosingFunction() = func)
}

*/
predicate func_3(Variable vremaining_747, Variable voffset_747, ExprStmt target_13, RelationalOperation target_14, ExprStmt target_15, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignRemExpr).getLValue().(VariableAccess).getTarget()=voffset_747
	and target_3.getExpr().(AssignRemExpr).getRValue().(VariableAccess).getTarget()=vremaining_747
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_13.getLocation())
	and target_3.getExpr().(AssignRemExpr).getRValue().(VariableAccess).getLocation().isBefore(target_14.getGreaterOperand().(VariableAccess).getLocation())
	and target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignRemExpr).getLValue().(VariableAccess).getLocation()))
}

/*predicate func_4(Variable vindex_750, Variable vtable_perturb, StmtExpr target_4) {
	target_4.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtable_perturb
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_750
}

*/
predicate func_5(Parameter vport_offset_737, AddExpr target_5) {
	target_5.getLeftOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_5.getRightOperand().(VariableAccess).getTarget()=vport_offset_737
}

predicate func_6(Variable vremaining_747, VariableAccess target_6) {
	target_6.getTarget()=vremaining_747
}

predicate func_7(Variable vremaining_747, Variable voffset_747, RemExpr target_7) {
	target_7.getLeftOperand() instanceof AddExpr
	and target_7.getRightOperand().(VariableAccess).getTarget()=vremaining_747
	and target_7.getParent().(AssignExpr).getRValue() = target_7
	and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_747
}

predicate func_10(Variable vindex_750, Variable vtable_perturb, ExprStmt target_10) {
	target_10.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtable_perturb
	and target_10.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_750
}

predicate func_13(Variable voffset_747, ExprStmt target_13) {
	target_13.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=voffset_747
	and target_13.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="4294967294"
}

predicate func_14(Variable vremaining_747, RelationalOperation target_14) {
	 (target_14 instanceof GTExpr or target_14 instanceof LTExpr)
	and target_14.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getGreaterOperand().(VariableAccess).getTarget()=vremaining_747
}

predicate func_15(Variable voffset_747, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_747
	and target_15.getExpr().(AssignExpr).getRValue() instanceof RemExpr
}

from Function func, Parameter vport_offset_737, Variable vremaining_747, Variable voffset_747, Variable vindex_750, Variable vtable_perturb, AddExpr target_5, VariableAccess target_6, RemExpr target_7, ExprStmt target_10, ExprStmt target_13, RelationalOperation target_14, ExprStmt target_15
where
not func_3(vremaining_747, voffset_747, target_13, target_14, target_15, func)
and func_5(vport_offset_737, target_5)
and func_6(vremaining_747, target_6)
and func_7(vremaining_747, voffset_747, target_7)
and func_10(vindex_750, vtable_perturb, target_10)
and func_13(voffset_747, target_13)
and func_14(vremaining_747, target_14)
and func_15(voffset_747, target_15)
and vport_offset_737.getType().hasName("u32")
and vremaining_747.getType().hasName("u32")
and voffset_747.getType().hasName("u32")
and vindex_750.getType().hasName("u32")
and vtable_perturb.getType() instanceof ArrayType
and vport_offset_737.getFunction() = func
and vremaining_747.(LocalVariable).getFunction() = func
and voffset_747.(LocalVariable).getFunction() = func
and vindex_750.(LocalVariable).getFunction() = func
and not vtable_perturb.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
