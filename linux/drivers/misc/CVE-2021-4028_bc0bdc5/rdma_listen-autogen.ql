/**
 * @name linux-bc0bdc5afaa740d782fbf936aaeebd65e5c2921d-rdma_listen
 * @id cpp/linux/bc0bdc5afaa740d782fbf936aaeebd65e5c2921d/rdma-listen
 * @description linux-bc0bdc5afaa740d782fbf936aaeebd65e5c2921d-drivers/infiniband/core/cma.c-rdma_listen CVE-2021-4028
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vid_3779) {
exists(AddressOfExpr target_0 |
	target_0.getOperand().(VariableAccess).getType().hasName("sockaddr_in")
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rdma_bind_addr")
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vid_3779
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1) instanceof FunctionCall)
}

predicate func_2(Function func, AssignExpr target_2) {
	target_2.getLValue().(ValueFieldAccess).getTarget().getName()="ss_family"
	and target_2.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="src_addr"
	and target_2.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="addr"
	and target_2.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="route"
	and target_2.getRValue() instanceof Literal
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vid_priv_3781, Variable vret_3783, Parameter vid_3779, NotExpr target_5, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_3783
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rdma_bind_addr")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vid_3779
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("cma_src_addr")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vid_priv_3781
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

/*predicate func_4(Variable vid_priv_3781, Parameter vid_3779, FunctionCall target_4) {
	target_4.getTarget().hasName("cma_src_addr")
	and target_4.getArgument(0).(VariableAccess).getTarget()=vid_priv_3781
	and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rdma_bind_addr")
	and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vid_3779
}

*/
predicate func_5(Variable vid_priv_3781, BlockStmt target_6, NotExpr target_5) {
	target_5.getOperand().(FunctionCall).getTarget().hasName("cma_comp_exch")
	and target_5.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vid_priv_3781
	and target_5.getParent().(IfStmt).getThen()=target_6
}

predicate func_6(Variable vret_3783, BlockStmt target_6) {
	target_6.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_6.getStmt(1) instanceof ExprStmt
	and target_6.getStmt(2).(IfStmt).getCondition().(VariableAccess).getTarget()=vret_3783
	and target_6.getStmt(2).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_3783
	and target_6.getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_6.getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_6.getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_6.getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_6.getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_6.getStmt(3).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
}

from Function func, Variable vid_priv_3781, Variable vret_3783, Parameter vid_3779, AssignExpr target_2, ExprStmt target_3, NotExpr target_5, BlockStmt target_6
where
not func_0(vid_3779)
and func_2(func, target_2)
and func_3(vid_priv_3781, vret_3783, vid_3779, target_5, target_3)
and func_5(vid_priv_3781, target_6, target_5)
and func_6(vret_3783, target_6)
and vid_priv_3781.getType().hasName("rdma_id_private *")
and vret_3783.getType().hasName("int")
and vid_3779.getType().hasName("rdma_cm_id *")
and vid_priv_3781.(LocalVariable).getFunction() = func
and vret_3783.(LocalVariable).getFunction() = func
and vid_3779.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
