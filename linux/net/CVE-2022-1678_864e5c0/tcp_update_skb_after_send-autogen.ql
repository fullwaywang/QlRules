/**
 * @name linux-864e5c090749448e879e86bec06ee396aa2c19c5-tcp_update_skb_after_send
 * @id cpp/linux/864e5c090749448e879e86bec06ee396aa2c19c5/tcp-update-skb-after-send
 * @description linux-864e5c090749448e879e86bec06ee396aa2c19c5-net/ipv4/tcp_output.c-tcp_update_skb_after_send CVE-2022-1678
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsk_988, LogicalAndExpr target_1, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("tcp_internal_pacing")
	and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsk_988
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
}

predicate func_1(Function func, LogicalAndExpr target_1) {
	target_1.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_1.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(ComplementExpr).getValue()="18446744073709551615"
	and target_1.getLeftOperand().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_1.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="data_segs_out"
	and target_1.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tcp_sock *")
	and target_1.getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="10"
	and target_1.getEnclosingFunction() = func
}

from Function func, Parameter vsk_988, ExprStmt target_0, LogicalAndExpr target_1
where
func_0(vsk_988, target_1, target_0)
and func_1(func, target_1)
and vsk_988.getType().hasName("sock *")
and vsk_988.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
