/**
 * @name linux-d02ba2a6110c530a32926af8ad441111774d2893-pppol2tp_release
 * @id cpp/linux/d02ba2a6110c530a32926af8ad441111774d2893/pppol2tp-release
 * @description linux-d02ba2a6110c530a32926af8ad441111774d2893-net/l2tp/l2tp_ppp.c-pppol2tp_release CVE-2022-20567
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vps_476, ExprStmt target_8, FunctionCall target_0) {
		target_0.getTarget().hasName("mutex_lock_nested")
		and not target_0.getTarget().hasName("sock_put")
		and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_lock"
		and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_0.getArgument(1).(Literal).getValue()="0"
		and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_2(Variable vsession_455, BlockStmt target_25, VariableAccess target_2) {
		target_2.getTarget()=vsession_455
		and target_2.getParent().(NEExpr).getAnOperand() instanceof Literal
		and target_2.getParent().(NEExpr).getParent().(IfStmt).getThen()=target_25
}

predicate func_3(Variable vsession_455, BlockStmt target_25, EqualityOperation target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vsession_455
		and target_3.getAnOperand().(Literal).getValue()="0"
		and target_3.getParent().(IfStmt).getThen()=target_25
}

predicate func_4(EqualityOperation target_3, Function func, DeclStmt target_4) {
		target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vsession_455, Variable vps_476, AssignExpr target_5) {
		target_5.getLValue().(VariableAccess).getTarget()=vps_476
		and target_5.getRValue().(FunctionCall).getTarget().hasName("l2tp_session_priv")
		and target_5.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsession_455
}

predicate func_6(EqualityOperation target_3, Function func, ExprStmt target_6) {
		target_6.getExpr() instanceof FunctionCall
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vps_476, ExprStmt target_8, PointerFieldAccess target_7) {
		target_7.getTarget().getName()="sk_lock"
		and target_7.getQualifier().(VariableAccess).getTarget()=vps_476
		and target_7.getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_8(Variable vps_476, EqualityOperation target_3, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="__sk"
		and target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_8.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
		and target_8.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerFieldAccess).getTarget().getName()="sk"
		and target_8.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

/*predicate func_9(Variable v__warned_482, DoStmt target_9) {
		target_9.getCondition() instanceof Literal
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_482
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("lock_is_held")
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_482
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
}

*/
/*predicate func_11(Variable v__warned_482, IfStmt target_11) {
		target_11.getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_482
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("lock_is_held")
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dep_map"
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_482
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
}

*/
/*predicate func_12(Variable v__warned_482, LogicalAndExpr target_27, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_482
		and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

*/
/*predicate func_13(LogicalAndExpr target_27, Function func, ExprStmt target_13) {
		target_13.getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_13.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_13.getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_13.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
		and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
		and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_15(Variable vps_476, ExprStmt target_15) {
		target_15.getExpr().(PointerFieldAccess).getTarget().getName()="sk"
		and target_15.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
}

*/
predicate func_16(EqualityOperation target_3, Function func, DoStmt target_16) {
		target_16.getCondition().(Literal).getValue()="0"
		and target_16.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__write_once_size")
		and target_16.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="__val"
		and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_16.getEnclosingFunction() = func
}

/*predicate func_18(Variable v__u_484, ExprStmt target_18) {
		target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__write_once_size")
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk"
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_484
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="__val"
		and target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_484
}

*/
/*predicate func_20(Variable vps_476, Variable v__u_484, ExprStmt target_20) {
		target_20.getExpr().(FunctionCall).getTarget().hasName("__write_once_size")
		and target_20.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk"
		and target_20.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_20.getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_20.getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_484
		and target_20.getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
}

*/
/*predicate func_21(Variable v__u_484, ExprStmt target_21) {
		target_21.getExpr().(ValueFieldAccess).getTarget().getName()="__val"
		and target_21.getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_484
}

*/
predicate func_22(Variable vps_476, EqualityOperation target_3, ExprStmt target_22) {
		target_22.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
		and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_lock"
		and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_22.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_23(Variable vps_476, EqualityOperation target_3, ExprStmt target_23) {
		target_23.getExpr().(FunctionCall).getTarget().hasName("call_rcu_sched")
		and target_23.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_23.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vps_476
		and target_23.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_25(Variable vsession_455, BlockStmt target_25) {
		target_25.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2tp_session_delete")
		and target_25.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsession_455
		and target_25.getStmt(2).(ExprStmt).getExpr() instanceof AssignExpr
		and target_25.getStmt(3) instanceof ExprStmt
		and target_25.getStmt(4) instanceof ExprStmt
}

predicate func_27(Function func, LogicalAndExpr target_27) {
		target_27.getAnOperand() instanceof LogicalAndExpr
		and target_27.getAnOperand() instanceof NotExpr
		and target_27.getEnclosingFunction() = func
}

from Function func, Variable vsession_455, Variable vps_476, Variable v__warned_482, Variable v__u_484, FunctionCall target_0, VariableAccess target_2, EqualityOperation target_3, DeclStmt target_4, AssignExpr target_5, ExprStmt target_6, PointerFieldAccess target_7, ExprStmt target_8, DoStmt target_16, ExprStmt target_22, ExprStmt target_23, BlockStmt target_25, LogicalAndExpr target_27
where
func_0(vps_476, target_8, target_0)
and func_2(vsession_455, target_25, target_2)
and func_3(vsession_455, target_25, target_3)
and func_4(target_3, func, target_4)
and func_5(vsession_455, vps_476, target_5)
and func_6(target_3, func, target_6)
and func_7(vps_476, target_8, target_7)
and func_8(vps_476, target_3, target_8)
and func_16(target_3, func, target_16)
and func_22(vps_476, target_3, target_22)
and func_23(vps_476, target_3, target_23)
and func_25(vsession_455, target_25)
and func_27(func, target_27)
and vsession_455.getType().hasName("l2tp_session *")
and vps_476.getType().hasName("pppol2tp_session *")
and v__warned_482.getType().hasName("bool")
and v__u_484.getType().hasName("union <unnamed>")
and vsession_455.(LocalVariable).getFunction() = func
and vps_476.(LocalVariable).getFunction() = func
and v__warned_482.(LocalVariable).getFunction() = func
and v__u_484.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
