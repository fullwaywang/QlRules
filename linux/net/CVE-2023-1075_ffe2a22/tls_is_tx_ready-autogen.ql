/**
 * @name linux-ffe2a22562444720b05bdfeb999c03e810d84cbb-tls_is_tx_ready
 * @id cpp/linux/ffe2a22562444720b05bdfeb999c03e810d84cbb/tls-is-tx-ready
 * @description linux-ffe2a22562444720b05bdfeb999c03e810d84cbb-net/tls/tls_sw.c-tls_is_tx_ready CVE-2023-1075
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(ExprStmt target_4, Function func) {
exists(ExprStmt target_2 |
	target_2.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("list_head *")
	and target_2.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getType().hasName("list_head *")
	and target_2.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_2.getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_2.getLocation().isBefore(target_4.getLocation())
	and target_2.getEnclosingFunction() = func)
}

predicate func_4(Variable v__mptr_2430, ExprStmt target_4) {
	target_4.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_2430
	and target_4.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
}

predicate func_5(Parameter vctx_2426, AddressOfExpr target_5) {
	target_5.getOperand().(PointerFieldAccess).getTarget().getName()="tx_list"
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_2426
}

predicate func_6(Function func, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="next"
	and target_6.getQualifier() instanceof AddressOfExpr
	and target_6.getEnclosingFunction() = func
}

from Function func, Parameter vctx_2426, Variable v__mptr_2430, ExprStmt target_4, AddressOfExpr target_5, PointerFieldAccess target_6
where
not func_2(target_4, func)
and func_4(v__mptr_2430, target_4)
and func_5(vctx_2426, target_5)
and func_6(func, target_6)
and vctx_2426.getType().hasName("tls_sw_context_tx *")
and v__mptr_2430.getType().hasName("void *")
and vctx_2426.getFunction() = func
and v__mptr_2430.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
