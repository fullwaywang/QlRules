/**
 * @name linux-5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809-sctp_process_unk_param
 * @id cpp/linux/5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809/sctp-process-unk-param
 * @description linux-5fa782c2f5ef6c2e4f04d3e228412c9b4a4c8809-net/sctp/sm_make_chunk.c-sctp_process_unk_param CVE-2010-1173
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter verrp_1962, Parameter vparam_1960, FunctionCall target_0) {
		target_0.getTarget().hasName("sctp_addto_chunk")
		and not target_0.getTarget().hasName("sctp_addto_chunk_fixed")
		and target_0.getArgument(0).(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=verrp_1962
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="p"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("__fswab16")
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="p"
		and target_0.getArgument(1).(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_0.getArgument(1).(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="-4"
		and target_0.getArgument(2).(ValueFieldAccess).getTarget().getName()="v"
		and target_0.getArgument(2).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vparam_1960
}

predicate func_1(Parameter vchunk_1961, Parameter verrp_1962, Parameter vasoc_1959, FunctionCall target_1) {
		target_1.getTarget().hasName("sctp_make_op_error_space")
		and not target_1.getTarget().hasName("sctp_make_op_error_fixed")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vasoc_1959
		and target_1.getArgument(1).(VariableAccess).getTarget()=vchunk_1961
		and target_1.getArgument(2).(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_1.getArgument(2).(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_1.getArgument(2).(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="chunk_hdr"
		and target_1.getArgument(2).(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_1961
		and target_1.getArgument(2).(ConditionalExpr).getThen() instanceof BitwiseOrExpr
		and target_1.getArgument(2).(ConditionalExpr).getElse() instanceof FunctionCall
		and target_1.getParent().(AssignExpr).getRValue() = target_1
		and target_1.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=verrp_1962
}

/*predicate func_2(Parameter vchunk_1961, FunctionCall target_2) {
		target_2.getTarget().hasName("__builtin_constant_p")
		and not target_2.getTarget().hasName("sctp_init_cause_fixed")
		and target_2.getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="chunk_hdr"
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_1961
}

*/
predicate func_3(Parameter verrp_1962, PointerDereferenceExpr target_3) {
		target_3.getOperand().(VariableAccess).getTarget()=verrp_1962
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Parameter vparam_1960, BitwiseAndExpr target_4) {
		target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="p"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vparam_1960
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="65280"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("__fswab16")
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="p"
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vparam_1960
		and target_4.getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_4.getRightOperand().(ComplementExpr).getValue()="-4"
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Parameter vchunk_1961, PointerFieldAccess target_6) {
		target_6.getTarget().getName()="chunk_hdr"
		and target_6.getQualifier().(VariableAccess).getTarget()=vchunk_1961
}

predicate func_7(Parameter vchunk_1961, BitwiseOrExpr target_7) {
		target_7.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_7.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="chunk_hdr"
		and target_7.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_1961
		and target_7.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
		and target_7.getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_7.getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_7.getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="chunk_hdr"
		and target_7.getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_1961
		and target_7.getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="65280"
		and target_7.getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_7.getParent().(ConditionalExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_8(Parameter vchunk_1961, FunctionCall target_8) {
		target_8.getTarget().hasName("__fswab16")
		and target_8.getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_8.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="chunk_hdr"
		and target_8.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_1961
		and target_8.getParent().(ConditionalExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_9(Function func, FunctionCall target_9) {
		target_9.getTarget().hasName("sctp_init_cause")
		and target_9.getArgument(0) instanceof PointerDereferenceExpr
		and target_9.getArgument(1) instanceof EnumConstantAccess
		and target_9.getArgument(2) instanceof BitwiseAndExpr
		and target_9.getEnclosingFunction() = func
}

from Function func, Parameter vchunk_1961, Parameter verrp_1962, Parameter vparam_1960, Parameter vasoc_1959, FunctionCall target_0, FunctionCall target_1, PointerDereferenceExpr target_3, BitwiseAndExpr target_4, PointerFieldAccess target_6, BitwiseOrExpr target_7, FunctionCall target_8, FunctionCall target_9
where
func_0(verrp_1962, vparam_1960, target_0)
and func_1(vchunk_1961, verrp_1962, vasoc_1959, target_1)
and func_3(verrp_1962, target_3)
and func_4(vparam_1960, target_4)
and func_6(vchunk_1961, target_6)
and func_7(vchunk_1961, target_7)
and func_8(vchunk_1961, target_8)
and func_9(func, target_9)
and vchunk_1961.getType().hasName("sctp_chunk *")
and verrp_1962.getType().hasName("sctp_chunk **")
and vparam_1960.getType().hasName("sctp_params")
and vasoc_1959.getType().hasName("const sctp_association *")
and vchunk_1961.getFunction() = func
and verrp_1962.getFunction() = func
and vparam_1960.getFunction() = func
and vasoc_1959.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
