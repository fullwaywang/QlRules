/**
 * @name v8-3483b970eb1c35f96b2b605cfaf6ca25dc9b6ab9-v8__internal__ValueDeserializer__ReadJSArrayBufferView
 * @id cpp/v8/3483b970eb1c35f96b2b605cfaf6ca25dc9b6ab9/v8internalvaluedeserializerreadjsarraybufferview
 * @description v8-3483b970eb1c35f96b2b605cfaf6ca25dc9b6ab9-src/objects/value-serializer.cc-v8__internal__ValueDeserializer__ReadJSArrayBufferView CVE-2022-3045
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbuffer_2005, FunctionCall target_0) {
	target_0.getTarget().hasName("byte_length")
	and not target_0.getTarget().hasName("GetByteLength")
	and target_0.getQualifier().(FunctionCall).getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vbuffer_2005
}

predicate func_1(Variable vflags_2010, Parameter vbuffer_2005, Variable vdata_view_2028, ExprStmt target_7, ExprStmt target_8, FunctionCall target_9, FunctionCall target_10, ConstructorCall target_11) {
exists(IfStmt target_1 |
	target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ValidateAndSetJSArrayBufferViewFlags")
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getTarget()=vdata_view_2028
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getTarget()=vbuffer_2005
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vflags_2010
	and target_1.getThen().(BlockStmt).getStmt(0).(ReturnStmt).getExpr().(ConstructorCall).getType() instanceof VoidType
	and target_1.getLocation().isBefore(target_7.getLocation())
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_9.getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getLocation())
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getArgument(1).(VariableAccess).getLocation())
	and target_1.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vflags_2010, Parameter vbuffer_2005, Variable vtyped_array_2046, ExprStmt target_8, FunctionCall target_10, ConstructorCall target_12, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ValidateAndSetJSArrayBufferViewFlags")
	and target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getTarget()=vtyped_array_2046
	and target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getTarget()=vbuffer_2005
	and target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vflags_2010
	and target_2.getThen().(BlockStmt).getStmt(0).(ReturnStmt).getExpr().(ConstructorCall).getType() instanceof VoidType
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_8.getLocation())
	and target_10.getArgument(1).(VariableAccess).getLocation().isBefore(target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getLocation())
	and target_2.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(OverloadedPointerDereferenceExpr).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Variable vdata_view_2028, VariableAccess target_3) {
	target_3.getTarget()=vdata_view_2028
}

predicate func_4(Variable vtyped_array_2046, VariableAccess target_4) {
	target_4.getTarget()=vtyped_array_2046
}

predicate func_5(Variable vflags_2010, VariableAccess target_5) {
	target_5.getTarget()=vflags_2010
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Variable vflags_2010, VariableAccess target_6) {
	target_6.getTarget()=vflags_2010
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_7(Variable vflags_2010, Variable vdata_view_2028, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("set_bit_field")
	and target_7.getExpr().(FunctionCall).getQualifier().(FunctionCall).getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vdata_view_2028
	and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vflags_2010
}

predicate func_8(Variable vflags_2010, Variable vtyped_array_2046, Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("set_bit_field")
	and target_8.getExpr().(FunctionCall).getQualifier().(FunctionCall).getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vtyped_array_2046
	and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vflags_2010
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vbuffer_2005, FunctionCall target_9) {
	target_9.getTarget().hasName("NewJSDataView")
	and target_9.getQualifier().(FunctionCall).getTarget().hasName("factory")
	and target_9.getQualifier().(FunctionCall).getQualifier().(PointerFieldAccess).getTarget().getName()="isolate_"
	and target_9.getQualifier().(FunctionCall).getQualifier().(PointerFieldAccess).getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_9.getArgument(0).(VariableAccess).getTarget()=vbuffer_2005
	and target_9.getArgument(1).(VariableAccess).getTarget().getType().hasName("uint32_t")
	and target_9.getArgument(2).(VariableAccess).getTarget().getType().hasName("uint32_t")
}

predicate func_10(Parameter vbuffer_2005, FunctionCall target_10) {
	target_10.getTarget().hasName("NewJSTypedArray")
	and target_10.getQualifier().(FunctionCall).getTarget().hasName("factory")
	and target_10.getQualifier().(FunctionCall).getQualifier().(PointerFieldAccess).getTarget().getName()="isolate_"
	and target_10.getQualifier().(FunctionCall).getQualifier().(PointerFieldAccess).getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_10.getArgument(0).(VariableAccess).getTarget().getType().hasName("ExternalArrayType")
	and target_10.getArgument(1).(VariableAccess).getTarget()=vbuffer_2005
	and target_10.getArgument(2).(VariableAccess).getTarget().getType().hasName("uint32_t")
	and target_10.getArgument(3).(DivExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("uint32_t")
	and target_10.getArgument(3).(DivExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_11(Variable vdata_view_2028, ConstructorCall target_11) {
	target_11.getArgument(0).(VariableAccess).getTarget()=vdata_view_2028
}

predicate func_12(Variable vtyped_array_2046, ConstructorCall target_12) {
	target_12.getArgument(0).(VariableAccess).getTarget()=vtyped_array_2046
}

from Function func, Variable vflags_2010, Parameter vbuffer_2005, Variable vdata_view_2028, Variable vtyped_array_2046, FunctionCall target_0, VariableAccess target_3, VariableAccess target_4, VariableAccess target_5, VariableAccess target_6, ExprStmt target_7, ExprStmt target_8, FunctionCall target_9, FunctionCall target_10, ConstructorCall target_11, ConstructorCall target_12
where
func_0(vbuffer_2005, target_0)
and not func_1(vflags_2010, vbuffer_2005, vdata_view_2028, target_7, target_8, target_9, target_10, target_11)
and not func_2(vflags_2010, vbuffer_2005, vtyped_array_2046, target_8, target_10, target_12, func)
and func_3(vdata_view_2028, target_3)
and func_4(vtyped_array_2046, target_4)
and func_5(vflags_2010, target_5)
and func_6(vflags_2010, target_6)
and func_7(vflags_2010, vdata_view_2028, target_7)
and func_8(vflags_2010, vtyped_array_2046, func, target_8)
and func_9(vbuffer_2005, target_9)
and func_10(vbuffer_2005, target_10)
and func_11(vdata_view_2028, target_11)
and func_12(vtyped_array_2046, target_12)
and vflags_2010.getType().hasName("uint32_t")
and vbuffer_2005.getType().hasName("Handle<JSArrayBuffer>")
and vdata_view_2028.getType().hasName("Handle<JSDataView>")
and vtyped_array_2046.getType().hasName("Handle<JSTypedArray>")
and vflags_2010.(LocalVariable).getFunction() = func
and vbuffer_2005.getFunction() = func
and vdata_view_2028.(LocalVariable).getFunction() = func
and vtyped_array_2046.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
