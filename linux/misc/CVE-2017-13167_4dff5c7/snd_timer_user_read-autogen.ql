/**
 * @name linux-4dff5c7b7093b19c19d3a100f8a3ad87cb7cd9e7-snd_timer_user_read
 * @id cpp/linux/4dff5c7b7093b19c19d3a100f8a3ad87cb7cd9e7/snd-timer-user-read
 * @description linux-4dff5c7b7093b19c19d3a100f8a3ad87cb7cd9e7-sound/core/timer.c-snd_timer_user_read CVE-2017-13167
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable verr_1936, UnaryMinusExpr target_0) {
	target_0.getValue()="-14"
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
}

predicate func_1(Variable verr_1936, UnaryMinusExpr target_1) {
	target_1.getValue()="-14"
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
}

predicate func_2(Parameter vbuffer_1931, Variable vtu_1934, ExprStmt target_19, IfStmt target_2) {
	target_2.getCondition().(PointerFieldAccess).getTarget().getName()="tread"
	and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_1931
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tqueue"
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="32"
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="_error"
	and target_2.getElse() instanceof BlockStmt
	and target_2.getLocation().isBefore(target_19.getLocation())
}

predicate func_3(Variable vtu_1934, IfStmt target_20, ExprStmt target_3) {
	target_3.getExpr().(AssignRemExpr).getLValue().(PointerFieldAccess).getTarget().getName()="qhead"
	and target_3.getExpr().(AssignRemExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_3.getExpr().(AssignRemExpr).getRValue().(PointerFieldAccess).getTarget().getName()="queue_size"
	and target_3.getExpr().(AssignRemExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_20.getLocation().isBefore(target_3.getLocation())
}

predicate func_4(Variable vtu_1934, ExprStmt target_21, ExprStmt target_4) {
	target_4.getExpr().(FunctionCall).getTarget().hasName("spin_lock_irq")
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="qlock"
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_21.getLocation().isBefore(target_4.getLocation())
}

predicate func_5(Variable vtu_1934, ExprStmt target_21, ExprStmt target_5) {
	target_5.getExpr().(PostfixDecrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="qused"
	and target_5.getExpr().(PostfixDecrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_21.getLocation().isBefore(target_5.getLocation())
}

predicate func_6(FunctionCall target_22, Function func) {
exists(GotoStmt target_6 |
	target_6.getName() ="_error"
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_6
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_6.getEnclosingFunction() = func)
}

predicate func_7(ExprStmt target_23, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_7.getExpr().(AssignExpr).getRValue() instanceof PostfixIncrExpr
	and target_7.getLocation().isBefore(target_23.getLocation())
	and target_7.getEnclosingFunction() = func)
}

predicate func_10(Variable verr_1936, LogicalOrExpr target_24, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
	and target_10.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-11"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
}

predicate func_11(Variable verr_1936, PointerFieldAccess target_25, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
	and target_11.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-19"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

predicate func_12(Variable vtu_1934, PostfixIncrExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="qhead"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_12.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tqueue"
	and target_12.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
}

predicate func_13(Variable verr_1936, FunctionCall target_26, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
	and target_13.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
}

predicate func_14(Variable verr_1936, FunctionCall target_27, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1936
	and target_14.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

predicate func_15(LogicalOrExpr target_24, Function func, BreakStmt target_15) {
	target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
	and target_15.getEnclosingFunction() = func
}

predicate func_16(PointerFieldAccess target_25, Function func, BreakStmt target_16) {
	target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
	and target_16.getEnclosingFunction() = func
}

predicate func_17(FunctionCall target_22, Function func, BreakStmt target_17) {
	target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Variable vtu_1934, PostfixIncrExpr target_18) {
	target_18.getOperand().(PointerFieldAccess).getTarget().getName()="qhead"
	and target_18.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_18.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="queue"
	and target_18.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
}

predicate func_19(Function func, ExprStmt target_19) {
	target_19.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("long")
	and target_19.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget().getType().hasName("long")
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable verr_1936, IfStmt target_20) {
	target_20.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_1936
	and target_20.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_20.getThen().(GotoStmt).getName() ="_error"
}

predicate func_21(Parameter vbuffer_1931, ExprStmt target_21) {
	target_21.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vbuffer_1931
	and target_21.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget().getType().hasName("long")
}

predicate func_22(Function func, FunctionCall target_22) {
	target_22.getTarget().hasName("signal_pending")
	and target_22.getArgument(0).(FunctionCall).getTarget().hasName("get_current")
	and target_22.getEnclosingFunction() = func
}

predicate func_23(Variable vtu_1934, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irq")
	and target_23.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="qlock"
	and target_23.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
}

predicate func_24(Function func, LogicalOrExpr target_24) {
	target_24.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="f_flags"
	and target_24.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("file *")
	and target_24.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2048"
	and target_24.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_24.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("long")
	and target_24.getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_24.getEnclosingFunction() = func
}

predicate func_25(Variable vtu_1934, PointerFieldAccess target_25) {
	target_25.getTarget().getName()="disconnected"
	and target_25.getQualifier().(VariableAccess).getTarget()=vtu_1934
}

predicate func_26(Parameter vbuffer_1931, Variable vtu_1934, FunctionCall target_26) {
	target_26.getTarget().hasName("copy_to_user")
	and target_26.getArgument(0).(VariableAccess).getTarget()=vbuffer_1931
	and target_26.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tqueue"
	and target_26.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_26.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr
	and target_26.getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_26.getArgument(2).(SizeofTypeOperator).getValue()="32"
}

predicate func_27(Parameter vbuffer_1931, Variable vtu_1934, FunctionCall target_27) {
	target_27.getTarget().hasName("copy_to_user")
	and target_27.getArgument(0).(VariableAccess).getTarget()=vbuffer_1931
	and target_27.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="queue"
	and target_27.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtu_1934
	and target_27.getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr
	and target_27.getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_27.getArgument(2).(SizeofTypeOperator).getValue()="8"
}

from Function func, Parameter vbuffer_1931, Variable vtu_1934, Variable verr_1936, UnaryMinusExpr target_0, UnaryMinusExpr target_1, IfStmt target_2, ExprStmt target_3, ExprStmt target_4, ExprStmt target_5, ExprStmt target_10, ExprStmt target_11, PostfixIncrExpr target_12, ExprStmt target_13, ExprStmt target_14, BreakStmt target_15, BreakStmt target_16, BreakStmt target_17, PostfixIncrExpr target_18, ExprStmt target_19, IfStmt target_20, ExprStmt target_21, FunctionCall target_22, ExprStmt target_23, LogicalOrExpr target_24, PointerFieldAccess target_25, FunctionCall target_26, FunctionCall target_27
where
func_0(verr_1936, target_0)
and func_1(verr_1936, target_1)
and func_2(vbuffer_1931, vtu_1934, target_19, target_2)
and func_3(vtu_1934, target_20, target_3)
and func_4(vtu_1934, target_21, target_4)
and func_5(vtu_1934, target_21, target_5)
and not func_6(target_22, func)
and not func_7(target_23, func)
and func_10(verr_1936, target_24, target_10)
and func_11(verr_1936, target_25, target_11)
and func_12(vtu_1934, target_12)
and func_13(verr_1936, target_26, target_13)
and func_14(verr_1936, target_27, target_14)
and func_15(target_24, func, target_15)
and func_16(target_25, func, target_16)
and func_17(target_22, func, target_17)
and func_18(vtu_1934, target_18)
and func_19(func, target_19)
and func_20(verr_1936, target_20)
and func_21(vbuffer_1931, target_21)
and func_22(func, target_22)
and func_23(vtu_1934, target_23)
and func_24(func, target_24)
and func_25(vtu_1934, target_25)
and func_26(vbuffer_1931, vtu_1934, target_26)
and func_27(vbuffer_1931, vtu_1934, target_27)
and vbuffer_1931.getType().hasName("char *")
and vtu_1934.getType().hasName("snd_timer_user *")
and verr_1936.getType().hasName("int")
and vbuffer_1931.getFunction() = func
and vtu_1934.(LocalVariable).getFunction() = func
and verr_1936.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
