commit e7d6848ec262b86ecec8c0bfaa2d4e385b037622	e7d6848ec262b86ecec8c0bfaa2d4e385b037622
Author: Eugene Zemtsov <eugene@chromium.org>
Date:   Wed Oct 4 06:29:52 2023 +0000

    media: Remove workaround for libvpx threading resize bug
    
    The bug was fixed in libvpx.
    Also run the same unit test on other encoders.
    
    Bug: 1486441
    Change-Id: I4313c16be2045f0c7844910fddfb34a0fd151018
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4910355
    Commit-Queue: Eugene Zemtsov <eugene@chromium.org>
    Reviewed-by: Dale Curtis <dalecurtis@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1205074}

diff --git a/media/video/software_video_encoder_test.cc b/media/video/software_video_encoder_test.cc
index f4136c2acf5c2..b48d14f029e77 100644
--- a/media/video/software_video_encoder_test.cc
+++ b/media/video/software_video_encoder_test.cc
@@ -344,7 +344,6 @@ class SoftwareVideoEncoderTest
 };
 
 class H264VideoEncoderTest : public SoftwareVideoEncoderTest {};
-class VpxVideoEncoderTest : public SoftwareVideoEncoderTest {};
 class SVCVideoEncoderTest : public SoftwareVideoEncoderTest {};
 
 TEST_P(SoftwareVideoEncoderTest, StopCallbackWrapping) {
@@ -753,7 +752,7 @@ TEST_P(SVCVideoEncoderTest, ChangeLayers) {
   EXPECT_EQ(chunks.size(), total_frames_count);
 }
 
-TEST_P(VpxVideoEncoderTest, ReconfigureWithResize) {
+TEST_P(SoftwareVideoEncoderTest, ReconfigureWithResizingNumberOfThreads) {
   int outputs_count = 0;
   VideoEncoder::Options options;
   options.frame_size = gfx::Size(1024, 1024);
@@ -1155,11 +1154,6 @@ SwVideoTestParams kVpxParams[] = {
     {VideoCodec::kVP8, VP8PROFILE_ANY, PIXEL_FORMAT_I420},
     {VideoCodec::kVP8, VP8PROFILE_ANY, PIXEL_FORMAT_XRGB}};
 
-INSTANTIATE_TEST_SUITE_P(VpxSpecific,
-                         VpxVideoEncoderTest,
-                         ::testing::ValuesIn(kVpxParams),
-                         PrintTestParams);
-
 INSTANTIATE_TEST_SUITE_P(VpxGeneric,
                          SoftwareVideoEncoderTest,
                          ::testing::ValuesIn(kVpxParams),
@@ -1219,7 +1213,6 @@ INSTANTIATE_TEST_SUITE_P(Av1TemporalSvc,
 #endif  // ENABLE_LIBAOM
 
 GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST(H264VideoEncoderTest);
-GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST(VpxVideoEncoderTest);
 GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST(SVCVideoEncoderTest);
 GTEST_ALLOW_UNINSTANTIATED_PARAMETERIZED_TEST(SoftwareVideoEncoderTest);
 
diff --git a/media/video/vpx_video_encoder.cc b/media/video/vpx_video_encoder.cc
index 61034604d84d8..1f311bfc83b32 100644
--- a/media/video/vpx_video_encoder.cc
+++ b/media/video/vpx_video_encoder.cc
@@ -649,10 +649,6 @@ void VpxVideoEncoder::ChangeOptions(const Options& options,
     return;
   }
 
-  // libvpx doesn't support adjusting the number of threads
-  // midway through an encoding session. More details: crbug.com/1486441
-  new_config.g_threads = codec_config_.g_threads;
-
   status = ReallocateVpxImageIfNeeded(&vpx_image_, vpx_image_.fmt,
                                       options.frame_size.width(),
                                       options.frame_size.height());
