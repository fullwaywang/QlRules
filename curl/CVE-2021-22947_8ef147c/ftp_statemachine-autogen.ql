/**
 * @name curl-8ef147c43646e91-ftp_statemachine
 * @id cpp/curl/8ef147c43646e91/ftp-statemachine
 * @description curl-8ef147c43646e91-lib/ftp.c-ftp_statemachine CVE-2021-22947
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpp_2669, PointerFieldAccess target_1, ExprStmt target_2) {
	exists(IfStmt target_0 |
		target_0.getCondition().(PointerFieldAccess).getTarget().getName()="cache_size"
		and target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpp_2669
		and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(PointerFieldAccess target_1) {
		target_1.getTarget().getName()="state"
		and target_1.getQualifier().(VariableAccess).getTarget().getType().hasName("ftp_conn *")
}

predicate func_2(Variable vpp_2669, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("CURLcode")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ftp_readresp")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("Curl_easy *")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("curl_socket_t")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpp_2669
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("size_t")
}

from Function func, Variable vpp_2669, PointerFieldAccess target_1, ExprStmt target_2
where
not func_0(vpp_2669, target_1, target_2)
and func_1(target_1)
and func_2(vpp_2669, target_2)
and vpp_2669.getType().hasName("pingpong *")
and vpp_2669.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
