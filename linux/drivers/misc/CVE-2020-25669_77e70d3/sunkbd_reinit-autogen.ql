/**
 * @name linux-77e70d351db7de07a46ac49b87a6c3c7a60fca7e-sunkbd_reinit
 * @id cpp/linux/77e70d351db7de07a46ac49b87a6c3c7a60fca7e/sunkbd-reinit
 * @description linux-77e70d351db7de07a46ac49b87a6c3c7a60fca7e-drivers/input/keyboard/sunkbd.c-sunkbd_reinit CVE-2020-25669
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsunkbd_209, ExprStmt target_15) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand() instanceof RelationalOperation
	and target_0.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="enabled"
	and target_0.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_0.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_1(Variable vsunkbd_209, ExprStmt target_15) {
exists(PointerFieldAccess target_1 |
	target_1.getTarget().getName()="enabled"
	and target_1.getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_2(Variable vsunkbd_209, PointerFieldAccess target_20) {
exists(LogicalOrExpr target_2 |
	target_2.getLeftOperand() instanceof RelationalOperation
	and target_2.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="enabled"
	and target_2.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_2.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_3(Variable vsunkbd_209, PointerFieldAccess target_20) {
exists(PointerFieldAccess target_3 |
	target_3.getTarget().getName()="enabled"
	and target_3.getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_3.getQualifier().(VariableAccess).getLocation().isBefore(target_20.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_4(Variable vsunkbd_209, ExprStmt target_21, PointerFieldAccess target_22, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="reset"
	and target_4.getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_4.getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand() instanceof Literal
	and target_4.getCondition().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="enabled"
	and target_4.getCondition().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sunkbd_set_leds_beeps")
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsunkbd_209
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_21.getLocation())
	and target_4.getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_22.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_5(Variable vsunkbd_209, PointerFieldAccess target_22) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("sunkbd_set_leds_beeps")
	and target_5.getArgument(0).(VariableAccess).getTarget()=vsunkbd_209
	and target_5.getArgument(0).(VariableAccess).getLocation().isBefore(target_22.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_6(Variable vsunkbd_209, RelationalOperation target_6) {
	 (target_6 instanceof GEExpr or target_6 instanceof LEExpr)
	and target_6.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="reset"
	and target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_6.getLesserOperand() instanceof Literal
}

predicate func_7(Variable vsunkbd_209, RelationalOperation target_7) {
	 (target_7 instanceof GEExpr or target_7 instanceof LEExpr)
	and target_7.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="reset"
	and target_7.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_7.getLesserOperand() instanceof Literal
}

predicate func_8(Variable vsunkbd_209, VariableAccess target_8) {
	target_8.getTarget()=vsunkbd_209
	and target_8.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_9(Variable vsunkbd_209, VariableAccess target_9) {
	target_9.getTarget()=vsunkbd_209
	and target_9.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_10(Variable vsunkbd_209, VariableAccess target_10) {
	target_10.getTarget()=vsunkbd_209
	and target_10.getParent().(PointerFieldAccess).getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_11(Variable vsunkbd_209, VariableAccess target_11) {
	target_11.getTarget()=vsunkbd_209
	and target_11.getParent().(PointerFieldAccess).getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_12(Variable vsunkbd_209, VariableAccess target_12) {
	target_12.getTarget()=vsunkbd_209
	and target_12.getParent().(PointerFieldAccess).getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_14(Variable vsunkbd_209, FunctionCall target_14) {
	target_14.getTarget().hasName("serio_write")
	and target_14.getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_14.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_14.getArgument(1).(Literal).getValue()="14"
}

predicate func_15(Variable vsunkbd_209, Function func, ExprStmt target_15) {
	target_15.getExpr().(FunctionCall).getTarget().hasName("serio_write")
	and target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="3"
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="2"
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="1"
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_bit")
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0) instanceof Literal
	and target_15.getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="led"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

/*predicate func_16(Variable vsunkbd_209, NotExpr target_16) {
	target_16.getOperand().(FunctionCall).getTarget().hasName("test_bit")
	and target_16.getOperand().(FunctionCall).getArgument(0) instanceof Literal
	and target_16.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="led"
	and target_16.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_16.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_16.getParent().(NotExpr).getParent().(BitwiseOrExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("serio_write")
	and target_16.getParent().(NotExpr).getParent().(BitwiseOrExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_16.getParent().(NotExpr).getParent().(BitwiseOrExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
}

*/
predicate func_17(Variable vsunkbd_209, Function func, ExprStmt target_17) {
	target_17.getExpr().(FunctionCall).getTarget().hasName("serio_write")
	and target_17.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_17.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_17.getExpr().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(Literal).getValue()="11"
	and target_17.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_bit")
	and target_17.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_17.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="snd"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

/*predicate func_18(Variable vsunkbd_209, NotExpr target_18) {
	target_18.getOperand().(FunctionCall).getTarget().hasName("test_bit")
	and target_18.getOperand().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_18.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="snd"
	and target_18.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_18.getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_18.getParent().(NotExpr).getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("serio_write")
	and target_18.getParent().(NotExpr).getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_18.getParent().(NotExpr).getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_18.getParent().(NotExpr).getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(Literal).getValue()="11"
}

*/
predicate func_19(Variable vsunkbd_209, Function func, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("serio_write")
	and target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="serio"
	and target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
	and target_19.getExpr().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(Literal).getValue()="3"
	and target_19.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_bit")
	and target_19.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(Literal).getValue()="1"
	and target_19.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="snd"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Variable vsunkbd_209, PointerFieldAccess target_20) {
	target_20.getTarget().getName()="led"
	and target_20.getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_20.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
}

predicate func_21(Function func, ExprStmt target_21) {
	target_21.getExpr() instanceof FunctionCall
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Variable vsunkbd_209, PointerFieldAccess target_22) {
	target_22.getTarget().getName()="led"
	and target_22.getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_22.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsunkbd_209
}

from Function func, Variable vsunkbd_209, RelationalOperation target_6, RelationalOperation target_7, VariableAccess target_8, VariableAccess target_9, VariableAccess target_10, VariableAccess target_11, VariableAccess target_12, FunctionCall target_14, ExprStmt target_15, ExprStmt target_17, ExprStmt target_19, PointerFieldAccess target_20, ExprStmt target_21, PointerFieldAccess target_22
where
not func_0(vsunkbd_209, target_15)
and not func_2(vsunkbd_209, target_20)
and not func_4(vsunkbd_209, target_21, target_22, func)
and func_6(vsunkbd_209, target_6)
and func_7(vsunkbd_209, target_7)
and func_8(vsunkbd_209, target_8)
and func_9(vsunkbd_209, target_9)
and func_10(vsunkbd_209, target_10)
and func_11(vsunkbd_209, target_11)
and func_12(vsunkbd_209, target_12)
and func_14(vsunkbd_209, target_14)
and func_15(vsunkbd_209, func, target_15)
and func_17(vsunkbd_209, func, target_17)
and func_19(vsunkbd_209, func, target_19)
and func_20(vsunkbd_209, target_20)
and func_21(func, target_21)
and func_22(vsunkbd_209, target_22)
and vsunkbd_209.getType().hasName("sunkbd *")
and vsunkbd_209.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
