/**
 * @name linux-83912d6d55be10d65b5268d1871168b9ebe1ec4b-init_smb3_11_server
 * @id cpp/linux/83912d6d55be10d65b5268d1871168b9ebe1ec4b/init-smb3-11-server
 * @description linux-83912d6d55be10d65b5268d1871168b9ebe1ec4b-fs/ksmbd/smb2ops.c-init_smb3_11_server CVE-2021-45100
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vconn_262, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="capabilities"
	and target_0.getQualifier().(PointerFieldAccess).getTarget().getName()="vals"
	and target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_262
}

predicate func_1(Parameter vconn_262, Function func, IfStmt target_1) {
	target_1.getCondition().(PointerFieldAccess).getTarget().getName()="cipher_type"
	and target_1.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_262
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="capabilities"
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vals"
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_262
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="64"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

from Function func, Parameter vconn_262, PointerFieldAccess target_0, IfStmt target_1
where
func_0(vconn_262, target_0)
and func_1(vconn_262, func, target_1)
and vconn_262.getType().hasName("ksmbd_conn *")
and vconn_262.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
