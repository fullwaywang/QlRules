/**
 * @name linux-e0535ce58b92d7baf0b33284a6c4f8f0338f943e-tcf_action_init_1
 * @id cpp/linux/e0535ce58b92d7baf0b33284a6c4f8f0338f943e/tcf-action-init-1
 * @description linux-e0535ce58b92d7baf0b33284a6c4f8f0338f943e-net/sched/act_api.c-tcf_action_init_1 CVE-2017-7979
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="22"
	and not target_0.getValue()="0"
	and target_0.getParent().(UnaryMinusExpr).getParent().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vtb_555, Variable vcklen_608, EqualityOperation target_23) {
exists(IfStmt target_1 |
	target_1.getCondition() instanceof ArrayExpr
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vcklen_608
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="16"
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen() instanceof GotoStmt
	and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("tc_cookie *")
	and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_memdup_cookie")
	and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtb_555
	and target_1.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getType().hasName("tc_cookie *")
	and target_1.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_1.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(1) instanceof GotoStmt
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(6)=target_1
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23)
}

/*predicate func_2(Variable vtb_555, ArrayExpr target_10) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("tc_cookie *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_memdup_cookie")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtb_555
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10)
}

*/
/*predicate func_3(BlockStmt target_25, Function func) {
exists(NotExpr target_3 |
	target_3.getOperand().(VariableAccess).getType().hasName("tc_cookie *")
	and target_3.getParent().(IfStmt).getThen()=target_25
	and target_3.getEnclosingFunction() = func)
}

*/
predicate func_4(Parameter vname_549, Variable vtb_555, BlockStmt target_26, EqualityOperation target_27, ArrayExpr target_28, ArrayExpr target_10) {
exists(LogicalAndExpr target_4 |
	target_4.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vname_549
	and target_4.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_4.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtb_555
	and target_4.getParent().(IfStmt).getThen()=target_26
	and target_27.getLeftOperand().(VariableAccess).getLocation().isBefore(target_4.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation())
	and target_28.getArrayBase().(VariableAccess).getLocation().isBefore(target_4.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
	and target_4.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_10.getArrayBase().(VariableAccess).getLocation()))
}

predicate func_5(Variable va_552, RelationalOperation target_21, ReturnStmt target_29) {
exists(IfStmt target_5 |
	target_5.getCondition().(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_5.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="data"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552
	and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_5
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_5.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_29.getExpr().(VariableAccess).getLocation()))
}

/*predicate func_6(Variable va_552) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("kfree")
	and target_6.getArgument(0).(PointerFieldAccess).getTarget().getName()="data"
	and target_6.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_6.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552)
}

*/
/*predicate func_7(Variable va_552, ReturnStmt target_29) {
exists(FunctionCall target_7 |
	target_7.getTarget().hasName("kfree")
	and target_7.getArgument(0).(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_7.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552
	and target_7.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_29.getExpr().(VariableAccess).getLocation()))
}

*/
predicate func_8(Variable va_552, RelationalOperation target_21) {
exists(AssignExpr target_8 |
	target_8.getLValue().(PointerFieldAccess).getTarget().getName()="act_cookie"
	and target_8.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_552
	and target_8.getRValue().(VariableAccess).getType().hasName("tc_cookie *")
	and target_21.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_8.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Function func) {
exists(IfStmt target_9 |
	target_9.getCondition().(VariableAccess).getType().hasName("tc_cookie *")
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="data"
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("tc_cookie *")
	and target_9.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_9.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("tc_cookie *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_10(Variable vtb_555, BlockStmt target_26, ArrayExpr target_10) {
	target_10.getArrayBase().(VariableAccess).getTarget()=vtb_555
	and target_10.getParent().(IfStmt).getThen()=target_26
}

predicate func_11(Variable verr_557, RelationalOperation target_21, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_557
	and target_11.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-12"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
}

predicate func_12(Variable va_552, VariableAccess target_12) {
	target_12.getTarget()=va_552
	and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_13(Variable va_552, VariableAccess target_13) {
	target_13.getTarget()=va_552
	and target_13.getParent().(FunctionCall).getParent().(LTExpr).getLesserOperand() instanceof FunctionCall
}

predicate func_14(Variable vtb_555, VariableAccess target_14) {
	target_14.getTarget()=vtb_555
	and target_14.getParent().(FunctionCall).getParent().(LTExpr).getLesserOperand() instanceof FunctionCall
}

predicate func_16(Variable va_552, VariableAccess target_16) {
	target_16.getTarget()=va_552
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_17(RelationalOperation target_31, Function func, GotoStmt target_17) {
	target_17.getName() ="err_mod"
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_31
	and target_17.getEnclosingFunction() = func
}

predicate func_18(RelationalOperation target_21, Function func, GotoStmt target_18) {
	target_18.getName() ="err_mod"
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Variable verr_557, RelationalOperation target_32, AssignExpr target_19) {
	target_19.getLValue().(VariableAccess).getTarget()=verr_557
	and target_19.getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_32.getLesserOperand().(VariableAccess).getLocation().isBefore(target_19.getLValue().(VariableAccess).getLocation())
}

predicate func_20(Parameter vbind_550, Variable va_552, ExprStmt target_33, RelationalOperation target_21, FunctionCall target_20) {
	target_20.getTarget().hasName("tcf_hash_release")
	and target_20.getArgument(0).(VariableAccess).getTarget()=va_552
	and target_20.getArgument(1).(VariableAccess).getTarget()=vbind_550
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(5).(VariableAccess).getLocation().isBefore(target_20.getArgument(1).(VariableAccess).getLocation())
	and target_20.getArgument(0).(VariableAccess).getLocation().isBefore(target_21.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_21(Variable va_552, Variable vtb_555, BlockStmt target_25, RelationalOperation target_21) {
	 (target_21 instanceof GTExpr or target_21 instanceof LTExpr)
	and target_21.getLesserOperand().(FunctionCall).getTarget().hasName("nla_memdup_cookie")
	and target_21.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=va_552
	and target_21.getLesserOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vtb_555
	and target_21.getGreaterOperand() instanceof Literal
	and target_21.getParent().(IfStmt).getThen()=target_25
}

predicate func_22(Parameter vbind_550, Variable va_552, ReturnStmt target_29, FunctionCall target_22) {
	target_22.getTarget().hasName("tcf_hash_release")
	and target_22.getArgument(0).(VariableAccess).getTarget()=va_552
	and target_22.getArgument(1).(VariableAccess).getTarget()=vbind_550
	and target_22.getArgument(0).(VariableAccess).getLocation().isBefore(target_29.getExpr().(VariableAccess).getLocation())
}

predicate func_23(Parameter vname_549, BlockStmt target_36, EqualityOperation target_23) {
	target_23.getLeftOperand().(VariableAccess).getTarget()=vname_549
	and target_23.getRightOperand().(Literal).getValue()="0"
	and target_23.getParent().(IfStmt).getThen()=target_36
}

predicate func_25(Function func, BlockStmt target_25) {
	target_25.getStmt(0) instanceof ExprStmt
	and target_25.getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
	and target_25.getStmt(2) instanceof GotoStmt
	and target_25.getEnclosingFunction() = func
}

predicate func_26(Variable vcklen_608, BlockStmt target_26) {
	target_26.getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vcklen_608
	and target_26.getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="16"
	and target_26.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_26.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
	and target_26.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2) instanceof GotoStmt
}

predicate func_27(Parameter vname_549, ExprStmt target_37, EqualityOperation target_27) {
	target_27.getLeftOperand().(VariableAccess).getTarget()=vname_549
	and target_27.getRightOperand().(Literal).getValue()="0"
	and target_27.getParent().(IfStmt).getThen()=target_37
}

predicate func_28(Variable vtb_555, ArrayExpr target_28) {
	target_28.getArrayBase().(VariableAccess).getTarget()=vtb_555
}

predicate func_29(Variable va_552, ReturnStmt target_29) {
	target_29.getExpr().(VariableAccess).getTarget()=va_552
}

predicate func_31(Variable vcklen_608, RelationalOperation target_31) {
	 (target_31 instanceof GTExpr or target_31 instanceof LTExpr)
	and target_31.getGreaterOperand().(VariableAccess).getTarget()=vcklen_608
	and target_31.getLesserOperand().(Literal).getValue()="16"
}

predicate func_32(Variable verr_557, RelationalOperation target_32) {
	 (target_32 instanceof GTExpr or target_32 instanceof LTExpr)
	and target_32.getLesserOperand().(VariableAccess).getTarget()=verr_557
	and target_32.getGreaterOperand().(Literal).getValue()="0"
	and target_32.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_33(Parameter vbind_550, Variable va_552, Variable verr_557, ExprStmt target_33) {
	target_33.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_557
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="init"
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tc_action_ops *")
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net *")
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("nlattr *")
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("nlattr *")
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=va_552
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("int")
	and target_33.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(5).(VariableAccess).getTarget()=vbind_550
}

predicate func_36(Variable vtb_555, Variable verr_557, BlockStmt target_36) {
	target_36.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_557
	and target_36.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_parse_nested")
	and target_36.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtb_555
	and target_36.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("nlattr *")
	and target_36.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
}

predicate func_37(Parameter vbind_550, Variable va_552, Variable vtb_555, Variable verr_557, ExprStmt target_37) {
	target_37.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_557
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="init"
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tc_action_ops *")
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net *")
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtb_555
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("nlattr *")
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=va_552
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("int")
	and target_37.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(5).(VariableAccess).getTarget()=vbind_550
}

from Function func, Parameter vname_549, Parameter vbind_550, Variable va_552, Variable vtb_555, Variable verr_557, Variable vcklen_608, Literal target_0, ArrayExpr target_10, ExprStmt target_11, VariableAccess target_12, VariableAccess target_13, VariableAccess target_14, VariableAccess target_16, GotoStmt target_17, GotoStmt target_18, AssignExpr target_19, FunctionCall target_20, RelationalOperation target_21, FunctionCall target_22, EqualityOperation target_23, BlockStmt target_25, BlockStmt target_26, EqualityOperation target_27, ArrayExpr target_28, ReturnStmt target_29, RelationalOperation target_31, RelationalOperation target_32, ExprStmt target_33, BlockStmt target_36, ExprStmt target_37
where
func_0(func, target_0)
and not func_1(vtb_555, vcklen_608, target_23)
and not func_4(vname_549, vtb_555, target_26, target_27, target_28, target_10)
and not func_5(va_552, target_21, target_29)
and not func_8(va_552, target_21)
and not func_9(func)
and func_10(vtb_555, target_26, target_10)
and func_11(verr_557, target_21, target_11)
and func_12(va_552, target_12)
and func_13(va_552, target_13)
and func_14(vtb_555, target_14)
and func_16(va_552, target_16)
and func_17(target_31, func, target_17)
and func_18(target_21, func, target_18)
and func_19(verr_557, target_32, target_19)
and func_20(vbind_550, va_552, target_33, target_21, target_20)
and func_21(va_552, vtb_555, target_25, target_21)
and func_22(vbind_550, va_552, target_29, target_22)
and func_23(vname_549, target_36, target_23)
and func_25(func, target_25)
and func_26(vcklen_608, target_26)
and func_27(vname_549, target_37, target_27)
and func_28(vtb_555, target_28)
and func_29(va_552, target_29)
and func_31(vcklen_608, target_31)
and func_32(verr_557, target_32)
and func_33(vbind_550, va_552, verr_557, target_33)
and func_36(vtb_555, verr_557, target_36)
and func_37(vbind_550, va_552, vtb_555, verr_557, target_37)
and vname_549.getType().hasName("char *")
and vbind_550.getType().hasName("int")
and va_552.getType().hasName("tc_action *")
and vtb_555.getType().hasName("nlattr *[8]")
and verr_557.getType().hasName("int")
and vcklen_608.getType().hasName("int")
and vname_549.getFunction() = func
and vbind_550.getFunction() = func
and va_552.(LocalVariable).getFunction() = func
and vtb_555.(LocalVariable).getFunction() = func
and verr_557.(LocalVariable).getFunction() = func
and vcklen_608.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
