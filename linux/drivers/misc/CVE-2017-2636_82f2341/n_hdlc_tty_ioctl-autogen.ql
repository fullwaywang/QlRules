/**
 * @name linux-82f2341c94d270421f383641b7cd670e474db56b-n_hdlc_tty_ioctl
 * @id cpp/linux/82f2341c94d270421f383641b7cd670e474db56b/n-hdlc-tty-ioctl
 * @description linux-82f2341c94d270421f383641b7cd670e474db56b-drivers/tty/n_hdlc.c-n_hdlc_tty_ioctl CVE-2017-2636
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="755"
	and not target_0.getValue()="740"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)n_hdlc_tty_ioctl() called %d\n"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(VariableAccess target_15, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("n_hdlc_buf *")
	and target_1.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_15
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
exists(FunctionCall target_2 |
	target_2.getTarget().hasName("__read_once_size")
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="next"
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("list_head *")
	and target_2.getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
	and target_2.getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("union <unnamed>")
	and target_2.getArgument(2).(SizeofExprOperator).getValue()="8"
	and target_2.getEnclosingFunction() = func)
}

predicate func_5(VariableAccess target_15, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("n_hdlc_buf *")
	and target_5.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_5.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_15
	and target_5.getEnclosingFunction() = func)
}

predicate func_7(Variable vcount_750, ValueFieldAccess target_13, ExprStmt target_16, ExprStmt target_17) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vcount_750
	and target_7.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="count"
	and target_7.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("n_hdlc_buf *")
	and target_7.getParent().(IfStmt).getCondition()=target_13
	and target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
	and target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_9(Variable vn_hdlc_748, ExprStmt target_18, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="rx_buf_list"
	and target_9.getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_9.getParent().(ValueFieldAccess).getParent().(IfStmt).getThen()=target_18
}

predicate func_10(Variable vn_hdlc_748, ExprStmt target_19, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="tx_buf_list"
	and target_10.getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_10.getParent().(ValueFieldAccess).getParent().(IfStmt).getThen()=target_19
}

predicate func_11(Variable vn_hdlc_748, ExprStmt target_18, ValueFieldAccess target_11) {
	target_11.getTarget().getName()="head"
	and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="rx_buf_list"
	and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_11.getParent().(IfStmt).getThen()=target_18
}

predicate func_12(Variable vn_hdlc_748, ValueFieldAccess target_11, AddressOfExpr target_20, ValueFieldAccess target_12) {
	target_12.getTarget().getName()="head"
	and target_12.getQualifier().(PointerFieldAccess).getTarget().getName()="rx_buf_list"
	and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_13(Variable vn_hdlc_748, ExprStmt target_19, ValueFieldAccess target_13) {
	target_13.getTarget().getName()="head"
	and target_13.getQualifier().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_13.getParent().(IfStmt).getThen()=target_19
}

predicate func_14(Variable vn_hdlc_748, ValueFieldAccess target_13, AddressOfExpr target_21, ValueFieldAccess target_14) {
	target_14.getTarget().getName()="head"
	and target_14.getQualifier().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_14.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_14.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_21.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_15(Parameter vcmd_746, VariableAccess target_15) {
	target_15.getTarget()=vcmd_746
}

predicate func_16(Variable vcount_750, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vcount_750
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("tty_chars_in_buffer")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("tty_struct *")
}

predicate func_17(Variable vcount_750, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_17.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vcount_750
}

predicate func_18(Variable vcount_750, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vcount_750
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="count"
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier() instanceof ValueFieldAccess
}

predicate func_19(Variable vcount_750, ExprStmt target_19) {
	target_19.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vcount_750
	and target_19.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="count"
	and target_19.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier() instanceof ValueFieldAccess
}

predicate func_20(Variable vn_hdlc_748, AddressOfExpr target_20) {
	target_20.getOperand().(ValueFieldAccess).getTarget().getName()="spinlock"
	and target_20.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rx_buf_list"
	and target_20.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
}

predicate func_21(Variable vn_hdlc_748, AddressOfExpr target_21) {
	target_21.getOperand().(ValueFieldAccess).getTarget().getName()="spinlock"
	and target_21.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_21.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_748
	and target_21.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_21.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
}

from Function func, Parameter vcmd_746, Variable vn_hdlc_748, Variable vcount_750, Literal target_0, PointerFieldAccess target_9, PointerFieldAccess target_10, ValueFieldAccess target_11, ValueFieldAccess target_12, ValueFieldAccess target_13, ValueFieldAccess target_14, VariableAccess target_15, ExprStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19, AddressOfExpr target_20, AddressOfExpr target_21
where
func_0(func, target_0)
and not func_1(target_15, func)
and not func_2(func)
and not func_5(target_15, func)
and not func_7(vcount_750, target_13, target_16, target_17)
and func_9(vn_hdlc_748, target_18, target_9)
and func_10(vn_hdlc_748, target_19, target_10)
and func_11(vn_hdlc_748, target_18, target_11)
and func_12(vn_hdlc_748, target_11, target_20, target_12)
and func_13(vn_hdlc_748, target_19, target_13)
and func_14(vn_hdlc_748, target_13, target_21, target_14)
and func_15(vcmd_746, target_15)
and func_16(vcount_750, target_16)
and func_17(vcount_750, target_17)
and func_18(vcount_750, target_18)
and func_19(vcount_750, target_19)
and func_20(vn_hdlc_748, target_20)
and func_21(vn_hdlc_748, target_21)
and vcmd_746.getType().hasName("unsigned int")
and vn_hdlc_748.getType().hasName("n_hdlc *")
and vcount_750.getType().hasName("int")
and vcmd_746.getFunction() = func
and vn_hdlc_748.(LocalVariable).getFunction() = func
and vcount_750.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
