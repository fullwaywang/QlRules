/**
 * @name openssl-00e2f5eea29994d19293ec4e8c8775ba73678598-siv_cipher
 * @id cpp/openssl/00e2f5eea29994d19293ec4e8c8775ba73678598/siv-cipher
 * @description openssl-00e2f5eea29994d19293ec4e8c8775ba73678598-providers/implementations/ciphers/cipher_aes_siv.c-siv_cipher CVE-2023-2975
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vout_115, BlockStmt target_5, RelationalOperation target_6) {
	exists(EqualityOperation target_0 |
		target_0.getAnOperand().(VariableAccess).getTarget()=vout_115
		and target_0.getAnOperand().(Literal).getValue()="0"
		and target_0.getParent().(IfStmt).getThen()=target_5
		and target_0.getAnOperand().(VariableAccess).getLocation().isBefore(target_6.getLesserOperand().(VariableCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Parameter voutl_115, EqualityOperation target_3, ExprStmt target_4) {
	exists(IfStmt target_1 |
		target_1.getCondition() instanceof EqualityOperation
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=voutl_115
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen() instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="1"
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_1.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation()))
}

/*predicate func_2(Parameter voutl_115, EqualityOperation target_3, ExprStmt target_4) {
	exists(IfStmt target_2 |
		target_2.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=voutl_115
		and target_2.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_2.getThen() instanceof ExprStmt
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_2
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_2.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation()))
}

*/
predicate func_3(Parameter vinl_116, BlockStmt target_5, EqualityOperation target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vinl_116
		and target_3.getAnOperand().(Literal).getValue()="0"
		and target_3.getParent().(IfStmt).getThen()=target_5
}

predicate func_4(Parameter voutl_115, EqualityOperation target_3, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=voutl_115
		and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_5(Function func, BlockStmt target_5) {
		target_5.getStmt(0) instanceof ExprStmt
		and target_5.getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="1"
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vinl_116, Parameter vout_115, RelationalOperation target_6) {
		 (target_6 instanceof GEExpr or target_6 instanceof LEExpr)
		and target_6.getLesserOperand().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="cipher"
		and target_6.getLesserOperand().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="hw"
		and target_6.getLesserOperand().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("PROV_AES_SIV_CTX *")
		and target_6.getLesserOperand().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("PROV_AES_SIV_CTX *")
		and target_6.getLesserOperand().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vout_115
		and target_6.getLesserOperand().(VariableCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("const unsigned char *")
		and target_6.getLesserOperand().(VariableCall).getArgument(3).(VariableAccess).getTarget()=vinl_116
		and target_6.getGreaterOperand().(Literal).getValue()="0"
}

from Function func, Parameter voutl_115, Parameter vinl_116, Parameter vout_115, EqualityOperation target_3, ExprStmt target_4, BlockStmt target_5, RelationalOperation target_6
where
not func_0(vout_115, target_5, target_6)
and not func_1(voutl_115, target_3, target_4)
and func_3(vinl_116, target_5, target_3)
and func_4(voutl_115, target_3, target_4)
and func_5(func, target_5)
and func_6(vinl_116, vout_115, target_6)
and voutl_115.getType().hasName("size_t *")
and vinl_116.getType().hasName("size_t")
and vout_115.getType().hasName("unsigned char *")
and voutl_115.getFunction() = func
and vinl_116.getFunction() = func
and vout_115.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
