/**
 * @name linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-iscsi_conn_start
 * @id cpp/linux/ec29d0ac29be366450a7faffbcf8cba3a6a3b506/iscsi-conn-start
 * @description linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-drivers/scsi/libiscsi.c-iscsi_conn_start CVE-2021-47328
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Variable vconn_3136, ExprStmt target_4, ExprStmt target_5, VariableAccess target_2) {
	target_2.getTarget()=vconn_3136
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getLocation())
	and target_2.getLocation().isBefore(target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_3(Variable vconn_3136, ExprStmt target_5, VariableAccess target_3) {
	target_3.getTarget()=vconn_3136
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__wake_up")
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ehwait"
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3"
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLocation())
}

predicate func_4(Variable vconn_3136, PointerFieldAccess target_6, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="stop_stage"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3136
	and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_4.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

predicate func_5(Variable vconn_3136, PointerFieldAccess target_6, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="stop_stage"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3136
	and target_5.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_5.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

predicate func_6(Variable vconn_3136, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="stop_stage"
	and target_6.getQualifier().(VariableAccess).getTarget()=vconn_3136
}

from Function func, Variable vconn_3136, VariableAccess target_2, VariableAccess target_3, ExprStmt target_4, ExprStmt target_5, PointerFieldAccess target_6
where
func_2(vconn_3136, target_4, target_5, target_2)
and func_3(vconn_3136, target_5, target_3)
and func_4(vconn_3136, target_6, target_4)
and func_5(vconn_3136, target_6, target_5)
and func_6(vconn_3136, target_6)
and vconn_3136.getType().hasName("iscsi_conn *")
and vconn_3136.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
