/**
 * @name linux-b0979a885b9d4df2a25b88e9d444ccaa5f9f495c-st_dwc3_probe
 * @id cpp/linux/b0979a885b9d4df2a25b88e9d444ccaa5f9f495c/st-dwc3-probe
 * @description linux-b0979a885b9d4df2a25b88e9d444ccaa5f9f495c-drivers/usb/dwc3/dwc3-st.c-st_dwc3_probe CVE-2024-46674
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(NotExpr target_9, Function func) {
exists(ReturnStmt target_0 |
	target_0.getExpr() instanceof UnaryMinusExpr
	and target_0.getParent().(IfStmt).getCondition()=target_9
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(FunctionCall target_10, Function func) {
exists(ReturnStmt target_1 |
	exists(BlockStmt obj_0 | obj_0=target_1.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(1)=target_1
			and obj_1.getCondition()=target_10
		)
	)
	and target_1.getExpr() instanceof FunctionCall
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(Variable vret_203, UnaryMinusExpr target_2) {
	exists(AssignExpr obj_0 | obj_0=target_2.getParent() |
		obj_0.getRValue() = target_2
		and obj_0.getLValue().(VariableAccess).getTarget()=vret_203
	)
	and target_2.getValue()="-6"
}

predicate func_3(Variable vdwc3_data_197, Variable vret_203, FunctionCall target_3) {
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getArgument(0) |
		obj_0.getTarget().getName()="rstc_pwrdn"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vdwc3_data_197
	)
	and exists(AssignExpr obj_1 | obj_1=target_3.getParent() |
		obj_1.getRValue() = target_3
		and obj_1.getLValue().(VariableAccess).getTarget()=vret_203
	)
	and target_3.getTarget().hasName("PTR_ERR")
}

predicate func_4(Variable vret_203, NotExpr target_9, ExprStmt target_4) {
	exists(AssignExpr obj_0 | obj_0=target_4.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=vret_203
		and obj_0.getRValue() instanceof UnaryMinusExpr
	)
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_5(NotExpr target_9, Function func, GotoStmt target_5) {
	target_5.getName() ="undo_platform_dev_alloc"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Variable vret_203, FunctionCall target_10, ExprStmt target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=vret_203
		and obj_0.getRValue() instanceof FunctionCall
	)
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

predicate func_7(FunctionCall target_10, Function func, GotoStmt target_7) {
	target_7.getName() ="undo_platform_dev_alloc"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vpdev_195, Function func, ExprStmt target_8) {
	exists(FunctionCall obj_0 | obj_0=target_8.getExpr() |
		obj_0.getTarget().hasName("platform_device_put")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vpdev_195
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Function func, NotExpr target_9) {
	target_9.getOperand().(VariableAccess).getTarget().getType().hasName("resource *")
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Variable vdwc3_data_197, FunctionCall target_10) {
	exists(PointerFieldAccess obj_0 | obj_0=target_10.getArgument(0) |
		obj_0.getTarget().getName()="rstc_pwrdn"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vdwc3_data_197
	)
	and target_10.getTarget().hasName("IS_ERR")
}

from Function func, Parameter vpdev_195, Variable vdwc3_data_197, Variable vret_203, UnaryMinusExpr target_2, FunctionCall target_3, ExprStmt target_4, GotoStmt target_5, ExprStmt target_6, GotoStmt target_7, ExprStmt target_8, NotExpr target_9, FunctionCall target_10
where
not func_0(target_9, func)
and not func_1(target_10, func)
and func_2(vret_203, target_2)
and func_3(vdwc3_data_197, vret_203, target_3)
and func_4(vret_203, target_9, target_4)
and func_5(target_9, func, target_5)
and func_6(vret_203, target_10, target_6)
and func_7(target_10, func, target_7)
and func_8(vpdev_195, func, target_8)
and func_9(func, target_9)
and func_10(vdwc3_data_197, target_10)
and vpdev_195.getType().hasName("platform_device *")
and vdwc3_data_197.getType().hasName("st_dwc3 *")
and vret_203.getType().hasName("int")
and vpdev_195.getFunction() = func
and vdwc3_data_197.(LocalVariable).getFunction() = func
and vret_203.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
