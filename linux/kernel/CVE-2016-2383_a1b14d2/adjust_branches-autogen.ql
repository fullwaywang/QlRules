/**
 * @name linux-a1b14d27ed0965838350f1377ff97c93ee383492-adjust_branches
 * @id cpp/linux/a1b14d27ed0965838350f1377ff97c93ee383492/adjust-branches
 * @description linux-a1b14d27ed0965838350f1377ff97c93ee383492-kernel/bpf/verifier.c-adjust_branches CVE-2016-2383
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpos_2070, Parameter vdelta_2070, ExprStmt target_6) {
exists(AddExpr target_0 |
	target_0.getLeftOperand().(VariableAccess).getTarget()=vpos_2070
	and target_0.getRightOperand().(VariableAccess).getTarget()=vdelta_2070
	and target_6.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vpos_2070, Parameter vdelta_2070, Variable vi_2074, ExprStmt target_7) {
exists(RelationalOperation target_1 |
	 (target_1 instanceof GEExpr or target_1 instanceof LEExpr)
	and target_1.getLesserOperand() instanceof AddExpr
	and target_1.getGreaterOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vpos_2070
	and target_1.getGreaterOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vdelta_2070
	and target_1.getParent().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vi_2074
	and target_1.getParent().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vpos_2070
	and target_1.getParent().(LogicalAndExpr).getRightOperand() instanceof RelationalOperation
	and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_7)
}

predicate func_2(Variable vinsn_2072, Variable vi_2074, AddExpr target_2) {
	target_2.getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vi_2074
	and target_2.getLeftOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="off"
	and target_2.getLeftOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_2072
	and target_2.getRightOperand().(Literal).getValue()="1"
}

predicate func_3(Parameter vpos_2070, VariableAccess target_3) {
	target_3.getTarget()=vpos_2070
}

predicate func_4(Parameter vpos_2070, VariableAccess target_4) {
	target_4.getTarget()=vpos_2070
}

predicate func_5(Parameter vpos_2070, Variable vi_2074, ExprStmt target_7, RelationalOperation target_5) {
	 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
	and target_5.getLesserOperand() instanceof AddExpr
	and target_5.getGreaterOperand().(VariableAccess).getTarget()=vpos_2070
	and target_5.getParent().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vi_2074
	and target_5.getParent().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vpos_2070
	and target_5.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_7
}

predicate func_6(Parameter vdelta_2070, Variable vinsn_2072, ExprStmt target_6) {
	target_6.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="off"
	and target_6.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_2072
	and target_6.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vdelta_2070
}

predicate func_7(Parameter vdelta_2070, Variable vinsn_2072, ExprStmt target_7) {
	target_7.getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getTarget().getName()="off"
	and target_7.getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_2072
	and target_7.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vdelta_2070
}

from Function func, Parameter vpos_2070, Parameter vdelta_2070, Variable vinsn_2072, Variable vi_2074, AddExpr target_2, VariableAccess target_3, VariableAccess target_4, RelationalOperation target_5, ExprStmt target_6, ExprStmt target_7
where
not func_0(vpos_2070, vdelta_2070, target_6)
and not func_1(vpos_2070, vdelta_2070, vi_2074, target_7)
and func_2(vinsn_2072, vi_2074, target_2)
and func_3(vpos_2070, target_3)
and func_4(vpos_2070, target_4)
and func_5(vpos_2070, vi_2074, target_7, target_5)
and func_6(vdelta_2070, vinsn_2072, target_6)
and func_7(vdelta_2070, vinsn_2072, target_7)
and vpos_2070.getType().hasName("int")
and vdelta_2070.getType().hasName("int")
and vinsn_2072.getType().hasName("bpf_insn *")
and vi_2074.getType().hasName("int")
and vpos_2070.getFunction() = func
and vdelta_2070.getFunction() = func
and vinsn_2072.(LocalVariable).getFunction() = func
and vi_2074.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
