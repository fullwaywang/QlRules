/**
 * @name linux-66e3531b33ee51dad17c463b4d9c9f52e341503d-xennet_get_responses
 * @id cpp/linux/66e3531b33ee51dad17c463b4d9c9f52e341503d/xennet-get-responses
 * @description linux-66e3531b33ee51dad17c463b4d9c9f52e341503d-drivers/net/xen-netfront.c-xennet_get_responses CVE-2022-23042
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_0.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="xdp_prog"
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Variable v__UNIQUE_ID_rcu1840_1039, VariableAccess target_1) {
	target_1.getTarget()=v__UNIQUE_ID_rcu1840_1039
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="1839"
	and not target_2.getValue()="1"
	and target_2.getParent().(AsmStmt).getParent().(BlockStmt).getStmt(0) instanceof AsmStmt
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("__builtin_unreachable")
	and not target_3.getTarget().hasName("_dev_alert")
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vqueue_977, ExprStmt target_21, ExprStmt target_22, AddressOfExpr target_23) {
exists(IfStmt target_4 |
	target_4.getCondition().(NotExpr).getOperand() instanceof FunctionCall
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_alert")
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="broken"
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="info"
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_977
	and target_4.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_4.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_alert")
	and target_4.getThen().(BlockStmt).getStmt(3).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_4.getLocation().isBefore(target_21.getLocation())
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_5(DoStmt target_24, Function func) {
exists(LogicalAndExpr target_5 |
	target_5.getValue()="1"
	and target_5.getParent().(IfStmt).getThen()=target_24
	and target_5.getEnclosingFunction() = func)
}

*/
/*predicate func_9(Parameter vqueue_977, ExprStmt target_22, AddressOfExpr target_23) {
exists(ExprStmt target_9 |
	target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="broken"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="info"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_977
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_10(Variable vdev_988, ExprStmt target_25) {
exists(StmtExpr target_10 |
	target_10.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_10.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getValue()="1"
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_alert")
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_988
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Disabled for further use\n"
	and target_25.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

*/
/*predicate func_11(ExprStmt target_26, Function func) {
exists(IfStmt target_11 |
	target_11.getCondition().(LogicalAndExpr).getValue()="1"
	and target_11.getLocation().isBefore(target_26.getLocation())
	and target_11.getEnclosingFunction() = func)
}

*/
/*predicate func_12(Function func) {
exists(ReturnStmt target_12 |
	target_12.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_12.getEnclosingFunction() = func)
}

*/
predicate func_13(Variable vref_987, Variable vret_991, FunctionCall target_13) {
	target_13.getTarget().hasName("gnttab_end_foreign_access_ref")
	and target_13.getArgument(0).(VariableAccess).getTarget()=vref_987
	and target_13.getArgument(1).(Literal).getValue()="0"
	and target_13.getParent().(AssignExpr).getRValue() = target_13
	and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_991
}

predicate func_15(Variable vret_991, AssignExpr target_15) {
	target_15.getLValue().(VariableAccess).getTarget()=vret_991
	and target_15.getRValue() instanceof FunctionCall
}

predicate func_16(Variable vret_991, DoStmt target_24, FunctionCall target_16) {
	target_16.getTarget().hasName("__builtin_expect")
	and target_16.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_991
	and target_16.getArgument(1) instanceof Literal
	and target_16.getParent().(IfStmt).getThen()=target_24
}

/*predicate func_17(Variable vret_991, NotExpr target_17) {
	target_17.getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_991
	and target_17.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_17.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
}

*/
predicate func_18(Function func, AsmStmt target_18) {
	target_18.getChild(0) instanceof Literal
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Function func, DoStmt target_19) {
	target_19.getCondition() instanceof Literal
	and target_19.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_19.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_19.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_19.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_19.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_19.getEnclosingFunction() = func
}

/*predicate func_20(Function func, AsmStmt target_20) {
	target_20.getChild(0) instanceof StringLiteral
	and target_20.getChild(1) instanceof Literal
	and target_20.getChild(2) instanceof Literal
	and target_20.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_20.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_20.getEnclosingFunction() = func
}

*/
predicate func_21(Function func, ExprStmt target_21) {
	target_21.getExpr() instanceof AssignExpr
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Parameter vqueue_977, Variable vref_987, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("xennet_move_rx_slot")
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vqueue_977
	and target_22.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_22.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vref_987
}

predicate func_23(Parameter vqueue_977, AddressOfExpr target_23) {
	target_23.getOperand().(PointerFieldAccess).getTarget().getName()="gref_rx_head"
	and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_977
}

predicate func_24(Function func, DoStmt target_24) {
	target_24.getCondition() instanceof Literal
	and target_24.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0) instanceof AsmStmt
	and target_24.getStmt().(BlockStmt).getStmt(1) instanceof DoStmt
	and target_24.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_24.getEnclosingFunction() = func
}

predicate func_25(Variable vdev_988, ExprStmt target_25) {
	target_25.getExpr().(FunctionCall).getTarget().hasName("_dev_warn")
	and target_25.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_988
	and target_25.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Bad rx response id %d.\n"
	and target_25.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="id"
	and target_25.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xen_netif_rx_response *")
}

predicate func_26(Function func, ExprStmt target_26) {
	target_26.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0) instanceof AsmStmt
	and target_26.getEnclosingFunction() = func
}

from Function func, Parameter vqueue_977, Variable vref_987, Variable vdev_988, Variable vret_991, Variable v__UNIQUE_ID_rcu1840_1039, Initializer target_0, VariableAccess target_1, Literal target_2, FunctionCall target_3, FunctionCall target_13, AssignExpr target_15, FunctionCall target_16, AsmStmt target_18, DoStmt target_19, ExprStmt target_21, ExprStmt target_22, AddressOfExpr target_23, DoStmt target_24, ExprStmt target_25, ExprStmt target_26
where
func_0(func, target_0)
and func_1(v__UNIQUE_ID_rcu1840_1039, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and not func_4(vqueue_977, target_21, target_22, target_23)
and func_13(vref_987, vret_991, target_13)
and func_15(vret_991, target_15)
and func_16(vret_991, target_24, target_16)
and func_18(func, target_18)
and func_19(func, target_19)
and func_21(func, target_21)
and func_22(vqueue_977, vref_987, target_22)
and func_23(vqueue_977, target_23)
and func_24(func, target_24)
and func_25(vdev_988, target_25)
and func_26(func, target_26)
and vqueue_977.getType().hasName("netfront_queue *")
and vref_987.getType().hasName("grant_ref_t")
and vdev_988.getType().hasName("device *")
and vret_991.getType().hasName("unsigned long")
and v__UNIQUE_ID_rcu1840_1039.getType().hasName("bpf_prog *")
and vqueue_977.getFunction() = func
and vref_987.(LocalVariable).getFunction() = func
and vdev_988.(LocalVariable).getFunction() = func
and vret_991.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1840_1039.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
