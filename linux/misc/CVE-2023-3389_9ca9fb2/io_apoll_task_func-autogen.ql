/**
 * @name linux-9ca9fb24d5febccea354089c41f96a8ad0d853f8-io_apoll_task_func
 * @id cpp/linux/9ca9fb24d5febccea354089c41f96a8ad0d853f8/io-apoll-task-func
 * @description linux-9ca9fb24d5febccea354089c41f96a8ad0d853f8-io_uring/poll.c-io_apoll_task_func CVE-2023-3389
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vreq_242, FunctionCall target_0) {
	target_0.getTarget().hasName("io_poll_req_delete")
	and not target_0.getTarget().hasName("io_poll_tw_hash_eject")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vreq_242
	and target_0.getArgument(1).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_0.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_242
}

predicate func_2(Parameter vreq_242, ExprStmt target_3, VariableAccess target_2) {
	target_2.getTarget()=vreq_242
	and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_2.getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_3(Parameter vreq_242, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("io_req_task_submit")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_242
	and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("bool *")
}

from Function func, Parameter vreq_242, FunctionCall target_0, VariableAccess target_2, ExprStmt target_3
where
func_0(vreq_242, target_0)
and func_2(vreq_242, target_3, target_2)
and func_3(vreq_242, target_3)
and vreq_242.getType().hasName("io_kiocb *")
and vreq_242.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
