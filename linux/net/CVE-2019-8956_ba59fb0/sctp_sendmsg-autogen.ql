/**
 * @name linux-ba59fb0273076637f0add4311faa990a5eec27c0-sctp_sendmsg
 * @id cpp/linux/ba59fb0273076637f0add4311faa990a5eec27c0/sctp-sendmsg
 * @description linux-ba59fb0273076637f0add4311faa990a5eec27c0-net/sctp/socket.c-sctp_sendmsg CVE-2019-8956
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vasoc_2030, Variable v__mptr_1_2056, VariableAccess target_0) {
	target_0.getTarget()=vasoc_2030
	and target_0.getParent().(AssignExpr).getLValue() = target_0
	and target_0.getParent().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_0.getParent().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1_2056
}

predicate func_2(Variable v__mptr_1_2056) {
exists(CommaExpr target_2 |
	target_2.getLeftOperand() instanceof AssignExpr
	and target_2.getRightOperand().(AssignExpr).getLValue().(VariableAccess).getType().hasName("sctp_association *")
	and target_2.getRightOperand().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_2.getRightOperand().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1_2056)
}

predicate func_3(Variable vasoc_2030, EqualityOperation target_6) {
exists(CommaExpr target_3 |
	target_3.getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vasoc_2030
	and target_3.getLeftOperand().(AssignExpr).getRValue().(VariableAccess).getType().hasName("sctp_association *")
	and target_3.getRightOperand().(AssignExpr).getLValue().(VariableAccess).getType().hasName("sctp_association *")
	and target_3.getRightOperand().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_3.getRightOperand().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("void *")
	and target_6.getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_4(Variable vasoc_2030, Variable v__mptr_2056, AssignExpr target_4) {
	target_4.getLValue().(VariableAccess).getTarget()=vasoc_2030
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_2056
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="168"
}

predicate func_6(Variable vasoc_2030, EqualityOperation target_6) {
	target_6.getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="asocs"
	and target_6.getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vasoc_2030
	and target_6.getRightOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="asocs"
	and target_6.getRightOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_endpoint *")
}

from Function func, Variable vasoc_2030, Variable v__mptr_2056, Variable v__mptr_1_2056, VariableAccess target_0, AssignExpr target_4, EqualityOperation target_6
where
func_0(vasoc_2030, v__mptr_1_2056, target_0)
and not func_2(v__mptr_1_2056)
and not func_3(vasoc_2030, target_6)
and func_4(vasoc_2030, v__mptr_2056, target_4)
and func_6(vasoc_2030, target_6)
and vasoc_2030.getType().hasName("sctp_association *")
and v__mptr_2056.getType().hasName("void *")
and v__mptr_1_2056.getType().hasName("void *")
and vasoc_2030.(LocalVariable).getFunction() = func
and v__mptr_2056.(LocalVariable).getFunction() = func
and v__mptr_1_2056.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
