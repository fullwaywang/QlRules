/**
 * @name linux-967d3c27127e71a10ff5c083583a038606431b61-subflow_ulp_clone
 * @id cpp/linux/967d3c27127e71a10ff5c083583a038606431b61/subflow-ulp-clone
 * @description linux-967d3c27127e71a10ff5c083583a038606431b61-net/mptcp/subflow.c-subflow_ulp_clone CVE-2024-27404
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(PointerFieldAccess target_4, Function func) {
exists(DoStmt target_0 |
	target_0.getCondition().(Literal).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="remote_id"
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(5)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
	and target_0.getEnclosingFunction() = func)
}

/*predicate func_2(Variable vnew_ctx_1938) {
exists(PointerDereferenceExpr target_2 |
	target_2.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="remote_id"
	and target_2.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_ctx_1938
	and target_2.getParent().(AssignExpr).getLValue() = target_2
	and target_2.getParent().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="remote_id"
	and target_2.getParent().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("mptcp_subflow_request_sock *"))
}

*/
predicate func_3(Variable vnew_ctx_1938, ValueFieldAccess target_3) {
	target_3.getTarget().getName()="remote_id"
	and target_3.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_ctx_1938
}

predicate func_4(Function func, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="mp_join"
	and target_4.getQualifier().(VariableAccess).getTarget().getType().hasName("mptcp_subflow_request_sock *")
	and target_4.getEnclosingFunction() = func
}

from Function func, Variable vnew_ctx_1938, ValueFieldAccess target_3, PointerFieldAccess target_4
where
not func_0(target_4, func)
and func_3(vnew_ctx_1938, target_3)
and func_4(func, target_4)
and vnew_ctx_1938.getType().hasName("mptcp_subflow_context *")
and vnew_ctx_1938.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
