/**
 * @name linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-acct_stack_growth
 * @id cpp/linux/1be7107fbe18eed3e319a6c3e83c78254b693acb/acct-stack-growth
 * @description linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-mm/mmap.c-acct_stack_growth CVE-2017-1000379
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vactual_size_2162, ReturnStmt target_4, VariableAccess target_0) {
		target_0.getTarget()=vactual_size_2162
		and target_0.getParent().(GTExpr).getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(Literal).getValue()="1"
		and target_0.getParent().(GTExpr).getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size")
		and target_0.getParent().(GTExpr).getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size_nocheck")
		and target_0.getParent().(GTExpr).getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="__val"
		and target_0.getParent().(GTExpr).getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("union <unnamed>")
		and target_0.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_4
}

predicate func_2(Variable vactual_size_2162, Parameter vsize_2158, Function func, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vactual_size_2162
		and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsize_2158
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vactual_size_2162, Parameter vsize_2158, Parameter vvma_2158, Function func, IfStmt target_3) {
		target_3.getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vsize_2158
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_2158
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="256"
		and target_3.getThen().(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vactual_size_2162
		and target_3.getThen().(ExprStmt).getExpr().(AssignSubExpr).getRValue().(BinaryBitwiseOperation).getValue()="4096"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(RelationalOperation target_6, Function func, ReturnStmt target_4) {
		target_4.getExpr().(UnaryMinusExpr).getValue()="-12"
		and target_4.getParent().(IfStmt).getCondition()=target_6
		and target_4.getEnclosingFunction() = func
}

predicate func_6(Variable vactual_size_2162, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(VariableAccess).getTarget()=vactual_size_2162
		and target_6.getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(Literal).getValue()="1"
		and target_6.getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size")
		and target_6.getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_6.getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size_nocheck")
		and target_6.getLesserOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
}

from Function func, Variable vactual_size_2162, Parameter vsize_2158, Parameter vvma_2158, VariableAccess target_0, ExprStmt target_2, IfStmt target_3, ReturnStmt target_4, RelationalOperation target_6
where
func_0(vactual_size_2162, target_4, target_0)
and func_2(vactual_size_2162, vsize_2158, func, target_2)
and func_3(vactual_size_2162, vsize_2158, vvma_2158, func, target_3)
and func_4(target_6, func, target_4)
and func_6(vactual_size_2162, target_6)
and vactual_size_2162.getType().hasName("unsigned long")
and vsize_2158.getType().hasName("unsigned long")
and vvma_2158.getType().hasName("vm_area_struct *")
and vactual_size_2162.(LocalVariable).getFunction() = func
and vsize_2158.getFunction() = func
and vvma_2158.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
