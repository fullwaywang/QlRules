/**
 * @name libtiff-38ede78b13810ff0fa8e61f86ef9aa0ab2964668-_TIFFVSetField
 * @id cpp/libtiff/38ede78b13810ff0fa8e61f86ef9aa0ab2964668/-tiffvsetfield
 * @description libtiff-38ede78b13810ff0fa8e61f86ef9aa0ab2964668-libtiff/tif_dir.c-_TIFFVSetField CVE-2018-19210
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vtd_170, SubExpr target_1) {
		target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_1.getRightOperand().(PointerFieldAccess).getTarget().getName()="td_extrasamples"
		and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
}

predicate func_2(Parameter vtif_166, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="tif_clientdata"
		and target_2.getQualifier().(VariableAccess).getTarget()=vtif_166
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_3(Parameter vtif_166, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="td_fieldsset"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="tif_dir"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_166
}

predicate func_4(Variable vtd_170, Variable vv_172, BlockStmt target_11, LogicalAndExpr target_4) {
		target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="td_transferfunction"
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vv_172
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1"
		and target_4.getAnOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand() instanceof SubExpr
		and target_4.getAnOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1"
		and target_4.getParent().(IfStmt).getThen()=target_11
}

predicate func_5(Variable vmodule_168, Parameter vtif_166, LogicalAndExpr target_4, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("TIFFWarningExt")
		and target_5.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tif_clientdata"
		and target_5.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_166
		and target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vmodule_168
		and target_5.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="ExtraSamples tag value is changing, but TransferFunction was read with a different value. Cancelling it"
		and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
}

predicate func_6(LogicalAndExpr target_4, Function func, ExprStmt target_6) {
		target_6.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayBase() instanceof ValueFieldAccess
		and target_6.getExpr().(AssignAndExpr).getLValue().(ArrayExpr).getArrayOffset().(DivExpr).getValue()="1"
		and target_6.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709547519"
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vtd_170, LogicalAndExpr target_4, ExprStmt target_8, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("_TIFFfree")
		and target_7.getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="td_transferfunction"
		and target_7.getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_7.getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
		and target_7.getExpr().(FunctionCall).getArgument(0).(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_8(Variable vtd_170, LogicalAndExpr target_4, ArrayExpr target_12, NotExpr target_13, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="td_transferfunction"
		and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
		and target_8.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
		and target_12.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_9(Parameter vap_166, Variable vtd_170, Variable vv_172, VariableAccess target_14, IfStmt target_9) {
		target_9.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("setExtraSamples")
		and target_9.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtd_170
		and target_9.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vap_166
		and target_9.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vv_172
		and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
}

/*predicate func_10(Parameter vap_166, Variable vtd_170, Variable vv_172, BuiltInVarArg target_15, ExprStmt target_16, ExprStmt target_8, LogicalAndExpr target_4, VariableAccess target_10) {
		target_10.getTarget()=vtd_170
		and target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("setExtraSamples")
		and target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vap_166
		and target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vv_172
		and target_15.getVAList().(VariableAccess).getLocation().isBefore(target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(BuiltInVarArg).getVAList().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getLocation())
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_10.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
}

*/
predicate func_11(Function func, BlockStmt target_11) {
		target_11.getStmt(0) instanceof ExprStmt
		and target_11.getStmt(1) instanceof ExprStmt
		and target_11.getStmt(2) instanceof ExprStmt
		and target_11.getStmt(3) instanceof ExprStmt
		and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vtd_170, ArrayExpr target_12) {
		target_12.getArrayBase().(PointerFieldAccess).getTarget().getName()="td_transferfunction"
		and target_12.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_12.getArrayOffset() instanceof Literal
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_13(Parameter vap_166, Variable vtd_170, Variable vv_172, NotExpr target_13) {
		target_13.getOperand().(FunctionCall).getTarget().hasName("setExtraSamples")
		and target_13.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtd_170
		and target_13.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vap_166
		and target_13.getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vv_172
}

predicate func_14(Variable vstandard_tag_176, VariableAccess target_14) {
		target_14.getTarget()=vstandard_tag_176
}

predicate func_15(Parameter vap_166, BuiltInVarArg target_15) {
		target_15.getVAList().(VariableAccess).getTarget()=vap_166
}

predicate func_16(Parameter vap_166, Variable vtd_170, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="td_extrasamples"
		and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_170
		and target_16.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(BuiltInVarArg).getVAList().(VariableAccess).getTarget()=vap_166
		and target_16.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
}

from Function func, Parameter vap_166, Variable vmodule_168, Variable vtd_170, Variable vv_172, Variable vstandard_tag_176, Parameter vtif_166, SubExpr target_1, PointerFieldAccess target_2, ValueFieldAccess target_3, LogicalAndExpr target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, IfStmt target_9, BlockStmt target_11, ArrayExpr target_12, NotExpr target_13, VariableAccess target_14, BuiltInVarArg target_15, ExprStmt target_16
where
func_1(vtd_170, target_1)
and func_2(vtif_166, target_2)
and func_3(vtif_166, target_3)
and func_4(vtd_170, vv_172, target_11, target_4)
and func_5(vmodule_168, vtif_166, target_4, target_5)
and func_6(target_4, func, target_6)
and func_7(vtd_170, target_4, target_8, target_7)
and func_8(vtd_170, target_4, target_12, target_13, target_8)
and func_9(vap_166, vtd_170, vv_172, target_14, target_9)
and func_11(func, target_11)
and func_12(vtd_170, target_12)
and func_13(vap_166, vtd_170, vv_172, target_13)
and func_14(vstandard_tag_176, target_14)
and func_15(vap_166, target_15)
and func_16(vap_166, vtd_170, target_16)
and vap_166.getType().hasName("va_list")
and vmodule_168.getType().hasName("const char[]")
and vtd_170.getType().hasName("TIFFDirectory *")
and vv_172.getType().hasName("uint32")
and vstandard_tag_176.getType().hasName("uint32")
and vtif_166.getType().hasName("TIFF *")
and vap_166.getFunction() = func
and vmodule_168.(LocalVariable).getFunction() = func
and vtd_170.(LocalVariable).getFunction() = func
and vv_172.(LocalVariable).getFunction() = func
and vstandard_tag_176.(LocalVariable).getFunction() = func
and vtif_166.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
