/**
 * @name linux-51093254bf879bc9ce96590400a87897c7498463-srpt_handle_tsk_mgmt
 * @id cpp/linux/51093254bf879bc9ce96590400a87897c7498463/srpt-handle-tsk-mgmt
 * @description linux-51093254bf879bc9ce96590400a87897c7498463-drivers/infiniband/ulp/srpt/ib_srpt.c-srpt_handle_tsk_mgmt CVE-2016-6327
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsend_ioctx_1742, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="response"
	and target_0.getQualifier().(ValueFieldAccess).getTarget().getName()="se_tmr_req"
	and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_0.getParent().(AssignExpr).getLValue() = target_0
	and target_0.getParent().(AssignExpr).getRValue() instanceof EnumConstantAccess
}

predicate func_1(Variable vsrp_tsk_1744, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="task_tag"
	and target_1.getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_2(Function func, DeclStmt target_2) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vtcm_tmr_1749, Function func, IfStmt target_3) {
	target_3.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vtcm_tmr_1749
	and target_3.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="response"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="se_tmr_req"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_3.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="fail"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

/*predicate func_4(Parameter vsend_ioctx_1742, RelationalOperation target_15, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="response"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="se_tmr_req"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

*/
/*predicate func_5(RelationalOperation target_15, Function func, GotoStmt target_5) {
	target_5.getName() ="fail"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_5.getEnclosingFunction() = func
}

*/
predicate func_6(Variable vsrp_tsk_1744, Variable vtag_1748, Variable vrc_1750, Parameter vsend_ioctx_1742, Function func, IfStmt target_6) {
	target_6.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="tsk_mgmt_func"
	and target_6.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_1750
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("srpt_rx_mgmt_fn_tag")
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="task_tag"
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vrc_1750
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="response"
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="fail"
	and target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtag_1748
	and target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="task_tag"
	and target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

/*predicate func_7(Variable vsrp_tsk_1744, Variable vrc_1750, Parameter vsend_ioctx_1742, EqualityOperation target_16, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_1750
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("srpt_rx_mgmt_fn_tag")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="task_tag"
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

*/
/*predicate func_8(Variable vsrp_tsk_1744, Variable vrc_1750, Parameter vsend_ioctx_1742, FunctionCall target_8) {
	target_8.getTarget().hasName("srpt_rx_mgmt_fn_tag")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_8.getArgument(1).(PointerFieldAccess).getTarget().getName()="task_tag"
	and target_8.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_8.getParent().(AssignExpr).getRValue() = target_8
	and target_8.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_1750
}

*/
/*predicate func_9(Variable vrc_1750, EqualityOperation target_16, IfStmt target_9) {
	target_9.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vrc_1750
	and target_9.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="response"
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="se_tmr_req"
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_9.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="fail"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

*/
/*predicate func_10(Parameter vsend_ioctx_1742, RelationalOperation target_17, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="response"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="se_tmr_req"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_11(RelationalOperation target_17, Function func, GotoStmt target_11) {
	target_11.getName() ="fail"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_12(Variable vsrp_tsk_1744, Variable vtag_1748, EqualityOperation target_16, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtag_1748
	and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="task_tag"
	and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

*/
predicate func_13(Variable vsrp_tsk_1744, Variable vsess_1746, Variable vunpacked_lun_1747, Variable vtag_1748, Variable vtcm_tmr_1749, Variable vrc_1750, Parameter vsend_ioctx_1742, AssignExpr target_13) {
	target_13.getLValue().(VariableAccess).getTarget()=vrc_1750
	and target_13.getRValue().(FunctionCall).getTarget().hasName("target_submit_tmr")
	and target_13.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_13.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_13.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsess_1746
	and target_13.getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_13.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vunpacked_lun_1747
	and target_13.getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_13.getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vtcm_tmr_1749
	and target_13.getRValue().(FunctionCall).getArgument(6).(BitwiseOrExpr).getValue()="37748928"
	and target_13.getRValue().(FunctionCall).getArgument(7).(VariableAccess).getTarget()=vtag_1748
}

/*predicate func_14(Variable vsrp_tsk_1744, Variable vsess_1746, Variable vunpacked_lun_1747, Variable vtag_1748, Variable vtcm_tmr_1749, Parameter vsend_ioctx_1742, VariableAccess target_14) {
	target_14.getTarget()=vtag_1748
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("target_submit_tmr")
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cmd"
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsend_ioctx_1742
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsess_1746
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vunpacked_lun_1747
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vtcm_tmr_1749
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(BitwiseOrExpr).getValue()="37748928"
}

*/
predicate func_15(Variable vtcm_tmr_1749, RelationalOperation target_15) {
	 (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
	and target_15.getLesserOperand().(VariableAccess).getTarget()=vtcm_tmr_1749
	and target_15.getGreaterOperand() instanceof Literal
}

predicate func_16(Variable vsrp_tsk_1744, EqualityOperation target_16) {
	target_16.getLeftOperand().(PointerFieldAccess).getTarget().getName()="tsk_mgmt_func"
	and target_16.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsrp_tsk_1744
	and target_16.getRightOperand() instanceof EnumConstantAccess
}

predicate func_17(Variable vrc_1750, RelationalOperation target_17) {
	 (target_17 instanceof GTExpr or target_17 instanceof LTExpr)
	and target_17.getLesserOperand().(VariableAccess).getTarget()=vrc_1750
	and target_17.getGreaterOperand() instanceof Literal
}

from Function func, Variable vsrp_tsk_1744, Variable vsess_1746, Variable vunpacked_lun_1747, Variable vtag_1748, Variable vtcm_tmr_1749, Variable vrc_1750, Parameter vsend_ioctx_1742, PointerFieldAccess target_0, PointerFieldAccess target_1, DeclStmt target_2, IfStmt target_3, IfStmt target_6, AssignExpr target_13, RelationalOperation target_15, EqualityOperation target_16, RelationalOperation target_17
where
func_0(vsend_ioctx_1742, target_0)
and func_1(vsrp_tsk_1744, target_1)
and func_2(func, target_2)
and func_3(vtcm_tmr_1749, func, target_3)
and func_6(vsrp_tsk_1744, vtag_1748, vrc_1750, vsend_ioctx_1742, func, target_6)
and func_13(vsrp_tsk_1744, vsess_1746, vunpacked_lun_1747, vtag_1748, vtcm_tmr_1749, vrc_1750, vsend_ioctx_1742, target_13)
and func_15(vtcm_tmr_1749, target_15)
and func_16(vsrp_tsk_1744, target_16)
and func_17(vrc_1750, target_17)
and vsrp_tsk_1744.getType().hasName("srp_tsk_mgmt *")
and vsess_1746.getType().hasName("se_session *")
and vunpacked_lun_1747.getType().hasName("uint64_t")
and vtag_1748.getType().hasName("uint32_t")
and vtcm_tmr_1749.getType().hasName("int")
and vrc_1750.getType().hasName("int")
and vsend_ioctx_1742.getType().hasName("srpt_send_ioctx *")
and vsrp_tsk_1744.(LocalVariable).getFunction() = func
and vsess_1746.(LocalVariable).getFunction() = func
and vunpacked_lun_1747.(LocalVariable).getFunction() = func
and vtag_1748.(LocalVariable).getFunction() = func
and vtcm_tmr_1749.(LocalVariable).getFunction() = func
and vrc_1750.(LocalVariable).getFunction() = func
and vsend_ioctx_1742.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
