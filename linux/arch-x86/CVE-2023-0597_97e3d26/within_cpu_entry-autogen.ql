/**
 * @name linux-97e3d26b5e5f371b3ee223d94dd123e6c442ba80-within_cpu_entry
 * @id cpp/linux/97e3d26b5e5f371b3ee223d94dd123e6c442ba80/within-cpu-entry
 * @description linux-97e3d26b5e5f371b3ee223d94dd123e6c442ba80-arch/x86/kernel/hw_breakpoint.c-within_cpu_entry CVE-2023-0597
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BinaryBitwiseOperation target_0) {
	target_0.getValue()="4096"
	and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("within_area")
	and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getValue()="18446741874686296064"
	and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(3) instanceof AddExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(ReturnStmt target_2, Function func, AddExpr target_1) {
	target_1.getValue()="2382368768"
	and target_1.getParent().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_1.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_1.getParent().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getValue()="18446741874686296064"
	and target_1.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_2
	and target_1.getEnclosingFunction() = func
}

predicate func_2(FunctionCall target_3, Function func, ReturnStmt target_2) {
	target_2.getParent().(IfStmt).getCondition()=target_3
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("within_area")
	and target_3.getArgument(0).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_3.getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_3.getArgument(2).(BinaryBitwiseOperation).getValue()="18446741874686296064"
	and target_3.getArgument(3) instanceof AddExpr
	and target_3.getEnclosingFunction() = func
}

from Function func, BinaryBitwiseOperation target_0, AddExpr target_1, ReturnStmt target_2, FunctionCall target_3
where
func_0(func, target_0)
and func_1(target_2, func, target_1)
and func_2(target_3, func, target_2)
and func_3(func, target_3)
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
