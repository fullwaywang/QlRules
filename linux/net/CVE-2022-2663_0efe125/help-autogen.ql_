/**
 * @name linux-0efe125cfb99e6773a7434f3463f7c2fa28f3a43-help
 * @id cpp/linux/0efe125cfb99e6773a7434f3463f7c2fa28f3a43/help
 * @description linux-0efe125cfb99e6773a7434f3463f7c2fa28f3a43-net/netfilter/nf_conntrack_irc.c-help CVE-2022-2663
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtuple_118, Variable vdcc_ip_119, Variable vdcc_port_120, BlockStmt target_3, ExprStmt target_4, LogicalAndExpr target_5, AddressOfExpr target_6, AddressOfExpr target_7, ExprStmt target_8, ExprStmt target_9) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_0.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_0.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_0.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dst"
	and target_0.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="tuple"
	and target_0.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vdcc_port_120
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getParent().(IfStmt).getThen()=target_3
	and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_6.getOperand().(VariableAccess).getLocation().isBefore(target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getLocation())
	and target_0.getLeftOperand().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getLocation().isBefore(target_7.getOperand().(VariableAccess).getLocation())
	and target_8.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation())
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_9.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

/*predicate func_1(Parameter vct_108, Variable vdir_116, ExprStmt target_4, ExprStmt target_10, ExprStmt target_11) {
exists(ValueFieldAccess target_1 |
	target_1.getTarget().getName()="dst"
	and target_1.getQualifier().(ValueFieldAccess).getTarget().getName()="tuple"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tuplehash"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vct_108
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(NotExpr).getOperand().(VariableAccess).getTarget()=vdir_116
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(NotExpr).getOperand().(VariableAccess).getLocation()))
}

*/
predicate func_2(Variable vtuple_118, LogicalAndExpr target_5, AddressOfExpr target_12, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="dst"
	and target_2.getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getQualifier().(VariableAccess).getLocation())
	and target_2.getQualifier().(VariableAccess).getLocation().isBefore(target_12.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_3(Function func, BlockStmt target_3) {
	target_3.getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_3.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("net_ratelimit")
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vct_108, Variable vdir_116, Variable vtuple_118, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtuple_118
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="tuple"
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tuplehash"
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vct_108
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vdir_116
}

predicate func_5(Variable vtuple_118, Variable vdcc_ip_119, LogicalAndExpr target_5) {
	target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_5.getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_5.getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dst"
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_5.getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vdcc_ip_119
}

predicate func_6(Variable vdcc_ip_119, Variable vdcc_port_120, AddressOfExpr target_6) {
	target_6.getOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("_ddebug")
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="nf_conntrack_irc: DCC bound ip/port: %pI4:%u\n"
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdcc_port_120
}

predicate func_7(Variable vtuple_118, Variable vdcc_ip_119, Variable vdcc_port_120, AddressOfExpr target_7) {
	target_7.getOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_printk")
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="4nf_conntrack_irc: Forged DCC command from %pI4: %pI4:%u\n"
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdcc_port_120
}

predicate func_8(Variable vdcc_ip_119, Variable vdcc_port_120, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("_ddebug")
	and target_8.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="nf_conntrack_irc: DCC bound ip/port: %pI4:%u\n"
	and target_8.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_8.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdcc_port_120
}

predicate func_9(Variable vtuple_118, Variable vdcc_ip_119, Variable vdcc_port_120, ExprStmt target_9) {
	target_9.getExpr().(FunctionCall).getTarget().hasName("_printk")
	and target_9.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="4nf_conntrack_irc: Forged DCC command from %pI4: %pI4:%u\n"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
	and target_9.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdcc_ip_119
	and target_9.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdcc_port_120
}

predicate func_10(Parameter vct_108, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("nf_conntrack_expect *")
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nf_ct_expect_alloc")
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vct_108
}

predicate func_11(Parameter vct_108, Variable vdir_116, Variable vtuple_118, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtuple_118
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="tuple"
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="tuplehash"
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vct_108
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(NotExpr).getOperand().(VariableAccess).getTarget()=vdir_116
}

predicate func_12(Variable vtuple_118, AddressOfExpr target_12) {
	target_12.getOperand().(ValueFieldAccess).getTarget().getName()="ip"
	and target_12.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="u3"
	and target_12.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_12.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtuple_118
}

from Function func, Parameter vct_108, Variable vdir_116, Variable vtuple_118, Variable vdcc_ip_119, Variable vdcc_port_120, PointerFieldAccess target_2, BlockStmt target_3, ExprStmt target_4, LogicalAndExpr target_5, AddressOfExpr target_6, AddressOfExpr target_7, ExprStmt target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, AddressOfExpr target_12
where
not func_0(vtuple_118, vdcc_ip_119, vdcc_port_120, target_3, target_4, target_5, target_6, target_7, target_8, target_9)
and func_2(vtuple_118, target_5, target_12, target_2)
and func_3(func, target_3)
and func_4(vct_108, vdir_116, vtuple_118, target_4)
and func_5(vtuple_118, vdcc_ip_119, target_5)
and func_6(vdcc_ip_119, vdcc_port_120, target_6)
and func_7(vtuple_118, vdcc_ip_119, vdcc_port_120, target_7)
and func_8(vdcc_ip_119, vdcc_port_120, target_8)
and func_9(vtuple_118, vdcc_ip_119, vdcc_port_120, target_9)
and func_10(vct_108, target_10)
and func_11(vct_108, vdir_116, vtuple_118, target_11)
and func_12(vtuple_118, target_12)
and vct_108.getType().hasName("nf_conn *")
and vdir_116.getType().hasName("int")
and vtuple_118.getType().hasName("nf_conntrack_tuple *")
and vdcc_ip_119.getType().hasName("__be32")
and vdcc_port_120.getType().hasName("u_int16_t")
and vct_108.getFunction() = func
and vdir_116.(LocalVariable).getFunction() = func
and vtuple_118.(LocalVariable).getFunction() = func
and vdcc_ip_119.(LocalVariable).getFunction() = func
and vdcc_port_120.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
