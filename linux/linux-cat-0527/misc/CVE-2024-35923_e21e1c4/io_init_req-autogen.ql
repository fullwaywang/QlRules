/**
 * @name linux-e21e1c45e1fe2e31732f40256b49c04e76a17cee-io_init_req
 * @id cpp/linux/e21e1c45e1fe2e31732f40256b49c04e76a17cee/io-init-req
 * @description linux-e21e1c45e1fe2e31732f40256b49c04e76a17cee-io_uring/io_uring.c-io_init_req CVE-2024-35923
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vreq_2184, ExprStmt target_18) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("io_init_fail_req")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_0.getArgument(1) instanceof UnaryMinusExpr
	and target_18.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vreq_2184) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("io_init_fail_req")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_1.getArgument(1) instanceof UnaryMinusExpr)
}

predicate func_2(Parameter vreq_2184, ExprStmt target_19) {
exists(FunctionCall target_2 |
	target_2.getTarget().hasName("io_init_fail_req")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_2.getArgument(1) instanceof UnaryMinusExpr
	and target_2.getArgument(0).(VariableAccess).getLocation().isBefore(target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vreq_2184, ExprStmt target_19, ExprStmt target_20) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("io_init_fail_req")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_3.getArgument(1) instanceof UnaryMinusExpr
	and target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getArgument(0).(VariableAccess).getLocation())
	and target_3.getArgument(0).(VariableAccess).getLocation().isBefore(target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Parameter vreq_2184, LogicalAndExpr target_21, ExprStmt target_22) {
exists(FunctionCall target_4 |
	target_4.getTarget().hasName("io_init_fail_req")
	and target_4.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_4.getArgument(1) instanceof UnaryMinusExpr
	and target_21.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_4.getArgument(0).(VariableAccess).getLocation())
	and target_4.getArgument(0).(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vreq_2184, ExprStmt target_23) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("io_init_fail_req")
	and target_5.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_5.getArgument(1) instanceof UnaryMinusExpr
	and target_23.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(Parameter vreq_2184, ExprStmt target_24) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("io_init_fail_req")
	and target_6.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_6.getArgument(1) instanceof UnaryMinusExpr
	and target_6.getArgument(0).(VariableAccess).getLocation().isBefore(target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_7(Parameter vreq_2184, NotExpr target_25, ExprStmt target_26) {
exists(FunctionCall target_7 |
	target_7.getTarget().hasName("io_init_fail_req")
	and target_7.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_7.getArgument(1) instanceof UnaryMinusExpr
	and target_25.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getArgument(0).(VariableAccess).getLocation())
	and target_7.getArgument(0).(VariableAccess).getLocation().isBefore(target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_8(Parameter vreq_2184, Variable vret_2262, ExprStmt target_27, ExprStmt target_28) {
exists(FunctionCall target_8 |
	target_8.getTarget().hasName("io_init_fail_req")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vreq_2184
	and target_8.getArgument(1).(VariableAccess).getTarget()=vret_2262
	and target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getArgument(0).(VariableAccess).getLocation())
	and target_8.getArgument(0).(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Function func, UnaryMinusExpr target_9) {
	target_9.getValue()="-22"
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Function func, UnaryMinusExpr target_10) {
	target_10.getValue()="-22"
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Function func, UnaryMinusExpr target_11) {
	target_11.getValue()="-95"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Function func, UnaryMinusExpr target_12) {
	target_12.getValue()="-95"
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Function func, UnaryMinusExpr target_13) {
	target_13.getValue()="-13"
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Function func, UnaryMinusExpr target_14) {
	target_14.getValue()="-22"
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, UnaryMinusExpr target_15) {
	target_15.getValue()="-22"
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, UnaryMinusExpr target_16) {
	target_16.getValue()="-22"
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vret_2262, VariableAccess target_17) {
	target_17.getTarget()=vret_2262
}

predicate func_18(Parameter vreq_2184, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="opcode"
	and target_18.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
	and target_18.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_19(Parameter vreq_2184, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="buf_index"
	and target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
	and target_19.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
}

predicate func_20(Parameter vreq_2184, ExprStmt target_20) {
	target_20.getExpr().(FunctionCall).getTarget().hasName("io_init_req_drain")
	and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_2184
}

predicate func_21(Parameter vreq_2184, LogicalAndExpr target_21) {
	target_21.getLeftOperand().(ValueFieldAccess).getTarget().getName()="restricted"
	and target_21.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_21.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("io_ring_ctx *")
	and target_21.getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("io_check_restriction")
	and target_21.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("io_ring_ctx *")
	and target_21.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vreq_2184
	and target_21.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_22(Parameter vreq_2184, ExprStmt target_22) {
	target_22.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_22.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
}

predicate func_23(Parameter vreq_2184, ExprStmt target_23) {
	target_23.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_23.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
	and target_23.getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="18"
}

predicate func_24(Parameter vreq_2184, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="fd"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cqe"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
	and target_24.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
}

predicate func_25(Parameter vreq_2184, NotExpr target_25) {
	target_25.getOperand().(PointerFieldAccess).getTarget().getName()="creds"
	and target_25.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
}

predicate func_26(Parameter vreq_2184, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("get_cred")
	and target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="creds"
	and target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
}

predicate func_27(Parameter vreq_2184, ExprStmt target_27) {
	target_27.getExpr().(FunctionCall).getTarget().hasName("put_cred")
	and target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="creds"
	and target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
}

predicate func_28(Parameter vreq_2184, ExprStmt target_28) {
	target_28.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_28.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_2184
}

from Function func, Parameter vreq_2184, Variable vret_2262, UnaryMinusExpr target_9, UnaryMinusExpr target_10, UnaryMinusExpr target_11, UnaryMinusExpr target_12, UnaryMinusExpr target_13, UnaryMinusExpr target_14, UnaryMinusExpr target_15, UnaryMinusExpr target_16, VariableAccess target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_20, LogicalAndExpr target_21, ExprStmt target_22, ExprStmt target_23, ExprStmt target_24, NotExpr target_25, ExprStmt target_26, ExprStmt target_27, ExprStmt target_28
where
not func_0(vreq_2184, target_18)
and not func_1(vreq_2184)
and not func_2(vreq_2184, target_19)
and not func_3(vreq_2184, target_19, target_20)
and not func_4(vreq_2184, target_21, target_22)
and not func_5(vreq_2184, target_23)
and not func_6(vreq_2184, target_24)
and not func_7(vreq_2184, target_25, target_26)
and not func_8(vreq_2184, vret_2262, target_27, target_28)
and func_9(func, target_9)
and func_10(func, target_10)
and func_11(func, target_11)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(func, target_16)
and func_17(vret_2262, target_17)
and func_18(vreq_2184, target_18)
and func_19(vreq_2184, target_19)
and func_20(vreq_2184, target_20)
and func_21(vreq_2184, target_21)
and func_22(vreq_2184, target_22)
and func_23(vreq_2184, target_23)
and func_24(vreq_2184, target_24)
and func_25(vreq_2184, target_25)
and func_26(vreq_2184, target_26)
and func_27(vreq_2184, target_27)
and func_28(vreq_2184, target_28)
and vreq_2184.getType().hasName("io_kiocb *")
and vret_2262.getType().hasName("int")
and vreq_2184.getFunction() = func
and vret_2262.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
