/**
 * @name linux-a8170c35e738d62e9919ce5b109cf4ed66e95bde-sctp_make_init_ack
 * @id cpp/linux/a8170c35e738d62e9919ce5b109cf4ed66e95bde/sctp-make-init-ack
 * @description linux-a8170c35e738d62e9919ce5b109cf4ed66e95bde-net/sctp/sm_make_chunk.c-sctp_make_init_ack CVE-2011-1573
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(BitwiseAndExpr target_0 |
		target_0.getLeftOperand().(AddExpr).getAnOperand() instanceof ConditionalExpr
		and target_0.getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_0.getRightOperand().(ComplementExpr).getValue()="-4"
		and target_0.getParent().(AssignAddExpr).getRValue() = target_0
		and target_0.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Function func) {
	exists(BitwiseAndExpr target_1 |
		target_1.getLeftOperand().(AddExpr).getAnOperand() instanceof ConditionalExpr
		and target_1.getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_1.getRightOperand().(ComplementExpr).getValue()="-4"
		and target_1.getParent().(AssignAddExpr).getRValue() = target_1
		and target_1.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
	exists(BitwiseAndExpr target_2 |
		target_2.getLeftOperand().(AddExpr).getAnOperand() instanceof AddExpr
		and target_2.getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_2.getRightOperand().(ComplementExpr).getValue()="18446744073709551612"
		and target_2.getParent().(AssignAddExpr).getRValue() = target_2
		and target_2.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vauth_hmacs_350, ConditionalExpr target_3) {
		target_3.getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_3.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_3.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_hmacs_350
		and target_3.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_3.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_hmacs_350
		and target_3.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
		and target_3.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_3.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_3.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_hmacs_350
		and target_3.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="65280"
		and target_3.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_3.getElse().(FunctionCall).getTarget().hasName("__fswab16")
		and target_3.getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_3.getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_hmacs_350
		and target_3.getParent().(AssignAddExpr).getRValue() = target_3
		and target_3.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
}

predicate func_4(Variable vauth_chunks_349, ConditionalExpr target_4) {
		target_4.getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_4.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_chunks_349
		and target_4.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_chunks_349
		and target_4.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
		and target_4.getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_4.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_chunks_349
		and target_4.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="65280"
		and target_4.getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
		and target_4.getElse().(FunctionCall).getTarget().hasName("__fswab16")
		and target_4.getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="length"
		and target_4.getElse().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vauth_chunks_349
		and target_4.getParent().(AssignAddExpr).getRValue() = target_4
		and target_4.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
}

predicate func_5(Variable vnum_ext_347, AddExpr target_5) {
		target_5.getAnOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_5.getAnOperand().(SizeofTypeOperator).getValue()="4"
		and target_5.getAnOperand().(VariableAccess).getTarget()=vnum_ext_347
		and target_5.getParent().(AssignAddExpr).getRValue() = target_5
		and target_5.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
}

from Function func, Variable vnum_ext_347, Variable vauth_chunks_349, Variable vauth_hmacs_350, ConditionalExpr target_3, ConditionalExpr target_4, AddExpr target_5
where
not func_0(func)
and not func_1(func)
and not func_2(func)
and func_3(vauth_hmacs_350, target_3)
and func_4(vauth_chunks_349, target_4)
and func_5(vnum_ext_347, target_5)
and vnum_ext_347.getType().hasName("int")
and vauth_chunks_349.getType().hasName("sctp_paramhdr_t *")
and vauth_hmacs_350.getType().hasName("sctp_paramhdr_t *")
and vnum_ext_347.(LocalVariable).getFunction() = func
and vauth_chunks_349.(LocalVariable).getFunction() = func
and vauth_hmacs_350.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
