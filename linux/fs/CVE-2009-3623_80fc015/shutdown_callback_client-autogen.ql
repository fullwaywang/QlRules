/**
 * @name linux-80fc015bdfe1f5b870c1e1ee02d78e709523fee7-shutdown_callback_client
 * @id cpp/linux/80fc015bdfe1f5b870c1e1ee02d78e709523fee7/shutdown-callback-client
 * @description linux-80fc015bdfe1f5b870c1e1ee02d78e709523fee7-fs/nfsd/nfs4state.c-shutdown_callback_client CVE-2009-3623
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vclp_687, Function func, IfStmt target_0) {
		target_0.getCondition().(ValueFieldAccess).getTarget().getName()="cb_cred"
		and target_0.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_0.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_rpccred")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="cb_cred"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="cb_cred"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

/*predicate func_1(Parameter vclp_687, ValueFieldAccess target_3, ExprStmt target_1) {
		target_1.getExpr().(FunctionCall).getTarget().hasName("put_rpccred")
		and target_1.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="cb_cred"
		and target_1.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_1.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
/*predicate func_2(Parameter vclp_687, ValueFieldAccess target_3, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="cb_cred"
		and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
		and target_2.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
predicate func_3(Parameter vclp_687, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="cb_cred"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="cl_cb_conn"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclp_687
}

from Function func, Parameter vclp_687, IfStmt target_0, ValueFieldAccess target_3
where
func_0(vclp_687, func, target_0)
and func_3(vclp_687, target_3)
and vclp_687.getType().hasName("nfs4_client *")
and vclp_687.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
