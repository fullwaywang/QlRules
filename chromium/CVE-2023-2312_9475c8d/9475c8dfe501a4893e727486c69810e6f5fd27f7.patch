commit 9475c8dfe501a4893e727486c69810e6f5fd27f7	9475c8dfe501a4893e727486c69810e6f5fd27f7
Author: Tarun Bansal <tbansal@google.com>
Date:   Fri Jul 28 17:52:17 2023 +0000

    [Offline] Pass WebContentsGetter instead of WebContents
    
    OfflinePageUtils::ScheduleDownload passes a WebContents
    raw pointer to a callback, with no guarantee it is valid
    when the callback runs. This CL changes the logic to pass a
    WebContentsGetter instead of WebContents.
    
    Bug: 1448548
    Change-Id: Ibaefdae8eae61139dcb6eae8365e9d3ce1c32f9c
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4709689
    Reviewed-by: Daniel Cheng <dcheng@chromium.org>
    Commit-Queue: Tarun Bansal <tbansal@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1176718}

diff --git a/chrome/browser/offline_pages/offline_page_utils.cc b/chrome/browser/offline_pages/offline_page_utils.cc
index 4d2193cd78c44..f777a3718d485 100644
--- a/chrome/browser/offline_pages/offline_page_utils.cc
+++ b/chrome/browser/offline_pages/offline_page_utils.cc
@@ -139,7 +139,7 @@ content::WebContents::Getter GetWebContentsGetter(
 }
 
 void AcquireFileAccessPermissionDoneForScheduleDownload(
-    content::WebContents* web_contents,
+    const content::WebContents::Getter& wc_getter,
     const std::string& name_space,
     const GURL& url,
     OfflinePageUtils::DownloadUIActionFlags ui_action,
@@ -147,6 +147,11 @@ void AcquireFileAccessPermissionDoneForScheduleDownload(
     bool granted) {
   if (!granted)
     return;
+  content::WebContents* web_contents = wc_getter.Run();
+  if (!web_contents) {
+    return;
+  }
+
   OfflinePageTabHelper* tab_helper =
       OfflinePageTabHelper::FromWebContents(web_contents);
   if (!tab_helper)
@@ -296,7 +301,8 @@ void OfflinePageUtils::ScheduleDownload(content::WebContents* web_contents,
   AcquireFileAccessPermission(
       web_contents,
       base::BindOnce(&AcquireFileAccessPermissionDoneForScheduleDownload,
-                     web_contents, name_space, url, ui_action, request_origin));
+                     GetWebContentsGetter(web_contents), name_space, url,
+                     ui_action, request_origin));
 }
 
 // static
