/**
 * @name linux-129a72a0d3c8e139a04512325384fe5ac119e74d-emulate_store_desc_ptr
 * @id cpp/linux/129a72a0d3c8e139a04512325384fe5ac119e74d/emulate-store-desc-ptr
 * @description linux-129a72a0d3c8e139a04512325384fe5ac119e74d-arch/x86/kvm/emulate.c-emulate_store_desc_ptr CVE-2017-2584
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdesc_ptr_3677, Parameter vctxt_3673, FunctionCall target_0) {
	target_0.getTarget().hasName("segmented_write")
	and not target_0.getTarget().hasName("segmented_write_std")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vctxt_3673
	and target_0.getArgument(1).(ValueFieldAccess).getTarget().getName()="mem"
	and target_0.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="addr"
	and target_0.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dst"
	and target_0.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_3673
	and target_0.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdesc_ptr_3677
	and target_0.getArgument(3).(AddExpr).getLeftOperand().(Literal).getValue()="2"
	and target_0.getArgument(3).(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="op_bytes"
	and target_0.getArgument(3).(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_3673
}

from Function func, Variable vdesc_ptr_3677, Parameter vctxt_3673, FunctionCall target_0
where
func_0(vdesc_ptr_3677, vctxt_3673, target_0)
and vdesc_ptr_3677.getType().hasName("desc_ptr")
and vctxt_3673.getType().hasName("x86_emulate_ctxt *")
and vdesc_ptr_3677.(LocalVariable).getFunction() = func
and vctxt_3673.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
