/**
 * @name linux-3f190e3aec212fc8c61e202c51400afa7384d4bc-cxusb_ctrl_msg
 * @id cpp/linux/3f190e3aec212fc8c61e202c51400afa7384d4bc/cxusb-ctrl-msg
 * @description linux-3f190e3aec212fc8c61e202c51400afa7384d4bc-drivers/media/usb/dvb-usb/cxusb.c-cxusb_ctrl_msg CVE-2017-8063
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="0"
	and not target_0.getValue()="80"
	and target_0.getParent().(EQExpr).getParent().(LogicalOrExpr).getLeftOperand() instanceof EqualityOperation
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vwo_62, ExprStmt target_26, VariableAccess target_1) {
	target_1.getTarget()=vwo_62
	and target_1.getParent().(IfStmt).getThen()=target_26
}

predicate func_2(Variable vst_61, Variable vret_62, Parameter vd_58, FunctionCall target_2) {
	target_2.getTarget().hasName("dvb_usb_generic_write")
	and not target_2.getTarget().hasName("printk")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_2.getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_2.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_2.getArgument(2) instanceof AddExpr
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_62
}

predicate func_3(Function func, Literal target_3) {
	target_3.getValue()="1"
	and not target_3.getValue()="95"
	and target_3.getParent().(AddExpr).getParent().(FunctionCall).getArgument(2) instanceof AddExpr
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vwlen_59, Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Parameter vd_58, AddExpr target_10, ExprStmt target_26, AddressOfExpr target_27, VariableAccess target_4) {
	target_4.getTarget()=vwlen_59
	and vwlen_59.getIndex() = 3
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2) instanceof AddExpr
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrbuf_59
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrlen_59
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5) instanceof Literal
	and target_10.getRightOperand().(VariableAccess).getLocation().isBefore(target_4.getLocation())
	and target_4.getParent().(AddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_5(Parameter vrlen_59, ExprStmt target_28, Function func) {
exists(IfStmt target_5 |
	target_5.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vrlen_59
	and target_5.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="80"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="4cxusb: i2c rd: len=%d is too big!\n\n"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("int")
	and target_5.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-95"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_28.getLocation()))
}

predicate func_7(Parameter vrbuf_59, Parameter vrlen_59, ExprStmt target_26, ExprStmt target_28) {
exists(LogicalAndExpr target_7 |
	target_7.getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_7.getLeftOperand().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget()=vrbuf_59
	and target_7.getRightOperand().(VariableAccess).getTarget()=vrlen_59
	and target_7.getParent().(IfStmt).getThen()=target_26)
}

predicate func_8(Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, AddressOfExpr target_31, ExprStmt target_26) {
exists(FunctionCall target_8 |
	target_8.getTarget().hasName("__memcpy")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vrbuf_59
	and target_8.getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_8.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_8.getArgument(2).(VariableAccess).getTarget()=vrlen_59
	and target_31.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Variable vst_61, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="data"
	and target_9.getQualifier().(VariableAccess).getTarget()=vst_61
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_10(Parameter vwlen_59, AddExpr target_10) {
	target_10.getLeftOperand().(Literal).getValue()="1"
	and target_10.getRightOperand().(VariableAccess).getTarget()=vwlen_59
	and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_11(Parameter vrlen_59, VariableAccess target_11) {
	target_11.getTarget()=vrlen_59
}

predicate func_13(Variable vret_62, VariableAccess target_13) {
	target_13.getTarget()=vret_62
	and target_13.getParent().(AssignExpr).getLValue() = target_13
	and target_13.getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Parameter vd_58, VariableAccess target_14) {
	target_14.getTarget()=vd_58
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_15(Parameter vrbuf_59, VariableAccess target_15) {
	target_15.getTarget()=vrbuf_59
}

predicate func_16(Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Parameter vd_58, VariableAccess target_16) {
	target_16.getTarget()=vrbuf_59
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2) instanceof AddExpr
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrlen_59
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5) instanceof Literal
}

/*predicate func_17(Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Parameter vd_58, VariableAccess target_17) {
	target_17.getTarget()=vrlen_59
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2) instanceof AddExpr
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrbuf_59
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5) instanceof Literal
}

*/
predicate func_19(Parameter vrbuf_59, Parameter vrlen_59, Variable vwo_62, VariableAccess target_19) {
	target_19.getTarget()=vwo_62
	and target_19.getParent().(AssignExpr).getLValue() = target_19
	and target_19.getParent().(AssignExpr).getRValue().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vrbuf_59
	and target_19.getParent().(AssignExpr).getRValue().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_19.getParent().(AssignExpr).getRValue().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vrlen_59
	and target_19.getParent().(AssignExpr).getRValue().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof Literal
}

/*predicate func_20(Parameter vrbuf_59, Parameter vrlen_59, Variable vwo_62, LogicalOrExpr target_20) {
	target_20.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vrbuf_59
	and target_20.getLeftOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_20.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vrlen_59
	and target_20.getRightOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_20.getParent().(AssignExpr).getRValue() = target_20
	and target_20.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwo_62
}

*/
predicate func_21(Variable vret_62, AssignExpr target_21) {
	target_21.getLValue().(VariableAccess).getTarget()=vret_62
	and target_21.getRValue() instanceof FunctionCall
}

predicate func_22(Parameter vwlen_59, Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Variable vret_62, Parameter vd_58, AssignExpr target_22) {
	target_22.getLValue().(VariableAccess).getTarget()=vret_62
	and target_22.getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_22.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_22.getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_22.getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_22.getRValue().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand() instanceof Literal
	and target_22.getRValue().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(VariableAccess).getTarget()=vwlen_59
	and target_22.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrbuf_59
	and target_22.getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrlen_59
	and target_22.getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="0"
}

/*predicate func_23(Parameter vwlen_59, Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Parameter vd_58, AddExpr target_10, ExprStmt target_26, AddressOfExpr target_27, VariableAccess target_23) {
	target_23.getTarget()=vd_58
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand() instanceof Literal
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(VariableAccess).getTarget()=vwlen_59
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrbuf_59
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrlen_59
	and target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="0"
	and target_10.getRightOperand().(VariableAccess).getLocation().isBefore(target_23.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(VariableAccess).getLocation())
	and target_23.getLocation().isBefore(target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_24(Parameter vwlen_59, Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Parameter vd_58, AddExpr target_10, ExprStmt target_26, AddressOfExpr target_27, AddExpr target_24) {
	target_24.getLeftOperand() instanceof Literal
	and target_24.getRightOperand().(VariableAccess).getTarget()=vwlen_59
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dvb_usb_generic_rw")
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vd_58
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="data"
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrbuf_59
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrlen_59
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="0"
	and target_10.getRightOperand().(VariableAccess).getLocation().isBefore(target_24.getRightOperand().(VariableAccess).getLocation())
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_26(Function func, ExprStmt target_26) {
	target_26.getExpr() instanceof AssignExpr
	and target_26.getEnclosingFunction() = func
}

predicate func_27(Parameter vd_58, AddressOfExpr target_27) {
	target_27.getOperand().(PointerFieldAccess).getTarget().getName()="data_mutex"
	and target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_58
	and target_27.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
}

predicate func_28(Variable vwo_62, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwo_62
	and target_28.getExpr().(AssignExpr).getRValue() instanceof LogicalOrExpr
}

predicate func_31(Variable vst_61, AddressOfExpr target_31) {
	target_31.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="data"
	and target_31.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vst_61
	and target_31.getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
}

from Function func, Parameter vwlen_59, Parameter vrbuf_59, Parameter vrlen_59, Variable vst_61, Variable vret_62, Variable vwo_62, Parameter vd_58, Literal target_0, VariableAccess target_1, FunctionCall target_2, Literal target_3, VariableAccess target_4, PointerFieldAccess target_9, AddExpr target_10, VariableAccess target_11, VariableAccess target_13, VariableAccess target_14, VariableAccess target_15, VariableAccess target_16, VariableAccess target_19, AssignExpr target_21, AssignExpr target_22, ExprStmt target_26, AddressOfExpr target_27, ExprStmt target_28, AddressOfExpr target_31
where
func_0(func, target_0)
and func_1(vwo_62, target_26, target_1)
and func_2(vst_61, vret_62, vd_58, target_2)
and func_3(func, target_3)
and func_4(vwlen_59, vrbuf_59, vrlen_59, vst_61, vd_58, target_10, target_26, target_27, target_4)
and not func_5(vrlen_59, target_28, func)
and not func_7(vrbuf_59, vrlen_59, target_26, target_28)
and not func_8(vrbuf_59, vrlen_59, vst_61, target_31, target_26)
and func_9(vst_61, target_9)
and func_10(vwlen_59, target_10)
and func_11(vrlen_59, target_11)
and func_13(vret_62, target_13)
and func_14(vd_58, target_14)
and func_15(vrbuf_59, target_15)
and func_16(vrbuf_59, vrlen_59, vst_61, vd_58, target_16)
and func_19(vrbuf_59, vrlen_59, vwo_62, target_19)
and func_21(vret_62, target_21)
and func_22(vwlen_59, vrbuf_59, vrlen_59, vst_61, vret_62, vd_58, target_22)
and func_26(func, target_26)
and func_27(vd_58, target_27)
and func_28(vwo_62, target_28)
and func_31(vst_61, target_31)
and vwlen_59.getType().hasName("int")
and vrbuf_59.getType().hasName("u8 *")
and vrlen_59.getType().hasName("int")
and vst_61.getType().hasName("cxusb_state *")
and vret_62.getType().hasName("int")
and vwo_62.getType().hasName("int")
and vd_58.getType().hasName("dvb_usb_device *")
and vwlen_59.getFunction() = func
and vrbuf_59.getFunction() = func
and vrlen_59.getFunction() = func
and vst_61.(LocalVariable).getFunction() = func
and vret_62.(LocalVariable).getFunction() = func
and vwo_62.(LocalVariable).getFunction() = func
and vd_58.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
