/**
 * @name linux-8f34f1eac3820fc2722e5159acceb22545b30b0d-copy_huge_pmd
 * @id cpp/linux/8f34f1eac3820fc2722e5159acceb22545b30b0d/copy-huge-pmd
 * @description linux-8f34f1eac3820fc2722e5159acceb22545b30b0d-mm/huge_memory.c-copy_huge_pmd CVE-2023-4732
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvma_1029, VariableAccess target_0) {
	target_0.getTarget()=vvma_1029
	and vvma_1029.getIndex() = 5
	and target_0.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("vma_is_anonymous")
}

predicate func_1(Parameter vvma_1029, VariableAccess target_1) {
	target_1.getTarget()=vvma_1029
	and vvma_1029.getIndex() = 5
	and target_1.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("page_needs_cow_for_dma")
	and target_1.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("page *")
}

predicate func_2(Parameter vsrc_pmd_1028, Parameter vvma_1029, VariableAccess target_2) {
	target_2.getTarget()=vvma_1029
	and vvma_1029.getIndex() = 5
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__split_huge_pmd")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsrc_pmd_1028
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_3(Parameter vvma_1029, VariableAccess target_3) {
	target_3.getTarget()=vvma_1029
	and vvma_1029.getIndex() = 5
}

predicate func_4(Parameter vsrc_pmd_1028, BlockStmt target_11, ExprStmt target_12, PointerDereferenceExpr target_13) {
exists(FunctionCall target_4 |
	target_4.getTarget().hasName("pmd_swp_uffd_wp")
	and target_4.getArgument(0).(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vsrc_pmd_1028
	and target_4.getParent().(IfStmt).getThen()=target_11
	and target_12.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_4.getArgument(0).(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
	and target_4.getArgument(0).(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_13.getOperand().(VariableAccess).getLocation()))
}

predicate func_5(Variable vpmd_1033, FunctionCall target_9, ExprStmt target_14, NotExpr target_15) {
exists(ExprStmt target_5 |
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pmd_swp_mkuffd_wp")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
	and target_5.getParent().(IfStmt).getCondition()=target_9
	and target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_15.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(Variable vpmd_1033, FunctionCall target_9, ExprStmt target_16, ExprStmt target_17) {
exists(IfStmt target_6 |
	target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("userfaultfd_wp")
	and target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("vm_area_struct *")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pmd_swp_clear_uffd_wp")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(6)=target_6
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_16.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_17.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

/*predicate func_7(ExprStmt target_14, Function func) {
exists(FunctionCall target_7 |
	target_7.getTarget().hasName("userfaultfd_wp")
	and target_7.getArgument(0).(VariableAccess).getType().hasName("vm_area_struct *")
	and target_7.getParent().(NotExpr).getOperand() instanceof BitwiseAndExpr
	and target_7.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_14
	and target_7.getEnclosingFunction() = func)
}

*/
predicate func_8(Variable vpmd_1033, ExprStmt target_18, ExprStmt target_12, Function func) {
exists(IfStmt target_8 |
	target_8.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("userfaultfd_wp")
	and target_8.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("vm_area_struct *")
	and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pmd_clear_uffd_wp")
	and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_18.getLocation())
	and target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_9(Variable vpmd_1033, BlockStmt target_11, FunctionCall target_9) {
	target_9.getTarget().hasName("__builtin_expect")
	and target_9.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("is_swap_pmd")
	and target_9.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
	and target_9.getArgument(1).(Literal).getValue()="0"
	and target_9.getParent().(IfStmt).getThen()=target_11
}

predicate func_10(Parameter vvma_1029, ExprStmt target_14, BitwiseAndExpr target_10) {
	target_10.getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_10.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_1029
	and target_10.getRightOperand().(Literal).getValue()="4096"
	and target_10.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_14
}

predicate func_11(Variable vpmd_1033, BlockStmt target_11) {
	target_11.getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_11.getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_11.getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_11.getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_11.getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("is_write_migration_entry")
	and target_11.getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("swp_entry_t")
	and target_11.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("make_migration_entry_read")
	and target_11.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("swp_entry_t")
	and target_11.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_11.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("swp_entry_to_pmd")
	and target_11.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("swp_entry_t")
}

predicate func_12(Parameter vsrc_pmd_1028, Variable vpmd_1033, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_12.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vsrc_pmd_1028
}

predicate func_13(Parameter vsrc_pmd_1028, ExprStmt target_19, PointerDereferenceExpr target_13) {
	target_13.getOperand().(VariableAccess).getTarget()=vsrc_pmd_1028
	and target_13.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_19
}

predicate func_14(Variable vpmd_1033, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pmd_clear_uffd_wp")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
}

predicate func_15(Variable vpmd_1033, NotExpr target_15) {
	target_15.getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("is_swap_pmd")
	and target_15.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
}

predicate func_16(Parameter vsrc_pmd_1028, Variable vpmd_1033, ExprStmt target_16) {
	target_16.getExpr().(FunctionCall).getTarget().hasName("set_pmd_at")
	and target_16.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("mm_struct *")
	and target_16.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_16.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vsrc_pmd_1028
	and target_16.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vpmd_1033
}

predicate func_17(Variable vpmd_1033, FunctionCall target_9, ExprStmt target_17) {
	target_17.getExpr().(FunctionCall).getTarget().hasName("set_pmd_at")
	and target_17.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("mm_struct *")
	and target_17.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_17.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("pmd_t *")
	and target_17.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vpmd_1033
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_18(Parameter vsrc_pmd_1028, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("pmdp_set_wrprotect")
	and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("mm_struct *")
	and target_18.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_18.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vsrc_pmd_1028
}

predicate func_19(Variable vpmd_1033, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmd_1033
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pmd_swp_mksoft_dirty")
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpmd_1033
}

from Function func, Parameter vsrc_pmd_1028, Parameter vvma_1029, Variable vpmd_1033, VariableAccess target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, FunctionCall target_9, BitwiseAndExpr target_10, BlockStmt target_11, ExprStmt target_12, PointerDereferenceExpr target_13, ExprStmt target_14, NotExpr target_15, ExprStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19
where
func_0(vvma_1029, target_0)
and func_1(vvma_1029, target_1)
and func_2(vsrc_pmd_1028, vvma_1029, target_2)
and func_3(vvma_1029, target_3)
and not func_4(vsrc_pmd_1028, target_11, target_12, target_13)
and not func_5(vpmd_1033, target_9, target_14, target_15)
and not func_6(vpmd_1033, target_9, target_16, target_17)
and not func_8(vpmd_1033, target_18, target_12, func)
and func_9(vpmd_1033, target_11, target_9)
and func_10(vvma_1029, target_14, target_10)
and func_11(vpmd_1033, target_11)
and func_12(vsrc_pmd_1028, vpmd_1033, target_12)
and func_13(vsrc_pmd_1028, target_19, target_13)
and func_14(vpmd_1033, target_14)
and func_15(vpmd_1033, target_15)
and func_16(vsrc_pmd_1028, vpmd_1033, target_16)
and func_17(vpmd_1033, target_9, target_17)
and func_18(vsrc_pmd_1028, target_18)
and func_19(vpmd_1033, target_19)
and vsrc_pmd_1028.getType().hasName("pmd_t *")
and vvma_1029.getType().hasName("vm_area_struct *")
and vpmd_1033.getType().hasName("pmd_t")
and vsrc_pmd_1028.getFunction() = func
and vvma_1029.getFunction() = func
and vpmd_1033.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
