/**
 * @name linux-2f987a76a97773beafbc615b9c4d8fe79129a7f4-__ip6_datagram_connect
 * @id cpp/linux/2f987a76a97773beafbc615b9c4d8fe79129a7f4/--ip6-datagram-connect
 * @description linux-2f987a76a97773beafbc615b9c4d8fe79129a7f4-net/ipv6/datagram.c-__ip6_datagram_connect CVE-2021-0935
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vsk_143, ExprStmt target_13, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("in6_addr")
		and target_1.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="skc_v6_daddr"
		and target_1.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="__sk_common"
		and target_1.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_143
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vnp_148, ExprStmt target_14, ExprStmt target_15, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("__be32")
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="flow_label"
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_148
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("__be32")
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="skc_dport"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="__sk_common"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sk"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Function func) {
	exists(AssignExpr target_4 |
		target_4.getLValue() instanceof ValueFieldAccess
		and target_4.getRValue().(VariableAccess).getType().hasName("in6_addr")
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vnp_148, ExprStmt target_15) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(PointerFieldAccess).getTarget().getName()="flow_label"
		and target_5.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_148
		and target_5.getRValue().(VariableAccess).getType().hasName("__be32")
		and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(VariableAccess target_16, Function func) {
	exists(ExprStmt target_6 |
		target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skc_dport"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="__sk_common"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sk"
		and target_6.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("__be32")
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_6
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_6.getEnclosingFunction() = func)
}

predicate func_8(Parameter vsk_143, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="skc_v6_daddr"
		and target_8.getQualifier().(PointerFieldAccess).getTarget().getName()="__sk_common"
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_143
}

predicate func_9(Parameter vsk_143, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="__sk_common"
		and target_9.getQualifier().(VariableAccess).getTarget()=vsk_143
		and target_9.getParent().(ValueFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_10(Function func, FunctionCall target_10) {
		target_10.getTarget().hasName("__memset")
		and target_10.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
		and target_10.getArgument(1).(Literal).getValue()="0"
		and target_10.getArgument(2).(SizeofExprOperator).getValue()="16"
		and target_10.getEnclosingFunction() = func
}

predicate func_13(Parameter vsk_143, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skc_state"
		and target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="__sk_common"
		and target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_143
}

predicate func_14(Parameter vsk_143, Variable vnp_148, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skc_bound_dev_if"
		and target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="__sk_common"
		and target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_143
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mcast_oif"
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_148
}

predicate func_15(Variable vnp_148, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flow_label"
		and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_148
		and target_15.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("__be32")
}

predicate func_16(Variable verr_151, BlockStmt target_17, VariableAccess target_16) {
		target_16.getTarget()=verr_151
		and target_16.getParent().(IfStmt).getThen()=target_17
}

predicate func_17(Function func, BlockStmt target_17) {
		target_17.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skc_dport"
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="__sk_common"
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_17.getEnclosingFunction() = func
}

from Function func, Variable verr_151, Parameter vsk_143, Variable vnp_148, ValueFieldAccess target_8, PointerFieldAccess target_9, FunctionCall target_10, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, VariableAccess target_16, BlockStmt target_17
where
not func_1(vsk_143, target_13, func)
and not func_2(vnp_148, target_14, target_15, func)
and not func_3(func)
and not func_4(func)
and not func_5(vnp_148, target_15)
and not func_6(target_16, func)
and func_8(vsk_143, target_8)
and func_9(vsk_143, target_9)
and func_10(func, target_10)
and func_13(vsk_143, target_13)
and func_14(vsk_143, vnp_148, target_14)
and func_15(vnp_148, target_15)
and func_16(verr_151, target_17, target_16)
and func_17(func, target_17)
and verr_151.getType().hasName("int")
and vsk_143.getType().hasName("sock *")
and vnp_148.getType().hasName("ipv6_pinfo *")
and verr_151.(LocalVariable).getFunction() = func
and vsk_143.getFunction() = func
and vnp_148.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
