/**
 * @name linux-1c0b51e62a50e9291764d022ed44549e65d6ab9c-thermal_genl_cmd_tz_get_trip
 * @id cpp/linux/1c0b51e62a50e9291764d022ed44549e65d6ab9c/thermal-genl-cmd-tz-get-trip
 * @description linux-1c0b51e62a50e9291764d022ed44549e65d6ab9c-drivers/thermal/thermal_netlink.c-thermal_genl_cmd_tz_get_trip CVE-2022-48915
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(Initializer target_0 |
	target_0.getExpr().(Literal).getValue()="0"
	and target_0.getExpr().getEnclosingFunction() = func
)
}

predicate func_1(Variable vtz_399, ExprStmt target_2, ExprStmt target_3, PointerFieldAccess target_4) {
exists(IfStmt target_1 |
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getCondition() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="ops"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vtz_399
		)
		and obj_0.getTarget().getName()="get_trip_hyst"
	)
	and target_1.getThen() instanceof ExprStmt
	and target_1.getLocation().isBefore(target_2.getLocation())
	and target_3.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getCondition().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getCondition().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_2(Variable vtz_399, Variable vi_401, Variable vhyst_421, ExprStmt target_2) {
	exists(VariableCall obj_0 | obj_0=target_2.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getExpr() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="ops"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vtz_399
			)
			and obj_1.getTarget().getName()="get_trip_hyst"
		)
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vtz_399
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vi_401
		and obj_0.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhyst_421
	)
}

predicate func_3(Variable vtz_399, Variable vi_401, ExprStmt target_3) {
	exists(VariableCall obj_0 | obj_0=target_3.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getExpr() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="ops"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vtz_399
			)
			and obj_1.getTarget().getName()="get_trip_temp"
		)
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vtz_399
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vi_401
		and obj_0.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
	)
}

predicate func_4(Variable vtz_399, PointerFieldAccess target_4) {
	exists(PointerFieldAccess obj_0 | obj_0=target_4.getQualifier() |
		obj_0.getTarget().getName()="ops"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vtz_399
	)
	and target_4.getTarget().getName()="get_trip_hyst"
}

from Function func, Variable vtz_399, Variable vi_401, Variable vhyst_421, ExprStmt target_2, ExprStmt target_3, PointerFieldAccess target_4
where
not func_0(func)
and not func_1(vtz_399, target_2, target_3, target_4)
and func_2(vtz_399, vi_401, vhyst_421, target_2)
and func_3(vtz_399, vi_401, target_3)
and func_4(vtz_399, target_4)
and vtz_399.getType().hasName("thermal_zone_device *")
and vi_401.getType().hasName("int")
and vhyst_421.getType().hasName("int")
and vtz_399.(LocalVariable).getFunction() = func
and vi_401.(LocalVariable).getFunction() = func
and vhyst_421.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
