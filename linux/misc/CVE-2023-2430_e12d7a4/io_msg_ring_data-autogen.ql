/**
 * @name linux-e12d7a46f65ae4b7d58a5e0c1cbfa825cf8d830d-io_msg_ring_data
 * @id cpp/linux/e12d7a46f65ae4b7d58a5e0c1cbfa825cf8d830d/io-msg-ring-data
 * @description linux-e12d7a46f65ae4b7d58a5e0c1cbfa825cf8d830d-io_uring/msg_ring.c-io_msg_ring_data CVE-2023-2430
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, UnaryMinusExpr target_0) {
	target_0.getValue()="-75"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(IfStmt target_12, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_1.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_12.getLocation()))
}

predicate func_2(Variable vtarget_ctx_80, ReturnStmt target_13, AddressOfExpr target_14) {
exists(BitwiseAndExpr target_2 |
	target_2.getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_2.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtarget_ctx_80
	and target_2.getRightOperand().(BinaryBitwiseOperation).getValue()="1"
	and target_2.getParent().(IfStmt).getThen()=target_13
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vtarget_ctx_80, FunctionCall target_9) {
exists(IfStmt target_3 |
	target_3.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("io_double_lock_ctx")
	and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtarget_ctx_80
	and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned int")
	and target_3.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-11"
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9)
}

/*predicate func_4(Function func) {
exists(UnaryMinusExpr target_4 |
	target_4.getValue()="-11"
	and target_4.getEnclosingFunction() = func)
}

*/
predicate func_5(FunctionCall target_9, Function func) {
exists(IfStmt target_5 |
	target_5.getCondition() instanceof FunctionCall
	and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_5
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Variable vtarget_ctx_80, FunctionCall target_9) {
exists(ExprStmt target_6 |
	target_6.getExpr().(FunctionCall).getTarget().hasName("io_double_unlock_ctx")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtarget_ctx_80
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_6
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9)
}

predicate func_7(Variable vmsg_81, Variable vtarget_ctx_80, FunctionCall target_9, AddressOfExpr target_15) {
exists(IfStmt target_7 |
	target_7.getCondition().(FunctionCall).getTarget().hasName("io_post_aux_cqe")
	and target_7.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtarget_ctx_80
	and target_7.getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="user_data"
	and target_7.getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_81
	and target_7.getCondition().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="len"
	and target_7.getCondition().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_81
	and target_7.getCondition().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(0)=target_7
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_15.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Variable vmsg_81, Variable vtarget_ctx_80, ReturnStmt target_13, FunctionCall target_9) {
	target_9.getTarget().hasName("io_post_aux_cqe")
	and target_9.getArgument(0).(VariableAccess).getTarget()=vtarget_ctx_80
	and target_9.getArgument(1).(PointerFieldAccess).getTarget().getName()="user_data"
	and target_9.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_81
	and target_9.getArgument(2).(PointerFieldAccess).getTarget().getName()="len"
	and target_9.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_81
	and target_9.getArgument(3).(Literal).getValue()="0"
	and target_9.getParent().(IfStmt).getThen()=target_13
}

/*predicate func_10(Function func, UnaryMinusExpr target_10) {
	target_10.getValue()="-75"
	and target_10.getEnclosingFunction() = func
}

*/
predicate func_12(Function func, IfStmt target_12) {
	target_12.getCondition() instanceof FunctionCall
	and target_12.getThen().(ReturnStmt).getExpr() instanceof Literal
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Function func, ReturnStmt target_13) {
	target_13.getExpr() instanceof Literal
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Variable vtarget_ctx_80, AddressOfExpr target_14) {
	target_14.getOperand().(PointerFieldAccess).getTarget().getName()="sq_flags"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="rings"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtarget_ctx_80
}

predicate func_15(Variable vmsg_81, Variable vtarget_ctx_80, ReturnStmt target_16, AddressOfExpr target_15) {
	target_15.getOperand().(PointerFieldAccess).getTarget().getName()="tw"
	and target_15.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_81
	and target_15.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="submitter_task"
	and target_15.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtarget_ctx_80
	and target_15.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_16
}

predicate func_16(Function func, ReturnStmt target_16) {
	target_16.getExpr().(UnaryMinusExpr).getValue()="-130"
	and target_16.getEnclosingFunction() = func
}

from Function func, Variable vmsg_81, Variable vtarget_ctx_80, UnaryMinusExpr target_0, FunctionCall target_9, IfStmt target_12, ReturnStmt target_13, AddressOfExpr target_14, AddressOfExpr target_15, ReturnStmt target_16
where
func_0(func, target_0)
and not func_1(target_12, func)
and not func_2(vtarget_ctx_80, target_13, target_14)
and not func_3(vtarget_ctx_80, target_9)
and not func_5(target_9, func)
and not func_6(vtarget_ctx_80, target_9)
and not func_7(vmsg_81, vtarget_ctx_80, target_9, target_15)
and func_9(vmsg_81, vtarget_ctx_80, target_13, target_9)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(vtarget_ctx_80, target_14)
and func_15(vmsg_81, vtarget_ctx_80, target_16, target_15)
and func_16(func, target_16)
and vmsg_81.getType().hasName("io_msg *")
and vtarget_ctx_80.getType().hasName("io_ring_ctx *")
and vmsg_81.(LocalVariable).getFunction() = func
and vtarget_ctx_80.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
