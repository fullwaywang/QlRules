/**
 * @name libtiff-3ca657a8793dd011bf869695d72ad31c779c3cc1-PredictorDecodeTile
 * @id cpp/libtiff/3ca657a8793dd011bf869695d72ad31c779c3cc1/predictordecodetile
 * @description libtiff-3ca657a8793dd011bf869695d72ad31c779c3cc1-libtiff/tif_predict.c-PredictorDecodeTile CVE-2016-9535
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable v__PRETTY_FUNCTION__, FunctionCall target_0) {
		target_0.getTarget().hasName("__assert_fail")
		and not target_0.getTarget().hasName("TIFFErrorExt")
		and target_0.getArgument(0) instanceof StringLiteral
		and target_0.getArgument(1) instanceof StringLiteral
		and target_0.getArgument(2) instanceof Literal
		and target_0.getArgument(3).(VariableAccess).getTarget()=v__PRETTY_FUNCTION__
}

predicate func_1(Parameter vtif_449, ExprCall target_17) {
	exists(IfStmt target_1 |
		target_1.getCondition().(EqualityOperation).getAnOperand() instanceof RemExpr
		and target_1.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("TIFFErrorExt")
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tif_clientdata"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_449
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="PredictorDecodeTile"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%s"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(StringLiteral).getValue()="occ0%rowsize != 0"
		and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17)
}

/*predicate func_2(Parameter vtif_449, ExprCall target_17) {
	exists(PointerFieldAccess target_2 |
		target_2.getTarget().getName()="tif_clientdata"
		and target_2.getQualifier().(VariableAccess).getTarget()=vtif_449
		and target_17.getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_6(Function func) {
	exists(NotExpr target_6 |
		target_6.getOperand() instanceof ExprCall
		and target_6.getParent().(IfStmt).getThen() instanceof EmptyStmt
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(EqualityOperation target_10, Function func) {
	exists(ReturnStmt target_7 |
		target_7.getExpr().(Literal).getValue()="0"
		and target_7.getParent().(IfStmt).getCondition()=target_10
		and target_7.getEnclosingFunction() = func)
}

predicate func_8(Parameter vocc0_449, Variable vrowsize_457, RemExpr target_8) {
		target_8.getLeftOperand().(VariableAccess).getTarget()=vocc0_449
		and target_8.getRightOperand().(VariableAccess).getTarget()=vrowsize_457
		and target_8.getParent().(EQExpr).getAnOperand() instanceof Literal
}

predicate func_9(Function func, SizeofExprOperator target_9) {
		target_9.getValue()="4"
		and target_9.getEnclosingFunction() = func
}

predicate func_10(Variable vsp_451, EqualityOperation target_10) {
		target_10.getAnOperand().(PointerFieldAccess).getTarget().getName()="decodepfunc"
		and target_10.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsp_451
		and target_10.getAnOperand() instanceof Literal
		and target_10.getParent().(IfStmt).getThen() instanceof EmptyStmt
}

predicate func_11(Parameter vtif_449, Parameter vop0_449, Variable vsp_451, Variable vrowsize_457, ExprCall target_11) {
		target_11.getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="decodepfunc"
		and target_11.getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsp_451
		and target_11.getArgument(0).(VariableAccess).getTarget()=vtif_449
		and target_11.getArgument(1).(VariableAccess).getTarget()=vop0_449
		and target_11.getArgument(2).(VariableAccess).getTarget()=vrowsize_457
}

predicate func_12(Function func, SizeofExprOperator target_12) {
		target_12.getValue()="4"
		and target_12.getEnclosingFunction() = func
}

predicate func_13(Parameter vocc0_449, Variable vrowsize_457, RelationalOperation target_20, EqualityOperation target_13) {
		target_13.getAnOperand().(RemExpr).getLeftOperand().(VariableAccess).getTarget()=vocc0_449
		and target_13.getAnOperand().(RemExpr).getRightOperand().(VariableAccess).getTarget()=vrowsize_457
		and target_13.getAnOperand() instanceof Literal
		and target_13.getParent().(IfStmt).getThen() instanceof EmptyStmt
		and target_13.getAnOperand().(RemExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_20.getGreaterOperand().(VariableAccess).getLocation())
}

predicate func_14(EqualityOperation target_13, Function func, ExprStmt target_14) {
		target_14.getExpr() instanceof FunctionCall
		and target_14.getParent().(IfStmt).getCondition()=target_13
		and target_14.getEnclosingFunction() = func
}

predicate func_15(ExprCall target_17, Function func, ExprStmt target_15) {
		target_15.getExpr().(CommaExpr).getLeftOperand() instanceof SizeofExprOperator
		and target_15.getExpr().(CommaExpr).getRightOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition() instanceof EqualityOperation
		and target_15.getExpr().(CommaExpr).getRightOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__assert_fail")
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
		and target_15.getEnclosingFunction() = func
}

/*predicate func_16(EqualityOperation target_10, Function func, EmptyStmt target_16) {
		target_16.getParent().(IfStmt).getCondition()=target_10
		and target_16.getEnclosingFunction() = func
}

*/
predicate func_17(Parameter vtif_449, Parameter vop0_449, Parameter vocc0_449, Variable vsp_451, ExprCall target_17) {
		target_17.getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="decodetile"
		and target_17.getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsp_451
		and target_17.getArgument(0).(VariableAccess).getTarget()=vtif_449
		and target_17.getArgument(1).(VariableAccess).getTarget()=vop0_449
		and target_17.getArgument(2).(VariableAccess).getTarget()=vocc0_449
		and target_17.getArgument(3).(VariableAccess).getTarget().getType().hasName("uint16")
}

predicate func_20(Parameter vocc0_449, RelationalOperation target_20) {
		 (target_20 instanceof GTExpr or target_20 instanceof LTExpr)
		and target_20.getGreaterOperand().(VariableAccess).getTarget()=vocc0_449
		and target_20.getLesserOperand().(Literal).getValue()="0"
}

from Function func, Parameter vtif_449, Parameter vop0_449, Parameter vocc0_449, Variable vsp_451, Variable v__PRETTY_FUNCTION__, Variable vrowsize_457, FunctionCall target_0, RemExpr target_8, SizeofExprOperator target_9, EqualityOperation target_10, ExprCall target_11, SizeofExprOperator target_12, EqualityOperation target_13, ExprStmt target_14, ExprStmt target_15, ExprCall target_17, RelationalOperation target_20
where
func_0(v__PRETTY_FUNCTION__, target_0)
and not func_1(vtif_449, target_17)
and not func_6(func)
and not func_7(target_10, func)
and func_8(vocc0_449, vrowsize_457, target_8)
and func_9(func, target_9)
and func_10(vsp_451, target_10)
and func_11(vtif_449, vop0_449, vsp_451, vrowsize_457, target_11)
and func_12(func, target_12)
and func_13(vocc0_449, vrowsize_457, target_20, target_13)
and func_14(target_13, func, target_14)
and func_15(target_17, func, target_15)
and func_17(vtif_449, vop0_449, vocc0_449, vsp_451, target_17)
and func_20(vocc0_449, target_20)
and vtif_449.getType().hasName("TIFF *")
and vop0_449.getType().hasName("uint8 *")
and vocc0_449.getType().hasName("tmsize_t")
and vsp_451.getType().hasName("TIFFPredictorState *")
and v__PRETTY_FUNCTION__.getType() instanceof ArrayType
and vrowsize_457.getType().hasName("tmsize_t")
and vtif_449.getFunction() = func
and vop0_449.getFunction() = func
and vocc0_449.getFunction() = func
and vsp_451.(LocalVariable).getFunction() = func
and not v__PRETTY_FUNCTION__.getParentScope+() = func
and vrowsize_457.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
