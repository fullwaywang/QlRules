/**
 * @name linux-bb6d73d9add68ad270888db327514384dfa44958-irdma_sc_alloc_stag
 * @id cpp/linux/bb6d73d9add68ad270888db327514384dfa44958/irdma-sc-alloc-stag
 * @description linux-bb6d73d9add68ad270888db327514384dfa44958-drivers/infiniband/hw/irdma/ctrl.c-irdma_sc_alloc_stag CVE-2023-25775
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vinfo_1056, IfStmt target_1, EqualityOperation target_2, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="total_len"
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1056
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="all_memory"
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1056
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vinfo_1056, IfStmt target_1) {
	target_1.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="page_size"
	and target_1.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1056
	and target_1.getCondition().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="1073741824"
	and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("irdma_page_size")
	and target_1.getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="page_size"
	and target_1.getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1056
	and target_1.getElse().(IfStmt).getCondition().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="2097152"
	and target_1.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("irdma_page_size")
	and target_1.getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("irdma_page_size")
}

predicate func_2(Parameter vinfo_1056, EqualityOperation target_2) {
	target_2.getLeftOperand().(PointerFieldAccess).getTarget().getName()="page_size"
	and target_2.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1056
	and target_2.getRightOperand().(HexLiteral).getValue()="1073741824"
}

from Function func, Parameter vinfo_1056, IfStmt target_1, EqualityOperation target_2
where
not func_0(vinfo_1056, target_1, target_2, func)
and func_1(vinfo_1056, target_1)
and func_2(vinfo_1056, target_2)
and vinfo_1056.getType().hasName("irdma_allocate_stag_info *")
and vinfo_1056.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
