/**
 * @name linux-b0077e269f6c152e807fdac90b58caf012cdbaab-blk_mq_get_new_requests
 * @id cpp/linux/b0077e269f6c152e807fdac90b58caf012cdbaab/blk-mq-get-new-requests
 * @description linux-b0077e269f6c152e807fdac90b58caf012cdbaab-block/blk-mq.c-blk_mq_get_new_requests CVE-2023-52787
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vq_2849, Parameter vbio_2851, Parameter vnsegs_2852, FunctionCall target_0) {
	target_0.getTarget().hasName("blk_mq_attempt_bio_merge")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vq_2849
	and target_0.getArgument(1).(VariableAccess).getTarget()=vbio_2851
	and target_0.getArgument(2).(VariableAccess).getTarget()=vnsegs_2852
	and target_0.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_1(Parameter vbio_2851, ReturnStmt target_4, FunctionCall target_1) {
	target_1.getTarget().hasName("__builtin_expect")
	and target_1.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("bio_queue_enter")
	and target_1.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2851
	and target_1.getArgument(1).(Literal).getValue()="0"
	and target_1.getParent().(IfStmt).getThen()=target_4
}

predicate func_2(Function func, IfStmt target_2) {
	target_2.getCondition() instanceof FunctionCall
	and target_2.getThen().(GotoStmt).getName() ="queue_exit"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Parameter vq_2849, Function func, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("blk_queue_exit")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vq_2849
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(FunctionCall target_1, Function func, ReturnStmt target_4) {
	target_4.getExpr().(Literal).getValue()="0"
	and target_4.getParent().(IfStmt).getCondition()=target_1
	and target_4.getEnclosingFunction() = func
}

from Function func, Parameter vq_2849, Parameter vbio_2851, Parameter vnsegs_2852, FunctionCall target_0, FunctionCall target_1, IfStmt target_2, ExprStmt target_3, ReturnStmt target_4
where
func_0(vq_2849, vbio_2851, vnsegs_2852, target_0)
and func_1(vbio_2851, target_4, target_1)
and func_2(func, target_2)
and func_3(vq_2849, func, target_3)
and func_4(target_1, func, target_4)
and vq_2849.getType().hasName("request_queue *")
and vbio_2851.getType().hasName("bio *")
and vnsegs_2852.getType().hasName("unsigned int")
and vq_2849.getFunction() = func
and vbio_2851.getFunction() = func
and vnsegs_2852.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
