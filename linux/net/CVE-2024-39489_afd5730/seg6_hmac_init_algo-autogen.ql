/**
 * @name linux-afd5730969aec960a2fee4e5ee839a6014643976-seg6_hmac_init_algo
 * @id cpp/linux/afd5730969aec960a2fee4e5ee839a6014643976/seg6-hmac-init-algo
 * @description linux-afd5730969aec960a2fee4e5ee839a6014643976-net/ipv6/seg6_hmac.c-seg6_hmac_init_algo CVE-2024-39489
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(NotExpr target_12, Function func) {
exists(GotoStmt target_0 |
	target_0.getName() ="error_out"
	and target_0.getParent().(IfStmt).getCondition()=target_12
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(FunctionCall target_13, Function func) {
exists(ExprStmt target_1 |
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("int")
		and obj_0.getRValue() instanceof FunctionCall
	)
	and exists(BlockStmt obj_1 | obj_1=target_1.getParent() |
		exists(IfStmt obj_2 | obj_2=obj_1.getParent() |
			obj_2.getThen().(BlockStmt).getStmt(0)=target_1
			and obj_2.getCondition()=target_13
		)
	)
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(FunctionCall target_13, Function func) {
exists(GotoStmt target_2 |
	exists(BlockStmt obj_0 | obj_0=target_2.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(1)=target_2
			and obj_1.getCondition()=target_13
		)
	)
	and target_2.getName() ="error_out"
	and target_2.getEnclosingFunction() = func
)
}

predicate func_3(NotExpr target_14, Function func) {
exists(GotoStmt target_3 |
	target_3.getName() ="error_out"
	and target_3.getParent().(IfStmt).getCondition()=target_14
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(NotExpr target_15, Function func) {
exists(GotoStmt target_4 |
	target_4.getName() ="error_out"
	and target_4.getParent().(IfStmt).getCondition()=target_15
	and target_4.getEnclosingFunction() = func
)
}

predicate func_5(Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("seg6_hmac_exit")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
)
}

predicate func_7(Function func, UnaryMinusExpr target_7) {
	target_7.getValue()="-12"
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Variable vtfm_361, FunctionCall target_8) {
	target_8.getTarget().hasName("PTR_ERR")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vtfm_361
}

predicate func_9(FunctionCall target_13, Function func, ReturnStmt target_9) {
	target_9.getExpr() instanceof FunctionCall
	and target_9.getParent().(IfStmt).getCondition()=target_13
	and target_9.getEnclosingFunction() = func
}

predicate func_10(NotExpr target_14, Function func, ReturnStmt target_10) {
	target_10.getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_10.getParent().(IfStmt).getCondition()=target_14
	and target_10.getEnclosingFunction() = func
}

predicate func_11(NotExpr target_15, Function func, ReturnStmt target_11) {
	target_11.getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_11.getParent().(IfStmt).getCondition()=target_15
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Function func, NotExpr target_12) {
	exists(PointerFieldAccess obj_0 | obj_0=target_12.getOperand() |
		obj_0.getTarget().getName()="tfms"
		and obj_0.getQualifier().(VariableAccess).getTarget().getType().hasName("seg6_hmac_algo *")
	)
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Variable vtfm_361, FunctionCall target_13) {
	target_13.getTarget().hasName("IS_ERR")
	and target_13.getArgument(0).(VariableAccess).getTarget()=vtfm_361
}

predicate func_14(Function func, NotExpr target_14) {
	exists(PointerFieldAccess obj_0 | obj_0=target_14.getOperand() |
		obj_0.getTarget().getName()="shashs"
		and obj_0.getQualifier().(VariableAccess).getTarget().getType().hasName("seg6_hmac_algo *")
	)
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, NotExpr target_15) {
	target_15.getOperand().(VariableAccess).getTarget().getType().hasName("shash_desc *")
	and target_15.getEnclosingFunction() = func
}

from Function func, Variable vtfm_361, UnaryMinusExpr target_7, FunctionCall target_8, ReturnStmt target_9, ReturnStmt target_10, ReturnStmt target_11, NotExpr target_12, FunctionCall target_13, NotExpr target_14, NotExpr target_15
where
not func_0(target_12, func)
and not func_1(target_13, func)
and not func_2(target_13, func)
and not func_3(target_14, func)
and not func_4(target_15, func)
and not func_5(func)
and func_7(func, target_7)
and func_8(vtfm_361, target_8)
and func_9(target_13, func, target_9)
and func_10(target_14, func, target_10)
and func_11(target_15, func, target_11)
and func_12(func, target_12)
and func_13(vtfm_361, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and vtfm_361.getType().hasName("crypto_shash *")
and vtfm_361.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
