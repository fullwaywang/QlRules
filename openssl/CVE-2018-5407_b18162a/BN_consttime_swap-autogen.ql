/**
 * @name openssl-b18162a7c9bbfb57112459a4d6631fa258fd8c0c-BN_consttime_swap
 * @id cpp/openssl/b18162a7c9bbfb57112459a4d6631fa258fd8c0c/bn-consttime-swap
 * @description openssl-b18162a7c9bbfb57112459a4d6631fa258fd8c0c-crypto/bn/bn_lib.c-BN_consttime_swap CVE-2018-5407
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcondition_888, Parameter va_888, Parameter vb_888, Variable vt_890, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_890
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="neg"
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="neg"
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_888
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter va_888, Variable vt_890, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="neg"
		and target_1.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_1.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1)
}

predicate func_2(Parameter vb_888, Variable vt_890, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="neg"
		and target_2.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_2.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2)
}

predicate func_3(Parameter vcondition_888, Parameter va_888, Parameter vb_888, Variable vt_890, ExprStmt target_9, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_890
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="4"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_888
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_4(Parameter va_888, Variable vt_890, ExprStmt target_9, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
		and target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_4.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vb_888, Variable vt_890, ExprStmt target_9, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
		and target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_5.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vcondition_888, Parameter va_888, Parameter vb_888, Variable vt_890, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_890
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="top"
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="top"
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_888
}

predicate func_7(Parameter va_888, Variable vt_890, ExprStmt target_7) {
		target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="top"
		and target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_7.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
}

predicate func_8(Parameter vb_888, Variable vt_890, ExprStmt target_8) {
		target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="top"
		and target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_8.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_890
}

predicate func_9(Parameter vcondition_888, Parameter va_888, Parameter vb_888, Variable vt_890, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_890
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="d"
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_888
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="d"
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_888
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_888
}

from Function func, Parameter vcondition_888, Parameter va_888, Parameter vb_888, Variable vt_890, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9
where
not func_0(vcondition_888, va_888, vb_888, vt_890, target_6, target_7, target_8, func)
and not func_1(va_888, vt_890, func)
and not func_2(vb_888, vt_890, func)
and not func_3(vcondition_888, va_888, vb_888, vt_890, target_9, func)
and not func_4(va_888, vt_890, target_9, func)
and not func_5(vb_888, vt_890, target_9, func)
and func_6(vcondition_888, va_888, vb_888, vt_890, target_6)
and func_7(va_888, vt_890, target_7)
and func_8(vb_888, vt_890, target_8)
and func_9(vcondition_888, va_888, vb_888, vt_890, target_9)
and vcondition_888.getType().hasName("unsigned long")
and va_888.getType().hasName("BIGNUM *")
and vb_888.getType().hasName("BIGNUM *")
and vt_890.getType().hasName("unsigned long")
and vcondition_888.getFunction() = func
and va_888.getFunction() = func
and vb_888.getFunction() = func
and vt_890.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
