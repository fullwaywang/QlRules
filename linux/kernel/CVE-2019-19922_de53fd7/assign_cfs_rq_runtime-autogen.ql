/**
 * @name linux-de53fd7aedb100f03e5d2231cfce0e4993282425-assign_cfs_rq_runtime
 * @id cpp/linux/de53fd7aedb100f03e5d2231cfce0e4993282425/assign-cfs-rq-runtime
 * @description linux-de53fd7aedb100f03e5d2231cfce0e4993282425-kernel/sched/fair.c-assign_cfs_rq_runtime CVE-2019-19922
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Function func, DeclStmt target_1) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Variable vcfs_b_4396, Variable vexpires_seq_4398, Function func, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vexpires_seq_4398
	and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4396
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vcfs_b_4396, Variable vexpires_4397, Function func, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vexpires_4397
	and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4396
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Parameter vcfs_rq_4393, Variable vexpires_4397, Variable vexpires_seq_4398, Function func, IfStmt target_4) {
	target_4.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_4.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_4.getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vexpires_seq_4398
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vexpires_seq_4398
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vexpires_4397
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

/*predicate func_5(Parameter vcfs_rq_4393, Variable vexpires_seq_4398, EqualityOperation target_7, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_5.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vexpires_seq_4398
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
/*predicate func_6(Parameter vcfs_rq_4393, Variable vexpires_4397, EqualityOperation target_7, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_6.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vexpires_4397
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
predicate func_7(Parameter vcfs_rq_4393, Variable vexpires_seq_4398, EqualityOperation target_7) {
	target_7.getLeftOperand().(PointerFieldAccess).getTarget().getName()="expires_seq"
	and target_7.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4393
	and target_7.getRightOperand().(VariableAccess).getTarget()=vexpires_seq_4398
}

from Function func, Parameter vcfs_rq_4393, Variable vcfs_b_4396, Variable vexpires_4397, Variable vexpires_seq_4398, DeclStmt target_1, ExprStmt target_2, ExprStmt target_3, IfStmt target_4, EqualityOperation target_7
where
func_1(func, target_1)
and func_2(vcfs_b_4396, vexpires_seq_4398, func, target_2)
and func_3(vcfs_b_4396, vexpires_4397, func, target_3)
and func_4(vcfs_rq_4393, vexpires_4397, vexpires_seq_4398, func, target_4)
and func_7(vcfs_rq_4393, vexpires_seq_4398, target_7)
and vcfs_rq_4393.getType().hasName("cfs_rq *")
and vcfs_b_4396.getType().hasName("cfs_bandwidth *")
and vexpires_4397.getType().hasName("u64")
and vexpires_seq_4398.getType().hasName("int")
and vcfs_rq_4393.getFunction() = func
and vcfs_b_4396.(LocalVariable).getFunction() = func
and vexpires_4397.(LocalVariable).getFunction() = func
and vexpires_seq_4398.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
