/**
 * @name linux-4374f256ce8182019353c0c639bb8d0695b4c941-adjust_scalar_min_max_vals
 * @id cpp/linux/4374f256ce8182019353c0c639bb8d0695b4c941/adjust-scalar-min-max-vals
 * @description linux-4374f256ce8182019353c0c639bb8d0695b4c941-kernel/bpf/verifier.c-adjust_scalar_min_max_vals CVE-2017-17853
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdst_reg_2009, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="smin_value"
	and target_0.getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_0.getParent().(AssignExpr).getLValue() = target_0
	and target_0.getParent().(AssignExpr).getRValue() instanceof Literal
}

predicate func_1(Parameter vdst_reg_2009, VariableAccess target_7, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getValue()="-9223372036854775808"
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

predicate func_2(Parameter vdst_reg_2009, VariableAccess target_7, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smax_value"
	and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_2.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getValue()="9223372036854775807"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

predicate func_3(Parameter vdst_reg_2009, Variable vumin_val_2016, Variable vumax_val_2016, VariableAccess target_8, IfStmt target_3) {
	target_3.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_3.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_3.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableAccess).getTarget()=vumin_val_2016
	and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_3.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vumax_val_2016
	and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_8
}

/*predicate func_4(Parameter vdst_reg_2009, Variable vumin_val_2016, RelationalOperation target_9, IfStmt target_4) {
	target_4.getCondition().(VariableAccess).getTarget()=vumin_val_2016
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_4.getElse().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_4.getElse().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

*/
/*predicate func_5(Parameter vdst_reg_2009, VariableAccess target_7, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_5.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
/*predicate func_6(Parameter vdst_reg_2009, Variable vumax_val_2016, RelationalOperation target_9, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_6.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_6.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_6.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vumax_val_2016
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

*/
predicate func_7(Variable vumin_val_2016, BlockStmt target_10, VariableAccess target_7) {
	target_7.getTarget()=vumin_val_2016
	and target_7.getParent().(IfStmt).getThen()=target_10
}

predicate func_8(Variable vopcode_2013, VariableAccess target_8) {
	target_8.getTarget()=vopcode_2013
}

predicate func_9(Parameter vdst_reg_2009, BlockStmt target_11, RelationalOperation target_9) {
	 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
	and target_9.getLesserOperand().(PointerFieldAccess).getTarget().getName()="smin_value"
	and target_9.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdst_reg_2009
	and target_9.getGreaterOperand() instanceof Literal
	and target_9.getParent().(IfStmt).getThen()=target_11
}

predicate func_10(Function func, BlockStmt target_10) {
	target_10.getStmt(0) instanceof ExprStmt
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Function func, BlockStmt target_11) {
	target_11.getStmt(0) instanceof IfStmt
	and target_11.getEnclosingFunction() = func
}

from Function func, Parameter vdst_reg_2009, Variable vopcode_2013, Variable vumin_val_2016, Variable vumax_val_2016, PointerFieldAccess target_0, ExprStmt target_1, ExprStmt target_2, IfStmt target_3, VariableAccess target_7, VariableAccess target_8, RelationalOperation target_9, BlockStmt target_10, BlockStmt target_11
where
func_0(vdst_reg_2009, target_0)
and func_1(vdst_reg_2009, target_7, target_1)
and func_2(vdst_reg_2009, target_7, target_2)
and func_3(vdst_reg_2009, vumin_val_2016, vumax_val_2016, target_8, target_3)
and func_7(vumin_val_2016, target_10, target_7)
and func_8(vopcode_2013, target_8)
and func_9(vdst_reg_2009, target_11, target_9)
and func_10(func, target_10)
and func_11(func, target_11)
and vdst_reg_2009.getType().hasName("bpf_reg_state *")
and vopcode_2013.getType().hasName("u8")
and vumin_val_2016.getType().hasName("u64")
and vumax_val_2016.getType().hasName("u64")
and vdst_reg_2009.getFunction() = func
and vopcode_2013.(LocalVariable).getFunction() = func
and vumin_val_2016.(LocalVariable).getFunction() = func
and vumax_val_2016.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
