/**
 * @name linux-7690aa1cdf7c4565ad6b013b324c28b685505e24-__nla_validate_parse
 * @id cpp/linux/7690aa1cdf7c4565ad6b013b324c28b685505e24/--nla-validate-parse
 * @description linux-7690aa1cdf7c4565ad6b013b324c28b685505e24-lib/nlattr.c-__nla_validate_parse CVE-2020-36691
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(BlockStmt target_7, Function func) {
exists(RelationalOperation target_0 |
	 (target_0 instanceof GEExpr or target_0 instanceof LEExpr)
	and target_0.getGreaterOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getLesserOperand().(Literal).getValue()="10"
	and target_0.getParent().(IfStmt).getThen()=target_7
	and target_0.getEnclosingFunction() = func)
}

predicate func_4(Parameter vpolicy_358, Variable verr_381, IfStmt target_8, FunctionCall target_9) {
exists(IfStmt target_4 |
	target_4.getCondition().(VariableAccess).getTarget()=vpolicy_358
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_381
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=verr_381
	and target_4.getLocation().isBefore(target_8.getLocation())
	and target_4.getCondition().(VariableAccess).getLocation().isBefore(target_9.getArgument(2).(VariableAccess).getLocation()))
}

predicate func_6(Parameter vpolicy_358, BlockStmt target_7, VariableAccess target_6) {
	target_6.getTarget()=vpolicy_358
	and target_6.getParent().(IfStmt).getThen()=target_7
}

predicate func_7(Variable verr_381, BlockStmt target_7) {
	target_7.getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_381
	and target_7.getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_7.getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=verr_381
}

predicate func_8(Parameter vpolicy_358, Variable verr_381, IfStmt target_8) {
	target_8.getCondition().(VariableAccess).getTarget()=vpolicy_358
	and target_8.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_381
	and target_8.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_8.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=verr_381
}

predicate func_9(Parameter vpolicy_358, FunctionCall target_9) {
	target_9.getTarget().hasName("validate_nla")
	and target_9.getArgument(0).(VariableAccess).getTarget().getType().hasName("const nlattr *")
	and target_9.getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
	and target_9.getArgument(2).(VariableAccess).getTarget()=vpolicy_358
	and target_9.getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_9.getArgument(4).(VariableAccess).getTarget().getType().hasName("netlink_ext_ack *")
}

from Function func, Parameter vpolicy_358, Variable verr_381, VariableAccess target_6, BlockStmt target_7, IfStmt target_8, FunctionCall target_9
where
not func_0(target_7, func)
and not func_4(vpolicy_358, verr_381, target_8, target_9)
and func_6(vpolicy_358, target_7, target_6)
and func_7(verr_381, target_7)
and func_8(vpolicy_358, verr_381, target_8)
and func_9(vpolicy_358, target_9)
and vpolicy_358.getType().hasName("const nla_policy *")
and verr_381.getType().hasName("int")
and vpolicy_358.getFunction() = func
and verr_381.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
