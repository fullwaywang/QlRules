/**
 * @name linux-7a7b5df84b6b4e5d599c7289526eed96541a0654-cp2112_gpio_direction_input
 * @id cpp/linux/7a7b5df84b6b4e5d599c7289526eed96541a0654/cp2112-gpio-direction-input
 * @description linux-7a7b5df84b6b4e5d599c7289526eed96541a0654-drivers/hid/hid-cp2112.c-cp2112_gpio_direction_input CVE-2017-8071
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vflags_189, FunctionCall target_0) {
	target_0.getTarget().hasName("spin_unlock_irqrestore")
	and not target_0.getTarget().hasName("mutex_lock_nested")
	and target_0.getArgument(0) instanceof AddressOfExpr
	and target_0.getArgument(1).(VariableAccess).getTarget()=vflags_189
}

predicate func_1(Function func) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("mutex_unlock")
	and target_1.getArgument(0) instanceof AddressOfExpr
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Variable vdev_186, AddressOfExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_186
	and target_2.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(0) instanceof FunctionCall
}

predicate func_3(Variable vdev_186, AddressOfExpr target_3) {
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_186
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vflags_189, Function func, DoStmt target_6) {
	target_6.getCondition() instanceof Literal
	and target_6.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_6.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_189
	and target_6.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

/*predicate func_7(Variable vflags_189, DoStmt target_7) {
	target_7.getCondition().(Literal).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_189
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0) instanceof AddressOfExpr
}

*/
/*predicate func_8(Variable v__dummy_192, Variable v__dummy2_192, StmtExpr target_8) {
	target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy_192
	and target_8.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy2_192
	and target_8.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
}

*/
/*predicate func_11(Variable v__dummy_192, Variable v__dummy2_192, ExprStmt target_11) {
	target_11.getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy_192
	and target_11.getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy2_192
}

*/
/*predicate func_12(Function func, ExprStmt target_12) {
	target_12.getExpr().(Literal).getValue()="1"
	and target_12.getEnclosingFunction() = func
}

*/
/*predicate func_13(Variable vflags_189, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_189
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0) instanceof AddressOfExpr
}

*/
from Function func, Variable vdev_186, Variable vflags_189, Variable v__dummy_192, Variable v__dummy2_192, FunctionCall target_0, AddressOfExpr target_2, AddressOfExpr target_3, DeclStmt target_5, DoStmt target_6
where
func_0(vflags_189, target_0)
and not func_1(func)
and func_2(vdev_186, target_2)
and func_3(vdev_186, target_3)
and func_5(func, target_5)
and func_6(vflags_189, func, target_6)
and vdev_186.getType().hasName("cp2112_device *")
and vflags_189.getType().hasName("unsigned long")
and v__dummy_192.getType().hasName("unsigned long")
and v__dummy2_192.getType().hasName("unsigned long")
and vdev_186.(LocalVariable).getFunction() = func
and vflags_189.(LocalVariable).getFunction() = func
and v__dummy_192.(LocalVariable).getFunction() = func
and v__dummy2_192.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
