/**
 * @name linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-ntfs_create_inode
 * @id cpp/linux/0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b/ntfs-create-inode
 * @description linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-fs/ntfs3/inode.c-ntfs_create_inode CVE-2022-48502
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vni_1204, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="file"
	and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_1204
}

predicate func_2(Parameter vmode_1194, EqualityOperation target_2) {
	target_2.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vmode_1194
	and target_2.getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
	and target_2.getRightOperand().(Literal).getValue()="16384"
	and target_2.getParent().(LogicalOrExpr).getRightOperand() instanceof FunctionCall
	and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_3(Variable vsbi_1200, Variable vni_1204, Function func, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("run_deallocate")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsbi_1200
	and target_3.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="run"
	and target_3.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="file"
	and target_3.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_1204
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, LogicalOrExpr target_4) {
	target_4.getLeftOperand() instanceof EqualityOperation
	and target_4.getRightOperand().(FunctionCall).getTarget().hasName("run_is_empty")
	and target_4.getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="run"
	and target_4.getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_4.getParent().(IfStmt).getThen() instanceof GotoStmt
	and target_4.getEnclosingFunction() = func
}

predicate func_5(LogicalOrExpr target_4, Function func, GotoStmt target_5) {
	target_5.getName() ="out4"
	and target_5.getParent().(IfStmt).getCondition()=target_4
	and target_5.getEnclosingFunction() = func
}

from Function func, Parameter vmode_1194, Variable vsbi_1200, Variable vni_1204, ValueFieldAccess target_1, EqualityOperation target_2, ExprStmt target_3, LogicalOrExpr target_4, GotoStmt target_5
where
func_1(vni_1204, target_1)
and func_2(vmode_1194, target_2)
and func_3(vsbi_1200, vni_1204, func, target_3)
and func_4(func, target_4)
and func_5(target_4, func, target_5)
and vmode_1194.getType().hasName("umode_t")
and vsbi_1200.getType().hasName("ntfs_sb_info *")
and vni_1204.getType().hasName("ntfs_inode *")
and vmode_1194.getFunction() = func
and vsbi_1200.(LocalVariable).getFunction() = func
and vni_1204.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
