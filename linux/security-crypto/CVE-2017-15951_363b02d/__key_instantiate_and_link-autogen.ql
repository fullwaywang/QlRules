/**
 * @name linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-__key_instantiate_and_link
 * @id cpp/linux/363b02dab09b3226f3bd1420dad9c72b79a42a76/--key-instantiate-and-link
 * @description linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-security/keys/key.c-__key_instantiate_and_link CVE-2017-15951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkey_410, Literal target_0) {
	target_0.getValue()="0"
	and not target_0.getValue()="8"
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

/*predicate func_1(Parameter vkey_410, VariableAccess target_1) {
	target_1.getTarget()=vkey_410
	and vkey_410.getIndex() = 0
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
}

*/
predicate func_2(Parameter vkey_410, Literal target_2) {
	target_2.getValue()="0"
	and not target_2.getValue()="8"
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

/*predicate func_3(Parameter vkey_410, PointerFieldAccess target_15, VariableAccess target_3) {
	target_3.getTarget()=vkey_410
	and vkey_410.getIndex() = 0
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_3.getLocation().isBefore(target_15.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_4(Parameter vkey_410, Literal target_4) {
	target_4.getValue()="0"
	and not target_4.getValue()="8"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

predicate func_5(Parameter vkey_410, AddressOfExpr target_16, AddressOfExpr target_17, Literal target_5) {
	target_5.getValue()="4"
	and not target_5.getValue()="3"
	and target_5.getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("test_and_clear_bit")
	and target_5.getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_5.getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_16.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_5.getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_6(Function func, Literal target_6) {
	target_6.getValue()="10"
	and not target_6.getValue()="8"
	and target_6.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_6.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_6.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("key *")
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Function func, Literal target_7) {
	target_7.getValue()="10"
	and not target_7.getValue()="8"
	and target_7.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_7.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_7.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("key *")
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vkey_410, Literal target_8) {
	target_8.getValue()="10"
	and not target_8.getValue()="8"
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

predicate func_9(Parameter vkey_410, ExprStmt target_18, Literal target_9) {
	target_9.getValue()="4"
	and not target_9.getValue()="3"
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("wake_up_bit")
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_18.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_10(Parameter vkey_410, BlockStmt target_19, AddressOfExpr target_20) {
exists(EqualityOperation target_10 |
	target_10.getLeftOperand().(PointerFieldAccess).getTarget().getName()="state"
	and target_10.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_10.getParent().(IfStmt).getThen()=target_19
	and target_10.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_11(Parameter vkey_410, EqualityOperation target_21, AddressOfExpr target_22, AddressOfExpr target_16) {
exists(ExprStmt target_11 |
	target_11.getExpr().(FunctionCall).getTarget().hasName("mark_key_instantiated")
	and target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkey_410
	and target_11.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_22.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_16.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_12(Parameter vkey_410, PointerFieldAccess target_12) {
	target_12.getTarget().getName()="flags"
	and target_12.getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_12.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_12.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(0) instanceof Literal
}

predicate func_13(Parameter vkey_410, PointerFieldAccess target_13) {
	target_13.getTarget().getName()="flags"
	and target_13.getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_13.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_13.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(0) instanceof Literal
}

predicate func_14(Parameter vkey_410, BlockStmt target_19, NotExpr target_14) {
	target_14.getOperand().(ConditionalExpr).getCondition().(Literal).getValue()="1"
	and target_14.getOperand().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_14.getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(0) instanceof Literal
	and target_14.getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_14.getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_14.getOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_14.getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0) instanceof Literal
	and target_14.getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_14.getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_14.getParent().(IfStmt).getThen()=target_19
}

predicate func_15(Parameter vkey_410, PointerFieldAccess target_15) {
	target_15.getTarget().getName()="instantiate"
	and target_15.getQualifier().(ValueFieldAccess).getTarget().getName()="type"
	and target_15.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_15.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_15.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

predicate func_16(Parameter vkey_410, AddressOfExpr target_16) {
	target_16.getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_16.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof Literal
}

predicate func_17(Parameter vkey_410, AddressOfExpr target_17) {
	target_17.getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_17.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_17.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof Literal
}

predicate func_18(Parameter vkey_410, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="expiry"
	and target_18.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_18.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="expiry"
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("key_preparsed_payload *")
}

predicate func_19(Parameter vkey_410, BlockStmt target_19) {
	target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="instantiate"
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vkey_410
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("key_preparsed_payload *")
}

predicate func_20(Parameter vkey_410, AddressOfExpr target_20) {
	target_20.getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
	and target_20.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_20.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(0) instanceof Literal
}

predicate func_21(Function func, EqualityOperation target_21) {
	target_21.getLeftOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getRightOperand().(Literal).getValue()="0"
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Parameter vkey_410, AddressOfExpr target_22) {
	target_22.getOperand().(PointerFieldAccess).getTarget().getName()="nikeys"
	and target_22.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="user"
	and target_22.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_410
}

from Function func, Parameter vkey_410, Literal target_0, Literal target_2, Literal target_4, Literal target_5, Literal target_6, Literal target_7, Literal target_8, Literal target_9, PointerFieldAccess target_12, PointerFieldAccess target_13, NotExpr target_14, PointerFieldAccess target_15, AddressOfExpr target_16, AddressOfExpr target_17, ExprStmt target_18, BlockStmt target_19, AddressOfExpr target_20, EqualityOperation target_21, AddressOfExpr target_22
where
func_0(vkey_410, target_0)
and func_2(vkey_410, target_2)
and func_4(vkey_410, target_4)
and func_5(vkey_410, target_16, target_17, target_5)
and func_6(func, target_6)
and func_7(func, target_7)
and func_8(vkey_410, target_8)
and func_9(vkey_410, target_18, target_9)
and not func_10(vkey_410, target_19, target_20)
and not func_11(vkey_410, target_21, target_22, target_16)
and func_12(vkey_410, target_12)
and func_13(vkey_410, target_13)
and func_14(vkey_410, target_19, target_14)
and func_15(vkey_410, target_15)
and func_16(vkey_410, target_16)
and func_17(vkey_410, target_17)
and func_18(vkey_410, target_18)
and func_19(vkey_410, target_19)
and func_20(vkey_410, target_20)
and func_21(func, target_21)
and func_22(vkey_410, target_22)
and vkey_410.getType().hasName("key *")
and vkey_410.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
