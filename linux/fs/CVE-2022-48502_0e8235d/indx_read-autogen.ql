/**
 * @name linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-indx_read
 * @id cpp/linux/0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b/indx-read
 * @description linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-indx_read CVE-2022-48502
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vni_955, Parameter vvbn_955, Variable verr_958, Variable vib_959, Variable vbytes_963, ValueFieldAccess target_1, ValueFieldAccess target_2, BinaryBitwiseOperation target_3, IfStmt target_4, EqualityOperation target_5, AddressOfExpr target_6, AddressOfExpr target_7, ExprStmt target_8, RelationalOperation target_9, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("index_buf_check")
		and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vib_959
		and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbytes_963
		and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vvbn_955
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ntfs_inode_printk")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="vfs_inode"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="3directory corrupted"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ntfs_set_state")
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="sbi"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_958
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_3.getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
		and target_4.getCondition().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getAnOperand().(VariableAccess).getLocation())
		and target_6.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_9.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vni_955, ValueFieldAccess target_1) {
		target_1.getTarget().getName()="sbi"
		and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
}

predicate func_2(Parameter vni_955, ValueFieldAccess target_2) {
		target_2.getTarget().getName()="sbi"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
}

predicate func_3(Parameter vvbn_955, BinaryBitwiseOperation target_3) {
		target_3.getLeftOperand().(VariableAccess).getTarget()=vvbn_955
		and target_3.getRightOperand().(PointerFieldAccess).getTarget().getName()="vbn2vbo_bits"
		and target_3.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("ntfs_index *")
}

predicate func_4(Variable verr_958, IfStmt target_4) {
		target_4.getCondition().(VariableAccess).getTarget()=verr_958
}

predicate func_5(Variable verr_958, BlockStmt target_10, EqualityOperation target_5) {
		target_5.getAnOperand().(VariableAccess).getTarget()=verr_958
		and target_5.getAnOperand().(UnaryMinusExpr).getValue()="-555"
		and target_5.getParent().(IfStmt).getThen()=target_10
}

predicate func_6(Parameter vni_955, Variable vib_959, Variable vbytes_963, AddressOfExpr target_6) {
		target_6.getOperand().(PointerFieldAccess).getTarget().getName()="rhdr"
		and target_6.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vib_959
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ntfs_read_bh")
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="sbi"
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("runs_tree *")
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u64")
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vbytes_963
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nb"
		and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("indx_node *")
}

predicate func_7(Parameter vni_955, Variable vib_959, AddressOfExpr target_7) {
		target_7.getOperand().(PointerFieldAccess).getTarget().getName()="rhdr"
		and target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vib_959
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ntfs_write_bh")
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="sbi"
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nb"
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("indx_node *")
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
}

predicate func_8(Parameter vni_955, Variable verr_958, Variable vib_959, Variable vbytes_963, Function func, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_958
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ntfs_read_bh")
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="sbi"
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("runs_tree *")
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u64")
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rhdr"
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vib_959
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vbytes_963
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nb"
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("indx_node *")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vib_959, Variable vbytes_963, RelationalOperation target_9) {
		 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="24"
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(ValueFieldAccess).getTarget().getName()="used"
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ihdr"
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vib_959
		and target_9.getLesserOperand().(VariableAccess).getTarget()=vbytes_963
}

predicate func_10(Parameter vni_955, Variable vib_959, BlockStmt target_10) {
		target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ntfs_write_bh")
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="sbi"
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mi"
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vni_955
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rhdr"
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vib_959
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nb"
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("indx_node *")
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
}

from Function func, Parameter vni_955, Parameter vvbn_955, Variable verr_958, Variable vib_959, Variable vbytes_963, ValueFieldAccess target_1, ValueFieldAccess target_2, BinaryBitwiseOperation target_3, IfStmt target_4, EqualityOperation target_5, AddressOfExpr target_6, AddressOfExpr target_7, ExprStmt target_8, RelationalOperation target_9, BlockStmt target_10
where
not func_0(vni_955, vvbn_955, verr_958, vib_959, vbytes_963, target_1, target_2, target_3, target_4, target_5, target_6, target_7, target_8, target_9, func)
and func_1(vni_955, target_1)
and func_2(vni_955, target_2)
and func_3(vvbn_955, target_3)
and func_4(verr_958, target_4)
and func_5(verr_958, target_10, target_5)
and func_6(vni_955, vib_959, vbytes_963, target_6)
and func_7(vni_955, vib_959, target_7)
and func_8(vni_955, verr_958, vib_959, vbytes_963, func, target_8)
and func_9(vib_959, vbytes_963, target_9)
and func_10(vni_955, vib_959, target_10)
and vni_955.getType().hasName("ntfs_inode *")
and vvbn_955.getType().hasName("CLST")
and verr_958.getType().hasName("int")
and vib_959.getType().hasName("INDEX_BUFFER *")
and vbytes_963.getType().hasName("u32")
and vni_955.getFunction() = func
and vvbn_955.getFunction() = func
and verr_958.(LocalVariable).getFunction() = func
and vib_959.(LocalVariable).getFunction() = func
and vbytes_963.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
