/**
 * @name linux-fecf31ee395b0295f2d7260aa29946b7605f7c85-nft_set_desc_concat
 * @id cpp/linux/fecf31ee395b0295f2d7260aa29946b7605f7c85/nft-set-desc-concat
 * @description linux-fecf31ee395b0295f2d7260aa29946b7605f7c85-nft_set_desc_concat CVE-2022-2078
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vdesc_4267, ExprStmt target_5, Function func) {
	exists(ForStmt target_1 |
		target_1.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_1.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="field_count"
		and target_1.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_4267
		and target_1.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getType().hasName("int")
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getType().hasName("u32")
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(SizeofTypeOperator).getValue()="4"
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(DivExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_1.getStmt().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(DivExpr).getRightOperand().(SizeofTypeOperator).getValue()="4"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_1.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Function func) {
	exists(IfStmt target_2 |
		target_2.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u32")
		and target_2.getCondition().(RelationalOperation).getLesserOperand().(AddExpr).getValue()="16"
		and target_2.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-7"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2)
}

predicate func_5(Parameter vdesc_4267, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_set_desc_concat_parse")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("nlattr *")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdesc_4267
}

from Function func, Parameter vdesc_4267, ExprStmt target_5
where
not func_1(vdesc_4267, target_5, func)
and not func_2(func)
and func_5(vdesc_4267, target_5)
and vdesc_4267.getType().hasName("nft_set_desc *")
and vdesc_4267.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
