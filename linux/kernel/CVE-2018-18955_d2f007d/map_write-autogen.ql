/**
 * @name linux-d2f007dbe7e4c9583eea6eb04d60001e85c6f1bd-map_write
 * @id cpp/linux/d2f007dbe7e4c9583eea6eb04d60001e85c6f1bd/map-write
 * @description linux-d2f007dbe7e4c9583eea6eb04d60001e85c6f1bd-kernel/user_namespace.c-map_write CVE-2018-18955
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vret_862, IfStmt target_2, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_862
	and target_0.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-1"
	and target_2.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Parameter vparent_map_854, Variable vnew_map_858, Variable vidx_859, Variable ve_986, Variable vlower_first_987, IfStmt target_2, ForStmt target_1) {
	target_1.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vidx_859
	and target_1.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vidx_859
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="nr_extents"
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_map_858
	and target_1.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vidx_859
	and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getTarget().getName()="nr_extents"
	and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_map_858
	and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="5"
	and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_986
	and target_1.getStmt().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_986
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlower_first_987
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("map_id_range_down")
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vparent_map_854
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="lower_first"
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_986
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="count"
	and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_986
	and target_1.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vlower_first_987
	and target_1.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="4294967295"
	and target_1.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(GotoStmt).getName() ="out"
	and target_1.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="lower_first"
	and target_1.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_986
	and target_1.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vlower_first_987
	and target_2.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vret_862, Function func, IfStmt target_2) {
	target_2.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vret_862
	and target_2.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_2.getThen().(GotoStmt).getName() ="out"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

from Function func, Parameter vparent_map_854, Variable vnew_map_858, Variable vidx_859, Variable vret_862, Variable ve_986, Variable vlower_first_987, ExprStmt target_0, ForStmt target_1, IfStmt target_2
where
func_0(vret_862, target_2, target_0)
and func_1(vparent_map_854, vnew_map_858, vidx_859, ve_986, vlower_first_987, target_2, target_1)
and func_2(vret_862, func, target_2)
and vparent_map_854.getType().hasName("uid_gid_map *")
and vnew_map_858.getType().hasName("uid_gid_map")
and vidx_859.getType().hasName("unsigned int")
and vret_862.getType().hasName("ssize_t")
and ve_986.getType().hasName("uid_gid_extent *")
and vlower_first_987.getType().hasName("u32")
and vparent_map_854.getFunction() = func
and vnew_map_858.(LocalVariable).getFunction() = func
and vidx_859.(LocalVariable).getFunction() = func
and vret_862.(LocalVariable).getFunction() = func
and ve_986.(LocalVariable).getFunction() = func
and vlower_first_987.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
