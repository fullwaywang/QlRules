/**
 * @name linux-b860d3cc62877fad02863e2a08efff69a19382d2-l2tp_ip6_recvmsg
 * @id cpp/linux/b860d3cc62877fad02863e2a08efff69a19382d2/l2tp-ip6-recvmsg
 * @description linux-b860d3cc62877fad02863e2a08efff69a19382d2-net/l2tp/l2tp_ip6.c-l2tp_ip6_recvmsg CVE-2013-3230
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vlsa_656, VariableAccess target_1, ExprStmt target_2, AddressOfExpr target_3) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="l2tp_conn_id"
		and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlsa_656
		and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(5)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
		and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vlsa_656, BlockStmt target_4, VariableAccess target_1) {
		target_1.getTarget()=vlsa_656
		and target_1.getParent().(IfStmt).getThen()=target_4
}

predicate func_2(Variable vlsa_656, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="l2tp_scope_id"
		and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlsa_656
		and target_2.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_3(Variable vlsa_656, AddressOfExpr target_3) {
		target_3.getOperand().(PointerFieldAccess).getTarget().getName()="l2tp_addr"
		and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlsa_656
}

predicate func_4(Variable vlsa_656, BlockStmt target_4) {
		target_4.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="l2tp_family"
		and target_4.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlsa_656
		and target_4.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="10"
		and target_4.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="l2tp_unused"
		and target_4.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlsa_656
		and target_4.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

from Function func, Variable vlsa_656, VariableAccess target_1, ExprStmt target_2, AddressOfExpr target_3, BlockStmt target_4
where
not func_0(vlsa_656, target_1, target_2, target_3)
and func_1(vlsa_656, target_4, target_1)
and func_2(vlsa_656, target_2)
and func_3(vlsa_656, target_3)
and func_4(vlsa_656, target_4)
and vlsa_656.getType().hasName("sockaddr_l2tpip6 *")
and vlsa_656.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
