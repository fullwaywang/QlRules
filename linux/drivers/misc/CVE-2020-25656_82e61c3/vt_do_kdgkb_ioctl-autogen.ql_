/**
 * @name linux-82e61c3909db51d91b9d3e2071557b6435018b80-vt_do_kdgkb_ioctl
 * @id cpp/linux/82e61c3909db51d91b9d3e2071557b6435018b80/vt-do-kdgkb-ioctl
 * @description linux-82e61c3909db51d91b9d3e2071557b6435018b80-drivers/tty/vt/keyboard.c-vt_do_kdgkb_ioctl CVE-2020-25656
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr() instanceof ConditionalExpr
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Parameter vuser_kdgkb_1995, Variable vfrom_2026, FunctionCall target_1) {
	target_1.getTarget().hasName("strlen")
	and not target_1.getTarget().hasName("strlcpy")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vfrom_2026
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vuser_kdgkb_1995
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vfrom_2026
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getCondition().(FunctionCall).getArgument(2) instanceof AddExpr
}

predicate func_4(Variable vflags_2004, ExprStmt target_18) {
exists(DoStmt target_4 |
	target_4.getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_2004
	and target_4.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_4.getLocation().isBefore(target_18.getLocation()))
}

predicate func_6(Variable vkbs_1997, ExprStmt target_18, ExprStmt target_19) {
exists(ExprStmt target_6 |
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("ssize_t")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("strlcpy")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkbs_1997
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1) instanceof ConditionalExpr
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("ssize_t")
	and target_6.getLocation().isBefore(target_18.getLocation())
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_7(Variable vkbs_1997, ExprStmt target_19) {
exists(PointerFieldAccess target_7 |
	target_7.getTarget().getName()="kb_string"
	and target_7.getQualifier().(VariableAccess).getTarget()=vkbs_1997
	and target_7.getQualifier().(VariableAccess).getLocation().isBefore(target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_9(Variable vflags_2004, ExprStmt target_18) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("spinlock_t")
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_2004
	and target_9.getLocation().isBefore(target_18.getLocation()))
}

predicate func_10(Parameter vuser_kdgkb_1995, Variable vkbs_1997, Variable vret_2003, ExprStmt target_18, ExprStmt target_21) {
exists(ExprStmt target_10 |
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_2003
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vuser_kdgkb_1995
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkbs_1997
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand().(VariableAccess).getType().hasName("ssize_t")
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(2).(AddExpr).getRightOperand() instanceof Literal
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(UnaryMinusExpr).getValue()="-14"
	and target_10.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_10.getLocation().isBefore(target_18.getLocation())
	and target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

/*predicate func_12(Parameter vuser_kdgkb_1995, Variable vfrom_2026) {
exists(AddExpr target_12 |
	target_12.getLeftOperand().(VariableAccess).getType().hasName("ssize_t")
	and target_12.getRightOperand() instanceof Literal
	and target_12.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_12.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vuser_kdgkb_1995
	and target_12.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vfrom_2026
	and target_12.getParent().(FunctionCall).getArgument(2) instanceof AddExpr)
}

*/
predicate func_13(Variable vi_2002, Variable vfunc_table, ConditionalExpr target_13) {
	target_13.getCondition().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vfunc_table
	and target_13.getCondition().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_2002
	and target_13.getElse().(StringLiteral).getValue()=""
}

predicate func_16(Parameter vuser_kdgkb_1995, Variable vfrom_2026, AddExpr target_17, VariableAccess target_16) {
	target_16.getTarget()=vfrom_2026
	and target_16.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_16.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vuser_kdgkb_1995
	and target_16.getParent().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand() instanceof FunctionCall
	and target_16.getParent().(FunctionCall).getArgument(2).(AddExpr).getRightOperand() instanceof Literal
}

predicate func_17(Function func, AddExpr target_17) {
	target_17.getLeftOperand() instanceof FunctionCall
	and target_17.getRightOperand() instanceof Literal
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Parameter vuser_kdgkb_1995, Variable vret_2003, Variable vfrom_2026, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_2003
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vuser_kdgkb_1995
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vfrom_2026
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(2) instanceof AddExpr
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(UnaryMinusExpr).getValue()="-14"
	and target_18.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

predicate func_19(Variable vkbs_1997, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(ConditionalExpr).getCondition().(VariableAccess).getTarget().getType().hasName("u_char *")
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(ConditionalExpr).getThen().(UnaryMinusExpr).getOperand().(FunctionCall).getTarget().hasName("strlen")
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(ConditionalExpr).getThen().(UnaryMinusExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("u_char *")
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(ConditionalExpr).getElse().(Literal).getValue()="1"
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(FunctionCall).getTarget().hasName("strlen")
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="kb_string"
	and target_19.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkbs_1997
}

predicate func_21(Variable vret_2003, ExprStmt target_21) {
	target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_2003
	and target_21.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-14"
}

from Function func, Parameter vuser_kdgkb_1995, Variable vkbs_1997, Variable vi_2002, Variable vret_2003, Variable vflags_2004, Variable vfrom_2026, Variable vfunc_table, Initializer target_0, FunctionCall target_1, ConditionalExpr target_13, VariableAccess target_16, AddExpr target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_21
where
func_0(func, target_0)
and func_1(vuser_kdgkb_1995, vfrom_2026, target_1)
and not func_4(vflags_2004, target_18)
and not func_6(vkbs_1997, target_18, target_19)
and not func_9(vflags_2004, target_18)
and not func_10(vuser_kdgkb_1995, vkbs_1997, vret_2003, target_18, target_21)
and func_13(vi_2002, vfunc_table, target_13)
and func_16(vuser_kdgkb_1995, vfrom_2026, target_17, target_16)
and func_17(func, target_17)
and func_18(vuser_kdgkb_1995, vret_2003, vfrom_2026, target_18)
and func_19(vkbs_1997, target_19)
and func_21(vret_2003, target_21)
and vuser_kdgkb_1995.getType().hasName("kbsentry *")
and vkbs_1997.getType().hasName("kbsentry *")
and vi_2002.getType().hasName("int")
and vret_2003.getType().hasName("int")
and vflags_2004.getType().hasName("unsigned long")
and vfrom_2026.getType().hasName("unsigned char *")
and vfunc_table.getType() instanceof ArrayType
and vuser_kdgkb_1995.getFunction() = func
and vkbs_1997.(LocalVariable).getFunction() = func
and vi_2002.(LocalVariable).getFunction() = func
and vret_2003.(LocalVariable).getFunction() = func
and vflags_2004.(LocalVariable).getFunction() = func
and vfrom_2026.(LocalVariable).getFunction() = func
and not vfunc_table.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
