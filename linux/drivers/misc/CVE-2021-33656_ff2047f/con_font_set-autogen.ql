/**
 * @name linux-ff2047fb755d4415ec3c70ac799889371151796d-con_font_set
 * @id cpp/linux/ff2047fb755d4415ec3c70ac799889371151796d/con-font-set
 * @description linux-ff2047fb755d4415ec3c70ac799889371151796d-drivers/tty/vt/vt.c-con_font_set CVE-2021-33656
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vop_4611, ReturnStmt target_14) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand() instanceof LogicalOrExpr
	and target_0.getRightOperand() instanceof NotExpr
	and target_0.getParent().(LogicalOrExpr).getLeftOperand() instanceof LogicalOrExpr
	and target_0.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_0.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_0.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_0.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_14)
}

predicate func_1(Variable vfont_4613, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="data"
	and target_1.getQualifier().(VariableAccess).getTarget()=vfont_4613
}

predicate func_2(Parameter vop_4611, ReturnStmt target_14, LogicalOrExpr target_2) {
	target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="width"
	and target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_2.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="width"
	and target_2.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_2.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_2.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_2.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_14
}

predicate func_3(Parameter vop_4611, BlockStmt target_15, NotExpr target_3) {
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_3.getParent().(IfStmt).getThen()=target_15
}

predicate func_4(Parameter vop_4611, Variable vfont_4613, Variable vh_4634, Variable vi_4634, Variable vcharmap_4635, Function func, IfStmt target_4) {
	target_4.getCondition() instanceof NotExpr
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2147483648"
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof ValueFieldAccess
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vh_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="32"
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vh_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getUpdate().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vh_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="charcount"
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_4634
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getStmt().(IfStmt).getCondition().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vcharmap_4635
	and target_4.getThen().(BlockStmt).getStmt(3).(ForStmt).getStmt().(ForStmt).getStmt().(IfStmt).getThen().(GotoStmt).getName() ="nonzero"
	and target_4.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_4.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="data"
	and target_4.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4613
	and target_4.getThen().(BlockStmt).getStmt(5).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_4.getThen().(BlockStmt).getStmt(6).(LabelStmt).getName() ="nonzero"
	and target_4.getThen().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="height"
	and target_4.getThen().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_4.getThen().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vh_4634
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(NotExpr target_3, Function func, DeclStmt target_5) {
	target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_5.getEnclosingFunction() = func
}

predicate func_6(NotExpr target_3, Function func, DeclStmt target_6) {
	target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_6.getEnclosingFunction() = func
}

/*predicate func_7(Parameter vop_4611, NotExpr target_3, IfStmt target_7) {
	target_7.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_7.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_7.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2147483648"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof ValueFieldAccess
	and target_7.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
/*predicate func_8(NotExpr target_16, Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_8.getExpr().(FunctionCall).getArgument(0) instanceof ValueFieldAccess
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(NotExpr target_16, Function func, ReturnStmt target_9) {
	target_9.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(Parameter vop_4611, Variable vh_4634, Variable vi_4634, Variable vcharmap_4635, NotExpr target_3, ForStmt target_10) {
	target_10.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vh_4634
	and target_10.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="32"
	and target_10.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vh_4634
	and target_10.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_10.getUpdate().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vh_4634
	and target_10.getStmt().(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_4634
	and target_10.getStmt().(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_10.getStmt().(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_4634
	and target_10.getStmt().(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="charcount"
	and target_10.getStmt().(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_10.getStmt().(ForStmt).getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_4634
	and target_10.getStmt().(ForStmt).getStmt().(IfStmt).getCondition().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vcharmap_4635
	and target_10.getStmt().(ForStmt).getStmt().(IfStmt).getCondition().(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vh_4634
	and target_10.getStmt().(ForStmt).getStmt().(IfStmt).getCondition().(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
	and target_10.getStmt().(ForStmt).getStmt().(IfStmt).getThen().(GotoStmt).getName() ="nonzero"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
/*predicate func_11(Variable vfont_4613, NotExpr target_3, ValueFieldAccess target_1, ExprStmt target_17, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_11.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="data"
	and target_11.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4613
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_11.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_11.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_12(NotExpr target_3, Function func, ReturnStmt target_12) {
	target_12.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_12.getEnclosingFunction() = func
}

*/
/*predicate func_13(Parameter vop_4611, Variable vh_4634, NotExpr target_3, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="height"
	and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_13.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vh_4634
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
predicate func_14(LogicalOrExpr target_18, Function func, ReturnStmt target_14) {
	target_14.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_14.getParent().(IfStmt).getCondition()=target_18
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, BlockStmt target_15) {
	target_15.getStmt(2) instanceof IfStmt
	and target_15.getStmt(3) instanceof ForStmt
	and target_15.getStmt(4) instanceof ExprStmt
	and target_15.getStmt(5) instanceof ReturnStmt
	and target_15.getStmt(6) instanceof LabelStmt
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, NotExpr target_16) {
	target_16.getOperand() instanceof BitwiseAndExpr
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Parameter vop_4611, Variable vfont_4613, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="charcount"
	and target_17.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4613
	and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="charcount"
	and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
}

predicate func_18(Parameter vop_4611, LogicalOrExpr target_18) {
	target_18.getLeftOperand() instanceof LogicalOrExpr
	and target_18.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_18.getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4611
	and target_18.getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
}

from Function func, Parameter vop_4611, Variable vfont_4613, Variable vh_4634, Variable vi_4634, Variable vcharmap_4635, ValueFieldAccess target_1, LogicalOrExpr target_2, NotExpr target_3, IfStmt target_4, DeclStmt target_5, DeclStmt target_6, ReturnStmt target_14, BlockStmt target_15, NotExpr target_16, ExprStmt target_17, LogicalOrExpr target_18
where
not func_0(vop_4611, target_14)
and func_1(vfont_4613, target_1)
and func_2(vop_4611, target_14, target_2)
and func_3(vop_4611, target_15, target_3)
and func_4(vop_4611, vfont_4613, vh_4634, vi_4634, vcharmap_4635, func, target_4)
and func_5(target_3, func, target_5)
and func_6(target_3, func, target_6)
and func_14(target_18, func, target_14)
and func_15(func, target_15)
and func_16(func, target_16)
and func_17(vop_4611, vfont_4613, target_17)
and func_18(vop_4611, target_18)
and vop_4611.getType().hasName("console_font_op *")
and vfont_4613.getType().hasName("console_font")
and vh_4634.getType().hasName("int")
and vi_4634.getType().hasName("int")
and vcharmap_4635.getType().hasName("u8 *")
and vop_4611.getFunction() = func
and vfont_4613.(LocalVariable).getFunction() = func
and vh_4634.(LocalVariable).getFunction() = func
and vi_4634.(LocalVariable).getFunction() = func
and vcharmap_4635.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
