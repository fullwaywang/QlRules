/**
 * @name linux-dd4d747ef05addab887dc8ff0d6ab9860bbcd783-w83793_detect_subclients
 * @id cpp/linux/dd4d747ef05addab887dc8ff0d6ab9860bbcd783/w83793-detect-subclients
 * @description linux-dd4d747ef05addab887dc8ff0d6ab9860bbcd783-drivers/hwmon/w83793.c-w83793_detect_subclients CVE-2021-47384
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
	target_0.getValue()="duplicate addresses 0x%x, use force_subclients\n"
	and not target_0.getValue()="duplicate addresses 0x%x, use force_subclient\n"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="0"
	and not target_1.getValue()="72"
	and target_1.getParent().(ArrayExpr).getParent().(AssignExpr).getLValue() instanceof ArrayExpr
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="0"
	and not target_2.getValue()="7"
	and target_2.getParent().(ArrayExpr).getParent().(FunctionCall).getArgument(0) instanceof ArrayExpr
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, StringLiteral target_3) {
	target_3.getValue()="duplicate addresses 0x%x, use force_subclients\n"
	and not target_3.getValue()="duplicate addresses 0x%x, use force_subclient\n"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vtmp_1567, NotExpr target_15, LogicalAndExpr target_16) {
exists(BitwiseAndExpr target_4 |
	target_4.getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_4.getRightOperand().(HexLiteral).getValue()="136"
	and target_15.getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_4.getLeftOperand().(VariableAccess).getLocation())
	and target_4.getLeftOperand().(VariableAccess).getLocation().isBefore(target_16.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_5(Variable vtmp_1567, Parameter vclient_1563, LogicalAndExpr target_16, AddExpr target_17) {
exists(AddExpr target_5 |
	target_5.getLeftOperand().(Literal).getValue()="72"
	and target_5.getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_5.getRightOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="7"
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_err")
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclient_1563
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="addr"
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier() instanceof ArrayExpr
	and target_16.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_5.getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_5.getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_17.getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_6(Variable vtmp_1567, ExprStmt target_18, NotExpr target_6) {
	target_6.getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_6.getOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="8"
	and target_6.getParent().(IfStmt).getThen()=target_18
}

predicate func_7(Variable vtmp_1567, Variable vadapter_1568, Parameter vclient_1563, FunctionCall target_7) {
	target_7.getTarget().hasName("devm_i2c_new_dummy_device")
	and target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclient_1563
	and target_7.getArgument(1).(VariableAccess).getTarget()=vadapter_1568
	and target_7.getArgument(2).(AddExpr).getLeftOperand().(HexLiteral).getValue()="72"
	and target_7.getArgument(2).(AddExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_7.getArgument(2).(AddExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="7"
	and target_7.getParent().(AssignExpr).getRValue() = target_7
	and target_7.getParent().(AssignExpr).getLValue() instanceof ArrayExpr
}

predicate func_8(LogicalAndExpr target_16, Function func, ReturnStmt target_8) {
	target_8.getExpr().(UnaryMinusExpr).getValue()="-19"
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Variable vtmp_1567, Variable vadapter_1568, Parameter vclient_1563, FunctionCall target_9) {
	target_9.getTarget().hasName("devm_i2c_new_dummy_device")
	and target_9.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_9.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclient_1563
	and target_9.getArgument(1).(VariableAccess).getTarget()=vadapter_1568
	and target_9.getArgument(2).(AddExpr).getLeftOperand().(HexLiteral).getValue()="72"
	and target_9.getArgument(2).(AddExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_9.getArgument(2).(AddExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="4"
	and target_9.getArgument(2).(AddExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="7"
	and target_9.getParent().(AssignExpr).getRValue() = target_9
	and target_9.getParent().(AssignExpr).getLValue() instanceof ArrayExpr
}

predicate func_10(Function func, DeclStmt target_10) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vdata_1569, AssignExpr target_11) {
	target_11.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="lm75"
	and target_11.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1569
	and target_11.getLValue().(ArrayExpr).getArrayOffset() instanceof Literal
	and target_11.getRValue() instanceof FunctionCall
}

predicate func_12(Variable vdata_1569, FunctionCall target_12) {
	target_12.getTarget().hasName("IS_ERR")
	and target_12.getArgument(0).(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="lm75"
	and target_12.getArgument(0).(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1569
	and target_12.getArgument(0).(ArrayExpr).getArrayOffset() instanceof Literal
}

predicate func_13(Variable vdata_1569, PointerFieldAccess target_13) {
	target_13.getTarget().getName()="addr"
	and target_13.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="lm75"
	and target_13.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1569
	and target_13.getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
}

predicate func_14(Variable vdata_1569, AssignExpr target_14) {
	target_14.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="lm75"
	and target_14.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1569
	and target_14.getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
	and target_14.getRValue() instanceof FunctionCall
}

predicate func_15(Variable vtmp_1567, NotExpr target_15) {
	target_15.getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_15.getOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="128"
}

predicate func_16(Variable vtmp_1567, LogicalAndExpr target_16) {
	target_16.getLeftOperand().(NotExpr).getOperand() instanceof FunctionCall
	and target_16.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_16.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="7"
	and target_16.getRightOperand().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_16.getRightOperand().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="4"
	and target_16.getRightOperand().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="7"
}

predicate func_17(Variable vtmp_1567, AddExpr target_17) {
	target_17.getLeftOperand().(HexLiteral).getValue()="72"
	and target_17.getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vtmp_1567
	and target_17.getRightOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="4"
	and target_17.getRightOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="7"
}

predicate func_18(Function func, ExprStmt target_18) {
	target_18.getExpr() instanceof AssignExpr
	and target_18.getEnclosingFunction() = func
}

from Function func, Variable vtmp_1567, Variable vadapter_1568, Variable vdata_1569, Parameter vclient_1563, StringLiteral target_0, Literal target_1, Literal target_2, StringLiteral target_3, NotExpr target_6, FunctionCall target_7, ReturnStmt target_8, FunctionCall target_9, DeclStmt target_10, AssignExpr target_11, FunctionCall target_12, PointerFieldAccess target_13, AssignExpr target_14, NotExpr target_15, LogicalAndExpr target_16, AddExpr target_17, ExprStmt target_18
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and not func_4(vtmp_1567, target_15, target_16)
and not func_5(vtmp_1567, vclient_1563, target_16, target_17)
and func_6(vtmp_1567, target_18, target_6)
and func_7(vtmp_1567, vadapter_1568, vclient_1563, target_7)
and func_8(target_16, func, target_8)
and func_9(vtmp_1567, vadapter_1568, vclient_1563, target_9)
and func_10(func, target_10)
and func_11(vdata_1569, target_11)
and func_12(vdata_1569, target_12)
and func_13(vdata_1569, target_13)
and func_14(vdata_1569, target_14)
and func_15(vtmp_1567, target_15)
and func_16(vtmp_1567, target_16)
and func_17(vtmp_1567, target_17)
and func_18(func, target_18)
and vtmp_1567.getType().hasName("u8")
and vadapter_1568.getType().hasName("i2c_adapter *")
and vdata_1569.getType().hasName("w83793_data *")
and vclient_1563.getType().hasName("i2c_client *")
and vtmp_1567.(LocalVariable).getFunction() = func
and vadapter_1568.(LocalVariable).getFunction() = func
and vdata_1569.(LocalVariable).getFunction() = func
and vclient_1563.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
