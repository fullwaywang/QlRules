/**
 * @name linux-b0077e269f6c152e807fdac90b58caf012cdbaab-blk_mq_submit_bio
 * @id cpp/linux/b0077e269f6c152e807fdac90b58caf012cdbaab/blk-mq-submit-bio
 * @description linux-b0077e269f6c152e807fdac90b58caf012cdbaab-block/blk-mq.c-blk_mq_submit_bio CVE-2023-52787
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(Initializer target_0 |
	target_0.getExpr().(Literal).getValue()="0"
	and target_0.getExpr().getEnclosingFunction() = func)
}

predicate func_2(Variable vplug_2949, Variable vrq_2952) {
exists(StmtExpr target_2 |
	target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cached_rq"
	and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vplug_2949
	and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cached_rq"
	and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("request *")
	and target_2.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(VariableAccess).getType().hasName("request *")
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrq_2952)
}

predicate func_3(Variable vq_2948, Variable vrq_2952, NotExpr target_24, ExprStmt target_16) {
exists(IfStmt target_3 |
	target_3.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vrq_2952
	and target_3.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="q"
	and target_3.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrq_2952
	and target_3.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vq_2948
	and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrq_2952
	and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
	and target_3.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(Parameter vbio_2946, Variable vq_2948, Variable vnr_segs_2953, NotExpr target_25, ExprStmt target_16) {
exists(IfStmt target_5 |
	target_5.getCondition().(FunctionCall).getTarget().hasName("blk_mq_attempt_bio_merge")
	and target_5.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vq_2948
	and target_5.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbio_2946
	and target_5.getCondition().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vnr_segs_2953
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_5
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
	and target_5.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_6(Parameter vbio_2946, Variable vplug_2949, Variable vrq_2952, ExprStmt target_16, ExprStmt target_26, NotExpr target_27) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("blk_mq_can_use_cached_rq")
	and target_6.getArgument(0).(VariableAccess).getTarget()=vrq_2952
	and target_6.getArgument(1).(VariableAccess).getTarget()=vplug_2949
	and target_6.getArgument(2).(VariableAccess).getTarget()=vbio_2946
	and target_6.getParent().(IfStmt).getThen() instanceof ReturnStmt
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_6.getArgument(2).(VariableAccess).getLocation())
	and target_6.getArgument(2).(VariableAccess).getLocation().isBefore(target_26.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_6.getArgument(0).(VariableAccess).getLocation().isBefore(target_27.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getLocation()))
}

predicate func_7(FunctionCall target_14, Function func) {
exists(GotoStmt target_7 |
	target_7.getName() ="done"
	and target_7.getParent().(IfStmt).getCondition()=target_14
	and target_7.getEnclosingFunction() = func)
}

predicate func_8(Variable vq_2948, NotExpr target_25) {
exists(ExprStmt target_8 |
	target_8.getExpr().(FunctionCall).getTarget().hasName("percpu_ref_get")
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="q_usage_counter"
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vq_2948
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_8
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25)
}

predicate func_9(Parameter vbio_2946, NotExpr target_25) {
exists(IfStmt target_9 |
	target_9.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("bio_queue_enter")
	and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2946
	and target_9.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(0)=target_9
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25)
}

/*predicate func_10(Parameter vbio_2946, NotExpr target_25) {
exists(NotExpr target_10 |
	target_10.getOperand().(FunctionCall).getTarget().hasName("bio_queue_enter")
	and target_10.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2946
	and target_10.getParent().(NotExpr).getOperand().(VariableAccess).getTarget()=vbio_2946
	and target_10.getParent().(NotExpr).getParent().(IfStmt).getThen() instanceof ReturnStmt
	and target_10.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_25.getOperand().(VariableAccess).getLocation()))
}

*/
predicate func_11(Parameter vbio_2946, NotExpr target_25, AddressOfExpr target_29) {
exists(IfStmt target_11 |
	target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("bio_integrity_prep")
	and target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2946
	and target_11.getThen().(GotoStmt).getName() ="fail"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(1)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
	and target_29.getOperand().(VariableAccess).getLocation().isBefore(target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_12(Parameter vbio_2946, Variable vrq_2952, BlockStmt target_30, AddressOfExpr target_29) {
exists(FunctionCall target_12 |
	target_12.getTarget().hasName("bio_integrity_prep")
	and target_12.getArgument(0).(VariableAccess).getTarget()=vbio_2946
	and target_12.getParent().(NotExpr).getOperand().(VariableAccess).getTarget()=vrq_2952
	and target_12.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_30
	and target_29.getOperand().(VariableAccess).getLocation().isBefore(target_12.getArgument(0).(VariableAccess).getLocation()))
}

*/
predicate func_13(Variable vq_2948, ExprStmt target_26, ExprStmt target_16, ExprStmt target_31, Function func) {
exists(IfStmt target_13 |
	target_13.getCondition() instanceof FunctionCall
	and target_13.getThen().(BlockStmt).getStmt(0).(LabelStmt).getName() ="fail"
	and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("blk_queue_exit")
	and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vq_2948
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
	and target_13.getLocation().isBefore(target_26.getLocation())
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_31.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_14(Variable vrq_2952, FunctionCall target_14) {
	target_14.getTarget().hasName("__builtin_expect")
	and target_14.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vrq_2952
	and target_14.getArgument(1).(Literal).getValue()="0"
	and target_14.getParent().(IfStmt).getThen() instanceof ReturnStmt
}

predicate func_15(Parameter vbio_2946, Function func, IfStmt target_15) {
	target_15.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("bio_integrity_prep")
	and target_15.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2946
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Parameter vbio_2946, Variable vq_2948, Variable vplug_2949, Variable vrq_2952, Variable vnr_segs_2953, NotExpr target_24, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrq_2952
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("blk_mq_get_new_requests")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vq_2948
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vplug_2949
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vbio_2946
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnr_segs_2953
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
}

predicate func_17(Variable vq_2948, VariableAccess target_17) {
	target_17.getTarget()=vq_2948
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_18(Variable vplug_2949, VariableAccess target_18) {
	target_18.getTarget()=vplug_2949
	and target_18.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_19(Variable vnr_segs_2953, VariableAccess target_19) {
	target_19.getTarget()=vnr_segs_2953
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_20(Variable vrq_2952, BlockStmt target_30, VariableAccess target_20) {
	target_20.getTarget()=vrq_2952
	and target_20.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_30
}

predicate func_21(Parameter vbio_2946, VariableAccess target_21) {
	target_21.getTarget()=vbio_2946
	and target_21.getParent().(NotExpr).getParent().(IfStmt).getThen() instanceof ReturnStmt
}

predicate func_22(Parameter vbio_2946, Variable vq_2948, Variable vplug_2949, Variable vrq_2952, Variable vnr_segs_2953, FunctionCall target_22) {
	target_22.getTarget().hasName("blk_mq_get_cached_request")
	and target_22.getArgument(0).(VariableAccess).getTarget()=vq_2948
	and target_22.getArgument(1).(VariableAccess).getTarget()=vplug_2949
	and target_22.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbio_2946
	and target_22.getArgument(3).(VariableAccess).getTarget()=vnr_segs_2953
	and target_22.getParent().(AssignExpr).getRValue() = target_22
	and target_22.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrq_2952
}

predicate func_24(Variable vrq_2952, NotExpr target_24) {
	target_24.getOperand().(VariableAccess).getTarget()=vrq_2952
}

predicate func_25(Parameter vbio_2946, NotExpr target_25) {
	target_25.getOperand().(VariableAccess).getTarget()=vbio_2946
}

predicate func_26(Parameter vbio_2946, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("trace_block_getrq")
	and target_26.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbio_2946
}

predicate func_27(Variable vrq_2952, NotExpr target_27) {
	target_27.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vrq_2952
}

predicate func_29(Parameter vbio_2946, AddressOfExpr target_29) {
	target_29.getOperand().(VariableAccess).getTarget()=vbio_2946
}

predicate func_30(Parameter vbio_2946, BlockStmt target_30) {
	target_30.getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vbio_2946
	and target_30.getStmt(1) instanceof ExprStmt
	and target_30.getStmt(2).(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_31(Parameter vbio_2946, Variable vq_2948, Variable vrq_2952, ExprStmt target_31) {
	target_31.getExpr().(FunctionCall).getTarget().hasName("rq_qos_track")
	and target_31.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vq_2948
	and target_31.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vrq_2952
	and target_31.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vbio_2946
}

from Function func, Parameter vbio_2946, Variable vq_2948, Variable vplug_2949, Variable vrq_2952, Variable vnr_segs_2953, FunctionCall target_14, IfStmt target_15, ExprStmt target_16, VariableAccess target_17, VariableAccess target_18, VariableAccess target_19, VariableAccess target_20, VariableAccess target_21, FunctionCall target_22, NotExpr target_24, NotExpr target_25, ExprStmt target_26, NotExpr target_27, AddressOfExpr target_29, BlockStmt target_30, ExprStmt target_31
where
not func_0(func)
and not func_2(vplug_2949, vrq_2952)
and not func_3(vq_2948, vrq_2952, target_24, target_16)
and not func_5(vbio_2946, vq_2948, vnr_segs_2953, target_25, target_16)
and not func_6(vbio_2946, vplug_2949, vrq_2952, target_16, target_26, target_27)
and not func_7(target_14, func)
and not func_8(vq_2948, target_25)
and not func_9(vbio_2946, target_25)
and not func_11(vbio_2946, target_25, target_29)
and not func_13(vq_2948, target_26, target_16, target_31, func)
and func_14(vrq_2952, target_14)
and func_15(vbio_2946, func, target_15)
and func_16(vbio_2946, vq_2948, vplug_2949, vrq_2952, vnr_segs_2953, target_24, target_16)
and func_17(vq_2948, target_17)
and func_18(vplug_2949, target_18)
and func_19(vnr_segs_2953, target_19)
and func_20(vrq_2952, target_30, target_20)
and func_21(vbio_2946, target_21)
and func_22(vbio_2946, vq_2948, vplug_2949, vrq_2952, vnr_segs_2953, target_22)
and func_24(vrq_2952, target_24)
and func_25(vbio_2946, target_25)
and func_26(vbio_2946, target_26)
and func_27(vrq_2952, target_27)
and func_29(vbio_2946, target_29)
and func_30(vbio_2946, target_30)
and func_31(vbio_2946, vq_2948, vrq_2952, target_31)
and vbio_2946.getType().hasName("bio *")
and vq_2948.getType().hasName("request_queue *")
and vplug_2949.getType().hasName("blk_plug *")
and vrq_2952.getType().hasName("request *")
and vnr_segs_2953.getType().hasName("unsigned int")
and vbio_2946.getFunction() = func
and vq_2948.(LocalVariable).getFunction() = func
and vplug_2949.(LocalVariable).getFunction() = func
and vrq_2952.(LocalVariable).getFunction() = func
and vnr_segs_2953.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
