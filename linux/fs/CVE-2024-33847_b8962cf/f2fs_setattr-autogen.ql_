/**
 * @name linux-b8962cf98595d1ec62f40f23667de830567ec8bc-f2fs_setattr
 * @id cpp/linux/b8962cf98595d1ec62f40f23667de830567ec8bc/f2fs-setattr
 * @description linux-b8962cf98595d1ec62f40f23667de830567ec8bc-fs/f2fs/file.c-f2fs_setattr CVE-2024-33847
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(LogicalAndExpr target_6, Function func) {
exists(IfStmt target_0 |
	exists(BlockStmt obj_0 | obj_0=target_0.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(0)=target_0
			and obj_1.getCondition()=target_6
		)
	)
	and target_0.getCondition() instanceof NotExpr
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-95"
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(Parameter vattr_878, Variable vinode_880, LogicalAndExpr target_6, NotExpr target_7) {
exists(IfStmt target_1 |
	exists(LogicalAndExpr obj_0 | obj_0=target_1.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getLeftOperand() |
			obj_1.getTarget().hasName("is_inode_flag_set")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vinode_880
		)
		and exists(NotExpr obj_2 | obj_2=obj_0.getRightOperand() |
			exists(EqualityOperation obj_3 | obj_3=obj_2.getOperand() |
				exists(BitwiseAndExpr obj_4 | obj_4=obj_3.getLeftOperand() |
					exists(PointerFieldAccess obj_5 | obj_5=obj_4.getLeftOperand() |
						obj_5.getTarget().getName()="ia_size"
						and obj_5.getQualifier().(VariableAccess).getTarget()=vattr_878
					)
					and obj_4.getRightOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
				)
				and obj_3.getRightOperand().(Literal).getValue()="0"
			)
		)
	)
	and exists(BlockStmt obj_6 | obj_6=target_1.getParent() |
		exists(IfStmt obj_7 | obj_7=obj_6.getParent() |
			obj_7.getThen().(BlockStmt).getStmt(1)=target_1
			and obj_7.getCondition()=target_6
		)
	)
	and target_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_7.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

/*predicate func_2(Variable vinode_880, ReturnStmt target_8, NotExpr target_7) {
exists(FunctionCall target_2 |
	exists(LogicalAndExpr obj_0 | obj_0=target_2.getParent() |
		obj_0.getLeftOperand() instanceof BitwiseAndExpr
		and obj_0.getRightOperand() instanceof NotExpr
		and obj_0.getParent().(IfStmt).getThen()=target_8
	)
	and target_2.getTarget().hasName("is_inode_flag_set")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vinode_880
	and target_7.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getArgument(0).(VariableAccess).getLocation())
)
}

*/
/*predicate func_3(Parameter vattr_878, ReturnStmt target_8, NotExpr target_7, LogicalAndExpr target_6) {
exists(NotExpr target_3 |
	exists(EqualityOperation obj_0 | obj_0=target_3.getOperand() |
		exists(BitwiseAndExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLeftOperand() |
				obj_2.getTarget().getName()="ia_size"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vattr_878
			)
			and exists(SubExpr obj_3 | obj_3=obj_1.getRightOperand() |
				exists(BinaryBitwiseOperation obj_4 | obj_4=obj_3.getLeftOperand() |
					exists(PointerFieldAccess obj_5 | obj_5=obj_4.getLeftOperand() |
						obj_5.getTarget().getName()="i_cluster_size"
						and obj_5.getQualifier().(FunctionCall).getTarget().hasName("F2FS_I")
					)
					and obj_4.getRightOperand().(Literal).getValue()="12"
				)
				and obj_3.getRightOperand().(Literal).getValue()="1"
			)
		)
		and obj_0.getRightOperand().(Literal).getValue()="0"
	)
	and exists(LogicalAndExpr obj_6 | obj_6=target_3.getParent() |
		obj_6.getLeftOperand() instanceof BitwiseAndExpr
		and obj_6.getRightOperand() instanceof NotExpr
		and obj_6.getParent().(IfStmt).getThen()=target_8
	)
	and target_7.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

*/
predicate func_4(Parameter vattr_878, Variable vinode_880, ReturnStmt target_8, BitwiseAndExpr target_4) {
	exists(PointerFieldAccess obj_0 | obj_0=target_4.getLeftOperand() |
		obj_0.getTarget().getName()="ia_valid"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vattr_878
	)
	and exists(LogicalAndExpr obj_1 | obj_1=target_4.getParent() |
		exists(NotExpr obj_2 | obj_2=obj_1.getRightOperand() |
			exists(FunctionCall obj_3 | obj_3=obj_2.getOperand() |
				obj_3.getTarget().hasName("f2fs_is_compress_backend_ready")
				and obj_3.getArgument(0).(VariableAccess).getTarget()=vinode_880
			)
		)
		and obj_1.getParent().(IfStmt).getThen()=target_8
	)
	and target_4.getRightOperand().(BinaryBitwiseOperation).getValue()="8"
}

/*predicate func_5(Parameter vattr_878, Variable vinode_880, ReturnStmt target_8, NotExpr target_5) {
	exists(FunctionCall obj_0 | obj_0=target_5.getOperand() |
		obj_0.getTarget().hasName("f2fs_is_compress_backend_ready")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vinode_880
	)
	and exists(LogicalAndExpr obj_1 | obj_1=target_5.getParent() |
		exists(BitwiseAndExpr obj_2 | obj_2=obj_1.getLeftOperand() |
			exists(PointerFieldAccess obj_3 | obj_3=obj_2.getLeftOperand() |
				obj_3.getTarget().getName()="ia_valid"
				and obj_3.getQualifier().(VariableAccess).getTarget()=vattr_878
			)
			and obj_2.getRightOperand().(BinaryBitwiseOperation).getValue()="8"
		)
		and obj_1.getParent().(IfStmt).getThen()=target_8
	)
}

*/
predicate func_6(Function func, LogicalAndExpr target_6) {
	target_6.getLeftOperand() instanceof BitwiseAndExpr
	and target_6.getRightOperand() instanceof NotExpr
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Parameter vattr_878, Variable vinode_880, NotExpr target_7) {
	exists(NotExpr obj_0 | obj_0=target_7.getOperand() |
		exists(LogicalAndExpr obj_1 | obj_1=obj_0.getOperand() |
			exists(BitwiseAndExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getLeftOperand() |
					obj_3.getTarget().getName()="i_flags"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vinode_880
				)
				and obj_2.getRightOperand().(BinaryBitwiseOperation).getValue()="4"
			)
			and exists(BitwiseAndExpr obj_4 | obj_4=obj_1.getRightOperand() |
				exists(PointerFieldAccess obj_5 | obj_5=obj_4.getLeftOperand() |
					obj_5.getTarget().getName()="ia_valid"
					and obj_5.getQualifier().(VariableAccess).getTarget()=vattr_878
				)
				and obj_4.getRightOperand().(BitwiseOrExpr).getValue()="65543"
			)
		)
	)
}

predicate func_8(Function func, ReturnStmt target_8) {
	target_8.getExpr().(UnaryMinusExpr).getValue()="-95"
	and target_8.getEnclosingFunction() = func
}

from Function func, Parameter vattr_878, Variable vinode_880, BitwiseAndExpr target_4, LogicalAndExpr target_6, NotExpr target_7, ReturnStmt target_8
where
not func_0(target_6, func)
and not func_1(vattr_878, vinode_880, target_6, target_7)
and func_4(vattr_878, vinode_880, target_8, target_4)
and func_6(func, target_6)
and func_7(vattr_878, vinode_880, target_7)
and func_8(func, target_8)
and vattr_878.getType().hasName("iattr *")
and vinode_880.getType().hasName("inode *")
and vattr_878.getFunction() = func
and vinode_880.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
