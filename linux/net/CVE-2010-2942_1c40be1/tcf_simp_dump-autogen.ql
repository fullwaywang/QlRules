/**
 * @name linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-tcf_simp_dump
 * @id cpp/linux/1c40be12f7d8ca1d387510d39787b12e512a7ce8/tcf-simp-dump
 * @description linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-net/sched/act_simple.c-tcf_simp_dump CVE-2010-2942
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vd_166, ValueFieldAccess target_1) {
		target_1.getTarget().getName()="tcfc_index"
		and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_166
}

predicate func_2(Parameter vref_163, Variable vd_166, SubExpr target_2) {
		target_2.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_refcnt"
		and target_2.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_2.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_166
		and target_2.getRightOperand().(VariableAccess).getTarget()=vref_163
		and target_2.getParent().(AssignExpr).getRValue() = target_2
		and target_2.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_3(Parameter vbind_163, Variable vd_166, SubExpr target_3) {
		target_3.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_bindcnt"
		and target_3.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_3.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_166
		and target_3.getRightOperand().(VariableAccess).getTarget()=vbind_163
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_4(Variable vd_166, ValueFieldAccess target_4) {
		target_4.getTarget().getName()="tcfc_action"
		and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_166
}

predicate func_5(Variable vopt_167, Function func, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="index"
		and target_5.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_167
		and target_5.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vopt_167, Function func, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="refcnt"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_167
		and target_6.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vopt_167, Function func, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bindcnt"
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_167
		and target_7.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vopt_167, Function func, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="action"
		and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_167
		and target_8.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

from Function func, Parameter vbind_163, Parameter vref_163, Variable vd_166, Variable vopt_167, ValueFieldAccess target_1, SubExpr target_2, SubExpr target_3, ValueFieldAccess target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8
where
func_1(vd_166, target_1)
and func_2(vref_163, vd_166, target_2)
and func_3(vbind_163, vd_166, target_3)
and func_4(vd_166, target_4)
and func_5(vopt_167, func, target_5)
and func_6(vopt_167, func, target_6)
and func_7(vopt_167, func, target_7)
and func_8(vopt_167, func, target_8)
and vbind_163.getType().hasName("int")
and vref_163.getType().hasName("int")
and vd_166.getType().hasName("tcf_defact *")
and vopt_167.getType().hasName("tc_defact")
and vbind_163.getFunction() = func
and vref_163.getFunction() = func
and vd_166.(LocalVariable).getFunction() = func
and vopt_167.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
