/**
 * @name linux-c77ec61ca0a49544ca81881cc5d5529858f7e196-f2fs_sanity_check_ckpt
 * @id cpp/linux/c77ec61ca0a49544ca81881cc5d5529858f7e196/f2fs-sanity-check-ckpt
 * @description linux-c77ec61ca0a49544ca81881cc5d5529858f7e196-fs/f2fs/super.c-f2fs_sanity_check_ckpt CVE-2018-13096
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vraw_super_2279, ExprStmt target_11, ExprStmt target_12) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_0.getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_sit"
		and target_0.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vfsmeta_2278, ExprStmt target_11, ExprStmt target_12, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
		and target_1.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getType().hasName("unsigned int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
		and target_1.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_12.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_3(Variable vraw_super_2279, ExprStmt target_13, ExprStmt target_14, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_nat"
		and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_13.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vckpt_2280, LogicalOrExpr target_15, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="sit_ver_bitmap_bytesize"
		and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vckpt_2280
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Variable vckpt_2280, Function func) {
	exists(ExprStmt target_6 |
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="nat_ver_bitmap_bytesize"
		and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vckpt_2280
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6)
}

predicate func_7(Variable vraw_super_2279, ExprStmt target_16, Function func) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="log_blocks_per_seg"
		and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
		and target_16.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_8(Parameter vsbi_2276, ExprStmt target_17, NotExpr target_18, Function func) {
	exists(IfStmt target_8 |
		target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(DivExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(DivExpr).getRightOperand().(Literal).getValue()="2"
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getRightOperand().(Literal).getValue()="8"
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(DivExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(DivExpr).getRightOperand().(Literal).getValue()="2"
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_8.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(DivExpr).getRightOperand().(Literal).getValue()="8"
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("f2fs_msg")
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sb"
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_2276
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="3"
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="Wrong bitmap size: sit: %u, nat:%u"
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getType().hasName("unsigned int")
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getType().hasName("unsigned int")
		and target_8.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
		and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_18.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_9(Variable vfsmeta_2278, Variable vraw_super_2279, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="segment_count_sit"
		and target_9.getQualifier().(VariableAccess).getTarget()=vraw_super_2279
		and target_9.getParent().(AssignAddExpr).getRValue() = target_9
		and target_9.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
}

predicate func_10(Variable vfsmeta_2278, Variable vraw_super_2279, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="segment_count_nat"
		and target_10.getQualifier().(VariableAccess).getTarget()=vraw_super_2279
		and target_10.getParent().(AssignAddExpr).getRValue() = target_10
		and target_10.getParent().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
}

predicate func_11(Variable vfsmeta_2278, Variable vraw_super_2279, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_ckpt"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
}

predicate func_12(Variable vfsmeta_2278, Variable vraw_super_2279, ExprStmt target_12) {
		target_12.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
		and target_12.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_nat"
		and target_12.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
}

predicate func_13(Variable vfsmeta_2278, Variable vraw_super_2279, ExprStmt target_13) {
		target_13.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
		and target_13.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_sit"
		and target_13.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
}

predicate func_14(Variable vfsmeta_2278, Variable vraw_super_2279, ExprStmt target_14) {
		target_14.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vfsmeta_2278
		and target_14.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_ssa"
		and target_14.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
}

predicate func_15(Variable vckpt_2280, LogicalOrExpr target_15) {
		target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="cur_data_segno"
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vckpt_2280
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_15.getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="cur_data_blkoff"
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vckpt_2280
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_15.getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_16(Variable vraw_super_2279, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_16.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="segment_count_main"
		and target_16.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vraw_super_2279
}

predicate func_17(Parameter vsbi_2276, ExprStmt target_17) {
		target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="blocks_per_seg"
		and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_2276
}

predicate func_18(Parameter vsbi_2276, NotExpr target_18) {
		target_18.getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("f2fs_cp_error")
		and target_18.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsbi_2276
}

from Function func, Parameter vsbi_2276, Variable vfsmeta_2278, Variable vraw_super_2279, Variable vckpt_2280, PointerFieldAccess target_9, PointerFieldAccess target_10, ExprStmt target_11, ExprStmt target_12, ExprStmt target_13, ExprStmt target_14, LogicalOrExpr target_15, ExprStmt target_16, ExprStmt target_17, NotExpr target_18
where
not func_0(vraw_super_2279, target_11, target_12)
and not func_1(vfsmeta_2278, target_11, target_12, func)
and not func_3(vraw_super_2279, target_13, target_14, func)
and not func_5(vckpt_2280, target_15, func)
and not func_6(vckpt_2280, func)
and not func_7(vraw_super_2279, target_16, func)
and not func_8(vsbi_2276, target_17, target_18, func)
and func_9(vfsmeta_2278, vraw_super_2279, target_9)
and func_10(vfsmeta_2278, vraw_super_2279, target_10)
and func_11(vfsmeta_2278, vraw_super_2279, target_11)
and func_12(vfsmeta_2278, vraw_super_2279, target_12)
and func_13(vfsmeta_2278, vraw_super_2279, target_13)
and func_14(vfsmeta_2278, vraw_super_2279, target_14)
and func_15(vckpt_2280, target_15)
and func_16(vraw_super_2279, target_16)
and func_17(vsbi_2276, target_17)
and func_18(vsbi_2276, target_18)
and vsbi_2276.getType().hasName("f2fs_sb_info *")
and vfsmeta_2278.getType().hasName("unsigned int")
and vraw_super_2279.getType().hasName("f2fs_super_block *")
and vckpt_2280.getType().hasName("f2fs_checkpoint *")
and vsbi_2276.getFunction() = func
and vfsmeta_2278.(LocalVariable).getFunction() = func
and vraw_super_2279.(LocalVariable).getFunction() = func
and vckpt_2280.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
