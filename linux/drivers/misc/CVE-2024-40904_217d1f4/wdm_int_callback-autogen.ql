/**
 * @name linux-217d1f44fff560b3995a685a60aa66e55a7f0f56-wdm_int_callback
 * @id cpp/linux/217d1f44fff560b3995a685a60aa66e55a7f0f56/wdm-int-callback
 * @description linux-217d1f44fff560b3995a685a60aa66e55a7f0f56-drivers/usb/class/cdc-wdm.c-wdm_int_callback CVE-2024-40904
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(VariableAccess target_4, Function func) {
exists(DoStmt target_0 |
	exists(BlockStmt obj_0 | obj_0=target_0.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(1) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("___ratelimit")
				and obj_2.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ratelimit_state")
				and obj_2.getArgument(1).(VariableAccess).getType().hasName("const char[17]")
			)
			and obj_1.getThen() instanceof ExprStmt
		)
	)
	and target_0.getCondition().(Literal).getValue()="0"
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_4
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(RelationalOperation target_5, Function func) {
exists(DoStmt target_1 |
	exists(BlockStmt obj_0 | obj_0=target_1.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(1) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("___ratelimit")
				and obj_2.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ratelimit_state")
				and obj_2.getArgument(1).(VariableAccess).getType().hasName("const char[17]")
			)
			and obj_1.getThen() instanceof ExprStmt
		)
	)
	and exists(BlockStmt obj_3 | obj_3=target_1.getParent() |
		exists(IfStmt obj_4 | obj_4=obj_3.getParent() |
			obj_4.getThen().(BlockStmt).getStmt(0)=target_1
			and obj_4.getCondition()=target_5
		)
	)
	and target_1.getCondition().(Literal).getValue()="0"
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(Variable vstatus_237, Variable vdesc_238, VariableAccess target_4, ExprStmt target_2) {
	exists(FunctionCall obj_0 | obj_0=target_2.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="intf"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vdesc_238
				)
				and obj_2.getTarget().getName()="dev"
			)
		)
		and obj_0.getTarget().hasName("_dev_err")
		and obj_0.getArgument(1).(StringLiteral).getValue()="nonzero urb status received: %d\n"
		and obj_0.getArgument(2).(VariableAccess).getTarget()=vstatus_237
	)
	and target_2.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_4
}

predicate func_3(Parameter vurb_232, Variable vdesc_238, RelationalOperation target_5, ExprStmt target_3) {
	exists(FunctionCall obj_0 | obj_0=target_3.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="intf"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vdesc_238
				)
				and obj_2.getTarget().getName()="dev"
			)
		)
		and exists(PointerFieldAccess obj_4 | obj_4=obj_0.getArgument(2) |
			obj_4.getTarget().getName()="actual_length"
			and obj_4.getQualifier().(VariableAccess).getTarget()=vurb_232
		)
		and obj_0.getTarget().hasName("_dev_err")
		and obj_0.getArgument(1).(StringLiteral).getValue()="wdm_int_callback - %d bytes\n"
	)
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

predicate func_4(Variable vstatus_237, VariableAccess target_4) {
	target_4.getTarget()=vstatus_237
}

predicate func_5(Parameter vurb_232, RelationalOperation target_5) {
	exists(PointerFieldAccess obj_0 | obj_0=target_5.getLesserOperand() |
		obj_0.getTarget().getName()="actual_length"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vurb_232
	)
	and exists(SizeofTypeOperator obj_1 | obj_1=target_5.getGreaterOperand() |
		obj_1.getType() instanceof LongType
		and obj_1.getValue()="8"
	)
	and  (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
}

from Function func, Parameter vurb_232, Variable vstatus_237, Variable vdesc_238, ExprStmt target_2, ExprStmt target_3, VariableAccess target_4, RelationalOperation target_5
where
not func_0(target_4, func)
and not func_1(target_5, func)
and func_2(vstatus_237, vdesc_238, target_4, target_2)
and func_3(vurb_232, vdesc_238, target_5, target_3)
and func_4(vstatus_237, target_4)
and func_5(vurb_232, target_5)
and vurb_232.getType().hasName("urb *")
and vstatus_237.getType().hasName("int")
and vdesc_238.getType().hasName("wdm_device *")
and vurb_232.getFunction() = func
and vstatus_237.(LocalVariable).getFunction() = func
and vdesc_238.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
