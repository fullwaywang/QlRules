/**
 * @name linux-bf988435bd5b53529f4408a8efb1f433f6ddfda9-ethtool_set_rxnfc
 * @id cpp/linux/bf988435bd5b53529f4408a8efb1f433f6ddfda9/ethtool-set-rxnfc
 * @description linux-bf988435bd5b53529f4408a8efb1f433f6ddfda9-net/core/ethtool.c-ethtool_set_rxnfc CVE-2010-2478
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

/*predicate func_0(Parameter vuseraddr_321, Variable vcmd_323, VariableAccess target_0) {
		target_0.getTarget()=vcmd_323
		and target_0.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
		and target_0.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vuseraddr_321
		and target_0.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="192"
}

*/
predicate func_1(Parameter vuseraddr_321, Variable vcmd_323, VariableAccess target_1) {
		target_1.getTarget()=vcmd_323
		and target_1.getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
		and target_1.getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcmd_323
		and target_1.getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vuseraddr_321
		and target_1.getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="192"
}

predicate func_2(Variable vcmd_323, VariableAccess target_2) {
		target_2.getTarget()=vcmd_323
		and target_2.getParent().(AddressOfExpr).getParent().(VariableCall).getParent().(ReturnStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="set_rxnfc"
		and target_2.getParent().(AddressOfExpr).getParent().(VariableCall).getParent().(ReturnStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ethtool_ops"
		and target_2.getParent().(AddressOfExpr).getParent().(VariableCall).getParent().(ReturnStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("net_device *")
		and target_2.getParent().(AddressOfExpr).getParent().(VariableCall).getParent().(ReturnStmt).getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net_device *")
}

predicate func_3(Variable vcmd_323, ReturnStmt target_7, AddressOfExpr target_9) {
	exists(EqualityOperation target_3 |
		target_3.getAnOperand().(VariableAccess).getTarget()=vcmd_323
		and target_3.getAnOperand().(Literal).getValue()="42"
		and target_3.getParent().(IfStmt).getThen()=target_7
		and target_3.getAnOperand().(VariableAccess).getLocation().isBefore(target_9.getOperand().(VariableAccess).getLocation()))
}

predicate func_4(FunctionCall target_10, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_4.getExpr().(AssignExpr).getRValue().(AddExpr).getValue()="16"
		and target_4.getParent().(IfStmt).getCondition()=target_10
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Parameter vuseraddr_321, Function func) {
	exists(IfStmt target_5 |
		target_5.getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
		and target_5.getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ethtool_rxnfc")
		and target_5.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vuseraddr_321
		and target_5.getCondition().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("size_t")
		and target_5.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-14"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5)
}

predicate func_7(Function func, ReturnStmt target_7) {
		target_7.getExpr().(UnaryMinusExpr).getValue()="-14"
		and target_7.getEnclosingFunction() = func
}

predicate func_9(Parameter vuseraddr_321, Variable vcmd_323, ReturnStmt target_7, AddressOfExpr target_9) {
		target_9.getOperand().(VariableAccess).getTarget()=vcmd_323
		and target_9.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vuseraddr_321
		and target_9.getParent().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="192"
		and target_9.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_7
}

predicate func_10(Parameter vuseraddr_321, Variable vcmd_323, FunctionCall target_10) {
		target_10.getTarget().hasName("copy_from_user")
		and target_10.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcmd_323
		and target_10.getArgument(1).(VariableAccess).getTarget()=vuseraddr_321
		and target_10.getArgument(2).(SizeofExprOperator).getValue()="192"
}

from Function func, Parameter vuseraddr_321, Variable vcmd_323, VariableAccess target_1, VariableAccess target_2, ReturnStmt target_7, AddressOfExpr target_9, FunctionCall target_10
where
func_1(vuseraddr_321, vcmd_323, target_1)
and func_2(vcmd_323, target_2)
and not func_3(vcmd_323, target_7, target_9)
and not func_4(target_10, func)
and not func_5(vuseraddr_321, func)
and func_7(func, target_7)
and func_9(vuseraddr_321, vcmd_323, target_7, target_9)
and func_10(vuseraddr_321, vcmd_323, target_10)
and vuseraddr_321.getType().hasName("void *")
and vcmd_323.getType().hasName("ethtool_rxnfc")
and vuseraddr_321.getFunction() = func
and vcmd_323.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
