/**
 * @name linux-24a9799aa8efecd0eb55a75e35f9d8e6400063aa-cifs_mark_tcp_ses_conns_for_reconnect
 * @id cpp/linux/24a9799aa8efecd0eb55a75e35f9d8e6400063aa/cifs-mark-tcp-ses-conns-for-reconnect
 * @description linux-24a9799aa8efecd0eb55a75e35f9d8e6400063aa-fs/smb/client/connect.c-cifs_mark_tcp_ses_conns_for_reconnect CVE-2024-35870
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vses_208, ExprStmt target_5, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_5.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vses_208, ExprStmt target_6, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_6.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vses_208, IfStmt target_7, AddressOfExpr target_8, EqualityOperation target_9) {
exists(IfStmt target_2 |
	target_2.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ses_status"
	and target_2.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_2.getLocation().isBefore(target_7.getLocation())
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Variable vses_208, ForStmt target_10, ExprStmt target_6, AddressOfExpr target_11) {
exists(ExprStmt target_3 |
	target_3.getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_3.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_3.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_3.getLocation().isBefore(target_10.getLocation())
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Variable vses_208, ForStmt target_10, AddressOfExpr target_11, PointerFieldAccess target_12) {
exists(ExprStmt target_4 |
	target_4.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_4.getLocation().isBefore(target_10.getLocation())
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vses_208, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="chan_lock"
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
}

predicate func_6(Variable vses_208, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="ses_status"
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
}

predicate func_7(Variable vses_208, IfStmt target_7) {
	target_7.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("cifs_ses_get_chan_index")
	and target_7.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vses_208
	and target_7.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("TCP_Server_Info *")
	and target_7.getCondition().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="-1"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="chan_lock"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
}

predicate func_8(Variable vses_208, AddressOfExpr target_8) {
	target_8.getOperand().(PointerFieldAccess).getTarget().getName()="chan_lock"
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
}

predicate func_9(Variable vses_208, EqualityOperation target_9) {
	target_9.getLeftOperand().(FunctionCall).getTarget().hasName("cifs_ses_get_chan_index")
	and target_9.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vses_208
	and target_9.getLeftOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("TCP_Server_Info *")
	and target_9.getRightOperand().(UnaryMinusExpr).getValue()="-1"
}

predicate func_10(Variable vses_208, ForStmt target_10) {
	target_10.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("cifs_tcon *")
	and target_10.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_is_head")
	and target_10.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tcon_list"
	and target_10.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("cifs_tcon *")
	and target_10.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tcon_list"
	and target_10.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
	and target_10.getUpdate().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("cifs_tcon *")
	and target_10.getUpdate().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("void *")
	and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="need_reconnect"
	and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("cifs_tcon *")
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tc_lock"
	and target_10.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("cifs_tcon *")
}

predicate func_11(Variable vses_208, AddressOfExpr target_11) {
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="ses_lock"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
}

predicate func_12(Variable vses_208, PointerFieldAccess target_12) {
	target_12.getTarget().getName()="next"
	and target_12.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tcon_list"
	and target_12.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vses_208
}

from Function func, Variable vses_208, ExprStmt target_0, ExprStmt target_1, ExprStmt target_5, ExprStmt target_6, IfStmt target_7, AddressOfExpr target_8, EqualityOperation target_9, ForStmt target_10, AddressOfExpr target_11, PointerFieldAccess target_12
where
func_0(vses_208, target_5, target_0)
and func_1(vses_208, target_6, target_1)
and not func_2(vses_208, target_7, target_8, target_9)
and not func_3(vses_208, target_10, target_6, target_11)
and not func_4(vses_208, target_10, target_11, target_12)
and func_5(vses_208, target_5)
and func_6(vses_208, target_6)
and func_7(vses_208, target_7)
and func_8(vses_208, target_8)
and func_9(vses_208, target_9)
and func_10(vses_208, target_10)
and func_11(vses_208, target_11)
and func_12(vses_208, target_12)
and vses_208.getType().hasName("cifs_ses *")
and vses_208.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
