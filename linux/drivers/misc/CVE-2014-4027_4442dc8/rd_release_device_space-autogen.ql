/**
 * @name linux-4442dc8a92b8f9ad8ee9e7f8438f4c04c03a22dc-rd_release_device_space
 * @id cpp/linux/4442dc8a92b8f9ad8ee9e7f8438f4c04c03a22dc/rd-release-device-space
 * @description linux-4442dc8a92b8f9ad8ee9e7f8438f4c04c03a22dc-drivers/target/target_core_rd.c-rd_release_device_space CVE-2014-4027
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_87, Parameter vrd_dev_85, PointerFieldAccess target_25) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("rd_release_sgl_table")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vrd_dev_85
	and target_0.getArgument(1).(PointerFieldAccess).getTarget().getName()="sg_table_array"
	and target_0.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrd_dev_85
	and target_0.getArgument(2).(PointerFieldAccess).getTarget().getName()="sg_table_count"
	and target_0.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrd_dev_85
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_87
	and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_25.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vsg_table_88, Parameter vrd_dev_85, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="sg_table_array"
	and target_1.getQualifier().(VariableAccess).getTarget()=vrd_dev_85
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsg_table_88
}

predicate func_2(Variable vi_87, Parameter vrd_dev_85, BlockStmt target_26, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="sg_table_count"
	and target_2.getQualifier().(VariableAccess).getTarget()=vrd_dev_85
	and target_2.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vi_87
	and target_2.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_26
}

predicate func_3(Variable vpage_count_87, VariableAccess target_3) {
	target_3.getTarget()=vpage_count_87
}

predicate func_6(Function func, Initializer target_6) {
	target_6.getExpr().(Literal).getValue()="0"
	and target_6.getExpr().getEnclosingFunction() = func
}

predicate func_8(Function func, DeclStmt target_8) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Function func, DeclStmt target_9) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Function func, DeclStmt target_10) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vsg_table_88, Parameter vrd_dev_85, AssignExpr target_11) {
	target_11.getLValue().(VariableAccess).getTarget()=vsg_table_88
	and target_11.getRValue().(PointerFieldAccess).getTarget().getName()="sg_table_array"
	and target_11.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrd_dev_85
}

predicate func_12(Variable vi_87, Variable vj_87, Variable vsg_per_table_87, Variable vsg_table_88, Variable vpg_89, Variable vsg_90, Parameter vrd_dev_85, Function func, ForStmt target_12) {
	target_12.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_87
	and target_12.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_12.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_87
	and target_12.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="sg_table_count"
	and target_12.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrd_dev_85
	and target_12.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_87
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsg_90
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="sg_table"
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsg_table_88
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsg_per_table_87
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="rd_sg_count"
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsg_table_88
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_87
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vj_87
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vsg_per_table_87
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vj_87
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpg_89
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sg_page")
	and target_12.getStmt().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vpg_89
	and target_12.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_12.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsg_90
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

/*predicate func_13(Variable vi_87, VariableAccess target_13) {
	target_13.getTarget()=vi_87
	and target_13.getParent().(AssignExpr).getLValue() = target_13
	and target_13.getParent().(AssignExpr).getRValue().(Literal).getValue()="0"
}

*/
/*predicate func_15(Variable vi_87, Variable vsg_table_88, Variable vsg_90, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsg_90
	and target_15.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="sg_table"
	and target_15.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsg_table_88
	and target_15.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
}

*/
/*predicate func_16(Variable vi_87, Variable vsg_per_table_87, Variable vsg_table_88, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsg_per_table_87
	and target_16.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="rd_sg_count"
	and target_16.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsg_table_88
	and target_16.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
}

*/
/*predicate func_17(Variable vj_87, Variable vpage_count_87, Variable vsg_per_table_87, Variable vpg_89, ForStmt target_17) {
	target_17.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_87
	and target_17.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_17.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vj_87
	and target_17.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vsg_per_table_87
	and target_17.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vj_87
	and target_17.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpg_89
	and target_17.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sg_page")
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vpg_89
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__free_pages")
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpg_89
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vpage_count_87
}

*/
/*predicate func_18(Variable vj_87, Variable vpg_89, Variable vsg_90, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpg_89
	and target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sg_page")
	and target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vsg_90
	and target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vj_87
}

*/
/*predicate func_19(Variable vpage_count_87, Variable vpg_89, IfStmt target_19) {
	target_19.getCondition().(VariableAccess).getTarget()=vpg_89
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__free_pages")
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpg_89
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_19.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vpage_count_87
}

*/
/*predicate func_20(Variable vpg_89, VariableAccess target_28, ExprStmt target_20) {
	target_20.getExpr().(FunctionCall).getTarget().hasName("__free_pages")
	and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpg_89
	and target_20.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_28
}

*/
/*predicate func_21(Variable vpage_count_87, VariableAccess target_28, ExprStmt target_21) {
	target_21.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vpage_count_87
	and target_21.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_28
}

*/
/*predicate func_22(Variable vsg_90, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsg_90
}

*/
predicate func_23(Variable vsg_table_88, Function func, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_23.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsg_table_88
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_23
}

predicate func_25(Parameter vrd_dev_85, PointerFieldAccess target_25) {
	target_25.getTarget().getName()="rd_host_id"
	and target_25.getQualifier().(PointerFieldAccess).getTarget().getName()="rd_host"
	and target_25.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrd_dev_85
}

predicate func_26(Function func, BlockStmt target_26) {
	target_26.getStmt(0) instanceof ExprStmt
	and target_26.getStmt(1) instanceof ExprStmt
	and target_26.getStmt(2) instanceof ForStmt
	and target_26.getStmt(3) instanceof ExprStmt
	and target_26.getEnclosingFunction() = func
}

predicate func_28(Variable vpg_89, BlockStmt target_29, VariableAccess target_28) {
	target_28.getTarget()=vpg_89
	and target_28.getParent().(IfStmt).getThen()=target_29
}

predicate func_29(Function func, BlockStmt target_29) {
	target_29.getStmt(0) instanceof ExprStmt
	and target_29.getStmt(1) instanceof ExprStmt
	and target_29.getEnclosingFunction() = func
}

from Function func, Variable vi_87, Variable vj_87, Variable vpage_count_87, Variable vsg_per_table_87, Variable vsg_table_88, Variable vpg_89, Variable vsg_90, Parameter vrd_dev_85, PointerFieldAccess target_1, PointerFieldAccess target_2, VariableAccess target_3, Initializer target_6, DeclStmt target_8, DeclStmt target_9, DeclStmt target_10, AssignExpr target_11, ForStmt target_12, ExprStmt target_23, PointerFieldAccess target_25, BlockStmt target_26, VariableAccess target_28, BlockStmt target_29
where
not func_0(vi_87, vrd_dev_85, target_25)
and func_1(vsg_table_88, vrd_dev_85, target_1)
and func_2(vi_87, vrd_dev_85, target_26, target_2)
and func_3(vpage_count_87, target_3)
and func_6(func, target_6)
and func_8(func, target_8)
and func_9(func, target_9)
and func_10(func, target_10)
and func_11(vsg_table_88, vrd_dev_85, target_11)
and func_12(vi_87, vj_87, vsg_per_table_87, vsg_table_88, vpg_89, vsg_90, vrd_dev_85, func, target_12)
and func_23(vsg_table_88, func, target_23)
and func_25(vrd_dev_85, target_25)
and func_26(func, target_26)
and func_28(vpg_89, target_29, target_28)
and func_29(func, target_29)
and vi_87.getType().hasName("u32")
and vj_87.getType().hasName("u32")
and vpage_count_87.getType().hasName("u32")
and vsg_per_table_87.getType().hasName("u32")
and vsg_table_88.getType().hasName("rd_dev_sg_table *")
and vpg_89.getType().hasName("page *")
and vsg_90.getType().hasName("scatterlist *")
and vrd_dev_85.getType().hasName("rd_dev *")
and vi_87.(LocalVariable).getFunction() = func
and vj_87.(LocalVariable).getFunction() = func
and vpage_count_87.(LocalVariable).getFunction() = func
and vsg_per_table_87.(LocalVariable).getFunction() = func
and vsg_table_88.(LocalVariable).getFunction() = func
and vpg_89.(LocalVariable).getFunction() = func
and vsg_90.(LocalVariable).getFunction() = func
and vrd_dev_85.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
