/**
 * @name libtiff-be4c85b16e8801a16eec25e80eb9f3dd6a96731b-TIFFPrintDirectory
 * @id cpp/libtiff/be4c85b16e8801a16eec25e80eb9f3dd6a96731b/tiffprintdirectory
 * @description libtiff-be4c85b16e8801a16eec25e80eb9f3dd6a96731b-libtiff/tif_print.c-TIFFPrintDirectory CVE-2018-7456
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtd_236, Variable vi_544, ExprStmt target_3, RelationalOperation target_4) {
	exists(LogicalAndExpr target_0 |
		target_0.getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_544
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="td_extrasamples"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_544
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="3"
		and target_0.getParent().(ForStmt).getStmt()=target_3
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_1(Variable vtd_236, Variable vi_544, ExprStmt target_3, RelationalOperation target_4) {
	exists(SubExpr target_1 |
		target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_1.getRightOperand().(PointerFieldAccess).getTarget().getName()="td_extrasamples"
		and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_1.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vi_544
		and target_1.getParent().(LTExpr).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_1.getParent().(LTExpr).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_1.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_3
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_2(Variable vtd_236, Variable vi_544, ExprStmt target_3, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="td_samplesperpixel"
		and target_2.getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_2.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vi_544
		and target_2.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_3
}

predicate func_3(Variable vtd_236, Variable vi_544, ExprStmt target_3) {
		target_3.getExpr().(FunctionCall).getTarget().hasName("fprintf")
		and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("FILE *")
		and target_3.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()=" %5u"
		and target_3.getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="td_transferfunction"
		and target_3.getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
		and target_3.getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_544
		and target_3.getExpr().(FunctionCall).getArgument(2).(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("long")
}

predicate func_4(Variable vtd_236, Variable vi_544, RelationalOperation target_4) {
		 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
		and target_4.getLesserOperand().(VariableAccess).getTarget()=vi_544
		and target_4.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="td_samplesperpixel"
		and target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_236
}

from Function func, Variable vtd_236, Variable vi_544, PointerFieldAccess target_2, ExprStmt target_3, RelationalOperation target_4
where
not func_0(vtd_236, vi_544, target_3, target_4)
and func_2(vtd_236, vi_544, target_3, target_2)
and func_3(vtd_236, vi_544, target_3)
and func_4(vtd_236, vi_544, target_4)
and vtd_236.getType().hasName("TIFFDirectory *")
and vi_544.getType().hasName("uint16")
and vtd_236.(LocalVariable).getFunction() = func
and vi_544.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
