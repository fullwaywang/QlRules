/**
 * @name libtiff-b5c7d4c4e03333ac16b5cfb11acaaeaa493334f8-main
 * @id cpp/libtiff/b5c7d4c4e03333ac16b5cfb11acaaeaa493334f8/main
 * @description libtiff-b5c7d4c4e03333ac16b5cfb11acaaeaa493334f8-tools/tiffcrop.c-main CVE-2023-3618
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(RelationalOperation target_3, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition() instanceof FunctionCall
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("TIFFError")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="main"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Unable to write new image selections"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("exit")
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="1"
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
		and target_0.getEnclosingFunction() = func)
}

/*predicate func_1(Function func) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("TIFFError")
		and target_1.getArgument(0).(StringLiteral).getValue()="main"
		and target_1.getArgument(1).(StringLiteral).getValue()="Unable to write new image selections"
		and target_1.getEnclosingFunction() = func)
}

*/
predicate func_2(Parameter vargv_2588, Variable vin_2601, Variable vout_2602, Variable vmp_2604, Variable vimage_2607, Variable vcrop_2608, Variable vseg_buffs_2612, Variable vdump_2613, Parameter vargc_2588, Variable vnext_page_2622, Variable vtotal_pages_2623, FunctionCall target_2) {
		target_2.getTarget().hasName("writeSelections")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vin_2601
		and target_2.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vout_2602
		and target_2.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcrop_2608
		and target_2.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vimage_2607
		and target_2.getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdump_2613
		and target_2.getArgument(5).(VariableAccess).getTarget()=vseg_buffs_2612
		and target_2.getArgument(6).(VariableAccess).getTarget()=vmp_2604
		and target_2.getArgument(7).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vargv_2588
		and target_2.getArgument(7).(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vargc_2588
		and target_2.getArgument(7).(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_2.getArgument(8).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vnext_page_2622
		and target_2.getArgument(9).(VariableAccess).getTarget()=vtotal_pages_2623
}

predicate func_3(Variable vcrop_2608, BlockStmt target_4, RelationalOperation target_3) {
		 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
		and target_3.getGreaterOperand().(ValueFieldAccess).getTarget().getName()="selections"
		and target_3.getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vcrop_2608
		and target_3.getLesserOperand().(Literal).getValue()="0"
		and target_3.getParent().(IfStmt).getThen()=target_4
}

predicate func_4(Function func, BlockStmt target_4) {
		target_4.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_4.getEnclosingFunction() = func
}

from Function func, Parameter vargv_2588, Variable vin_2601, Variable vout_2602, Variable vmp_2604, Variable vimage_2607, Variable vcrop_2608, Variable vseg_buffs_2612, Variable vdump_2613, Parameter vargc_2588, Variable vnext_page_2622, Variable vtotal_pages_2623, FunctionCall target_2, RelationalOperation target_3, BlockStmt target_4
where
not func_0(target_3, func)
and func_2(vargv_2588, vin_2601, vout_2602, vmp_2604, vimage_2607, vcrop_2608, vseg_buffs_2612, vdump_2613, vargc_2588, vnext_page_2622, vtotal_pages_2623, target_2)
and func_3(vcrop_2608, target_4, target_3)
and func_4(func, target_4)
and vargv_2588.getType().hasName("char *[]")
and vin_2601.getType().hasName("TIFF *")
and vout_2602.getType().hasName("TIFF *")
and vmp_2604.getType().hasName("char *")
and vimage_2607.getType().hasName("image_data")
and vcrop_2608.getType().hasName("crop_mask")
and vseg_buffs_2612.getType().hasName("buffinfo[32]")
and vdump_2613.getType().hasName("dump_opts")
and vargc_2588.getType().hasName("int")
and vnext_page_2622.getType().hasName("unsigned int")
and vtotal_pages_2623.getType().hasName("unsigned int")
and vargv_2588.getFunction() = func
and vin_2601.(LocalVariable).getFunction() = func
and vout_2602.(LocalVariable).getFunction() = func
and vmp_2604.(LocalVariable).getFunction() = func
and vimage_2607.(LocalVariable).getFunction() = func
and vcrop_2608.(LocalVariable).getFunction() = func
and vseg_buffs_2612.(LocalVariable).getFunction() = func
and vdump_2613.(LocalVariable).getFunction() = func
and vargc_2588.getFunction() = func
and vnext_page_2622.(LocalVariable).getFunction() = func
and vtotal_pages_2623.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
