/**
 * @name linux-382c27f4ed28f803b1f1473ac2d8db0afc795a1b-__perf_event_read_size
 * @id cpp/linux/382c27f4ed28f803b1f1473ac2d8db0afc795a1b/--perf-event-read-size
 * @description linux-382c27f4ed28f803b1f1473ac2d8db0afc795a1b-kernel/events/core.c-__perf_event_read_size CVE-2023-6931
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable ventry_1819, ExprStmt target_16, VariableAccess target_0) {
	target_0.getTarget()=ventry_1819
	and target_16.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vnr_1821, ExprStmt target_17, VariableAccess target_1) {
	target_1.getTarget()=vnr_1821
	and target_17.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getLocation())
}

predicate func_7(Variable vsize_1820) {
exists(AddExpr target_7 |
	target_7.getLeftOperand().(VariableAccess).getTarget()=vsize_1820
	and target_7.getRightOperand().(MulExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_7.getRightOperand().(MulExpr).getRightOperand().(VariableAccess).getType().hasName("int"))
}

predicate func_8(Parameter vevent_1817, Variable vsize_1820, VariableAccess target_8) {
	target_8.getTarget()=vsize_1820
	and target_8.getParent().(AssignExpr).getRValue() = target_8
	and target_8.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="read_size"
	and target_8.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
}

predicate func_9(Parameter vevent_1817, ExprStmt target_18, ValueFieldAccess target_9) {
	target_9.getTarget().getName()="read_format"
	and target_9.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_9.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_9.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_18
}

predicate func_10(Parameter vevent_1817, ExprStmt target_20, ValueFieldAccess target_10) {
	target_10.getTarget().getName()="read_format"
	and target_10.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_10.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_10.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_20
}

predicate func_11(Parameter vevent_1817, ExprStmt target_23, ValueFieldAccess target_11) {
	target_11.getTarget().getName()="read_format"
	and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_11.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_23
}

predicate func_12(Parameter vevent_1817, ExprStmt target_16, ValueFieldAccess target_12) {
	target_12.getTarget().getName()="read_format"
	and target_12.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_12.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_16
}

predicate func_13(Parameter vevent_1817, BlockStmt target_28, ExprStmt target_15, ValueFieldAccess target_13) {
	target_13.getTarget().getName()="read_format"
	and target_13.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
	and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_13.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_28
	and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_14(Variable ventry_1819, Variable vsize_1820, Variable vnr_1821, Function func, ExprStmt target_14) {
	target_14.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vsize_1820
	and target_14.getExpr().(AssignAddExpr).getRValue().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=ventry_1819
	and target_14.getExpr().(AssignAddExpr).getRValue().(MulExpr).getRightOperand().(VariableAccess).getTarget()=vnr_1821
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Parameter vevent_1817, Variable vsize_1820, Function func, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="read_size"
	and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_1817
	and target_15.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsize_1820
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Variable ventry_1819, BitwiseAndExpr target_30, ExprStmt target_16) {
	target_16.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=ventry_1819
	and target_16.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
	and target_16.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getValue()="8"
	and target_16.getParent().(IfStmt).getCondition()=target_30
}

predicate func_17(Variable vnr_1821, ExprStmt target_17) {
	target_17.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vnr_1821
	and target_17.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_18(Variable vsize_1820, BitwiseAndExpr target_31, ExprStmt target_18) {
	target_18.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vsize_1820
	and target_18.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
	and target_18.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getValue()="8"
	and target_18.getParent().(IfStmt).getCondition()=target_31
}

predicate func_20(Variable vsize_1820, BitwiseAndExpr target_32, ExprStmt target_20) {
	target_20.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vsize_1820
	and target_20.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
	and target_20.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getValue()="8"
	and target_20.getParent().(IfStmt).getCondition()=target_32
}

predicate func_23(Variable ventry_1819, BitwiseAndExpr target_33, ExprStmt target_23) {
	target_23.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=ventry_1819
	and target_23.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
	and target_23.getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getValue()="8"
	and target_23.getParent().(IfStmt).getCondition()=target_33
}

predicate func_28(Variable vsize_1820, Variable vnr_1821, BlockStmt target_28) {
	target_28.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vnr_1821
	and target_28.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_28.getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vsize_1820
	and target_28.getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
	and target_28.getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(SizeofTypeOperator).getValue()="8"
}

predicate func_30(Function func, BitwiseAndExpr target_30) {
	target_30.getLeftOperand() instanceof ValueFieldAccess
	and target_30.getEnclosingFunction() = func
}

predicate func_31(Function func, BitwiseAndExpr target_31) {
	target_31.getLeftOperand() instanceof ValueFieldAccess
	and target_31.getEnclosingFunction() = func
}

predicate func_32(Function func, BitwiseAndExpr target_32) {
	target_32.getLeftOperand() instanceof ValueFieldAccess
	and target_32.getEnclosingFunction() = func
}

predicate func_33(Function func, BitwiseAndExpr target_33) {
	target_33.getLeftOperand() instanceof ValueFieldAccess
	and target_33.getEnclosingFunction() = func
}

from Function func, Parameter vevent_1817, Variable ventry_1819, Variable vsize_1820, Variable vnr_1821, VariableAccess target_0, VariableAccess target_1, VariableAccess target_8, ValueFieldAccess target_9, ValueFieldAccess target_10, ValueFieldAccess target_11, ValueFieldAccess target_12, ValueFieldAccess target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_20, ExprStmt target_23, BlockStmt target_28, BitwiseAndExpr target_30, BitwiseAndExpr target_31, BitwiseAndExpr target_32, BitwiseAndExpr target_33
where
func_0(ventry_1819, target_16, target_0)
and func_1(vnr_1821, target_17, target_1)
and not func_7(vsize_1820)
and func_8(vevent_1817, vsize_1820, target_8)
and func_9(vevent_1817, target_18, target_9)
and func_10(vevent_1817, target_20, target_10)
and func_11(vevent_1817, target_23, target_11)
and func_12(vevent_1817, target_16, target_12)
and func_13(vevent_1817, target_28, target_15, target_13)
and func_14(ventry_1819, vsize_1820, vnr_1821, func, target_14)
and func_15(vevent_1817, vsize_1820, func, target_15)
and func_16(ventry_1819, target_30, target_16)
and func_17(vnr_1821, target_17)
and func_18(vsize_1820, target_31, target_18)
and func_20(vsize_1820, target_32, target_20)
and func_23(ventry_1819, target_33, target_23)
and func_28(vsize_1820, vnr_1821, target_28)
and func_30(func, target_30)
and func_31(func, target_31)
and func_32(func, target_32)
and func_33(func, target_33)
and vevent_1817.getType().hasName("perf_event *")
and ventry_1819.getType().hasName("int")
and vsize_1820.getType().hasName("int")
and vnr_1821.getType().hasName("int")
and vevent_1817.getFunction() = func
and ventry_1819.(LocalVariable).getFunction() = func
and vsize_1820.(LocalVariable).getFunction() = func
and vnr_1821.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
