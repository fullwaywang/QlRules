/**
 * @name linux-ca465e1f1f9b38fe916a36f7d80c5d25f2337c81-cma_cancel_listens
 * @id cpp/linux/ca465e1f1f9b38fe916a36f7d80c5d25f2337c81/cma-cancel-listens
 * @description linux-ca465e1f1f9b38fe916a36f7d80c5d25f2337c81-drivers/infiniband/core/cma.c-cma_cancel_listens CVE-2021-47392
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vid_priv_1749, FunctionCall target_0) {
	target_0.getTarget().hasName("list_del")
	and not target_0.getTarget().hasName("_cma_cancel_listens")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vid_priv_1749
}

predicate func_1(Variable vlock, AddressOfExpr target_1) {
	target_1.getOperand().(VariableAccess).getTarget()=vlock
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_2(Parameter vid_priv_1749, VariableAccess target_2) {
	target_2.getTarget()=vid_priv_1749
	and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Parameter vid_priv_1749, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="list"
	and target_4.getQualifier().(VariableAccess).getTarget()=vid_priv_1749
}

predicate func_5(Variable vdev_id_priv_1751, Variable vlock, Parameter vid_priv_1749, Function func, WhileStmt target_5) {
	target_5.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_5.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="listen_list"
	and target_5.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vid_priv_1749
	and target_5.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdev_id_priv_1751
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_del_init")
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_del")
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="listen_list"
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_5.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("rdma_destroy_id")
	and target_5.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id"
	and target_5.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
	and target_5.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_5.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlock
	and target_5.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

/*predicate func_6(Variable vdev_id_priv_1751, Variable v__mptr_1761, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdev_id_priv_1751
	and target_6.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_6.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1761
}

*/
/*predicate func_8(Function func, DoStmt target_8) {
	target_8.getCondition().(Literal).getValue()="0"
	and target_8.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_10(Function func, IfStmt target_10) {
	target_10.getCondition().(NotExpr).getValue()="0"
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Variable v__mptr_1761, ExprStmt target_11) {
	target_11.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1761
	and target_11.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="496"
}

*/
/*predicate func_12(Variable vdev_id_priv_1751, ExprStmt target_12) {
	target_12.getExpr().(FunctionCall).getTarget().hasName("list_del_init")
	and target_12.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
	and target_12.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
}

*/
/*predicate func_13(Variable vdev_id_priv_1751, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("list_del")
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="listen_list"
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
}

*/
/*predicate func_14(Function func, ExprStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_14.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_15(Variable vdev_id_priv_1751, ExprStmt target_15) {
	target_15.getExpr().(FunctionCall).getTarget().hasName("rdma_destroy_id")
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id"
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_id_priv_1751
}

*/
/*predicate func_16(Variable vlock, AddressOfExpr target_1, AddressOfExpr target_17, ExprStmt target_16) {
	target_16.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlock
	and target_16.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_1.getOperand().(VariableAccess).getLocation().isBefore(target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_17.getOperand().(VariableAccess).getLocation())
}

*/
predicate func_17(Variable vlock, AddressOfExpr target_17) {
	target_17.getOperand().(VariableAccess).getTarget()=vlock
	and target_17.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
}

from Function func, Variable vdev_id_priv_1751, Variable vlock, Variable v__mptr_1761, Parameter vid_priv_1749, FunctionCall target_0, AddressOfExpr target_1, VariableAccess target_2, DeclStmt target_3, PointerFieldAccess target_4, WhileStmt target_5, AddressOfExpr target_17
where
func_0(vid_priv_1749, target_0)
and func_1(vlock, target_1)
and func_2(vid_priv_1749, target_2)
and func_3(func, target_3)
and func_4(vid_priv_1749, target_4)
and func_5(vdev_id_priv_1751, vlock, vid_priv_1749, func, target_5)
and func_17(vlock, target_17)
and vdev_id_priv_1751.getType().hasName("rdma_id_private *")
and vlock.getType().hasName("mutex")
and v__mptr_1761.getType().hasName("void *")
and vid_priv_1749.getType().hasName("rdma_id_private *")
and vdev_id_priv_1751.(LocalVariable).getFunction() = func
and not vlock.getParentScope+() = func
and v__mptr_1761.(LocalVariable).getFunction() = func
and vid_priv_1749.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
