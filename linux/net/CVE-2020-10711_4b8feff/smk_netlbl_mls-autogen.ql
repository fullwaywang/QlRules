/**
 * @name linux-4b8feff251da3d7058b5779e21b33a85c686b974-smk_netlbl_mls
 * @id cpp/linux/4b8feff251da3d7058b5779e21b33a85c686b974/smk-netlbl-mls
 * @description linux-4b8feff251da3d7058b5779e21b33a85c686b974-security/smack/smack_access.c-smk_netlbl_mls CVE-2020-10711
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsap_427, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="attr"
		and target_0.getQualifier().(VariableAccess).getTarget()=vsap_427
}

predicate func_1(Parameter vsap_427, PointerFieldAccess target_1) {
		target_1.getTarget().getName()="attr"
		and target_1.getQualifier().(VariableAccess).getTarget()=vsap_427
}

predicate func_3(Parameter vsap_427, FunctionCall target_3) {
		target_3.getTarget().hasName("netlbl_secattr_catmap_alloc")
		and target_3.getArgument(0).(Literal).getValue()="32"
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="cat"
		and target_3.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="mls"
		and target_3.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_3.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsap_427
}

predicate func_4(Parameter vsap_427, Function func, IfStmt target_4) {
		target_4.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cat"
		and target_4.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="mls"
		and target_4.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_4.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsap_427
		and target_4.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Parameter vsap_427, Function func, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="startbit"
		and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="cat"
		and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="mls"
		and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsap_427
		and target_5.getExpr().(AssignExpr).getRValue() instanceof Literal
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

from Function func, Parameter vsap_427, PointerFieldAccess target_0, PointerFieldAccess target_1, FunctionCall target_3, IfStmt target_4, ExprStmt target_5
where
func_0(vsap_427, target_0)
and func_1(vsap_427, target_1)
and func_3(vsap_427, target_3)
and func_4(vsap_427, func, target_4)
and func_5(vsap_427, func, target_5)
and vsap_427.getType().hasName("netlbl_lsm_secattr *")
and vsap_427.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
