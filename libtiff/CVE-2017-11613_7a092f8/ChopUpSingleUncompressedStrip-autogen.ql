/**
 * @name libtiff-7a092f8af2568d61993a8cc2e7a35a998d7d37be-ChopUpSingleUncompressedStrip
 * @id cpp/libtiff/7a092f8af2568d61993a8cc2e7a35a998d7d37be/chopupsingleuncompressedstrip
 * @description libtiff-7a092f8af2568d61993a8cc2e7a35a998d7d37be-libtiff/tif_dirread.c-ChopUpSingleUncompressedStrip CVE-2017-11613
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
		target_0.getValue()="0"
		and not target_0.getValue()="1"
		and target_0.getParent().(ArrayExpr).getParent().(GEExpr).getGreaterOperand() instanceof ArrayExpr
		and target_0.getEnclosingFunction() = func
}

predicate func_3(Variable voffset_5650, Variable vnstrips_5655, Parameter vtif_5646, ExprStmt target_8, LogicalAndExpr target_9, ExprStmt target_10) {
	exists(DivExpr target_3 |
		target_3.getLeftOperand().(SubExpr).getLeftOperand().(ExprCall).getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tif_sizeproc"
		and target_3.getLeftOperand().(SubExpr).getLeftOperand().(ExprCall).getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_3.getLeftOperand().(SubExpr).getLeftOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tif_clientdata"
		and target_3.getLeftOperand().(SubExpr).getLeftOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_3.getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=voffset_5650
		and target_3.getRightOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vnstrips_5655
		and target_3.getRightOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_3.getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(VariableAccess).getLocation())
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_3.getRightOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation())
		and target_3.getRightOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_5(Parameter vtif_5646, LogicalAndExpr target_9, ArrayExpr target_5) {
		target_5.getArrayBase().(ValueFieldAccess).getTarget().getName()="td_stripoffset"
		and target_5.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tif_dir"
		and target_5.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_5.getArrayOffset() instanceof Literal
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_6(Parameter vtif_5646, ArrayExpr target_6) {
		target_6.getArrayBase().(ValueFieldAccess).getTarget().getName()="td_stripbytecount"
		and target_6.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tif_dir"
		and target_6.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_6.getArrayOffset().(Literal).getValue()="0"
}

predicate func_7(Parameter vtif_5646, ExprStmt target_10, ArrayExpr target_7) {
		target_7.getArrayBase().(ValueFieldAccess).getTarget().getName()="td_stripoffset"
		and target_7.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tif_dir"
		and target_7.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_7.getArrayOffset().(Literal).getValue()="0"
		and target_7.getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_8(Variable voffset_5650, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("uint64 *")
		and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("uint32")
		and target_8.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(VariableAccess).getTarget().getType().hasName("uint64")
		and target_8.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(VariableAccess).getTarget()=voffset_5650
		and target_8.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

predicate func_9(Variable vnstrips_5655, Parameter vtif_5646, LogicalAndExpr target_9) {
		target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="tif_mode"
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vnstrips_5655
		and target_9.getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1000000"
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand() instanceof ArrayExpr
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ExprCall).getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tif_sizeproc"
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ExprCall).getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tif_clientdata"
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand() instanceof ArrayExpr
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand().(ExprCall).getExpr().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tif_sizeproc"
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tif_clientdata"
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand().(ExprCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtif_5646
		and target_9.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(SubExpr).getRightOperand() instanceof ArrayExpr
}

predicate func_10(Variable vnstrips_5655, Parameter vtif_5646, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("uint64 *")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_TIFFCheckMalloc")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtif_5646
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnstrips_5655
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="8"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(StringLiteral).getValue()="for chopped \"StripByteCounts\" array"
}

from Function func, Variable voffset_5650, Variable vnstrips_5655, Parameter vtif_5646, Literal target_0, ArrayExpr target_5, ArrayExpr target_6, ArrayExpr target_7, ExprStmt target_8, LogicalAndExpr target_9, ExprStmt target_10
where
func_0(func, target_0)
and not func_3(voffset_5650, vnstrips_5655, vtif_5646, target_8, target_9, target_10)
and func_5(vtif_5646, target_9, target_5)
and func_6(vtif_5646, target_6)
and func_7(vtif_5646, target_10, target_7)
and func_8(voffset_5650, target_8)
and func_9(vnstrips_5655, vtif_5646, target_9)
and func_10(vnstrips_5655, vtif_5646, target_10)
and voffset_5650.getType().hasName("uint64")
and vnstrips_5655.getType().hasName("uint32")
and vtif_5646.getType().hasName("TIFF *")
and voffset_5650.(LocalVariable).getFunction() = func
and vnstrips_5655.(LocalVariable).getFunction() = func
and vtif_5646.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
