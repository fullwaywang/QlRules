/**
 * @name linux-5fe7f7b78290638806211046a99f031ff26164e1-ksmbd_smb2_check_message
 * @id cpp/linux/5fe7f7b78290638806211046a99f031ff26164e1/ksmbd-smb2-check-message
 * @description linux-5fe7f7b78290638806211046a99f031ff26164e1-ksmbd_smb2_check_message CVE-2023-3865
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vwork_347, Variable vhdr_350, ExprStmt target_11, FunctionCall target_12, IfStmt target_7) {
	exists(AddExpr target_1 |
		target_1.getAnOperand().(PointerFieldAccess).getTarget().getName()="next_smb2_rcv_hdr_off"
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_347
		and target_1.getAnOperand().(VariableAccess).getType().hasName("__u32")
		and target_1.getParent().(GTExpr).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="NextCommand"
		and target_1.getParent().(GTExpr).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_350
		and target_1.getParent().(GTExpr).getLesserOperand() instanceof Literal
		and target_1.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_11
		and target_12.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(RelationalOperation target_13, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
		and target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_printk")
		and target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="3ksmbd: next command(%u) offset exceeds smb msg size\n"
		and target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("__u32")
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_3
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(RelationalOperation target_13, Function func) {
	exists(ReturnStmt target_4 |
		target_4.getExpr().(Literal).getValue()="1"
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_4
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vlen_353, ExprStmt target_14, Function func) {
	exists(IfStmt target_5 |
		target_5.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("__u32")
		and target_5.getCondition().(RelationalOperation).getLesserOperand() instanceof Literal
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_353
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("__u32")
		and target_5.getElse() instanceof IfStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_7(Parameter vwork_347, Variable vlen_353, RelationalOperation target_13, IfStmt target_7) {
		target_7.getCondition().(PointerFieldAccess).getTarget().getName()="next_smb2_rcv_hdr_off"
		and target_7.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_347
		and target_7.getThen().(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_353
		and target_7.getThen().(ExprStmt).getExpr().(AssignSubExpr).getRValue().(PointerFieldAccess).getTarget().getName()="next_smb2_rcv_hdr_off"
		and target_7.getThen().(ExprStmt).getExpr().(AssignSubExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_347
		and target_7.getParent().(IfStmt).getCondition()=target_13
}

predicate func_8(Variable vhdr_350, ExprStmt target_11, PointerFieldAccess target_8) {
		target_8.getTarget().getName()="NextCommand"
		and target_8.getQualifier().(VariableAccess).getTarget()=vhdr_350
		and target_8.getParent().(GTExpr).getLesserOperand().(Literal).getValue()="0"
		and target_8.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_11
}

predicate func_10(Variable vhdr_350, RelationalOperation target_13, FunctionCall target_15, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="NextCommand"
		and target_10.getQualifier().(VariableAccess).getTarget()=vhdr_350
		and target_13.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getQualifier().(VariableAccess).getLocation())
		and target_10.getQualifier().(VariableAccess).getLocation().isBefore(target_15.getArgument(0).(VariableAccess).getLocation())
}

predicate func_11(Variable vhdr_350, Variable vlen_353, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_353
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="NextCommand"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_350
}

predicate func_12(Parameter vwork_347, FunctionCall target_12) {
		target_12.getTarget().hasName("get_rfc1002_len")
		and target_12.getArgument(0).(PointerFieldAccess).getTarget().getName()="request_buf"
		and target_12.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_347
}

predicate func_13(Variable vhdr_350, RelationalOperation target_13) {
		 (target_13 instanceof GTExpr or target_13 instanceof LTExpr)
		and target_13.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="NextCommand"
		and target_13.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_350
		and target_13.getLesserOperand() instanceof Literal
}

predicate func_14(Parameter vwork_347, Variable vlen_353, ExprStmt target_14) {
		target_14.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_353
		and target_14.getExpr().(AssignSubExpr).getRValue().(PointerFieldAccess).getTarget().getName()="next_smb2_rcv_hdr_off"
		and target_14.getExpr().(AssignSubExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_347
}

predicate func_15(Variable vhdr_350, FunctionCall target_15) {
		target_15.getTarget().hasName("check_smb2_hdr")
		and target_15.getArgument(0).(VariableAccess).getTarget()=vhdr_350
}

from Function func, Parameter vwork_347, Variable vhdr_350, Variable vlen_353, IfStmt target_7, PointerFieldAccess target_8, PointerFieldAccess target_10, ExprStmt target_11, FunctionCall target_12, RelationalOperation target_13, ExprStmt target_14, FunctionCall target_15
where
not func_1(vwork_347, vhdr_350, target_11, target_12, target_7)
and not func_3(target_13, func)
and not func_4(target_13, func)
and not func_5(vlen_353, target_14, func)
and func_7(vwork_347, vlen_353, target_13, target_7)
and func_8(vhdr_350, target_11, target_8)
and func_10(vhdr_350, target_13, target_15, target_10)
and func_11(vhdr_350, vlen_353, target_11)
and func_12(vwork_347, target_12)
and func_13(vhdr_350, target_13)
and func_14(vwork_347, vlen_353, target_14)
and func_15(vhdr_350, target_15)
and vwork_347.getType().hasName("ksmbd_work *")
and vhdr_350.getType().hasName("smb2_hdr *")
and vlen_353.getType().hasName("__u32")
and vwork_347.getFunction() = func
and vhdr_350.(LocalVariable).getFunction() = func
and vlen_353.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
