/**
 * @name linux-bddc0c411a45d3718ac535a070f349be8eca8d48-ieee80211_parse_tx_radiotap
 * @id cpp/linux/bddc0c411a45d3718ac535a070f349be8eca8d48/ieee80211-parse-tx-radiotap
 * @description linux-bddc0c411a45d3718ac535a070f349be8eca8d48-ieee80211_parse_tx_radiotap CVE-2021-38206
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vskb_2017, FunctionCall target_10) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("ieee80211_validate_radiotap_len")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vskb_2017
		and target_0.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
		and target_10.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Function func, DeclStmt target_2) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vsband_2025, Variable vrate_2030, Variable vi_2037, BitwiseAndExpr target_12, BlockStmt target_3) {
		target_3.getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_2037
		and target_3.getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_3.getStmt(0).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_2037
		and target_3.getStmt(0).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="n_bitrates"
		and target_3.getStmt(0).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsband_2025
		and target_3.getStmt(0).(ForStmt).getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_2037
		and target_3.getStmt(0).(ForStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vrate_2030
		and target_3.getStmt(0).(ForStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(MulExpr).getRightOperand().(Literal).getValue()="5"
		and target_3.getStmt(0).(ForStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(ValueFieldAccess).getTarget().getName()="bitrate"
		and target_3.getStmt(0).(ForStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="idx"
		and target_3.getStmt(0).(ForStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vi_2037
		and target_3.getParent().(IfStmt).getParent().(IfStmt).getCondition()=target_12
}

predicate func_4(Parameter vskb_2017, VariableAccess target_4) {
		target_4.getTarget()=vskb_2017
		and target_4.getParent().(PointerFieldAccess).getParent().(LTExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_5(Parameter vskb_2017, ReturnStmt target_13, FunctionCall target_5) {
		target_5.getTarget().hasName("__builtin_expect")
		and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="len"
		and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_2017
		and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getValue()="8"
		and target_5.getArgument(1).(Literal).getValue()="0"
		and target_5.getParent().(IfStmt).getThen()=target_13
}

/*predicate func_6(Parameter vskb_2017, NotExpr target_6) {
		target_6.getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="len"
		and target_6.getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_2017
		and target_6.getOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_6.getOperand().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getValue()="8"
		and target_6.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_6.getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

*/
predicate func_7(Variable vrthdr_2022, ReturnStmt target_8, FunctionCall target_7) {
		target_7.getTarget().hasName("__builtin_expect")
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="it_version"
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrthdr_2022
		and target_7.getArgument(1).(Literal).getValue()="0"
		and target_7.getParent().(IfStmt).getThen()=target_8
}

predicate func_8(FunctionCall target_7, Function func, ReturnStmt target_8) {
		target_8.getParent().(IfStmt).getCondition()=target_7
		and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vskb_2017, Function func, IfStmt target_9) {
		target_9.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="len"
		and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_2017
		and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getTarget().hasName("ieee80211_get_radiotap_len")
		and target_9.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="data"
		and target_9.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vrthdr_2022, Parameter vskb_2017, FunctionCall target_10) {
		target_10.getTarget().hasName("ieee80211_radiotap_iterator_init")
		and target_10.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("ieee80211_radiotap_iterator")
		and target_10.getArgument(1).(VariableAccess).getTarget()=vrthdr_2022
		and target_10.getArgument(2).(PointerFieldAccess).getTarget().getName()="len"
		and target_10.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_2017
		and target_10.getArgument(3).(Literal).getValue()="0"
}

predicate func_12(Function func, BitwiseAndExpr target_12) {
		target_12.getLeftOperand().(VariableAccess).getTarget().getType().hasName("u16")
		and target_12.getEnclosingFunction() = func
}

predicate func_13(FunctionCall target_5, Function func, ReturnStmt target_13) {
		target_13.getParent().(IfStmt).getCondition()=target_5
		and target_13.getEnclosingFunction() = func
}

from Function func, Variable vrthdr_2022, Variable vsband_2025, Variable vrate_2030, Parameter vskb_2017, Variable vi_2037, DeclStmt target_2, BlockStmt target_3, VariableAccess target_4, FunctionCall target_5, FunctionCall target_7, ReturnStmt target_8, IfStmt target_9, FunctionCall target_10, BitwiseAndExpr target_12, ReturnStmt target_13
where
not func_0(vskb_2017, target_10)
and func_2(func, target_2)
and func_3(vsband_2025, vrate_2030, vi_2037, target_12, target_3)
and func_4(vskb_2017, target_4)
and func_5(vskb_2017, target_13, target_5)
and func_7(vrthdr_2022, target_8, target_7)
and func_8(target_7, func, target_8)
and func_9(vskb_2017, func, target_9)
and func_10(vrthdr_2022, vskb_2017, target_10)
and func_12(func, target_12)
and func_13(target_5, func, target_13)
and vrthdr_2022.getType().hasName("ieee80211_radiotap_header *")
and vsband_2025.getType().hasName("ieee80211_supported_band *")
and vrate_2030.getType().hasName("u16")
and vskb_2017.getType().hasName("sk_buff *")
and vi_2037.getType().hasName("int")
and vrthdr_2022.(LocalVariable).getFunction() = func
and vsband_2025.(LocalVariable).getFunction() = func
and vrate_2030.(LocalVariable).getFunction() = func
and vskb_2017.getFunction() = func
and vi_2037.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
