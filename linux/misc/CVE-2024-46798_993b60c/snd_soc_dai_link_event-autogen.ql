/**
 * @name linux-993b60c7f93fa1d8ff296b58f646a867e945ae89-snd_soc_dai_link_event
 * @id cpp/linux/993b60c7f93fa1d8ff296b58f646a867e945ae89/snd-soc-dai-link-event
 * @description linux-993b60c7f93fa1d8ff296b58f646a867e945ae89-sound/soc/soc-dapm.c-snd_soc_dai_link_event CVE-2024-46798
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsubstream_3937, VariableAccess target_1, ExprStmt target_2, ExprStmt target_3) {
exists(ExprStmt target_0 |
	exists(AssignExpr obj_0 | obj_0=target_0.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="runtime"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vsubstream_3937
		)
		and obj_0.getRValue().(Literal).getValue()="0"
	)
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_1(Parameter vevent_3933, VariableAccess target_1) {
	target_1.getTarget()=vevent_3933
}

predicate func_2(Variable vsubstream_3937, ExprStmt target_2) {
	exists(FunctionCall obj_0 | obj_0=target_2.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getArgument(0) |
			obj_1.getTarget().getName()="runtime"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vsubstream_3937
		)
		and obj_0.getTarget().hasName("kfree")
	)
}

predicate func_3(Variable vsubstream_3937, ExprStmt target_3) {
	exists(AssignExpr obj_0 | obj_0=target_3.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="stream"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vsubstream_3937
		)
		and obj_0.getRValue().(VariableAccess).getTarget().getType().hasName("int")
	)
}

from Function func, Parameter vevent_3933, Variable vsubstream_3937, VariableAccess target_1, ExprStmt target_2, ExprStmt target_3
where
not func_0(vsubstream_3937, target_1, target_2, target_3)
and func_1(vevent_3933, target_1)
and func_2(vsubstream_3937, target_2)
and func_3(vsubstream_3937, target_3)
and vevent_3933.getType().hasName("int")
and vsubstream_3937.getType().hasName("snd_pcm_substream *")
and vevent_3933.getFunction() = func
and vsubstream_3937.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
