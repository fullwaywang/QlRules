/**
 * @name chromium-8c4aee2a90d08535cfb1bf0a59e00cae956b1762-content__ServiceWorkerDevToolsAgentHost__RenderProcessHostDestroyed_
 * @id cpp/chromium/8c4aee2a90d08535cfb1bf0a59e00cae956b1762/contentserviceworkerdevtoolsagenthostrenderprocesshostdestroyed
 * @description chromium-8c4aee2a90d08535cfb1bf0a59e00cae956b1762-content/browser/devtools/web_contents_devtools_agent_host.cc-content__ServiceWorkerDevToolsAgentHost__RenderProcessHostDestroyed_ CVE-2023-2135
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(FunctionCall target_0 |
	exists(FunctionCall obj_0 | obj_0=target_0.getArgument(0) |
		obj_0.getTarget().hasName("ForceDetachAllSessionsImpl")
		and obj_0.getQualifier() instanceof ThisExpr
	)
	and target_0.getTarget().hasName("operator=")
	and target_0.getQualifier().(VariableAccess).getType().hasName("scoped_refptr<DevToolsAgentHost>")
	and target_0.getEnclosingFunction() = func
)
}

predicate func_2(Function func, ThisExpr target_2) {
	target_2.getType() instanceof PointerType
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("ForceDetachAllSessions")
	and target_3.getQualifier() instanceof ThisExpr
	and target_3.getEnclosingFunction() = func
}

from Function func, ThisExpr target_2, FunctionCall target_3
where
not func_0(func)
and func_2(func, target_2)
and func_3(func, target_3)
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
