commit 68fbc4ce9b4fc50a13860cf199bf5125f9cb8e36	68fbc4ce9b4fc50a13860cf199bf5125f9cb8e36
Author: Jinsuk Kim <jinsukkim@chromium.org>
Date:   Tue Dec 12 00:27:29 2023 +0000

    [CCT] Clean up a feature flag kCCTPreventTouches
    
    Deletes the feature flag which is enabled by default, and the related
    code as well.
    
    Bug: 1430867
    Change-Id: I73e567967005f552610610c53022fdcb502219db
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5111939
    Code-Coverage: findit-for-me@appspot.gserviceaccount.com <findit-for-me@appspot.gserviceaccount.com>
    Reviewed-by: Sinan Sahin <sinansahin@google.com>
    Commit-Queue: Jinsuk Kim <jinsukkim@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1236054}

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabActivity.java
index 7aa678dbee663..e2cd01f2d2149 100644
--- a/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/customtabs/CustomTabActivity.java
@@ -68,7 +68,9 @@ public class CustomTabActivity extends BaseCustomTabActivity {
     public static final AllCachedFieldTrialParameters EXPERIMENTS_FOR_AGSA_PARAMS =
             new AllCachedFieldTrialParameters(ChromeFeatureList.EXPERIMENTS_FOR_AGSA);
 
-    private boolean mPreventTouchFeatureEnabled;
+    /** Prevents Tapjacking on T-. See crbug.com/1430867 */
+    private static final boolean sPreventTouches =
+            Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU;
 
     private CustomTabsOpenTimeRecorder mOpenTimeRecorder;
 
@@ -191,17 +193,9 @@ public class CustomTabActivity extends BaseCustomTabActivity {
                             && urlPackage.equals(
                                     mConnection.getClientPackageNameForSession(mSession));
                 });
-        initPreventTouchFeatureFlag();
         super.finishNativeInitialization();
     }
 
-    @VisibleForTesting(otherwise = PRIVATE)
-    void initPreventTouchFeatureFlag() {
-        mPreventTouchFeatureEnabled =
-                Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU
-                        && ChromeFeatureList.isEnabled(ChromeFeatureList.CCT_PREVENT_TOUCHES);
-    }
-
     @Override
     protected void handleFinishAndClose() {
         mOpenTimeRecorder.updateCloseCause();
@@ -293,7 +287,7 @@ public class CustomTabActivity extends BaseCustomTabActivity {
 
     @Override
     public boolean dispatchTouchEvent(MotionEvent ev) {
-        if (mPreventTouchFeatureEnabled && shouldPreventTouch(ev)) {
+        if (sPreventTouches && shouldPreventTouch(ev)) {
             // Discard the events which may be trickling down from an overlay activity above.
             return true;
         }
diff --git a/chrome/android/junit/src/org/chromium/chrome/browser/customtabs/CustomTabsFilterTouchUnitTest.java b/chrome/android/junit/src/org/chromium/chrome/browser/customtabs/CustomTabsFilterTouchUnitTest.java
index 12d662230807d..62bb27227898c 100644
--- a/chrome/android/junit/src/org/chromium/chrome/browser/customtabs/CustomTabsFilterTouchUnitTest.java
+++ b/chrome/android/junit/src/org/chromium/chrome/browser/customtabs/CustomTabsFilterTouchUnitTest.java
@@ -28,16 +28,13 @@ import org.chromium.base.ApplicationStatus;
 import org.chromium.base.test.BaseRobolectricTestRunner;
 import org.chromium.base.test.util.Batch;
 import org.chromium.base.test.util.CommandLineFlags;
-import org.chromium.chrome.browser.flags.ChromeFeatureList;
 import org.chromium.chrome.browser.flags.ChromeSwitches;
 import org.chromium.chrome.browser.multiwindow.MultiWindowUtils;
 import org.chromium.chrome.test.util.browser.Features;
-import org.chromium.chrome.test.util.browser.Features.EnableFeatures;
 
 /** Tests {@link CustomTabActivity} filters touch events from overlay activity. */
 @RunWith(BaseRobolectricTestRunner.class)
 @Batch(Batch.UNIT_TESTS)
-@EnableFeatures(ChromeFeatureList.CCT_PREVENT_TOUCHES)
 @CommandLineFlags.Add({
     ChromeSwitches.DISABLE_FIRST_RUN_EXPERIENCE,
     ChromeSwitches.DISABLE_NATIVE_INITIALIZATION
@@ -71,7 +68,6 @@ public class CustomTabsFilterTouchUnitTest {
     @Test
     @SmallTest
     public void testInjectMissingEventInMultiWindowMode() {
-        mActivity.initPreventTouchFeatureFlag();
         ApplicationStatus.onStateChangeForTesting(mActivity, ActivityState.PAUSED);
         assertTrue("Events should be consumed", mActivity.dispatchTouchEvent(mMotionEvent));
 
diff --git a/chrome/browser/about_flags.cc b/chrome/browser/about_flags.cc
index 1a7322fc0da07..b9183bdbd08d6 100644
--- a/chrome/browser/about_flags.cc
+++ b/chrome/browser/about_flags.cc
@@ -7363,9 +7363,6 @@ const FeatureEntry kFeatureEntries[] = {
      FEATURE_WITH_PARAMS_VALUE_TYPE(chrome::android::kCCTPageInsightsHub,
                                     kCCTPageInsightsHubVariations,
                                     "CCTPageInsightsHubVariations")},
-    {"cct-prevent-touches", flag_descriptions::kCCTPreventTouchesName,
-     flag_descriptions::kCCTPreventTouchesDescription, kOsAndroid,
-     FEATURE_VALUE_TYPE(chrome::android::kCCTPreventTouches)},
     {"cct-resizable-for-third-parties",
      flag_descriptions::kCCTResizableForThirdPartiesName,
      flag_descriptions::kCCTResizableForThirdPartiesDescription, kOsAndroid,
diff --git a/chrome/browser/flag_descriptions.cc b/chrome/browser/flag_descriptions.cc
index 812bfd9b8f17e..3e0dfdd975abe 100644
--- a/chrome/browser/flag_descriptions.cc
+++ b/chrome/browser/flag_descriptions.cc
@@ -3950,11 +3950,6 @@ const char kCCTPageInsightsHubName[] = "Page Insights Hub";
 const char kCCTPageInsightsHubDescription[] =
     "Show Page Insights Hub on Chrome Custom Tabs.";
 
-const char kCCTPreventTouchesName[] = "Prevent touches from overlay";
-const char kCCTPreventTouchesDescription[] =
-    "Prevent touches from being processed if they are coming from an overlay "
-    "activity.";
-
 const char kCCTResizableForThirdPartiesName[] =
     "Bottom sheet Custom Tabs (third party)";
 const char kCCTResizableForThirdPartiesDescription[] =
diff --git a/chrome/browser/flag_descriptions.h b/chrome/browser/flag_descriptions.h
index 797412802418f..5765590f98307 100644
--- a/chrome/browser/flag_descriptions.h
+++ b/chrome/browser/flag_descriptions.h
@@ -2287,9 +2287,6 @@ extern const char kCCTMinimizedDescription[];
 extern const char kCCTPageInsightsHubName[];
 extern const char kCCTPageInsightsHubDescription[];
 
-extern const char kCCTPreventTouchesName[];
-extern const char kCCTPreventTouchesDescription[];
-
 extern const char kCCTResizableForThirdPartiesName[];
 extern const char kCCTResizableForThirdPartiesDescription[];
 extern const char kCCTResizableSideSheetName[];
diff --git a/chrome/browser/flags/android/chrome_feature_list.cc b/chrome/browser/flags/android/chrome_feature_list.cc
index 34b7c034aa5ea..ab5f99d0f92f9 100644
--- a/chrome/browser/flags/android/chrome_feature_list.cc
+++ b/chrome/browser/flags/android/chrome_feature_list.cc
@@ -204,7 +204,6 @@ const base::Feature* const kFeaturesExposedToJava[] = {
     &kCCTPageInsightsHub,
     &kCCTPostMessageAPI,
     &kCCTPrefetchDelayShowOnStart,
-    &kCCTPreventTouches,
     &kCCTRealTimeEngagementSignals,
     &kCCTRealTimeEngagementSignalsAlternativeImpl,
     &kCCTRedirectPreconnect,
@@ -600,10 +599,6 @@ BASE_FEATURE(kCCTPrefetchDelayShowOnStart,
              "CCTPrefetchDelayShowOnStart",
              base::FEATURE_ENABLED_BY_DEFAULT);
 
-BASE_FEATURE(kCCTPreventTouches,
-             "CCTPreventTouches",
-             base::FEATURE_ENABLED_BY_DEFAULT);
-
 BASE_FEATURE(kCCTRealTimeEngagementSignals,
              "CCTRealTimeEngagementSignals",
              base::FEATURE_ENABLED_BY_DEFAULT);
diff --git a/chrome/browser/flags/android/chrome_feature_list.h b/chrome/browser/flags/android/chrome_feature_list.h
index e99b47bf83665..39de8689f510a 100644
--- a/chrome/browser/flags/android/chrome_feature_list.h
+++ b/chrome/browser/flags/android/chrome_feature_list.h
@@ -60,7 +60,6 @@ BASE_DECLARE_FEATURE(kCCTNewDownloadTab);
 BASE_DECLARE_FEATURE(kCCTPageInsightsHub);
 BASE_DECLARE_FEATURE(kCCTPostMessageAPI);
 BASE_DECLARE_FEATURE(kCCTPrefetchDelayShowOnStart);
-BASE_DECLARE_FEATURE(kCCTPreventTouches);
 BASE_DECLARE_FEATURE(kCCTRealTimeEngagementSignals);
 BASE_DECLARE_FEATURE(kCCTRealTimeEngagementSignalsAlternativeImpl);
 BASE_DECLARE_FEATURE(kCCTRedirectPreconnect);
diff --git a/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java b/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
index 4583da1751152..89028d3037efc 100644
--- a/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
+++ b/chrome/browser/flags/android/java/src/org/chromium/chrome/browser/flags/ChromeFeatureList.java
@@ -192,7 +192,6 @@ public abstract class ChromeFeatureList {
     public static final String CCT_PAGE_INSIGHTS_HUB = "CCTPageInsightsHub";
     public static final String CCT_POST_MESSAGE_API = "CCTPostMessageAPI";
     public static final String CCT_PREFETCH_DELAY_SHOW_ON_START = "CCTPrefetchDelayShowOnStart";
-    public static final String CCT_PREVENT_TOUCHES = "CCTPreventTouches";
     public static final String CCT_REAL_TIME_ENGAGEMENT_SIGNALS = "CCTRealTimeEngagementSignals";
     public static final String CCT_REAL_TIME_ENGAGEMENT_SIGNALS_ALTERNATIVE_IMPL =
             "CCTRealTimeEngagementSignalsAlternativeImpl";
