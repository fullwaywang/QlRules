/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_uring_flush
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-uring-flush
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_uring_flush CVE-2020-29534
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdata_8257) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getTarget()=vdata_8257
		and target_0.getRValue().(Literal).getValue()="0")
}

predicate func_1(Parameter vdata_8257, Variable vctx_8259) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("io_uring_cancel_task_requests")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vctx_8259
		and target_1.getArgument(1).(VariableAccess).getTarget()=vdata_8257)
}

predicate func_2(Parameter vdata_8257, Parameter vfile_8257, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(FunctionCall).getTarget().hasName("io_uring_attempt_task_drop")
		and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfile_8257
		and target_2.getExpr().(FunctionCall).getArgument(1).(NotExpr).getOperand().(VariableAccess).getTarget()=vdata_8257
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2)
}

predicate func_3(Variable vctx_8259, VariableAccess target_3) {
		target_3.getTarget()=vctx_8259
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Parameter vdata_8257, VariableAccess target_4) {
		target_4.getTarget()=vdata_8257
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Parameter vdata_8257, Variable vctx_8259, FunctionCall target_5) {
		target_5.getTarget().hasName("io_uring_cancel_files")
		and target_5.getArgument(0).(VariableAccess).getTarget()=vctx_8259
		and target_5.getArgument(1).(VariableAccess).getTarget()=vdata_8257
}

predicate func_6(Variable vctx_8259, FunctionCall target_6) {
		target_6.getTarget().hasName("io_wq_cancel_cb")
		and target_6.getArgument(0).(PointerFieldAccess).getTarget().getName()="io_wq"
		and target_6.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_8259
		and target_6.getArgument(2).(FunctionCall).getTarget().hasName("get_current")
}

from Function func, Parameter vdata_8257, Variable vctx_8259, Parameter vfile_8257, VariableAccess target_3, VariableAccess target_4, FunctionCall target_5, FunctionCall target_6
where
not func_0(vdata_8257)
and not func_1(vdata_8257, vctx_8259)
and not func_2(vdata_8257, vfile_8257, func)
and func_3(vctx_8259, target_3)
and func_4(vdata_8257, target_4)
and func_5(vdata_8257, vctx_8259, target_5)
and func_6(vctx_8259, target_6)
and vdata_8257.getType().hasName("void *")
and vctx_8259.getType().hasName("io_ring_ctx *")
and vfile_8257.getType().hasName("file *")
and vdata_8257.getFunction() = func
and vctx_8259.(LocalVariable).getFunction() = func
and vfile_8257.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
