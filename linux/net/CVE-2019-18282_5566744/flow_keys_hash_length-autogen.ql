/**
 * @name linux-55667441c84fa5e0911a0aac44fb059c15ba6da2-flow_keys_hash_length
 * @id cpp/linux/55667441c84fa5e0911a0aac44fb059c15ba6da2/flow-keys-hash-length
 * @description linux-55667441c84fa5e0911a0aac44fb059c15ba6da2-net/core/flow_dissector.c-flow_keys_hash_length CVE-2019-18282
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vflow_1373, PointerDereferenceExpr target_1) {
	target_1.getOperand().(VariableAccess).getTarget()=vflow_1373
}

predicate func_2(Variable vdiff_1375, SubExpr target_2) {
	target_2.getLeftOperand().(SizeofExprOperator).getValue()="64"
	and target_2.getRightOperand().(VariableAccess).getTarget()=vdiff_1375
}

predicate func_3(Function func, DoStmt target_3) {
	target_3.getCondition() instanceof Literal
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

/*predicate func_4(Function func, IfStmt target_4) {
	target_4.getCondition().(NotExpr).getValue()="0"
	and target_4.getEnclosingFunction() = func
}

*/
predicate func_5(Function func, DivExpr target_5) {
	target_5.getLeftOperand() instanceof SubExpr
	and target_5.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getRightOperand().(SizeofTypeOperator).getValue()="4"
	and target_5.getEnclosingFunction() = func
}

from Function func, Variable vdiff_1375, Parameter vflow_1373, PointerDereferenceExpr target_1, SubExpr target_2, DoStmt target_3, DivExpr target_5
where
func_1(vflow_1373, target_1)
and func_2(vdiff_1375, target_2)
and func_3(func, target_3)
and func_5(func, target_5)
and vdiff_1375.getType().hasName("size_t")
and vflow_1373.getType().hasName("const flow_keys *")
and vdiff_1375.(LocalVariable).getFunction() = func
and vflow_1373.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
