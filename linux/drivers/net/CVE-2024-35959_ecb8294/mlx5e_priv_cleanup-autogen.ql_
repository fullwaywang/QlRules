/**
 * @name linux-ecb829459a841198e142f72fadab56424ae96519-mlx5e_priv_cleanup
 * @id cpp/linux/ecb829459a841198e142f72fadab56424ae96519/mlx5e-priv-cleanup
 * @description linux-ecb829459a841198e142f72fadab56424ae96519-drivers/net/ethernet/mellanox/mlx5/core/en_main.c-mlx5e_priv_cleanup CVE-2024-35959
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpriv_5715, Function func, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="state_lock"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_5715
	and target_0.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

predicate func_1(Parameter vpriv_5715, Function func, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="state_lock"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_5715
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

from Function func, Parameter vpriv_5715, ExprStmt target_0, ExprStmt target_1
where
func_0(vpriv_5715, func, target_0)
and func_1(vpriv_5715, func, target_1)
and vpriv_5715.getType().hasName("mlx5e_priv *")
and vpriv_5715.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
