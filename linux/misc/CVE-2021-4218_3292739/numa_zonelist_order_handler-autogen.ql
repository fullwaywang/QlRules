/**
 * @name linux-32927393dc1ccd60fb2bdc05b9e8e88753761469-numa_zonelist_order_handler
 * @id cpp/linux/32927393dc1ccd60fb2bdc05b9e8e88753761469/numa-zonelist-order-handler
 * @description linux-32927393dc1ccd60fb2bdc05b9e8e88753761469-include/linux/mmzone.h-numa_zonelist_order_handler CVE-2021-4218
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtable_5548, Parameter vwrite_5548, Parameter vbuffer_5549, Parameter vlength_5549, Parameter vppos_5550, NotExpr target_5, ReturnStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("proc_dostring")
	and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtable_5548
	and target_0.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vwrite_5548
	and target_0.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vbuffer_5549
	and target_0.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vlength_5549
	and target_0.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vppos_5550
	and target_0.getParent().(IfStmt).getCondition()=target_5
}

predicate func_1(Parameter vbuffer_5549, VariableAccess target_1) {
	target_1.getTarget()=vbuffer_5549
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_2(Parameter vwrite_5548, ReturnStmt target_0, VariableAccess target_2) {
	target_2.getTarget()=vwrite_5548
	and target_2.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_0
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, DeclStmt target_4) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Parameter vwrite_5548, ReturnStmt target_0, NotExpr target_5) {
	target_5.getOperand().(VariableAccess).getTarget()=vwrite_5548
	and target_5.getParent().(IfStmt).getThen()=target_0
}

predicate func_6(Parameter vbuffer_5549, Variable vstr_5552, Function func, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vstr_5552
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("memdup_user_nul")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_5549
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="16"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vstr_5552, Function func, IfStmt target_7) {
	target_7.getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_7.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vstr_5552
	and target_7.getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_7.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vstr_5552
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vstr_5552, FunctionCall target_8) {
	target_8.getTarget().hasName("PTR_ERR")
	and target_8.getArgument(0).(VariableAccess).getTarget()=vstr_5552
}

predicate func_9(Variable vstr_5552, Variable vret_5553, Function func, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_5553
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__parse_numa_zonelist_order")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vstr_5552
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

/*predicate func_10(Variable vstr_5552, FunctionCall target_8, ExprStmt target_11, VariableAccess target_10) {
	target_10.getTarget()=vstr_5552
	and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__parse_numa_zonelist_order")
	and target_8.getArgument(0).(VariableAccess).getLocation().isBefore(target_10.getLocation())
	and target_10.getLocation().isBefore(target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
predicate func_11(Variable vstr_5552, Function func, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vstr_5552
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vret_5553, Function func, ReturnStmt target_12) {
	target_12.getExpr().(VariableAccess).getTarget()=vret_5553
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

from Function func, Parameter vtable_5548, Parameter vwrite_5548, Parameter vbuffer_5549, Parameter vlength_5549, Parameter vppos_5550, Variable vstr_5552, Variable vret_5553, ReturnStmt target_0, VariableAccess target_1, VariableAccess target_2, DeclStmt target_3, DeclStmt target_4, NotExpr target_5, ExprStmt target_6, IfStmt target_7, FunctionCall target_8, ExprStmt target_9, ExprStmt target_11, ReturnStmt target_12
where
func_0(vtable_5548, vwrite_5548, vbuffer_5549, vlength_5549, vppos_5550, target_5, target_0)
and func_1(vbuffer_5549, target_1)
and func_2(vwrite_5548, target_0, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(vwrite_5548, target_0, target_5)
and func_6(vbuffer_5549, vstr_5552, func, target_6)
and func_7(vstr_5552, func, target_7)
and func_8(vstr_5552, target_8)
and func_9(vstr_5552, vret_5553, func, target_9)
and func_11(vstr_5552, func, target_11)
and func_12(vret_5553, func, target_12)
and vtable_5548.getType().hasName("ctl_table *")
and vwrite_5548.getType().hasName("int")
and vbuffer_5549.getType().hasName("void *")
and vlength_5549.getType().hasName("size_t *")
and vppos_5550.getType().hasName("loff_t *")
and vstr_5552.getType().hasName("char *")
and vret_5553.getType().hasName("int")
and vtable_5548.getFunction() = func
and vwrite_5548.getFunction() = func
and vbuffer_5549.getFunction() = func
and vlength_5549.getFunction() = func
and vppos_5550.getFunction() = func
and vstr_5552.(LocalVariable).getFunction() = func
and vret_5553.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
