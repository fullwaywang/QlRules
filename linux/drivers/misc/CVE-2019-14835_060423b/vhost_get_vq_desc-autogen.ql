/**
 * @name linux-060423bfdee3f8bc6e2c1bac97de24d5415e2bc4-vhost_get_vq_desc
 * @id cpp/linux/060423bfdee3f8bc6e2c1bac97de24d5415e2bc4/vhost-get-vq-desc
 * @description linux-060423bfdee3f8bc6e2c1bac97de24d5415e2bc4-drivers/vhost/vhost.c-vhost_get_vq_desc CVE-2019-14835
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlog_2213, Variable vret_2220, ExprStmt target_2, ExprStmt target_3, ExprStmt target_4) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand().(VariableAccess).getTarget()=vlog_2213
	and target_0.getRightOperand().(VariableAccess).getTarget()=vret_2220
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vlog_2213
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_0.getLeftOperand().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
	and target_3.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(VariableAccess).getLocation())
	and target_0.getRightOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vlog_2213, VariableAccess target_1) {
	target_1.getTarget()=vlog_2213
	and target_1.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_2(Parameter vlog_2213, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="addr"
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlog_2213
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned int *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("vhost64_to_cpu")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("vhost_virtqueue *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("vring_desc")
}

predicate func_3(Variable vret_2220, ExprStmt target_3) {
	target_3.getExpr().(AssignAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned int *")
	and target_3.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vret_2220
}

predicate func_4(Variable vret_2220, ExprStmt target_4) {
	target_4.getExpr().(AssignAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned int *")
	and target_4.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vret_2220
}

from Function func, Parameter vlog_2213, Variable vret_2220, VariableAccess target_1, ExprStmt target_2, ExprStmt target_3, ExprStmt target_4
where
not func_0(vlog_2213, vret_2220, target_2, target_3, target_4)
and func_1(vlog_2213, target_1)
and func_2(vlog_2213, target_2)
and func_3(vret_2220, target_3)
and func_4(vret_2220, target_4)
and vlog_2213.getType().hasName("vhost_log *")
and vret_2220.getType().hasName("int")
and vlog_2213.getFunction() = func
and vret_2220.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
