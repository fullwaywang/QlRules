/**
 * @name linux-0fb6bd06e06792469acc15bbe427361b56ada528-lg4ff_init
 * @id cpp/linux/0fb6bd06e06792469acc15bbe427361b56ada528/lg4ff-init
 * @description linux-0fb6bd06e06792469acc15bbe427361b56ada528-drivers/hid/hid-lg4ff.c-lg4ff_init CVE-2013-2893
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vreport_489, Parameter vhid_484, BlockStmt target_28, AddressOfExpr target_2) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("hid_validate_values")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vhid_484
	and target_0.getArgument(1) instanceof Literal
	and target_0.getArgument(2) instanceof Literal
	and target_0.getArgument(3).(Literal).getValue()="0"
	and target_0.getArgument(4).(Literal).getValue()="7"
	and target_0.getParent().(NotExpr).getOperand().(VariableAccess).getTarget()=vreport_489
	and target_0.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_28
	and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vhid_484, AddressOfExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_484
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

/*predicate func_3(Function func, UnaryMinusExpr target_3) {
	target_3.getValue()="-1"
	and target_3.getEnclosingFunction() = func
}

*/
predicate func_4(Parameter vhid_484, AddressOfExpr target_4) {
	target_4.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_484
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Function func, UnaryMinusExpr target_5) {
	target_5.getValue()="-1"
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vhid_484, AddressOfExpr target_6) {
	target_6.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_6.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_484
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_7(Function func, UnaryMinusExpr target_7) {
	target_7.getValue()="-1"
	and target_7.getEnclosingFunction() = func
}

predicate func_8(FunctionCall target_15, Function func, ReturnStmt target_8) {
	target_8.getExpr().(UnaryMinusExpr).getValue()="-1"
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vhid_484, VariableAccess target_9) {
	target_9.getTarget()=vhid_484
}

predicate func_12(Function func, DeclStmt target_12) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Function func, DeclStmt target_13) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Function func, DeclStmt target_14) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Variable vreport_list_487, BlockStmt target_29, FunctionCall target_15) {
	target_15.getTarget().hasName("list_empty")
	and target_15.getArgument(0).(VariableAccess).getTarget()=vreport_list_487
	and target_15.getParent().(IfStmt).getThen()=target_29
}

predicate func_16(FunctionCall target_15, Function func, ExprStmt target_16) {
	target_16.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_16.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_16.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="No output report found\n"
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vreport_489, Variable v__mptr_504, Function func, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreport_489
	and target_17.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_504
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

/*predicate func_19(Variable v__mptr_504, ExprStmt target_19) {
	target_19.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_504
	and target_19.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
}

*/
predicate func_20(Variable vreport_489, Function func, IfStmt target_20) {
	target_20.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vreport_489
	and target_20.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_20.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_20.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="NULL output report\n"
	and target_20.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

/*predicate func_21(Variable vreport_489, BlockStmt target_28, ExprStmt target_17, ExprStmt target_24, VariableAccess target_21) {
	target_21.getTarget()=vreport_489
	and target_21.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_28
	and target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_21.getLocation())
	and target_21.getLocation().isBefore(target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_22(NotExpr target_30, Function func, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_22.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_22.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="NULL output report\n"
	and target_22.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_30
	and target_22.getEnclosingFunction() = func
}

*/
/*predicate func_23(NotExpr target_30, Function func, ReturnStmt target_23) {
	target_23.getExpr() instanceof UnaryMinusExpr
	and target_23.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_30
	and target_23.getEnclosingFunction() = func
}

*/
predicate func_24(Variable vreport_489, Variable vfield_490, Function func, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfield_490
	and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="field"
	and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreport_489
	and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_24
}

predicate func_25(Variable vfield_490, Function func, IfStmt target_25) {
	target_25.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vfield_490
	and target_25.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_25.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_25.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="NULL field\n"
	and target_25.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_25
}

/*predicate func_26(NotExpr target_31, Function func, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_26.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_26.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="NULL field\n"
	and target_26.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_31
	and target_26.getEnclosingFunction() = func
}

*/
/*predicate func_27(NotExpr target_31, Function func, ReturnStmt target_27) {
	target_27.getExpr() instanceof UnaryMinusExpr
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_31
	and target_27.getEnclosingFunction() = func
}

*/
predicate func_28(Function func, BlockStmt target_28) {
	target_28.getStmt(0) instanceof ExprStmt
	and target_28.getStmt(1) instanceof ReturnStmt
	and target_28.getEnclosingFunction() = func
}

predicate func_29(Function func, BlockStmt target_29) {
	target_29.getStmt(0) instanceof ExprStmt
	and target_29.getStmt(1) instanceof ReturnStmt
	and target_29.getEnclosingFunction() = func
}

predicate func_30(Variable vreport_489, NotExpr target_30) {
	target_30.getOperand().(VariableAccess).getTarget()=vreport_489
}

predicate func_31(Variable vfield_490, NotExpr target_31) {
	target_31.getOperand().(VariableAccess).getTarget()=vfield_490
}

from Function func, Variable vreport_list_487, Variable vreport_489, Variable vfield_490, Parameter vhid_484, Variable v__mptr_504, AddressOfExpr target_2, AddressOfExpr target_4, UnaryMinusExpr target_5, AddressOfExpr target_6, UnaryMinusExpr target_7, ReturnStmt target_8, VariableAccess target_9, DeclStmt target_12, DeclStmt target_13, DeclStmt target_14, FunctionCall target_15, ExprStmt target_16, ExprStmt target_17, IfStmt target_20, ExprStmt target_24, IfStmt target_25, BlockStmt target_28, BlockStmt target_29, NotExpr target_30, NotExpr target_31
where
not func_0(vreport_489, vhid_484, target_28, target_2)
and func_2(vhid_484, target_2)
and func_4(vhid_484, target_4)
and func_5(func, target_5)
and func_6(vhid_484, target_6)
and func_7(func, target_7)
and func_8(target_15, func, target_8)
and func_9(vhid_484, target_9)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(func, target_14)
and func_15(vreport_list_487, target_29, target_15)
and func_16(target_15, func, target_16)
and func_17(vreport_489, v__mptr_504, func, target_17)
and func_20(vreport_489, func, target_20)
and func_24(vreport_489, vfield_490, func, target_24)
and func_25(vfield_490, func, target_25)
and func_28(func, target_28)
and func_29(func, target_29)
and func_30(vreport_489, target_30)
and func_31(vfield_490, target_31)
and vreport_list_487.getType().hasName("list_head *")
and vreport_489.getType().hasName("hid_report *")
and vfield_490.getType().hasName("hid_field *")
and vhid_484.getType().hasName("hid_device *")
and v__mptr_504.getType().hasName("const list_head *")
and vreport_list_487.(LocalVariable).getFunction() = func
and vreport_489.(LocalVariable).getFunction() = func
and vfield_490.(LocalVariable).getFunction() = func
and vhid_484.getFunction() = func
and v__mptr_504.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
