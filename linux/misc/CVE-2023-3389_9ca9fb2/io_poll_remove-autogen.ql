/**
 * @name linux-9ca9fb24d5febccea354089c41f96a8ad0d853f8-io_poll_remove
 * @id cpp/linux/9ca9fb24d5febccea354089c41f96a8ad0d853f8/io-poll-remove
 * @description linux-9ca9fb24d5febccea354089c41f96a8ad0d853f8-io_uring/poll.c-io_poll_remove CVE-2023-3389
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(NotExpr target_18, Function func) {
	exists(GotoStmt target_0 |
		target_0.getParent().(IfStmt).getCondition()=target_18
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable vret2_750, BlockStmt target_20, NotExpr target_14) {
	exists(EqualityOperation target_1 |
		target_1.getAnOperand().(VariableAccess).getTarget()=vret2_750
		and target_1.getAnOperand() instanceof UnaryMinusExpr
		and target_1.getParent().(IfStmt).getThen()=target_20
		and target_1.getAnOperand().(VariableAccess).getLocation().isBefore(target_14.getOperand().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vissue_flags_743, Variable vctx_747, ExprStmt target_21, AddressOfExpr target_22, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(FunctionCall).getTarget().hasName("io_ring_submit_lock")
		and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_747
		and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vissue_flags_743
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_22.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Variable vcd_746, Variable vctx_747, Variable vbucket_748, Variable vpreq_749, AddressOfExpr target_23, AddressOfExpr target_24, NotExpr target_18, AddressOfExpr target_25, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpreq_749
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_poll_find")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_747
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcd_746
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cancel_table_locked"
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_747
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbucket_748
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_23.getOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
		and target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
		and target_18.getOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vpreq_749, Variable vret2_750, ExprStmt target_26, ExprStmt target_15, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret2_750
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_poll_disarm")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpreq_749
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_7(Variable vpreq_749, Variable vret_750, ExprStmt target_26, ExprStmt target_15) {
	exists(FunctionCall target_7 |
		target_7.getTarget().hasName("io_poll_disarm")
		and target_7.getArgument(0).(VariableAccess).getTarget()=vpreq_749
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
		and target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getArgument(0).(VariableAccess).getLocation())
		and target_7.getArgument(0).(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

*/
predicate func_9(Variable vbucket_748, VariableAccess target_17, IfStmt target_27) {
	exists(ExprStmt target_9 |
		target_9.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbucket_748
		and target_9.getParent().(IfStmt).getCondition()=target_17
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_27.getCondition().(VariableAccess).getLocation()))
}

predicate func_10(Parameter vissue_flags_743, Variable vctx_747, ExprStmt target_21, ExprStmt target_28, Function func) {
	exists(ExprStmt target_10 |
		target_10.getExpr().(FunctionCall).getTarget().hasName("io_ring_submit_unlock")
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_747
		and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vissue_flags_743
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_11(Variable vret2_750, Variable vret_750, LogicalOrExpr target_29, ExprStmt target_30, RelationalOperation target_31, Function func) {
	exists(IfStmt target_11 |
		target_11.getCondition().(VariableAccess).getTarget()=vret2_750
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vret2_750
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
		and target_29.getAnOperand().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_11.getCondition().(VariableAccess).getLocation())
		and target_30.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_31.getLesserOperand().(VariableAccess).getLocation()))
}

/*predicate func_12(Variable vret2_750, Variable vret_750, NotExpr target_14, ExprStmt target_30, RelationalOperation target_31) {
	exists(AssignExpr target_12 |
		target_12.getLValue().(VariableAccess).getTarget()=vret_750
		and target_12.getRValue().(VariableAccess).getTarget()=vret2_750
		and target_14.getOperand().(VariableAccess).getLocation().isBefore(target_12.getRValue().(VariableAccess).getLocation())
		and target_30.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_12.getLValue().(VariableAccess).getLocation())
		and target_12.getLValue().(VariableAccess).getLocation().isBefore(target_31.getLesserOperand().(VariableAccess).getLocation()))
}

*/
predicate func_13(Variable vret_750, UnaryMinusExpr target_13) {
		target_13.getValue()="-2"
		and target_13.getParent().(AssignExpr).getRValue() = target_13
		and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
}

predicate func_14(Variable vret2_750, BlockStmt target_20, NotExpr target_14) {
		target_14.getOperand().(VariableAccess).getTarget()=vret2_750
		and target_14.getParent().(IfStmt).getThen()=target_20
}

predicate func_15(Variable vpreq_749, Variable vret2_750, VariableAccess target_17, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret2_750
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_poll_disarm")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpreq_749
		and target_15.getParent().(IfStmt).getCondition()=target_17
}

predicate func_16(Variable vret_750, VariableAccess target_16) {
		target_16.getTarget()=vret_750
		and target_16.getParent().(AssignExpr).getLValue() = target_16
		and target_16.getParent().(AssignExpr).getRValue() instanceof UnaryMinusExpr
}

predicate func_17(Variable vpreq_749, ExprStmt target_15, VariableAccess target_17) {
		target_17.getTarget()=vpreq_749
		and target_17.getParent().(IfStmt).getThen()=target_15
}

predicate func_18(Variable vpreq_749, BlockStmt target_32, NotExpr target_18) {
		target_18.getOperand().(VariableAccess).getTarget()=vpreq_749
		and target_18.getParent().(IfStmt).getThen()=target_32
}

predicate func_19(Variable vret_750, UnaryMinusExpr target_19) {
		target_19.getValue()="-114"
		and target_19.getParent().(AssignExpr).getRValue() = target_19
		and target_19.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
}

predicate func_20(Variable vret_750, BlockStmt target_20) {
		target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
		and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
}

predicate func_21(Parameter vissue_flags_743, Variable vpreq_749, Variable vret2_750, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret2_750
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_poll_add")
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpreq_749
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vissue_flags_743
}

predicate func_22(Variable vctx_747, AddressOfExpr target_22) {
		target_22.getOperand().(ValueFieldAccess).getTarget().getName()="cancel_table"
		and target_22.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_22.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_747
}

predicate func_23(Variable vcd_746, AddressOfExpr target_23) {
		target_23.getOperand().(VariableAccess).getTarget()=vcd_746
}

predicate func_24(Variable vbucket_748, AddressOfExpr target_24) {
		target_24.getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbucket_748
}

predicate func_25(Variable vpreq_749, AddressOfExpr target_25) {
		target_25.getOperand().(ValueFieldAccess).getTarget().getName()="cmd"
		and target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpreq_749
}

predicate func_26(Variable vcd_746, Variable vctx_747, Variable vbucket_748, Variable vpreq_749, ExprStmt target_26) {
		target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpreq_749
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_poll_find")
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_747
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcd_746
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cancel_table"
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_747
		and target_26.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbucket_748
}

predicate func_27(Variable vbucket_748, IfStmt target_27) {
		target_27.getCondition().(VariableAccess).getTarget()=vbucket_748
		and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
		and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbucket_748
}

predicate func_28(Parameter vissue_flags_743, ExprStmt target_28) {
		target_28.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("bool")
		and target_28.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vissue_flags_743
}

predicate func_29(Variable vret2_750, LogicalOrExpr target_29) {
		target_29.getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret2_750
		and target_29.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vret2_750
		and target_29.getAnOperand().(EqualityOperation).getAnOperand().(UnaryMinusExpr).getValue()="-529"
}

predicate func_30(Variable vret_750, ExprStmt target_30) {
		target_30.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
		and target_30.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
}

predicate func_31(Variable vret_750, RelationalOperation target_31) {
		 (target_31 instanceof GTExpr or target_31 instanceof LTExpr)
		and target_31.getLesserOperand().(VariableAccess).getTarget()=vret_750
		and target_31.getGreaterOperand().(Literal).getValue()="0"
}

predicate func_32(Variable vret_750, BlockStmt target_32) {
		target_32.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_750
		and target_32.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
}

from Function func, Parameter vissue_flags_743, Variable vcd_746, Variable vctx_747, Variable vbucket_748, Variable vpreq_749, Variable vret2_750, Variable vret_750, UnaryMinusExpr target_13, NotExpr target_14, ExprStmt target_15, VariableAccess target_16, VariableAccess target_17, NotExpr target_18, UnaryMinusExpr target_19, BlockStmt target_20, ExprStmt target_21, AddressOfExpr target_22, AddressOfExpr target_23, AddressOfExpr target_24, AddressOfExpr target_25, ExprStmt target_26, IfStmt target_27, ExprStmt target_28, LogicalOrExpr target_29, ExprStmt target_30, RelationalOperation target_31, BlockStmt target_32
where
not func_0(target_18, func)
and not func_1(vret2_750, target_20, target_14)
and not func_3(vissue_flags_743, vctx_747, target_21, target_22, func)
and not func_4(vcd_746, vctx_747, vbucket_748, vpreq_749, target_23, target_24, target_18, target_25, func)
and not func_5(vpreq_749, vret2_750, target_26, target_15, func)
and not func_9(vbucket_748, target_17, target_27)
and not func_10(vissue_flags_743, vctx_747, target_21, target_28, func)
and not func_11(vret2_750, vret_750, target_29, target_30, target_31, func)
and func_13(vret_750, target_13)
and func_14(vret2_750, target_20, target_14)
and func_15(vpreq_749, vret2_750, target_17, target_15)
and func_16(vret_750, target_16)
and func_17(vpreq_749, target_15, target_17)
and func_18(vpreq_749, target_32, target_18)
and func_19(vret_750, target_19)
and func_20(vret_750, target_20)
and func_21(vissue_flags_743, vpreq_749, vret2_750, target_21)
and func_22(vctx_747, target_22)
and func_23(vcd_746, target_23)
and func_24(vbucket_748, target_24)
and func_25(vpreq_749, target_25)
and func_26(vcd_746, vctx_747, vbucket_748, vpreq_749, target_26)
and func_27(vbucket_748, target_27)
and func_28(vissue_flags_743, target_28)
and func_29(vret2_750, target_29)
and func_30(vret_750, target_30)
and func_31(vret_750, target_31)
and func_32(vret_750, target_32)
and vissue_flags_743.getType().hasName("unsigned int")
and vcd_746.getType().hasName("io_cancel_data")
and vctx_747.getType().hasName("io_ring_ctx *")
and vbucket_748.getType().hasName("io_hash_bucket *")
and vpreq_749.getType().hasName("io_kiocb *")
and vret2_750.getType().hasName("int")
and vret_750.getType().hasName("int")
and vissue_flags_743.getFunction() = func
and vcd_746.(LocalVariable).getFunction() = func
and vctx_747.(LocalVariable).getFunction() = func
and vbucket_748.(LocalVariable).getFunction() = func
and vpreq_749.(LocalVariable).getFunction() = func
and vret2_750.(LocalVariable).getFunction() = func
and vret_750.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
