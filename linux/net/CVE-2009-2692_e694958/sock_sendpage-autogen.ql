/**
 * @name linux-e694958388c50148389b0e9b9e9e8945cf0f1b98-sock_sendpage
 * @id cpp/linux/e694958388c50148389b0e9b9e9e8945cf0f1b98/sock-sendpage
 * @description linux-e694958388c50148389b0e9b9e9e8945cf0f1b98-net/socket.c-sock_sendpage CVE-2009-2692
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpage_727, Parameter voffset_728, Parameter vsize_728, Variable vsock_730, Variable vflags_731) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("kernel_sendpage")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vsock_730
	and target_0.getArgument(1).(VariableAccess).getTarget()=vpage_727
	and target_0.getArgument(2).(VariableAccess).getTarget()=voffset_728
	and target_0.getArgument(3).(VariableAccess).getTarget()=vsize_728
	and target_0.getArgument(4).(VariableAccess).getTarget()=vflags_731)
}

predicate func_1(Variable vsock_730, VariableAccess target_1) {
	target_1.getTarget()=vsock_730
	and target_1.getParent().(VariableCall).getParent().(ReturnStmt).getExpr() instanceof VariableCall
}

predicate func_2(Parameter vpage_727, VariableAccess target_2) {
	target_2.getTarget()=vpage_727
	and target_2.getParent().(VariableCall).getParent().(ReturnStmt).getExpr() instanceof VariableCall
}

predicate func_3(Parameter voffset_728, VariableAccess target_3) {
	target_3.getTarget()=voffset_728
	and target_3.getParent().(VariableCall).getParent().(ReturnStmt).getExpr() instanceof VariableCall
}

predicate func_4(Parameter vsize_728, VariableAccess target_4) {
	target_4.getTarget()=vsize_728
	and target_4.getParent().(VariableCall).getParent().(ReturnStmt).getExpr() instanceof VariableCall
}

predicate func_5(Variable vflags_731, VariableAccess target_5) {
	target_5.getTarget()=vflags_731
	and target_5.getParent().(VariableCall).getParent().(ReturnStmt).getExpr() instanceof VariableCall
}

predicate func_6(Parameter vpage_727, Parameter voffset_728, Parameter vsize_728, Variable vsock_730, Variable vflags_731, VariableCall target_6) {
	target_6.getExpr().(PointerFieldAccess).getTarget().getName()="sendpage"
	and target_6.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
	and target_6.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsock_730
	and target_6.getArgument(0).(VariableAccess).getTarget()=vsock_730
	and target_6.getArgument(1).(VariableAccess).getTarget()=vpage_727
	and target_6.getArgument(2).(VariableAccess).getTarget()=voffset_728
	and target_6.getArgument(3).(VariableAccess).getTarget()=vsize_728
	and target_6.getArgument(4).(VariableAccess).getTarget()=vflags_731
}

from Function func, Parameter vpage_727, Parameter voffset_728, Parameter vsize_728, Variable vsock_730, Variable vflags_731, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_4, VariableAccess target_5, VariableCall target_6
where
not func_0(vpage_727, voffset_728, vsize_728, vsock_730, vflags_731)
and func_1(vsock_730, target_1)
and func_2(vpage_727, target_2)
and func_3(voffset_728, target_3)
and func_4(vsize_728, target_4)
and func_5(vflags_731, target_5)
and func_6(vpage_727, voffset_728, vsize_728, vsock_730, vflags_731, target_6)
and vpage_727.getType().hasName("page *")
and voffset_728.getType().hasName("int")
and vsize_728.getType().hasName("size_t")
and vsock_730.getType().hasName("socket *")
and vflags_731.getType().hasName("int")
and vpage_727.getFunction() = func
and voffset_728.getFunction() = func
and vsize_728.getFunction() = func
and vsock_730.(LocalVariable).getFunction() = func
and vflags_731.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
