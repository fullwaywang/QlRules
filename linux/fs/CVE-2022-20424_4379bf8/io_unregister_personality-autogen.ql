/**
 * @name linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-io_unregister_personality
 * @id cpp/linux/4379bf8bd70b5de6bba7d53015b0c36c57a634ee/io-unregister-personality
 * @description linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-fs/io_uring.c-io_unregister_personality CVE-2022-20424
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable viod_8596, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="creds"
	and target_0.getQualifier().(VariableAccess).getTarget()=viod_8596
}

predicate func_1(Variable viod_8596, FunctionCall target_1) {
	target_1.getTarget().hasName("kfree")
	and not target_1.getTarget().hasName("lockdep_rcu_suspicious")
	and target_1.getArgument(0).(VariableAccess).getTarget()=viod_8596
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="22"
	and not target_2.getValue()="1"
	and target_2.getParent().(UnaryMinusExpr).getParent().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and target_2.getEnclosingFunction() = func
}

predicate func_4(ExprStmt target_23, Function func) {
exists(ExprStmt target_4 |
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("const cred *")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("get_cred")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerFieldAccess).getTarget().getName()="cred"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_23.getLocation()))
}

/*predicate func_5(VariableAccess target_20, Function func) {
exists(DoStmt target_5 |
	target_5.getCondition() instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getValue()="0"
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_5
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_5.getEnclosingFunction() = func)
}

*/
/*predicate func_6(ExprStmt target_24, Function func) {
exists(LogicalAndExpr target_6 |
	target_6.getLeftOperand().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
	and target_6.getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
	and target_6.getRightOperand().(NotExpr).getValue()="0"
	and target_6.getParent().(IfStmt).getThen()=target_24
	and target_6.getEnclosingFunction() = func)
}

*/
/*predicate func_7(Function func) {
exists(AssignExpr target_7 |
	target_7.getLValue().(VariableAccess).getType().hasName("bool")
	and target_7.getEnclosingFunction() = func)
}

*/
/*predicate func_9(VariableAccess target_20, Function func) {
exists(EmptyStmt target_9 |
	target_9.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_9
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_9.getEnclosingFunction() = func)
}

*/
/*predicate func_10(VariableAccess target_20, Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(PointerFieldAccess).getTarget().getName()="cred"
	and target_10.getExpr().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_10
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_10.getEnclosingFunction() = func)
}

*/
/*predicate func_11(Variable viod_8596) {
exists(FunctionCall target_11 |
	target_11.getTarget().hasName("get_current")
	and target_11.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_cred")
	and target_11.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="creds"
	and target_11.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viod_8596)
}

*/
predicate func_12(ExprStmt target_23, Function func) {
exists(ExprStmt target_12 |
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("idr_alloc_cyclic")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("const cred *")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="1"
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(ComplementExpr).getValue()="65535"
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(BitwiseOrExpr).getValue()="3264"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
	and target_12.getLocation().isBefore(target_23.getLocation()))
}

predicate func_13(BlockStmt target_25, Function func) {
exists(RelationalOperation target_13 |
	 (target_13 instanceof GTExpr or target_13 instanceof LTExpr)
	and target_13.getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_13.getGreaterOperand().(Literal).getValue()="0"
	and target_13.getParent().(IfStmt).getThen()=target_25
	and target_13.getEnclosingFunction() = func)
}

predicate func_16(Parameter vctx_8594, AddressOfExpr target_16) {
	target_16.getOperand().(PointerFieldAccess).getTarget().getName()="personality_idr"
	and target_16.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_8594
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_19(Parameter vid_8594, Variable viod_8596, AssignExpr target_19) {
	target_19.getLValue().(VariableAccess).getTarget()=viod_8596
	and target_19.getRValue().(FunctionCall).getTarget().hasName("idr_remove")
	and target_19.getRValue().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_19.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vid_8594
}

predicate func_20(Variable viod_8596, BlockStmt target_25, ExprStmt target_23, ExprStmt target_26, VariableAccess target_20) {
	target_20.getTarget()=viod_8596
	and target_20.getParent().(IfStmt).getThen()=target_25
	and target_20.getLocation().isBefore(target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_21(Variable viod_8596, ExprStmt target_24, FunctionCall target_21) {
	target_21.getTarget().hasName("refcount_dec_and_test")
	and target_21.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_21.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viod_8596
	and target_21.getParent().(IfStmt).getThen()=target_24
}

predicate func_22(Function func, ReturnStmt target_22) {
	target_22.getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

predicate func_23(Function func, ExprStmt target_23) {
	target_23.getExpr() instanceof AssignExpr
	and target_23.getEnclosingFunction() = func
}

predicate func_24(Function func, ExprStmt target_24) {
	target_24.getExpr() instanceof FunctionCall
	and target_24.getEnclosingFunction() = func
}

predicate func_25(Variable viod_8596, BlockStmt target_25) {
	target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_cred")
	and target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="creds"
	and target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viod_8596
	and target_25.getStmt(1).(IfStmt).getCondition() instanceof FunctionCall
	and target_25.getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_26(Variable viod_8596, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("put_cred")
	and target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="creds"
	and target_26.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viod_8596
}

from Function func, Parameter vctx_8594, Parameter vid_8594, Variable viod_8596, PointerFieldAccess target_0, FunctionCall target_1, Literal target_2, AddressOfExpr target_16, AssignExpr target_19, VariableAccess target_20, FunctionCall target_21, ReturnStmt target_22, ExprStmt target_23, ExprStmt target_24, BlockStmt target_25, ExprStmt target_26
where
func_0(viod_8596, target_0)
and func_1(viod_8596, target_1)
and func_2(func, target_2)
and not func_4(target_23, func)
and not func_12(target_23, func)
and not func_13(target_25, func)
and func_16(vctx_8594, target_16)
and func_19(vid_8594, viod_8596, target_19)
and func_20(viod_8596, target_25, target_23, target_26, target_20)
and func_21(viod_8596, target_24, target_21)
and func_22(func, target_22)
and func_23(func, target_23)
and func_24(func, target_24)
and func_25(viod_8596, target_25)
and func_26(viod_8596, target_26)
and vctx_8594.getType().hasName("io_ring_ctx *")
and vid_8594.getType().hasName("unsigned int")
and viod_8596.getType().hasName("io_identity *")
and vctx_8594.getFunction() = func
and vid_8594.getFunction() = func
and viod_8596.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
