/**
 * @name linux-1871c6020d7308afb99127bba51f04548e7ca84e-load_guest_segment_descriptor
 * @id cpp/linux/1871c6020d7308afb99127bba51f04548e7ca84e/load-guest-segment-descriptor
 * @description linux-1871c6020d7308afb99127bba51f04548e7ca84e-arch/x86/kvm/x86.c-load_guest_segment_descriptor CVE-2010-0298
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvcpu_4654, Variable vdtable_4657, Variable vindex_4658, Parameter vseg_desc_4655, FunctionCall target_0) {
		target_0.getTarget().hasName("kvm_read_guest_virt")
		and not target_0.getTarget().hasName("kvm_read_guest_virt_system")
		and target_0.getArgument(0).(AddExpr).getAnOperand().(ValueFieldAccess).getTarget().getName()="base"
		and target_0.getArgument(0).(AddExpr).getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vdtable_4657
		and target_0.getArgument(0).(AddExpr).getAnOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vindex_4658
		and target_0.getArgument(0).(AddExpr).getAnOperand().(MulExpr).getRightOperand().(Literal).getValue()="8"
		and target_0.getArgument(1).(VariableAccess).getTarget()=vseg_desc_4655
		and target_0.getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_0.getArgument(3).(VariableAccess).getTarget()=vvcpu_4654
}

from Function func, Parameter vvcpu_4654, Variable vdtable_4657, Variable vindex_4658, Parameter vseg_desc_4655, FunctionCall target_0
where
func_0(vvcpu_4654, vdtable_4657, vindex_4658, vseg_desc_4655, target_0)
and vvcpu_4654.getType().hasName("kvm_vcpu *")
and vdtable_4657.getType().hasName("descriptor_table")
and vindex_4658.getType().hasName("u16")
and vseg_desc_4655.getType().hasName("desc_struct *")
and vvcpu_4654.getFunction() = func
and vdtable_4657.(LocalVariable).getFunction() = func
and vindex_4658.(LocalVariable).getFunction() = func
and vseg_desc_4655.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
