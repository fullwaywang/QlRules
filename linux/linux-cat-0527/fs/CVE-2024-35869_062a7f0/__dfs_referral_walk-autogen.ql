/**
 * @name linux-062a7f0ff46eb57aff526897bd2bebfdb1d3046a-__dfs_referral_walk
 * @id cpp/linux/062a7f0ff46eb57aff526897bd2bebfdb1d3046a/--dfs-referral-walk
 * @description linux-062a7f0ff46eb57aff526897bd2bebfdb1d3046a-fs/smb/client/dfs.c-__dfs_referral_walk CVE-2024-35869
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmnt_ctx_139, Variable vrc_145, FunctionCall target_0) {
	target_0.getTarget().hasName("add_root_smb_session")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vmnt_ctx_139
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_145
}

predicate func_1(Variable vrc_145, AssignExpr target_1) {
	target_1.getLValue().(VariableAccess).getTarget()=vrc_145
	and target_1.getRValue() instanceof FunctionCall
}

predicate func_2(Variable vrc_145, VariableAccess target_3, IfStmt target_2) {
	target_2.getCondition().(VariableAccess).getTarget()=vrc_145
	and target_2.getThen().(GotoStmt).getName() ="out"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_3(Variable vis_refsrv_144, VariableAccess target_3) {
	target_3.getTarget()=vis_refsrv_144
}

from Function func, Parameter vmnt_ctx_139, Variable vis_refsrv_144, Variable vrc_145, FunctionCall target_0, AssignExpr target_1, IfStmt target_2, VariableAccess target_3
where
func_0(vmnt_ctx_139, vrc_145, target_0)
and func_1(vrc_145, target_1)
and func_2(vrc_145, target_3, target_2)
and func_3(vis_refsrv_144, target_3)
and vmnt_ctx_139.getType().hasName("cifs_mount_ctx *")
and vis_refsrv_144.getType().hasName("bool")
and vrc_145.getType().hasName("int")
and vmnt_ctx_139.getFunction() = func
and vis_refsrv_144.(LocalVariable).getFunction() = func
and vrc_145.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
