/**
 * @name linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-iscsi_conn_setup
 * @id cpp/linux/ec29d0ac29be366450a7faffbcf8cba3a6a3b506/iscsi-conn-setup
 * @description linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-drivers/scsi/libiscsi.c-iscsi_conn_setup CVE-2021-47328
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, SizeofExprOperator target_0) {
	target_0.getValue()="696"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, SizeofExprOperator target_1) {
	target_1.getValue()="696"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, SizeofExprOperator target_2) {
	target_2.getValue()="696"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, StringLiteral target_3) {
	target_3.getValue()="&conn->ehwait"
	and not target_3.getValue()="&session->ehwait"
	and target_3.getEnclosingFunction() = func
}

predicate func_5(Variable vconn_3030, Function func, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="tmf_state"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vconn_3030, Variable v__key_3072, FunctionCall target_6) {
	target_6.getTarget().hasName("init_timer_key")
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tmf_timer"
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
	and target_6.getArgument(2).(Literal).getValue()="0"
	and target_6.getArgument(3).(StringLiteral).getValue()="(&conn->tmf_timer)"
	and target_6.getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_3072
}

predicate func_7(Variable vconn_3030, Variable v__key_3073, Function func, DoStmt target_7) {
	target_7.getCondition().(Literal).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__init_waitqueue_head")
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ehwait"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_3073
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

/*predicate func_9(Variable vconn_3030, Variable v__key_3073, ExprStmt target_9) {
	target_9.getExpr().(FunctionCall).getTarget().hasName("__init_waitqueue_head")
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ehwait"
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
	and target_9.getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_9.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_3073
}

*/
/*predicate func_10(Variable vconn_3030, Variable v__key_3073, AddressOfExpr target_11, AddressOfExpr target_12, VariableAccess target_10) {
	target_10.getTarget()=vconn_3030
	and target_10.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__init_waitqueue_head")
	and target_10.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ehwait"
	and target_10.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_10.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_3073
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getLocation())
	and target_10.getLocation().isBefore(target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_11(Variable vconn_3030, AddressOfExpr target_11) {
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="tmf_timer"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
}

predicate func_12(Variable vconn_3030, AddressOfExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="login_task"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3030
}

from Function func, Variable vconn_3030, Variable v__key_3072, Variable v__key_3073, SizeofExprOperator target_0, SizeofExprOperator target_1, SizeofExprOperator target_2, StringLiteral target_3, ExprStmt target_5, FunctionCall target_6, DoStmt target_7, AddressOfExpr target_11, AddressOfExpr target_12
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_5(vconn_3030, func, target_5)
and func_6(vconn_3030, v__key_3072, target_6)
and func_7(vconn_3030, v__key_3073, func, target_7)
and func_11(vconn_3030, target_11)
and func_12(vconn_3030, target_12)
and vconn_3030.getType().hasName("iscsi_conn *")
and v__key_3072.getType().hasName("lock_class_key")
and v__key_3073.getType().hasName("lock_class_key")
and vconn_3030.(LocalVariable).getFunction() = func
and v__key_3072.(LocalVariable).getFunction() = func
and v__key_3073.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
