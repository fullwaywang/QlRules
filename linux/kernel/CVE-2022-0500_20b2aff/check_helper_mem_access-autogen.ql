/**
 * @name linux-20b2aff4bc15bda809f994761d5719827d66c0b4-check_helper_mem_access
 * @id cpp/linux/20b2aff4bc15bda809f994761d5719827d66c0b4/check-helper-mem-access
 * @description linux-20b2aff4bc15bda809f994761d5719827d66c0b4-kernel/bpf/verifier.c-check_helper_mem_access CVE-2022-0500
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vreg_4773, FunctionCall target_15) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("base_type")
	and target_1.getArgument(0).(PointerFieldAccess).getTarget().getName()="type"
	and target_1.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_1.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vreg_4773, PointerFieldAccess target_6) {
exists(IfStmt target_2 |
	target_2.getCondition().(FunctionCall).getTarget().hasName("type_is_rdonly_mem")
	and target_2.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="type"
	and target_2.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_2.getThen().(BlockStmt).getStmt(0) instanceof IfStmt
	and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("const char *")
	and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof StringLiteral
	and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32 *")
	and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof AddressOfExpr
	and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("const char *")
	and target_2.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof StringLiteral
	and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32 *")
	and target_2.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof AddressOfExpr
	and target_2.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6)
}

predicate func_5(Variable vreg_4773, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="off"
	and target_5.getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_5.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Variable vreg_4773, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="type"
	and target_6.getQualifier().(VariableAccess).getTarget()=vreg_4773
}

predicate func_7(Parameter vmeta_4771, PointerFieldAccess target_6, IfStmt target_7) {
	target_7.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vmeta_4771
	and target_7.getCondition().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="raw_mode"
	and target_7.getCondition().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmeta_4771
	and target_7.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-13"
	and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

predicate func_8(Parameter vregno_4769, Parameter vaccess_size_4770, Parameter vzero_size_allowed_4770, Variable vreg_4773, Parameter venv_4769, AddressOfExpr target_8) {
	target_8.getOperand().(PointerFieldAccess).getTarget().getName()="max_rdonly_access"
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="aux"
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="prog"
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_4769
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("check_buffer_access")
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venv_4769
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vreg_4773
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vregno_4769
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="off"
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vaccess_size_4770
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vzero_size_allowed_4770
	and target_8.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(6).(StringLiteral).getValue()="rdonly"
}

predicate func_9(Parameter venv_4769, AddressOfExpr target_9) {
	target_9.getOperand().(PointerFieldAccess).getTarget().getName()="max_rdwr_access"
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="aux"
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="prog"
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_4769
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
}

predicate func_11(Variable vreg_4773, VariableAccess target_11) {
	target_11.getTarget()=vreg_4773
	and target_11.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
}

predicate func_14(Parameter vregno_4769, Parameter vaccess_size_4770, Parameter vzero_size_allowed_4770, Variable vreg_4773, Parameter venv_4769, PointerFieldAccess target_6, ReturnStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("check_buffer_access")
	and target_14.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venv_4769
	and target_14.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vreg_4773
	and target_14.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vregno_4769
	and target_14.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="off"
	and target_14.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_14.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vaccess_size_4770
	and target_14.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vzero_size_allowed_4770
	and target_14.getExpr().(FunctionCall).getArgument(6) instanceof StringLiteral
	and target_14.getExpr().(FunctionCall).getArgument(7) instanceof AddressOfExpr
	and target_14.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

predicate func_15(Parameter vregno_4769, Parameter vaccess_size_4770, Parameter vzero_size_allowed_4770, Variable vreg_4773, Parameter venv_4769, FunctionCall target_15) {
	target_15.getTarget().hasName("check_packet_access")
	and target_15.getArgument(0).(VariableAccess).getTarget()=venv_4769
	and target_15.getArgument(1).(VariableAccess).getTarget()=vregno_4769
	and target_15.getArgument(2).(PointerFieldAccess).getTarget().getName()="off"
	and target_15.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_4773
	and target_15.getArgument(3).(VariableAccess).getTarget()=vaccess_size_4770
	and target_15.getArgument(4).(VariableAccess).getTarget()=vzero_size_allowed_4770
}

from Function func, Parameter vregno_4769, Parameter vaccess_size_4770, Parameter vzero_size_allowed_4770, Parameter vmeta_4771, Variable vreg_4773, Parameter venv_4769, PointerFieldAccess target_5, PointerFieldAccess target_6, IfStmt target_7, AddressOfExpr target_8, AddressOfExpr target_9, VariableAccess target_11, ReturnStmt target_14, FunctionCall target_15
where
not func_1(vreg_4773, target_15)
and not func_2(vreg_4773, target_6)
and func_5(vreg_4773, target_5)
and func_6(vreg_4773, target_6)
and func_7(vmeta_4771, target_6, target_7)
and func_8(vregno_4769, vaccess_size_4770, vzero_size_allowed_4770, vreg_4773, venv_4769, target_8)
and func_9(venv_4769, target_9)
and func_11(vreg_4773, target_11)
and func_14(vregno_4769, vaccess_size_4770, vzero_size_allowed_4770, vreg_4773, venv_4769, target_6, target_14)
and func_15(vregno_4769, vaccess_size_4770, vzero_size_allowed_4770, vreg_4773, venv_4769, target_15)
and vregno_4769.getType().hasName("int")
and vaccess_size_4770.getType().hasName("int")
and vzero_size_allowed_4770.getType().hasName("bool")
and vmeta_4771.getType().hasName("bpf_call_arg_meta *")
and vreg_4773.getType().hasName("bpf_reg_state *")
and venv_4769.getType().hasName("bpf_verifier_env *")
and vregno_4769.getFunction() = func
and vaccess_size_4770.getFunction() = func
and vzero_size_allowed_4770.getFunction() = func
and vmeta_4771.getFunction() = func
and vreg_4773.(LocalVariable).getFunction() = func
and venv_4769.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
