/**
 * @name chromium-5608bda8ba25f912561e81cdc35bc7f3796682fb-content__CursorManager__UpdateViewUnderCursor
 * @id cpp/chromium/5608bda8ba25f912561e81cdc35bc7f3796682fb/contentcursormanagerupdateviewundercursor
 * @description chromium-5608bda8ba25f912561e81cdc35bc7f3796682fb-content/browser/renderer_host/cursor_manager.cc-content__CursorManager__UpdateViewUnderCursor CVE-2023-2466
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vcursor_36, FunctionCall target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="root_view_"
			and obj_1.getQualifier() instanceof ThisExpr
		)
	)
	and target_0.getTarget().hasName("DisplayCursor")
	and not target_0.getTarget().hasName("UpdateCursor")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vcursor_36
}

predicate func_1(Function func, ThisExpr target_1) {
	target_1.getType() instanceof PointerType
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, DeclStmt target_2) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Variable vit_38, Variable vcursor_36, Function func, IfStmt target_4) {
	exists(FunctionCall obj_0 | obj_0=target_4.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getArgument(1) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="cursor_map_"
				and obj_2.getQualifier().(ThisExpr).getType() instanceof PointerType
			)
			and obj_1.getTarget().hasName("end")
		)
		and obj_0.getTarget().hasName("operator!=")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vit_38
	)
	and exists(ExprStmt obj_3 | obj_3=target_4.getThen() |
		exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
			exists(PointerFieldAccess obj_5 | obj_5=obj_4.getArgument(0) |
				obj_5.getTarget().getName()="second"
				and obj_5.getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vit_38
			)
			and obj_4.getTarget().hasName("operator=")
			and obj_4.getQualifier().(VariableAccess).getTarget()=vcursor_36
		)
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

/*predicate func_5(Variable vit_38, Variable vcursor_36, FunctionCall target_5) {
	exists(PointerFieldAccess obj_0 | obj_0=target_5.getArgument(0) |
		obj_0.getTarget().getName()="second"
		and obj_0.getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vit_38
	)
	and target_5.getTarget().hasName("operator=")
	and target_5.getQualifier().(VariableAccess).getTarget()=vcursor_36
}

*/
predicate func_6(Function func, ExprStmt target_6) {
	target_6.getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Function func, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="root_view_"
	and target_7.getQualifier().(ThisExpr).getType() instanceof PointerType
	and target_7.getEnclosingFunction() = func
}

from Function func, Variable vit_38, Variable vcursor_36, FunctionCall target_0, ThisExpr target_1, DeclStmt target_2, DeclStmt target_3, IfStmt target_4, ExprStmt target_6, PointerFieldAccess target_7
where
func_0(vcursor_36, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(vit_38, vcursor_36, func, target_4)
and func_6(func, target_6)
and func_7(func, target_7)
and vit_38.getType().hasName("iterator")
and vcursor_36.getType().hasName("Cursor")
and vit_38.(LocalVariable).getFunction() = func
and vcursor_36.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
