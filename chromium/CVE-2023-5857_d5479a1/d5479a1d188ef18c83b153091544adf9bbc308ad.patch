commit d5479a1d188ef18c83b153091544adf9bbc308ad	d5479a1d188ef18c83b153091544adf9bbc308ad
Author: Daniel Rubery <drubery@chromium.org>
Date:   Sat Oct 21 00:12:52 2023 +0000

    Don't open download on BYPASS_DEEP_SCANNING command
    
    We use the label "Download anyway" for this UX now, so we shouldn't be
    opening the file. For contexts using strings like "Open now", we use a
    new DownloadCommand BYPASS_DEEP_SCANNING_AND_OPEN
    
    Fixed: 1493435
    Change-Id: I201201c51235bf2bc1fd275e77176e166f5b40d5
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4956103
    Reviewed-by: Xinghui Lu <xinghuilu@chromium.org>
    Commit-Queue: Daniel Rubery <drubery@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1213022}

diff --git a/chrome/browser/download/download_commands.h b/chrome/browser/download/download_commands.h
index 51923e8055e20..31c913db91e0f 100644
--- a/chrome/browser/download/download_commands.h
+++ b/chrome/browser/download/download_commands.h
@@ -42,8 +42,10 @@ class DownloadCommands {
     REVIEW = 17,                // Show enterprise download review dialog.
     RETRY = 18,                 // Retry the download.
     CANCEL_DEEP_SCAN = 19,  // Cancel deep scan and return to scanning prompt.
+    BYPASS_DEEP_SCANNING_AND_OPEN = 20,  // Bypass the prompt to deep scan and
+                                         // open the file.
 
-    kMaxValue = CANCEL_DEEP_SCAN,  // Keep last.
+    kMaxValue = BYPASS_DEEP_SCANNING_AND_OPEN,  // Keep last.
   };
 
   // |model| must outlive DownloadCommands.
diff --git a/chrome/browser/download/download_item_model.cc b/chrome/browser/download/download_item_model.cc
index c9f8467b674d2..fbc19043cc234 100644
--- a/chrome/browser/download/download_item_model.cc
+++ b/chrome/browser/download/download_item_model.cc
@@ -733,6 +733,7 @@ bool DownloadItemModel::IsCommandEnabled(
     case DownloadCommands::OPEN_SAFE_BROWSING_SETTING:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -774,6 +775,7 @@ bool DownloadItemModel::IsCommandChecked(
     case DownloadCommands::COPY_TO_CLIPBOARD:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -810,10 +812,14 @@ void DownloadItemModel::ExecuteCommand(DownloadCommands* download_commands,
         prefs->EnableAutoOpenByUserBasedOnExtension(path);
       break;
     }
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
+#if BUILDFLAG(FULL_SAFE_BROWSING)
+      SetOpenWhenComplete(true);
+#endif
+      [[fallthrough]];
     case DownloadCommands::BYPASS_DEEP_SCANNING:
 #if BUILDFLAG(FULL_SAFE_BROWSING)
       CompleteSafeBrowsingScan();
-      SetOpenWhenComplete(true);
 #endif
       if (GetDangerType() == download::DOWNLOAD_DANGER_TYPE_ASYNC_SCANNING) {
         LogDeepScanEvent(download_,
diff --git a/chrome/browser/download/download_shelf_context_menu.cc b/chrome/browser/download/download_shelf_context_menu.cc
index c717bb29ab052..7325b134d9993 100644
--- a/chrome/browser/download/download_shelf_context_menu.cc
+++ b/chrome/browser/download/download_shelf_context_menu.cc
@@ -201,7 +201,7 @@ std::u16string DownloadShelfContextMenu::GetLabelForCommandId(
     case DownloadCommands::DEEP_SCAN:
       id = IDS_DOWNLOAD_MENU_DEEP_SCAN;
       break;
-    case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
       id = IDS_OPEN_DOWNLOAD_NOW;
       break;
     // These commands are not supported on the context menu.
@@ -210,6 +210,7 @@ std::u16string DownloadShelfContextMenu::GetLabelForCommandId(
     case DownloadCommands::CANCEL_DEEP_SCAN:
     case DownloadCommands::LEARN_MORE_DOWNLOAD_BLOCKED:
     case DownloadCommands::OPEN_SAFE_BROWSING_SETTING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING:
       NOTREACHED();
       break;
   }
@@ -398,8 +399,8 @@ ui::SimpleMenuModel* DownloadShelfContextMenu::GetDeepScanningMenuModel(
       GetLabelForCommandId(DownloadCommands::DISCARD));
 
   deep_scanning_menu_model_->AddItem(
-      DownloadCommands::BYPASS_DEEP_SCANNING,
-      GetLabelForCommandId(DownloadCommands::BYPASS_DEEP_SCANNING));
+      DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN,
+      GetLabelForCommandId(DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN));
 
   deep_scanning_menu_model_->AddSeparator(ui::NORMAL_SEPARATOR);
 
diff --git a/chrome/browser/download/download_stats.cc b/chrome/browser/download/download_stats.cc
index 1ee5844a9ed86..cd0e2baad0eda 100644
--- a/chrome/browser/download/download_stats.cc
+++ b/chrome/browser/download/download_stats.cc
@@ -141,7 +141,7 @@ DownloadShelfContextMenuAction DownloadCommandToShelfAction(
     case DownloadCommands::Command::DEEP_SCAN:
       return clicked ? DownloadShelfContextMenuAction::kDeepScanClicked
                      : DownloadShelfContextMenuAction::kDeepScanEnabled;
-    case DownloadCommands::Command::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
       return clicked
                  ? DownloadShelfContextMenuAction::kBypassDeepScanningClicked
                  : DownloadShelfContextMenuAction::kBypassDeepScanningEnabled;
@@ -153,6 +153,7 @@ DownloadShelfContextMenuAction DownloadCommandToShelfAction(
     case DownloadCommands::Command::CANCEL_DEEP_SCAN:
     case DownloadCommands::Command::LEARN_MORE_DOWNLOAD_BLOCKED:
     case DownloadCommands::Command::OPEN_SAFE_BROWSING_SETTING:
+    case DownloadCommands::Command::BYPASS_DEEP_SCANNING:
       NOTREACHED();
       return DownloadShelfContextMenuAction::kNotReached;
   }
diff --git a/chrome/browser/download/download_ui_model.cc b/chrome/browser/download/download_ui_model.cc
index c89179a2d3912..fadb73fd6e791 100644
--- a/chrome/browser/download/download_ui_model.cc
+++ b/chrome/browser/download/download_ui_model.cc
@@ -643,6 +643,7 @@ bool DownloadUIModel::IsCommandEnabled(
     case DownloadCommands::LEARN_MORE_DOWNLOAD_BLOCKED:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -678,6 +679,7 @@ bool DownloadUIModel::IsCommandChecked(
     case DownloadCommands::COPY_TO_CLIPBOARD:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -745,6 +747,7 @@ void DownloadUIModel::ExecuteCommand(DownloadCommands* download_commands,
     case DownloadCommands::DEEP_SCAN:
       break;
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
diff --git a/chrome/browser/download/notification/download_item_notification.cc b/chrome/browser/download/notification/download_item_notification.cc
index 89fbfefe0f1ce..8c99c449c3736 100644
--- a/chrome/browser/download/notification/download_item_notification.cc
+++ b/chrome/browser/download/notification/download_item_notification.cc
@@ -206,6 +206,7 @@ void RecordButtonClickAction(DownloadCommands::Command command) {
     case DownloadCommands::LEARN_MORE_DOWNLOAD_BLOCKED:
     case DownloadCommands::OPEN_SAFE_BROWSING_SETTING:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::CANCEL_DEEP_SCAN:
     case DownloadCommands::RETRY:
       NOTREACHED();
@@ -958,6 +959,7 @@ std::u16string DownloadItemNotification::GetCommandLabel(
     case DownloadCommands::LEARN_MORE_DOWNLOAD_BLOCKED:
     case DownloadCommands::OPEN_SAFE_BROWSING_SETTING:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::CANCEL_DEEP_SCAN:
     case DownloadCommands::RETRY:
       // Only for menu.
diff --git a/chrome/browser/download/offline_item_model.cc b/chrome/browser/download/offline_item_model.cc
index d0d36a2e92188..4a9e4cd195b02 100644
--- a/chrome/browser/download/offline_item_model.cc
+++ b/chrome/browser/download/offline_item_model.cc
@@ -314,6 +314,7 @@ bool OfflineItemModel::IsCommandEnabled(
     case DownloadCommands::OPEN_SAFE_BROWSING_SETTING:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -347,6 +348,7 @@ bool OfflineItemModel::IsCommandChecked(
     case DownloadCommands::COPY_TO_CLIPBOARD:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
@@ -377,6 +379,7 @@ void OfflineItemModel::ExecuteCommand(DownloadCommands* download_commands,
     case DownloadCommands::COPY_TO_CLIPBOARD:
     case DownloadCommands::DEEP_SCAN:
     case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
     case DownloadCommands::REVIEW:
     case DownloadCommands::RETRY:
     case DownloadCommands::CANCEL_DEEP_SCAN:
diff --git a/chrome/browser/ui/download/download_bubble_row_view_info.cc b/chrome/browser/ui/download/download_bubble_row_view_info.cc
index 568ad2ba4c505..291efcd39fb04 100644
--- a/chrome/browser/ui/download/download_bubble_row_view_info.cc
+++ b/chrome/browser/ui/download/download_bubble_row_view_info.cc
@@ -294,7 +294,7 @@ void DownloadBubbleRowViewInfo::PopulateForInProgressOrComplete() {
         if (!download::DoesDownloadConnectorBlock(model_->profile(),
                                                   model_->GetURL())) {
           primary_button_command_ =
-              DownloadCommands::Command::BYPASS_DEEP_SCANNING;
+              DownloadCommands::Command::BYPASS_DEEP_SCANNING_AND_OPEN;
         }
       }
       return;
diff --git a/chrome/browser/ui/views/download/bubble/download_bubble_row_view.cc b/chrome/browser/ui/views/download/bubble/download_bubble_row_view.cc
index 300c0ba8dc1db..6ea5f19868240 100644
--- a/chrome/browser/ui/views/download/bubble/download_bubble_row_view.cc
+++ b/chrome/browser/ui/views/download/bubble/download_bubble_row_view.cc
@@ -439,7 +439,7 @@ DownloadBubbleRowView::DownloadBubbleRowView(
                     l10n_util::GetStringUTF16(IDS_CONFIRM_DOWNLOAD));
   AddMainPageButton(DownloadCommands::DEEP_SCAN,
                     l10n_util::GetStringUTF16(IDS_DOWNLOAD_BUBBLE_SCAN));
-  AddMainPageButton(DownloadCommands::BYPASS_DEEP_SCANNING,
+  AddMainPageButton(DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN,
                     l10n_util::GetStringUTF16(IDS_DOWNLOAD_BUBBLE_OPEN_NOW));
   AddMainPageButton(DownloadCommands::RESUME,
                     l10n_util::GetStringUTF16(IDS_DOWNLOAD_BUBBLE_RESUME));
@@ -907,7 +907,7 @@ std::u16string DownloadBubbleRowView::GetAccessibleNameForMainPageButton(
       return l10n_util::GetStringFUTF16(
           IDS_DOWNLOAD_BUBBLE_SCAN_MAIN_BUTTON_ACCESSIBILITY,
           info_->model()->GetFileNameToReportUser().LossyDisplayName());
-    case DownloadCommands::BYPASS_DEEP_SCANNING:
+    case DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN:
       return l10n_util::GetStringFUTF16(
           IDS_DOWNLOAD_BUBBLE_OPEN_NOW_MAIN_BUTTON_ACCESSIBILITY,
           info_->model()->GetFileNameToReportUser().LossyDisplayName());
diff --git a/chrome/browser/ui/views/download/download_item_view.cc b/chrome/browser/ui/views/download/download_item_view.cc
index e6644625ca3de..64edaa5e063e7 100644
--- a/chrome/browser/ui/views/download/download_item_view.cc
+++ b/chrome/browser/ui/views/download/download_item_view.cc
@@ -1239,7 +1239,7 @@ void DownloadItemView::ShowOpenDialog(content::WebContents* web_contents) {
                        DownloadCommands::DEEP_SCAN),
         base::BindOnce(&DownloadItemView::ExecuteCommand,
                        weak_ptr_factory_.GetWeakPtr(),
-                       DownloadCommands::BYPASS_DEEP_SCANNING));
+                       DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN));
   }
 }
 
diff --git a/chrome/browser/ui/webui/downloads/downloads_dom_handler.cc b/chrome/browser/ui/webui/downloads/downloads_dom_handler.cc
index a0015295185ff..50d228593f416 100644
--- a/chrome/browser/ui/webui/downloads/downloads_dom_handler.cc
+++ b/chrome/browser/ui/webui/downloads/downloads_dom_handler.cc
@@ -490,7 +490,7 @@ void DownloadsDOMHandler::BypassDeepScanRequiringGesture(
   if (download) {
     DownloadItemModel model(download);
     DownloadCommands commands(model.GetWeakPtr());
-    commands.ExecuteCommand(DownloadCommands::BYPASS_DEEP_SCANNING);
+    commands.ExecuteCommand(DownloadCommands::BYPASS_DEEP_SCANNING_AND_OPEN);
   }
 }
 
diff --git a/tools/metrics/histograms/enums.xml b/tools/metrics/histograms/enums.xml
index fbf56e687dce2..aca788eebcb6d 100644
--- a/tools/metrics/histograms/enums.xml
+++ b/tools/metrics/histograms/enums.xml
@@ -30317,6 +30317,7 @@ Called by update_document_policy_enum.py.-->
   <int value="17" label="Review"/>
   <int value="18" label="Retry"/>
   <int value="19" label="Cancel deep scan"/>
+  <int value="20" label="Bypass deep scanning and open"/>
 </enum>
 
 <enum name="DownloadConnectionSecurity">
