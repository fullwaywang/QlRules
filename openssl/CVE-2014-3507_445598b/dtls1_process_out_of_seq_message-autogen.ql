/**
 * @name openssl-445598b35e16090b676bb168807da06518658b34-dtls1_process_out_of_seq_message
 * @id cpp/openssl/445598b35e16090b676bb168807da06518658b34/dtls1-process-out-of-seq-message
 * @description openssl-445598b35e16090b676bb168807da06518658b34-ssl/d1_both.c-dtls1_process_out_of_seq_message CVE-2014-3507
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vitem_702, EqualityOperation target_5) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getTarget()=vitem_702
		and target_0.getRValue() instanceof FunctionCall
		and target_5.getAnOperand().(VariableAccess).getLocation().isBefore(target_0.getLValue().(VariableAccess).getLocation()))
}

predicate func_1(Variable vitem_702, LogicalOrExpr target_7, LogicalAndExpr target_9) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vitem_702
		and target_1.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand() instanceof Literal
		and target_1.getExpr().(ConditionalExpr).getThen() instanceof Literal
		and target_1.getExpr().(ConditionalExpr).getElse().(CommaExpr).getLeftOperand().(FunctionCall).getTarget().hasName("OpenSSLDie")
		and target_1.getExpr().(ConditionalExpr).getElse().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_1.getExpr().(ConditionalExpr).getElse().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(1) instanceof Literal
		and target_1.getExpr().(ConditionalExpr).getElse().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(2).(StringLiteral).getValue()="item != NULL"
		and target_1.getExpr().(ConditionalExpr).getElse().(CommaExpr).getRightOperand() instanceof Literal
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(12)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
		and target_1.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_9.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vmsg_hdr_698, Variable vfrag_len_704, ReturnStmt target_10, RelationalOperation target_2) {
		 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
		and target_2.getLesserOperand().(VariableAccess).getTarget()=vfrag_len_704
		and target_2.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_2.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_698
		and target_2.getParent().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vfrag_len_704
		and target_2.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_10
}

predicate func_3(Variable vitem_702, Parameter vs_698, FunctionCall target_3) {
		target_3.getTarget().hasName("pqueue_insert")
		and target_3.getArgument(0).(PointerFieldAccess).getTarget().getName()="buffered_messages"
		and target_3.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_3.getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_698
		and target_3.getArgument(1).(VariableAccess).getTarget()=vitem_702
}

predicate func_4(Variable vfrag_len_704, ReturnStmt target_10, LogicalAndExpr target_4) {
		target_4.getAnOperand().(VariableAccess).getTarget()=vfrag_len_704
		and target_4.getAnOperand() instanceof RelationalOperation
		and target_4.getParent().(IfStmt).getThen()=target_10
}

predicate func_5(Variable vitem_702, EqualityOperation target_5) {
		target_5.getAnOperand().(VariableAccess).getTarget()=vitem_702
		and target_5.getAnOperand().(Literal).getValue()="0"
		and target_5.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_7(Parameter vmsg_hdr_698, Variable vitem_702, Parameter vs_698, LogicalOrExpr target_7) {
		target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="seq"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_698
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_698
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="seq"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_698
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(Literal).getValue()="10"
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vitem_702
		and target_7.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_698
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="type"
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_698
		and target_7.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="20"
}

predicate func_9(Variable vitem_702, LogicalAndExpr target_9) {
		target_9.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget().getType().hasName("hm_fragment *")
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vitem_702
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
}

predicate func_10(Parameter vmsg_hdr_698, Parameter vs_698, ReturnStmt target_10) {
		target_10.getExpr().(FunctionCall).getTarget().hasName("dtls1_reassemble_fragment")
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_698
		and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vmsg_hdr_698
		and target_10.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int *")
}

from Function func, Parameter vmsg_hdr_698, Variable vitem_702, Variable vfrag_len_704, Parameter vs_698, RelationalOperation target_2, FunctionCall target_3, LogicalAndExpr target_4, EqualityOperation target_5, LogicalOrExpr target_7, LogicalAndExpr target_9, ReturnStmt target_10
where
not func_0(vitem_702, target_5)
and not func_1(vitem_702, target_7, target_9)
and func_2(vmsg_hdr_698, vfrag_len_704, target_10, target_2)
and func_3(vitem_702, vs_698, target_3)
and func_4(vfrag_len_704, target_10, target_4)
and func_5(vitem_702, target_5)
and func_7(vmsg_hdr_698, vitem_702, vs_698, target_7)
and func_9(vitem_702, target_9)
and func_10(vmsg_hdr_698, vs_698, target_10)
and vmsg_hdr_698.getType().hasName("hm_header_st *")
and vitem_702.getType().hasName("pitem *")
and vfrag_len_704.getType().hasName("unsigned long")
and vs_698.getType().hasName("SSL *")
and vmsg_hdr_698.getFunction() = func
and vitem_702.(LocalVariable).getFunction() = func
and vfrag_len_704.(LocalVariable).getFunction() = func
and vs_698.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
