/**
 * @name linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-vmw_view_res_val_add
 * @id cpp/linux/a309c7194e8a2f8bd4539b9449917913f6c2cd50/vmw-view-res-val-add
 * @description linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c-vmw_view_res_val_add CVE-2022-40133
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vview_393, VariableAccess target_0) {
	target_0.getTarget()=vview_393
	and vview_393.getIndex() = 1
	and target_0.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(1) instanceof FunctionCall
}

predicate func_1(Parameter vview_393, VariableAccess target_1) {
	target_1.getTarget()=vview_393
	and vview_393.getIndex() = 1
	and target_1.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(2) instanceof FunctionCall
}

predicate func_3(Function func) {
exists(Initializer target_3 |
	target_3.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_3.getExpr().getEnclosingFunction() = func)
}

predicate func_4(Function func) {
exists(AssignExpr target_4 |
	target_4.getLValue().(VariableAccess).getType().hasName("ttm_base_object *")
	and target_4.getRValue().(FunctionCall).getTarget().hasName("ttm_base_object_lookup")
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("ttm_object_file *")
	and target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("uint32_t")
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(ReturnStmt target_14, Function func) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("__builtin_expect")
	and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("ttm_base_object *")
	and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_5.getArgument(1).(Literal).getValue()="0"
	and target_5.getParent().(IfStmt).getThen()=target_14
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Function func) {
exists(UnaryMinusExpr target_6 |
	target_6.getValue()="-22"
	and target_6.getEnclosingFunction() = func)
}

predicate func_7(Function func) {
exists(IfStmt target_7 |
	target_7.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("ttm_base_object_type")
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("ttm_base_object *")
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="object_type"
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("const vmw_user_resource_conv *")
	and target_7.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_7.getThen().(GotoStmt).getName() ="out_bad_resource"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_8(Function func) {
exists(ExprStmt target_8 |
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("vmw_resource *")
	and target_8.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="base_obj_to_res"
	and target_8.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("const vmw_user_resource_conv *")
	and target_8.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getType().hasName("ttm_base_object *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_9(Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("kref_get")
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="kref"
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("vmw_resource *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_10(Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getType().hasName("vmw_resource **")
	and target_10.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("vmw_resource *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_11(Variable vret_395, IfStmt target_20, Function func) {
exists(ExprStmt target_11 |
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_395
	and target_11.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
	and target_11.getFollowingStmt() instanceof ReturnStmt
	and target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_20.getCondition().(VariableAccess).getLocation()))
}

predicate func_13(Function func) {
exists(ExprStmt target_13 |
	target_13.getExpr().(FunctionCall).getTarget().hasName("ttm_base_object_unref")
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ttm_base_object *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
	and target_13.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_14(Variable vret_395, VariableAccess target_17, ReturnStmt target_14) {
	target_14.getExpr().(VariableAccess).getTarget()=vret_395
	and target_14.getParent().(IfStmt).getCondition()=target_17
}

predicate func_16(Parameter vsw_context_392, Parameter vview_393, Variable vret_395, FunctionCall target_16) {
	target_16.getTarget().hasName("vmw_execbuf_res_noctx_val_add")
	and target_16.getArgument(0).(VariableAccess).getTarget()=vsw_context_392
	and target_16.getArgument(1).(FunctionCall).getTarget().hasName("vmw_view_srf")
	and target_16.getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vview_393
	and target_16.getArgument(2).(FunctionCall).getTarget().hasName("vmw_view_dirtying")
	and target_16.getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vview_393
	and target_16.getParent().(AssignExpr).getRValue() = target_16
	and target_16.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_395
}

predicate func_17(Variable vret_395, ReturnStmt target_14, VariableAccess target_17) {
	target_17.getTarget()=vret_395
	and target_17.getParent().(IfStmt).getThen()=target_14
}

predicate func_18(Parameter vsw_context_392, Parameter vview_393, FunctionCall target_18) {
	target_18.getTarget().hasName("vmw_execbuf_res_noctx_val_add")
	and target_18.getArgument(0).(VariableAccess).getTarget()=vsw_context_392
	and target_18.getArgument(1).(VariableAccess).getTarget()=vview_393
	and target_18.getArgument(2) instanceof Literal
}

predicate func_20(Variable vret_395, IfStmt target_20) {
	target_20.getCondition().(VariableAccess).getTarget()=vret_395
	and target_20.getThen() instanceof ReturnStmt
}

from Function func, Parameter vsw_context_392, Parameter vview_393, Variable vret_395, VariableAccess target_0, VariableAccess target_1, ReturnStmt target_14, FunctionCall target_16, VariableAccess target_17, FunctionCall target_18, IfStmt target_20
where
func_0(vview_393, target_0)
and func_1(vview_393, target_1)
and not func_3(func)
and not func_4(func)
and not func_5(target_14, func)
and not func_6(func)
and not func_7(func)
and not func_8(func)
and not func_9(func)
and not func_10(func)
and not func_11(vret_395, target_20, func)
and not func_13(func)
and func_14(vret_395, target_17, target_14)
and func_16(vsw_context_392, vview_393, vret_395, target_16)
and func_17(vret_395, target_14, target_17)
and func_18(vsw_context_392, vview_393, target_18)
and func_20(vret_395, target_20)
and vsw_context_392.getType().hasName("vmw_sw_context *")
and vview_393.getType().hasName("vmw_resource *")
and vret_395.getType().hasName("int")
and vsw_context_392.getFunction() = func
and vview_393.getFunction() = func
and vret_395.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
