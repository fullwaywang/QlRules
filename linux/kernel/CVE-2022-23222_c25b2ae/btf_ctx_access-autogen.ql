/**
 * @name linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-btf_ctx_access
 * @id cpp/linux/c25b2ae136039ffa820c26138ed4a5e5f3ab3841/btf-ctx-access
 * @description linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-kernel/bpf/btf.c-btf_ctx_access CVE-2022-23222
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_3(Variable vctx_arg_info_4942, IfStmt target_12, LogicalAndExpr target_13) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("base_type")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_3.getLocation().isBefore(target_12.getLocation())
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Variable vctx_arg_info_4942, IfStmt target_12, ExprStmt target_14) {
exists(ExprStmt target_4 |
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("type_flag")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_4.getLocation().isBefore(target_12.getLocation())
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vctx_arg_info_4942, BlockStmt target_15) {
exists(LogicalAndExpr target_5 |
	target_5.getLeftOperand() instanceof EqualityOperation
	and target_5.getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u32")
	and target_5.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u32")
	and target_5.getParent().(LogicalAndExpr).getLeftOperand() instanceof EqualityOperation
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_5.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_15)
}

predicate func_8(Variable vctx_arg_info_4942, BlockStmt target_15) {
exists(BitwiseAndExpr target_8 |
	target_8.getLeftOperand().(VariableAccess).getType().hasName("u32")
	and target_8.getParent().(LogicalAndExpr).getLeftOperand() instanceof EqualityOperation
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_8.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_15)
}

predicate func_9(Variable vctx_arg_info_4942, Parameter voff_4841, BlockStmt target_15, EqualityOperation target_9) {
	target_9.getLeftOperand().(PointerFieldAccess).getTarget().getName()="offset"
	and target_9.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_9.getRightOperand().(VariableAccess).getTarget()=voff_4841
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_9.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_9.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_15
}

/*predicate func_10(Variable vctx_arg_info_4942, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="reg_type"
	and target_10.getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
}

*/
/*predicate func_11(Variable vctx_arg_info_4942, PointerFieldAccess target_11) {
	target_11.getTarget().getName()="reg_type"
	and target_11.getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
}

*/
predicate func_12(Variable vctx_arg_info_4942, IfStmt target_12) {
	target_12.getCondition().(LogicalAndExpr).getLeftOperand() instanceof EqualityOperation
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("bpf_insn_access_aux *")
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
}

predicate func_13(Variable vctx_arg_info_4942, LogicalAndExpr target_13) {
	target_13.getLeftOperand() instanceof EqualityOperation
	and target_13.getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_13.getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_13.getRightOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_13.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_13.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_13.getRightOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
}

predicate func_14(Variable vctx_arg_info_4942, LogicalAndExpr target_13, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("bpf_insn_access_aux *")
	and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
}

predicate func_15(Variable vctx_arg_info_4942, BlockStmt target_15) {
	target_15.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_15.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("bpf_insn_access_aux *")
	and target_15.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="reg_type"
	and target_15.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_arg_info_4942
}

from Function func, Variable vctx_arg_info_4942, Parameter voff_4841, EqualityOperation target_9, IfStmt target_12, LogicalAndExpr target_13, ExprStmt target_14, BlockStmt target_15
where
not func_3(vctx_arg_info_4942, target_12, target_13)
and not func_4(vctx_arg_info_4942, target_12, target_14)
and not func_5(vctx_arg_info_4942, target_15)
and not func_8(vctx_arg_info_4942, target_15)
and func_9(vctx_arg_info_4942, voff_4841, target_15, target_9)
and func_12(vctx_arg_info_4942, target_12)
and func_13(vctx_arg_info_4942, target_13)
and func_14(vctx_arg_info_4942, target_13, target_14)
and func_15(vctx_arg_info_4942, target_15)
and vctx_arg_info_4942.getType().hasName("const bpf_ctx_arg_aux *")
and voff_4841.getType().hasName("int")
and vctx_arg_info_4942.(LocalVariable).getFunction() = func
and voff_4841.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
