/**
 * @name linux-f15eca95138b3d4ec17b63c3c1937b0aa0d3624b-dg_dispatch_as_host
 * @id cpp/linux/f15eca95138b3d4ec17b63c3c1937b0aa0d3624b/dg-dispatch-as-host
 * @description linux-f15eca95138b3d4ec17b63c3c1937b0aa0d3624b-drivers/misc/vmw_vmci/vmci_datagram.c-dg_dispatch_as_host CVE-2024-35944
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdg_info_218, Parameter vdg_157, AddressOfExpr target_9, ExprStmt target_10) {
exists(AssignExpr target_0 |
	target_0.getLValue().(PointerFieldAccess).getTarget().getName()="msg"
	and target_0.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_0.getRValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vdg_157
	and target_0.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getRValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable vdg_info_218, Parameter vdg_157, LogicalOrExpr target_11, ExprStmt target_12, AddressOfExpr target_7, AddExpr target_13, ExprStmt target_14) {
exists(ExprStmt target_1 |
	target_1.getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="msg_payload"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_1.getExpr().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vdg_157
	and target_1.getExpr().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getRightOperand().(Literal).getValue()="1"
	and target_1.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="payload_size"
	and target_1.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_157
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(7)=target_1
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_13.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getLocation())
	and target_1.getExpr().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_14.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

/*predicate func_2(Variable vdg_size_160, Variable vdg_info_218, Parameter vdg_157, ExprStmt target_12, AddressOfExpr target_7) {
exists(AddressOfExpr target_2 |
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="msg_payload"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_3(Variable vdg_size_160, Parameter vdg_157, AddExpr target_13) {
exists(PointerArithmeticOperation target_3 |
	target_3.getLeftOperand().(VariableAccess).getTarget()=vdg_157
	and target_3.getRightOperand().(Literal).getValue()="1"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
	and target_13.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLeftOperand().(VariableAccess).getLocation()))
}

*/
/*predicate func_4(Parameter vdg_157, ExprStmt target_14) {
exists(PointerFieldAccess target_4 |
	target_4.getTarget().getName()="payload_size"
	and target_4.getQualifier().(VariableAccess).getTarget()=vdg_157
	and target_4.getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

*/
predicate func_5(Variable vdg_size_160, Variable vdg_info_218, Parameter vdg_157, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="msg"
	and target_5.getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_5.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_5.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_5.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_5.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
}

/*predicate func_6(Variable vdg_size_160, Parameter vdg_157, VariableAccess target_6) {
	target_6.getTarget()=vdg_157
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
}

*/
predicate func_7(Variable vdg_size_160, Variable vdg_info_218, Parameter vdg_157, AddressOfExpr target_7) {
	target_7.getOperand().(PointerFieldAccess).getTarget().getName()="msg"
	and target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
}

/*predicate func_8(Variable vdg_size_160, Variable vdg_info_218, Parameter vdg_157, ExprStmt target_15, ExprStmt target_16, AddressOfExpr target_9, ExprStmt target_10, VariableAccess target_8) {
	target_8.getTarget()=vdg_size_160
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="msg"
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_8.getLocation())
	and target_8.getLocation().isBefore(target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getLocation())
}

*/
predicate func_9(Variable vdg_info_218, AddressOfExpr target_9) {
	target_9.getOperand().(PointerFieldAccess).getTarget().getName()="work"
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__init_work")
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_10(Parameter vdg_157, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="recv_cb"
	and target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("datagram_entry *")
	and target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="client_data"
	and target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("datagram_entry *")
	and target_10.getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
}

predicate func_11(Parameter vdg_157, LogicalOrExpr target_11) {
	target_11.getLeftOperand().(PointerFieldAccess).getTarget().getName()="run_delayed"
	and target_11.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("datagram_entry *")
	and target_11.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="context"
	and target_11.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_11.getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_157
	and target_11.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="2"
}

predicate func_12(Variable vdg_info_218, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="entry"
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_info_218
	and target_12.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("datagram_entry *")
}

predicate func_13(Parameter vdg_157, AddExpr target_13) {
	target_13.getLeftOperand().(SizeofExprOperator).getValue()="120"
	and target_13.getRightOperand().(PointerFieldAccess).getTarget().getName()="payload_size"
	and target_13.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_157
}

predicate func_14(Variable vdg_size_160, Parameter vdg_157, ExprStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_14.getExpr().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_14.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_157
	and target_14.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdg_size_160
}

predicate func_15(Variable vdg_size_160, Parameter vdg_157, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdg_size_160
	and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(SizeofTypeOperator).getValue()="24"
	and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="payload_size"
	and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdg_157
}

predicate func_16(Variable vdg_size_160, Parameter vdg_157, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("vmci_datagram *")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmemdup")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdg_157
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdg_size_160
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(BitwiseOrExpr).getValue()="3264"
}

from Function func, Variable vdg_size_160, Variable vdg_info_218, Parameter vdg_157, PointerFieldAccess target_5, AddressOfExpr target_7, AddressOfExpr target_9, ExprStmt target_10, LogicalOrExpr target_11, ExprStmt target_12, AddExpr target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16
where
not func_0(vdg_info_218, vdg_157, target_9, target_10)
and not func_1(vdg_info_218, vdg_157, target_11, target_12, target_7, target_13, target_14)
and func_5(vdg_size_160, vdg_info_218, vdg_157, target_5)
and func_7(vdg_size_160, vdg_info_218, vdg_157, target_7)
and func_9(vdg_info_218, target_9)
and func_10(vdg_157, target_10)
and func_11(vdg_157, target_11)
and func_12(vdg_info_218, target_12)
and func_13(vdg_157, target_13)
and func_14(vdg_size_160, vdg_157, target_14)
and func_15(vdg_size_160, vdg_157, target_15)
and func_16(vdg_size_160, vdg_157, target_16)
and vdg_size_160.getType().hasName("size_t")
and vdg_info_218.getType().hasName("delayed_datagram_info *")
and vdg_157.getType().hasName("vmci_datagram *")
and vdg_size_160.(LocalVariable).getFunction() = func
and vdg_info_218.(LocalVariable).getFunction() = func
and vdg_157.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
