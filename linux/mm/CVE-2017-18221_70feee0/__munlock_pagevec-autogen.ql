/**
 * @name linux-70feee0e1ef331b22cc51f383d532a0d043fbdcc-__munlock_pagevec
 * @id cpp/linux/70feee0e1ef331b22cc51f383d532a0d043fbdcc/--munlock-pagevec
 * @description linux-70feee0e1ef331b22cc51f383d532a0d043fbdcc-mm/mlock.c-__munlock_pagevec CVE-2017-18221
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(Initializer target_0 |
	target_0.getExpr() instanceof UnaryMinusExpr
	and target_0.getExpr().getEnclosingFunction() = func)
}

predicate func_1(Variable vdelta_munlocked_287, ExprStmt target_5) {
exists(PostfixIncrExpr target_1 |
	target_1.getOperand().(VariableAccess).getTarget()=vdelta_munlocked_287
	and target_1.getOperand().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_2(Variable vnr_286, UnaryMinusExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vnr_286
}

predicate func_3(Variable vdelta_munlocked_287, VariableAccess target_3) {
	target_3.getTarget()=vdelta_munlocked_287
	and target_3.getParent().(AssignExpr).getLValue() = target_3
	and target_3.getParent().(AssignExpr).getRValue() instanceof AddExpr
}

predicate func_4(Variable vdelta_munlocked_287, Variable vpvec_putback_288, AssignExpr target_4) {
	target_4.getLValue().(VariableAccess).getTarget()=vdelta_munlocked_287
	and target_4.getRValue().(AddExpr).getLeftOperand() instanceof UnaryMinusExpr
	and target_4.getRValue().(AddExpr).getRightOperand().(FunctionCall).getTarget().hasName("pagevec_count")
	and target_4.getRValue().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vpvec_putback_288
}

predicate func_5(Variable vdelta_munlocked_287, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("__mod_zone_page_state")
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("zone *")
	and target_5.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdelta_munlocked_287
}

from Function func, Variable vnr_286, Variable vdelta_munlocked_287, Variable vpvec_putback_288, UnaryMinusExpr target_2, VariableAccess target_3, AssignExpr target_4, ExprStmt target_5
where
not func_0(func)
and not func_1(vdelta_munlocked_287, target_5)
and func_2(vnr_286, target_2)
and func_3(vdelta_munlocked_287, target_3)
and func_4(vdelta_munlocked_287, vpvec_putback_288, target_4)
and func_5(vdelta_munlocked_287, target_5)
and vnr_286.getType().hasName("int")
and vdelta_munlocked_287.getType().hasName("int")
and vpvec_putback_288.getType().hasName("pagevec")
and vnr_286.(LocalVariable).getFunction() = func
and vdelta_munlocked_287.(LocalVariable).getFunction() = func
and vpvec_putback_288.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
