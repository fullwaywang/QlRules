/**
 * @name linux-ccfe8c3f7e52ae83155cb038753f4c75b774ca8a-__driver_rfc4106_decrypt
 * @id cpp/linux/ccfe8c3f7e52ae83155cb038753f4c75b774ca8a/--driver-rfc4106-decrypt
 * @description linux-ccfe8c3f7e52ae83155cb038753f4c75b774ca8a-arch/x86/crypto/aesni-intel_glue.c-__driver_rfc4106_decrypt CVE-2015-3331
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vauth_tag_len_1110, ExprStmt target_4, ExprStmt target_5, VariableAccess target_0) {
	target_0.getTarget()=vauth_tag_len_1110
	and target_4.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getLocation())
	and target_0.getLocation().isBefore(target_5.getExpr().(VariableCall).getArgument(9).(VariableAccess).getLocation())
}

predicate func_1(Variable vsrc_1102, Parameter vreq_1099, PointerArithmeticOperation target_1) {
	target_1.getLeftOperand().(VariableAccess).getTarget()=vsrc_1102
	and target_1.getRightOperand().(PointerFieldAccess).getTarget().getName()="cryptlen"
	and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1099
}

predicate func_2(Variable vauth_tag_len_1110, PointerArithmeticOperation target_2) {
	target_2.getLeftOperand() instanceof PointerArithmeticOperation
	and target_2.getRightOperand().(VariableAccess).getTarget()=vauth_tag_len_1110
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u8 *")
}

predicate func_3(Parameter vreq_1099, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="cryptlen"
	and target_3.getQualifier().(VariableAccess).getTarget()=vreq_1099
}

predicate func_4(Variable vauth_tag_len_1110, Parameter vreq_1099, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_4.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cryptlen"
	and target_4.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1099
	and target_4.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vauth_tag_len_1110
}

predicate func_5(Variable vsrc_1102, Variable vauth_tag_len_1110, Parameter vreq_1099, ExprStmt target_5) {
	target_5.getExpr().(VariableCall).getExpr().(VariableAccess).getTarget().getType().hasName("..(*)(..)")
	and target_5.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("void *")
	and target_5.getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_5.getExpr().(VariableCall).getArgument(2).(VariableAccess).getTarget()=vsrc_1102
	and target_5.getExpr().(VariableCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_5.getExpr().(VariableCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_5.getExpr().(VariableCall).getArgument(5).(PointerFieldAccess).getTarget().getName()="hash_subkey"
	and target_5.getExpr().(VariableCall).getArgument(5).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("aesni_rfc4106_gcm_ctx *")
	and target_5.getExpr().(VariableCall).getArgument(6).(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_5.getExpr().(VariableCall).getArgument(7).(PointerFieldAccess).getTarget().getName()="assoclen"
	and target_5.getExpr().(VariableCall).getArgument(7).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1099
	and target_5.getExpr().(VariableCall).getArgument(8).(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_5.getExpr().(VariableCall).getArgument(9).(VariableAccess).getTarget()=vauth_tag_len_1110
}

from Function func, Variable vsrc_1102, Variable vauth_tag_len_1110, Parameter vreq_1099, VariableAccess target_0, PointerArithmeticOperation target_1, PointerArithmeticOperation target_2, PointerFieldAccess target_3, ExprStmt target_4, ExprStmt target_5
where
func_0(vauth_tag_len_1110, target_4, target_5, target_0)
and func_1(vsrc_1102, vreq_1099, target_1)
and func_2(vauth_tag_len_1110, target_2)
and func_3(vreq_1099, target_3)
and func_4(vauth_tag_len_1110, vreq_1099, target_4)
and func_5(vsrc_1102, vauth_tag_len_1110, vreq_1099, target_5)
and vsrc_1102.getType().hasName("u8 *")
and vauth_tag_len_1110.getType().hasName("unsigned long")
and vreq_1099.getType().hasName("aead_request *")
and vsrc_1102.(LocalVariable).getFunction() = func
and vauth_tag_len_1110.(LocalVariable).getFunction() = func
and vreq_1099.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
