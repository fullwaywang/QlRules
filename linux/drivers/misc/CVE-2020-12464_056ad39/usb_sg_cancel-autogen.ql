/**
 * @name linux-056ad39ee9253873522f6469c3364964a322912b-usb_sg_cancel
 * @id cpp/linux/056ad39ee9253873522f6469c3364964a322912b/usb-sg-cancel
 * @description linux-056ad39ee9253873522f6469c3364964a322912b-drivers/usb/core/message.c-usb_sg_cancel CVE-2020-12464
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vio_586, BlockStmt target_7, IfStmt target_8) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand().(PointerFieldAccess).getTarget().getName()="status"
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getParent().(IfStmt).getThen()=target_7
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vio_586, ExprStmt target_9, ExprStmt target_10, AddressOfExpr target_11, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_9.getLocation())
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vflags_588, ExprStmt target_9, Function func) {
exists(DoStmt target_2 |
	target_2.getCondition().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_588
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getFollowingStmt() instanceof ReturnStmt
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vio_586, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(PostfixDecrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_3.getExpr().(PostfixDecrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_4(Parameter vio_586, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_4.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("complete")
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="complete"
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_6(Parameter vio_586, BlockStmt target_7, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="status"
	and target_6.getQualifier().(VariableAccess).getTarget()=vio_586
	and target_6.getParent().(IfStmt).getThen()=target_7
}

predicate func_7(Parameter vio_586, Variable vflags_588, BlockStmt target_7) {
	target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_588
}

predicate func_8(Parameter vio_586, Variable vflags_588, IfStmt target_8) {
	target_8.getCondition().(PointerFieldAccess).getTarget().getName()="status"
	and target_8.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_8.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_588
}

predicate func_9(Parameter vio_586, Variable vflags_588, Function func, ExprStmt target_9) {
	target_9.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_588
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Parameter vio_586, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="status"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_10.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-104"
}

predicate func_11(Parameter vio_586, Variable vflags_588, AddressOfExpr target_11) {
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_586
	and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_588
}

from Function func, Parameter vio_586, Variable vflags_588, PointerFieldAccess target_6, BlockStmt target_7, IfStmt target_8, ExprStmt target_9, ExprStmt target_10, AddressOfExpr target_11
where
not func_0(vio_586, target_7, target_8)
and not func_1(vio_586, target_9, target_10, target_11, func)
and not func_2(vflags_588, target_9, func)
and not func_3(vio_586, func)
and not func_4(vio_586, func)
and func_6(vio_586, target_7, target_6)
and func_7(vio_586, vflags_588, target_7)
and func_8(vio_586, vflags_588, target_8)
and func_9(vio_586, vflags_588, func, target_9)
and func_10(vio_586, target_10)
and func_11(vio_586, vflags_588, target_11)
and vio_586.getType().hasName("usb_sg_request *")
and vflags_588.getType().hasName("unsigned long")
and vio_586.getFunction() = func
and vflags_588.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
