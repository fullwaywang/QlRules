/**
 * @name linux-92dc0b1f46e12cfabd28d709bb34f7a39431b44f-gb_uart_remove
 * @id cpp/linux/92dc0b1f46e12cfabd28d709bb34f7a39431b44f/gb-uart-remove
 * @description linux-92dc0b1f46e12cfabd28d709bb34f7a39431b44f-drivers/staging/greybus/uart.c-gb_uart_remove CVE-2021-47358
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vgb_tty_909, FunctionCall target_0) {
	target_0.getTarget().hasName("tty_port_destroy")
	and not target_0.getTarget().hasName("tty_port_put")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="port"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgb_tty_909
}

predicate func_1(Variable vconnection_910, ExprStmt target_9, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("gb_connection_destroy")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vconnection_910
	and target_9.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vgb_tty_909, Function func, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("release_minor")
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vgb_tty_909
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable v__kfifo_939, Function func, ExprStmt target_3) {
	target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getValue()="1"
	and target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__kfifo_free")
	and target_3.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=v__kfifo_939
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

/*predicate func_6(Variable v__kfifo_939, IfStmt target_6) {
	target_6.getCondition().(EqualityOperation).getValue()="1"
	and target_6.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__kfifo_free")
	and target_6.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=v__kfifo_939
}

*/
predicate func_7(Variable vgb_tty_909, Function func, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_7.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="buffer"
	and target_7.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgb_tty_909
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vgb_tty_909, Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vgb_tty_909
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Function func, ExprStmt target_9) {
	target_9.getExpr() instanceof FunctionCall
	and target_9.getEnclosingFunction() = func
}

from Function func, Variable vgb_tty_909, Variable vconnection_910, Variable v__kfifo_939, FunctionCall target_0, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9
where
func_0(vgb_tty_909, target_0)
and func_1(vconnection_910, target_9, target_1)
and func_2(vgb_tty_909, func, target_2)
and func_3(v__kfifo_939, func, target_3)
and func_7(vgb_tty_909, func, target_7)
and func_8(vgb_tty_909, func, target_8)
and func_9(func, target_9)
and vgb_tty_909.getType().hasName("gb_tty *")
and vconnection_910.getType().hasName("gb_connection *")
and v__kfifo_939.getType().hasName("__kfifo *")
and vgb_tty_909.(LocalVariable).getFunction() = func
and vconnection_910.(LocalVariable).getFunction() = func
and v__kfifo_939.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
