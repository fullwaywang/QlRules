/**
 * @name linux-fc7facce686b64201dbf0b9614cc1d0bfad70010-mem_cgroup_migrate
 * @id cpp/linux/fc7facce686b64201dbf0b9614cc1d0bfad70010/mem-cgroup-migrate
 * @description linux-fc7facce686b64201dbf0b9614cc1d0bfad70010-mm/memcontrol.c-mem_cgroup_migrate CVE-2024-42234
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vold_7588, Function func, IfStmt target_0) {
	exists(LogicalAndExpr obj_0 | obj_0=target_0.getCondition() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getLeftOperand() |
			obj_1.getTarget().hasName("folio_test_large")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vold_7588
		)
		and exists(FunctionCall obj_2 | obj_2=obj_0.getRightOperand() |
			obj_2.getTarget().hasName("folio_test_large_rmappable")
			and obj_2.getArgument(0).(VariableAccess).getTarget()=vold_7588
		)
	)
	and exists(ExprStmt obj_3 | obj_3=target_0.getThen() |
		exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
			obj_4.getTarget().hasName("folio_undo_large_rmappable")
			and obj_4.getArgument(0).(VariableAccess).getTarget()=vold_7588
		)
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

from Function func, Parameter vold_7588, IfStmt target_0
where
func_0(vold_7588, func, target_0)
and vold_7588.getType().hasName("folio *")
and vold_7588.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
