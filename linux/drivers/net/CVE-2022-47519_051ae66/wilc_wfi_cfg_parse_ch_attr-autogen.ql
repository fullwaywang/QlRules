/**
 * @name linux-051ae669e4505abbe05165bebf6be7922de11f41-wilc_wfi_cfg_parse_ch_attr
 * @id cpp/linux/051ae669e4505abbe05165bebf6be7922de11f41/wilc-wfi-cfg-parse-ch-attr
 * @description linux-051ae669e4505abbe05165bebf6be7922de11f41-drivers/net/wireless/microchip/wilc1000/cfg80211.c-wilc_wfi_cfg_parse_ch_attr CVE-2022-47519
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable ve_951, Variable vindex_954, IfStmt target_11, ExprStmt target_0) {
	target_0.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vindex_954
	and target_0.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="attr_len"
	and target_0.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
	and target_0.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(SizeofExprOperator).getValue()="3"
	and target_11.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable ve_951) {
exists(AssignExpr target_1 |
	target_1.getLValue().(VariableAccess).getType().hasName("u16")
	and target_1.getRValue().(PointerFieldAccess).getTarget().getName()="attr_len"
	and target_1.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951)
}

predicate func_2(Parameter vlen_949, Variable vindex_954, ExprStmt target_12, RelationalOperation target_13, ExprStmt target_14) {
exists(RelationalOperation target_2 |
	 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
	and target_2.getGreaterOperand().(AddExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vindex_954
	and target_2.getGreaterOperand().(AddExpr).getLeftOperand().(AddExpr).getRightOperand().(SizeofExprOperator).getValue()="3"
	and target_2.getGreaterOperand().(AddExpr).getRightOperand().(VariableAccess).getType().hasName("u16")
	and target_2.getLesserOperand().(VariableAccess).getTarget()=vlen_949
	and target_2.getParent().(IfStmt).getThen()=target_12
	and target_13.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_2.getLesserOperand().(VariableAccess).getLocation())
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_2.getGreaterOperand().(AddExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_3(EqualityOperation target_8, Function func) {
exists(ReturnStmt target_3 |
	target_3.getParent().(IfStmt).getCondition()=target_8
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(Variable vindex_954, Variable vch_list_idx_955, Variable vop_ch_idx_956, ExprStmt target_0, LogicalAndExpr target_16) {
exists(IfStmt target_4 |
	target_4.getCondition() instanceof EqualityOperation
	and target_4.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vch_list_idx_955
	and target_4.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
	and target_4.getElse().(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand() instanceof EqualityOperation
	and target_4.getElse().(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u16")
	and target_4.getElse().(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(SubExpr).getValue()="5"
	and target_4.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vop_ch_idx_956
	and target_4.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
	and target_4.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
	and target_4.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_16.getLeftOperand().(VariableAccess).getLocation()))
}

/*predicate func_5(ExprStmt target_18, Function func) {
exists(LogicalAndExpr target_5 |
	target_5.getLeftOperand() instanceof EqualityOperation
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u16")
	and target_5.getRightOperand().(EqualityOperation).getRightOperand().(SubExpr).getValue()="5"
	and target_5.getParent().(IfStmt).getThen()=target_18
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_6(Variable vindex_954, ExprStmt target_18) {
exists(ExprStmt target_6 |
	target_6.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vindex_954
	and target_6.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(SizeofExprOperator).getValue()="3"
	and target_6.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getType().hasName("u16")
	and target_18.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_8(Variable ve_951, ExprStmt target_12, EqualityOperation target_8) {
	target_8.getLeftOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
	and target_8.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
	and target_8.getParent().(IfStmt).getThen()=target_12
}

predicate func_9(Variable ve_951, ExprStmt target_18, EqualityOperation target_9) {
	target_9.getLeftOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
	and target_9.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
	and target_9.getParent().(IfStmt).getThen()=target_18
}

predicate func_10(Variable ve_951, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="attr_len"
	and target_10.getQualifier().(VariableAccess).getTarget()=ve_951
}

predicate func_11(Variable vch_list_idx_955, Variable vop_ch_idx_956, IfStmt target_11) {
	target_11.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vch_list_idx_955
	and target_11.getCondition().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget()=vop_ch_idx_956
}

predicate func_12(Variable vindex_954, Variable vch_list_idx_955, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vch_list_idx_955
	and target_12.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
}

predicate func_13(Parameter vlen_949, Variable vindex_954, RelationalOperation target_13) {
	 (target_13 instanceof GEExpr or target_13 instanceof LEExpr)
	and target_13.getLesserOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vindex_954
	and target_13.getLesserOperand().(AddExpr).getRightOperand().(SizeofExprOperator).getValue()="3"
	and target_13.getGreaterOperand().(VariableAccess).getTarget()=vlen_949
}

predicate func_14(Variable ve_951, Variable vindex_954, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_951
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_954
}

predicate func_16(Variable vch_list_idx_955, Variable vop_ch_idx_956, LogicalAndExpr target_16) {
	target_16.getLeftOperand().(VariableAccess).getTarget()=vch_list_idx_955
	and target_16.getRightOperand().(VariableAccess).getTarget()=vop_ch_idx_956
}

predicate func_18(Variable vindex_954, Variable vop_ch_idx_956, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vop_ch_idx_956
	and target_18.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
}

from Function func, Parameter vlen_949, Variable ve_951, Variable vindex_954, Variable vch_list_idx_955, Variable vop_ch_idx_956, ExprStmt target_0, EqualityOperation target_8, EqualityOperation target_9, PointerFieldAccess target_10, IfStmt target_11, ExprStmt target_12, RelationalOperation target_13, ExprStmt target_14, LogicalAndExpr target_16, ExprStmt target_18
where
func_0(ve_951, vindex_954, target_11, target_0)
and not func_1(ve_951)
and not func_2(vlen_949, vindex_954, target_12, target_13, target_14)
and not func_3(target_8, func)
and not func_4(vindex_954, vch_list_idx_955, vop_ch_idx_956, target_0, target_16)
and not func_6(vindex_954, target_18)
and func_8(ve_951, target_12, target_8)
and func_9(ve_951, target_18, target_9)
and func_10(ve_951, target_10)
and func_11(vch_list_idx_955, vop_ch_idx_956, target_11)
and func_12(vindex_954, vch_list_idx_955, target_12)
and func_13(vlen_949, vindex_954, target_13)
and func_14(ve_951, vindex_954, target_14)
and func_16(vch_list_idx_955, vop_ch_idx_956, target_16)
and func_18(vindex_954, vop_ch_idx_956, target_18)
and vlen_949.getType().hasName("u32")
and ve_951.getType().hasName("wilc_attr_entry *")
and vindex_954.getType().hasName("u32")
and vch_list_idx_955.getType().hasName("u8")
and vop_ch_idx_956.getType().hasName("u8")
and vlen_949.getFunction() = func
and ve_951.(LocalVariable).getFunction() = func
and vindex_954.(LocalVariable).getFunction() = func
and vch_list_idx_955.(LocalVariable).getFunction() = func
and vop_ch_idx_956.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
