/**
 * @name linux-3a50597de8635cd05133bd12c95681c82fe7b878-keyctl_session_to_parent
 * @id cpp/linux/3a50597de8635cd05133bd12c95681c82fe7b878/keyctl-session-to-parent
 * @description linux-3a50597de8635cd05133bd12c95681c82fe7b878-security/keys/keyctl.c-keyctl_session_to_parent CVE-2016-0728
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BuiltInOperationBuiltInOffsetOf target_0) {
		target_0.getValue()="152"
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vkeyring_r_1460, ExprStmt target_14, ExprStmt target_15, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vkeyring_r_1460
		and target_1.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vcred_1461, VariableAccess target_2) {
		target_2.getTarget()=vcred_1461
}

predicate func_3(Variable vmycred_1458, VariableAccess target_3) {
		target_3.getTarget()=vmycred_1458
}

predicate func_4(Variable vpcred_1458, VariableAccess target_4) {
		target_4.getTarget()=vpcred_1458
}

predicate func_5(Variable vpcred_1458, VariableAccess target_5) {
		target_5.getTarget()=vpcred_1458
}

predicate func_6(Variable vpcred_1458, VariableAccess target_6) {
		target_6.getTarget()=vpcred_1458
}

predicate func_7(Variable vmycred_1458, VariableAccess target_7) {
		target_7.getTarget()=vmycred_1458
}

predicate func_8(Variable vcred_1461, PointerFieldAccess target_8) {
		target_8.getTarget().getName()="tgcred"
		and target_8.getQualifier().(VariableAccess).getTarget()=vcred_1461
}

predicate func_9(Variable vmycred_1458, LogicalOrExpr target_16, LogicalOrExpr target_17, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="tgcred"
		and target_9.getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_9.getQualifier().(VariableAccess).getLocation())
		and target_9.getQualifier().(VariableAccess).getLocation().isBefore(target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_10(Variable vpcred_1458, LogicalOrExpr target_16, LogicalOrExpr target_17, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="tgcred"
		and target_10.getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_10.getQualifier().(VariableAccess).getLocation())
		and target_10.getQualifier().(VariableAccess).getLocation().isBefore(target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_11(Variable vpcred_1458, LogicalOrExpr target_17, PointerFieldAccess target_18, PointerFieldAccess target_11) {
		target_11.getTarget().getName()="tgcred"
		and target_11.getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getQualifier().(VariableAccess).getLocation())
		and target_11.getQualifier().(VariableAccess).getLocation().isBefore(target_18.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_12(Variable vpcred_1458, LogicalOrExpr target_19, PointerFieldAccess target_12) {
		target_12.getTarget().getName()="tgcred"
		and target_12.getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getQualifier().(VariableAccess).getLocation())
}

predicate func_13(Variable vmycred_1458, LogicalOrExpr target_19, PointerFieldAccess target_13) {
		target_13.getTarget().getName()="tgcred"
		and target_13.getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getQualifier().(VariableAccess).getLocation())
}

predicate func_14(Variable vcred_1461, Variable vkeyring_r_1460, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcred_1461
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("key_ref_to_ptr")
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkeyring_r_1460
}

predicate func_15(Variable vkeyring_r_1460, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("key_ref_put")
		and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkeyring_r_1460
}

predicate func_16(Variable vmycred_1458, Variable vpcred_1458, LogicalOrExpr target_16) {
		target_16.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vmycred_1458
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vpcred_1458
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_16.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
}

predicate func_17(Variable vmycred_1458, Variable vpcred_1458, LogicalOrExpr target_17) {
		target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="uid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="suid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="gid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="egid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="egid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="egid"
		and target_17.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_17.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="sgid"
		and target_17.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_17.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="egid"
		and target_17.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
}

predicate func_18(Variable vpcred_1458, PointerFieldAccess target_18) {
		target_18.getTarget().getName()="session_keyring"
		and target_18.getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_18.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
}

predicate func_19(Variable vmycred_1458, Variable vpcred_1458, LogicalOrExpr target_19) {
		target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="uid"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpcred_1458
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_19.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="uid"
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="euid"
		and target_19.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmycred_1458
}

from Function func, Variable vcred_1461, Variable vmycred_1458, Variable vpcred_1458, Variable vkeyring_r_1460, BuiltInOperationBuiltInOffsetOf target_0, VariableAccess target_2, VariableAccess target_3, VariableAccess target_4, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, PointerFieldAccess target_8, PointerFieldAccess target_9, PointerFieldAccess target_10, PointerFieldAccess target_11, PointerFieldAccess target_12, PointerFieldAccess target_13, ExprStmt target_14, ExprStmt target_15, LogicalOrExpr target_16, LogicalOrExpr target_17, PointerFieldAccess target_18, LogicalOrExpr target_19
where
func_0(func, target_0)
and not func_1(vkeyring_r_1460, target_14, target_15, func)
and func_2(vcred_1461, target_2)
and func_3(vmycred_1458, target_3)
and func_4(vpcred_1458, target_4)
and func_5(vpcred_1458, target_5)
and func_6(vpcred_1458, target_6)
and func_7(vmycred_1458, target_7)
and func_8(vcred_1461, target_8)
and func_9(vmycred_1458, target_16, target_17, target_9)
and func_10(vpcred_1458, target_16, target_17, target_10)
and func_11(vpcred_1458, target_17, target_18, target_11)
and func_12(vpcred_1458, target_19, target_12)
and func_13(vmycred_1458, target_19, target_13)
and func_14(vcred_1461, vkeyring_r_1460, target_14)
and func_15(vkeyring_r_1460, target_15)
and func_16(vmycred_1458, vpcred_1458, target_16)
and func_17(vmycred_1458, vpcred_1458, target_17)
and func_18(vpcred_1458, target_18)
and func_19(vmycred_1458, vpcred_1458, target_19)
and vcred_1461.getType().hasName("cred *")
and vmycred_1458.getType().hasName("const cred *")
and vpcred_1458.getType().hasName("const cred *")
and vkeyring_r_1460.getType().hasName("key_ref_t")
and vcred_1461.(LocalVariable).getFunction() = func
and vmycred_1458.(LocalVariable).getFunction() = func
and vpcred_1458.(LocalVariable).getFunction() = func
and vkeyring_r_1460.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
