/**
 * @name linux-4b03da87d0b7074c93d9662c6e1a8939f9b8b86e-max_vclocks_store
 * @id cpp/linux/4b03da87d0b7074c93d9662c6e1a8939f9b8b86e/max-vclocks-store
 * @description linux-4b03da87d0b7074c93d9662c6e1a8939f9b8b86e-drivers/ptp/ptp_sysfs.c-max_vclocks_store CVE-2024-40994
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vvclock_index_266, Variable vsize_268, FunctionCall target_0) {
	exists(AssignExpr obj_0 | obj_0=target_0.getParent() |
		obj_0.getRValue() = target_0
		and obj_0.getLValue().(VariableAccess).getTarget()=vvclock_index_266
	)
	and target_0.getTarget().hasName("kzalloc")
	and not target_0.getTarget().hasName("kcalloc")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vsize_268
	and target_0.getArgument(1).(BitwiseOrExpr).getValue()="3264"
}

predicate func_1(Function func, SizeofTypeOperator target_1) {
	target_1.getType() instanceof LongType
	and target_1.getValue()="4"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vmax_269, VariableAccess target_2) {
	target_2.getTarget()=vmax_269
}

predicate func_3(Variable vsize_268, Variable vmax_269, AssignExpr target_3) {
	exists(MulExpr obj_0 | obj_0=target_3.getRValue() |
		obj_0.getLeftOperand() instanceof SizeofTypeOperator
		and obj_0.getRightOperand().(VariableAccess).getTarget()=vmax_269
	)
	and target_3.getLValue().(VariableAccess).getTarget()=vsize_268
}

predicate func_4(Variable vvclock_index_266, Function func, ExprStmt target_4) {
	exists(AssignExpr obj_0 | obj_0=target_4.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=vvclock_index_266
		and obj_0.getRValue() instanceof FunctionCall
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

from Function func, Variable vvclock_index_266, Variable vsize_268, Variable vmax_269, FunctionCall target_0, SizeofTypeOperator target_1, VariableAccess target_2, AssignExpr target_3, ExprStmt target_4
where
func_0(vvclock_index_266, vsize_268, target_0)
and func_1(func, target_1)
and func_2(vmax_269, target_2)
and func_3(vsize_268, vmax_269, target_3)
and func_4(vvclock_index_266, func, target_4)
and vvclock_index_266.getType().hasName("unsigned int *")
and vsize_268.getType().hasName("size_t")
and vmax_269.getType().hasName("u32")
and vvclock_index_266.(LocalVariable).getFunction() = func
and vsize_268.(LocalVariable).getFunction() = func
and vmax_269.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
