/**
 * @name linux-ea3d7209ca01da209cda6f0dea8be9cc4b7a933b-ext4_zero_range
 * @id cpp/linux/ea3d7209ca01da209cda6f0dea8be9cc4b7a933b/ext4-zero-range
 * @description linux-ea3d7209ca01da209cda6f0dea8be9cc4b7a933b-fs/ext4/extents.c-ext4_zero_range CVE-2015-8839
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinode_4763, Initializer target_0) {
		target_0.getExpr().(PointerFieldAccess).getTarget().getName()="i_mapping"
		and target_0.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_4763
}

predicate func_1(Function func) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("down_write")
		and target_1.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mmap_sem"
		and target_1.getEnclosingFunction() = func)
}

/*predicate func_3(LogicalAndExpr target_9, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("const inode *")
		and target_3.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="592"
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_3
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
		and target_3.getEnclosingFunction() = func)
}

*/
predicate func_4(RelationalOperation target_6, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(FunctionCall).getTarget().hasName("up_write")
		and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mmap_sem"
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(7)=target_4
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Parameter voffset_4760, Parameter vlen_4761, AddExpr target_5) {
		target_5.getAnOperand().(VariableAccess).getTarget()=voffset_4760
		and target_5.getAnOperand().(VariableAccess).getTarget()=vlen_4761
		and target_5.getParent().(SubExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_6(Variable vmax_blocks_4765, BlockStmt target_13, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(VariableAccess).getTarget()=vmax_blocks_4765
		and target_6.getLesserOperand().(Literal).getValue()="0"
		and target_6.getParent().(IfStmt).getThen()=target_13
}

predicate func_7(Variable vinode_4763, VariableAccess target_7) {
		target_7.getTarget()=vinode_4763
}

predicate func_9(Variable vmapping_4773, BlockStmt target_14, LogicalAndExpr target_9) {
		target_9.getAnOperand().(PointerFieldAccess).getTarget().getName()="nrpages"
		and target_9.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmapping_4773
		and target_9.getAnOperand().(FunctionCall).getTarget().hasName("mapping_tagged")
		and target_9.getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmapping_4773
		and target_9.getAnOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_9.getParent().(IfStmt).getThen()=target_14
}

predicate func_10(Variable vret_4767, Variable vmapping_4773, Parameter voffset_4760, AssignExpr target_10) {
		target_10.getLValue().(VariableAccess).getTarget()=vret_4767
		and target_10.getRValue().(FunctionCall).getTarget().hasName("filemap_write_and_wait_range")
		and target_10.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmapping_4773
		and target_10.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voffset_4760
		and target_10.getRValue().(FunctionCall).getArgument(2).(SubExpr).getLeftOperand() instanceof AddExpr
		and target_10.getRValue().(FunctionCall).getArgument(2).(SubExpr).getRightOperand().(Literal).getValue()="1"
}

predicate func_11(Variable vret_4767, LogicalAndExpr target_9, IfStmt target_11) {
		target_11.getCondition().(VariableAccess).getTarget()=vret_4767
		and target_11.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_4767
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_12(Variable vmax_blocks_4765, Variable vnew_size_4766, Variable vret_4767, Variable vflags_4768, Variable vstart_4771, Variable vend_4771, Variable vlblk_4772, Parameter vfile_4760, Parameter vmode_4761, Variable vinode_4763, Function func, IfStmt target_12) {
		target_12.getCondition() instanceof RelationalOperation
		and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vflags_4768
		and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="1073742336"
		and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("truncate_pagecache_range")
		and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vstart_4771
		and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vend_4771
		and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="i_mtime"
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="i_ctime"
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ext4_current_time")
		and target_12.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ext4_inode_block_unlocked_dio")
		and target_12.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("inode_dio_wait")
		and target_12.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_4763
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_4767
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ext4_alloc_file_blocks")
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfile_4760
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlblk_4772
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmax_blocks_4765
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vnew_size_4766
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vflags_4768
		and target_12.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vmode_4761
		and target_12.getThen().(BlockStmt).getStmt(6).(IfStmt).getCondition().(VariableAccess).getTarget()=vret_4767
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Variable vflags_4768, Variable vstart_4771, Variable vend_4771, Variable vinode_4763, BlockStmt target_13) {
		target_13.getStmt(0).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vflags_4768
		and target_13.getStmt(0).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="1073742336"
		and target_13.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("truncate_pagecache_range")
		and target_13.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_4763
		and target_13.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vstart_4771
		and target_13.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vend_4771
		and target_13.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SubExpr).getRightOperand().(Literal).getValue()="1"
}

predicate func_14(Function func, BlockStmt target_14) {
		target_14.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
		and target_14.getStmt(1) instanceof IfStmt
		and target_14.getEnclosingFunction() = func
}

from Function func, Variable vmax_blocks_4765, Variable vnew_size_4766, Variable vret_4767, Variable vflags_4768, Variable vstart_4771, Variable vend_4771, Variable vlblk_4772, Variable vmapping_4773, Parameter vfile_4760, Parameter voffset_4760, Parameter vlen_4761, Parameter vmode_4761, Variable vinode_4763, Initializer target_0, AddExpr target_5, RelationalOperation target_6, VariableAccess target_7, LogicalAndExpr target_9, AssignExpr target_10, IfStmt target_11, IfStmt target_12, BlockStmt target_13, BlockStmt target_14
where
func_0(vinode_4763, target_0)
and not func_1(func)
and not func_4(target_6, func)
and func_5(voffset_4760, vlen_4761, target_5)
and func_6(vmax_blocks_4765, target_13, target_6)
and func_7(vinode_4763, target_7)
and func_9(vmapping_4773, target_14, target_9)
and func_10(vret_4767, vmapping_4773, voffset_4760, target_10)
and func_11(vret_4767, target_9, target_11)
and func_12(vmax_blocks_4765, vnew_size_4766, vret_4767, vflags_4768, vstart_4771, vend_4771, vlblk_4772, vfile_4760, vmode_4761, vinode_4763, func, target_12)
and func_13(vflags_4768, vstart_4771, vend_4771, vinode_4763, target_13)
and func_14(func, target_14)
and vmax_blocks_4765.getType().hasName("unsigned int")
and vnew_size_4766.getType().hasName("loff_t")
and vret_4767.getType().hasName("int")
and vflags_4768.getType().hasName("int")
and vstart_4771.getType().hasName("loff_t")
and vend_4771.getType().hasName("loff_t")
and vlblk_4772.getType().hasName("ext4_lblk_t")
and vmapping_4773.getType().hasName("address_space *")
and vfile_4760.getType().hasName("file *")
and voffset_4760.getType().hasName("loff_t")
and vlen_4761.getType().hasName("loff_t")
and vmode_4761.getType().hasName("int")
and vinode_4763.getType().hasName("inode *")
and vmax_blocks_4765.(LocalVariable).getFunction() = func
and vnew_size_4766.(LocalVariable).getFunction() = func
and vret_4767.(LocalVariable).getFunction() = func
and vflags_4768.(LocalVariable).getFunction() = func
and vstart_4771.(LocalVariable).getFunction() = func
and vend_4771.(LocalVariable).getFunction() = func
and vlblk_4772.(LocalVariable).getFunction() = func
and vmapping_4773.(LocalVariable).getFunction() = func
and vfile_4760.getFunction() = func
and voffset_4760.getFunction() = func
and vlen_4761.getFunction() = func
and vmode_4761.getFunction() = func
and vinode_4763.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
