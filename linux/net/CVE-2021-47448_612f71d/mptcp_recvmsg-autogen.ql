/**
 * @name linux-612f71d7328c14369924384ad2170aae2a6abd92-mptcp_recvmsg
 * @id cpp/linux/612f71d7328c14369924384ad2170aae2a6abd92/mptcp-recvmsg
 * @description linux-612f71d7328c14369924384ad2170aae2a6abd92-net/mptcp/protocol.c-mptcp_recvmsg CVE-2021-47448
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Function func, StringLiteral target_1) {
	target_1.getValue()="MPTCP: msk=%p data_ready=%d rx queue empty=%d copied=%d"
	and not target_1.getValue()="MPTCP: msk=%p rx queue empty=%d:%d copied=%d"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Parameter vsk_1990, AddressOfExpr target_17) {
exists(FunctionCall target_2 |
	target_2.getTarget().hasName("sk_wait_data")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vsk_1990
	and target_2.getArgument(1) instanceof AddressOfExpr
	and target_2.getArgument(2) instanceof Literal
	and target_2.getArgument(0).(VariableAccess).getLocation().isBefore(target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vtimeo_1997, AddressOfExpr target_3) {
	target_3.getOperand().(VariableAccess).getTarget()=vtimeo_1997
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Variable vmsk_1993, Parameter vsk_1990, BlockStmt target_18, FunctionCall target_4) {
	target_4.getTarget().hasName("skb_queue_empty_lockless")
	and target_4.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_4.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_4.getParent().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("skb_queue_empty")
	and target_4.getParent().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="receive_queue"
	and target_4.getParent().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_4.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_18
}

/*predicate func_5(Variable vmsk_1993, Parameter vsk_1990, BlockStmt target_18, FunctionCall target_5) {
	target_5.getTarget().hasName("skb_queue_empty")
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="receive_queue"
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_5.getParent().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("skb_queue_empty_lockless")
	and target_5.getParent().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_5.getParent().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_5.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_18
}

*/
predicate func_6(Variable vbranch_2101, ExprStmt target_19, StmtExpr target_6) {
	target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BuiltInOperation).getValue()="0"
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_2101
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(BuiltInOperation).getValue()="1"
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_2101
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_2101
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("____wrong_branch_error")
	and target_6.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_6.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vbranch_2101
	and target_6.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_6.getParent().(IfStmt).getThen()=target_19
}

predicate func_7(Parameter vsk_1990, VariableAccess target_7) {
	target_7.getTarget()=vsk_1990
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_9(Parameter vsk_1990, FunctionCall target_9) {
	target_9.getTarget().hasName("mptcp_wait_data")
	and target_9.getArgument(0).(VariableAccess).getTarget()=vsk_1990
	and target_9.getArgument(1) instanceof AddressOfExpr
}

predicate func_10(Variable vmsk_1993, Function func, IfStmt target_10) {
	target_10.getCondition().(LogicalAndExpr).getLeftOperand() instanceof FunctionCall
	and target_10.getCondition().(LogicalAndExpr).getRightOperand() instanceof FunctionCall
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("clear_bit")
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof Literal
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("__mptcp_move_skbs")
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Variable vmsk_1993, LogicalAndExpr target_20, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("clear_bit")
	and target_11.getExpr().(FunctionCall).getArgument(0) instanceof Literal
	and target_11.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_11.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
}

*/
/*predicate func_12(Variable vmsk_1993, ExprStmt target_21, FunctionCall target_12) {
	target_12.getTarget().hasName("__builtin_expect")
	and target_12.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("__mptcp_move_skbs")
	and target_12.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmsk_1993
	and target_12.getArgument(1).(Literal).getValue()="0"
	and target_12.getParent().(IfStmt).getThen()=target_21
}

*/
/*predicate func_13(Variable vmsk_1993, FunctionCall target_13) {
	target_13.getTarget().hasName("set_bit")
	and target_13.getArgument(0).(Literal).getValue()="0"
	and target_13.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_13.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
}

*/
predicate func_14(Variable vmsk_1993, Variable vcopied_1995, Variable v__UNIQUE_ID_ddebug1964_2101, Parameter vsk_1990, IfStmt target_14) {
	target_14.getCondition() instanceof StmtExpr
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug1964_2101
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsk_1993
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getTarget().hasName("test_bit")
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(0) instanceof Literal
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getTarget().hasName("skb_queue_empty_lockless")
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_14.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vcopied_1995
}

/*predicate func_15(Variable vmsk_1993, Variable vcopied_1995, Variable v__UNIQUE_ID_ddebug1964_2101, Parameter vsk_1990, FunctionCall target_15) {
	target_15.getTarget().hasName("test_bit")
	and target_15.getArgument(0) instanceof Literal
	and target_15.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_15.getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug1964_2101
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsk_1993
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getTarget().hasName("skb_queue_empty_lockless")
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vcopied_1995
}

*/
/*predicate func_16(Variable vmsk_1993, Variable vcopied_1995, Variable v__UNIQUE_ID_ddebug1964_2101, Parameter vsk_1990, FunctionCall target_16) {
	target_16.getTarget().hasName("skb_queue_empty_lockless")
	and target_16.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_16.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug1964_2101
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsk_1993
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getTarget().hasName("test_bit")
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(0) instanceof Literal
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsk_1993
	and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vcopied_1995
}

*/
predicate func_17(Parameter vsk_1990, AddressOfExpr target_17) {
	target_17.getOperand().(PointerFieldAccess).getTarget().getName()="sk_receive_queue"
	and target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1990
	and target_17.getParent().(FunctionCall).getParent().(LogicalAndExpr).getLeftOperand() instanceof FunctionCall
}

predicate func_18(Function func, BlockStmt target_18) {
	target_18.getStmt(0) instanceof ExprStmt
	and target_18.getStmt(1).(IfStmt).getCondition() instanceof FunctionCall
	and target_18.getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Variable vmsk_1993, Variable vcopied_1995, Variable v__UNIQUE_ID_ddebug1964_2101, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug1964_2101
	and target_19.getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
	and target_19.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsk_1993
	and target_19.getExpr().(FunctionCall).getArgument(3) instanceof FunctionCall
	and target_19.getExpr().(FunctionCall).getArgument(4) instanceof FunctionCall
	and target_19.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vcopied_1995
}

predicate func_20(Function func, LogicalAndExpr target_20) {
	target_20.getLeftOperand() instanceof FunctionCall
	and target_20.getRightOperand() instanceof FunctionCall
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Function func, ExprStmt target_21) {
	target_21.getExpr() instanceof FunctionCall
	and target_21.getEnclosingFunction() = func
}

from Function func, Variable vmsk_1993, Variable vcopied_1995, Variable vtimeo_1997, Variable v__UNIQUE_ID_ddebug1964_2101, Variable vbranch_2101, Parameter vsk_1990, StringLiteral target_1, AddressOfExpr target_3, FunctionCall target_4, StmtExpr target_6, VariableAccess target_7, FunctionCall target_9, IfStmt target_10, IfStmt target_14, AddressOfExpr target_17, BlockStmt target_18, ExprStmt target_19, LogicalAndExpr target_20, ExprStmt target_21
where
func_1(func, target_1)
and not func_2(vsk_1990, target_17)
and func_3(vtimeo_1997, target_3)
and func_4(vmsk_1993, vsk_1990, target_18, target_4)
and func_6(vbranch_2101, target_19, target_6)
and func_7(vsk_1990, target_7)
and func_9(vsk_1990, target_9)
and func_10(vmsk_1993, func, target_10)
and func_14(vmsk_1993, vcopied_1995, v__UNIQUE_ID_ddebug1964_2101, vsk_1990, target_14)
and func_17(vsk_1990, target_17)
and func_18(func, target_18)
and func_19(vmsk_1993, vcopied_1995, v__UNIQUE_ID_ddebug1964_2101, target_19)
and func_20(func, target_20)
and func_21(func, target_21)
and vmsk_1993.getType().hasName("mptcp_sock *")
and vcopied_1995.getType().hasName("int")
and vtimeo_1997.getType().hasName("long")
and v__UNIQUE_ID_ddebug1964_2101.getType().hasName("_ddebug")
and vbranch_2101.getType().hasName("bool")
and vsk_1990.getType().hasName("sock *")
and vmsk_1993.(LocalVariable).getFunction() = func
and vcopied_1995.(LocalVariable).getFunction() = func
and vtimeo_1997.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug1964_2101.(LocalVariable).getFunction() = func
and vbranch_2101.(LocalVariable).getFunction() = func
and vsk_1990.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
