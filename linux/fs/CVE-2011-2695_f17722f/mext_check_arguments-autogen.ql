/**
 * @name linux-f17722f917b2f21497deb6edc62fb1683daa08e6-mext_check_arguments
 * @id cpp/linux/f17722f917b2f21497deb6edc62fb1683daa08e6/mext-check-arguments
 * @description linux-f17722f917b2f21497deb6edc62fb1683daa08e6-fs/ext4/move_extent.c-mext_check_arguments CVE-2011-2695
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vorig_start_948, EqualityOperation target_12) {
	exists(RelationalOperation target_0 |
		 (target_0 instanceof GEExpr or target_0 instanceof LEExpr)
		and target_0.getGreaterOperand().(VariableAccess).getTarget()=vorig_start_948
		and target_0.getLesserOperand() instanceof Literal
		and target_12.getAnOperand().(VariableAccess).getLocation().isBefore(target_0.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vdonor_start_949, EqualityOperation target_12) {
	exists(RelationalOperation target_1 |
		 (target_1 instanceof GEExpr or target_1 instanceof LEExpr)
		and target_1.getGreaterOperand().(VariableAccess).getTarget()=vdonor_start_949
		and target_1.getLesserOperand() instanceof Literal
		and target_12.getAnOperand().(VariableAccess).getLocation().isBefore(target_1.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vlen_949, BlockStmt target_14) {
	exists(RelationalOperation target_2 |
		 (target_2 instanceof GEExpr or target_2 instanceof LEExpr)
		and target_2.getGreaterOperand() instanceof AddExpr
		and target_2.getLesserOperand() instanceof Literal
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand() instanceof RelationalOperation
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand() instanceof RelationalOperation
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vlen_949
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="4294967295"
		and target_2.getParent().(LogicalOrExpr).getAnOperand() instanceof RelationalOperation
		and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_14)
}

predicate func_3(Parameter vorig_start_948, Parameter vlen_949, AddExpr target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vorig_start_948
		and target_3.getAnOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vlen_949
}

predicate func_4(Parameter vorig_start_948, VariableAccess target_4) {
		target_4.getTarget()=vorig_start_948
}

predicate func_6(Parameter vdonor_start_949, VariableAccess target_6) {
		target_6.getTarget()=vdonor_start_949
}

/*predicate func_9(Parameter vorig_start_948, RelationalOperation target_9) {
		 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
		and target_9.getGreaterOperand().(VariableAccess).getTarget()=vorig_start_948
		and target_9.getLesserOperand() instanceof Literal
}

*/
/*predicate func_10(Parameter vdonor_start_949, RelationalOperation target_10) {
		 (target_10 instanceof GTExpr or target_10 instanceof LTExpr)
		and target_10.getGreaterOperand().(VariableAccess).getTarget()=vdonor_start_949
		and target_10.getLesserOperand() instanceof Literal
}

*/
predicate func_11(Parameter vorig_start_948, Parameter vdonor_start_949, Parameter vlen_949, BlockStmt target_14, RelationalOperation target_11) {
		 (target_11 instanceof GTExpr or target_11 instanceof LTExpr)
		and target_11.getGreaterOperand() instanceof AddExpr
		and target_11.getLesserOperand() instanceof Literal
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vorig_start_948
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand() instanceof Literal
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vdonor_start_949
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand() instanceof Literal
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vlen_949
		and target_11.getParent().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="4294967295"
		and target_11.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_14
}

predicate func_12(Parameter vorig_start_948, Parameter vdonor_start_949, EqualityOperation target_12) {
		target_12.getAnOperand().(VariableAccess).getTarget()=vorig_start_948
		and target_12.getAnOperand().(VariableAccess).getTarget()=vdonor_start_949
}

predicate func_14(LogicalOrExpr target_15, Function func, BlockStmt target_14) {
		target_14.getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
		and target_14.getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_14.getParent().(IfStmt).getCondition()=target_15
		and target_14.getEnclosingFunction() = func
}

predicate func_15(Parameter vlen_949, LogicalOrExpr target_15) {
		target_15.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand() instanceof RelationalOperation
		and target_15.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand() instanceof RelationalOperation
		and target_15.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vlen_949
		and target_15.getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="4294967295"
		and target_15.getAnOperand() instanceof RelationalOperation
}

from Function func, Parameter vorig_start_948, Parameter vdonor_start_949, Parameter vlen_949, AddExpr target_3, VariableAccess target_4, VariableAccess target_6, RelationalOperation target_11, EqualityOperation target_12, BlockStmt target_14, LogicalOrExpr target_15
where
not func_0(vorig_start_948, target_12)
and not func_1(vdonor_start_949, target_12)
and not func_2(vlen_949, target_14)
and func_3(vorig_start_948, vlen_949, target_3)
and func_4(vorig_start_948, target_4)
and func_6(vdonor_start_949, target_6)
and func_11(vorig_start_948, vdonor_start_949, vlen_949, target_14, target_11)
and func_12(vorig_start_948, vdonor_start_949, target_12)
and func_14(target_15, func, target_14)
and func_15(vlen_949, target_15)
and vorig_start_948.getType().hasName("__u64")
and vdonor_start_949.getType().hasName("__u64")
and vlen_949.getType().hasName("__u64 *")
and vorig_start_948.getFunction() = func
and vdonor_start_949.getFunction() = func
and vlen_949.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
