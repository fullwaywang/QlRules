/**
 * @name linux-394f56fe480140877304d342dec46d50dc823d46-vdso_addr
 * @id cpp/linux/394f56fe480140877304d342dec46d50dc823d46/vdso-addr
 * @description linux-394f56fe480140877304d342dec46d50dc823d46-arch/x86/vdso/vma.c-vdso_addr CVE-2014-9585
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vaddr_55, Variable vend_55, RelationalOperation target_14, VariableAccess target_0) {
		target_0.getTarget()=vend_55
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vaddr_55
		and target_14.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getLocation())
}

predicate func_1(Variable vaddr_55, VariableAccess target_1) {
		target_1.getTarget()=vaddr_55
		and target_1.getParent().(AssignExpr).getLValue() = target_1
		and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vaddr_55
		and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getValue()="4095"
		and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073709547520"
}

/*predicate func_2(Variable vaddr_55, VariableAccess target_2) {
		target_2.getTarget()=vaddr_55
}

*/
predicate func_3(Function func, Literal target_3) {
		target_3.getValue()="512"
		and not target_3.getValue()="12"
		and target_3.getParent().(SubExpr).getParent().(BitwiseAndExpr).getRightOperand() instanceof SubExpr
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vaddr_55, Variable vend_55, ExprStmt target_15, ExprStmt target_8, VariableAccess target_4) {
		target_4.getTarget()=vaddr_55
		and target_4.getParent().(GEExpr).getLesserOperand().(VariableAccess).getTarget()=vend_55
		and target_4.getParent().(GEExpr).getParent().(IfStmt).getThen()=target_15
		and target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getLocation())
}

predicate func_5(Parameter vlen_50, Parameter vstart_50, ExprStmt target_16) {
	exists(AddExpr target_5 |
		target_5.getAnOperand().(VariableAccess).getTarget()=vstart_50
		and target_5.getAnOperand().(VariableAccess).getTarget()=vlen_50
		and target_5.getAnOperand().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_6(Variable vend_55, ExprStmt target_15) {
	exists(RelationalOperation target_6 |
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(VariableAccess).getTarget()=vend_55
		and target_6.getLesserOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_6.getParent().(IfStmt).getThen()=target_15)
}

predicate func_7(Variable vend_55, Variable voffset_56, Parameter vstart_50, ExprStmt target_16, RelationalOperation target_14, ExprStmt target_17, ExprStmt target_8) {
	exists(RemExpr target_7 |
		target_7.getLeftOperand() instanceof FunctionCall
		and target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vend_55
		and target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vstart_50
		and target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
		and target_7.getRightOperand().(AddExpr).getAnOperand() instanceof Literal
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_56
		and target_16.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation())
		and target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_14.getLesserOperand().(VariableAccess).getLocation())
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation())
		and target_7.getRightOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_8(Variable vaddr_55, Variable voffset_56, Parameter vstart_50, Function func, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vaddr_55
		and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vstart_50
		and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=voffset_56
		and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vstart_50, VariableAccess target_9) {
		target_9.getTarget()=vstart_50
}

predicate func_10(Function func, FunctionCall target_10) {
		target_10.getTarget().hasName("get_random_int")
		and target_10.getEnclosingFunction() = func
}

predicate func_12(Variable vaddr_55, Variable vend_55, ExprStmt target_15, VariableAccess target_12) {
		target_12.getTarget()=vend_55
		and target_12.getParent().(GEExpr).getGreaterOperand().(VariableAccess).getTarget()=vaddr_55
		and target_12.getParent().(GEExpr).getParent().(IfStmt).getThen()=target_15
}

predicate func_13(Variable voffset_56, BitwiseAndExpr target_13) {
		target_13.getLeftOperand() instanceof FunctionCall
		and target_13.getRightOperand().(SubExpr).getValue()="511"
		and target_13.getParent().(AssignExpr).getRValue() = target_13
		and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_56
}

predicate func_14(Variable vaddr_55, Variable vend_55, ExprStmt target_15, RelationalOperation target_14) {
		 (target_14 instanceof GEExpr or target_14 instanceof LEExpr)
		and target_14.getGreaterOperand().(VariableAccess).getTarget()=vaddr_55
		and target_14.getLesserOperand().(VariableAccess).getTarget()=vend_55
		and target_14.getParent().(IfStmt).getThen()=target_15
}

predicate func_15(Variable vaddr_55, Variable vend_55, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vaddr_55
		and target_15.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vend_55
}

predicate func_16(Variable vend_55, Parameter vlen_50, ExprStmt target_16) {
		target_16.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vend_55
		and target_16.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vlen_50
}

predicate func_17(Variable vend_55, Parameter vstart_50, ExprStmt target_17) {
		target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vend_55
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vstart_50
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getValue()="2097152"
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073707454464"
}

from Function func, Variable vaddr_55, Variable vend_55, Variable voffset_56, Parameter vlen_50, Parameter vstart_50, VariableAccess target_0, VariableAccess target_1, Literal target_3, VariableAccess target_4, ExprStmt target_8, VariableAccess target_9, FunctionCall target_10, VariableAccess target_12, BitwiseAndExpr target_13, RelationalOperation target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_17
where
func_0(vaddr_55, vend_55, target_14, target_0)
and func_1(vaddr_55, target_1)
and func_3(func, target_3)
and func_4(vaddr_55, vend_55, target_15, target_8, target_4)
and not func_5(vlen_50, vstart_50, target_16)
and not func_6(vend_55, target_15)
and not func_7(vend_55, voffset_56, vstart_50, target_16, target_14, target_17, target_8)
and func_8(vaddr_55, voffset_56, vstart_50, func, target_8)
and func_9(vstart_50, target_9)
and func_10(func, target_10)
and func_12(vaddr_55, vend_55, target_15, target_12)
and func_13(voffset_56, target_13)
and func_14(vaddr_55, vend_55, target_15, target_14)
and func_15(vaddr_55, vend_55, target_15)
and func_16(vend_55, vlen_50, target_16)
and func_17(vend_55, vstart_50, target_17)
and vaddr_55.getType().hasName("unsigned long")
and vend_55.getType().hasName("unsigned long")
and voffset_56.getType().hasName("unsigned int")
and vlen_50.getType().hasName("unsigned int")
and vstart_50.getType().hasName("unsigned long")
and vaddr_55.(LocalVariable).getFunction() = func
and vend_55.(LocalVariable).getFunction() = func
and voffset_56.(LocalVariable).getFunction() = func
and vlen_50.getFunction() = func
and vstart_50.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
