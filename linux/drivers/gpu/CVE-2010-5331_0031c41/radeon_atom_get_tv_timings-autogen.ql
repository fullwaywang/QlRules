/**
 * @name linux-0031c41be5c529f8329e327b63cde92ba1284842-radeon_atom_get_tv_timings
 * @id cpp/linux/0031c41be5c529f8329e327b63cde92ba1284842/radeon-atom-get-tv-timings
 * @description linux-0031c41be5c529f8329e327b63cde92ba1284842-drivers/gpu/drm/radeon/radeon_atombios.c-radeon_atom_get_tv_timings CVE-2010-5331
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vindex_1249, ReturnStmt target_8, ExprStmt target_9) {
exists(RelationalOperation target_0 |
	 (target_0 instanceof GEExpr or target_0 instanceof LEExpr)
	and target_0.getGreaterOperand().(VariableAccess).getTarget()=vindex_1249
	and target_0.getLesserOperand() instanceof Literal
	and target_0.getParent().(IfStmt).getThen()=target_8
	and target_0.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vindex_1249, ReturnStmt target_10, ExprStmt target_11) {
exists(RelationalOperation target_1 |
	 (target_1 instanceof GEExpr or target_1 instanceof LEExpr)
	and target_1.getGreaterOperand().(VariableAccess).getTarget()=vindex_1249
	and target_1.getLesserOperand() instanceof Literal
	and target_1.getParent().(IfStmt).getThen()=target_10
	and target_1.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vindex_1249, ReturnStmt target_8, VariableAccess target_2) {
	target_2.getTarget()=vindex_1249
	and target_2.getParent().(GTExpr).getLesserOperand().(Literal).getValue()="2"
	and target_2.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_8
}

predicate func_4(Parameter vindex_1249, ReturnStmt target_10, VariableAccess target_4) {
	target_4.getTarget()=vindex_1249
	and target_4.getParent().(GTExpr).getLesserOperand().(Literal).getValue()="3"
	and target_4.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_10
}

predicate func_6(Parameter vindex_1249, ReturnStmt target_8, RelationalOperation target_6) {
	 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
	and target_6.getGreaterOperand().(VariableAccess).getTarget()=vindex_1249
	and target_6.getLesserOperand() instanceof Literal
	and target_6.getParent().(IfStmt).getThen()=target_8
}

predicate func_7(Parameter vindex_1249, ReturnStmt target_10, RelationalOperation target_7) {
	 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
	and target_7.getGreaterOperand().(VariableAccess).getTarget()=vindex_1249
	and target_7.getLesserOperand() instanceof Literal
	and target_7.getParent().(IfStmt).getThen()=target_10
}

predicate func_8(RelationalOperation target_6, Function func, ReturnStmt target_8) {
	target_8.getParent().(IfStmt).getCondition()=target_6
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vindex_1249, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="crtc_htotal"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("drm_display_mode *")
	and target_9.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="usCRTC_H_Total"
	and target_9.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="aModeTimings"
	and target_9.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("ATOM_ANALOG_TV_INFO *")
	and target_9.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_1249
}

predicate func_10(RelationalOperation target_7, Function func, ReturnStmt target_10) {
	target_10.getParent().(IfStmt).getCondition()=target_7
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Parameter vindex_1249, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("ATOM_DTD_FORMAT *")
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="aModeTimings"
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("ATOM_ANALOG_TV_INFO_V1_2 *")
	and target_11.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_1249
}

from Function func, Parameter vindex_1249, VariableAccess target_2, VariableAccess target_4, RelationalOperation target_6, RelationalOperation target_7, ReturnStmt target_8, ExprStmt target_9, ReturnStmt target_10, ExprStmt target_11
where
not func_0(vindex_1249, target_8, target_9)
and not func_1(vindex_1249, target_10, target_11)
and func_2(vindex_1249, target_8, target_2)
and func_4(vindex_1249, target_10, target_4)
and func_6(vindex_1249, target_8, target_6)
and func_7(vindex_1249, target_10, target_7)
and func_8(target_6, func, target_8)
and func_9(vindex_1249, target_9)
and func_10(target_7, func, target_10)
and func_11(vindex_1249, target_11)
and vindex_1249.getType().hasName("int")
and vindex_1249.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
