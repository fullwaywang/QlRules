/**
 * @name memcached-bd578fc34b96abe0f8d99c1409814a09f51ee71c-dispatch_bin_command
 * @id cpp/memcached/bd578fc34b96abe0f8d99c1409814a09f51ee71c/dispatch-bin-command
 * @description memcached-bd578fc34b96abe0f8d99c1409814a09f51ee71c-memcached.c-dispatch_bin_command CVE-2016-8706
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Variable vextlen_2000, Variable vkeylen_2001, Variable vbodylen_2002, Parameter vc_1997, LogicalAndExpr target_4, RelationalOperation target_6, ValueFieldAccess target_8, LogicalAndExpr target_9, Function func) {
	exists(IfStmt target_2 |
		target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vkeylen_2001
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vbodylen_2002
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vkeylen_2001
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vextlen_2000
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vbodylen_2002
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("write_bin_error")
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_1997
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="0"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="write_and_go"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vc_1997
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_6.getGreaterOperand().(VariableAccess).getLocation())
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Variable vextlen_2000, Variable vkeylen_2001, Variable vbodylen_2002, LogicalAndExpr target_4) {
		target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vextlen_2000
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vkeylen_2001
		and target_4.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vbodylen_2002
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
}

predicate func_6(Variable vkeylen_2001, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(VariableAccess).getTarget()=vkeylen_2001
		and target_6.getLesserOperand().(Literal).getValue()="250"
}

predicate func_8(Parameter vc_1997, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="request"
		and target_8.getQualifier().(PointerFieldAccess).getTarget().getName()="binary_header"
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vc_1997
}

predicate func_9(Parameter vc_1997, LogicalAndExpr target_9) {
		target_9.getAnOperand().(ValueFieldAccess).getTarget().getName()="sasl"
		and target_9.getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("settings")
		and target_9.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("authenticated")
		and target_9.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vc_1997
}

from Function func, Variable vextlen_2000, Variable vkeylen_2001, Variable vbodylen_2002, Parameter vc_1997, LogicalAndExpr target_4, RelationalOperation target_6, ValueFieldAccess target_8, LogicalAndExpr target_9
where
not func_2(vextlen_2000, vkeylen_2001, vbodylen_2002, vc_1997, target_4, target_6, target_8, target_9, func)
and func_4(vextlen_2000, vkeylen_2001, vbodylen_2002, target_4)
and func_6(vkeylen_2001, target_6)
and func_8(vc_1997, target_8)
and func_9(vc_1997, target_9)
and vextlen_2000.getType().hasName("int")
and vkeylen_2001.getType().hasName("int")
and vbodylen_2002.getType().hasName("uint32_t")
and vc_1997.getType().hasName("conn *")
and vextlen_2000.(LocalVariable).getFunction() = func
and vkeylen_2001.(LocalVariable).getFunction() = func
and vbodylen_2002.(LocalVariable).getFunction() = func
and vc_1997.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
