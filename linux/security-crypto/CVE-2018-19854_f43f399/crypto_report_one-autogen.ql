/**
 * @name linux-f43f39958beb206b53292801e216d9b8a660f087-crypto_report_one
 * @id cpp/linux/f43f39958beb206b53292801e216d9b8a660f087/crypto-report-one
 * @description linux-f43f39958beb206b53292801e216d9b8a660f087-crypto/crypto_user_base.c-crypto_report_one CVE-2018-19854
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vualg_162, Parameter valg_161) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("strncpy")
		and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_name"
		and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_0.getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_name"
		and target_0.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_161
		and target_0.getArgument(2) instanceof SizeofExprOperator)
}

predicate func_1(Parameter vualg_162, Parameter valg_161, SizeofExprOperator target_6, SizeofExprOperator target_9) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("strncpy")
		and target_1.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_driver_name"
		and target_1.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_1.getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_driver_name"
		and target_1.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_161
		and target_1.getArgument(2) instanceof SizeofExprOperator)
}

predicate func_2(Parameter vualg_162, SizeofExprOperator target_9, SizeofExprOperator target_12) {
	exists(FunctionCall target_2 |
		target_2.getTarget().hasName("strncpy")
		and target_2.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_module_name"
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_2.getArgument(1) instanceof StmtExpr
		and target_2.getArgument(2) instanceof SizeofExprOperator)
}

predicate func_3(Function func) {
	exists(FunctionCall target_3 |
		target_3.getTarget().hasName("strncpy")
		and target_3.getArgument(0) instanceof ValueFieldAccess
		and target_3.getArgument(1) instanceof StringLiteral
		and target_3.getArgument(2) instanceof SizeofExprOperator
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(Parameter vualg_162, PointerFieldAccess target_4) {
		target_4.getTarget().getName()="cru_name"
		and target_4.getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Parameter valg_161, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="cra_name"
		and target_5.getQualifier().(VariableAccess).getTarget()=valg_161
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Function func, SizeofExprOperator target_6) {
		target_6.getValue()="64"
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Parameter vualg_162, PointerFieldAccess target_7) {
		target_7.getTarget().getName()="cru_driver_name"
		and target_7.getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_8(Parameter valg_161, PointerFieldAccess target_8) {
		target_8.getTarget().getName()="cra_driver_name"
		and target_8.getQualifier().(VariableAccess).getTarget()=valg_161
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_9(Function func, SizeofExprOperator target_9) {
		target_9.getValue()="64"
		and target_9.getEnclosingFunction() = func
}

predicate func_10(Parameter vualg_162, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="cru_module_name"
		and target_10.getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_11(Variable v__mod_167, StmtExpr target_11) {
		target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(VariableAccess).getTarget()=v__mod_167
		and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="name"
		and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=v__mod_167
		and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getElse().(StringLiteral).getValue()="kernel"
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_12(Function func, SizeofExprOperator target_12) {
		target_12.getValue()="64"
		and target_12.getEnclosingFunction() = func
}

predicate func_13(Variable vrl_178, ValueFieldAccess target_13) {
		target_13.getTarget().getName()="type"
		and target_13.getQualifier().(VariableAccess).getTarget()=vrl_178
}

predicate func_14(Function func, SizeofExprOperator target_14) {
		target_14.getValue()="64"
		and target_14.getEnclosingFunction() = func
}

predicate func_16(Parameter vualg_162, Parameter valg_161, FunctionCall target_16) {
		target_16.getTarget().hasName("strlcpy")
		and target_16.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_name"
		and target_16.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_16.getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_name"
		and target_16.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_161
		and target_16.getArgument(2) instanceof SizeofExprOperator
}

predicate func_17(Parameter vualg_162, Parameter valg_161, FunctionCall target_17) {
		target_17.getTarget().hasName("strlcpy")
		and target_17.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_driver_name"
		and target_17.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_17.getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_driver_name"
		and target_17.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_161
		and target_17.getArgument(2) instanceof SizeofExprOperator
}

predicate func_18(Parameter vualg_162, FunctionCall target_18) {
		target_18.getTarget().hasName("strlcpy")
		and target_18.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_module_name"
		and target_18.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vualg_162
		and target_18.getArgument(1) instanceof StmtExpr
		and target_18.getArgument(2) instanceof SizeofExprOperator
}

predicate func_19(Function func, FunctionCall target_19) {
		target_19.getTarget().hasName("strlcpy")
		and target_19.getArgument(0) instanceof ValueFieldAccess
		and target_19.getArgument(1) instanceof StringLiteral
		and target_19.getArgument(2) instanceof SizeofExprOperator
		and target_19.getEnclosingFunction() = func
}

from Function func, Parameter vualg_162, Variable v__mod_167, Variable vrl_178, Parameter valg_161, PointerFieldAccess target_4, PointerFieldAccess target_5, SizeofExprOperator target_6, PointerFieldAccess target_7, PointerFieldAccess target_8, SizeofExprOperator target_9, PointerFieldAccess target_10, StmtExpr target_11, SizeofExprOperator target_12, ValueFieldAccess target_13, SizeofExprOperator target_14, FunctionCall target_16, FunctionCall target_17, FunctionCall target_18, FunctionCall target_19
where
not func_0(vualg_162, valg_161)
and not func_1(vualg_162, valg_161, target_6, target_9)
and not func_2(vualg_162, target_9, target_12)
and not func_3(func)
and func_4(vualg_162, target_4)
and func_5(valg_161, target_5)
and func_6(func, target_6)
and func_7(vualg_162, target_7)
and func_8(valg_161, target_8)
and func_9(func, target_9)
and func_10(vualg_162, target_10)
and func_11(v__mod_167, target_11)
and func_12(func, target_12)
and func_13(vrl_178, target_13)
and func_14(func, target_14)
and func_16(vualg_162, valg_161, target_16)
and func_17(vualg_162, valg_161, target_17)
and func_18(vualg_162, target_18)
and func_19(func, target_19)
and vualg_162.getType().hasName("crypto_user_alg *")
and v__mod_167.getType().hasName("module *")
and vrl_178.getType().hasName("crypto_report_larval")
and valg_161.getType().hasName("crypto_alg *")
and vualg_162.getFunction() = func
and v__mod_167.(LocalVariable).getFunction() = func
and vrl_178.(LocalVariable).getFunction() = func
and valg_161.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
