/**
 * @name linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-__io_req_init_async
 * @id cpp/linux/4379bf8bd70b5de6bba7d53015b0c36c57a634ee/--io-req-init-async
 * @description linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-fs/io_uring.c-__io_req_init_async CVE-2022-20409
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, SizeofExprOperator target_0) {
	target_0.getValue()="24"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vreq_1246, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="flags"
	and target_1.getQualifier().(VariableAccess).getTarget()=vreq_1246
}

predicate func_2(Parameter vreq_1246, ExprStmt target_18, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand() instanceof EnumConstantAccess
	and target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="creds"
	and target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_2.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_2.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="creds"
	and target_2.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_2.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_2.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_2.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerFieldAccess).getTarget().getName()="cred"
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("const cred *")
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("override_creds")
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="creds"
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_18.getLocation()))
}

/*predicate func_3(Function func) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getType().hasName("bool")
	and target_3.getEnclosingFunction() = func)
}

*/
/*predicate func_4(Function func) {
exists(FunctionCall target_4 |
	target_4.getTarget().hasName("lockdep_rcu_suspicious")
	and target_4.getArgument(0) instanceof StringLiteral
	and target_4.getArgument(1) instanceof Literal
	and target_4.getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
	and target_4.getEnclosingFunction() = func)
}

*/
predicate func_5(Parameter vreq_1246, ExprStmt target_18, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_issue_sqe")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_18.getLocation()))
}

predicate func_6(ExprStmt target_18, Function func) {
exists(IfStmt target_6 |
	target_6.getCondition().(VariableAccess).getType().hasName("const cred *")
	and target_6.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("revert_creds")
	and target_6.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("const cred *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getLocation().isBefore(target_18.getLocation()))
}

predicate func_7(Parameter vreq_1246, ExprStmt target_18, AddressOfExpr target_19, Function func) {
exists(IfStmt target_7 |
	target_7.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_7.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="-11"
	and target_7.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_7.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_7.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("io_arm_poll_handler")
	and target_7.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_7.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_queue_async_work")
	and target_7.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_7.getElse().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_7.getElse().(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_7.getElse().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_7.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_7.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_7.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_put_req")
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("req_set_fail_links")
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_put_req")
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_req_complete")
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1246
	and target_7.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_18.getLocation())
	and target_7.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_9(Function func) {
exists(PointerFieldAccess target_9 |
	target_9.getTarget().getName()="reqs"
	and target_9.getQualifier().(VariableAccess).getType().hasName("io_comp_state *")
	and target_9.getEnclosingFunction() = func)
}

*/
predicate func_10(ExprStmt target_18, Function func) {
exists(IfStmt target_10 |
	target_10.getCondition().(VariableAccess).getType().hasName("io_kiocb *")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_queue_linked_timeout")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("io_kiocb *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getLocation().isBefore(target_18.getLocation()))
}

predicate func_11(Parameter vreq_1246, PointerFieldAccess target_11) {
	target_11.getTarget().getName()="work"
	and target_11.getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_11.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_12(Parameter vreq_1246, PointerFieldAccess target_12) {
	target_12.getTarget().getName()="work"
	and target_12.getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_12.getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_13(Parameter vreq_1246, VariableAccess target_13) {
	target_13.getTarget()=vreq_1246
}

predicate func_16(Parameter vreq_1246, FunctionCall target_16) {
	target_16.getTarget().hasName("__memset")
	and target_16.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="work"
	and target_16.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_16.getArgument(1) instanceof Literal
	and target_16.getArgument(2) instanceof SizeofExprOperator
}

predicate func_17(Parameter vreq_1246, AssignOrExpr target_17) {
	target_17.getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_17.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
	and target_17.getRValue() instanceof EnumConstantAccess
}

predicate func_18(Function func, ExprStmt target_18) {
	target_18.getExpr() instanceof FunctionCall
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Parameter vreq_1246, AddressOfExpr target_19) {
	target_19.getOperand().(PointerFieldAccess).getTarget().getName()="work"
	and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1246
}

from Function func, Parameter vreq_1246, SizeofExprOperator target_0, PointerFieldAccess target_1, PointerFieldAccess target_11, PointerFieldAccess target_12, VariableAccess target_13, FunctionCall target_16, AssignOrExpr target_17, ExprStmt target_18, AddressOfExpr target_19
where
func_0(func, target_0)
and func_1(vreq_1246, target_1)
and not func_2(vreq_1246, target_18, func)
and not func_5(vreq_1246, target_18, func)
and not func_6(target_18, func)
and not func_7(vreq_1246, target_18, target_19, func)
and not func_10(target_18, func)
and func_11(vreq_1246, target_11)
and func_12(vreq_1246, target_12)
and func_13(vreq_1246, target_13)
and func_16(vreq_1246, target_16)
and func_17(vreq_1246, target_17)
and func_18(func, target_18)
and func_19(vreq_1246, target_19)
and vreq_1246.getType().hasName("io_kiocb *")
and vreq_1246.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
