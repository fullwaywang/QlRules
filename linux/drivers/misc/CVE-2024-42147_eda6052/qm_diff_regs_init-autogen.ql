/**
 * @name linux-eda60520cfe3aba9f088c68ebd5bcbca9fc6ac3c-qm_diff_regs_init
 * @id cpp/linux/eda60520cfe3aba9f088c68ebd5bcbca9fc6ac3c/qm-diff-regs-init
 * @description linux-eda60520cfe3aba9f088c68ebd5bcbca9fc6ac3c-drivers/crypto/hisilicon/debugfs.c-qm_diff_regs_init CVE-2024-42147
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(FunctionCall target_8, Function func) {
exists(ExprStmt target_0 |
	exists(AssignExpr obj_0 | obj_0=target_0.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("int")
		and obj_0.getRValue() instanceof FunctionCall
	)
	and exists(BlockStmt obj_1 | obj_1=target_0.getParent() |
		exists(IfStmt obj_2 | obj_2=obj_1.getParent() |
			obj_2.getThen().(BlockStmt).getStmt(0)=target_0
			and obj_2.getCondition()=target_8
		)
	)
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(Parameter vqm_795, FunctionCall target_8, ValueFieldAccess target_9, ValueFieldAccess target_10) {
exists(ExprStmt target_1 |
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="debug"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vqm_795
			)
			and obj_1.getTarget().getName()="qm_diff_regs"
		)
		and obj_0.getRValue().(Literal).getValue()="0"
	)
	and exists(BlockStmt obj_3 | obj_3=target_1.getParent() |
		exists(IfStmt obj_4 | obj_4=obj_3.getParent() |
			obj_4.getThen().(BlockStmt).getStmt(1)=target_1
			and obj_4.getCondition()=target_8
		)
	)
	and target_9.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_3(FunctionCall target_11, Function func) {
exists(ExprStmt target_3 |
	exists(AssignExpr obj_0 | obj_0=target_3.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("int")
		and obj_0.getRValue() instanceof FunctionCall
	)
	and exists(BlockStmt obj_1 | obj_1=target_3.getParent() |
		exists(IfStmt obj_2 | obj_2=obj_1.getParent() |
			obj_2.getThen().(BlockStmt).getStmt(1)=target_3
			and obj_2.getCondition()=target_11
		)
	)
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(Parameter vqm_795, FunctionCall target_11, ValueFieldAccess target_12, ValueFieldAccess target_13) {
exists(ExprStmt target_4 |
	exists(AssignExpr obj_0 | obj_0=target_4.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="debug"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vqm_795
			)
			and obj_1.getTarget().getName()="acc_diff_regs"
		)
		and obj_0.getRValue().(Literal).getValue()="0"
	)
	and exists(BlockStmt obj_3 | obj_3=target_4.getParent() |
		exists(IfStmt obj_4 | obj_4=obj_3.getParent() |
			obj_4.getThen().(BlockStmt).getStmt(2)=target_4
			and obj_4.getCondition()=target_11
		)
	)
	and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_6(Parameter vqm_795, FunctionCall target_6) {
	exists(ValueFieldAccess obj_0 | obj_0=target_6.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="debug"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vqm_795
		)
		and obj_0.getTarget().getName()="qm_diff_regs"
	)
	and target_6.getTarget().hasName("PTR_ERR")
}

predicate func_7(Parameter vqm_795, FunctionCall target_7) {
	exists(ValueFieldAccess obj_0 | obj_0=target_7.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="debug"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vqm_795
		)
		and obj_0.getTarget().getName()="acc_diff_regs"
	)
	and target_7.getTarget().hasName("PTR_ERR")
}

predicate func_8(Parameter vqm_795, FunctionCall target_8) {
	exists(ValueFieldAccess obj_0 | obj_0=target_8.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="debug"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vqm_795
		)
		and obj_0.getTarget().getName()="qm_diff_regs"
	)
	and target_8.getTarget().hasName("IS_ERR")
}

predicate func_9(Parameter vqm_795, ValueFieldAccess target_9) {
	exists(PointerFieldAccess obj_0 | obj_0=target_9.getQualifier() |
		obj_0.getTarget().getName()="debug"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vqm_795
	)
	and target_9.getTarget().getName()="qm_diff_regs"
}

predicate func_10(Parameter vqm_795, ValueFieldAccess target_10) {
	exists(PointerFieldAccess obj_0 | obj_0=target_10.getQualifier() |
		obj_0.getTarget().getName()="debug"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vqm_795
	)
	and target_10.getTarget().getName()="qm_diff_regs"
}

predicate func_11(Parameter vqm_795, FunctionCall target_11) {
	exists(ValueFieldAccess obj_0 | obj_0=target_11.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="debug"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vqm_795
		)
		and obj_0.getTarget().getName()="acc_diff_regs"
	)
	and target_11.getTarget().hasName("IS_ERR")
}

predicate func_12(Parameter vqm_795, ValueFieldAccess target_12) {
	exists(PointerFieldAccess obj_0 | obj_0=target_12.getQualifier() |
		obj_0.getTarget().getName()="debug"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vqm_795
	)
	and target_12.getTarget().getName()="qm_diff_regs"
}

predicate func_13(Parameter vqm_795, ValueFieldAccess target_13) {
	exists(PointerFieldAccess obj_0 | obj_0=target_13.getQualifier() |
		obj_0.getTarget().getName()="debug"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vqm_795
	)
	and target_13.getTarget().getName()="acc_diff_regs"
}

from Function func, Parameter vqm_795, FunctionCall target_6, FunctionCall target_7, FunctionCall target_8, ValueFieldAccess target_9, ValueFieldAccess target_10, FunctionCall target_11, ValueFieldAccess target_12, ValueFieldAccess target_13
where
not func_0(target_8, func)
and not func_1(vqm_795, target_8, target_9, target_10)
and not func_3(target_11, func)
and not func_4(vqm_795, target_11, target_12, target_13)
and func_6(vqm_795, target_6)
and func_7(vqm_795, target_7)
and func_8(vqm_795, target_8)
and func_9(vqm_795, target_9)
and func_10(vqm_795, target_10)
and func_11(vqm_795, target_11)
and func_12(vqm_795, target_12)
and func_13(vqm_795, target_13)
and vqm_795.getType().hasName("hisi_qm *")
and vqm_795.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
