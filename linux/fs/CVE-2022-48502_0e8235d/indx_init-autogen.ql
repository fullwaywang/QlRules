/**
 * @name linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-indx_init
 * @id cpp/linux/0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b/indx-init
 * @description linux-0e8235d28f3a0e9eda9f02ff67ee566d5f42b66b-indx_init CVE-2022-48502
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vattr_817, Variable vt32_819, FunctionCall target_17, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt32_819
		and target_0.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="data_size"
		and target_0.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="res"
		and target_0.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_0.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vattr_817
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_17.getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vt32_819, Variable vroot_820, NotExpr target_20, Function func) {
	exists(IfStmt target_1 |
		target_1.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vt32_819
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("index_hdr_check")
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ihdr"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vroot_820
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vt32_819
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_2(RelationalOperation target_21, Function func) {
	exists(GotoStmt target_2 |
		target_2.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(0)=target_2
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
		and target_2.getEnclosingFunction() = func)
}

*/
predicate func_3(NotExpr target_20, Function func) {
	exists(GotoStmt target_3 |
		target_3.getParent().(IfStmt).getCondition()=target_20
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(EqualityOperation target_22, Function func) {
	exists(GotoStmt target_4 |
		target_4.getParent().(IfStmt).getCondition()=target_22
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(BitwiseAndExpr target_23, Function func) {
	exists(GotoStmt target_5 |
		target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_5
		and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
		and target_5.getEnclosingFunction() = func)
}

predicate func_6(EqualityOperation target_24, Function func) {
	exists(GotoStmt target_6 |
		target_6.getParent().(IfStmt).getCondition()=target_24
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(Parameter vindx_816, ExprStmt target_25, Function func) {
	exists(IfStmt target_7 |
		target_7.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cmp"
		and target_7.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindx_816
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
		and target_25.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_8(Parameter vsbi_816, ExprStmt target_10, Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(FunctionCall).getTarget().hasName("ntfs_set_state")
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsbi_816
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_9(NotExpr target_20, Function func, ReturnStmt target_9) {
		target_9.getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_9.getParent().(IfStmt).getCondition()=target_20
		and target_9.getEnclosingFunction() = func
}

predicate func_10(Parameter vindx_816, Parameter vsbi_816, RelationalOperation target_21, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="vbn2vbo_bits"
		and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindx_816
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="cluster_bits"
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_816
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
}

predicate func_11(Parameter vindx_816, PointerFieldAccess target_11) {
		target_11.getTarget().getName()="cmp"
		and target_11.getQualifier().(VariableAccess).getTarget()=vindx_816
}

predicate func_13(Function func, UnaryMinusExpr target_13) {
		target_13.getValue()="-22"
		and target_13.getEnclosingFunction() = func
}

predicate func_14(BitwiseAndExpr target_23, Function func, ReturnStmt target_14) {
		target_14.getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
		and target_14.getEnclosingFunction() = func
}

predicate func_15(EqualityOperation target_24, Function func, ReturnStmt target_15) {
		target_15.getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_15.getParent().(IfStmt).getCondition()=target_24
		and target_15.getEnclosingFunction() = func
}

predicate func_16(Parameter vindx_816, Function func, ReturnStmt target_16) {
		target_16.getExpr().(ConditionalExpr).getCondition().(PointerFieldAccess).getTarget().getName()="cmp"
		and target_16.getExpr().(ConditionalExpr).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindx_816
		and target_16.getExpr().(ConditionalExpr).getThen() instanceof Literal
		and target_16.getExpr().(ConditionalExpr).getElse().(UnaryMinusExpr).getValue()="-22"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(Parameter vattr_817, FunctionCall target_17) {
		target_17.getTarget().hasName("resident_data")
		and target_17.getArgument(0).(VariableAccess).getTarget()=vattr_817
}

predicate func_20(Variable vroot_820, NotExpr target_20) {
		target_20.getOperand().(PointerFieldAccess).getTarget().getName()="index_block_clst"
		and target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vroot_820
}

predicate func_21(Parameter vsbi_816, Variable vt32_819, RelationalOperation target_21) {
		 (target_21 instanceof GTExpr or target_21 instanceof LTExpr)
		and target_21.getLesserOperand().(VariableAccess).getTarget()=vt32_819
		and target_21.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="cluster_size"
		and target_21.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_816
}

predicate func_22(Variable vt32_819, Variable vroot_820, EqualityOperation target_22) {
		target_22.getAnOperand().(VariableAccess).getTarget()=vt32_819
		and target_22.getAnOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="index_block_clst"
		and target_22.getAnOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vroot_820
		and target_22.getAnOperand().(MulExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="512"
}

predicate func_23(Parameter vsbi_816, Variable vroot_820, BitwiseAndExpr target_23) {
		target_23.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cluster_size"
		and target_23.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_816
		and target_23.getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="9"
		and target_23.getRightOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="index_block_clst"
		and target_23.getRightOperand().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vroot_820
		and target_23.getRightOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
}

predicate func_24(Parameter vsbi_816, Variable vt32_819, Variable vroot_820, EqualityOperation target_24) {
		target_24.getAnOperand().(VariableAccess).getTarget()=vt32_819
		and target_24.getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="index_block_clst"
		and target_24.getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vroot_820
		and target_24.getAnOperand().(BinaryBitwiseOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="cluster_bits"
		and target_24.getAnOperand().(BinaryBitwiseOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_816
}

predicate func_25(Parameter vindx_816, Variable vroot_820, ExprStmt target_25) {
		target_25.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cmp"
		and target_25.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindx_816
		and target_25.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("get_cmp_func")
		and target_25.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vroot_820
}

from Function func, Parameter vindx_816, Parameter vsbi_816, Parameter vattr_817, Variable vt32_819, Variable vroot_820, ReturnStmt target_9, ExprStmt target_10, PointerFieldAccess target_11, UnaryMinusExpr target_13, ReturnStmt target_14, ReturnStmt target_15, ReturnStmt target_16, FunctionCall target_17, NotExpr target_20, RelationalOperation target_21, EqualityOperation target_22, BitwiseAndExpr target_23, EqualityOperation target_24, ExprStmt target_25
where
not func_0(vattr_817, vt32_819, target_17, func)
and not func_1(vt32_819, vroot_820, target_20, func)
and not func_3(target_20, func)
and not func_4(target_22, func)
and not func_5(target_23, func)
and not func_6(target_24, func)
and not func_7(vindx_816, target_25, func)
and not func_8(vsbi_816, target_10, func)
and func_9(target_20, func, target_9)
and func_10(vindx_816, vsbi_816, target_21, target_10)
and func_11(vindx_816, target_11)
and func_13(func, target_13)
and func_14(target_23, func, target_14)
and func_15(target_24, func, target_15)
and func_16(vindx_816, func, target_16)
and func_17(vattr_817, target_17)
and func_20(vroot_820, target_20)
and func_21(vsbi_816, vt32_819, target_21)
and func_22(vt32_819, vroot_820, target_22)
and func_23(vsbi_816, vroot_820, target_23)
and func_24(vsbi_816, vt32_819, vroot_820, target_24)
and func_25(vindx_816, vroot_820, target_25)
and vindx_816.getType().hasName("ntfs_index *")
and vsbi_816.getType().hasName("ntfs_sb_info *")
and vattr_817.getType().hasName("const ATTRIB *")
and vt32_819.getType().hasName("u32")
and vroot_820.getType().hasName("const INDEX_ROOT *")
and vindx_816.getFunction() = func
and vsbi_816.getFunction() = func
and vattr_817.getFunction() = func
and vt32_819.(LocalVariable).getFunction() = func
and vroot_820.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
