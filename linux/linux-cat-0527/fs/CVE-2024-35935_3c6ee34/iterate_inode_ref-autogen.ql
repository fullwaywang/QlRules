/**
 * @name linux-3c6ee34c6f9cd12802326da26631232a61743501-iterate_inode_ref
 * @id cpp/linux/3c6ee34c6f9cd12802326da26631232a61743501/iterate-inode-ref
 * @description linux-3c6ee34c6f9cd12802326da26631232a61743501-fs/btrfs/send.c-iterate_inode_ref CVE-2024-35935
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("__builtin_unreachable")
	and not target_0.getTarget().hasName("_btrfs_printk")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vroot_994, ExprStmt target_14) {
exists(PointerFieldAccess target_1 |
	target_1.getTarget().getName()="fs_info"
	and target_1.getQualifier().(VariableAccess).getTarget()=vroot_994
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vfound_key_995, ExprStmt target_15) {
exists(PointerFieldAccess target_3 |
	target_3.getTarget().getName()="objectid"
	and target_3.getQualifier().(VariableAccess).getTarget()=vfound_key_995
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Variable vret_1008, ExprStmt target_16) {
exists(AssignExpr target_6 |
	target_6.getLValue().(VariableAccess).getTarget()=vret_1008
	and target_6.getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_6.getLValue().(VariableAccess).getLocation()))
}

predicate func_8(RelationalOperation target_17, Function func, DoStmt target_8) {
	target_8.getCondition() instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_8.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
	and target_8.getEnclosingFunction() = func
}

/*predicate func_9(FunctionCall target_18, Function func, DoStmt target_9) {
	target_9.getCondition() instanceof Literal
	and target_9.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="2439"
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_9.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_9.getParent().(IfStmt).getCondition()=target_18
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(Function func, StmtExpr target_10) {
	target_10.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="2439"
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Function func, AsmStmt target_11) {
	target_11.getChild(0).(Literal).getValue()="2439"
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_12(Function func, DoStmt target_12) {
	target_12.getCondition() instanceof Literal
	and target_12.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_12.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_12.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_12.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_12.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_12.getEnclosingFunction() = func
}

*/
/*predicate func_13(Function func, AsmStmt target_13) {
	target_13.getChild(0) instanceof StringLiteral
	and target_13.getChild(1) instanceof Literal
	and target_13.getChild(2) instanceof Literal
	and target_13.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_13.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_13.getEnclosingFunction() = func
}

*/
predicate func_14(Parameter vroot_994, RelationalOperation target_17, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("char *")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("btrfs_ref_to_path")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vroot_994
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("btrfs_path *")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u32")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("extent_buffer *")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("u64")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(ValueFieldAccess).getTarget().getName()="buf"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("fs_path *")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(ValueFieldAccess).getTarget().getName()="buf_len"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("fs_path *")
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

predicate func_15(Parameter vfound_key_995, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u64")
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="offset"
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_995
}

predicate func_16(Variable vret_1008, FunctionCall target_19, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1008
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("char *")
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

predicate func_17(BlockStmt target_20, Function func, RelationalOperation target_17) {
	 (target_17 instanceof GTExpr or target_17 instanceof LTExpr)
	and target_17.getLesserOperand().(VariableAccess).getTarget().getType().hasName("char *")
	and target_17.getGreaterOperand().(ValueFieldAccess).getTarget().getName()="buf"
	and target_17.getGreaterOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_17.getGreaterOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_17.getGreaterOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("fs_path *")
	and target_17.getParent().(IfStmt).getThen()=target_20
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Function func, FunctionCall target_18) {
	target_18.getTarget().hasName("__builtin_expect")
	and target_18.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("char *")
	and target_18.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="buf"
	and target_18.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_18.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_18.getArgument(1) instanceof Literal
	and target_18.getEnclosingFunction() = func
}

predicate func_19(BlockStmt target_21, Function func, FunctionCall target_19) {
	target_19.getTarget().hasName("IS_ERR")
	and target_19.getArgument(0).(VariableAccess).getTarget().getType().hasName("char *")
	and target_19.getParent().(IfStmt).getThen()=target_21
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable vret_1008, BlockStmt target_20) {
	target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1008
	and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("fs_path_ensure_buf")
	and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("fs_path *")
	and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="buf_len"
	and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(ValueFieldAccess).getTarget().getName()="buf"
	and target_20.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget().getType().hasName("char *")
}

predicate func_21(Variable vret_1008, FunctionCall target_19, BlockStmt target_21) {
	target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1008
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("char *")
	and target_21.getStmt(1).(GotoStmt).getName() ="out"
	and target_21.getParent().(IfStmt).getCondition()=target_19
}

from Function func, Parameter vroot_994, Parameter vfound_key_995, Variable vret_1008, FunctionCall target_0, DoStmt target_8, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, RelationalOperation target_17, FunctionCall target_18, FunctionCall target_19, BlockStmt target_20, BlockStmt target_21
where
func_0(func, target_0)
and not func_1(vroot_994, target_14)
and not func_3(vfound_key_995, target_15)
and not func_6(vret_1008, target_16)
and func_8(target_17, func, target_8)
and func_14(vroot_994, target_17, target_14)
and func_15(vfound_key_995, target_15)
and func_16(vret_1008, target_19, target_16)
and func_17(target_20, func, target_17)
and func_18(func, target_18)
and func_19(target_21, func, target_19)
and func_20(vret_1008, target_20)
and func_21(vret_1008, target_19, target_21)
and vroot_994.getType().hasName("btrfs_root *")
and vfound_key_995.getType().hasName("btrfs_key *")
and vret_1008.getType().hasName("int")
and vroot_994.getFunction() = func
and vfound_key_995.getFunction() = func
and vret_1008.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
