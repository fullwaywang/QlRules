/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_prep_work_files
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-prep-work-files
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_prep_work_files CVE-2021-20194
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vreq_6100, Variable vio_op_defs, ValueFieldAccess target_0) {
	target_0.getTarget().getName()="file_table"
	and target_0.getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vio_op_defs
	and target_0.getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="opcode"
	and target_0.getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6100
}

predicate func_1(Parameter vreq_6100, FunctionCall target_1) {
	target_1.getTarget().hasName("io_grab_files")
	and not target_1.getTarget().hasName("atomic_inc_return")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vreq_6100
}

predicate func_2(Parameter vreq_6100, IfStmt target_18, Function func) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("trace_io_uring_complete")
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_2.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="user_data"
	and target_2.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6100
	and target_2.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_18.getLocation()))
}

predicate func_3(IfStmt target_18, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("io_uring_cqe *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_get_cqring")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("io_ring_ctx *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_18.getLocation()))
}

predicate func_4(Parameter vreq_6100, IfStmt target_18, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("io_uring_cqe *")
	and target_4.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_4.getThen().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_4.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(2).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="cq_overflow_flushed"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="in_idle"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="io_uring"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="task"
	and target_4.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6100
	and target_4.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("list_empty")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cq_overflow_list"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_clean_op")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_6100
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="result"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6100
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("long")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="cflags"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="compl"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("long")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("refcount_inc")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="refs"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_add_tail")
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="list"
	and target_4.getElse().(IfStmt).getElse().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cq_overflow_list"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_18.getLocation()))
}

/*predicate func_5(ReturnStmt target_19, Function func) {
exists(NotExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("io_uring_cqe *")
	and target_5.getParent().(NotExpr).getOperand() instanceof ValueFieldAccess
	and target_5.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_19
	and target_5.getEnclosingFunction() = func)
}

*/
/*predicate func_6(Function func) {
exists(PointerFieldAccess target_6 |
	target_6.getTarget().getName()="(unknown field)"
	and target_6.getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_6.getEnclosingFunction() = func)
}

*/
/*predicate func_7(Function func) {
exists(AddressOfExpr target_7 |
	target_7.getOperand().(ValueFieldAccess).getTarget().getName()="cached_cq_overflow"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_7.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
	and target_7.getEnclosingFunction() = func)
}

*/
/*predicate func_8(ReturnStmt target_19, Function func) {
exists(FunctionCall target_8 |
	target_8.getTarget().hasName("list_empty")
	and target_8.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cq_overflow_list"
	and target_8.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_8.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_8.getParent().(IfStmt).getThen()=target_19
	and target_8.getEnclosingFunction() = func)
}

*/
/*predicate func_9(NotExpr target_20, Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_9.getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="sq_check_overflow"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_9.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_9
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_9.getEnclosingFunction() = func)
}

*/
/*predicate func_10(NotExpr target_20, Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(FunctionCall).getTarget().hasName("set_bit")
	and target_10.getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_10.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cq_check_overflow"
	and target_10.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_10
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_10.getEnclosingFunction() = func)
}

*/
/*predicate func_11(NotExpr target_20, Function func) {
exists(ExprStmt target_11 |
	target_11.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sq_flags"
	and target_11.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rings"
	and target_11.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_11.getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="2"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
	and target_11.getEnclosingFunction() = func)
}

*/
predicate func_12(Parameter vreq_6100, VariableAccess target_12) {
	target_12.getTarget()=vreq_6100
}

predicate func_13(Parameter vreq_6100, VariableAccess target_13) {
	target_13.getTarget()=vreq_6100
	and target_13.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
}

predicate func_15(Parameter vreq_6100, Variable vio_op_defs, VariableAccess target_15) {
	target_15.getTarget()=vio_op_defs
	and target_15.getParent().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="opcode"
	and target_15.getParent().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6100
}

/*predicate func_16(Parameter vreq_6100, PointerFieldAccess target_16) {
	target_16.getTarget().getName()="opcode"
	and target_16.getQualifier().(VariableAccess).getTarget()=vreq_6100
}

*/
predicate func_17(Function func, ReturnStmt target_17) {
	target_17.getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

predicate func_18(Function func, IfStmt target_18) {
	target_18.getCondition().(NotExpr).getOperand() instanceof ValueFieldAccess
	and target_18.getThen().(ReturnStmt).getExpr() instanceof Literal
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Function func, ReturnStmt target_19) {
	target_19.getExpr() instanceof Literal
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Function func, NotExpr target_20) {
	target_20.getOperand() instanceof ValueFieldAccess
	and target_20.getEnclosingFunction() = func
}

from Function func, Parameter vreq_6100, Variable vio_op_defs, ValueFieldAccess target_0, FunctionCall target_1, VariableAccess target_12, VariableAccess target_13, VariableAccess target_15, ReturnStmt target_17, IfStmt target_18, ReturnStmt target_19, NotExpr target_20
where
func_0(vreq_6100, vio_op_defs, target_0)
and func_1(vreq_6100, target_1)
and not func_2(vreq_6100, target_18, func)
and not func_3(target_18, func)
and not func_4(vreq_6100, target_18, func)
and func_12(vreq_6100, target_12)
and func_13(vreq_6100, target_13)
and func_15(vreq_6100, vio_op_defs, target_15)
and func_17(func, target_17)
and func_18(func, target_18)
and func_19(func, target_19)
and func_20(func, target_20)
and vreq_6100.getType().hasName("io_kiocb *")
and vio_op_defs.getType() instanceof ArrayType
and vreq_6100.getFunction() = func
and not vio_op_defs.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
