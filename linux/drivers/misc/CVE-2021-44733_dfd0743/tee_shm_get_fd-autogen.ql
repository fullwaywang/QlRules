/**
 * @name linux-dfd0743f1d9ea76931510ed150334d571fbab49d-tee_shm_get_fd
 * @id cpp/linux/dfd0743f1d9ea76931510ed150334d571fbab49d/tee-shm-get-fd
 * @description linux-dfd0743f1d9ea76931510ed150334d571fbab49d-drivers/tee/tee_shm.c-tee_shm_get_fd CVE-2021-44733
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vshm_347, FunctionCall target_0) {
	target_0.getTarget().hasName("get_dma_buf")
	and not target_0.getTarget().hasName("refcount_inc")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_347
}

predicate func_1(Parameter vshm_347, FunctionCall target_1) {
	target_1.getTarget().hasName("dma_buf_fd")
	and not target_1.getTarget().hasName("anon_inode_getfd")
	and target_1.getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_1.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_347
	and target_1.getArgument(1).(Literal).getValue()="524288"
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_2(Parameter vshm_347, FunctionCall target_2) {
	target_2.getTarget().hasName("dma_buf_put")
	and not target_2.getTarget().hasName("tee_shm_put")
	and target_2.getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_347
}

predicate func_3(Parameter vshm_347) {
exists(AddressOfExpr target_3 |
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_347
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall)
}

predicate func_5(Function func) {
exists(AddressOfExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("const file_operations")
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Parameter vshm_347, VariableAccess target_6) {
	target_6.getTarget()=vshm_347
	and target_6.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_7(Parameter vshm_347, VariableAccess target_7) {
	target_7.getTarget()=vshm_347
	and target_7.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_8(Parameter vshm_347, VariableAccess target_8) {
	target_8.getTarget()=vshm_347
	and target_8.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Parameter vshm_347, FunctionCall target_0, FunctionCall target_1, FunctionCall target_2, VariableAccess target_6, VariableAccess target_7, VariableAccess target_8
where
func_0(vshm_347, target_0)
and func_1(vshm_347, target_1)
and func_2(vshm_347, target_2)
and not func_3(vshm_347)
and not func_5(func)
and func_6(vshm_347, target_6)
and func_7(vshm_347, target_7)
and func_8(vshm_347, target_8)
and vshm_347.getType().hasName("tee_shm *")
and vshm_347.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
