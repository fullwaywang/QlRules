/**
 * @name linux-1a1a143daf84db95dd7212086042004a3abb7bc2-tipc_netlink_start
 * @id cpp/linux/1a1a143daf84db95dd7212086042004a3abb7bc2/tipc-netlink-start
 * @description linux-1a1a143daf84db95dd7212086042004a3abb7bc2-net/tipc/netlink.c-tipc_netlink_start CVE-2016-4951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtipc_genl_v2_ops, AddExpr target_0) {
		target_0.getValue()="5"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_genl_register_family_with_ops_grps")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("genl_family")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vtipc_genl_v2_ops
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_3(Variable vtipc_genl_v2_ops, VariableAccess target_3) {
		target_3.getTarget()=vtipc_genl_v2_ops
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_genl_register_family_with_ops_grps")
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("genl_family")
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2) instanceof AddExpr
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

from Function func, Variable vtipc_genl_v2_ops, AddExpr target_0, VariableAccess target_3
where
func_0(vtipc_genl_v2_ops, target_0)
and func_3(vtipc_genl_v2_ops, target_3)
and vtipc_genl_v2_ops.getType() instanceof ArrayType
and not vtipc_genl_v2_ops.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
