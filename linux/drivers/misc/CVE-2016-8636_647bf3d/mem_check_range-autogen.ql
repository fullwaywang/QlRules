/**
 * @name linux-647bf3d8a8e5777319da92af672289b2a6c4dc66-mem_check_range
 * @id cpp/linux/647bf3d8a8e5777319da92af672289b2a6c4dc66/mem-check-range
 * @description linux-647bf3d8a8e5777319da92af672289b2a6c4dc66-drivers/infiniband/sw/rxe/rxe_mr.c-mem_check_range CVE-2016-8636
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmem_54, Parameter viova_54, Parameter vlength_54, PointerFieldAccess target_13, ConditionalExpr target_11) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand() instanceof RelationalOperation
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlength_54
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=viova_54
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand() instanceof AddExpr
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vlength_54
	and target_0.getThen().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_13)
}

/*predicate func_1(Parameter vmem_54, Parameter vlength_54, ConditionalExpr target_11) {
exists(LogicalOrExpr target_1 |
	target_1.getLeftOperand() instanceof RelationalOperation
	and target_1.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlength_54
	and target_1.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_1.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
	and target_1.getParent().(LogicalOrExpr).getLeftOperand() instanceof RelationalOperation
	and target_1.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand() instanceof AddExpr
	and target_1.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand() instanceof AddExpr)
}

*/
/*predicate func_3(Parameter vmem_54, ConditionalExpr target_11) {
exists(PointerFieldAccess target_3 |
	target_3.getTarget().getName()="length"
	and target_3.getQualifier().(VariableAccess).getTarget()=vmem_54)
}

*/
/*predicate func_4(Parameter viova_54, Parameter vlength_54) {
exists(RelationalOperation target_4 |
	 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
	and target_4.getGreaterOperand().(VariableAccess).getTarget()=viova_54
	and target_4.getLesserOperand().(SubExpr).getLeftOperand() instanceof AddExpr
	and target_4.getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vlength_54
	and target_4.getParent().(LogicalOrExpr).getLeftOperand() instanceof RelationalOperation
	and target_4.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand() instanceof AddExpr
	and target_4.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand() instanceof AddExpr)
}

*/
predicate func_5(Parameter vmem_54, Parameter viova_54, RelationalOperation target_5) {
	 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
	and target_5.getLesserOperand().(VariableAccess).getTarget()=viova_54
	and target_5.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="iova"
	and target_5.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
	and target_5.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand() instanceof AddExpr
	and target_5.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="iova"
	and target_5.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
	and target_5.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_5.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
}

/*predicate func_6(Parameter vmem_54, AddExpr target_6) {
	target_6.getLeftOperand().(PointerFieldAccess).getTarget().getName()="iova"
	and target_6.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
	and target_6.getRightOperand().(PointerFieldAccess).getTarget().getName()="length"
	and target_6.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmem_54
}

*/
predicate func_7(Function func, UnaryMinusExpr target_7) {
	target_7.getValue()="-14"
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vlength_54, VariableAccess target_8) {
	target_8.getTarget()=vlength_54
}

predicate func_9(Parameter viova_54, VariableAccess target_9) {
	target_9.getTarget()=viova_54
}

predicate func_11(Parameter viova_54, Parameter vlength_54, ConditionalExpr target_11) {
	target_11.getCondition().(LogicalOrExpr).getLeftOperand() instanceof RelationalOperation
	and target_11.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=viova_54
	and target_11.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vlength_54
	and target_11.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand() instanceof AddExpr
	and target_11.getThen() instanceof UnaryMinusExpr
	and target_11.getElse() instanceof Literal
}

/*predicate func_12(Parameter viova_54, Parameter vlength_54, AddExpr target_12) {
	target_12.getLeftOperand().(VariableAccess).getTarget()=viova_54
	and target_12.getRightOperand().(VariableAccess).getTarget()=vlength_54
}

*/
predicate func_13(Parameter vmem_54, PointerFieldAccess target_13) {
	target_13.getTarget().getName()="type"
	and target_13.getQualifier().(VariableAccess).getTarget()=vmem_54
}

from Function func, Parameter vmem_54, Parameter viova_54, Parameter vlength_54, RelationalOperation target_5, UnaryMinusExpr target_7, VariableAccess target_8, VariableAccess target_9, ConditionalExpr target_11, PointerFieldAccess target_13
where
not func_0(vmem_54, viova_54, vlength_54, target_13, target_11)
and func_5(vmem_54, viova_54, target_5)
and func_7(func, target_7)
and func_8(vlength_54, target_8)
and func_9(viova_54, target_9)
and func_11(viova_54, vlength_54, target_11)
and func_13(vmem_54, target_13)
and vmem_54.getType().hasName("rxe_mem *")
and viova_54.getType().hasName("u64")
and vlength_54.getType().hasName("size_t")
and vmem_54.getFunction() = func
and viova_54.getFunction() = func
and vlength_54.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
