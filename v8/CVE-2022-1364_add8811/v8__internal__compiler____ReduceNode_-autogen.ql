/**
 * @name v8-add8811019a1f2015c4214c20df8e6e8d4a864bb-v8__internal__compiler____ReduceNode_
 * @id cpp/v8/add8811019a1f2015c4214c20df8e6e8d4a864bb/v8internalcompilerreducenode
 * @description v8-add8811019a1f2015c4214c20df8e6e8d4a864bb-src/execution/frames.cc-v8__internal__compiler____ReduceNode_ CVE-2022-1364
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcurrent_568, FunctionCall target_1, ExprStmt target_2) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("FrameStateMightLazyDeopt")
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vcurrent_568
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("CurrentNode")
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(FunctionCall).getQualifier().(VariableAccess).getTarget()=vcurrent_568
	and target_0.getFollowingStmt() instanceof DeclStmt
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getQualifier().(VariableAccess).getLocation())
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getExpr().(FunctionCall).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vcurrent_568, FunctionCall target_1) {
	target_1.getTarget().hasName("CurrentNode")
	and target_1.getQualifier().(VariableAccess).getTarget()=vcurrent_568
}

predicate func_2(Parameter vcurrent_568, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("SetEscaped")
	and target_2.getExpr().(FunctionCall).getQualifier().(VariableAccess).getTarget()=vcurrent_568
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("Node *")
}

from Function func, Parameter vcurrent_568, FunctionCall target_1, ExprStmt target_2
where
not func_0(vcurrent_568, target_1, target_2)
and func_1(vcurrent_568, target_1)
and func_2(vcurrent_568, target_2)
and vcurrent_568.getType().hasName("Scope *")
and vcurrent_568.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
