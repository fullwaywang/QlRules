/**
 * @name linux-fc0b785802b856566df3ac943e38a072557001c4-safexcel_send_req
 * @id cpp/linux/fc0b785802b856566df3ac943e38a072557001c4/safexcel-send-req
 * @description linux-fc0b785802b856566df3ac943e38a072557001c4-drivers/crypto/inside-secure/safexcel_cipher.c-safexcel_send_req CVE-2023-52687
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(ExprStmt target_15, Function func) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand() instanceof RelationalOperation
	and target_0.getRightOperand().(NotExpr).getOperand() instanceof FunctionCall
	and target_0.getParent().(IfStmt).getThen()=target_15
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(RelationalOperation target_7, Function func) {
exists(ReturnStmt target_1 |
	target_1.getExpr().(UnaryMinusExpr).getValue()="-5"
	and target_1.getParent().(IfStmt).getCondition()=target_7
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Parameter vsreq_674, ExprStmt target_13, NotExpr target_16, RelationalOperation target_9) {
exists(LogicalAndExpr target_2 |
	target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_2.getRightOperand().(NotExpr).getOperand() instanceof FunctionCall
	and target_2.getParent().(IfStmt).getThen()=target_13
	and target_16.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(RelationalOperation target_9, Function func) {
exists(ReturnStmt target_3 |
	target_3.getExpr().(UnaryMinusExpr).getValue()="-5"
	and target_3.getParent().(IfStmt).getCondition()=target_9
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(ExprStmt target_14, Function func) {
exists(LogicalAndExpr target_4 |
	target_4.getLeftOperand() instanceof RelationalOperation
	and target_4.getRightOperand().(NotExpr).getOperand() instanceof FunctionCall
	and target_4.getParent().(IfStmt).getThen()=target_14
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vret_693) {
exists(AssignExpr target_5 |
	target_5.getLValue().(VariableAccess).getTarget()=vret_693
	and target_5.getRValue().(UnaryMinusExpr).getValue()="-5")
}

predicate func_7(Parameter vsreq_674, ExprStmt target_15, RelationalOperation target_7) {
	 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
	and target_7.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_7.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_7.getLesserOperand().(Literal).getValue()="0"
	and target_7.getParent().(IfStmt).getThen()=target_15
}

predicate func_8(Parameter vsreq_674, Parameter vsrc_675, Variable vpriv_683, FunctionCall target_8) {
	target_8.getTarget().hasName("dma_map_sg_attrs")
	and target_8.getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_8.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_683
	and target_8.getArgument(1).(VariableAccess).getTarget()=vsrc_675
	and target_8.getArgument(2).(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_8.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_8.getArgument(4).(Literal).getValue()="0"
}

predicate func_9(Parameter vsreq_674, ExprStmt target_13, RelationalOperation target_9) {
	 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
	and target_9.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_9.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_9.getLesserOperand().(Literal).getValue()="0"
	and target_9.getParent().(IfStmt).getThen()=target_13
}

predicate func_10(Parameter vsreq_674, Parameter vsrc_675, Variable vpriv_683, FunctionCall target_10) {
	target_10.getTarget().hasName("dma_map_sg_attrs")
	and target_10.getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_10.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_683
	and target_10.getArgument(1).(VariableAccess).getTarget()=vsrc_675
	and target_10.getArgument(2).(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_10.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_10.getArgument(4).(Literal).getValue()="0"
}

predicate func_11(Parameter vsreq_674, ExprStmt target_14, RelationalOperation target_11) {
	 (target_11 instanceof GTExpr or target_11 instanceof LTExpr)
	and target_11.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_dst"
	and target_11.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_11.getLesserOperand().(Literal).getValue()="0"
	and target_11.getParent().(IfStmt).getThen()=target_14
}

predicate func_12(Parameter vsreq_674, Parameter vdst_675, Variable vpriv_683, FunctionCall target_12) {
	target_12.getTarget().hasName("dma_map_sg_attrs")
	and target_12.getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_12.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_683
	and target_12.getArgument(1).(VariableAccess).getTarget()=vdst_675
	and target_12.getArgument(2).(PointerFieldAccess).getTarget().getName()="nr_dst"
	and target_12.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_12.getArgument(4).(Literal).getValue()="0"
}

predicate func_13(RelationalOperation target_9, Function func, ExprStmt target_13) {
	target_13.getExpr() instanceof FunctionCall
	and target_13.getParent().(IfStmt).getCondition()=target_9
	and target_13.getEnclosingFunction() = func
}

predicate func_14(RelationalOperation target_11, Function func, ExprStmt target_14) {
	target_14.getExpr() instanceof FunctionCall
	and target_14.getParent().(IfStmt).getCondition()=target_11
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, ExprStmt target_15) {
	target_15.getExpr() instanceof FunctionCall
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Parameter vsreq_674, NotExpr target_16) {
	target_16.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_16.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_src"
	and target_16.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsreq_674
	and target_16.getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
}

from Function func, Variable vret_693, Parameter vsreq_674, Parameter vsrc_675, Parameter vdst_675, Variable vpriv_683, RelationalOperation target_7, FunctionCall target_8, RelationalOperation target_9, FunctionCall target_10, RelationalOperation target_11, FunctionCall target_12, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, NotExpr target_16
where
not func_0(target_15, func)
and not func_1(target_7, func)
and not func_2(vsreq_674, target_13, target_16, target_9)
and not func_3(target_9, func)
and not func_4(target_14, func)
and not func_5(vret_693)
and func_7(vsreq_674, target_15, target_7)
and func_8(vsreq_674, vsrc_675, vpriv_683, target_8)
and func_9(vsreq_674, target_13, target_9)
and func_10(vsreq_674, vsrc_675, vpriv_683, target_10)
and func_11(vsreq_674, target_14, target_11)
and func_12(vsreq_674, vdst_675, vpriv_683, target_12)
and func_13(target_9, func, target_13)
and func_14(target_11, func, target_14)
and func_15(func, target_15)
and func_16(vsreq_674, target_16)
and vret_693.getType().hasName("int")
and vsreq_674.getType().hasName("safexcel_cipher_req *")
and vsrc_675.getType().hasName("scatterlist *")
and vdst_675.getType().hasName("scatterlist *")
and vpriv_683.getType().hasName("safexcel_crypto_priv *")
and vret_693.(LocalVariable).getFunction() = func
and vsreq_674.getFunction() = func
and vsrc_675.getFunction() = func
and vdst_675.getFunction() = func
and vpriv_683.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
