/**
 * @name linux-2039f26f3aca5b0e419b98f65dd36481337b86ee-convert_ctx_accesses
 * @id cpp/linux/2039f26f3aca5b0e419b98f65dd36481337b86ee/convert-ctx-accesses
 * @description linux-2039f26f3aca5b0e419b98f65dd36481337b86ee-convert_ctx_accesses CVE-2021-35477 CVE-2021-34556
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BitwiseOrExpr target_0) {
		target_0.getValue()="26"
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="24"
		and not target_1.getValue()="16"
		and target_1.getParent().(BitwiseAndExpr).getParent().(BitwiseOrExpr).getRightOperand().(BitwiseAndExpr).getValue()="24"
		and target_1.getEnclosingFunction() = func
}

predicate func_3(LogicalAndExpr target_32, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_3
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(Variable vinsn_11883, ExprStmt target_23, LogicalOrExpr target_33) {
	exists(LogicalOrExpr target_4 |
		target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand() instanceof LogicalOrExpr
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="114"
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="106"
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="98"
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="122"
		and target_4.getParent().(IfStmt).getThen()=target_23
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Function func) {
	exists(BitwiseOrExpr target_5 |
		target_5.getValue()="98"
		and target_5.getEnclosingFunction() = func)
}

predicate func_6(Function func) {
	exists(BitwiseOrExpr target_6 |
		target_6.getValue()="98"
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(Variable vinsn_11883, LogicalOrExpr target_22) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_7.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_7.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_7.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="7"
		and target_7.getExpr().(AssignExpr).getRValue().(EqualityOperation).getAnOperand().(Literal).getValue()="3"
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_7
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22)
}

predicate func_8(Function func) {
	exists(ValueFieldAccess target_8 |
		target_8.getTarget().getName()="sanitize_stack_spill"
		and target_8.getQualifier() instanceof ArrayExpr
		and target_8.getEnclosingFunction() = func)
}

predicate func_12(Function func) {
	exists(IfStmt target_12 |
		target_12.getCondition().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
		and target_12.getEnclosingFunction() = func)
}

predicate func_13(Parameter venv_11878, Variable vi_11881, Variable vdelta_11881, PointerFieldAccess target_13) {
		target_13.getTarget().getName()="insn_aux_data"
		and target_13.getQualifier().(VariableAccess).getTarget()=venv_11878
		and target_13.getParent().(ArrayExpr).getArrayOffset().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vi_11881
		and target_13.getParent().(ArrayExpr).getArrayOffset().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vdelta_11881
}

/*predicate func_14(Parameter venv_11878, Variable vi_11881, Variable vdelta_11881, AddExpr target_14) {
		target_14.getAnOperand().(VariableAccess).getTarget()=vi_11881
		and target_14.getAnOperand().(VariableAccess).getTarget()=vdelta_11881
		and target_14.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="insn_aux_data"
		and target_14.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_11878
}

*/
predicate func_15(Variable vcnt_11881, LogicalAndExpr target_32, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vcnt_11881
		and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getValue()="2"
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_16(Parameter venv_11878, Variable vi_11881, Variable vcnt_11881, Variable vdelta_11881, Variable vnew_prog_11885, Variable vpatch_11932, LogicalAndExpr target_32, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnew_prog_11885
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bpf_patch_insn_data")
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venv_11878
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vi_11881
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vdelta_11881
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpatch_11932
		and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vcnt_11881
		and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_17(Variable vnew_prog_11885, LogicalAndExpr target_32, IfStmt target_17) {
		target_17.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vnew_prog_11885
		and target_17.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_18(Variable vcnt_11881, Variable vdelta_11881, LogicalAndExpr target_32, ExprStmt target_18) {
		target_18.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vdelta_11881
		and target_18.getExpr().(AssignAddExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vcnt_11881
		and target_18.getExpr().(AssignAddExpr).getRValue().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_19(Parameter venv_11878, Variable vnew_prog_11885, LogicalAndExpr target_32, ExprStmt target_19) {
		target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="prog"
		and target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_11878
		and target_19.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnew_prog_11885
		and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_20(Variable vi_11881, Variable vdelta_11881, Variable vinsn_11883, Variable vnew_prog_11885, LogicalAndExpr target_32, ExprStmt target_20) {
		target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vinsn_11883
		and target_20.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getAnOperand().(PointerArithmeticOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="insnsi"
		and target_20.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getAnOperand().(PointerArithmeticOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_prog_11885
		and target_20.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getAnOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vi_11881
		and target_20.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vdelta_11881
		and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_21(Variable vtype_11886, LogicalOrExpr target_33, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtype_11886
		and target_21.getParent().(IfStmt).getCondition()=target_33
}

predicate func_22(Variable vinsn_11883, ExprStmt target_23, LogicalOrExpr target_22) {
		target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="115"
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="107"
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_22.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="99"
		and target_22.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_22.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_22.getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="123"
		and target_22.getParent().(IfStmt).getThen()=target_23
}

predicate func_23(Variable vtype_11886, LogicalOrExpr target_33, ExprStmt target_23) {
		target_23.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtype_11886
		and target_23.getParent().(IfStmt).getParent().(IfStmt).getCondition()=target_33
}

predicate func_24(Parameter venv_11878, Variable vi_11881, Variable vdelta_11881, ArrayExpr target_24) {
		target_24.getArrayBase().(PointerFieldAccess).getTarget().getName()="insn_aux_data"
		and target_24.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_11878
		and target_24.getArrayOffset().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vi_11881
		and target_24.getArrayOffset().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vdelta_11881
}

predicate func_28(LogicalAndExpr target_32, Function func, ContinueStmt target_28) {
		target_28.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
		and target_28.getEnclosingFunction() = func
}

predicate func_29(LogicalOrExpr target_33, Function func, ContinueStmt target_29) {
		target_29.getParent().(IfStmt).getParent().(IfStmt).getCondition()=target_33
		and target_29.getEnclosingFunction() = func
}

predicate func_30(Variable vtype_11886, BlockStmt target_34, ExprStmt target_23, EqualityOperation target_35, ValueFieldAccess target_30) {
		target_30.getTarget().getName()="sanitize_stack_off"
		and target_30.getQualifier() instanceof ArrayExpr
		and target_30.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vtype_11886
		and target_30.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_34
		and target_23.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_30.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_30.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_35.getAnOperand().(VariableAccess).getLocation())
}

predicate func_32(Variable vtype_11886, LogicalAndExpr target_32) {
		target_32.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vtype_11886
		and target_32.getAnOperand() instanceof ValueFieldAccess
}

predicate func_33(Variable vinsn_11883, LogicalOrExpr target_33) {
		target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="113"
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="105"
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_33.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="97"
		and target_33.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="code"
		and target_33.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_11883
		and target_33.getAnOperand().(EqualityOperation).getAnOperand().(BitwiseOrExpr).getValue()="121"
}

predicate func_34(Function func, BlockStmt target_34) {
		target_34.getStmt(1) instanceof ExprStmt
		and target_34.getStmt(2) instanceof ExprStmt
		and target_34.getStmt(3) instanceof IfStmt
		and target_34.getStmt(4) instanceof ExprStmt
		and target_34.getStmt(5) instanceof ExprStmt
		and target_34.getEnclosingFunction() = func
}

predicate func_35(Variable vtype_11886, EqualityOperation target_35) {
		target_35.getAnOperand().(VariableAccess).getTarget()=vtype_11886
}

from Function func, Parameter venv_11878, Variable vi_11881, Variable vcnt_11881, Variable vdelta_11881, Variable vinsn_11883, Variable vnew_prog_11885, Variable vtype_11886, Variable vpatch_11932, BitwiseOrExpr target_0, Literal target_1, PointerFieldAccess target_13, ExprStmt target_15, ExprStmt target_16, IfStmt target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_20, ExprStmt target_21, LogicalOrExpr target_22, ExprStmt target_23, ArrayExpr target_24, ContinueStmt target_28, ContinueStmt target_29, ValueFieldAccess target_30, LogicalAndExpr target_32, LogicalOrExpr target_33, BlockStmt target_34, EqualityOperation target_35
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_3(target_32, func)
and not func_4(vinsn_11883, target_23, target_33)
and not func_5(func)
and not func_6(func)
and not func_7(vinsn_11883, target_22)
and not func_8(func)
and not func_12(func)
and func_13(venv_11878, vi_11881, vdelta_11881, target_13)
and func_15(vcnt_11881, target_32, target_15)
and func_16(venv_11878, vi_11881, vcnt_11881, vdelta_11881, vnew_prog_11885, vpatch_11932, target_32, target_16)
and func_17(vnew_prog_11885, target_32, target_17)
and func_18(vcnt_11881, vdelta_11881, target_32, target_18)
and func_19(venv_11878, vnew_prog_11885, target_32, target_19)
and func_20(vi_11881, vdelta_11881, vinsn_11883, vnew_prog_11885, target_32, target_20)
and func_21(vtype_11886, target_33, target_21)
and func_22(vinsn_11883, target_23, target_22)
and func_23(vtype_11886, target_33, target_23)
and func_24(venv_11878, vi_11881, vdelta_11881, target_24)
and func_28(target_32, func, target_28)
and func_29(target_33, func, target_29)
and func_30(vtype_11886, target_34, target_23, target_35, target_30)
and func_32(vtype_11886, target_32)
and func_33(vinsn_11883, target_33)
and func_34(func, target_34)
and func_35(vtype_11886, target_35)
and venv_11878.getType().hasName("bpf_verifier_env *")
and vi_11881.getType().hasName("int")
and vcnt_11881.getType().hasName("int")
and vdelta_11881.getType().hasName("int")
and vinsn_11883.getType().hasName("bpf_insn *")
and vnew_prog_11885.getType().hasName("bpf_prog *")
and vtype_11886.getType().hasName("bpf_access_type")
and vpatch_11932.getType().hasName("bpf_insn[]")
and venv_11878.getFunction() = func
and vi_11881.(LocalVariable).getFunction() = func
and vcnt_11881.(LocalVariable).getFunction() = func
and vdelta_11881.(LocalVariable).getFunction() = func
and vinsn_11883.(LocalVariable).getFunction() = func
and vnew_prog_11885.(LocalVariable).getFunction() = func
and vtype_11886.(LocalVariable).getFunction() = func
and vpatch_11932.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
