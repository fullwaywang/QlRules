/**
 * @name linux-0558f33c06bb910e2879e355192227a8e8f0219d-sas_ex_revalidate_domain
 * @id cpp/linux/0558f33c06bb910e2879e355192227a8e8f0219d/sas-ex-revalidate-domain
 * @description linux-0558f33c06bb910e2879e355192227a8e8f0219d-drivers/scsi/libsas/sas_expander.c-sas_ex_revalidate_domain CVE-2017-18232
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vres_2123, Variable vex_2128, Variable vi_2129, Variable vphy_id_2129, WhileStmt target_2, LogicalAndExpr target_1, ExprStmt target_8, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition() instanceof LogicalAndExpr
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_2129
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="num_phys"
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vex_2128
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vphy_id_2129
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_find_bcast_phy")
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vphy_id_2129
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_rediscover")
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_2129
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_2.getLocation())
	and target_1.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_0.getThen().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable vres_2123, Variable vdev_2124, LogicalAndExpr target_1) {
	target_1.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vres_2123
	and target_1.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_1.getRightOperand().(VariableAccess).getTarget()=vdev_2124
}

predicate func_2(Parameter vport_dev_2121, Variable vres_2123, Variable vdev_2124, Variable vex_2128, Variable vi_2129, Variable vphy_id_2129, Function func, WhileStmt target_2) {
	target_2.getCondition() instanceof LogicalAndExpr
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_2129
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="num_phys"
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vex_2128
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vphy_id_2129
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_find_bcast_phy")
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vphy_id_2129
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_rediscover")
	and target_2.getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_2129
	and target_2.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdev_2124
	and target_2.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_2.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_find_bcast_dev")
	and target_2.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vport_dev_2121
	and target_2.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdev_2124
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vdev_2124, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdev_2124
	and target_3.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

/*predicate func_4(Parameter vport_dev_2121, Variable vres_2123, Variable vdev_2124, ExprStmt target_9, ExprStmt target_8, ReturnStmt target_10, ExprStmt target_3, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_find_bcast_dev")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vport_dev_2121
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdev_2124
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getExpr().(VariableAccess).getLocation())
	and target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
}

*/
predicate func_8(Variable vres_2123, Variable vdev_2124, Variable vphy_id_2129, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_rediscover")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_2124
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vphy_id_2129
}

predicate func_9(Parameter vport_dev_2121, Variable vres_2123, Variable vdev_2124, Function func, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_2123
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sas_find_bcast_dev")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vport_dev_2121
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdev_2124
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vres_2123, ReturnStmt target_10) {
	target_10.getExpr().(VariableAccess).getTarget()=vres_2123
}

from Function func, Parameter vport_dev_2121, Variable vres_2123, Variable vdev_2124, Variable vex_2128, Variable vi_2129, Variable vphy_id_2129, LogicalAndExpr target_1, WhileStmt target_2, ExprStmt target_3, ExprStmt target_8, ExprStmt target_9, ReturnStmt target_10
where
not func_0(vres_2123, vex_2128, vi_2129, vphy_id_2129, target_2, target_1, target_8, func)
and func_1(vres_2123, vdev_2124, target_1)
and func_2(vport_dev_2121, vres_2123, vdev_2124, vex_2128, vi_2129, vphy_id_2129, func, target_2)
and func_3(vdev_2124, target_3)
and func_8(vres_2123, vdev_2124, vphy_id_2129, target_8)
and func_9(vport_dev_2121, vres_2123, vdev_2124, func, target_9)
and func_10(vres_2123, target_10)
and vport_dev_2121.getType().hasName("domain_device *")
and vres_2123.getType().hasName("int")
and vdev_2124.getType().hasName("domain_device *")
and vex_2128.getType().hasName("expander_device *")
and vi_2129.getType().hasName("int")
and vphy_id_2129.getType().hasName("int")
and vport_dev_2121.getFunction() = func
and vres_2123.(LocalVariable).getFunction() = func
and vdev_2124.(LocalVariable).getFunction() = func
and vex_2128.(LocalVariable).getFunction() = func
and vi_2129.(LocalVariable).getFunction() = func
and vphy_id_2129.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
