/**
 * @name linux-aa93d1fee85c890a34f2510a310e55ee76a27848-airspy_probe
 * @id cpp/linux/aa93d1fee85c890a34f2510a310e55ee76a27848/airspy-probe
 * @description linux-aa93d1fee85c890a34f2510a310e55ee76a27848-drivers/media/usb/airspy/airspy.c-airspy_probe CVE-2016-5400
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vs_981, LabelStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("v4l2_device_unregister")
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="v4l2_dev"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_981
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Function func, LabelStmt target_1) {
	target_1.getName() ="err_unregister_v4l2_dev"
	and target_1.getEnclosingFunction() = func
}

from Function func, Variable vs_981, ExprStmt target_0, LabelStmt target_1
where
func_0(vs_981, target_1, target_0)
and func_1(func, target_1)
and vs_981.getType().hasName("airspy *")
and vs_981.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
