/**
 * @name linux-0ac4827f78c7ffe8eef074bc010e7e34bc22f533-ath9k_htc_probe_device
 * @id cpp/linux/0ac4827f78c7ffe8eef074bc010e7e34bc22f533/ath9k-htc-probe-device
 * @description linux-0ac4827f78c7ffe8eef074bc010e7e34bc22f533-drivers/net/wireless/ath/ath9k/htc_drv_init.c-ath9k_htc_probe_device CVE-2022-1679
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhtc_handle_931, Variable vpriv_935, ExprStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="drv_priv"
	and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhtc_handle_931
	and target_0.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vpriv_935
	and target_0.getLocation().isBefore(target_1.getLocation())
}

predicate func_1(Variable vpriv_935, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("SET_IEEE80211_DEV")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("ieee80211_hw *")
	and target_1.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_935
}

from Function func, Parameter vhtc_handle_931, Variable vpriv_935, ExprStmt target_0, ExprStmt target_1
where
func_0(vhtc_handle_931, vpriv_935, target_1, target_0)
and func_1(vpriv_935, target_1)
and vhtc_handle_931.getType().hasName("htc_target *")
and vpriv_935.getType().hasName("ath9k_htc_priv *")
and vhtc_handle_931.getFunction() = func
and vpriv_935.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
