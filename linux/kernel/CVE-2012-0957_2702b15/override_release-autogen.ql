/**
 * @name linux-2702b1526c7278c4d65d78de209a465d4de2885e-override_release
 * @id cpp/linux/2702b1526c7278c4d65d78de209a465d4de2885e/override-release
 * @description linux-2702b1526c7278c4d65d78de209a465d4de2885e-kernel/sys.c-override_release CVE-2012-0957
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
	target_0.getValue()="3.7.0-rc1-00155-g1d46e23"
	and not target_0.getValue()="3.7.0-rc1-00155-g1d46e23-dirty"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vlen_1268, Variable vbuf_1271, Variable vrest_1_1274, Variable vv_1276, FunctionCall target_1) {
	target_1.getTarget().hasName("snprintf")
	and not target_1.getTarget().hasName("scnprintf")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vbuf_1271
	and target_1.getArgument(1).(VariableAccess).getTarget()=vlen_1268
	and target_1.getArgument(2).(StringLiteral).getValue()="2.6.%u%s"
	and target_1.getArgument(3).(VariableAccess).getTarget()=vv_1276
	and target_1.getArgument(4).(VariableAccess).getTarget()=vrest_1_1274
}

predicate func_3(Function func) {
exists(Initializer target_3 |
	target_3.getExpr().(ArrayAggregateLiteral).getValue()="{...}"
	and target_3.getExpr().(ArrayAggregateLiteral).getElementExpr(0).(Literal).getValue()="0"
	and target_3.getExpr().getEnclosingFunction() = func)
}

predicate func_4(Function func) {
exists(AssignExpr target_4 |
	target_4.getLValue().(VariableAccess).getType().hasName("size_t")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vbuf_1271, Variable vrest_1_1274, Variable vv_1276, ExprStmt target_12, ExprStmt target_13, ExprStmt target_15) {
exists(AssignExpr target_5 |
	target_5.getLValue().(VariableAccess).getType().hasName("size_t")
	and target_5.getRValue().(FunctionCall).getTarget().hasName("scnprintf")
	and target_5.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuf_1271
	and target_5.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("size_t")
	and target_5.getRValue().(FunctionCall).getArgument(2).(StringLiteral).getValue()="2.6.%u%s"
	and target_5.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vv_1276
	and target_5.getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vrest_1_1274
	and target_5.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_13.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getLocation().isBefore(target_5.getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation())
	and target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

predicate func_8(Parameter vrelease_1268, Variable vret_1270, Variable vbuf_1271, BitwiseAndExpr target_16, ReturnStmt target_18) {
exists(ExprStmt target_8 |
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1270
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrelease_1268
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbuf_1271
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand().(VariableAccess).getType().hasName("size_t")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(Literal).getValue()="1"
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(10)=target_8
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
	and target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_18.getExpr().(VariableAccess).getLocation()))
}

/*predicate func_9(Parameter vrelease_1268, Parameter vlen_1268, Variable vbuf_1271) {
exists(AddExpr target_9 |
	target_9.getLeftOperand().(VariableAccess).getType().hasName("size_t")
	and target_9.getRightOperand().(Literal).getValue()="1"
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrelease_1268
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbuf_1271
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vlen_1268)
}

*/
predicate func_11(Parameter vrelease_1268, Parameter vlen_1268, Variable vbuf_1271, VariableAccess target_11) {
	target_11.getTarget()=vlen_1268
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrelease_1268
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbuf_1271
}

predicate func_12(Parameter vrelease_1268, Parameter vlen_1268, Variable vret_1270, Variable vbuf_1271, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1270
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("copy_to_user")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrelease_1268
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbuf_1271
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vlen_1268
}

predicate func_13(Variable vrest_1_1274, ExprStmt target_13) {
	target_13.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vrest_1_1274
}

predicate func_15(Variable vv_1276, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vv_1276
	and target_15.getExpr().(AssignExpr).getRValue().(AddExpr).getValue()="46"
}

predicate func_16(Function func, BitwiseAndExpr target_16) {
	target_16.getLeftOperand().(PointerFieldAccess).getTarget().getName()="personality"
	and target_16.getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_16.getEnclosingFunction() = func
}

predicate func_18(Variable vret_1270, ReturnStmt target_18) {
	target_18.getExpr().(VariableAccess).getTarget()=vret_1270
}

from Function func, Parameter vrelease_1268, Parameter vlen_1268, Variable vret_1270, Variable vbuf_1271, Variable vrest_1_1274, Variable vv_1276, StringLiteral target_0, FunctionCall target_1, VariableAccess target_11, ExprStmt target_12, ExprStmt target_13, ExprStmt target_15, BitwiseAndExpr target_16, ReturnStmt target_18
where
func_0(func, target_0)
and func_1(vlen_1268, vbuf_1271, vrest_1_1274, vv_1276, target_1)
and not func_3(func)
and not func_4(func)
and not func_5(vbuf_1271, vrest_1_1274, vv_1276, target_12, target_13, target_15)
and not func_8(vrelease_1268, vret_1270, vbuf_1271, target_16, target_18)
and func_11(vrelease_1268, vlen_1268, vbuf_1271, target_11)
and func_12(vrelease_1268, vlen_1268, vret_1270, vbuf_1271, target_12)
and func_13(vrest_1_1274, target_13)
and func_15(vv_1276, target_15)
and func_16(func, target_16)
and func_18(vret_1270, target_18)
and vrelease_1268.getType().hasName("char *")
and vlen_1268.getType().hasName("int")
and vret_1270.getType().hasName("int")
and vbuf_1271.getType().hasName("char[65]")
and vrest_1_1274.getType().hasName("char *")
and vv_1276.getType().hasName("unsigned int")
and vrelease_1268.getFunction() = func
and vlen_1268.getFunction() = func
and vret_1270.(LocalVariable).getFunction() = func
and vbuf_1271.(LocalVariable).getFunction() = func
and vrest_1_1274.(LocalVariable).getFunction() = func
and vv_1276.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
