/**
 * @name linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-ceph_x_encrypt
 * @id cpp/linux/c27a3e4d667fdcad3db7b104f75659478e0c68d8/ceph-x-encrypt
 * @description linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-net/ceph/auth_x.c-ceph_x_encrypt CVE-2014-6416
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vobuf_49, VariableAccess target_0) {
	target_0.getTarget()=vobuf_49
	and vobuf_49.getIndex() = 3
	and target_0.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_2(Parameter volen_49, Initializer target_2) {
	target_2.getExpr().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=volen_49
	and target_2.getExpr().(SubExpr).getRightOperand() instanceof SizeofTypeOperator
}

predicate func_3(Parameter vilen_49, Parameter vsecret_48, Parameter vibuf_49, Parameter vobuf_49, Variable vhead_51, Variable vlen_55, Variable vret_56, FunctionCall target_3) {
	target_3.getTarget().hasName("ceph_encrypt2")
	and not target_3.getTarget().hasName("ceph_has_room")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vsecret_48
	and target_3.getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vobuf_49
	and target_3.getArgument(1).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_3.getArgument(1).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getValue()="4"
	and target_3.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlen_55
	and target_3.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhead_51
	and target_3.getArgument(4).(SizeofExprOperator).getValue()="9"
	and target_3.getArgument(5).(VariableAccess).getTarget()=vibuf_49
	and target_3.getArgument(6).(VariableAccess).getTarget()=vilen_49
	and target_3.getParent().(AssignExpr).getRValue() = target_3
	and target_3.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_56
}

/*predicate func_4(Parameter vilen_49, Parameter vsecret_48, Parameter vibuf_49, Parameter vobuf_49, Variable vhead_51, Variable vlen_55, VariableAccess target_4) {
	target_4.getTarget()=vobuf_49
	and vobuf_49.getIndex() = 3
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_encrypt2")
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsecret_48
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getValue()="4"
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlen_55
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhead_51
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(SizeofExprOperator).getValue()="9"
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vibuf_49
	and target_4.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vilen_49
}

*/
/*predicate func_5(Function func, SizeofTypeOperator target_5) {
	target_5.getType() instanceof LongType
	and target_5.getValue()="4"
	and target_5.getEnclosingFunction() = func
}

*/
predicate func_8(ExprStmt target_31, Function func) {
exists(DoStmt target_8 |
	target_8.getCondition().(Literal).getValue()="0"
	and target_8.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_8.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_8.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(GotoStmt).getName() ="bad"
	and target_8.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u8")
	and target_8.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_decode_8")
	and target_8.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("void *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_31.getLocation()))
}

/*predicate func_9(Function func) {
exists(AssignExpr target_9 |
	target_9.getLValue().(VariableAccess).getType().hasName("u8")
	and target_9.getRValue().(FunctionCall).getTarget().hasName("ceph_decode_8")
	and target_9.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("void *")
	and target_9.getEnclosingFunction() = func)
}

*/
predicate func_10(ExprStmt target_31, Function func) {
exists(IfStmt target_10 |
	target_10.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u8")
	and target_10.getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="1"
	and target_10.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getLocation().isBefore(target_31.getLocation()))
}

/*predicate func_11(Function func) {
exists(UnaryMinusExpr target_11 |
	target_11.getValue()="-22"
	and target_11.getEnclosingFunction() = func)
}

*/
predicate func_12(ExprStmt target_31, Function func) {
exists(DoStmt target_12 |
	target_12.getCondition().(Literal).getValue()="0"
	and target_12.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_12.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_12.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(GotoStmt).getName() ="bad"
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32")
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_decode_32")
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("void *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
	and target_12.getLocation().isBefore(target_31.getLocation()))
}

predicate func_13(ExprStmt target_31, Function func) {
exists(DoStmt target_13 |
	target_13.getCondition() instanceof Literal
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("_ddebug")
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="libceph: %.*s %12.12s:%-4d : %d tickets\n"
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SubExpr).getValue()="0"
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(StringLiteral).getValue()="    "
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getTarget().hasName("ceph_file_part")
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(5) instanceof Literal
	and target_13.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(6).(VariableAccess).getType().hasName("u32")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
	and target_13.getLocation().isBefore(target_31.getLocation()))
}

predicate func_15(Parameter vsecret_48, Variable vret_56, ExprStmt target_31, IfStmt target_19, Function func) {
exists(WhileStmt target_15 |
	target_15.getCondition().(PostfixDecrExpr).getOperand().(VariableAccess).getType().hasName("u32")
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_56
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("process_one_ticket")
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("ceph_auth_client *")
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsecret_48
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("void *")
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getType().hasName("void *")
	and target_15.getStmt().(BlockStmt).getStmt(1) instanceof IfStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
	and target_15.getLocation().isBefore(target_31.getLocation())
	and target_15.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_19.getCondition().(VariableAccess).getLocation()))
}

/*predicate func_16(Parameter vsecret_48, Variable vret_56) {
exists(FunctionCall target_16 |
	target_16.getTarget().hasName("process_one_ticket")
	and target_16.getArgument(0).(VariableAccess).getType().hasName("ceph_auth_client *")
	and target_16.getArgument(1).(VariableAccess).getTarget()=vsecret_48
	and target_16.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("void *")
	and target_16.getArgument(3).(VariableAccess).getType().hasName("void *")
	and target_16.getParent().(AssignExpr).getRValue() = target_16
	and target_16.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_56)
}

*/
predicate func_17(ExprStmt target_31, Function func) {
exists(ReturnStmt target_17 |
	target_17.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
	and target_17.getLocation().isBefore(target_31.getLocation()))
}

predicate func_18(ExprStmt target_31, Function func) {
exists(ReturnStmt target_18 |
	target_18.getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
	and target_18.getLocation().isBefore(target_31.getLocation()))
}

predicate func_19(Variable vret_56, Function func, IfStmt target_19) {
	target_19.getCondition().(VariableAccess).getTarget()=vret_56
	and target_19.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_56
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_21(Function func, SizeofTypeOperator target_21) {
	target_21.getType() instanceof LongType
	and target_21.getValue()="4"
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Parameter vsecret_48, VariableAccess target_22) {
	target_22.getTarget()=vsecret_48
	and target_22.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_26(Parameter volen_49, VariableAccess target_26) {
	target_26.getTarget()=volen_49
}

predicate func_27(Variable vlen_55, VariableAccess target_27) {
	target_27.getTarget()=vlen_55
	and target_27.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_28(Variable vhead_51, VariableAccess target_28) {
	target_28.getTarget()=vhead_51
	and target_28.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_29(Parameter vobuf_49, Variable vlen_55, FunctionCall target_29) {
	target_29.getTarget().hasName("ceph_encode_32")
	and target_29.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vobuf_49
	and target_29.getArgument(1).(VariableAccess).getTarget()=vlen_55
}

predicate func_30(Variable vlen_55, AddExpr target_30) {
	target_30.getLeftOperand().(VariableAccess).getTarget()=vlen_55
	and target_30.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_30.getRightOperand().(SizeofTypeOperator).getValue()="4"
}

predicate func_31(Variable vret_56, ExprStmt target_31) {
	target_31.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_56
	and target_31.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
}

from Function func, Parameter vilen_49, Parameter vsecret_48, Parameter vibuf_49, Parameter vobuf_49, Parameter volen_49, Variable vhead_51, Variable vlen_55, Variable vret_56, VariableAccess target_0, Initializer target_2, FunctionCall target_3, IfStmt target_19, SizeofTypeOperator target_21, VariableAccess target_22, VariableAccess target_26, VariableAccess target_27, VariableAccess target_28, FunctionCall target_29, AddExpr target_30, ExprStmt target_31
where
func_0(vobuf_49, target_0)
and func_2(volen_49, target_2)
and func_3(vilen_49, vsecret_48, vibuf_49, vobuf_49, vhead_51, vlen_55, vret_56, target_3)
and not func_8(target_31, func)
and not func_10(target_31, func)
and not func_12(target_31, func)
and not func_13(target_31, func)
and not func_15(vsecret_48, vret_56, target_31, target_19, func)
and not func_17(target_31, func)
and not func_18(target_31, func)
and func_19(vret_56, func, target_19)
and func_21(func, target_21)
and func_22(vsecret_48, target_22)
and func_26(volen_49, target_26)
and func_27(vlen_55, target_27)
and func_28(vhead_51, target_28)
and func_29(vobuf_49, vlen_55, target_29)
and func_30(vlen_55, target_30)
and func_31(vret_56, target_31)
and vilen_49.getType().hasName("int")
and vsecret_48.getType().hasName("ceph_crypto_key *")
and vibuf_49.getType().hasName("void *")
and vobuf_49.getType().hasName("void *")
and volen_49.getType().hasName("size_t")
and vhead_51.getType().hasName("ceph_x_encrypt_header")
and vlen_55.getType().hasName("size_t")
and vret_56.getType().hasName("int")
and vilen_49.getFunction() = func
and vsecret_48.getFunction() = func
and vibuf_49.getFunction() = func
and vobuf_49.getFunction() = func
and volen_49.getFunction() = func
and vhead_51.(LocalVariable).getFunction() = func
and vlen_55.(LocalVariable).getFunction() = func
and vret_56.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
