commit 3a3ef0c1d09e1894740db71cdcb7be0bfd713671
Author: Shung-Hsi Yu <shung-hsi.yu@suse.com>
Date:   Wed Oct 12 10:23:53 2022 +0800

    libbpf: Fix null-pointer dereference in find_prog_by_sec_insn()
    
    When there are no program sections, obj->programs is left unallocated,
    and find_prog_by_sec_insn()'s search lands on &obj->programs[0] == NULL,
    and will cause null-pointer dereference in the following access to
    prog->sec_idx.
    
    Guard the search with obj->nr_programs similar to what's being done in
    __bpf_program__iter() to prevent null-pointer access from happening.
    
    Fixes: db2b8b06423c ("libbpf: Support CO-RE relocations for multi-prog sections")
    Signed-off-by: Shung-Hsi Yu <shung-hsi.yu@suse.com>
    Signed-off-by: Andrii Nakryiko <andrii@kernel.org>
    Link: https://lore.kernel.org/bpf/20221012022353.7350-4-shung-hsi.yu@suse.com

diff --git a/src/libbpf.c b/src/libbpf.c
index 29e9df0..8c3f236 100644
--- a/src/libbpf.c
+++ b/src/libbpf.c
@@ -4115,6 +4115,9 @@ static struct bpf_program *find_prog_by_sec_insn(const struct bpf_object *obj,
 	int l = 0, r = obj->nr_programs - 1, m;
 	struct bpf_program *prog;
 
+	if (!obj->nr_programs)
+		return NULL;
+
 	while (l < r) {
 		m = l + (r - l + 1) / 2;
 		prog = &obj->programs[m];
