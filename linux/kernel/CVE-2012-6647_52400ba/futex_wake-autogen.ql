/**
 * @name linux-52400ba946759af28442dee6265c5c0180ac7122-futex_wake
 * @id cpp/linux/52400ba946759af28442dee6265c5c0180ac7122/futex-wake
 * @description linux-52400ba946759af28442dee6265c5c0180ac7122-kernel/futex.c-futex_wake CVE-2012-6647
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vthis_812, ConditionalExpr target_6) {
	exists(LogicalOrExpr target_0 |
		target_0.getAnOperand().(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_0.getAnOperand().(PointerFieldAccess).getTarget().getName()="rt_waiter"
		and target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_0.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_0.getParent().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vthis_812, ConditionalExpr target_6) {
	exists(LogicalOrExpr target_1 |
		target_1.getAnOperand().(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_1.getAnOperand().(PointerFieldAccess).getTarget().getName()="rt_waiter"
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vthis_812, ExprStmt target_7) {
	exists(LogicalOrExpr target_2 |
		target_2.getAnOperand().(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_2.getAnOperand().(PointerFieldAccess).getTarget().getName()="rt_waiter"
		and target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vthis_812, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="pi_state"
		and target_3.getQualifier().(VariableAccess).getTarget()=vthis_812
}

predicate func_4(Variable vthis_812, PointerFieldAccess target_4) {
		target_4.getTarget().getName()="pi_state"
		and target_4.getQualifier().(VariableAccess).getTarget()=vthis_812
}

predicate func_5(Variable vthis_812, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="pi_state"
		and target_5.getQualifier().(VariableAccess).getTarget()=vthis_812
}

predicate func_6(Variable vthis_812, ConditionalExpr target_6) {
		target_6.getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_6.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_6.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_6.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_6.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
		and target_6.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getTarget().getName()="hit"
		and target_6.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getElse().(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getTarget().getName()="miss"
		and target_6.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_7(Variable vthis_812, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_7.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pi_state"
		and target_7.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthis_812
}

from Function func, Variable vthis_812, PointerFieldAccess target_3, PointerFieldAccess target_4, PointerFieldAccess target_5, ConditionalExpr target_6, ExprStmt target_7
where
not func_0(vthis_812, target_6)
and not func_1(vthis_812, target_6)
and not func_2(vthis_812, target_7)
and func_3(vthis_812, target_3)
and func_4(vthis_812, target_4)
and func_5(vthis_812, target_5)
and func_6(vthis_812, target_6)
and func_7(vthis_812, target_7)
and vthis_812.getType().hasName("futex_q *")
and vthis_812.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
