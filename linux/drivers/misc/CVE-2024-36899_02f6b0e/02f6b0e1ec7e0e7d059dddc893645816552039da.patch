commit 02f6b0e1ec7e0e7d059dddc893645816552039da
Author: Zhongqiu Han <quic_zhonhan@quicinc.com>
Date:   Sun May 5 22:11:56 2024 +0800

    gpiolib: cdev: Fix use after free in lineinfo_changed_notify
    
    The use-after-free issue occurs as follows: when the GPIO chip device file
    is being closed by invoking gpio_chrdev_release(), watched_lines is freed
    by bitmap_free(), but the unregistration of lineinfo_changed_nb notifier
    chain failed due to waiting write rwsem. Additionally, one of the GPIO
    chip's lines is also in the release process and holds the notifier chain's
    read rwsem. Consequently, a race condition leads to the use-after-free of
    watched_lines.
    
    Here is the typical stack when issue happened:
    
    [free]
    gpio_chrdev_release()
      --> bitmap_free(cdev->watched_lines)                  <-- freed
      --> blocking_notifier_chain_unregister()
        --> down_write(&nh->rwsem)                          <-- waiting rwsem
              --> __down_write_common()
                --> rwsem_down_write_slowpath()
                      --> schedule_preempt_disabled()
                        --> schedule()
    
    [use]
    st54spi_gpio_dev_release()
      --> gpio_free()
        --> gpiod_free()
          --> gpiod_free_commit()
            --> gpiod_line_state_notify()
              --> blocking_notifier_call_chain()
                --> down_read(&nh->rwsem);                  <-- held rwsem
                --> notifier_call_chain()
                  --> lineinfo_changed_notify()
                    --> test_bit(xxxx, cdev->watched_lines) <-- use after free
    
    The side effect of the use-after-free issue is that a GPIO line event is
    being generated for userspace where it shouldn't. However, since the chrdev
    is being closed, userspace won't have the chance to read that event anyway.
    
    To fix the issue, call the bitmap_free() function after the unregistration
    of lineinfo_changed_nb notifier chain.
    
    Fixes: 51c1064e82e7 ("gpiolib: add new ioctl() for monitoring changes in line info")
    Signed-off-by: Zhongqiu Han <quic_zhonhan@quicinc.com>
    Link: https://lore.kernel.org/r/20240505141156.2944912-1-quic_zhonhan@quicinc.com
    Signed-off-by: Bartosz Golaszewski <bartosz.golaszewski@linaro.org>

diff --git a/drivers/gpio/gpiolib-cdev.c b/drivers/gpio/gpiolib-cdev.c
index fea149ae7774..46a45093d4d0 100644
--- a/drivers/gpio/gpiolib-cdev.c
+++ b/drivers/gpio/gpiolib-cdev.c
@@ -2799,11 +2799,11 @@ static int gpio_chrdev_release(struct inode *inode, struct file *file)
 	struct gpio_chardev_data *cdev = file->private_data;
 	struct gpio_device *gdev = cdev->gdev;
 
-	bitmap_free(cdev->watched_lines);
 	blocking_notifier_chain_unregister(&gdev->device_notifier,
 					   &cdev->device_unregistered_nb);
 	blocking_notifier_chain_unregister(&gdev->line_state_notifier,
 					   &cdev->lineinfo_changed_nb);
+	bitmap_free(cdev->watched_lines);
 	gpio_device_put(gdev);
 	kfree(cdev);
 
