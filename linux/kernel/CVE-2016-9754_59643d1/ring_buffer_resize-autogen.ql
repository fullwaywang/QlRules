/**
 * @name linux-59643d1535eb220668692a5359de22545af579f6-ring_buffer_resize
 * @id cpp/linux/59643d1535eb220668692a5359de22545af579f6/ring-buffer-resize
 * @description linux-59643d1535eb220668692a5359de22545af579f6-kernel/trace/ring_buffer.c-ring_buffer_resize CVE-2016-9754
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsize_1642, VariableAccess target_0) {
	target_0.getTarget()=vsize_1642
	and vsize_1642.getIndex() = 1
}

predicate func_1(Parameter vsize_1642, ExprStmt target_14, ExprStmt target_10, VariableAccess target_1) {
	target_1.getTarget()=vsize_1642
	and vsize_1642.getIndex() = 1
	and target_1.getParent().(LTExpr).getGreaterOperand() instanceof MulExpr
	and target_1.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_14
	and target_10.getExpr().(AssignMulExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Parameter vsize_1642, ExprStmt target_10, IfStmt target_2) {
	target_2.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vsize_1642
	and target_2.getCondition().(RelationalOperation).getGreaterOperand() instanceof MulExpr
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_1642
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof MulExpr
	and target_10.getLocation().isBefore(target_2.getLocation())
}

predicate func_3(Parameter vsize_1642, Variable vnr_pages_1646, ExprStmt target_10, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnr_pages_1646
	and target_3.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_1642
	and target_3.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getRightOperand().(SubExpr).getValue()="4080"
	and target_3.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
	and target_3.getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(SubExpr).getValue()="4080"
	and target_10.getLocation().isBefore(target_3.getLocation())
}

predicate func_4(Parameter vsize_1642, Variable vnr_pages_1646) {
exists(MulExpr target_4 |
	target_4.getLeftOperand().(VariableAccess).getTarget()=vnr_pages_1646
	and target_4.getRightOperand() instanceof SubExpr
	and target_4.getParent().(AssignExpr).getRValue() = target_4
	and target_4.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_1642)
}

predicate func_5(Parameter vsize_1642, DivExpr target_5) {
	target_5.getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_1642
	and target_5.getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getRightOperand().(SubExpr).getValue()="4080"
	and target_5.getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
	and target_5.getRightOperand().(SubExpr).getValue()="4080"
	and target_5.getParent().(AssignExpr).getRValue() = target_5
	and target_5.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_1642
}

predicate func_6(Function func, SubExpr target_6) {
	target_6.getValue()="4080"
	and target_6.getEnclosingFunction() = func
}

/*predicate func_7(Parameter vsize_1642, VariableAccess target_7) {
	target_7.getTarget()=vsize_1642
	and target_7.getParent().(AssignExpr).getLValue() = target_7
	and target_7.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_1642
	and target_7.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getRightOperand().(SubExpr).getValue()="4080"
	and target_7.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
	and target_7.getParent().(AssignExpr).getRValue().(DivExpr).getRightOperand().(SubExpr).getValue()="4080"
}

*/
predicate func_10(Parameter vsize_1642, Function func, ExprStmt target_10) {
	target_10.getExpr().(AssignMulExpr).getLValue().(VariableAccess).getTarget()=vsize_1642
	and target_10.getExpr().(AssignMulExpr).getRValue() instanceof SubExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Parameter vsize_1642, ExprStmt target_14, MulExpr target_11) {
	target_11.getValue()="8160"
	and target_11.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vsize_1642
	and target_11.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_14
}

predicate func_12(Parameter vsize_1642, RelationalOperation target_16, ExprStmt target_3, VariableAccess target_12) {
	target_12.getTarget()=vsize_1642
	and target_12.getParent().(AssignExpr).getLValue() = target_12
	and target_12.getParent().(AssignExpr).getRValue().(MulExpr).getValue()="8160"
	and target_16.getLesserOperand().(VariableAccess).getLocation().isBefore(target_12.getLocation())
	and target_12.getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getLocation())
}

/*predicate func_13(Parameter vsize_1642, MulExpr target_13) {
	target_13.getValue()="8160"
	and target_13.getParent().(AssignExpr).getRValue() = target_13
	and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_1642
}

*/
predicate func_14(Parameter vsize_1642, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_1642
	and target_14.getExpr().(AssignExpr).getRValue() instanceof MulExpr
}

predicate func_16(Parameter vsize_1642, RelationalOperation target_16) {
	 (target_16 instanceof GTExpr or target_16 instanceof LTExpr)
	and target_16.getLesserOperand().(VariableAccess).getTarget()=vsize_1642
	and target_16.getGreaterOperand() instanceof MulExpr
}

from Function func, Parameter vsize_1642, Variable vnr_pages_1646, VariableAccess target_0, VariableAccess target_1, IfStmt target_2, ExprStmt target_3, DivExpr target_5, SubExpr target_6, ExprStmt target_10, MulExpr target_11, VariableAccess target_12, ExprStmt target_14, RelationalOperation target_16
where
func_0(vsize_1642, target_0)
and func_1(vsize_1642, target_14, target_10, target_1)
and func_2(vsize_1642, target_10, target_2)
and func_3(vsize_1642, vnr_pages_1646, target_10, target_3)
and not func_4(vsize_1642, vnr_pages_1646)
and func_5(vsize_1642, target_5)
and func_6(func, target_6)
and func_10(vsize_1642, func, target_10)
and func_11(vsize_1642, target_14, target_11)
and func_12(vsize_1642, target_16, target_3, target_12)
and func_14(vsize_1642, target_14)
and func_16(vsize_1642, target_16)
and vsize_1642.getType().hasName("unsigned long")
and vnr_pages_1646.getType().hasName("unsigned long")
and vsize_1642.getFunction() = func
and vnr_pages_1646.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
