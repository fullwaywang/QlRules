/**
 * @name linux-ee1fee900537b5d9560e9f937402de5ddc8412f3-ptrace_setoptions
 * @id cpp/linux/ee1fee900537b5d9560e9f937402de5ddc8412f3/ptrace-setoptions
 * @description linux-ee1fee900537b5d9560e9f937402de5ddc8412f3-kernel/ptrace.c-ptrace_setoptions CVE-2022-30594
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("seccomp_mode")
	and not target_0.getTarget().hasName("check_ptrace_options")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="seccomp"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier() instanceof FunctionCall
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vdata_654, IfStmt target_7, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("check_ptrace_options")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_654
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_7.getLocation()))
}

predicate func_4(Function func, BitwiseOrExpr target_4) {
	target_4.getValue()="1048831"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Function func, BinaryBitwiseOperation target_5) {
	target_5.getValue()="2097152"
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vdata_654, ReturnStmt target_15, VariableAccess target_6) {
	target_6.getTarget()=vdata_654
	and target_6.getParent().(BitwiseAndExpr).getRightOperand() instanceof ComplementExpr
	and target_6.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_15
}

predicate func_7(Parameter vdata_654, Function func, IfStmt target_7) {
	target_7.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vdata_654
	and target_7.getCondition().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073706405632"
	and target_7.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

/*predicate func_8(Function func, UnaryMinusExpr target_8) {
	target_8.getValue()="-22"
	and target_8.getEnclosingFunction() = func
}

*/
predicate func_9(Parameter vdata_654, BlockStmt target_16, FunctionCall target_9) {
	target_9.getTarget().hasName("__builtin_expect")
	and target_9.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vdata_654
	and target_9.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2097152"
	and target_9.getArgument(1).(Literal).getValue()="0"
	and target_9.getParent().(IfStmt).getThen()=target_16
}

predicate func_10(FunctionCall target_9, Function func, IfStmt target_10) {
	target_10.getCondition().(LogicalOrExpr).getValue()="0"
	and target_10.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_10.getEnclosingFunction() = func
}

predicate func_11(FunctionCall target_9, Function func, IfStmt target_11) {
	target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("capable")
	and target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(Literal).getValue()="21"
	and target_11.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-1"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_11.getEnclosingFunction() = func
}

predicate func_12(FunctionCall target_9, Function func, IfStmt target_12) {
	target_12.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand() instanceof FunctionCall
	and target_12.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_12.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ptrace"
	and target_12.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_12.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="16777216"
	and target_12.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-1"
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Function func, PointerFieldAccess target_13) {
	target_13.getTarget().getName()="seccomp"
	and target_13.getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_13.getEnclosingFunction() = func
}

predicate func_15(Function func, ReturnStmt target_15) {
	target_15.getExpr() instanceof UnaryMinusExpr
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, BlockStmt target_16) {
	target_16.getStmt(0) instanceof IfStmt
	and target_16.getStmt(1) instanceof IfStmt
	and target_16.getStmt(2) instanceof IfStmt
	and target_16.getEnclosingFunction() = func
}

from Function func, Parameter vdata_654, FunctionCall target_0, BitwiseOrExpr target_4, BinaryBitwiseOperation target_5, VariableAccess target_6, IfStmt target_7, FunctionCall target_9, IfStmt target_10, IfStmt target_11, IfStmt target_12, PointerFieldAccess target_13, ReturnStmt target_15, BlockStmt target_16
where
func_0(func, target_0)
and not func_1(vdata_654, target_7, func)
and func_4(func, target_4)
and func_5(func, target_5)
and func_6(vdata_654, target_15, target_6)
and func_7(vdata_654, func, target_7)
and func_9(vdata_654, target_16, target_9)
and func_10(target_9, func, target_10)
and func_11(target_9, func, target_11)
and func_12(target_9, func, target_12)
and func_13(func, target_13)
and func_15(func, target_15)
and func_16(func, target_16)
and vdata_654.getType().hasName("unsigned long")
and vdata_654.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
