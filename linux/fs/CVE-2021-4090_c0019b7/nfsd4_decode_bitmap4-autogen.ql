/**
 * @name linux-c0019b7db1d7ac62c711cda6b357a659d46428fe-nfsd4_decode_bitmap4
 * @id cpp/linux/c0019b7db1d7ac62c711cda6b357a659d46428fe/nfsd4-decode-bitmap4
 * @description linux-c0019b7db1d7ac62c711cda6b357a659d46428fe-fs/nfsd/nfs4xdr.c-nfsd4_decode_bitmap4 CVE-2021-4090
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbmval_278, Variable vi_280, ExprStmt target_3, RelationalOperation target_4, Function func) {
exists(ForStmt target_0 |
	target_0.getInitialization() instanceof ExprStmt
	and target_0.getCondition() instanceof RelationalOperation
	and target_0.getUpdate() instanceof PostfixIncrExpr
	and target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
	and target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_280
	and target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition() instanceof RelationalOperation
	and target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen() instanceof FunctionCall
	and target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_3.getLocation())
	and target_4.getLesserOperand().(VariableAccess).getLocation().isBefore(target_0.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation()))
}

/*predicate func_2(Parameter vbmval_278) {
exists(ConditionalExpr target_2 |
	target_2.getCondition() instanceof RelationalOperation
	and target_2.getThen() instanceof FunctionCall
	and target_2.getElse() instanceof Literal
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
	and target_2.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr)
}

*/
predicate func_3(Variable vi_280, Function func, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_280
	and target_3.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Variable vi_280, Variable vcount_280, RelationalOperation target_4) {
	 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
	and target_4.getLesserOperand().(VariableAccess).getTarget()=vi_280
	and target_4.getGreaterOperand().(VariableAccess).getTarget()=vcount_280
}

/*predicate func_5(Parameter vbmval_278, Variable vi_280, PostfixIncrExpr target_5) {
	target_5.getOperand().(VariableAccess).getTarget()=vi_280
	and target_5.getParent().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
}

*/
predicate func_6(Parameter vbmval_278, Variable vi_280, Variable vp_281, FunctionCall target_6) {
	target_6.getTarget().hasName("__be32_to_cpup")
	and target_6.getArgument(0).(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vp_281
	and target_6.getParent().(AssignExpr).getRValue() = target_6
	and target_6.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
	and target_6.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_280
}

predicate func_7(Parameter vbmlen_278, Variable vi_280, RelationalOperation target_7) {
	 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
	and target_7.getLesserOperand().(VariableAccess).getTarget()=vi_280
	and target_7.getGreaterOperand().(VariableAccess).getTarget()=vbmlen_278
}

predicate func_9(Parameter vbmval_278, Function func, WhileStmt target_9) {
	target_9.getCondition() instanceof RelationalOperation
	and target_9.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
	and target_9.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr
	and target_9.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Parameter vbmval_278, Variable vi_280, Function func, WhileStmt target_10) {
	target_10.getCondition() instanceof RelationalOperation
	and target_10.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbmval_278
	and target_10.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_280
	and target_10.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

from Function func, Parameter vbmval_278, Parameter vbmlen_278, Variable vi_280, Variable vcount_280, Variable vp_281, ExprStmt target_3, RelationalOperation target_4, FunctionCall target_6, RelationalOperation target_7, WhileStmt target_9, WhileStmt target_10
where
not func_0(vbmval_278, vi_280, target_3, target_4, func)
and func_3(vi_280, func, target_3)
and func_4(vi_280, vcount_280, target_4)
and func_6(vbmval_278, vi_280, vp_281, target_6)
and func_7(vbmlen_278, vi_280, target_7)
and func_9(vbmval_278, func, target_9)
and func_10(vbmval_278, vi_280, func, target_10)
and vbmval_278.getType().hasName("u32 *")
and vbmlen_278.getType().hasName("u32")
and vi_280.getType().hasName("u32")
and vcount_280.getType().hasName("u32")
and vp_281.getType().hasName("__be32 *")
and vbmval_278.getFunction() = func
and vbmlen_278.getFunction() = func
and vi_280.(LocalVariable).getFunction() = func
and vcount_280.(LocalVariable).getFunction() = func
and vp_281.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
