/**
 * @name linux-55484c45dbeca2eec7642932ec3f60f8a2d4bdbf-gru_steal_context
 * @id cpp/linux/55484c45dbeca2eec7642932ec3f60f8a2d4bdbf/gru-steal-context
 * @description linux-55484c45dbeca2eec7642932ec3f60f8a2d4bdbf-drivers/misc/sgi-gru/grumain.c-gru_steal_context CVE-2022-3424
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("uv_numa_blade_id")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_1(Variable vgru_720, Variable vngts_721, Variable vctxnum_722, ExprStmt target_8, LogicalOrExpr target_10, ExprStmt target_11, LogicalAndExpr target_12) {
	exists(IfStmt target_1 |
		target_1.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("int")
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="gs_chiplet_id"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgru_720
		and target_1.getThen().(BlockStmt).getStmt(0) instanceof IfStmt
		and target_1.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vctxnum_722
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="16"
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vctxnum_722
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vngts_721
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vngts_721
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("is_gts_stealable")
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vngts_721
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(3) instanceof LabelStmt
		and target_1.getThen().(BlockStmt).getStmt(4) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(5) instanceof IfStmt
		and target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_1.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getAnOperand().(VariableAccess).getLocation())
		and target_11.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
		and target_1.getThen().(BlockStmt).getStmt(2).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_2(Variable vgru_720, Variable vgru0_720, Variable vflag_722, FunctionCall target_13, ExprStmt target_8, LogicalAndExpr target_12) {
	exists(IfStmt target_2 |
		target_2.getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vflag_722
		and target_2.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru_720
		and target_2.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru0_720
		and target_2.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_13.getArgument(0).(VariableAccess).getLocation())
		and target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_2.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_2.getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_3(Variable vgru_720, Variable vcbr_722, Variable vdsr_722, IfStmt target_3) {
		target_3.getCondition().(FunctionCall).getTarget().hasName("check_gru_resources")
		and target_3.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vgru_720
		and target_3.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vcbr_722
		and target_3.getCondition().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdsr_722
		and target_3.getCondition().(FunctionCall).getArgument(3).(Literal).getValue()="16"
}

predicate func_4(Variable vgru_720, ExprStmt target_4) {
		target_4.getExpr().(FunctionCall).getTarget().hasName("spin_lock")
		and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gs_lock"
		and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgru_720
}

predicate func_5(Variable vgru_720, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
		and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gs_lock"
		and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgru_720
}

predicate func_6(Variable vgru_720, Variable vgru0_720, Variable vngts_721, Variable vctxnum_722, Variable vctxnum0_722, Variable vflag_722, IfStmt target_6) {
		target_6.getCondition().(LogicalOrExpr).getAnOperand().(VariableAccess).getTarget()=vngts_721
		and target_6.getCondition().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vflag_722
		and target_6.getCondition().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru_720
		and target_6.getCondition().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru0_720
		and target_6.getCondition().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum_722
		and target_6.getCondition().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum0_722
}

predicate func_7(Variable vflag_722, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflag_722
		and target_7.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
}

predicate func_8(Variable vgru_720, Variable vgru0_720, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgru0_720
		and target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vgru_720
}

predicate func_10(Variable vgru_720, Variable vgru0_720, Variable vngts_721, Variable vctxnum_722, Variable vctxnum0_722, Variable vflag_722, LogicalOrExpr target_10) {
		target_10.getAnOperand().(VariableAccess).getTarget()=vngts_721
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vflag_722
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru_720
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru0_720
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum_722
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum0_722
}

predicate func_11(Variable vctxnum_722, Variable vctxnum0_722, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vctxnum0_722
		and target_11.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vctxnum_722
}

predicate func_12(Variable vgru_720, Variable vgru0_720, Variable vctxnum_722, Variable vctxnum0_722, Variable vflag_722, LogicalAndExpr target_12) {
		target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vflag_722
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru_720
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgru0_720
		and target_12.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum_722
		and target_12.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vctxnum0_722
		and target_12.getParent().(IfStmt).getThen() instanceof BreakStmt
}

predicate func_13(Variable vgru_720, Variable vcbr_722, Variable vdsr_722, FunctionCall target_13) {
		target_13.getTarget().hasName("check_gru_resources")
		and target_13.getArgument(0).(VariableAccess).getTarget()=vgru_720
		and target_13.getArgument(1).(VariableAccess).getTarget()=vcbr_722
		and target_13.getArgument(2).(VariableAccess).getTarget()=vdsr_722
		and target_13.getArgument(3).(Literal).getValue()="16"
}

from Function func, Variable vgru_720, Variable vgru0_720, Variable vngts_721, Variable vctxnum_722, Variable vctxnum0_722, Variable vflag_722, Variable vcbr_722, Variable vdsr_722, IfStmt target_3, ExprStmt target_4, ExprStmt target_5, IfStmt target_6, ExprStmt target_7, ExprStmt target_8, LogicalOrExpr target_10, ExprStmt target_11, LogicalAndExpr target_12, FunctionCall target_13
where
not func_0(func)
and not func_1(vgru_720, vngts_721, vctxnum_722, target_8, target_10, target_11, target_12)
and not func_2(vgru_720, vgru0_720, vflag_722, target_13, target_8, target_12)
and func_3(vgru_720, vcbr_722, vdsr_722, target_3)
and func_4(vgru_720, target_4)
and func_5(vgru_720, target_5)
and func_6(vgru_720, vgru0_720, vngts_721, vctxnum_722, vctxnum0_722, vflag_722, target_6)
and func_7(vflag_722, target_7)
and func_8(vgru_720, vgru0_720, target_8)
and func_10(vgru_720, vgru0_720, vngts_721, vctxnum_722, vctxnum0_722, vflag_722, target_10)
and func_11(vctxnum_722, vctxnum0_722, target_11)
and func_12(vgru_720, vgru0_720, vctxnum_722, vctxnum0_722, vflag_722, target_12)
and func_13(vgru_720, vcbr_722, vdsr_722, target_13)
and vgru_720.getType().hasName("gru_state *")
and vgru0_720.getType().hasName("gru_state *")
and vngts_721.getType().hasName("gru_thread_state *")
and vctxnum_722.getType().hasName("int")
and vctxnum0_722.getType().hasName("int")
and vflag_722.getType().hasName("int")
and vcbr_722.getType().hasName("int")
and vdsr_722.getType().hasName("int")
and vgru_720.(LocalVariable).getFunction() = func
and vgru0_720.(LocalVariable).getFunction() = func
and vngts_721.(LocalVariable).getFunction() = func
and vctxnum_722.(LocalVariable).getFunction() = func
and vctxnum0_722.(LocalVariable).getFunction() = func
and vflag_722.(LocalVariable).getFunction() = func
and vcbr_722.(LocalVariable).getFunction() = func
and vdsr_722.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
