/**
 * @name linux-e4571b8c5e9ffa1e85c0c671995bd4dcc5c75091-btrfs_rm_device
 * @id cpp/linux/e4571b8c5e9ffa1e85c0c671995bd4dcc5c75091/btrfs-rm-device
 * @description linux-e4571b8c5e9ffa1e85c0c671995bd4dcc5c75091-fs/btrfs/volumes.c-btrfs_rm_device CVE-2021-3739
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdevice_path_2056, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand() instanceof EqualityOperation
	and target_0.getRightOperand().(VariableAccess).getTarget()=vdevice_path_2056
	and target_0.getParent().(LogicalAndExpr).getLeftOperand() instanceof EqualityOperation
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("strcmp")
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdevice_path_2056
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(StringLiteral).getValue()="missing"
	and target_0.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(VariableAccess).getLocation())
	and target_0.getRightOperand().(VariableAccess).getLocation().isBefore(target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vdevice_path_2056, Variable vdevice_2059, ExprStmt target_2, EqualityOperation target_1) {
	target_1.getLeftOperand().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_1.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdevice_2059
	and target_1.getRightOperand().(UnaryMinusExpr).getValue()="-2"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("strcmp")
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdevice_path_2056
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(StringLiteral).getValue()="missing"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Function func, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vdevice_path_2056, Variable vdevice_2059, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdevice_2059
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("btrfs_find_device_by_devspec")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("btrfs_fs_info *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("u64")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdevice_path_2056
}

predicate func_4(Parameter vdevice_path_2056, LogicalAndExpr target_4) {
	target_4.getLeftOperand() instanceof EqualityOperation
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("strcmp")
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdevice_path_2056
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(StringLiteral).getValue()="missing"
	and target_4.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
}

from Function func, Parameter vdevice_path_2056, Variable vdevice_2059, EqualityOperation target_1, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4
where
not func_0(vdevice_path_2056, target_2, target_3, target_4)
and func_1(vdevice_path_2056, vdevice_2059, target_2, target_1)
and func_2(func, target_2)
and func_3(vdevice_path_2056, vdevice_2059, target_3)
and func_4(vdevice_path_2056, target_4)
and vdevice_path_2056.getType().hasName("const char *")
and vdevice_2059.getType().hasName("btrfs_device *")
and vdevice_path_2056.getFunction() = func
and vdevice_2059.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
