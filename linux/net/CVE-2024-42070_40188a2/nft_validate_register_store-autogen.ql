/**
 * @name linux-40188a25a9847dbeb7ec67517174a835a677752f-nft_validate_register_store
 * @id cpp/linux/40188a25a9847dbeb7ec67517174a835a677752f/nft-validate-register-store
 * @description linux-40188a25a9847dbeb7ec67517174a835a677752f-net/netfilter/nf_tables_api.c-nft_validate_register_store CVE-2024-42070
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(IfStmt target_3, Function func, IfStmt target_0) {
	target_0.getCondition() instanceof LogicalAndExpr
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_3.getLocation().isBefore(target_0.getLocation())
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vtype_7638, ReturnStmt target_4, EqualityOperation target_1) {
	exists(LogicalAndExpr obj_0 | obj_0=target_1.getParent() |
		obj_0.getLeftOperand() instanceof EqualityOperation
		and obj_0.getParent().(IfStmt).getThen()=target_4
	)
	and target_1.getLeftOperand().(VariableAccess).getTarget()=vtype_7638
}

predicate func_2(Parameter vdata_7637, ReturnStmt target_4, LogicalAndExpr target_2) {
	exists(EqualityOperation obj_0 | obj_0=target_2.getLeftOperand() |
		obj_0.getLeftOperand().(VariableAccess).getTarget()=vdata_7637
		and obj_0.getRightOperand().(Literal).getValue()="0"
	)
	and target_2.getRightOperand() instanceof EqualityOperation
	and target_2.getParent().(IfStmt).getThen()=target_4
}

predicate func_3(Function func, IfStmt target_3) {
	exists(RelationalOperation obj_0 | obj_0=target_3.getCondition() |
		exists(AddExpr obj_1 | obj_1=obj_0.getGreaterOperand() |
			exists(MulExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				obj_2.getLeftOperand().(VariableAccess).getTarget().getType().hasName("nft_registers")
				and obj_2.getRightOperand().(Literal).getValue()="4"
			)
			and obj_1.getRightOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		)
		and obj_0.getLesserOperand().(SizeofExprOperator).getValue()="80"
	)
	and target_3.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-34"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(LogicalAndExpr target_2, Function func, ReturnStmt target_4) {
	target_4.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_4.getParent().(IfStmt).getCondition()=target_2
	and target_4.getEnclosingFunction() = func
}

from Function func, Parameter vdata_7637, Parameter vtype_7638, IfStmt target_0, EqualityOperation target_1, LogicalAndExpr target_2, IfStmt target_3, ReturnStmt target_4
where
func_0(target_3, func, target_0)
and func_1(vtype_7638, target_4, target_1)
and func_2(vdata_7637, target_4, target_2)
and func_3(func, target_3)
and func_4(target_2, func, target_4)
and vdata_7637.getType().hasName("const nft_data *")
and vtype_7638.getType().hasName("nft_data_types")
and vdata_7637.getFunction() = func
and vtype_7638.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
