/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_wq_files_match
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-wq-files-match
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_wq_files_match CVE-2021-20226
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdata_8062, Initializer target_0) {
	target_0.getExpr().(VariableAccess).getTarget()=vdata_8062
}

predicate func_1(Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="io_uring"
	and target_1.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_1.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("io_uring_alloc_task_context")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("get_current")
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getFollowingStmt() instanceof DeclStmt)
}

predicate func_4(Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="last"
	and target_4.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="io_uring"
	and target_4.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_4.getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getType().hasName("file *")
	and target_4.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("rcu_read_lock")
	and target_4.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("void *")
	and target_4.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("xas_load")
	and target_4.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("xa_state")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("void *")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getType().hasName("file *")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_file")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("file *")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("xas_store")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("file *")
	and target_4.getThen().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_4.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("rcu_read_unlock")
	and target_4.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="last"
	and target_4.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="io_uring"
	and target_4.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_4.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("file *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof DeclStmt)
}

predicate func_6(Function func) {
exists(ReturnStmt target_6 |
	target_6.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getFollowingStmt() instanceof DeclStmt)
}

predicate func_8(Parameter vwork_8062, Variable vfiles_8064, EqualityOperation target_8) {
	target_8.getLeftOperand().(PointerFieldAccess).getTarget().getName()="files"
	and target_8.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwork_8062
	and target_8.getRightOperand().(VariableAccess).getTarget()=vfiles_8064
}

from Function func, Parameter vwork_8062, Parameter vdata_8062, Variable vfiles_8064, Initializer target_0, EqualityOperation target_8
where
func_0(vdata_8062, target_0)
and not func_1(func)
and not func_4(func)
and not func_6(func)
and func_8(vwork_8062, vfiles_8064, target_8)
and vwork_8062.getType().hasName("io_wq_work *")
and vdata_8062.getType().hasName("void *")
and vfiles_8064.getType().hasName("files_struct *")
and vwork_8062.getFunction() = func
and vdata_8062.getFunction() = func
and vfiles_8064.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
