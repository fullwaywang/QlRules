/**
 * @name linux-234f3ce485d54017f15cf5e0699cff4100121601-em_loop
 * @id cpp/linux/234f3ce485d54017f15cf5e0699cff4100121601/em-loop
 * @description linux-234f3ce485d54017f15cf5e0699cff4100121601-arch/x86/kvm/emulate.c-em_loop CVE-2014-3647
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getType().hasName("int")
	and target_0.getRValue() instanceof FunctionCall
	and target_0.getEnclosingFunction() = func)
}

predicate func_2(Parameter vctxt_3272, FunctionCall target_2) {
	target_2.getTarget().hasName("jmp_rel")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vctxt_3272
	and target_2.getArgument(1).(ValueFieldAccess).getTarget().getName()="val"
	and target_2.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="src"
	and target_2.getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_3272
}

from Function func, Parameter vctxt_3272, FunctionCall target_2
where
not func_0(func)
and func_2(vctxt_3272, target_2)
and vctxt_3272.getType().hasName("x86_emulate_ctxt *")
and vctxt_3272.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
