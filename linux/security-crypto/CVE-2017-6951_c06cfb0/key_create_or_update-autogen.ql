/**
 * @name linux-c06cfb08b88d-key_create_or_update
 * @id cpp/linux/c06cfb08b88d/key-create-or-update
 * @description linux-c06cfb08b88d-security/keys/key.c-key_create_or_update CVE-2017-6951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vindex_key_783, NotExpr target_0) {
		target_0.getOperand().(PointerFieldAccess).getTarget().getName()="instantiate"
		and target_0.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
		and target_0.getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_783
}

predicate func_1(Variable vindex_key_783, LogicalOrExpr target_1) {
		target_1.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="match"
		and target_1.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
		and target_1.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_783
		and target_1.getAnOperand() instanceof NotExpr
		and target_1.getParent().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="description"
		and target_1.getParent().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_783
		and target_1.getParent().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="preparse"
		and target_1.getParent().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
		and target_1.getParent().(LogicalOrExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_783
		and target_1.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

from Function func, Variable vindex_key_783, NotExpr target_0, LogicalOrExpr target_1
where
func_0(vindex_key_783, target_0)
and func_1(vindex_key_783, target_1)
and vindex_key_783.getType().hasName("keyring_index_key")
and vindex_key_783.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
