/**
 * @name linux-f83ce3e6b02d5e48b3a43b001390e2b58820389d-proc_pid_wchan
 * @id cpp/linux/f83ce3e6b02d5e48b3a43b001390e2b58820389d/proc-pid-wchan
 * @description linux-f83ce3e6b02d5e48b3a43b001390e2b58820389d-fs/proc/base.c-proc_pid_wchan CVE-2011-0726
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtask_317, ConditionalExpr target_2, ExprStmt target_3) {
	exists(IfStmt target_0 |
		target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ptrace_may_access")
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_317
		and target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ptrace_may_access")
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_317
		and target_0.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_0.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_0.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("int")
		and target_0.getThen().(ReturnStmt).getExpr().(Literal).getValue()="0"
		and target_0.getElse() instanceof ReturnStmt
		and target_0.getParent().(IfStmt).getCondition()=target_2
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vwchan_319, Parameter vbuffer_317, ConditionalExpr target_2, ReturnStmt target_1) {
		target_1.getExpr().(FunctionCall).getTarget().hasName("sprintf")
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_317
		and target_1.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="%lu"
		and target_1.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vwchan_319
		and target_1.getParent().(IfStmt).getCondition()=target_2
}

predicate func_2(Variable vwchan_319, ConditionalExpr target_2) {
		target_2.getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_2.getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(FunctionCall).getTarget().hasName("lookup_symbol_name")
		and target_2.getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vwchan_319
		and target_2.getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getLesserOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("char[128]")
		and target_2.getCondition().(FunctionCall).getArgument(0).(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_2.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getTarget().hasName("lookup_symbol_name")
		and target_2.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vwchan_319
		and target_2.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("char[128]")
		and target_2.getThen().(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_2.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_2.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="miss_hit"
		and target_2.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_2.getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_3(Variable vwchan_319, Parameter vtask_317, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwchan_319
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("get_wchan")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_317
}

from Function func, Variable vwchan_319, Parameter vtask_317, Parameter vbuffer_317, ReturnStmt target_1, ConditionalExpr target_2, ExprStmt target_3
where
not func_0(vtask_317, target_2, target_3)
and func_1(vwchan_319, vbuffer_317, target_2, target_1)
and func_2(vwchan_319, target_2)
and func_3(vwchan_319, vtask_317, target_3)
and vwchan_319.getType().hasName("unsigned long")
and vtask_317.getType().hasName("task_struct *")
and vbuffer_317.getType().hasName("char *")
and vwchan_319.(LocalVariable).getFunction() = func
and vtask_317.getFunction() = func
and vbuffer_317.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
