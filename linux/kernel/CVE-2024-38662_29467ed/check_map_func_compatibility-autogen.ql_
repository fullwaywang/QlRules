/**
 * @name linux-29467edc23818dc5a33042ffb4920b49b090e63d-check_map_func_compatibility
 * @id cpp/linux/29467edc23818dc5a33042ffb4920b49b090e63d/check-map-func-compatibility
 * @description linux-29467edc23818dc5a33042ffb4920b49b090e63d-kernel/bpf/verifier.c-check_map_func_compatibility CVE-2024-38662
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_6(Parameter vfunc_id_4926, EqualityOperation target_6) {
	target_6.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
	and target_6.getRightOperand() instanceof EnumConstantAccess
}

predicate func_7(Parameter vfunc_id_4926, EqualityOperation target_7) {
	target_7.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
	and target_7.getRightOperand() instanceof EnumConstantAccess
}

predicate func_8(Parameter vfunc_id_4926, EqualityOperation target_8) {
	target_8.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
}

predicate func_9(Parameter vfunc_id_4926, EqualityOperation target_9) {
	target_9.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
	and target_9.getRightOperand() instanceof EnumConstantAccess
}

predicate func_10(Parameter vfunc_id_4926, EqualityOperation target_10) {
	target_10.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
	and target_10.getRightOperand() instanceof EnumConstantAccess
}

predicate func_11(Parameter vfunc_id_4926, EqualityOperation target_11) {
	target_11.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
}

predicate func_12(Parameter vfunc_id_4926, LogicalAndExpr target_12) {
	exists(LogicalAndExpr obj_0 | obj_0=target_12.getLeftOperand() |
		exists(LogicalAndExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(LogicalAndExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(LogicalAndExpr obj_3 | obj_3=obj_2.getLeftOperand() |
					obj_3.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
					and obj_3.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
				)
				and exists(EqualityOperation obj_4 | obj_4=obj_2.getRightOperand() |
					obj_4.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
					and obj_4.getRightOperand() instanceof EnumConstantAccess
				)
			)
			and obj_1.getRightOperand() instanceof EqualityOperation
		)
		and obj_0.getRightOperand() instanceof EqualityOperation
	)
	and exists(LogicalAndExpr obj_5 | obj_5=target_12.getParent() |
		exists(NotExpr obj_6 | obj_6=obj_5.getRightOperand() |
			exists(FunctionCall obj_7 | obj_7=obj_6.getOperand() |
				obj_7.getTarget().hasName("may_update_sockmap")
				and obj_7.getArgument(0).(VariableAccess).getTarget().getType().hasName("bpf_verifier_env *")
				and obj_7.getArgument(1).(VariableAccess).getTarget()=vfunc_id_4926
			)
		)
		and obj_5.getParent().(IfStmt).getThen() instanceof GotoStmt
	)
	and target_12.getRightOperand() instanceof EqualityOperation
}

predicate func_13(Parameter vfunc_id_4926, LogicalAndExpr target_13) {
	exists(LogicalAndExpr obj_0 | obj_0=target_13.getLeftOperand() |
		exists(LogicalAndExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(LogicalAndExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(LogicalAndExpr obj_3 | obj_3=obj_2.getLeftOperand() |
					obj_3.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
					and obj_3.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
				)
				and exists(EqualityOperation obj_4 | obj_4=obj_2.getRightOperand() |
					obj_4.getLeftOperand().(VariableAccess).getTarget()=vfunc_id_4926
					and obj_4.getRightOperand() instanceof EnumConstantAccess
				)
			)
			and obj_1.getRightOperand() instanceof EqualityOperation
		)
		and obj_0.getRightOperand() instanceof EqualityOperation
	)
	and exists(LogicalAndExpr obj_5 | obj_5=target_13.getParent() |
		exists(NotExpr obj_6 | obj_6=obj_5.getRightOperand() |
			exists(FunctionCall obj_7 | obj_7=obj_6.getOperand() |
				obj_7.getTarget().hasName("may_update_sockmap")
				and obj_7.getArgument(0).(VariableAccess).getTarget().getType().hasName("bpf_verifier_env *")
				and obj_7.getArgument(1).(VariableAccess).getTarget()=vfunc_id_4926
			)
		)
		and obj_5.getParent().(IfStmt).getThen() instanceof GotoStmt
	)
	and target_13.getRightOperand() instanceof EqualityOperation
}

from Function func, Parameter vfunc_id_4926, EqualityOperation target_6, EqualityOperation target_7, EqualityOperation target_8, EqualityOperation target_9, EqualityOperation target_10, EqualityOperation target_11, LogicalAndExpr target_12, LogicalAndExpr target_13
where
func_6(vfunc_id_4926, target_6)
and func_7(vfunc_id_4926, target_7)
and func_8(vfunc_id_4926, target_8)
and func_9(vfunc_id_4926, target_9)
and func_10(vfunc_id_4926, target_10)
and func_11(vfunc_id_4926, target_11)
and func_12(vfunc_id_4926, target_12)
and func_13(vfunc_id_4926, target_13)
and vfunc_id_4926.getType().hasName("int")
and vfunc_id_4926.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
