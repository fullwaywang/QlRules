/**
 * @name linux-594cc251fdd0d231d342d88b2fdff4bc42fb0690-eb_copy_relocations
 * @id cpp/linux/594cc251fdd0d231d342d88b2fdff4bc42fb0690/eb-copy-relocations
 * @description linux-594cc251fdd0d231d342d88b2fdff4bc42fb0690-drivers/gpu/drm/i915/i915_gem_execbuffer.c-eb_copy_relocations CVE-2018-20669
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(BinaryBitwiseOperation).getValue()="2147483648"
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Variable vsize_1579, Variable vcopied_1580, Initializer target_1) {
	target_1.getExpr().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_1579
	and target_1.getExpr().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vcopied_1580
}

predicate func_2(Variable v__UNIQUE_ID___x558_1602, Variable v__UNIQUE_ID___y559_1602, VariableAccess target_2) {
	target_2.getTarget()=v__UNIQUE_ID___x558_1602
	and target_2.getParent().(LTExpr).getGreaterOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___y559_1602
}

/*predicate func_3(Variable v__UNIQUE_ID___x558_1602, Variable v__UNIQUE_ID___y559_1602, VariableAccess target_3) {
	target_3.getTarget()=v__UNIQUE_ID___y559_1602
	and target_3.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=v__UNIQUE_ID___x558_1602
}

*/
predicate func_4(Variable v__UNIQUE_ID___x558_1602, VariableAccess target_4) {
	target_4.getTarget()=v__UNIQUE_ID___x558_1602
}

predicate func_5(Variable v__UNIQUE_ID___y559_1602, VariableAccess target_5) {
	target_5.getTarget()=v__UNIQUE_ID___y559_1602
}

predicate func_6(Variable vurelocs_1577, Variable vsize_1579, ExprStmt target_7, PointerArithmeticOperation target_8, SubExpr target_10) {
exists(IfStmt target_6 |
	target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("user_access_begin")
	and target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vurelocs_1577
	and target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsize_1579
	and target_6.getThen().(GotoStmt).getName() ="end_user"
	and target_6.getLocation().isBefore(target_7.getLocation())
	and target_8.getLeftOperand().(VariableAccess).getLocation().isBefore(target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_10.getLeftOperand().(VariableAccess).getLocation().isBefore(target_6.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_7(Function func, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("stac")
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Variable vurelocs_1577, Variable vcopied_1580, PointerArithmeticOperation target_8) {
	target_8.getLeftOperand().(VariableAccess).getTarget()=vurelocs_1577
	and target_8.getRightOperand().(VariableAccess).getTarget()=vcopied_1580
}

predicate func_10(Variable vsize_1579, Variable vcopied_1580, SubExpr target_10) {
	target_10.getLeftOperand().(VariableAccess).getTarget()=vsize_1579
	and target_10.getRightOperand().(VariableAccess).getTarget()=vcopied_1580
}

from Function func, Variable vurelocs_1577, Variable vsize_1579, Variable vcopied_1580, Variable v__UNIQUE_ID___x558_1602, Variable v__UNIQUE_ID___y559_1602, Initializer target_0, Initializer target_1, VariableAccess target_2, VariableAccess target_4, VariableAccess target_5, ExprStmt target_7, PointerArithmeticOperation target_8, SubExpr target_10
where
func_0(func, target_0)
and func_1(vsize_1579, vcopied_1580, target_1)
and func_2(v__UNIQUE_ID___x558_1602, v__UNIQUE_ID___y559_1602, target_2)
and func_4(v__UNIQUE_ID___x558_1602, target_4)
and func_5(v__UNIQUE_ID___y559_1602, target_5)
and not func_6(vurelocs_1577, vsize_1579, target_7, target_8, target_10)
and func_7(func, target_7)
and func_8(vurelocs_1577, vcopied_1580, target_8)
and func_10(vsize_1579, vcopied_1580, target_10)
and vurelocs_1577.getType().hasName("drm_i915_gem_relocation_entry *")
and vsize_1579.getType().hasName("unsigned long")
and vcopied_1580.getType().hasName("unsigned long")
and v__UNIQUE_ID___x558_1602.getType().hasName("u64")
and v__UNIQUE_ID___y559_1602.getType().hasName("u64")
and vurelocs_1577.(LocalVariable).getFunction() = func
and vsize_1579.(LocalVariable).getFunction() = func
and vcopied_1580.(LocalVariable).getFunction() = func
and v__UNIQUE_ID___x558_1602.(LocalVariable).getFunction() = func
and v__UNIQUE_ID___y559_1602.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
