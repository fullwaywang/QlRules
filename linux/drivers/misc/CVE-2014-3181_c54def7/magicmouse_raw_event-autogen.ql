/**
 * @name linux-c54def7bd64d7c0b6993336abcffb8444795bf38-magicmouse_raw_event
 * @id cpp/linux/c54def7bd64d7c0b6993336abcffb8444795bf38/magicmouse-raw-event
 * @description linux-c54def7bd64d7c0b6993336abcffb8444795bf38-drivers/hid/hid-magicmouse.c-magicmouse_raw_event CVE-2014-3181
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhdev_280, Parameter vsize_281, Variable vnpoints_285, ArrayExpr target_2, FunctionCall target_3, ExprStmt target_4, LogicalOrExpr target_5, RelationalOperation target_6) {
exists(IfStmt target_0 |
	target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vnpoints_285
	and target_0.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="15"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_warn")
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_280
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid size value (%d) for TRACKPAD_REPORT_ID\n"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vsize_281
	and target_0.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_2
	and target_3.getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_5.getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_6.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vhdev_280, Parameter vsize_281, Variable vnpoints_285, ArrayExpr target_2, ExprStmt target_7, ExprStmt target_8, SubExpr target_9, RelationalOperation target_10) {
exists(IfStmt target_1 |
	target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vnpoints_285
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="15"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_warn")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_280
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid size value (%d) for MOUSE_REPORT_ID\n"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vsize_281
	and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_2
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_8.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_9.getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_10.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_2(Function func, ArrayExpr target_2) {
	target_2.getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_2.getArrayOffset().(Literal).getValue()="0"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vhdev_280, FunctionCall target_3) {
	target_3.getTarget().hasName("hid_get_drvdata")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vhdev_280
}

predicate func_4(Parameter vsize_281, Variable vnpoints_285, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnpoints_285
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_281
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="4"
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(Literal).getValue()="9"
}

predicate func_5(Parameter vsize_281, LogicalOrExpr target_5) {
	target_5.getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vsize_281
	and target_5.getLeftOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="6"
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(RemExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_281
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(RemExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="6"
	and target_5.getRightOperand().(EqualityOperation).getLeftOperand().(RemExpr).getRightOperand().(Literal).getValue()="8"
	and target_5.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
}

predicate func_6(Variable vnpoints_285, ExprStmt target_11, RelationalOperation target_6) {
	 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
	and target_6.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_6.getGreaterOperand().(VariableAccess).getTarget()=vnpoints_285
	and target_6.getParent().(ForStmt).getStmt()=target_11
}

predicate func_7(Parameter vhdev_280, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("magicmouse_raw_event")
	and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhdev_280
	and target_7.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("hid_report *")
	and target_7.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_7.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getRightOperand().(Literal).getValue()="2"
	and target_7.getExpr().(FunctionCall).getArgument(3).(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_7.getExpr().(FunctionCall).getArgument(3).(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
}

predicate func_8(Parameter vsize_281, Variable vnpoints_285, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnpoints_285
	and target_8.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_281
	and target_8.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="6"
	and target_8.getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(Literal).getValue()="8"
}

predicate func_9(Parameter vsize_281, SubExpr target_9) {
	target_9.getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vsize_281
	and target_9.getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="2"
	and target_9.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_9.getRightOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
}

predicate func_10(Variable vnpoints_285, ExprStmt target_12, RelationalOperation target_10) {
	 (target_10 instanceof GTExpr or target_10 instanceof LTExpr)
	and target_10.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_10.getGreaterOperand().(VariableAccess).getTarget()=vnpoints_285
	and target_10.getParent().(ForStmt).getStmt()=target_12
}

predicate func_11(Function func, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("magicmouse_emit_touch")
	and target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("magicmouse_sc *")
	and target_11.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
	and target_11.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_11.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_11.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(MulExpr).getRightOperand().(Literal).getValue()="9"
	and target_11.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getRightOperand().(Literal).getValue()="4"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Function func, ExprStmt target_12) {
	target_12.getExpr().(FunctionCall).getTarget().hasName("magicmouse_emit_touch")
	and target_12.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("magicmouse_sc *")
	and target_12.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
	and target_12.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_12.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_12.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(MulExpr).getRightOperand().(Literal).getValue()="8"
	and target_12.getExpr().(FunctionCall).getArgument(2).(PointerArithmeticOperation).getRightOperand().(Literal).getValue()="6"
	and target_12.getEnclosingFunction() = func
}

from Function func, Parameter vhdev_280, Parameter vsize_281, Variable vnpoints_285, ArrayExpr target_2, FunctionCall target_3, ExprStmt target_4, LogicalOrExpr target_5, RelationalOperation target_6, ExprStmt target_7, ExprStmt target_8, SubExpr target_9, RelationalOperation target_10, ExprStmt target_11, ExprStmt target_12
where
not func_0(vhdev_280, vsize_281, vnpoints_285, target_2, target_3, target_4, target_5, target_6)
and not func_1(vhdev_280, vsize_281, vnpoints_285, target_2, target_7, target_8, target_9, target_10)
and func_2(func, target_2)
and func_3(vhdev_280, target_3)
and func_4(vsize_281, vnpoints_285, target_4)
and func_5(vsize_281, target_5)
and func_6(vnpoints_285, target_11, target_6)
and func_7(vhdev_280, target_7)
and func_8(vsize_281, vnpoints_285, target_8)
and func_9(vsize_281, target_9)
and func_10(vnpoints_285, target_12, target_10)
and func_11(func, target_11)
and func_12(func, target_12)
and vhdev_280.getType().hasName("hid_device *")
and vsize_281.getType().hasName("int")
and vnpoints_285.getType().hasName("int")
and vhdev_280.getFunction() = func
and vsize_281.getFunction() = func
and vnpoints_285.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
