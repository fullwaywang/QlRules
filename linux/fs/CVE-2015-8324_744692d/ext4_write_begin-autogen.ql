/**
 * @name linux-744692dc059845b2a3022119871846e74d4f6e11-ext4_write_begin
 * @id cpp/linux/744692dc059845b2a3022119871846e74d4f6e11/ext4-write-begin
 * @description linux-744692dc059845b2a3022119871846e74d4f6e11-fs/ext4/inode.c-ext4_write_begin CVE-2015-8324
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpagep_1539, Parameter vfsdata_1539, Variable vinode_1541, Variable vret_1542, Parameter vmapping_1537, Parameter vpos_1538, Parameter vlen_1538, Parameter vflags_1538, Parameter vfile_1537, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(FunctionCall).getTarget().hasName("ext4_should_dioread_nolock")
	and target_0.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1541
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1542
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("block_write_begin")
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfile_1537
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vmapping_1537
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpos_1538
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vlen_1538
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vflags_1538
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vpagep_1539
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vfsdata_1539
	and target_0.getElse() instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getLocation())
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_0.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
	and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vpagep_1539, Parameter vfsdata_1539, Variable vret_1542, Parameter vmapping_1537, Parameter vpos_1538, Parameter vlen_1538, Parameter vflags_1538, Parameter vfile_1537, Function func, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1542
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("block_write_begin")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfile_1537
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vmapping_1537
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpos_1538
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vlen_1538
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vflags_1538
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vpagep_1539
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vfsdata_1539
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Parameter vpagep_1539, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpagep_1539
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("page *")
}

predicate func_3(Variable vinode_1541, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("handle_t *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ext4_journal_start")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1541
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_4(Variable vinode_1541, Variable vret_1542, LogicalAndExpr target_4) {
	target_4.getLeftOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_1542
	and target_4.getRightOperand().(FunctionCall).getTarget().hasName("ext4_should_journal_data")
	and target_4.getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1541
}

predicate func_5(Variable vret_1542, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1542
	and target_5.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-12"
}

predicate func_6(Parameter vmapping_1537, Parameter vflags_1538, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("page *")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("grab_cache_page_write_begin")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmapping_1537
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vflags_1538
}

predicate func_7(Parameter vpos_1538, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vpos_1538
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(SubExpr).getValue()="4095"
}

predicate func_8(Parameter vlen_1538, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_8.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vlen_1538
}

from Function func, Parameter vpagep_1539, Parameter vfsdata_1539, Variable vinode_1541, Variable vret_1542, Parameter vmapping_1537, Parameter vpos_1538, Parameter vlen_1538, Parameter vflags_1538, Parameter vfile_1537, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8
where
not func_0(vpagep_1539, vfsdata_1539, vinode_1541, vret_1542, vmapping_1537, vpos_1538, vlen_1538, vflags_1538, vfile_1537, target_1, target_2, target_3, target_4, target_5, target_6, target_7, target_8, func)
and func_1(vpagep_1539, vfsdata_1539, vret_1542, vmapping_1537, vpos_1538, vlen_1538, vflags_1538, vfile_1537, func, target_1)
and func_2(vpagep_1539, target_2)
and func_3(vinode_1541, target_3)
and func_4(vinode_1541, vret_1542, target_4)
and func_5(vret_1542, target_5)
and func_6(vmapping_1537, vflags_1538, target_6)
and func_7(vpos_1538, target_7)
and func_8(vlen_1538, target_8)
and vpagep_1539.getType().hasName("page **")
and vfsdata_1539.getType().hasName("void **")
and vinode_1541.getType().hasName("inode *")
and vret_1542.getType().hasName("int")
and vmapping_1537.getType().hasName("address_space *")
and vpos_1538.getType().hasName("loff_t")
and vlen_1538.getType().hasName("unsigned int")
and vflags_1538.getType().hasName("unsigned int")
and vfile_1537.getType().hasName("file *")
and vpagep_1539.getFunction() = func
and vfsdata_1539.getFunction() = func
and vinode_1541.(LocalVariable).getFunction() = func
and vret_1542.(LocalVariable).getFunction() = func
and vmapping_1537.getFunction() = func
and vpos_1538.getFunction() = func
and vlen_1538.getFunction() = func
and vflags_1538.getFunction() = func
and vfile_1537.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
