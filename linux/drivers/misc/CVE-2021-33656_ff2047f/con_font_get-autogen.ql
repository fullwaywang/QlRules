/**
 * @name linux-ff2047fb755d4415ec3c70ac799889371151796d-con_font_get
 * @id cpp/linux/ff2047fb755d4415ec3c70ac799889371151796d/con-font-get
 * @description linux-ff2047fb755d4415ec3c70ac799889371151796d-drivers/tty/vt/vt.c-con_font_get CVE-2021-33656
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vop_4557, Variable vfont_4559, Variable vrc_4560, NotExpr target_3, IfStmt target_0) {
	target_0.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="width"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="width"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4557
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="height"
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4557
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_4560
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-28"
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_1(Parameter vop_4557, Variable vfont_4559, Variable vrc_4560, Function func, IfStmt target_1) {
	target_1.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_1.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4557
	and target_1.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2147483648"
	and target_1.getThen().(BlockStmt).getStmt(0) instanceof IfStmt
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="width"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="8"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_4560
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-5"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="height"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_4560
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

/*predicate func_2(Parameter vop_4557, Variable vfont_4559, Variable vrc_4560, NotExpr target_3, IfStmt target_2) {
	target_2.getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="width"
	and target_2.getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_2.getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="8"
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_4560
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-5"
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4557
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="height"
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="height"
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vop_4557
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="height"
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfont_4559
	and target_2.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="32"
	and target_2.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_4560
	and target_2.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-28"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
predicate func_3(Function func, NotExpr target_3) {
	target_3.getOperand() instanceof BitwiseAndExpr
	and target_3.getEnclosingFunction() = func
}

from Function func, Parameter vop_4557, Variable vfont_4559, Variable vrc_4560, IfStmt target_0, IfStmt target_1, NotExpr target_3
where
func_0(vop_4557, vfont_4559, vrc_4560, target_3, target_0)
and func_1(vop_4557, vfont_4559, vrc_4560, func, target_1)
and func_3(func, target_3)
and vop_4557.getType().hasName("console_font_op *")
and vfont_4559.getType().hasName("console_font")
and vrc_4560.getType().hasName("int")
and vop_4557.getFunction() = func
and vfont_4559.(LocalVariable).getFunction() = func
and vrc_4560.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
