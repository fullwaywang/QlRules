/**
 * @name linux-4970e48f83dbd21d2a6a7cdaaafc2a71f7f45dc4-hci_conn_add_unset
 * @id cpp/linux/4970e48f83dbd21d2a6a7cdaaafc2a71f7f45dc4/hci-conn-add-unset
 * @description linux-4970e48f83dbd21d2a6a7cdaaafc2a71f7f45dc4-net/bluetooth/hci_conn.c-hci_conn_add_unset CVE-2024-42132
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtype_1069, Parameter vdst_1070, Parameter vrole_1070, Variable vhandle_1072, Parameter vhdev_1069, FunctionCall target_0) {
	target_0.getTarget().hasName("hci_conn_add")
	and not target_0.getTarget().hasName("__hci_conn_add")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vhdev_1069
	and target_0.getArgument(1).(VariableAccess).getTarget()=vtype_1069
	and target_0.getArgument(2).(VariableAccess).getTarget()=vdst_1070
	and target_0.getArgument(3).(VariableAccess).getTarget()=vrole_1070
	and target_0.getArgument(4).(VariableAccess).getTarget()=vhandle_1072
}

from Function func, Parameter vtype_1069, Parameter vdst_1070, Parameter vrole_1070, Variable vhandle_1072, Parameter vhdev_1069, FunctionCall target_0
where
func_0(vtype_1069, vdst_1070, vrole_1070, vhandle_1072, vhdev_1069, target_0)
and vtype_1069.getType().hasName("int")
and vdst_1070.getType().hasName("bdaddr_t *")
and vrole_1070.getType().hasName("u8")
and vhandle_1072.getType().hasName("int")
and vhdev_1069.getType().hasName("hci_dev *")
and vtype_1069.getFunction() = func
and vdst_1070.getFunction() = func
and vrole_1070.getFunction() = func
and vhandle_1072.(LocalVariable).getFunction() = func
and vhdev_1069.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
