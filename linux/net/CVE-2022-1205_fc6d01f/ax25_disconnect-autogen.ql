/**
 * @name linux-fc6d01ff9ef03b66d4a3a23b46fc3c3d8cf92009-ax25_disconnect
 * @id cpp/linux/fc6d01ff9ef03b66d4a3a23b46fc3c3d8cf92009/ax25-disconnect
 * @description linux-fc6d01ff9ef03b66d4a3a23b46fc3c3d8cf92009-ax25_disconnect CVE-2022-1205
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vax25_260, Parameter vreason_260, ExprStmt target_6, LogicalOrExpr target_7, ExprStmt target_8, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vreason_260
		and target_0.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="101"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("del_timer_sync")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="timer"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("del_timer_sync")
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t1timer"
		and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("del_timer_sync")
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t2timer"
		and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("del_timer_sync")
		and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t3timer"
		and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_0.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("del_timer_sync")
		and target_0.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="idletimer"
		and target_0.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_0.getElse().(BlockStmt).getStmt(0) instanceof IfStmt
		and target_0.getElse().(BlockStmt).getStmt(1) instanceof ExprStmt
		and target_0.getElse().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_0.getElse().(BlockStmt).getStmt(3) instanceof ExprStmt
		and target_0.getElse().(BlockStmt).getStmt(4) instanceof ExprStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_8.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vax25_260, Function func, IfStmt target_1) {
		target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("sock_flag")
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sk"
		and target_1.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_1.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ax25_stop_heartbeat")
		and target_1.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Parameter vax25_260, Function func, ExprStmt target_2) {
		target_2.getExpr().(FunctionCall).getTarget().hasName("ax25_stop_t1timer")
		and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Parameter vax25_260, Function func, ExprStmt target_3) {
		target_3.getExpr().(FunctionCall).getTarget().hasName("ax25_stop_t2timer")
		and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Parameter vax25_260, Function func, ExprStmt target_4) {
		target_4.getExpr().(FunctionCall).getTarget().hasName("ax25_stop_t3timer")
		and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Parameter vax25_260, Function func, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("ax25_stop_idletimer")
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Parameter vax25_260, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("ax25_clear_queues")
		and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
}

predicate func_7(Parameter vax25_260, LogicalOrExpr target_7) {
		target_7.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk"
		and target_7.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
		and target_7.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("sock_flag")
		and target_7.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sk"
		and target_7.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_260
}

predicate func_8(Parameter vax25_260, Parameter vreason_260, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("ax25_link_failed")
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_260
		and target_8.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vreason_260
}

from Function func, Parameter vax25_260, Parameter vreason_260, IfStmt target_1, ExprStmt target_2, ExprStmt target_3, ExprStmt target_4, ExprStmt target_5, ExprStmt target_6, LogicalOrExpr target_7, ExprStmt target_8
where
not func_0(vax25_260, vreason_260, target_6, target_7, target_8, func)
and func_1(vax25_260, func, target_1)
and func_2(vax25_260, func, target_2)
and func_3(vax25_260, func, target_3)
and func_4(vax25_260, func, target_4)
and func_5(vax25_260, func, target_5)
and func_6(vax25_260, target_6)
and func_7(vax25_260, target_7)
and func_8(vax25_260, vreason_260, target_8)
and vax25_260.getType().hasName("ax25_cb *")
and vreason_260.getType().hasName("int")
and vax25_260.getFunction() = func
and vreason_260.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
