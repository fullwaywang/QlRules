/**
 * @name linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-key_gc_unused_keys
 * @id cpp/linux/363b02dab09b3226f3bd1420dad9c72b79a42a76/key-gc-unused-keys
 * @description linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-security/keys/gc.c-key_gc_unused_keys CVE-2017-15951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vkey_130, Literal target_0) {
	target_0.getValue()="0"
	and not target_0.getValue()="2"
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_0.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_1(Variable vkey_130, Literal target_1) {
	target_1.getValue()="0"
	and not target_1.getValue()="2"
	and target_1.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_1.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_1.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_2(Variable vkey_130, Literal target_2) {
	target_2.getValue()="3"
	and not target_2.getValue()="2"
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_2.getParent().(FunctionCall).getParent().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_3(Variable vkey_130, Literal target_3) {
	target_3.getValue()="3"
	and not target_3.getValue()="2"
	and target_3.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_3.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_3.getParent().(FunctionCall).getParent().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_4(Function func, SizeofExprOperator target_4) {
	target_4.getValue()="328"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vkey_130, ExprStmt target_10) {
exists(EqualityOperation target_5 |
	target_5.getLeftOperand().(VariableAccess).getType().hasName("short")
	and target_5.getParent().(LogicalAndExpr).getLeftOperand() instanceof LogicalAndExpr
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="destroy"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_5.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_10)
}

predicate func_6(ExprStmt target_11, Function func) {
exists(EqualityOperation target_6 |
	target_6.getLeftOperand().(VariableAccess).getType().hasName("short")
	and target_6.getParent().(IfStmt).getThen()=target_11
	and target_6.getEnclosingFunction() = func)
}

predicate func_7(Variable vkey_130, VariableAccess target_7) {
	target_7.getTarget()=vkey_130
	and target_7.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen() instanceof FunctionCall
}

predicate func_8(Variable vkey_130, ExprStmt target_10, LogicalAndExpr target_8) {
	target_8.getLeftOperand().(ConditionalExpr).getCondition().(Literal).getValue()="1"
	and target_8.getLeftOperand().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_8.getLeftOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(0) instanceof Literal
	and target_8.getLeftOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getLeftOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_8.getLeftOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_8.getLeftOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0) instanceof Literal
	and target_8.getLeftOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getLeftOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getCondition().(Literal).getValue()="1"
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(0).(Literal).getValue()="5"
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(Literal).getValue()="5"
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getRightOperand().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="destroy"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_8.getParent().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_8.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_10
}

predicate func_9(Variable vkey_130, ExprStmt target_11, AddressOfExpr target_12, AddressOfExpr target_13, ConditionalExpr target_9) {
	target_9.getCondition().(Literal).getValue()="1"
	and target_9.getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
	and target_9.getThen().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_9.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_9.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_9.getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
	and target_9.getElse().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_9.getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_9.getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_9.getParent().(IfStmt).getThen()=target_11
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_9.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_10(Variable vkey_130, ExprStmt target_10) {
	target_10.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="destroy"
	and target_10.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="type"
	and target_10.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
	and target_10.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vkey_130
}

predicate func_11(Variable vkey_130, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("atomic_dec")
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nikeys"
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="user"
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_12(Variable vkey_130, AddressOfExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="nkeys"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="user"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

predicate func_13(Variable vkey_130, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="nikeys"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="user"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_130
}

from Function func, Variable vkey_130, Literal target_0, Literal target_1, Literal target_2, Literal target_3, SizeofExprOperator target_4, VariableAccess target_7, LogicalAndExpr target_8, ConditionalExpr target_9, ExprStmt target_10, ExprStmt target_11, AddressOfExpr target_12, AddressOfExpr target_13
where
func_0(vkey_130, target_0)
and func_1(vkey_130, target_1)
and func_2(vkey_130, target_2)
and func_3(vkey_130, target_3)
and func_4(func, target_4)
and not func_5(vkey_130, target_10)
and not func_6(target_11, func)
and func_7(vkey_130, target_7)
and func_8(vkey_130, target_10, target_8)
and func_9(vkey_130, target_11, target_12, target_13, target_9)
and func_10(vkey_130, target_10)
and func_11(vkey_130, target_11)
and func_12(vkey_130, target_12)
and func_13(vkey_130, target_13)
and vkey_130.getType().hasName("key *")
and vkey_130.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
