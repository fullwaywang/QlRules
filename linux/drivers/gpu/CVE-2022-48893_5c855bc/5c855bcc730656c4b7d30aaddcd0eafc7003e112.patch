commit 5c855bcc730656c4b7d30aaddcd0eafc7003e112
Author: Chris Wilson <chris.p.wilson@intel.com>
Date:   Thu Sep 15 16:26:51 2022 -0700

    drm/i915/gt: Cleanup partial engine discovery failures
    
    [ Upstream commit 78a033433a5ae4fee85511ee075bc9a48312c79e ]
    
    If we abort driver initialisation in the middle of gt/engine discovery,
    some engines will be fully setup and some not. Those incompletely setup
    engines only have 'engine->release == NULL' and so will leak any of the
    common objects allocated.
    
    v2:
     - Drop the destroy_pinned_context() helper for now.  It's not really
       worth it with just a single callsite at the moment.  (Janusz)
    
    Signed-off-by: Chris Wilson <chris.p.wilson@intel.com>
    Cc: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
    Signed-off-by: Matt Roper <matthew.d.roper@intel.com>
    Reviewed-by: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
    Link: https://patchwork.freedesktop.org/patch/msgid/20220915232654.3283095-2-matthew.d.roper@intel.com
    Signed-off-by: Sasha Levin <sashal@kernel.org>

diff --git a/drivers/gpu/drm/i915/gt/intel_engine_cs.c b/drivers/gpu/drm/i915/gt/intel_engine_cs.c
index 83bfeb872bda..fcbccd8d244e 100644
--- a/drivers/gpu/drm/i915/gt/intel_engine_cs.c
+++ b/drivers/gpu/drm/i915/gt/intel_engine_cs.c
@@ -1343,8 +1343,13 @@ int intel_engines_init(struct intel_gt *gt)
 			return err;
 
 		err = setup(engine);
-		if (err)
+		if (err) {
+			intel_engine_cleanup_common(engine);
 			return err;
+		}
+
+		/* The backend should now be responsible for cleanup */
+		GEM_BUG_ON(engine->release == NULL);
 
 		err = engine_init_common(engine);
 		if (err)
