/**
 * @name linux-fd19d3b45164466a4adce7cbff448ba9189e1427-kvm_init_shadow_ept_mmu
 * @id cpp/linux/fd19d3b45164466a4adce7cbff448ba9189e1427/kvm-init-shadow-ept-mmu
 * @description linux-fd19d3b45164466a4adce7cbff448ba9189e1427-arch/x86/kvm/mmu.c-kvm_init_shadow_ept_mmu CVE-2017-12188
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvcpu_4535, Variable vcontext_4538, ExprStmt target_1, ExprStmt target_2, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(FunctionCall).getTarget().hasName("update_last_nonleaf_level")
	and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_4535
	and target_0.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vcontext_4538
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vvcpu_4535, Variable vcontext_4538, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("reset_rsvds_bits_mask_ept")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_4535
	and target_1.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vcontext_4538
	and target_1.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("bool")
}

predicate func_2(Parameter vvcpu_4535, Variable vcontext_4538, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("update_pkru_bitmask")
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvcpu_4535
	and target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vcontext_4538
}

from Function func, Parameter vvcpu_4535, Variable vcontext_4538, ExprStmt target_1, ExprStmt target_2
where
not func_0(vvcpu_4535, vcontext_4538, target_1, target_2, func)
and func_1(vvcpu_4535, vcontext_4538, target_1)
and func_2(vvcpu_4535, vcontext_4538, target_2)
and vvcpu_4535.getType().hasName("kvm_vcpu *")
and vcontext_4538.getType().hasName("kvm_mmu *")
and vvcpu_4535.getFunction() = func
and vcontext_4538.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
