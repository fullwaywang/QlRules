commit fcd1d79aa943fff4fbaa0cce1d576995a7960699
Author: Guchun Chen <guchun.chen@amd.com>
Date:   Fri Feb 18 13:05:26 2022 +0800

    drm/amdgpu: bypass tiling flag check in virtual display case (v2)
    
    [ Upstream commit e2b993302f40c4eb714ecf896dd9e1c5be7d4cd7 ]
    
    vkms leverages common amdgpu framebuffer creation, and
    also as it does not support FB modifier, there is no need
    to check tiling flags when initing framebuffer when virtual
    display is enabled.
    
    This can fix below calltrace:
    
    amdgpu 0000:00:08.0: GFX9+ requires FB check based on format modifier
    WARNING: CPU: 0 PID: 1023 at drivers/gpu/drm/amd/amdgpu/amdgpu_display.c:1150 amdgpu_display_framebuffer_init+0x8e7/0xb40 [amdgpu]
    
    v2: check adev->enable_virtual_display instead as vkms can be
            enabled in bare metal as well.
    
    Signed-off-by: Leslie Shi <Yuliang.Shi@amd.com>
    Signed-off-by: Guchun Chen <guchun.chen@amd.com>
    Reviewed-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

diff --git a/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c b/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
index dc50c05f23fc..5c08047adb59 100644
--- a/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
+++ b/drivers/gpu/drm/amd/amdgpu/amdgpu_display.c
@@ -1145,7 +1145,7 @@ int amdgpu_display_framebuffer_init(struct drm_device *dev,
 	if (ret)
 		return ret;
 
-	if (!dev->mode_config.allow_fb_modifiers) {
+	if (!dev->mode_config.allow_fb_modifiers && !adev->enable_virtual_display) {
 		drm_WARN_ONCE(dev, adev->family >= AMDGPU_FAMILY_AI,
 			      "GFX9+ requires FB check based on format modifier\n");
 		ret = check_tiling_flags_gfx6(rfb);
