commit e579b20308290df03f045c5d0ccb852d96b24ce3	e579b20308290df03f045c5d0ccb852d96b24ce3
Author: Adam Rice <ricea@chromium.org>
Date:   Tue Aug 1 07:34:05 2023 +0000

    NetworkContext: Don't access url_loader_factories_ during destruction
    
    Move the contents of `url_loader_factories_` to a temporary variable in
    the destructor of network::NetworkContext so that re-entrant calls to
    DestroyURLLoaderFactory() don't happen after it has started being
    destroyed.
    
    BUG=1465833
    
    Change-Id: I476f0865256bdcba4ec934688597e69991968f84
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4733351
    Reviewed-by: Kenichi Ishibashi <bashi@chromium.org>
    Commit-Queue: Adam Rice <ricea@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1177648}

diff --git a/services/network/network_context.cc b/services/network/network_context.cc
index fcba565164b48..1556492129b85 100644
--- a/services/network/network_context.cc
+++ b/services/network/network_context.cc
@@ -651,6 +651,8 @@ NetworkContext::NetworkContext(
 }
 
 NetworkContext::~NetworkContext() {
+  is_destructing_ = true;
+
   // May be nullptr in tests.
   if (network_service_)
     network_service_->DeregisterNetworkContext(this);
@@ -708,6 +710,12 @@ NetworkContext::~NetworkContext() {
     }
   }
 #endif  // BUILDFLAG(IS_DIRECTORY_TRANSFER_REQUIRED)
+
+  // Clear `url_loader_factories_` before deleting the contents, as it can
+  // result in re-entrant calls to DestroyURLLoaderFactory().
+  std::set<std::unique_ptr<cors::CorsURLLoaderFactory>,
+           base::UniquePtrComparator>
+      url_loader_factories = std::move(url_loader_factories_);
 }
 
 void NetworkContext::OnCookieManagerSettingsChanged() {
@@ -951,6 +959,9 @@ void NetworkContext::DisableQuic() {
 
 void NetworkContext::DestroyURLLoaderFactory(
     cors::CorsURLLoaderFactory* url_loader_factory) {
+  if (is_destructing_) {
+    return;
+  }
   auto it = url_loader_factories_.find(url_loader_factory);
   DCHECK(it != url_loader_factories_.end());
   url_loader_factories_.erase(it);
diff --git a/services/network/network_context.h b/services/network/network_context.h
index 5a6cfcf157071..ddf98ac1115a1 100644
--- a/services/network/network_context.h
+++ b/services/network/network_context.h
@@ -961,6 +961,10 @@ class COMPONENT_EXPORT(NETWORK_SERVICE) NetworkContext
   // according to the spec.
   bool acam_preflight_spec_conformant_ = true;
 
+  // True once the destructor has been called. Used to guard against re-entrant
+  // calls to DestroyURLLoaderFactory().
+  bool is_destructing_ = false;
+
   // Indicating whether
   // https://fetch.spec.whatwg.org/#cors-non-wildcard-request-header-name is
   // supported.
@@ -969,13 +973,8 @@ class COMPONENT_EXPORT(NETWORK_SERVICE) NetworkContext
 
   // CorsURLLoaderFactory assumes that fields owned by the NetworkContext always
   // live longer than the factory.  Therefore we want the factories to be
-  // destroyed before other fields above.  In particular:
-  // - This must be below |url_request_context_| so that the URLRequestContext
-  //   outlives all the URLLoaderFactories and URLLoaders that depend on it;
-  //   for the same reason, it must also be below |network_context_|.
-  // - This must be below |loader_count_per_process_| that is touched by
-  //   CorsURLLoaderFactory::DestroyURLLoader (see also
-  //   https://crbug.com/1174943).
+  // destroyed before other fields above.  This is accomplished by explicitly
+  // clearing `url_loader_factories_` in the destructor.
   std::set<std::unique_ptr<cors::CorsURLLoaderFactory>,
            base::UniquePtrComparator>
       url_loader_factories_;
