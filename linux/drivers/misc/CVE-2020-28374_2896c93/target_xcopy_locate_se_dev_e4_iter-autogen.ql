/**
 * @name linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-target_xcopy_locate_se_dev_e4_iter
 * @id cpp/linux/2896c93811e39d63a4d9b63ccf12a8fbc226e5e4/target-xcopy-locate-se-dev-e4-iter
 * @description linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-target_xcopy_locate_se_dev_e4_iter CVE-2020-28374
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Function func, StringLiteral target_1) {
		target_1.getValue()="XCOPY 0xe4: located se_dev: %p\n"
		and not target_1.getValue()="XCOPY: emulate_3pc disabled on se_dev %p\n"
		and target_1.getEnclosingFunction() = func
}

predicate func_3(Parameter vdata_55, Initializer target_3) {
		target_3.getExpr().(VariableAccess).getTarget()=vdata_55
}

predicate func_4(Function func, StringLiteral target_4) {
		target_4.getValue()="Called configfs_depend_item for se_dev: %p se_dev->se_dev_group: %p\n"
		and not target_4.getValue()="XCOPY: skip non-matching: %*ph\n"
		and target_4.getEnclosingFunction() = func
}

predicate func_7(Variable vtmp_dev_wwn_58, Variable v__UNIQUE_ID_ddebug886_81, EqualityOperation target_25, AddressOfExpr target_30, ValueFieldAccess target_31) {
	exists(DoStmt target_7 |
		target_7.getCondition() instanceof Literal
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug886_81
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY: skip non-matching: %*ph\n"
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="16"
		and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtmp_dev_wwn_58
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_7
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
		and target_30.getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
		and target_31.getQualifier().(VariableAccess).getLocation().isBefore(target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation()))
}

predicate func_12(BlockStmt target_32, Function func) {
	exists(StmtExpr target_12 |
		target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BuiltInOperation).getValue()="0"
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(BuiltInOperation).getValue()="1"
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("____wrong_branch_error")
		and target_12.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_12.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
		and target_12.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_12.getParent().(IfStmt).getThen()=target_32
		and target_12.getEnclosingFunction() = func)
}

predicate func_16(Parameter vse_dev_54, EqualityOperation target_25, ExprStmt target_34) {
	exists(ExprStmt target_16 |
		target_16.getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("_ddebug")
		and target_16.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: located se_dev: %p\n"
		and target_16.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vse_dev_54
		and target_16.getParent().(IfStmt).getCondition()=target_25
		and target_16.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_34.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_17(NotExpr target_35, Function func, ReturnStmt target_17) {
		target_17.getExpr().(Literal).getValue()="0"
		and target_17.getParent().(IfStmt).getCondition()=target_35
		and target_17.getEnclosingFunction() = func
}

predicate func_18(EqualityOperation target_36, Function func, ReturnStmt target_18) {
		target_18.getExpr().(Literal).getValue()="0"
		and target_18.getParent().(IfStmt).getCondition()=target_36
		and target_18.getEnclosingFunction() = func
}

predicate func_19(Parameter vse_dev_54, VariableAccess target_19) {
		target_19.getTarget()=vse_dev_54
		and target_19.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_22(Variable vinfo_57, PointerFieldAccess target_22) {
		target_22.getTarget().getName()="dev_wwn"
		and target_22.getQualifier().(VariableAccess).getTarget()=vinfo_57
}

predicate func_23(Parameter vse_dev_54, Variable vinfo_57, AssignExpr target_23) {
		target_23.getLValue().(PointerFieldAccess).getTarget().getName()="found_dev"
		and target_23.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_57
		and target_23.getRValue().(VariableAccess).getTarget()=vse_dev_54
}

predicate func_24(Parameter vse_dev_54, Variable vrc_59, AssignExpr target_24) {
		target_24.getLValue().(VariableAccess).getTarget()=vrc_59
		and target_24.getRValue().(FunctionCall).getTarget().hasName("target_depend_item")
		and target_24.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="cg_item"
		and target_24.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev_group"
		and target_24.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vse_dev_54
}

predicate func_25(Variable vrc_59, BlockStmt target_32, EqualityOperation target_25) {
		target_25.getAnOperand().(VariableAccess).getTarget()=vrc_59
		and target_25.getAnOperand() instanceof Literal
		and target_25.getParent().(IfStmt).getThen()=target_32
}

predicate func_26(Parameter vse_dev_54, Variable vrc_59, FunctionCall target_26) {
		target_26.getTarget().hasName("printk")
		and target_26.getArgument(0).(StringLiteral).getValue()="3configfs_depend_item attempt failed: %d for se_dev: %p\n"
		and target_26.getArgument(1).(VariableAccess).getTarget()=vrc_59
		and target_26.getArgument(2).(VariableAccess).getTarget()=vse_dev_54
}

predicate func_27(Variable vrc_59, EqualityOperation target_25, ReturnStmt target_27) {
		target_27.getExpr().(VariableAccess).getTarget()=vrc_59
		and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

predicate func_28(Parameter vse_dev_54, Variable v__UNIQUE_ID_ddebug886_81, VariableAccess target_28) {
		target_28.getTarget()=vse_dev_54
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug886_81
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev_group"
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vse_dev_54
}

/*predicate func_29(Parameter vse_dev_54, Variable v__UNIQUE_ID_ddebug886_81, AddressOfExpr target_29) {
		target_29.getOperand().(PointerFieldAccess).getTarget().getName()="dev_group"
		and target_29.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vse_dev_54
		and target_29.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_29.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug886_81
		and target_29.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
		and target_29.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vse_dev_54
}

*/
predicate func_30(Variable vinfo_57, Variable vtmp_dev_wwn_58, AddressOfExpr target_30) {
		target_30.getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtmp_dev_wwn_58
		and target_30.getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
		and target_30.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("memcmp")
		and target_30.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="dev_wwn"
		and target_30.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_57
		and target_30.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="16"
}

predicate func_31(Variable v__UNIQUE_ID_ddebug886_81, ValueFieldAccess target_31) {
		target_31.getTarget().getName()="key"
		and target_31.getQualifier().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug886_81
}

predicate func_32(Function func, BlockStmt target_32) {
		target_32.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_32.getStmt(1) instanceof ReturnStmt
		and target_32.getEnclosingFunction() = func
}

predicate func_34(Parameter vse_dev_54, Variable v__UNIQUE_ID_ddebug886_81, ExprStmt target_34) {
		target_34.getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_34.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__UNIQUE_ID_ddebug886_81
		and target_34.getExpr().(FunctionCall).getArgument(1) instanceof StringLiteral
		and target_34.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vse_dev_54
		and target_34.getExpr().(FunctionCall).getArgument(3) instanceof AddressOfExpr
}

predicate func_35(Parameter vse_dev_54, NotExpr target_35) {
		target_35.getOperand().(ValueFieldAccess).getTarget().getName()="emulate_3pc"
		and target_35.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev_attrib"
		and target_35.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vse_dev_54
}

predicate func_36(Variable vrc_59, ReturnStmt target_18, EqualityOperation target_36) {
		target_36.getAnOperand().(VariableAccess).getTarget()=vrc_59
		and target_36.getAnOperand().(Literal).getValue()="0"
		and target_36.getParent().(IfStmt).getThen()=target_18
}

from Function func, Parameter vse_dev_54, Parameter vdata_55, Variable vinfo_57, Variable vtmp_dev_wwn_58, Variable vrc_59, Variable v__UNIQUE_ID_ddebug886_81, StringLiteral target_1, Initializer target_3, StringLiteral target_4, ReturnStmt target_17, ReturnStmt target_18, VariableAccess target_19, PointerFieldAccess target_22, AssignExpr target_23, AssignExpr target_24, EqualityOperation target_25, FunctionCall target_26, ReturnStmt target_27, VariableAccess target_28, AddressOfExpr target_30, ValueFieldAccess target_31, BlockStmt target_32, ExprStmt target_34, NotExpr target_35, EqualityOperation target_36
where
func_1(func, target_1)
and func_3(vdata_55, target_3)
and func_4(func, target_4)
and not func_7(vtmp_dev_wwn_58, v__UNIQUE_ID_ddebug886_81, target_25, target_30, target_31)
and not func_12(target_32, func)
and not func_16(vse_dev_54, target_25, target_34)
and func_17(target_35, func, target_17)
and func_18(target_36, func, target_18)
and func_19(vse_dev_54, target_19)
and func_22(vinfo_57, target_22)
and func_23(vse_dev_54, vinfo_57, target_23)
and func_24(vse_dev_54, vrc_59, target_24)
and func_25(vrc_59, target_32, target_25)
and func_26(vse_dev_54, vrc_59, target_26)
and func_27(vrc_59, target_25, target_27)
and func_28(vse_dev_54, v__UNIQUE_ID_ddebug886_81, target_28)
and func_30(vinfo_57, vtmp_dev_wwn_58, target_30)
and func_31(v__UNIQUE_ID_ddebug886_81, target_31)
and func_32(func, target_32)
and func_34(vse_dev_54, v__UNIQUE_ID_ddebug886_81, target_34)
and func_35(vse_dev_54, target_35)
and func_36(vrc_59, target_18, target_36)
and vse_dev_54.getType().hasName("se_device *")
and vdata_55.getType().hasName("void *")
and vinfo_57.getType().hasName("xcopy_dev_search_info *")
and vtmp_dev_wwn_58.getType().hasName("unsigned char[16]")
and vrc_59.getType().hasName("int")
and v__UNIQUE_ID_ddebug886_81.getType().hasName("_ddebug")
and vse_dev_54.getFunction() = func
and vdata_55.getFunction() = func
and vinfo_57.(LocalVariable).getFunction() = func
and vtmp_dev_wwn_58.(LocalVariable).getFunction() = func
and vrc_59.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug886_81.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
