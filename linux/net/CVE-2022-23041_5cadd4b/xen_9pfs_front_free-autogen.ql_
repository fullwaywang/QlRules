/**
 * @name linux-5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd-xen_9pfs_front_free
 * @id cpp/linux/5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd/xen-9pfs-front-free
 * @description linux-5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd-net/9p/trans_xen.c-xen_9pfs_front_free CVE-2022-23041
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_264, Parameter vpriv_262, FunctionCall target_0) {
	target_0.getTarget().hasName("free_pages")
	and not target_0.getTarget().hasName("free_pages_exact")
	and target_0.getArgument(0).(ValueFieldAccess).getTarget().getName()="in"
	and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="data"
	and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ring_order"
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="intf"
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
	and target_0.getArgument(1).(SubExpr).getRightOperand() instanceof SubExpr
}

predicate func_1(Variable vi_264, Parameter vpriv_262, ValueFieldAccess target_5, ValueFieldAccess target_6) {
exists(BinaryBitwiseOperation target_1 |
	target_1.getLeftOperand().(Literal).getValue()="1"
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ring_order"
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="intf"
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
	and target_1.getRightOperand().(AddExpr).getRightOperand() instanceof Literal
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation())
	and target_1.getRightOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_6.getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation()))
}

predicate func_2(Variable vi_264, Parameter vpriv_262, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="ring_order"
	and target_2.getQualifier().(ValueFieldAccess).getTarget().getName()="intf"
	and target_2.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_2.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_2.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
	and target_2.getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Function func, SubExpr target_4) {
	target_4.getValue()="0"
	and target_4.getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vi_264, Parameter vpriv_262, ValueFieldAccess target_5) {
	target_5.getTarget().getName()="in"
	and target_5.getQualifier().(ValueFieldAccess).getTarget().getName()="data"
	and target_5.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_5.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_5.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
}

predicate func_6(Variable vi_264, Parameter vpriv_262, ValueFieldAccess target_6) {
	target_6.getTarget().getName()="ref"
	and target_6.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rings"
	and target_6.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_262
	and target_6.getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_264
}

from Function func, Variable vi_264, Parameter vpriv_262, FunctionCall target_0, PointerFieldAccess target_2, SubExpr target_4, ValueFieldAccess target_5, ValueFieldAccess target_6
where
func_0(vi_264, vpriv_262, target_0)
and not func_1(vi_264, vpriv_262, target_5, target_6)
and func_2(vi_264, vpriv_262, target_2)
and func_4(func, target_4)
and func_5(vi_264, vpriv_262, target_5)
and func_6(vi_264, vpriv_262, target_6)
and vi_264.getType().hasName("int")
and vpriv_262.getType().hasName("xen_9pfs_front_priv *")
and vi_264.(LocalVariable).getFunction() = func
and vpriv_262.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
