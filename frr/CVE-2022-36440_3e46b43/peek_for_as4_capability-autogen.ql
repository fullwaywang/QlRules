/**
 * @name frr-3e46b43e3788f0f87bae56a86b54d412b4710286-peek_for_as4_capability
 * @id cpp/frr/3e46b43e3788f0f87bae56a86b54d412b4710286/peek-for-as4-capability
 * @description frr-3e46b43e3788f0f87bae56a86b54d412b4710286-bgpd/bgp_open.c-peek_for_as4_capability CVE-2022-36440
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vs_1172, Variable vend_1174, RelationalOperation target_7, RelationalOperation target_8) {
	exists(IfStmt target_0 |
		target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(Literal).getValue()="1"
		and target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vend_1174
		and target_7.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_8.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vs_1172, Variable vend_1174, Variable vopt_length_1186, RelationalOperation target_8, ExprStmt target_9, RelationalOperation target_10) {
	exists(IfStmt target_1 |
		target_1.getCondition() instanceof LogicalOrExpr
		and target_1.getThen().(BlockStmt).getStmt(0) instanceof IfStmt
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vopt_length_1186
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(Literal).getValue()="1"
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vend_1174
		and target_1.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vopt_length_1186
		and target_1.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and target_8.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_1.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_10.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_2(Variable vs_1172, Variable vend_1174, IfStmt target_2) {
		target_2.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_2.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_2.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getAnOperand().(Literal).getValue()="2"
		and target_2.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vend_1174
}

predicate func_3(Parameter vpeer_1170, LogicalOrExpr target_3) {
		target_3.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpeer_1170
		and target_3.getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="1073741824"
		and target_3.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="sflags"
		and target_3.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpeer_1170
		and target_3.getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="128"
}

predicate func_4(Variable vs_1172, FunctionCall target_4) {
		target_4.getTarget().hasName("stream_getw")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vs_1172
}

predicate func_5(Variable vs_1172, FunctionCall target_5) {
		target_5.getTarget().hasName("stream_getc")
		and target_5.getArgument(0).(VariableAccess).getTarget()=vs_1172
}

predicate func_6(Variable vopt_length_1186, ConditionalExpr target_6) {
		target_6.getCondition() instanceof LogicalOrExpr
		and target_6.getThen() instanceof FunctionCall
		and target_6.getElse() instanceof FunctionCall
		and target_6.getParent().(AssignExpr).getRValue() = target_6
		and target_6.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vopt_length_1186
}

predicate func_7(Variable vs_1172, Variable vend_1174, RelationalOperation target_7) {
		 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
		and target_7.getLesserOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_7.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_7.getGreaterOperand().(VariableAccess).getTarget()=vend_1174
}

predicate func_8(Variable vs_1172, Variable vend_1174, RelationalOperation target_8) {
		 (target_8 instanceof GTExpr or target_8 instanceof LTExpr)
		and target_8.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_8.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_8.getGreaterOperand().(AddExpr).getAnOperand().(Literal).getValue()="2"
		and target_8.getLesserOperand().(VariableAccess).getTarget()=vend_1174
}

predicate func_9(Variable vs_1172, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("uint8_t")
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("stream_getc")
		and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
}

predicate func_10(Variable vs_1172, Variable vend_1174, Variable vopt_length_1186, RelationalOperation target_10) {
		 (target_10 instanceof GTExpr or target_10 instanceof LTExpr)
		and target_10.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getTarget().hasName("stream_get_getp")
		and target_10.getGreaterOperand().(AddExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_1172
		and target_10.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vopt_length_1186
		and target_10.getLesserOperand().(VariableAccess).getTarget()=vend_1174
}

from Function func, Variable vs_1172, Variable vend_1174, Parameter vpeer_1170, Variable vopt_length_1186, IfStmt target_2, LogicalOrExpr target_3, FunctionCall target_4, FunctionCall target_5, ConditionalExpr target_6, RelationalOperation target_7, RelationalOperation target_8, ExprStmt target_9, RelationalOperation target_10
where
not func_0(vs_1172, vend_1174, target_7, target_8)
and not func_1(vs_1172, vend_1174, vopt_length_1186, target_8, target_9, target_10)
and func_2(vs_1172, vend_1174, target_2)
and func_3(vpeer_1170, target_3)
and func_4(vs_1172, target_4)
and func_5(vs_1172, target_5)
and func_6(vopt_length_1186, target_6)
and func_7(vs_1172, vend_1174, target_7)
and func_8(vs_1172, vend_1174, target_8)
and func_9(vs_1172, target_9)
and func_10(vs_1172, vend_1174, vopt_length_1186, target_10)
and vs_1172.getType().hasName("stream *")
and vend_1174.getType().hasName("size_t")
and vpeer_1170.getType().hasName("peer *")
and vopt_length_1186.getType().hasName("uint16_t")
and vs_1172.(LocalVariable).getFunction() = func
and vend_1174.(LocalVariable).getFunction() = func
and vpeer_1170.getFunction() = func
and vopt_length_1186.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
