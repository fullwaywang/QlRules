/**
 * @name linux-1202cdd665315c525b5237e96e0bedc76d7e754f-nf_hook
 * @id cpp/linux/1202cdd665315c525b5237e96e0bedc76d7e754f/nf-hook
 * @description linux-1202cdd665315c525b5237e96e0bedc76d7e754f-nf_hook CVE-2023-3338
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
		target_0.getValue()="1923"
		and not target_0.getValue()="1921"
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="1924"
		and not target_1.getValue()="1922"
		and target_1.getEnclosingFunction() = func
}

predicate func_3(Variable vhook_head_216, Variable v__UNIQUE_ID_rcu1921_248, VariableAccess target_17, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhook_head_216
		and target_3.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
		and target_3.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1921_248
		and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
}

predicate func_5(Function func, DoStmt target_5) {
		target_5.getCondition() instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
		and target_5.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__compiletime_assert_1922")
		and target_5.getEnclosingFunction() = func
}

/*predicate func_7(Function func, IfStmt target_7) {
		target_7.getCondition().(NotExpr).getValue()="0"
		and target_7.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__compiletime_assert_1922")
		and target_7.getEnclosingFunction() = func
}

*/
predicate func_8(Parameter vhook_211, Parameter vnet_211, ExprStmt target_8) {
		target_8.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="hooks_decnet"
		and target_8.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nf"
		and target_8.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_211
		and target_8.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vhook_211
}

/*predicate func_9(Variable v__warned_248, DoStmt target_9) {
		target_9.getCondition() instanceof Literal
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_248
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
}

*/
/*predicate func_11(Variable v__warned_248, IfStmt target_11) {
		target_11.getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(LogicalOrExpr).getAnOperand() instanceof Literal
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(LogicalOrExpr).getAnOperand().(FunctionCall).getTarget().hasName("rcu_read_lock_held")
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_11.getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_248
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
}

*/
/*predicate func_12(Variable v__warned_248, LogicalAndExpr target_18, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
		and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
}

*/
/*predicate func_13(LogicalAndExpr target_18, Function func, ExprStmt target_13) {
		target_13.getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
		and target_13.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_13.getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_13.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
		and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
		and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_15(Variable v__UNIQUE_ID_rcu1921_248, ExprStmt target_15) {
		target_15.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1921_248
}

*/
predicate func_16(VariableAccess target_17, Function func, BreakStmt target_16) {
		target_16.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_16.getEnclosingFunction() = func
}

predicate func_17(Parameter vpf_211, VariableAccess target_17) {
		target_17.getTarget()=vpf_211
}

predicate func_18(BlockStmt target_19, Function func, LogicalAndExpr target_18) {
		target_18.getAnOperand() instanceof LogicalAndExpr
		and target_18.getAnOperand() instanceof NotExpr
		and target_18.getParent().(IfStmt).getThen()=target_19
		and target_18.getEnclosingFunction() = func
}

predicate func_19(LogicalAndExpr target_18, Function func, BlockStmt target_19) {
		target_19.getStmt(0) instanceof ExprStmt
		and target_19.getStmt(1) instanceof ExprStmt
		and target_19.getParent().(IfStmt).getCondition()=target_18
		and target_19.getEnclosingFunction() = func
}

from Function func, Variable vhook_head_216, Parameter vhook_211, Parameter vnet_211, Parameter vpf_211, Variable v__UNIQUE_ID_rcu1921_248, Variable v__warned_248, Literal target_0, Literal target_1, ExprStmt target_3, DoStmt target_5, ExprStmt target_8, BreakStmt target_16, VariableAccess target_17, LogicalAndExpr target_18, BlockStmt target_19
where
func_0(func, target_0)
and func_1(func, target_1)
and func_3(vhook_head_216, v__UNIQUE_ID_rcu1921_248, target_17, target_3)
and func_5(func, target_5)
and func_8(vhook_211, vnet_211, target_8)
and func_16(target_17, func, target_16)
and func_17(vpf_211, target_17)
and func_18(target_19, func, target_18)
and func_19(target_18, func, target_19)
and vhook_head_216.getType().hasName("nf_hook_entries *")
and vhook_211.getType().hasName("unsigned int")
and vnet_211.getType().hasName("net *")
and vpf_211.getType().hasName("u_int8_t")
and v__UNIQUE_ID_rcu1921_248.getType().hasName("nf_hook_entries *")
and v__warned_248.getType().hasName("bool")
and vhook_head_216.(LocalVariable).getFunction() = func
and vhook_211.getFunction() = func
and vnet_211.getFunction() = func
and vpf_211.getFunction() = func
and v__UNIQUE_ID_rcu1921_248.(LocalVariable).getFunction() = func
and v__warned_248.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
