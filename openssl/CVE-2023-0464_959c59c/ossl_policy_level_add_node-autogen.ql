/**
 * @name openssl-959c59c7a0164117e7f8366466a32bb1f8d77ff1-ossl_policy_level_add_node
 * @id cpp/openssl/959c59c7a0164117e7f8366466a32bb1f8d77ff1/ossl-policy-level-add-node
 * @description openssl-959c59c7a0164117e7f8366466a32bb1f8d77ff1-crypto/x509/pcy_node.c-ossl_policy_level_add_node CVE-2023-0464
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtree_62, BlockStmt target_7, IfStmt target_8) {
	exists(LogicalAndExpr target_0 |
		target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="node_maximum"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="node_count"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="node_maximum"
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_0.getParent().(IfStmt).getThen()=target_7
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getCondition().(VariableAccess).getLocation()))
}

predicate func_1(VariableAccess target_6, Function func) {
	exists(ReturnStmt target_1 |
		target_1.getExpr().(Literal).getValue()="0"
		and target_1.getParent().(IfStmt).getCondition()=target_6
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(Parameter vlevel_59, BlockStmt target_9, IfStmt target_10) {
	exists(EqualityOperation target_2 |
		target_2.getAnOperand().(VariableAccess).getTarget()=vlevel_59
		and target_2.getAnOperand().(Literal).getValue()="0"
		and target_2.getParent().(IfStmt).getThen()=target_9
		and target_2.getAnOperand().(VariableAccess).getLocation().isBefore(target_10.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vdata_60, Parameter vtree_62, EqualityOperation target_11, IfStmt target_8, Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(VariableAccess).getType().hasName("int")
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sk_X509_POLICY_DATA_new_null")
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(ExprCall).getArgument(0).(Literal).getValue()="34"
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(ExprCall).getArgument(2).(Literal).getValue()="0"
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("sk_X509_POLICY_DATA_push")
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdata_60
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(ExprCall).getArgument(0).(Literal).getValue()="34"
		and target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(ExprCall).getArgument(2).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_11.getAnOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_8.getCondition().(VariableAccess).getLocation().isBefore(target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vtree_62, NotExpr target_12, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="node_count"
		and target_4.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_12.getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vlevel_59, BlockStmt target_9, VariableAccess target_5) {
		target_5.getTarget()=vlevel_59
		and target_5.getParent().(IfStmt).getThen()=target_9
}

predicate func_6(Parameter vtree_62, BlockStmt target_7, VariableAccess target_6) {
		target_6.getTarget()=vtree_62
		and target_6.getParent().(IfStmt).getThen()=target_7
}

predicate func_7(Parameter vtree_62, BlockStmt target_7) {
		target_7.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_7.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_7.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_7.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_7.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_7.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sk_X509_POLICY_DATA_new_null")
}

predicate func_8(Parameter vtree_62, IfStmt target_8) {
		target_8.getCondition().(VariableAccess).getTarget()=vtree_62
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sk_X509_POLICY_DATA_new_null")
}

predicate func_9(Parameter vdata_60, Parameter vlevel_59, BlockStmt target_9) {
		target_9.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(FunctionCall).getTarget().hasName("OBJ_obj2nid")
		and target_9.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="valid_policy"
		and target_9.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_60
		and target_9.getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="746"
		and target_9.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getTarget().getName()="anyPolicy"
		and target_9.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlevel_59
		and target_9.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="anyPolicy"
		and target_9.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlevel_59
		and target_9.getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("X509_POLICY_NODE *")
		and target_9.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="nodes"
		and target_9.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlevel_59
		and target_9.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_9.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="nodes"
		and target_9.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ossl_policy_node_cmp_new")
}

predicate func_10(Parameter vlevel_59, IfStmt target_10) {
		target_10.getCondition().(PointerFieldAccess).getTarget().getName()="anyPolicy"
		and target_10.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlevel_59
}

predicate func_11(Parameter vdata_60, EqualityOperation target_11) {
		target_11.getAnOperand().(FunctionCall).getTarget().hasName("OBJ_obj2nid")
		and target_11.getAnOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="valid_policy"
		and target_11.getAnOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_60
		and target_11.getAnOperand().(Literal).getValue()="746"
}

predicate func_12(Parameter vdata_60, Parameter vtree_62, NotExpr target_12) {
		target_12.getOperand().(FunctionCall).getTarget().hasName("sk_X509_POLICY_DATA_push")
		and target_12.getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="extra_data"
		and target_12.getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtree_62
		and target_12.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdata_60
}

from Function func, Parameter vdata_60, Parameter vtree_62, Parameter vlevel_59, VariableAccess target_5, VariableAccess target_6, BlockStmt target_7, IfStmt target_8, BlockStmt target_9, IfStmt target_10, EqualityOperation target_11, NotExpr target_12
where
not func_0(vtree_62, target_7, target_8)
and not func_1(target_6, func)
and not func_2(vlevel_59, target_9, target_10)
and not func_3(vdata_60, vtree_62, target_11, target_8, func)
and not func_4(vtree_62, target_12, func)
and func_5(vlevel_59, target_9, target_5)
and func_6(vtree_62, target_7, target_6)
and func_7(vtree_62, target_7)
and func_8(vtree_62, target_8)
and func_9(vdata_60, vlevel_59, target_9)
and func_10(vlevel_59, target_10)
and func_11(vdata_60, target_11)
and func_12(vdata_60, vtree_62, target_12)
and vdata_60.getType().hasName("X509_POLICY_DATA *")
and vtree_62.getType().hasName("X509_POLICY_TREE *")
and vlevel_59.getType().hasName("X509_POLICY_LEVEL *")
and vdata_60.getFunction() = func
and vtree_62.getFunction() = func
and vlevel_59.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
