/**
 * @name curl-199f2d440d8659b42-hostmatch
 * @id cpp/curl/199f2d440d8659b42/hostmatch
 * @description curl-199f2d440d8659b42-lib/vtls/hostcheck.c-hostmatch CVE-2023-28321
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpattern_79, ReturnStmt target_31, FunctionCall target_0) {
		target_0.getTarget().hasName("curl_strnequal")
		and not target_0.getTarget().hasName("strncmp")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vpattern_79
		and target_0.getArgument(1).(StringLiteral).getValue()="xn--"
		and target_0.getArgument(2).(Literal).getValue()="4"
		and target_0.getParent().(LogicalOrExpr).getAnOperand() instanceof LogicalOrExpr
		and target_0.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_31
}

predicate func_5(Function func) {
	exists(Initializer target_5 |
		target_5.getExpr() instanceof FunctionCall
		and target_5.getExpr().getEnclosingFunction() = func)
}

predicate func_6(NotExpr target_25, Function func, DeclStmt target_6) {
		target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
		and target_6.getEnclosingFunction() = func
}

predicate func_7(NotExpr target_25, Function func, DeclStmt target_7) {
		target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
		and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vhostname_77, Function func, IfStmt target_8) {
		target_8.getCondition().(FunctionCall).getTarget().hasName("Curl_host_is_ipnum")
		and target_8.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhostname_77
		and target_8.getThen().(ReturnStmt).getExpr().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vpattern_79, Parameter vpatternlen_80, Variable vpattern_label_end_82, ReturnStmt target_31, LogicalOrExpr target_9) {
		target_9.getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vpattern_label_end_82
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(FunctionCall).getTarget().hasName("Curl_memrchr")
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpattern_79
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(FunctionCall).getArgument(1).(Literal).getValue()="46"
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpatternlen_80
		and target_9.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vpattern_label_end_82
		and target_9.getParent().(LogicalOrExpr).getAnOperand() instanceof FunctionCall
		and target_9.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_31
}

predicate func_10(Parameter vhostname_77, Parameter vhostlen_78, Variable vhostname_label_end_82, FunctionCall target_10) {
		target_10.getTarget().hasName("memchr")
		and target_10.getArgument(0).(VariableAccess).getTarget()=vhostname_77
		and target_10.getArgument(1).(CharLiteral).getValue()="46"
		and target_10.getArgument(2).(VariableAccess).getTarget()=vhostlen_78
		and target_10.getParent().(AssignExpr).getRValue() = target_10
		and target_10.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhostname_label_end_82
}

predicate func_11(NotExpr target_25, Function func, ReturnStmt target_11) {
		target_11.getExpr().(Literal).getValue()="0"
		and target_11.getParent().(IfStmt).getCondition()=target_25
		and target_11.getEnclosingFunction() = func
}

predicate func_12(Parameter vhostlen_78, Parameter vpatternlen_80, Variable vpattern_label_end_82, Variable vhostname_label_end_82, Variable vskiphost_112, Variable vskiplen_113, ReturnStmt target_32, FunctionCall target_12) {
		target_12.getTarget().hasName("pmatch")
		and target_12.getArgument(0).(VariableAccess).getTarget()=vhostname_label_end_82
		and target_12.getArgument(1).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vhostlen_78
		and target_12.getArgument(1).(SubExpr).getRightOperand().(VariableAccess).getTarget()=vskiphost_112
		and target_12.getArgument(2).(VariableAccess).getTarget()=vpattern_label_end_82
		and target_12.getArgument(3).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vpatternlen_80
		and target_12.getArgument(3).(SubExpr).getRightOperand().(VariableAccess).getTarget()=vskiplen_113
		and target_12.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_32
}

predicate func_13(Parameter vpattern_79, VariableAccess target_13) {
		target_13.getTarget()=vpattern_79
		and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Variable vhostname_label_end_82, ReturnStmt target_11, VariableAccess target_14) {
		target_14.getTarget()=vhostname_label_end_82
		and target_14.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_11
}

predicate func_21(Parameter vpattern_79, Parameter vpatternlen_80, Variable vwildcard_82, Function func, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vwildcard_82
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("memchr")
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpattern_79
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(CharLiteral).getValue()="42"
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpatternlen_80
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_22(Variable vwildcard_82, ReturnStmt target_33, NotExpr target_22) {
		target_22.getOperand().(VariableAccess).getTarget()=vwildcard_82
		and target_22.getParent().(IfStmt).getThen()=target_33
}

predicate func_23(ReturnStmt target_31, Function func, LogicalOrExpr target_23) {
		target_23.getAnOperand() instanceof LogicalOrExpr
		and target_23.getAnOperand() instanceof FunctionCall
		and target_23.getParent().(IfStmt).getThen()=target_31
		and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable vhostname_label_end_82, Function func, ExprStmt target_24) {
		target_24.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhostname_label_end_82
		and target_24.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_24
}

predicate func_25(Variable vhostname_label_end_82, ReturnStmt target_11, NotExpr target_25) {
		target_25.getOperand().(VariableAccess).getTarget()=vhostname_label_end_82
		and target_25.getParent().(IfStmt).getThen()=target_11
}

predicate func_26(NotExpr target_25, Function func, IfStmt target_26) {
		target_26.getCondition().(NotExpr).getOperand() instanceof FunctionCall
		and target_26.getThen().(ReturnStmt).getExpr() instanceof Literal
		and target_26.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
		and target_26.getEnclosingFunction() = func
}

predicate func_27(Parameter vhostname_77, Parameter vpattern_79, Variable vpattern_label_end_82, Variable vhostname_label_end_82, Function func, IfStmt target_27) {
		target_27.getCondition().(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vhostname_label_end_82
		and target_27.getCondition().(RelationalOperation).getLesserOperand().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vhostname_77
		and target_27.getCondition().(RelationalOperation).getGreaterOperand().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vpattern_label_end_82
		and target_27.getCondition().(RelationalOperation).getGreaterOperand().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vpattern_79
		and target_27.getThen().(ReturnStmt).getExpr() instanceof Literal
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_27
}

predicate func_28(Parameter vpattern_79, Variable vwildcard_82, Variable vprefixlen_83, Function func, ExprStmt target_28) {
		target_28.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vprefixlen_83
		and target_28.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vwildcard_82
		and target_28.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vpattern_79
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_28
}

predicate func_29(Variable vpattern_label_end_82, Variable vwildcard_82, Variable vsuffixlen_83, Function func, ExprStmt target_29) {
		target_29.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsuffixlen_83
		and target_29.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vpattern_label_end_82
		and target_29.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vwildcard_82
		and target_29.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(PointerArithmeticOperation).getAnOperand().(Literal).getValue()="1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_29
}

predicate func_30(Parameter vhostname_77, Parameter vpattern_79, Variable vwildcard_82, Variable vhostname_label_end_82, Variable vprefixlen_83, Variable vsuffixlen_83, Function func, ReturnStmt target_30) {
		target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("curl_strnequal")
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpattern_79
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vhostname_77
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vprefixlen_83
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("curl_strnequal")
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vwildcard_82
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getAnOperand().(Literal).getValue()="1"
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vhostname_label_end_82
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vsuffixlen_83
		and target_30.getExpr().(ConditionalExpr).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vsuffixlen_83
		and target_30.getExpr().(ConditionalExpr).getThen().(Literal).getValue()="1"
		and target_30.getExpr().(ConditionalExpr).getElse() instanceof Literal
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_30
}

predicate func_31(Parameter vhostname_77, Parameter vhostlen_78, Parameter vpattern_79, Parameter vpatternlen_80, ReturnStmt target_31) {
		target_31.getExpr().(FunctionCall).getTarget().hasName("pmatch")
		and target_31.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhostname_77
		and target_31.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vhostlen_78
		and target_31.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpattern_79
		and target_31.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vpatternlen_80
}

predicate func_32(ReturnStmt target_32) {
		target_32.getExpr() instanceof Literal
}

predicate func_33(Parameter vhostname_77, Parameter vhostlen_78, Parameter vpattern_79, Parameter vpatternlen_80, ReturnStmt target_33) {
		target_33.getExpr().(FunctionCall).getTarget().hasName("pmatch")
		and target_33.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhostname_77
		and target_33.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vhostlen_78
		and target_33.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpattern_79
		and target_33.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vpatternlen_80
}

from Function func, Parameter vhostname_77, Parameter vhostlen_78, Parameter vpattern_79, Parameter vpatternlen_80, Variable vpattern_label_end_82, Variable vwildcard_82, Variable vhostname_label_end_82, Variable vprefixlen_83, Variable vsuffixlen_83, Variable vskiphost_112, Variable vskiplen_113, FunctionCall target_0, DeclStmt target_6, DeclStmt target_7, IfStmt target_8, LogicalOrExpr target_9, FunctionCall target_10, ReturnStmt target_11, FunctionCall target_12, VariableAccess target_13, VariableAccess target_14, ExprStmt target_21, NotExpr target_22, LogicalOrExpr target_23, ExprStmt target_24, NotExpr target_25, IfStmt target_26, IfStmt target_27, ExprStmt target_28, ExprStmt target_29, ReturnStmt target_30, ReturnStmt target_31, ReturnStmt target_32, ReturnStmt target_33
where
func_0(vpattern_79, target_31, target_0)
and not func_5(func)
and func_6(target_25, func, target_6)
and func_7(target_25, func, target_7)
and func_8(vhostname_77, func, target_8)
and func_9(vpattern_79, vpatternlen_80, vpattern_label_end_82, target_31, target_9)
and func_10(vhostname_77, vhostlen_78, vhostname_label_end_82, target_10)
and func_11(target_25, func, target_11)
and func_12(vhostlen_78, vpatternlen_80, vpattern_label_end_82, vhostname_label_end_82, vskiphost_112, vskiplen_113, target_32, target_12)
and func_13(vpattern_79, target_13)
and func_14(vhostname_label_end_82, target_11, target_14)
and func_21(vpattern_79, vpatternlen_80, vwildcard_82, func, target_21)
and func_22(vwildcard_82, target_33, target_22)
and func_23(target_31, func, target_23)
and func_24(vhostname_label_end_82, func, target_24)
and func_25(vhostname_label_end_82, target_11, target_25)
and func_26(target_25, func, target_26)
and func_27(vhostname_77, vpattern_79, vpattern_label_end_82, vhostname_label_end_82, func, target_27)
and func_28(vpattern_79, vwildcard_82, vprefixlen_83, func, target_28)
and func_29(vpattern_label_end_82, vwildcard_82, vsuffixlen_83, func, target_29)
and func_30(vhostname_77, vpattern_79, vwildcard_82, vhostname_label_end_82, vprefixlen_83, vsuffixlen_83, func, target_30)
and func_31(vhostname_77, vhostlen_78, vpattern_79, vpatternlen_80, target_31)
and func_32(target_32)
and func_33(vhostname_77, vhostlen_78, vpattern_79, vpatternlen_80, target_33)
and vhostname_77.getType().hasName("const char *")
and vhostlen_78.getType().hasName("size_t")
and vpattern_79.getType().hasName("const char *")
and vpatternlen_80.getType().hasName("size_t")
and vpattern_label_end_82.getType().hasName("const char *")
and vwildcard_82.getType().hasName("const char *")
and vhostname_label_end_82.getType().hasName("const char *")
and vprefixlen_83.getType().hasName("size_t")
and vsuffixlen_83.getType().hasName("size_t")
and vskiphost_112.getType().hasName("size_t")
and vskiplen_113.getType().hasName("size_t")
and vhostname_77.getFunction() = func
and vhostlen_78.getFunction() = func
and vpattern_79.getFunction() = func
and vpatternlen_80.getFunction() = func
and vpattern_label_end_82.(LocalVariable).getFunction() = func
and vwildcard_82.(LocalVariable).getFunction() = func
and vhostname_label_end_82.(LocalVariable).getFunction() = func
and vprefixlen_83.(LocalVariable).getFunction() = func
and vsuffixlen_83.(LocalVariable).getFunction() = func
and vskiphost_112.(LocalVariable).getFunction() = func
and vskiplen_113.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
