/**
 * @name linux-32927393dc1ccd60fb2bdc05b9e8e88753761469-proc_do_large_bitmap
 * @id cpp/linux/32927393dc1ccd60fb2bdc05b9e8e88753761469/proc-do-large-bitmap
 * @description linux-32927393dc1ccd60fb2bdc05b9e8e88753761469-kernel/sysctl.c-proc_do_large_bitmap CVE-2021-4218
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vbitmap_len_1424, Variable vtmp_bitmap_1426, IfStmt target_31, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtmp_bitmap_1426
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bitmap_zalloc")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbitmap_len_1424
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264"
	and target_31.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Parameter vbuffer_1419, AddressOfExpr target_32) {
exists(Initializer target_1 |
	target_1.getExpr().(VariableAccess).getTarget()=vbuffer_1419
	and target_1.getExpr().(VariableAccess).getLocation().isBefore(target_32.getOperand().(VariableAccess).getLocation()))
}

predicate func_2(Variable vtmp_bitmap_1426, BlockStmt target_33, NotExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vtmp_bitmap_1426
	and target_2.getParent().(IfStmt).getThen()=target_33
}

predicate func_3(Variable vbit_a_1519, Variable vbit_b_1519, BlockStmt target_34, EqualityOperation target_3) {
	target_3.getLeftOperand().(VariableAccess).getTarget()=vbit_a_1519
	and target_3.getRightOperand().(VariableAccess).getTarget()=vbit_b_1519
	and target_3.getParent().(IfStmt).getThen()=target_34
}

predicate func_4(NotExpr target_2, Function func, ReturnStmt target_4) {
	target_4.getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
	and target_4.getEnclosingFunction() = func
}

predicate func_5(VariableAccess target_35, Function func, DeclStmt target_5) {
	target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_35
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, FunctionCall target_6) {
	target_6.getTarget().hasName("proc_put_char")
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbuffer_1419
	and target_6.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vleft_1423
	and target_6.getArgument(2).(CharLiteral).getValue()="44"
	and target_6.getParent().(AssignExpr).getRValue() = target_6
	and target_6.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
}

predicate func_7(Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, Variable vbit_a_1519, FunctionCall target_7) {
	target_7.getTarget().hasName("proc_put_long")
	and target_7.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbuffer_1419
	and target_7.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vleft_1423
	and target_7.getArgument(2).(VariableAccess).getTarget()=vbit_a_1519
	and target_7.getParent().(AssignExpr).getRValue() = target_7
	and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
}

predicate func_8(Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, FunctionCall target_8) {
	target_8.getTarget().hasName("proc_put_char")
	and target_8.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbuffer_1419
	and target_8.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vleft_1423
	and target_8.getArgument(2).(CharLiteral).getValue()="45"
	and target_8.getParent().(AssignExpr).getRValue() = target_8
	and target_8.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
}

predicate func_9(Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, Variable vbit_b_1519, FunctionCall target_9) {
	target_9.getTarget().hasName("proc_put_long")
	and target_9.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbuffer_1419
	and target_9.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vleft_1423
	and target_9.getArgument(2).(VariableAccess).getTarget()=vbit_b_1519
	and target_9.getParent().(AssignExpr).getRValue() = target_9
	and target_9.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
}

predicate func_10(Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, FunctionCall target_10) {
	target_10.getTarget().hasName("proc_put_char")
	and target_10.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vbuffer_1419
	and target_10.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vleft_1423
	and target_10.getArgument(2).(CharLiteral).getValue()="10"
	and target_10.getParent().(AssignExpr).getRValue() = target_10
	and target_10.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
}

predicate func_11(Parameter vbuffer_1419, VariableAccess target_11) {
	target_11.getTarget()=vbuffer_1419
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_13(Parameter vbuffer_1419, Variable vleft_1423, Variable vkbuf_1435, Variable vp_1435, AssignExpr target_13) {
	target_13.getLValue().(VariableAccess).getTarget()=vp_1435
	and target_13.getRValue().(AssignExpr).getLValue().(VariableAccess).getTarget()=vkbuf_1435
	and target_13.getRValue().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("memdup_user_nul")
	and target_13.getRValue().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_1419
	and target_13.getRValue().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vleft_1423
}

predicate func_14(Variable vkbuf_1435, ReturnStmt target_15, FunctionCall target_14) {
	target_14.getTarget().hasName("IS_ERR")
	and target_14.getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
	and target_14.getParent().(IfStmt).getThen()=target_15
}

predicate func_15(Variable vkbuf_1435, FunctionCall target_14, ReturnStmt target_15) {
	target_15.getExpr().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
	and target_15.getParent().(IfStmt).getCondition()=target_14
}

predicate func_16(Variable vkbuf_1435, VariableAccess target_35, IfStmt target_16) {
	target_16.getCondition() instanceof NotExpr
	and target_16.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_16.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
	and target_16.getThen().(BlockStmt).getStmt(1) instanceof ReturnStmt
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_35
}

/*predicate func_17(Variable vkbuf_1435, FunctionCall target_36, ExprStmt target_18, FunctionCall target_17) {
	target_17.getTarget().hasName("kfree")
	and target_17.getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
	and target_36.getArgument(0).(VariableAccess).getLocation().isBefore(target_17.getArgument(0).(VariableAccess).getLocation())
	and target_17.getArgument(0).(VariableAccess).getLocation().isBefore(target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
predicate func_18(Variable vkbuf_1435, VariableAccess target_35, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_35
}

predicate func_19(Variable verr_1421, NotExpr target_38, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
	and target_19.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_38
}

predicate func_20(Variable verr_1421, NotExpr target_38, ExprStmt target_19, IfStmt target_20) {
	target_20.getCondition().(VariableAccess).getTarget()=verr_1421
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_38
	and target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_20.getCondition().(VariableAccess).getLocation())
}

predicate func_21(Variable verr_1421, AssignExpr target_21) {
	target_21.getLValue().(VariableAccess).getTarget()=verr_1421
	and target_21.getRValue() instanceof FunctionCall
}

predicate func_22(Variable verr_1421, VariableAccess target_22) {
	target_22.getTarget()=verr_1421
	and target_22.getParent().(IfStmt).getThen() instanceof BreakStmt
}

predicate func_23(VariableAccess target_22, Function func, BreakStmt target_23) {
	target_23.getParent().(IfStmt).getCondition()=target_22
	and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable verr_1421, IfStmt target_24) {
	target_24.getCondition() instanceof EqualityOperation
	and target_24.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
	and target_24.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_24.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=verr_1421
	and target_24.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
	and target_24.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_24.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(VariableAccess).getTarget()=verr_1421
}

/*predicate func_25(Variable verr_1421, AssignExpr target_25) {
	target_25.getLValue().(VariableAccess).getTarget()=verr_1421
	and target_25.getRValue() instanceof FunctionCall
}

*/
/*predicate func_26(Variable verr_1421, EqualityOperation target_3, IfStmt target_26) {
	target_26.getCondition().(VariableAccess).getTarget()=verr_1421
	and target_26.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

*/
predicate func_27(Variable verr_1421, EqualityOperation target_3, ExprStmt target_27) {
	target_27.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
	and target_27.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

/*predicate func_28(Variable verr_1421, EqualityOperation target_3, ExprStmt target_27, NotExpr target_41, IfStmt target_28) {
	target_28.getCondition().(VariableAccess).getTarget()=verr_1421
	and target_28.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_27.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_28.getCondition().(VariableAccess).getLocation())
	and target_28.getCondition().(VariableAccess).getLocation().isBefore(target_41.getOperand().(VariableAccess).getLocation())
}

*/
predicate func_29(Variable verr_1421, VariableAccess target_35, IfStmt target_29) {
	target_29.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=verr_1421
	and target_29.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1421
	and target_29.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_29.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_35
}

/*predicate func_30(Variable verr_1421, AssignExpr target_30) {
	target_30.getLValue().(VariableAccess).getTarget()=verr_1421
	and target_30.getRValue() instanceof FunctionCall
}

*/
predicate func_31(Function func, IfStmt target_31) {
	target_31.getCondition() instanceof FunctionCall
	and target_31.getThen() instanceof ReturnStmt
	and target_31.getEnclosingFunction() = func
}

predicate func_32(Parameter vbuffer_1419, AddressOfExpr target_32) {
	target_32.getOperand().(VariableAccess).getTarget()=vbuffer_1419
}

predicate func_33(Function func, BlockStmt target_33) {
	target_33.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_33.getStmt(1) instanceof ReturnStmt
	and target_33.getEnclosingFunction() = func
}

predicate func_34(Function func, BlockStmt target_34) {
	target_34.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_34.getStmt(1) instanceof IfStmt
	and target_34.getStmt(2) instanceof ExprStmt
	and target_34.getStmt(3) instanceof IfStmt
	and target_34.getEnclosingFunction() = func
}

predicate func_35(Parameter vwrite_1418, BlockStmt target_42, VariableAccess target_35) {
	target_35.getTarget()=vwrite_1418
	and target_35.getParent().(IfStmt).getThen()=target_42
}

predicate func_36(Variable vkbuf_1435, FunctionCall target_36) {
	target_36.getTarget().hasName("PTR_ERR")
	and target_36.getArgument(0).(VariableAccess).getTarget()=vkbuf_1435
}

predicate func_38(Function func, NotExpr target_38) {
	target_38.getOperand().(VariableAccess).getTarget().getType().hasName("bool")
	and target_38.getEnclosingFunction() = func
}

predicate func_41(Variable verr_1421, ExprStmt target_43, NotExpr target_41) {
	target_41.getOperand().(VariableAccess).getTarget()=verr_1421
	and target_41.getParent().(IfStmt).getThen()=target_43
}

predicate func_42(Variable vleft_1423, BlockStmt target_42) {
	target_42.getStmt(2).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vleft_1423
	and target_42.getStmt(2).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(SubExpr).getValue()="4095"
	and target_42.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vleft_1423
	and target_42.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getValue()="4095"
	and target_42.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
	and target_42.getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vleft_1423
}

predicate func_43(Function func, ExprStmt target_43) {
	target_43.getExpr() instanceof AssignExpr
	and target_43.getEnclosingFunction() = func
}

from Function func, Parameter vwrite_1418, Parameter vbuffer_1419, Variable verr_1421, Variable vleft_1423, Variable vbitmap_len_1424, Variable vtmp_bitmap_1426, Variable vkbuf_1435, Variable vp_1435, Variable vbit_a_1519, Variable vbit_b_1519, ExprStmt target_0, NotExpr target_2, EqualityOperation target_3, ReturnStmt target_4, DeclStmt target_5, FunctionCall target_6, FunctionCall target_7, FunctionCall target_8, FunctionCall target_9, FunctionCall target_10, VariableAccess target_11, AssignExpr target_13, FunctionCall target_14, ReturnStmt target_15, IfStmt target_16, ExprStmt target_18, ExprStmt target_19, IfStmt target_20, AssignExpr target_21, VariableAccess target_22, BreakStmt target_23, IfStmt target_24, ExprStmt target_27, IfStmt target_29, IfStmt target_31, AddressOfExpr target_32, BlockStmt target_33, BlockStmt target_34, VariableAccess target_35, FunctionCall target_36, NotExpr target_38, NotExpr target_41, BlockStmt target_42, ExprStmt target_43
where
func_0(vbitmap_len_1424, vtmp_bitmap_1426, target_31, target_0)
and not func_1(vbuffer_1419, target_32)
and func_2(vtmp_bitmap_1426, target_33, target_2)
and func_3(vbit_a_1519, vbit_b_1519, target_34, target_3)
and func_4(target_2, func, target_4)
and func_5(target_35, func, target_5)
and func_6(vbuffer_1419, verr_1421, vleft_1423, target_6)
and func_7(vbuffer_1419, verr_1421, vleft_1423, vbit_a_1519, target_7)
and func_8(vbuffer_1419, verr_1421, vleft_1423, target_8)
and func_9(vbuffer_1419, verr_1421, vleft_1423, vbit_b_1519, target_9)
and func_10(vbuffer_1419, verr_1421, vleft_1423, target_10)
and func_11(vbuffer_1419, target_11)
and func_13(vbuffer_1419, vleft_1423, vkbuf_1435, vp_1435, target_13)
and func_14(vkbuf_1435, target_15, target_14)
and func_15(vkbuf_1435, target_14, target_15)
and func_16(vkbuf_1435, target_35, target_16)
and func_18(vkbuf_1435, target_35, target_18)
and func_19(verr_1421, target_38, target_19)
and func_20(verr_1421, target_38, target_19, target_20)
and func_21(verr_1421, target_21)
and func_22(verr_1421, target_22)
and func_23(target_22, func, target_23)
and func_24(verr_1421, target_24)
and func_27(verr_1421, target_3, target_27)
and func_29(verr_1421, target_35, target_29)
and func_31(func, target_31)
and func_32(vbuffer_1419, target_32)
and func_33(func, target_33)
and func_34(func, target_34)
and func_35(vwrite_1418, target_42, target_35)
and func_36(vkbuf_1435, target_36)
and func_38(func, target_38)
and func_41(verr_1421, target_43, target_41)
and func_42(vleft_1423, target_42)
and func_43(func, target_43)
and vwrite_1418.getType().hasName("int")
and vbuffer_1419.getType().hasName("void *")
and verr_1421.getType().hasName("int")
and vleft_1423.getType().hasName("size_t")
and vbitmap_len_1424.getType().hasName("unsigned long")
and vtmp_bitmap_1426.getType().hasName("unsigned long *")
and vkbuf_1435.getType().hasName("char *")
and vp_1435.getType().hasName("char *")
and vbit_a_1519.getType().hasName("unsigned long")
and vbit_b_1519.getType().hasName("unsigned long")
and vwrite_1418.getFunction() = func
and vbuffer_1419.getFunction() = func
and verr_1421.(LocalVariable).getFunction() = func
and vleft_1423.(LocalVariable).getFunction() = func
and vbitmap_len_1424.(LocalVariable).getFunction() = func
and vtmp_bitmap_1426.(LocalVariable).getFunction() = func
and vkbuf_1435.(LocalVariable).getFunction() = func
and vp_1435.(LocalVariable).getFunction() = func
and vbit_a_1519.(LocalVariable).getFunction() = func
and vbit_b_1519.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
