/**
 * @name linux-ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5-lo_release
 * @id cpp/linux/ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5/lo-release
 * @description linux-ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5-drivers/block/loop.c-lo_release CVE-2018-5344
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vlo_1586, FunctionCall target_0) {
	target_0.getTarget().hasName("blk_mq_freeze_queue")
	and not target_0.getTarget().hasName("__lo_release")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="lo_queue"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
}

predicate func_3(Parameter vdisk_1584, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="private_data"
	and target_3.getQualifier().(VariableAccess).getTarget()=vdisk_1584
}

predicate func_4(FunctionCall target_18, Function func, ReturnStmt target_4) {
	target_4.getParent().(IfStmt).getCondition()=target_18
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Function func, DeclStmt target_6) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vlo_1586, Function func, IfStmt target_7) {
	target_7.getCondition().(FunctionCall).getTarget().hasName("atomic_sub_return")
	and target_7.getCondition().(FunctionCall).getArgument(0).(Literal).getValue()="1"
	and target_7.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lo_refcnt"
	and target_7.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_7.getThen() instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vlo_1586, Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lo_ctl_mutex"
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_8.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_9(Variable vlo_1586, AddressOfExpr target_19, BitwiseAndExpr target_20, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="lo_ctl_mutex"
	and target_9.getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getQualifier().(VariableAccess).getLocation())
	and target_9.getQualifier().(VariableAccess).getLocation().isBefore(target_20.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_10(Variable vlo_1586, Variable verr_1587, Function func, IfStmt target_10) {
	target_10.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="lo_flags"
	and target_10.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1587
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("loop_clr_fd")
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vlo_1586
	and target_10.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=verr_1587
	and target_10.getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="lo_state"
	and target_10.getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_10.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_10.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("blk_mq_unfreeze_queue")
	and target_10.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="lo_queue"
	and target_10.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Variable vlo_1586, Variable verr_1587, AssignExpr target_11) {
	target_11.getLValue().(VariableAccess).getTarget()=verr_1587
	and target_11.getRValue().(FunctionCall).getTarget().hasName("loop_clr_fd")
	and target_11.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vlo_1586
}

*/
/*predicate func_12(Variable verr_1587, BitwiseAndExpr target_20, IfStmt target_12) {
	target_12.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=verr_1587
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
}

*/
/*predicate func_13(EqualityOperation target_21, Function func, ExprStmt target_13) {
	target_13.getExpr() instanceof FunctionCall
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_13.getEnclosingFunction() = func
}

*/
predicate func_14(Variable vlo_1586, EqualityOperation target_21, VariableAccess target_14) {
	target_14.getTarget()=vlo_1586
	and target_14.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getLocation())
}

/*predicate func_15(Variable vlo_1586, FunctionCall target_15) {
	target_15.getTarget().hasName("blk_mq_unfreeze_queue")
	and target_15.getArgument(0).(PointerFieldAccess).getTarget().getName()="lo_queue"
	and target_15.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
}

*/
predicate func_16(Variable vlo_1586, PointerFieldAccess target_16) {
	target_16.getTarget().getName()="lo_ctl_mutex"
	and target_16.getQualifier().(VariableAccess).getTarget()=vlo_1586
}

predicate func_17(Function func, ReturnStmt target_17) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

predicate func_18(Function func, FunctionCall target_18) {
	target_18.getTarget().hasName("atomic_sub_return")
	and target_18.getArgument(0) instanceof Literal
	and target_18.getArgument(1) instanceof AddressOfExpr
	and target_18.getEnclosingFunction() = func
}

predicate func_19(Variable vlo_1586, AddressOfExpr target_19) {
	target_19.getOperand().(PointerFieldAccess).getTarget().getName()="lo_refcnt"
	and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
}

predicate func_20(Variable vlo_1586, BitwiseAndExpr target_20) {
	target_20.getLeftOperand().(PointerFieldAccess).getTarget().getName()="lo_flags"
	and target_20.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_20.getRightOperand() instanceof EnumConstantAccess
}

predicate func_21(Variable vlo_1586, EqualityOperation target_21) {
	target_21.getLeftOperand().(PointerFieldAccess).getTarget().getName()="lo_state"
	and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlo_1586
	and target_21.getRightOperand() instanceof EnumConstantAccess
}

from Function func, Parameter vdisk_1584, Variable vlo_1586, Variable verr_1587, FunctionCall target_0, PointerFieldAccess target_3, ReturnStmt target_4, DeclStmt target_5, DeclStmt target_6, IfStmt target_7, ExprStmt target_8, IfStmt target_10, VariableAccess target_14, PointerFieldAccess target_16, ReturnStmt target_17, FunctionCall target_18, AddressOfExpr target_19, BitwiseAndExpr target_20, EqualityOperation target_21
where
func_0(vlo_1586, target_0)
and func_3(vdisk_1584, target_3)
and func_4(target_18, func, target_4)
and func_5(func, target_5)
and func_6(func, target_6)
and func_7(vlo_1586, func, target_7)
and func_8(vlo_1586, func, target_8)
and func_10(vlo_1586, verr_1587, func, target_10)
and func_14(vlo_1586, target_21, target_14)
and func_16(vlo_1586, target_16)
and func_17(func, target_17)
and func_18(func, target_18)
and func_19(vlo_1586, target_19)
and func_20(vlo_1586, target_20)
and func_21(vlo_1586, target_21)
and vdisk_1584.getType().hasName("gendisk *")
and vlo_1586.getType().hasName("loop_device *")
and verr_1587.getType().hasName("int")
and vdisk_1584.getFunction() = func
and vlo_1586.(LocalVariable).getFunction() = func
and verr_1587.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
