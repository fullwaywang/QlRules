/**
 * @name linux-051ae669e4505abbe05165bebf6be7922de11f41-wilc_wfi_cfg_parse_ch_attr
 * @id cpp/linux/051ae669e4505abbe05165bebf6be7922de11f41/wilc-wfi-cfg-parse-ch-attr
 * @description linux-051ae669e4505abbe05165bebf6be7922de11f41-wilc_wfi_cfg_parse_ch_attr CVE-2022-47519
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable ve_951, EqualityOperation target_8) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("u16")
		and target_0.getRValue().(PointerFieldAccess).getTarget().getName()="attr_len"
		and target_0.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
		and target_8.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vlen_949, Variable vindex_954, ExprStmt target_10, RelationalOperation target_11, ExprStmt target_12) {
	exists(RelationalOperation target_1 |
		 (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
		and target_1.getGreaterOperand().(AddExpr).getAnOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vindex_954
		and target_1.getGreaterOperand().(AddExpr).getAnOperand().(AddExpr).getAnOperand().(SizeofExprOperator).getValue()="3"
		and target_1.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getType().hasName("u16")
		and target_1.getLesserOperand().(VariableAccess).getTarget()=vlen_949
		and target_1.getParent().(IfStmt).getThen()=target_10
		and target_11.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_1.getLesserOperand().(VariableAccess).getLocation())
		and target_12.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_1.getGreaterOperand().(AddExpr).getAnOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_2(EqualityOperation target_7, Function func) {
	exists(ReturnStmt target_2 |
		target_2.getParent().(IfStmt).getCondition()=target_7
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vindex_954, Variable vch_list_idx_955, Variable vop_ch_idx_956, ExprStmt target_13, LogicalAndExpr target_15) {
	exists(IfStmt target_3 |
		target_3.getCondition() instanceof EqualityOperation
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vch_list_idx_955
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
		and target_3.getElse().(IfStmt).getCondition().(LogicalAndExpr).getAnOperand() instanceof EqualityOperation
		and target_3.getElse().(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("u16")
		and target_3.getElse().(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(SubExpr).getValue()="5"
		and target_3.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vop_ch_idx_956
		and target_3.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_15.getAnOperand().(VariableAccess).getLocation()))
}

/*predicate func_4(ExprStmt target_17, Function func) {
	exists(LogicalAndExpr target_4 |
		target_4.getAnOperand() instanceof EqualityOperation
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("u16")
		and target_4.getAnOperand().(EqualityOperation).getAnOperand().(SubExpr).getValue()="5"
		and target_4.getParent().(IfStmt).getThen()=target_17
		and target_4.getEnclosingFunction() = func)
}

*/
predicate func_5(Variable vindex_954, ExprStmt target_17) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vindex_954
		and target_5.getExpr().(AssignAddExpr).getRValue().(AddExpr).getAnOperand().(SizeofExprOperator).getValue()="3"
		and target_5.getExpr().(AssignAddExpr).getRValue().(AddExpr).getAnOperand().(VariableAccess).getType().hasName("u16")
		and target_17.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_7(Variable ve_951, ExprStmt target_10, EqualityOperation target_7) {
		target_7.getAnOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
		and target_7.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
		and target_7.getParent().(IfStmt).getThen()=target_10
}

predicate func_8(Variable ve_951, ExprStmt target_17, EqualityOperation target_8) {
		target_8.getAnOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
		and target_8.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
		and target_8.getParent().(IfStmt).getThen()=target_17
}

predicate func_9(Variable ve_951, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="attr_len"
		and target_9.getQualifier().(VariableAccess).getTarget()=ve_951
}

predicate func_10(Variable vindex_954, Variable vch_list_idx_955, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vch_list_idx_955
		and target_10.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
}

predicate func_11(Parameter vlen_949, Variable vindex_954, RelationalOperation target_11) {
		 (target_11 instanceof GEExpr or target_11 instanceof LEExpr)
		and target_11.getLesserOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vindex_954
		and target_11.getLesserOperand().(AddExpr).getAnOperand().(SizeofExprOperator).getValue()="3"
		and target_11.getGreaterOperand().(VariableAccess).getTarget()=vlen_949
}

predicate func_12(Variable ve_951, Variable vindex_954, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_951
		and target_12.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
		and target_12.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vindex_954
}

predicate func_13(Variable ve_951, Variable vindex_954, ExprStmt target_13) {
		target_13.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vindex_954
		and target_13.getExpr().(AssignAddExpr).getRValue().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="attr_len"
		and target_13.getExpr().(AssignAddExpr).getRValue().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
		and target_13.getExpr().(AssignAddExpr).getRValue().(AddExpr).getAnOperand().(SizeofExprOperator).getValue()="3"
}

predicate func_15(Variable vch_list_idx_955, Variable vop_ch_idx_956, LogicalAndExpr target_15) {
		target_15.getAnOperand().(VariableAccess).getTarget()=vch_list_idx_955
		and target_15.getAnOperand().(VariableAccess).getTarget()=vop_ch_idx_956
}

predicate func_17(Variable vindex_954, Variable vop_ch_idx_956, ExprStmt target_17) {
		target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vop_ch_idx_956
		and target_17.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vindex_954
}

from Function func, Parameter vlen_949, Variable ve_951, Variable vindex_954, Variable vch_list_idx_955, Variable vop_ch_idx_956, EqualityOperation target_7, EqualityOperation target_8, PointerFieldAccess target_9, ExprStmt target_10, RelationalOperation target_11, ExprStmt target_12, ExprStmt target_13, LogicalAndExpr target_15, ExprStmt target_17
where
not func_0(ve_951, target_8)
and not func_1(vlen_949, vindex_954, target_10, target_11, target_12)
and not func_2(target_7, func)
and not func_3(vindex_954, vch_list_idx_955, vop_ch_idx_956, target_13, target_15)
and not func_5(vindex_954, target_17)
and func_7(ve_951, target_10, target_7)
and func_8(ve_951, target_17, target_8)
and func_9(ve_951, target_9)
and func_10(vindex_954, vch_list_idx_955, target_10)
and func_11(vlen_949, vindex_954, target_11)
and func_12(ve_951, vindex_954, target_12)
and func_13(ve_951, vindex_954, target_13)
and func_15(vch_list_idx_955, vop_ch_idx_956, target_15)
and func_17(vindex_954, vop_ch_idx_956, target_17)
and vlen_949.getType().hasName("u32")
and ve_951.getType().hasName("wilc_attr_entry *")
and vindex_954.getType().hasName("u32")
and vch_list_idx_955.getType().hasName("u8")
and vop_ch_idx_956.getType().hasName("u8")
and vlen_949.getFunction() = func
and ve_951.(LocalVariable).getFunction() = func
and vindex_954.(LocalVariable).getFunction() = func
and vch_list_idx_955.(LocalVariable).getFunction() = func
and vop_ch_idx_956.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
