/**
 * @name linux-f78c1375339a291cba492a70eaf12ec501d28a8e-nl80211_set_interface
 * @id cpp/linux/f78c1375339a291cba492a70eaf12ec501d28a8e/nl80211-set-interface
 * @description linux-f78c1375339a291cba492a70eaf12ec501d28a8e-net/wireless/nl80211.c-nl80211_set_interface CVE-2024-27410
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable votype_4181, ArrayExpr target_1, EqualityOperation target_2) {
exists(IfStmt target_0 |
	target_0.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=votype_4181
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
	and target_2.getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_1(BlockStmt target_3, Function func, ArrayExpr target_1) {
	target_1.getArrayBase().(PointerFieldAccess).getTarget().getName()="attrs"
	and target_1.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("genl_info *")
	and target_1.getParent().(IfStmt).getThen()=target_3
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable votype_4181, EqualityOperation target_2) {
	target_2.getLeftOperand().(VariableAccess).getTarget()=votype_4181
	and target_2.getRightOperand().(VariableAccess).getTarget().getType().hasName("nl80211_iftype")
}

predicate func_3(Function func, BlockStmt target_3) {
	target_3.getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("nl80211_iftype")
	and target_3.getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_3.getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("netif_running")
	and target_3.getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net_device *")
	and target_3.getStmt(2).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-16"
	and target_3.getEnclosingFunction() = func
}

from Function func, Variable votype_4181, ArrayExpr target_1, EqualityOperation target_2, BlockStmt target_3
where
not func_0(votype_4181, target_1, target_2)
and func_1(target_3, func, target_1)
and func_2(votype_4181, target_2)
and func_3(func, target_3)
and votype_4181.getType().hasName("nl80211_iftype")
and votype_4181.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
