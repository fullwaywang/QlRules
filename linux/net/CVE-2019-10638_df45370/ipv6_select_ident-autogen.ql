/**
 * @name linux-df453700e8d81b1bdafdf684365ee2b9431fb702-ipv6_select_ident
 * @id cpp/linux/df453700e8d81b1bdafdf684365ee2b9431fb702/ipv6-select-ident
 * @description linux-df453700e8d81b1bdafdf684365ee2b9431fb702-net/ipv6/output_core.c-ipv6_select_ident CVE-2019-10638
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, DeclStmt target_0) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

predicate func_1(Variable v___ret_72, StmtExpr target_1) {
		target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v___ret_72
		and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__do_once_start")
		and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_1.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getTarget()=v___ret_72
}

/*predicate func_5(Variable v___ret_72, Variable v___done_72, Variable vbranch_72, Variable v___flags_72, IfStmt target_5) {
		target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BuiltInOperation).getValue()="1"
		and target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_72
		and target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
		and target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(BuiltInOperation).getValue()="0"
		and target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_5.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v___ret_72
		and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__do_once_start")
		and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___done_72
		and target_5.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___flags_72
		and target_5.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_5.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v___ret_72
		and target_5.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_5.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_random_bytes")
		and target_5.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__do_once_done")
}

*/
/*predicate func_7(Variable vbranch_72, IfStmt target_7) {
		target_7.getCondition().(BuiltInOperation).getValue()="1"
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_72
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
		and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="key"
		and target_7.getElse().(IfStmt).getCondition().(BuiltInOperation).getValue()="0"
		and target_7.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_72
		and target_7.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
		and target_7.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="key"
		and target_7.getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbranch_72
		and target_7.getElse().(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("____wrong_branch_error")
}

*/
/*predicate func_8(Variable vbranch_72, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_8.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vbranch_72
		and target_8.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

*/
predicate func_9(StmtExpr target_17, Function func, DeclStmt target_9) {
		target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
		and target_9.getEnclosingFunction() = func
}

/*predicate func_10(Variable v___ret_72, Variable v___done_72, Variable v___flags_72, StmtExpr target_17, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v___ret_72
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__do_once_start")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___done_72
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___flags_72
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_11(Variable vip6_idents_hashrnd_69, Variable v___ret_72, Variable v___done_72, Variable v___once_key_72, Variable v___flags_72, StmtExpr target_17, IfStmt target_11) {
		target_11.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_11.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v___ret_72
		and target_11.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_random_bytes")
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vip6_idents_hashrnd_69
		and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(SizeofExprOperator).getValue()="4"
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__do_once_done")
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___done_72
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___once_key_72
		and target_11.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___flags_72
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_12(Variable vip6_idents_hashrnd_69, FunctionCall target_18, ExprStmt target_12) {
		target_12.getExpr().(FunctionCall).getTarget().hasName("get_random_bytes")
		and target_12.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vip6_idents_hashrnd_69
		and target_12.getExpr().(FunctionCall).getArgument(1).(SizeofExprOperator).getValue()="4"
		and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
}

*/
/*predicate func_13(Variable v___done_72, Variable v___once_key_72, Variable v___flags_72, FunctionCall target_18, ExprStmt target_13) {
		target_13.getExpr().(FunctionCall).getTarget().hasName("__do_once_done")
		and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___done_72
		and target_13.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___once_key_72
		and target_13.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v___flags_72
		and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
}

*/
/*predicate func_14(Variable v___ret_72, ExprStmt target_14) {
		target_14.getExpr().(VariableAccess).getTarget()=v___ret_72
}

*/
predicate func_15(Parameter vnet_65, Parameter vdaddr_66, Parameter vsaddr_67, Variable vip6_idents_hashrnd_69, Variable vid_70, Function func, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_70
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__ipv6_select_ident")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_65
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vip6_idents_hashrnd_69
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdaddr_66
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vsaddr_67
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

/*predicate func_16(Parameter vnet_65, Parameter vdaddr_66, Parameter vsaddr_67, Variable vip6_idents_hashrnd_69, VariableAccess target_16) {
		target_16.getTarget()=vip6_idents_hashrnd_69
		and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__ipv6_select_ident")
		and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_65
		and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdaddr_66
		and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vsaddr_67
}

*/
predicate func_17(Function func, StmtExpr target_17) {
		target_17.getStmt() instanceof BlockStmt
		and target_17.getEnclosingFunction() = func
}

predicate func_18(Function func, FunctionCall target_18) {
		target_18.getTarget().hasName("__builtin_expect")
		and target_18.getArgument(0) instanceof NotExpr
		and target_18.getArgument(1) instanceof Literal
		and target_18.getEnclosingFunction() = func
}

from Function func, Parameter vnet_65, Parameter vdaddr_66, Parameter vsaddr_67, Variable vip6_idents_hashrnd_69, Variable vid_70, Variable v___ret_72, Variable v___done_72, Variable v___once_key_72, Variable vbranch_72, Variable v___flags_72, DeclStmt target_0, StmtExpr target_1, DeclStmt target_9, ExprStmt target_15, StmtExpr target_17, FunctionCall target_18
where
func_0(func, target_0)
and func_1(v___ret_72, target_1)
and func_9(target_17, func, target_9)
and func_15(vnet_65, vdaddr_66, vsaddr_67, vip6_idents_hashrnd_69, vid_70, func, target_15)
and func_17(func, target_17)
and func_18(func, target_18)
and vnet_65.getType().hasName("net *")
and vdaddr_66.getType().hasName("const in6_addr *")
and vsaddr_67.getType().hasName("const in6_addr *")
and vip6_idents_hashrnd_69.getType().hasName("u32")
and vid_70.getType().hasName("u32")
and v___ret_72.getType().hasName("bool")
and v___done_72.getType().hasName("bool")
and v___once_key_72.getType().hasName("static_key_true")
and vbranch_72.getType().hasName("bool")
and v___flags_72.getType().hasName("unsigned long")
and vnet_65.getFunction() = func
and vdaddr_66.getFunction() = func
and vsaddr_67.getFunction() = func
and vip6_idents_hashrnd_69.(LocalVariable).getFunction() = func
and vid_70.(LocalVariable).getFunction() = func
and v___ret_72.(LocalVariable).getFunction() = func
and v___done_72.(LocalVariable).getFunction() = func
and v___once_key_72.(LocalVariable).getFunction() = func
and vbranch_72.(LocalVariable).getFunction() = func
and v___flags_72.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
