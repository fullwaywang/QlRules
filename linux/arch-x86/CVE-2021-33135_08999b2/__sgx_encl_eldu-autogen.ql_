/**
 * @name linux-08999b2489b4c9b939d7483dbd03702ee4576d96-__sgx_encl_eldu
 * @id cpp/linux/08999b2489b4c9b939d7483dbd03702ee4576d96/--sgx-encl-eldu
 * @description linux-08999b2489b4c9b939d7483dbd03702ee4576d96-arch/x86/kernel/cpu/sgx/encl.c-__sgx_encl_eldu CVE-2021-33135
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vencl_24, ExprStmt target_16, ExprStmt target_17, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sgx_encl_get_backing_page_pcmd_offset")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vencl_24
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_16.getLocation())
	and target_17.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("u8 *")
	and target_2.getRValue() instanceof FunctionCall
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vpginfo_25, Variable vb_26, IfStmt target_18, ExprStmt target_19, ExprStmt target_20, ValueFieldAccess target_21, SubExpr target_15, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="metadata"
	and target_3.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_3.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(VariableAccess).getType().hasName("u8 *")
	and target_3.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="pcmd_offset"
	and target_3.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_26
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_18.getLocation())
	and target_19.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_21.getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(DoStmt target_22, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("__memset")
	and target_5.getExpr().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("u8 *")
	and target_5.getExpr().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand() instanceof ValueFieldAccess
	and target_5.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_5.getExpr().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getExpr().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="128"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_22.getLocation()))
}

predicate func_6(DoStmt target_22, Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_6.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("memchr_inv")
	and target_6.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("u8 *")
	and target_6.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_6.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getValue()="4096"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getLocation().isBefore(target_22.getLocation()))
}

predicate func_7(DoStmt target_11, Function func) {
exists(DoStmt target_7 |
	target_7.getCondition().(Literal).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_7.getLocation().isBefore(target_11.getLocation())
	and target_7.getEnclosingFunction() = func)
}

predicate func_9(Variable vencl_24, ExprStmt target_16, Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("sgx_encl_truncate_backing_page")
	and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vencl_24
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getFollowingStmt() instanceof ReturnStmt
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_10(Variable vencl_24, Function func) {
exists(IfStmt target_10 |
	target_10.getCondition().(VariableAccess).getType().hasName("bool")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sgx_encl_truncate_backing_page")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vencl_24
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_11(Function func, DoStmt target_11) {
	target_11.getCondition().(Literal).getValue()="0"
	and target_11.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vb_26, FunctionCall target_12) {
	target_12.getTarget().hasName("kmap_atomic")
	and target_12.getArgument(0).(ValueFieldAccess).getTarget().getName()="pcmd"
	and target_12.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_26
}

predicate func_13(Variable vb_26, ValueFieldAccess target_13) {
	target_13.getTarget().getName()="pcmd_offset"
	and target_13.getQualifier().(VariableAccess).getTarget()=vb_26
}

predicate func_15(Variable vpginfo_25, SubExpr target_15) {
	target_15.getLeftOperand().(ValueFieldAccess).getTarget().getName()="metadata"
	and target_15.getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_15.getRightOperand() instanceof ValueFieldAccess
	and target_15.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__kunmap_atomic")
}

predicate func_16(Variable vencl_24, Variable vb_26, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sgx_encl_get_backing")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vencl_24
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_16.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vb_26
}

predicate func_17(Variable vencl_24, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_17.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="size"
	and target_17.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vencl_24
	and target_17.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
}

predicate func_18(Variable vpginfo_25, IfStmt target_18) {
	target_18.getCondition().(VariableAccess).getTarget().getType().hasName("sgx_epc_page *")
	and target_18.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="secs"
	and target_18.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_18.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sgx_get_epc_virt_addr")
	and target_18.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sgx_epc_page *")
	and target_18.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="secs"
	and target_18.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_18.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_19(Variable vpginfo_25, Variable vb_26, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="contents"
	and target_19.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmap_atomic")
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="contents"
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_26
}

predicate func_20(Variable vpginfo_25, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="secs"
	and target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vpginfo_25
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sgx_get_epc_virt_addr")
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sgx_epc_page *")
}

predicate func_21(Variable vb_26, ValueFieldAccess target_21) {
	target_21.getTarget().getName()="pcmd"
	and target_21.getQualifier().(VariableAccess).getTarget()=vb_26
}

predicate func_22(Function func, DoStmt target_22) {
	target_22.getCondition().(Literal).getValue()="0"
	and target_22.getStmt().(BlockStmt).getStmt(0) instanceof DoStmt
	and target_22.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__kunmap_atomic")
	and target_22.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof SubExpr
	and target_22.getEnclosingFunction() = func
}

from Function func, Variable vencl_24, Variable vpginfo_25, Variable vb_26, DoStmt target_11, FunctionCall target_12, ValueFieldAccess target_13, SubExpr target_15, ExprStmt target_16, ExprStmt target_17, IfStmt target_18, ExprStmt target_19, ExprStmt target_20, ValueFieldAccess target_21, DoStmt target_22
where
not func_1(vencl_24, target_16, target_17, func)
and not func_2(func)
and not func_3(vpginfo_25, vb_26, target_18, target_19, target_20, target_21, target_15, func)
and not func_5(target_22, func)
and not func_6(target_22, func)
and not func_7(target_11, func)
and not func_9(vencl_24, target_16, func)
and not func_10(vencl_24, func)
and func_11(func, target_11)
and func_12(vb_26, target_12)
and func_13(vb_26, target_13)
and func_15(vpginfo_25, target_15)
and func_16(vencl_24, vb_26, target_16)
and func_17(vencl_24, target_17)
and func_18(vpginfo_25, target_18)
and func_19(vpginfo_25, vb_26, target_19)
and func_20(vpginfo_25, target_20)
and func_21(vb_26, target_21)
and func_22(func, target_22)
and vencl_24.getType().hasName("sgx_encl *")
and vpginfo_25.getType().hasName("sgx_pageinfo")
and vb_26.getType().hasName("sgx_backing")
and vencl_24.(LocalVariable).getFunction() = func
and vpginfo_25.(LocalVariable).getFunction() = func
and vb_26.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
