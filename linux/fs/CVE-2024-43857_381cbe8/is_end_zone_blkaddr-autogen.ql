/**
 * @name linux-381cbe85592c78fbaeb3e770e3e9f3bfa3e67efb-is_end_zone_blkaddr
 * @id cpp/linux/381cbe85592c78fbaeb3e770e3e9f3bfa3e67efb/is-end-zone-blkaddr
 * @description linux-381cbe85592c78fbaeb3e770e3e9f3bfa3e67efb-fs/f2fs/data.c-is_end_zone_blkaddr CVE-2024-43857
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(FunctionCall target_3, Function func) {
exists(ExprStmt target_0 |
	exists(AssignExpr obj_0 | obj_0=target_0.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("block_device *")
		and obj_0.getRValue() instanceof ValueFieldAccess
	)
	and exists(BlockStmt obj_1 | obj_1=target_0.getParent() |
		exists(IfStmt obj_2 | obj_2=obj_1.getParent() |
			obj_2.getThen().(BlockStmt).getStmt(3)=target_0
			and obj_2.getCondition()=target_3
		)
	)
	and target_0.getEnclosingFunction() = func
)
}

predicate func_2(Parameter vsbi_926, Variable vdevi_928, ValueFieldAccess target_2) {
	exists(ArrayExpr obj_0 | obj_0=target_2.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getArrayBase() |
			obj_1.getTarget().getName()="devs"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vsbi_926
		)
		and obj_0.getArrayOffset().(VariableAccess).getTarget()=vdevi_928
	)
	and target_2.getTarget().getName()="bdev"
}

predicate func_3(Parameter vsbi_926, FunctionCall target_3) {
	target_3.getTarget().hasName("f2fs_is_multi_device")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vsbi_926
}

from Function func, Parameter vsbi_926, Variable vdevi_928, ValueFieldAccess target_2, FunctionCall target_3
where
not func_0(target_3, func)
and func_2(vsbi_926, vdevi_928, target_2)
and func_3(vsbi_926, target_3)
and vsbi_926.getType().hasName("f2fs_sb_info *")
and vdevi_928.getType().hasName("int")
and vsbi_926.getFunction() = func
and vdevi_928.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
