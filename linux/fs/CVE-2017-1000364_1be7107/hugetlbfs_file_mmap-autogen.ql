/**
 * @name linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-hugetlbfs_file_mmap
 * @id cpp/linux/1be7107fbe18eed3e319a6c3e83c78254b693acb/hugetlbfs-file-mmap
 * @description linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-fs/hugetlbfs/inode.c-hugetlbfs_file_mmap CVE-2017-1000364
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvma_121, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="vm_pgoff"
	and target_0.getQualifier().(VariableAccess).getTarget()=vvma_121
}

predicate func_1(Parameter vvma_121, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="vm_pgoff"
	and target_1.getQualifier().(VariableAccess).getTarget()=vvma_121
}

predicate func_2(Parameter vvma_121, ExprStmt target_32, ExprStmt target_15) {
exists(RelationalOperation target_2 |
	 (target_2 instanceof GEExpr or target_2 instanceof LEExpr)
	and target_2.getLesserOperand().(PointerFieldAccess).getTarget().getName()="vm_start"
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_2.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="start_stack"
	and target_2.getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vm_mm"
	and target_2.getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_2.getParent().(LogicalAndExpr).getLeftOperand() instanceof BitwiseAndExpr
	and target_2.getParent().(LogicalAndExpr).getRightOperand() instanceof RelationalOperation
	and target_2.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_32
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_3(Parameter vvma_121, ExprStmt target_15) {
exists(PointerFieldAccess target_3 |
	target_3.getTarget().getName()="vm_mm"
	and target_3.getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_3.getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_4(Parameter vvma_121, ExprStmt target_32) {
exists(RelationalOperation target_4 |
	 (target_4 instanceof GEExpr or target_4 instanceof LEExpr)
	and target_4.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="vm_end"
	and target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_4.getLesserOperand().(PointerFieldAccess).getTarget().getName()="start_stack"
	and target_4.getLesserOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vm_mm"
	and target_4.getLesserOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_4.getParent().(LogicalAndExpr).getLeftOperand() instanceof BitwiseAndExpr
	and target_4.getParent().(LogicalAndExpr).getRightOperand() instanceof RelationalOperation
	and target_4.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_32)
}

/*predicate func_5(Parameter vvma_121) {
exists(PointerFieldAccess target_5 |
	target_5.getTarget().getName()="vm_mm"
	and target_5.getQualifier().(VariableAccess).getTarget()=vvma_121)
}

*/
predicate func_6(Parameter vvma_121, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="vm_end"
	and target_6.getQualifier().(VariableAccess).getTarget()=vvma_121
}

predicate func_7(Parameter vvma_121, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="vm_start"
	and target_7.getQualifier().(VariableAccess).getTarget()=vvma_121
}

predicate func_8(Parameter vvma_121, VariableAccess target_8) {
	target_8.getTarget()=vvma_121
}

predicate func_9(Parameter vvma_121, VariableAccess target_9) {
	target_9.getTarget()=vvma_121
}

predicate func_10(Function func, DeclStmt target_10) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Function func, DeclStmt target_11) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Function func, DeclStmt target_12) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Function func, DeclStmt target_13) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Parameter vvma_121, Function func, ExprStmt target_14) {
	target_14.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_14.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_14.getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="4456448"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Variable vhugetlb_vm_ops, Parameter vvma_121, Function func, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="vm_ops"
	and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_15.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhugetlb_vm_ops
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Parameter vvma_121, Function func, IfStmt target_16) {
	target_16.getCondition().(RelationalOperation).getLesserOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
	and target_16.getCondition().(RelationalOperation).getLesserOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_16.getCondition().(RelationalOperation).getLesserOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
	and target_16.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_16.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

/*predicate func_17(Function func, UnaryMinusExpr target_17) {
	target_17.getValue()="-22"
	and target_17.getEnclosingFunction() = func
}

*/
predicate func_18(Variable vh_126, Parameter vvma_121, Function func, IfStmt target_18) {
	target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
	and target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_18.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(ComplementExpr).getOperand().(FunctionCall).getTarget().hasName("huge_page_mask")
	and target_18.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(ComplementExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vh_126
	and target_18.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
	and target_18.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

predicate func_19(Parameter vvma_121, Variable vvma_len_124, Function func, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvma_len_124
	and target_19.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_end"
	and target_19.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_19.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="vm_start"
	and target_19.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Parameter vvma_121, Variable vlen_124, Variable vvma_len_124, Function func, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_124
	and target_20.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vvma_len_124
	and target_20.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
	and target_20.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_20.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

predicate func_21(Variable vlen_124, Variable vvma_len_124, Function func, IfStmt target_21) {
	target_21.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vlen_124
	and target_21.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vvma_len_124
	and target_21.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_22(Variable vinode_123, Function func, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("inode_lock")
	and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_123
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

predicate func_23(Parameter vfile_121, Function func, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("file_accessed")
	and target_23.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfile_121
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_23
}

predicate func_24(Variable vret_125, Function func, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_125
	and target_24.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_24
}

predicate func_25(Variable vh_126, Parameter vvma_121, Variable vinode_123, Variable vlen_124, Function func, IfStmt target_25) {
	target_25.getCondition().(FunctionCall).getTarget().hasName("hugetlb_reserve_pages")
	and target_25.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_123
	and target_25.getCondition().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
	and target_25.getCondition().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_25.getCondition().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getRightOperand().(FunctionCall).getTarget().hasName("huge_page_order")
	and target_25.getCondition().(FunctionCall).getArgument(1).(BinaryBitwiseOperation).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vh_126
	and target_25.getCondition().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vlen_124
	and target_25.getCondition().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getRightOperand().(FunctionCall).getTarget().hasName("huge_page_shift")
	and target_25.getCondition().(FunctionCall).getArgument(2).(BinaryBitwiseOperation).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vh_126
	and target_25.getCondition().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vvma_121
	and target_25.getCondition().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_25.getCondition().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_25.getThen().(GotoStmt).getName() ="out"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_25
}

predicate func_26(Variable vret_125, Function func, ExprStmt target_26) {
	target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_125
	and target_26.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_26
}

predicate func_27(Parameter vvma_121, Variable vinode_123, Variable vlen_124, Function func, IfStmt target_27) {
	target_27.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_27.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_27.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2"
	and target_27.getCondition().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="i_size"
	and target_27.getCondition().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_123
	and target_27.getCondition().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_124
	and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("i_size_write")
	and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_123
	and target_27.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlen_124
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_27
}

/*predicate func_28(Parameter vvma_121, Variable vinode_123, Variable vlen_124, ExprStmt target_32, BitwiseAndExpr target_28) {
	target_28.getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_28.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_28.getRightOperand().(Literal).getValue()="2"
	and target_28.getParent().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="i_size"
	and target_28.getParent().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_123
	and target_28.getParent().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_124
	and target_28.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_32
}

*/
/*predicate func_29(Parameter vvma_121, Variable vinode_123, Variable vlen_124, ExprStmt target_32, RelationalOperation target_29) {
	 (target_29 instanceof GTExpr or target_29 instanceof LTExpr)
	and target_29.getLesserOperand().(PointerFieldAccess).getTarget().getName()="i_size"
	and target_29.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_123
	and target_29.getGreaterOperand().(VariableAccess).getTarget()=vlen_124
	and target_29.getParent().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_29.getParent().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_121
	and target_29.getParent().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2"
	and target_29.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_32
}

*/
predicate func_30(Variable vinode_123, Function func, ExprStmt target_30) {
	target_30.getExpr().(FunctionCall).getTarget().hasName("inode_unlock")
	and target_30.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_123
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_30
}

predicate func_31(Variable vret_125, Function func, ReturnStmt target_31) {
	target_31.getExpr().(VariableAccess).getTarget()=vret_125
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_31
}

predicate func_32(Function func, ExprStmt target_32) {
	target_32.getExpr() instanceof FunctionCall
	and target_32.getEnclosingFunction() = func
}

from Function func, Variable vret_125, Variable vh_126, Variable vhugetlb_vm_ops, Parameter vfile_121, Parameter vvma_121, Variable vinode_123, Variable vlen_124, Variable vvma_len_124, PointerFieldAccess target_0, PointerFieldAccess target_1, PointerFieldAccess target_6, PointerFieldAccess target_7, VariableAccess target_8, VariableAccess target_9, DeclStmt target_10, DeclStmt target_11, DeclStmt target_12, DeclStmt target_13, ExprStmt target_14, ExprStmt target_15, IfStmt target_16, IfStmt target_18, ExprStmt target_19, ExprStmt target_20, IfStmt target_21, ExprStmt target_22, ExprStmt target_23, ExprStmt target_24, IfStmt target_25, ExprStmt target_26, IfStmt target_27, ExprStmt target_30, ReturnStmt target_31, ExprStmt target_32
where
func_0(vvma_121, target_0)
and func_1(vvma_121, target_1)
and not func_2(vvma_121, target_32, target_15)
and not func_4(vvma_121, target_32)
and func_6(vvma_121, target_6)
and func_7(vvma_121, target_7)
and func_8(vvma_121, target_8)
and func_9(vvma_121, target_9)
and func_10(func, target_10)
and func_11(func, target_11)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(vvma_121, func, target_14)
and func_15(vhugetlb_vm_ops, vvma_121, func, target_15)
and func_16(vvma_121, func, target_16)
and func_18(vh_126, vvma_121, func, target_18)
and func_19(vvma_121, vvma_len_124, func, target_19)
and func_20(vvma_121, vlen_124, vvma_len_124, func, target_20)
and func_21(vlen_124, vvma_len_124, func, target_21)
and func_22(vinode_123, func, target_22)
and func_23(vfile_121, func, target_23)
and func_24(vret_125, func, target_24)
and func_25(vh_126, vvma_121, vinode_123, vlen_124, func, target_25)
and func_26(vret_125, func, target_26)
and func_27(vvma_121, vinode_123, vlen_124, func, target_27)
and func_30(vinode_123, func, target_30)
and func_31(vret_125, func, target_31)
and func_32(func, target_32)
and vret_125.getType().hasName("int")
and vh_126.getType().hasName("hstate *")
and vhugetlb_vm_ops.getType().hasName("const vm_operations_struct")
and vfile_121.getType().hasName("file *")
and vvma_121.getType().hasName("vm_area_struct *")
and vinode_123.getType().hasName("inode *")
and vlen_124.getType().hasName("loff_t")
and vvma_len_124.getType().hasName("loff_t")
and vret_125.(LocalVariable).getFunction() = func
and vh_126.(LocalVariable).getFunction() = func
and not vhugetlb_vm_ops.getParentScope+() = func
and vfile_121.getFunction() = func
and vvma_121.getFunction() = func
and vinode_123.(LocalVariable).getFunction() = func
and vlen_124.(LocalVariable).getFunction() = func
and vvma_len_124.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
