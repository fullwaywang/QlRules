/**
 * @name linux-6022f210461fef67e6e676fd8544ca02d1bcfa7a-stex_queuecommand_lck
 * @id cpp/linux/6022f210461fef67e6e676fd8544ca02d1bcfa7a/stex-queuecommand-lck
 * @description linux-6022f210461fef67e6e676fd8544ca02d1bcfa7a-stex_queuecommand_lck CVE-2022-40768
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vhost_597, SubExpr target_1) {
		target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="max_id"
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhost_597
		and target_1.getRightOperand().(Literal).getValue()="1"
		and target_1.getParent().(AssignExpr).getRValue() = target_1
		and target_1.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_2(Variable vhba_596, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="host_no"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="host"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhba_596
		and target_2.getParent().(AssignExpr).getRValue() = target_2
		and target_2.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_9(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="major"
		and target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_9.getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_10(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="minor"
		and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_10.getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_11(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="oem"
		and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_11.getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_12(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="build"
		and target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_12.getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_13(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="signature"
		and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
		and target_13.getExpr().(AssignExpr).getRValue() instanceof EnumConstantAccess
		and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_14(Variable vver_1_668, EqualityOperation target_16, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="console_id"
		and target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_14.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_15(Variable vhba_596, Variable vver_1_668, EqualityOperation target_16, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="host_no"
		and target_15.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vver_1_668
		and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="host_no"
		and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="host"
		and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhba_596
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_16(Function func, EqualityOperation target_16) {
		target_16.getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="cmnd"
		and target_16.getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("scsi_cmnd *")
		and target_16.getAnOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
		and target_16.getEnclosingFunction() = func
}

from Function func, Variable vhba_596, Variable vhost_597, Variable vver_1_668, SubExpr target_1, PointerFieldAccess target_2, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, ExprStmt target_12, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, EqualityOperation target_16
where
func_1(vhost_597, target_1)
and func_2(vhba_596, target_2)
and func_9(vver_1_668, target_16, target_9)
and func_10(vver_1_668, target_16, target_10)
and func_11(vver_1_668, target_16, target_11)
and func_12(vver_1_668, target_16, target_12)
and func_13(vver_1_668, target_16, target_13)
and func_14(vver_1_668, target_16, target_14)
and func_15(vhba_596, vver_1_668, target_16, target_15)
and func_16(func, target_16)
and vhba_596.getType().hasName("st_hba *")
and vhost_597.getType().hasName("Scsi_Host *")
and vver_1_668.getType().hasName("st_drvver")
and vhba_596.(LocalVariable).getFunction() = func
and vhost_597.(LocalVariable).getFunction() = func
and vver_1_668.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
