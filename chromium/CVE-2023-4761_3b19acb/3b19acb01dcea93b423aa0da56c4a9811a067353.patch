commit 3b19acb01dcea93b423aa0da56c4a9811a067353	3b19acb01dcea93b423aa0da56c4a9811a067353
Author: Yi Gu <yigu@chromium.org>
Date:   Wed Aug 30 00:25:12 2023 +0000

    [FedCM] ReportBadMessage when the provider list is empty
    
    The provider list should not be empty unless the API is called from a
    compromised renderer.
    
    Change-Id: I3e497fae2343342b3ec6b17bd663f2ec1bf12d54
    Bug: 1476403
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4822925
    Reviewed-by: Nicolás Peña <npm@chromium.org>
    Commit-Queue: Yi Gu <yigu@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1189841}

diff --git a/content/browser/webid/federated_auth_request_impl.cc b/content/browser/webid/federated_auth_request_impl.cc
index 4c123bfc0a2a1..9c95239a441e1 100644
--- a/content/browser/webid/federated_auth_request_impl.cc
+++ b/content/browser/webid/federated_auth_request_impl.cc
@@ -565,6 +565,16 @@ void FederatedAuthRequestImpl::RequestToken(
     mojo::ReportBadMessage("idp_get_params_ptrs is empty.");
     return;
   }
+  // This could only happen with a compromised renderer process. We ensure that
+  // the provider list size is > 0 on the renderer side at the beginning of
+  // parsing |IdentityCredentialRequestOptions|.
+  for (auto& idp_get_params_ptr : idp_get_params_ptrs) {
+    if (idp_get_params_ptr->providers.size() == 0) {
+      mojo::ReportBadMessage("The provider list should not be empty.");
+      return;
+    }
+  }
+
   if (!render_frame_host().GetPage().IsPrimary()) {
     mojo::ReportBadMessage(
         "FedCM should not be allowed in nested frame trees.");
@@ -630,15 +640,6 @@ void FederatedAuthRequestImpl::RequestToken(
     return;
   }
 
-  // Check that providers are non-empty.
-  for (auto& idp_get_params_ptr : idp_get_params_ptrs) {
-    if (idp_get_params_ptr->providers.size() == 0) {
-      std::move(callback).Run(RequestTokenStatus::kError, absl::nullopt, "",
-                              /*is_auto_reauthn=*/false);
-      return;
-    }
-  }
-
   if (!fedcm_metrics_) {
     // Ensure the lifecycle state as GetPageUkmSourceId doesn't support the
     // prerendering page. As FederatedAithRequest runs behind the
