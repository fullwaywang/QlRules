/**
 * @name linux-9b5033ee2c5af6d1135a403df32d219ab57e55f9-v3d_get_cpu_copy_query_results_params
 * @id cpp/linux/9b5033ee2c5af6d1135a403df32d219ab57e55f9/v3d-get-cpu-copy-query-results-params
 * @description linux-9b5033ee2c5af6d1135a403df32d219ab57e55f9-drivers/gpu/drm/v3d/v3d_submit.c-v3d_get_cpu_copy_query_results_params CVE-2024-42263
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vjob_557, FunctionCall target_0) {
	exists(ValueFieldAccess obj_0 | obj_0=target_0.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="timestamp_query"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vjob_557
		)
		and obj_0.getTarget().getName()="queries"
	)
	and target_0.getTarget().hasName("kvfree")
	and not target_0.getTarget().hasName("v3d_timestamp_query_info_free")
}

predicate func_1(Function func) {
exists(AssignExpr target_1 |
	target_1.getLValue().(VariableAccess).getType().hasName("int")
	and target_1.getRValue() instanceof UnaryMinusExpr
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(FunctionCall target_14, Function func) {
exists(GotoStmt target_2 |
	exists(BlockStmt obj_0 | obj_0=target_2.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(1)=target_2
			and obj_1.getCondition()=target_14
		)
	)
	and target_2.getName() ="error"
	and target_2.getEnclosingFunction() = func
)
}

predicate func_3(Function func) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getType().hasName("int")
	and target_3.getRValue() instanceof UnaryMinusExpr
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(FunctionCall target_15, Function func) {
exists(GotoStmt target_4 |
	exists(BlockStmt obj_0 | obj_0=target_4.getParent() |
		exists(IfStmt obj_1 | obj_1=obj_0.getParent() |
			obj_1.getThen().(BlockStmt).getStmt(1)=target_4
			and obj_1.getCondition()=target_15
		)
	)
	and target_4.getName() ="error"
	and target_4.getEnclosingFunction() = func
)
}

predicate func_5(Parameter vjob_557, Variable vi_1_561, ExprStmt target_16, PostfixIncrExpr target_17, Function func) {
exists(ExprStmt target_5 |
	exists(FunctionCall obj_0 | obj_0=target_5.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getOperand() |
				obj_2.getTarget().getName()="timestamp_query"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vjob_557
			)
		)
		and obj_0.getTarget().hasName("v3d_timestamp_query_info_free")
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vi_1_561
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_17.getOperand().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
)
}

/*predicate func_6(Parameter vjob_557, ExprStmt target_16) {
exists(AddressOfExpr target_6 |
	exists(PointerFieldAccess obj_0 | obj_0=target_6.getOperand() |
		obj_0.getTarget().getName()="timestamp_query"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vjob_557
	)
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_6.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

*/
predicate func_9(Parameter vjob_557, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="timestamp_query"
	and target_9.getQualifier().(VariableAccess).getTarget()=vjob_557
	and target_9.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_10(Function func, UnaryMinusExpr target_10) {
	target_10.getValue()="-14"
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Function func, UnaryMinusExpr target_11) {
	target_11.getValue()="-14"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Parameter vjob_557, FunctionCall target_12) {
	exists(ValueFieldAccess obj_0 | obj_0=target_12.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="timestamp_query"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vjob_557
		)
		and obj_0.getTarget().getName()="queries"
	)
	and target_12.getTarget().hasName("kvfree")
}

predicate func_13(FunctionCall target_15, Function func, ReturnStmt target_13) {
	target_13.getExpr() instanceof UnaryMinusExpr
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Function func, FunctionCall target_14) {
	target_14.getTarget().hasName("copy_from_user")
	and target_14.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32")
	and target_14.getArgument(1).(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
	and target_14.getArgument(2).(SizeofExprOperator).getValue()="4"
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, FunctionCall target_15) {
	target_15.getTarget().hasName("copy_from_user")
	and target_15.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32")
	and target_15.getArgument(1).(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
	and target_15.getArgument(2).(SizeofExprOperator).getValue()="4"
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Parameter vjob_557, Variable vi_1_561, ExprStmt target_16) {
	exists(AssignExpr obj_0 | obj_0=target_16.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			exists(ArrayExpr obj_2 | obj_2=obj_1.getQualifier() |
				exists(ValueFieldAccess obj_3 | obj_3=obj_2.getArrayBase() |
					exists(PointerFieldAccess obj_4 | obj_4=obj_3.getQualifier() |
						obj_4.getTarget().getName()="timestamp_query"
						and obj_4.getQualifier().(VariableAccess).getTarget()=vjob_557
					)
					and obj_3.getTarget().getName()="queries"
				)
				and obj_2.getArrayOffset().(VariableAccess).getTarget()=vi_1_561
			)
			and obj_1.getTarget().getName()="offset"
		)
		and obj_0.getRValue().(VariableAccess).getTarget().getType().hasName("u32")
	)
}

predicate func_17(Variable vi_1_561, PostfixIncrExpr target_17) {
	target_17.getOperand().(VariableAccess).getTarget()=vi_1_561
}

from Function func, Parameter vjob_557, Variable vi_1_561, FunctionCall target_0, PointerFieldAccess target_9, UnaryMinusExpr target_10, UnaryMinusExpr target_11, FunctionCall target_12, ReturnStmt target_13, FunctionCall target_14, FunctionCall target_15, ExprStmt target_16, PostfixIncrExpr target_17
where
func_0(vjob_557, target_0)
and not func_1(func)
and not func_2(target_14, func)
and not func_3(func)
and not func_4(target_15, func)
and not func_5(vjob_557, vi_1_561, target_16, target_17, func)
and func_9(vjob_557, target_9)
and func_10(func, target_10)
and func_11(func, target_11)
and func_12(vjob_557, target_12)
and func_13(target_15, func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(vjob_557, vi_1_561, target_16)
and func_17(vi_1_561, target_17)
and vjob_557.getType().hasName("v3d_cpu_job *")
and vi_1_561.getType().hasName("int")
and vjob_557.getFunction() = func
and vi_1_561.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
