/**
 * @name linux-3cf521f7dc87c031617fd47e4b7aa2593c2f3daf-pppol2tp_setsockopt
 * @id cpp/linux/3cf521f7dc87c031617fd47e4b7aa2593c2f3daf/pppol2tp-setsockopt
 * @description linux-3cf521f7dc87c031617fd47e4b7aa2593c2f3daf-net/l2tp/l2tp_ppp.c-pppol2tp_setsockopt CVE-2014-4943
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vlevel_1357, Parameter voptname_1357, Parameter voptval_1358, Parameter voptlen_1358, Variable vsk_1360, Variable vudp_prot, VariableCall target_1) {
	target_1.getExpr().(ValueFieldAccess).getTarget().getName()="setsockopt"
	and target_1.getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vudp_prot
	and target_1.getArgument(0).(VariableAccess).getTarget()=vsk_1360
	and target_1.getArgument(1).(VariableAccess).getTarget()=vlevel_1357
	and target_1.getArgument(2).(VariableAccess).getTarget()=voptname_1357
	and target_1.getArgument(3).(VariableAccess).getTarget()=voptval_1358
	and target_1.getArgument(4).(VariableAccess).getTarget()=voptlen_1358
}

from Function func, Parameter vlevel_1357, Parameter voptname_1357, Parameter voptval_1358, Parameter voptlen_1358, Variable vsk_1360, Variable vudp_prot, VariableCall target_1
where
func_1(vlevel_1357, voptname_1357, voptval_1358, voptlen_1358, vsk_1360, vudp_prot, target_1)
and vlevel_1357.getType().hasName("int")
and voptname_1357.getType().hasName("int")
and voptval_1358.getType().hasName("char *")
and voptlen_1358.getType().hasName("unsigned int")
and vsk_1360.getType().hasName("sock *")
and vudp_prot.getType().hasName("proto")
and vlevel_1357.getFunction() = func
and voptname_1357.getFunction() = func
and voptval_1358.getFunction() = func
and voptlen_1358.getFunction() = func
and vsk_1360.(LocalVariable).getFunction() = func
and not vudp_prot.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
