/**
 * @name linux-62f20e068ccc50d6ab66fdb72ba90da2b9418c99-__ipv6_select_ident
 * @id cpp/linux/62f20e068ccc50d6ab66fdb72ba90da2b9418c99/--ipv6-select-ident
 * @description linux-62f20e068ccc50d6ab66fdb72ba90da2b9418c99-__ipv6_select_ident CVE-2021-45485
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vhash_25, Variable vid_25, FunctionCall target_0) {
		target_0.getTarget().hasName("ip_idents_reserve")
		and not target_0.getTarget().hasName("prandom_u32")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vhash_25
		and target_0.getArgument(1).(Literal).getValue()="1"
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_25
}

predicate func_1(Variable vid_25, DeclStmt target_7, Function func) {
	exists(DoStmt target_1 |
		target_1.getCondition() instanceof NotExpr
		and target_1.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_25
		and target_1.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("prandom_u32")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1)
}

predicate func_2(Variable vid_25, NotExpr target_2) {
		target_2.getOperand().(VariableAccess).getTarget()=vid_25
		and target_2.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_3(Variable vid_25, VariableAccess target_3) {
		target_3.getTarget()=vid_25
		and target_3.getParent().(AssignExpr).getLValue() = target_3
		and target_3.getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_5(Function func, TypeDeclarationEntry target_5) {
		target_5.getType() instanceof LocalStruct
		and target_5.getDeclaration().getEnclosingFunction() = func
}

predicate func_7(Function func, DeclStmt target_7) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Parameter vnet_14, Function func, IfStmt target_8) {
		target_8.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_8.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("siphash_key_is_zero")
		and target_8.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_8.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_random_bytes")
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ipv4"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_14
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(SizeofExprOperator).getValue()="16"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_9(Parameter vnet_14, FunctionCall target_9) {
		target_9.getTarget().hasName("get_random_bytes")
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ipv4"
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_14
		and target_9.getArgument(1).(SizeofExprOperator).getValue()="16"
}

*/
predicate func_10(Variable vcombined_21, Variable vhash_25, Parameter vnet_14, Function func, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhash_25
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("siphash")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcombined_21
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(SizeofExprOperator).getValue()="32"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ipv4"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_14
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Variable vcombined_21, Variable vhash_25, Parameter vnet_14, VariableAccess target_11) {
		target_11.getTarget()=vhash_25
		and target_11.getParent().(AssignExpr).getLValue() = target_11
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("siphash")
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcombined_21
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(SizeofExprOperator).getValue()="32"
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ipv4"
		and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_14
}

*/
/*predicate func_12(Variable vcombined_21, Variable vhash_25, Parameter vnet_14, FunctionCall target_12) {
		target_12.getTarget().hasName("siphash")
		and target_12.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcombined_21
		and target_12.getArgument(1).(SizeofExprOperator).getValue()="32"
		and target_12.getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ip_id_key"
		and target_12.getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ipv4"
		and target_12.getArgument(2).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_14
		and target_12.getParent().(AssignExpr).getRValue() = target_12
		and target_12.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhash_25
}

*/
predicate func_13(Variable vid_25, Function func, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_25
		and target_13.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Variable vid_25, Function func, IfStmt target_14) {
		target_14.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_14.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof NotExpr
		and target_14.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_14.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_25
		and target_14.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getValue()="2147483648"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

from Function func, Variable vcombined_21, Variable vhash_25, Variable vid_25, Parameter vnet_14, FunctionCall target_0, NotExpr target_2, VariableAccess target_3, TypeDeclarationEntry target_5, DeclStmt target_7, IfStmt target_8, ExprStmt target_10, ExprStmt target_13, IfStmt target_14
where
func_0(vhash_25, vid_25, target_0)
and not func_1(vid_25, target_7, func)
and func_2(vid_25, target_2)
and func_3(vid_25, target_3)
and func_5(func, target_5)
and func_7(func, target_7)
and func_8(vnet_14, func, target_8)
and func_10(vcombined_21, vhash_25, vnet_14, func, target_10)
and func_13(vid_25, func, target_13)
and func_14(vid_25, func, target_14)
and vcombined_21.getType().hasName("const struct <unnamed>")
and vhash_25.getType().hasName("u32")
and vid_25.getType().hasName("u32")
and vnet_14.getType().hasName("net *")
and vcombined_21.(LocalVariable).getFunction() = func
and vhash_25.(LocalVariable).getFunction() = func
and vid_25.(LocalVariable).getFunction() = func
and vnet_14.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
