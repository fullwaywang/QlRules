/**
 * @name linux-536de747bc48262225889a533db6650731ab25d3-dt9812_write_multiple_registers
 * @id cpp/linux/536de747bc48262225889a533db6650731ab25d3/dt9812-write-multiple-registers
 * @description linux-536de747bc48262225889a533db6650731ab25d3-drivers/comedi/drivers/dt9812.c-dt9812_write_multiple_registers CVE-2021-47477
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vusb_286, Variable vcount_289, Literal target_1) {
	target_1.getValue()="32"
	and not target_1.getValue()="12"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dt9812_private *")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(2) instanceof AddressOfExpr
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_289
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
}

predicate func_2(Parameter vreg_count_283, ForStmt target_21, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="count"
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="read_multi_info"
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vreg_count_283
	and target_2.getLocation().isBefore(target_21.getLocation())
}

predicate func_3(Variable vcmd_288) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getTarget()=vcmd_288
	and target_3.getRValue().(FunctionCall).getTarget().hasName("kzalloc")
	and target_3.getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="32"
	and target_3.getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264")
}

predicate func_4(Variable vcmd_288, ForStmt target_21, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vcmd_288
	and target_4.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_21.getLocation()))
}

/*predicate func_5(Function func) {
exists(UnaryMinusExpr target_5 |
	target_5.getValue()="-12"
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_6(Variable vcmd_288) {
exists(PointerFieldAccess target_6 |
	target_6.getTarget().getName()="cmd"
	and target_6.getQualifier().(VariableAccess).getTarget()=vcmd_288)
}

predicate func_7(Parameter vreg_count_283, Variable vcmd_288, ForStmt target_21, RelationalOperation target_25, ExprStmt target_2, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="count"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="read_multi_info"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcmd_288
	and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vreg_count_283
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_21.getLocation())
	and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_25.getGreaterOperand().(VariableAccess).getLocation()))
}

/*predicate func_8(Variable vcmd_288, ExprStmt target_2) {
exists(PointerFieldAccess target_8 |
	target_8.getTarget().getName()="u"
	and target_8.getQualifier().(VariableAccess).getTarget()=vcmd_288)
}

*/
predicate func_9(Variable vcmd_288, ExprStmt target_2) {
exists(PointerFieldAccess target_9 |
	target_9.getTarget().getName()="u"
	and target_9.getQualifier().(VariableAccess).getTarget()=vcmd_288)
}

predicate func_10(Variable vcmd_288) {
exists(PointerFieldAccess target_10 |
	target_10.getTarget().getName()="u"
	and target_10.getQualifier().(VariableAccess).getTarget()=vcmd_288)
}

predicate func_11(Variable vusb_286, Variable vcmd_288, Variable vcount_289, Function func) {
exists(ExprStmt target_11 |
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vcmd_288
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(SizeofExprOperator).getValue()="32"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_289
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
	and target_11.getFollowingStmt() instanceof ReturnStmt)
}

/*predicate func_13(Function func) {
exists(SizeofExprOperator target_13 |
	target_13.getValue()="32"
	and target_13.getEnclosingFunction() = func)
}

*/
predicate func_14(Variable vcmd_288, Function func) {
exists(ExprStmt target_14 |
	target_14.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_14.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcmd_288
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
	and target_14.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_15(Function func) {
exists(ReturnStmt target_15 |
	target_15.getExpr().(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
	and target_15.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_16(Variable vcmd_288, ValueFieldAccess target_16) {
	target_16.getTarget().getName()="cmd"
	and target_16.getQualifier().(VariableAccess).getTarget()=vcmd_288
	and target_16.getParent().(AssignExpr).getLValue() = target_16
}

predicate func_17(Variable vcmd_288, ValueFieldAccess target_17) {
	target_17.getTarget().getName()="u"
	and target_17.getQualifier().(VariableAccess).getTarget()=vcmd_288
}

predicate func_18(Variable vcmd_288, ValueFieldAccess target_18) {
	target_18.getTarget().getName()="u"
	and target_18.getQualifier().(VariableAccess).getTarget()=vcmd_288
}

predicate func_19(Variable vcmd_288, ValueFieldAccess target_19) {
	target_19.getTarget().getName()="u"
	and target_19.getQualifier().(VariableAccess).getTarget()=vcmd_288
}

predicate func_20(Variable vusb_286, Variable vcmd_288, Variable vcount_289, AddressOfExpr target_20) {
	target_20.getOperand().(VariableAccess).getTarget()=vcmd_288
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_286
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dt9812_private *")
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(3) instanceof Literal
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_289
	and target_20.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
}

predicate func_21(Parameter vreg_count_283, ForStmt target_21) {
	target_21.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_21.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vreg_count_283
	and target_21.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="address"
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="write"
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("u8 *")
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_25(Parameter vreg_count_283, RelationalOperation target_25) {
	 (target_25 instanceof GTExpr or target_25 instanceof LTExpr)
	and target_25.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_25.getGreaterOperand().(VariableAccess).getTarget()=vreg_count_283
}

from Function func, Parameter vreg_count_283, Variable vusb_286, Variable vcmd_288, Variable vcount_289, Literal target_1, ExprStmt target_2, ValueFieldAccess target_16, ValueFieldAccess target_17, ValueFieldAccess target_18, ValueFieldAccess target_19, AddressOfExpr target_20, ForStmt target_21, RelationalOperation target_25
where
func_1(vusb_286, vcount_289, target_1)
and func_2(vreg_count_283, target_21, target_2)
and not func_3(vcmd_288)
and not func_4(vcmd_288, target_21, func)
and not func_6(vcmd_288)
and not func_7(vreg_count_283, vcmd_288, target_21, target_25, target_2, func)
and not func_9(vcmd_288, target_2)
and not func_10(vcmd_288)
and not func_11(vusb_286, vcmd_288, vcount_289, func)
and not func_14(vcmd_288, func)
and not func_15(func)
and func_16(vcmd_288, target_16)
and func_17(vcmd_288, target_17)
and func_18(vcmd_288, target_18)
and func_19(vcmd_288, target_19)
and func_20(vusb_286, vcmd_288, vcount_289, target_20)
and func_21(vreg_count_283, target_21)
and func_25(vreg_count_283, target_25)
and vreg_count_283.getType().hasName("int")
and vusb_286.getType().hasName("usb_device *")
and vcmd_288.getType().hasName("dt9812_usb_cmd")
and vcount_289.getType().hasName("int")
and vreg_count_283.getFunction() = func
and vusb_286.(LocalVariable).getFunction() = func
and vcmd_288.(LocalVariable).getFunction() = func
and vcount_289.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
