/**
 * @name linux-f0c982853d665597d17e4995ff479fbbf79a9cf6-x86_android_tablet_remove
 * @id cpp/linux/f0c982853d665597d17e4995ff479fbbf79a9cf6/x86-android-tablet-remove
 * @description linux-f0c982853d665597d17e4995ff479fbbf79a9cf6-drivers/platform/x86/x86-android-tablets/core.c-x86_android_tablet_remove CVE-2024-40975
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_279) {
exists(SubExpr target_0 |
	exists(AssignExpr obj_0 | obj_0=target_0.getParent() |
		obj_0.getRValue() = target_0
		and obj_0.getLValue().(VariableAccess).getTarget()=vi_279
	)
	and target_0.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_0.getRightOperand().(Literal).getValue()="1"
)
}

predicate func_1(Variable vi_279, BlockStmt target_36) {
exists(RelationalOperation target_1 |
	 (target_1 instanceof GEExpr or target_1 instanceof LEExpr)
	and target_1.getGreaterOperand().(VariableAccess).getTarget()=vi_279
	and target_1.getLesserOperand() instanceof Literal
	and target_1.getParent().(ForStmt).getStmt()=target_36
)
}

predicate func_2(Variable vi_279, ArrayExpr target_37) {
exists(PostfixDecrExpr target_2 |
	exists(VariableAccess obj_0 | obj_0=target_2.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_37.getArrayOffset().(VariableAccess).getLocation())
	)
)
}

predicate func_3(Variable vi_279) {
exists(SubExpr target_3 |
	exists(AssignExpr obj_0 | obj_0=target_3.getParent() |
		obj_0.getRValue() = target_3
		and obj_0.getLValue().(VariableAccess).getTarget()=vi_279
	)
	and target_3.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_3.getRightOperand().(Literal).getValue()="1"
)
}

predicate func_4(Variable vi_279, ExprStmt target_38) {
exists(RelationalOperation target_4 |
	 (target_4 instanceof GEExpr or target_4 instanceof LEExpr)
	and target_4.getGreaterOperand().(VariableAccess).getTarget()=vi_279
	and target_4.getLesserOperand() instanceof Literal
	and target_4.getParent().(ForStmt).getStmt()=target_38
)
}

predicate func_5(Variable vi_279, ArrayExpr target_39) {
exists(PostfixDecrExpr target_5 |
	exists(VariableAccess obj_0 | obj_0=target_5.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_39.getArrayOffset().(VariableAccess).getLocation())
	)
)
}

predicate func_6(Variable vi_279) {
exists(SubExpr target_6 |
	exists(AssignExpr obj_0 | obj_0=target_6.getParent() |
		obj_0.getRValue() = target_6
		and obj_0.getLValue().(VariableAccess).getTarget()=vi_279
	)
	and target_6.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_6.getRightOperand().(Literal).getValue()="1"
)
}

predicate func_7(Variable vi_279, ExprStmt target_40) {
exists(RelationalOperation target_7 |
	 (target_7 instanceof GEExpr or target_7 instanceof LEExpr)
	and target_7.getGreaterOperand().(VariableAccess).getTarget()=vi_279
	and target_7.getLesserOperand() instanceof Literal
	and target_7.getParent().(ForStmt).getStmt()=target_40
)
}

predicate func_8(Variable vi_279, ArrayExpr target_41) {
exists(PostfixDecrExpr target_8 |
	exists(VariableAccess obj_0 | obj_0=target_8.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_41.getArrayOffset().(VariableAccess).getLocation())
	)
)
}

predicate func_9(Variable vi_279, ArrayExpr target_41) {
exists(AssignExpr target_9 |
	exists(SubExpr obj_0 | obj_0=target_9.getRValue() |
		obj_0.getLeftOperand().(VariableAccess).getType().hasName("int")
		and obj_0.getRightOperand().(Literal).getValue()="1"
	)
	and target_9.getLValue().(VariableAccess).getTarget()=vi_279
	and target_41.getArrayOffset().(VariableAccess).getLocation().isBefore(target_9.getLValue().(VariableAccess).getLocation())
)
}

predicate func_10(Variable vi_279, ExprStmt target_42) {
exists(RelationalOperation target_10 |
	 (target_10 instanceof GEExpr or target_10 instanceof LEExpr)
	and target_10.getGreaterOperand().(VariableAccess).getTarget()=vi_279
	and target_10.getLesserOperand().(Literal).getValue()="0"
	and target_10.getParent().(ForStmt).getStmt()=target_42
)
}

predicate func_11(Variable vi_279, ArrayExpr target_43) {
exists(PostfixDecrExpr target_11 |
	exists(VariableAccess obj_0 | obj_0=target_11.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_43.getArrayOffset().(VariableAccess).getLocation())
	)
)
}

predicate func_12(Variable vi_279, AssignExpr target_12) {
	target_12.getLValue().(VariableAccess).getTarget()=vi_279
	and target_12.getRValue().(Literal).getValue()="0"
}

predicate func_13(Variable vi_279, VariableAccess target_13) {
	target_13.getTarget()=vi_279
}

predicate func_14(Variable vi_279, VariableAccess target_14) {
	target_14.getTarget()=vi_279
}

predicate func_15(Variable vi_279, VariableAccess target_15) {
	target_15.getTarget()=vi_279
}

predicate func_16(Variable vi_279, VariableAccess target_16) {
	target_16.getTarget()=vi_279
}

predicate func_17(Variable vi_279, Variable vserdev_count, BlockStmt target_36, VariableAccess target_17) {
	exists(LTExpr obj_0 | obj_0=target_17.getParent() |
		obj_0.getGreaterOperand().(VariableAccess).getTarget()=vserdev_count
		and obj_0.getParent().(ForStmt).getStmt()=target_36
	)
	and target_17.getTarget()=vi_279
}

/*predicate func_18(Variable vi_279, Variable vserdev_count, BlockStmt target_36, VariableAccess target_18) {
	exists(LTExpr obj_0 | obj_0=target_18.getParent() |
		obj_0.getLesserOperand().(VariableAccess).getTarget()=vi_279
		and obj_0.getParent().(ForStmt).getStmt()=target_36
	)
	and target_18.getTarget()=vserdev_count
}

*/
predicate func_20(Variable vi_279, Variable vpdev_count, ExprStmt target_38, VariableAccess target_20) {
	exists(LTExpr obj_0 | obj_0=target_20.getParent() |
		obj_0.getGreaterOperand().(VariableAccess).getTarget()=vpdev_count
		and obj_0.getParent().(ForStmt).getStmt()=target_38
	)
	and target_20.getTarget()=vi_279
}

/*predicate func_21(Variable vi_279, Variable vpdev_count, ExprStmt target_38, VariableAccess target_21) {
	exists(LTExpr obj_0 | obj_0=target_21.getParent() |
		obj_0.getLesserOperand().(VariableAccess).getTarget()=vi_279
		and obj_0.getParent().(ForStmt).getStmt()=target_38
	)
	and target_21.getTarget()=vpdev_count
}

*/
predicate func_23(Variable vi_279, Variable vspi_dev_count, ExprStmt target_40, VariableAccess target_23) {
	exists(LTExpr obj_0 | obj_0=target_23.getParent() |
		obj_0.getGreaterOperand().(VariableAccess).getTarget()=vspi_dev_count
		and obj_0.getParent().(ForStmt).getStmt()=target_40
	)
	and target_23.getTarget()=vi_279
}

/*predicate func_24(Variable vi_279, Variable vspi_dev_count, ExprStmt target_40, VariableAccess target_24) {
	exists(LTExpr obj_0 | obj_0=target_24.getParent() |
		obj_0.getLesserOperand().(VariableAccess).getTarget()=vi_279
		and obj_0.getParent().(ForStmt).getStmt()=target_40
	)
	and target_24.getTarget()=vspi_dev_count
}

*/
predicate func_26(Variable vi2c_client_count, Variable vi_279, ExprStmt target_42, VariableAccess target_26) {
	exists(LTExpr obj_0 | obj_0=target_26.getParent() |
		obj_0.getGreaterOperand().(VariableAccess).getTarget()=vi2c_client_count
		and obj_0.getParent().(ForStmt).getStmt()=target_42
	)
	and target_26.getTarget()=vi_279
}

/*predicate func_27(Variable vi2c_client_count, Variable vi_279, ExprStmt target_42, VariableAccess target_27) {
	exists(LTExpr obj_0 | obj_0=target_27.getParent() |
		obj_0.getLesserOperand().(VariableAccess).getTarget()=vi_279
		and obj_0.getParent().(ForStmt).getStmt()=target_42
	)
	and target_27.getTarget()=vi2c_client_count
}

*/
predicate func_28(Variable vi_279, Variable vserdev_count, BlockStmt target_36, RelationalOperation target_28) {
	 (target_28 instanceof GTExpr or target_28 instanceof LTExpr)
	and target_28.getLesserOperand().(VariableAccess).getTarget()=vi_279
	and target_28.getGreaterOperand().(VariableAccess).getTarget()=vserdev_count
	and target_28.getParent().(ForStmt).getStmt()=target_36
}

predicate func_29(Variable vi_279, ArrayExpr target_37, PostfixIncrExpr target_29) {
	exists(VariableAccess obj_0 | obj_0=target_29.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_37.getArrayOffset().(VariableAccess).getLocation())
	)
}

predicate func_30(Variable vi_279, Variable vpdev_count, ExprStmt target_38, RelationalOperation target_30) {
	 (target_30 instanceof GTExpr or target_30 instanceof LTExpr)
	and target_30.getLesserOperand().(VariableAccess).getTarget()=vi_279
	and target_30.getGreaterOperand().(VariableAccess).getTarget()=vpdev_count
	and target_30.getParent().(ForStmt).getStmt()=target_38
}

predicate func_31(Variable vi_279, ArrayExpr target_39, PostfixIncrExpr target_31) {
	exists(VariableAccess obj_0 | obj_0=target_31.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_39.getArrayOffset().(VariableAccess).getLocation())
	)
}

predicate func_32(Variable vi_279, Variable vspi_dev_count, ExprStmt target_40, RelationalOperation target_32) {
	 (target_32 instanceof GTExpr or target_32 instanceof LTExpr)
	and target_32.getLesserOperand().(VariableAccess).getTarget()=vi_279
	and target_32.getGreaterOperand().(VariableAccess).getTarget()=vspi_dev_count
	and target_32.getParent().(ForStmt).getStmt()=target_40
}

predicate func_33(Variable vi_279, ArrayExpr target_41, PostfixIncrExpr target_33) {
	exists(VariableAccess obj_0 | obj_0=target_33.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_41.getArrayOffset().(VariableAccess).getLocation())
	)
}

predicate func_34(Variable vi2c_client_count, Variable vi_279, ExprStmt target_42, RelationalOperation target_34) {
	 (target_34 instanceof GTExpr or target_34 instanceof LTExpr)
	and target_34.getLesserOperand().(VariableAccess).getTarget()=vi_279
	and target_34.getGreaterOperand().(VariableAccess).getTarget()=vi2c_client_count
	and target_34.getParent().(ForStmt).getStmt()=target_42
}

predicate func_35(Variable vi_279, ArrayExpr target_43, PostfixIncrExpr target_35) {
	exists(VariableAccess obj_0 | obj_0=target_35.getOperand() |
		obj_0.getTarget()=vi_279
		and obj_0.getLocation().isBefore(target_43.getArrayOffset().(VariableAccess).getLocation())
	)
}

predicate func_36(Variable vi_279, BlockStmt target_36) {
	exists(IfStmt obj_0 | obj_0=target_36.getStmt(0) |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getCondition() |
			obj_1.getArrayBase().(VariableAccess).getTarget().getType().hasName("serdev_device **")
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_279
		)
		and exists(ExprStmt obj_2 | obj_2=obj_0.getThen() |
			exists(FunctionCall obj_3 | obj_3=obj_2.getExpr() |
				exists(ArrayExpr obj_4 | obj_4=obj_3.getArgument(0) |
					obj_4.getArrayBase().(VariableAccess).getTarget().getType().hasName("serdev_device **")
					and obj_4.getArrayOffset().(VariableAccess).getTarget()=vi_279
				)
				and obj_3.getTarget().hasName("serdev_device_remove")
			)
		)
	)
}

predicate func_37(Variable vi_279, ExprStmt target_44, ArrayExpr target_37) {
	target_37.getArrayBase().(VariableAccess).getTarget().getType().hasName("serdev_device **")
	and target_37.getArrayOffset().(VariableAccess).getTarget()=vi_279
	and target_37.getParent().(IfStmt).getThen()=target_44
}

predicate func_38(Variable vi_279, ExprStmt target_38) {
	exists(FunctionCall obj_0 | obj_0=target_38.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			obj_1.getArrayBase().(VariableAccess).getTarget().getType().hasName("platform_device **")
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_279
		)
		and obj_0.getTarget().hasName("platform_device_unregister")
	)
}

predicate func_39(Variable vi_279, ArrayExpr target_39) {
	target_39.getArrayBase().(VariableAccess).getTarget().getType().hasName("platform_device **")
	and target_39.getArrayOffset().(VariableAccess).getTarget()=vi_279
}

predicate func_40(Variable vi_279, ExprStmt target_40) {
	exists(FunctionCall obj_0 | obj_0=target_40.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			obj_1.getArrayBase().(VariableAccess).getTarget().getType().hasName("spi_device **")
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_279
		)
		and obj_0.getTarget().hasName("spi_unregister_device")
	)
}

predicate func_41(Variable vi_279, ArrayExpr target_41) {
	target_41.getArrayBase().(VariableAccess).getTarget().getType().hasName("spi_device **")
	and target_41.getArrayOffset().(VariableAccess).getTarget()=vi_279
}

predicate func_42(Variable vi_279, ExprStmt target_42) {
	exists(FunctionCall obj_0 | obj_0=target_42.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			obj_1.getArrayBase().(VariableAccess).getTarget().getType().hasName("i2c_client **")
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_279
		)
		and obj_0.getTarget().hasName("i2c_unregister_device")
	)
}

predicate func_43(Variable vi_279, ArrayExpr target_43) {
	target_43.getArrayBase().(VariableAccess).getTarget().getType().hasName("i2c_client **")
	and target_43.getArrayOffset().(VariableAccess).getTarget()=vi_279
}

predicate func_44(Variable vi_279, ExprStmt target_44) {
	exists(FunctionCall obj_0 | obj_0=target_44.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			obj_1.getArrayBase().(VariableAccess).getTarget().getType().hasName("serdev_device **")
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_279
		)
		and obj_0.getTarget().hasName("serdev_device_remove")
	)
}

from Function func, Variable vi2c_client_count, Variable vi_279, Variable vserdev_count, Variable vpdev_count, Variable vspi_dev_count, AssignExpr target_12, VariableAccess target_13, VariableAccess target_14, VariableAccess target_15, VariableAccess target_16, VariableAccess target_17, VariableAccess target_20, VariableAccess target_23, VariableAccess target_26, RelationalOperation target_28, PostfixIncrExpr target_29, RelationalOperation target_30, PostfixIncrExpr target_31, RelationalOperation target_32, PostfixIncrExpr target_33, RelationalOperation target_34, PostfixIncrExpr target_35, BlockStmt target_36, ArrayExpr target_37, ExprStmt target_38, ArrayExpr target_39, ExprStmt target_40, ArrayExpr target_41, ExprStmt target_42, ArrayExpr target_43, ExprStmt target_44
where
not func_0(vi_279)
and not func_1(vi_279, target_36)
and not func_2(vi_279, target_37)
and not func_3(vi_279)
and not func_4(vi_279, target_38)
and not func_5(vi_279, target_39)
and not func_6(vi_279)
and not func_7(vi_279, target_40)
and not func_8(vi_279, target_41)
and not func_9(vi_279, target_41)
and not func_10(vi_279, target_42)
and not func_11(vi_279, target_43)
and func_12(vi_279, target_12)
and func_13(vi_279, target_13)
and func_14(vi_279, target_14)
and func_15(vi_279, target_15)
and func_16(vi_279, target_16)
and func_17(vi_279, vserdev_count, target_36, target_17)
and func_20(vi_279, vpdev_count, target_38, target_20)
and func_23(vi_279, vspi_dev_count, target_40, target_23)
and func_26(vi2c_client_count, vi_279, target_42, target_26)
and func_28(vi_279, vserdev_count, target_36, target_28)
and func_29(vi_279, target_37, target_29)
and func_30(vi_279, vpdev_count, target_38, target_30)
and func_31(vi_279, target_39, target_31)
and func_32(vi_279, vspi_dev_count, target_40, target_32)
and func_33(vi_279, target_41, target_33)
and func_34(vi2c_client_count, vi_279, target_42, target_34)
and func_35(vi_279, target_43, target_35)
and func_36(vi_279, target_36)
and func_37(vi_279, target_44, target_37)
and func_38(vi_279, target_38)
and func_39(vi_279, target_39)
and func_40(vi_279, target_40)
and func_41(vi_279, target_41)
and func_42(vi_279, target_42)
and func_43(vi_279, target_43)
and func_44(vi_279, target_44)
and vi2c_client_count.getType().hasName("int")
and vi_279.getType().hasName("int")
and vserdev_count.getType().hasName("int")
and vpdev_count.getType().hasName("int")
and vspi_dev_count.getType().hasName("int")
and not vi2c_client_count.getParentScope+() = func
and vi_279.(LocalVariable).getFunction() = func
and not vserdev_count.getParentScope+() = func
and not vpdev_count.getParentScope+() = func
and not vspi_dev_count.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
