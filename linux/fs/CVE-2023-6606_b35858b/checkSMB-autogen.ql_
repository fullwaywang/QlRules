/**
 * @name linux-b35858b3786ddbb56e1c35138ba25d6adf8d0bef-checkSMB
 * @id cpp/linux/b35858b3786ddbb56e1c35138ba25d6adf8d0bef/checksmb
 * @description linux-b35858b3786ddbb56e1c35138ba25d6adf8d0bef-fs/smb/client/misc.c-checkSMB CVE-2023-6606
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtotal_read_329, Variable vsmb_331, RelationalOperation target_1, LogicalAndExpr target_2, EqualityOperation target_3) {
exists(IfStmt target_0 |
	target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vtotal_read_329
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getLeftOperand().(SizeofExprOperator).getValue()="37"
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(MulExpr).getLeftOperand().(Literal).getValue()="2"
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(MulExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="WordCount"
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(MulExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsmb_331
	and target_0.getThen().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_0.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_0.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(DoStmt).getCondition() instanceof Literal
	and target_0.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-5"
	and target_0.getParent().(IfStmt).getCondition()=target_1
	and target_2.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
	and target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_3.getRightOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vtotal_read_329, RelationalOperation target_1) {
	 (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
	and target_1.getLesserOperand().(VariableAccess).getTarget()=vtotal_read_329
	and target_1.getGreaterOperand().(AddExpr).getValue()="39"
}

predicate func_2(Parameter vtotal_read_329, Variable vsmb_331, LogicalAndExpr target_2) {
	target_2.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vtotal_read_329
	and target_2.getLeftOperand().(EqualityOperation).getRightOperand().(AddExpr).getValue()="38"
	and target_2.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="WordCount"
	and target_2.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsmb_331
	and target_2.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
}

predicate func_3(Parameter vtotal_read_329, EqualityOperation target_3) {
	target_3.getLeftOperand().(AddExpr).getLeftOperand().(Literal).getValue()="4"
	and target_3.getLeftOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("__u32")
	and target_3.getRightOperand().(VariableAccess).getTarget()=vtotal_read_329
}

from Function func, Parameter vtotal_read_329, Variable vsmb_331, RelationalOperation target_1, LogicalAndExpr target_2, EqualityOperation target_3
where
not func_0(vtotal_read_329, vsmb_331, target_1, target_2, target_3)
and func_1(vtotal_read_329, target_1)
and func_2(vtotal_read_329, vsmb_331, target_2)
and func_3(vtotal_read_329, target_3)
and vtotal_read_329.getType().hasName("unsigned int")
and vsmb_331.getType().hasName("smb_hdr *")
and vtotal_read_329.getFunction() = func
and vsmb_331.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
