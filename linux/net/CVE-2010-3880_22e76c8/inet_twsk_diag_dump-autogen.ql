/**
 * @name linux-22e76c849d505d87c5ecf3d3e6742a65f0ff4860-inet_twsk_diag_dump
 * @id cpp/linux/22e76c849d505d87c5ecf3d3e6742a65f0ff4860/inet-twsk-diag-dump
 * @description linux-22e76c849d505d87c5ecf3d3e6742a65f0ff4860-net/ipv4/inet_diag.c-inet_twsk_diag_dump CVE-2010-3880
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcb_526, BlockStmt target_13, PointerArithmeticOperation target_14) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("nlmsg_attrlen")
		and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="nlh"
		and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_526
		and target_0.getArgument(1) instanceof SizeofExprOperator
		and target_0.getParent().(IfStmt).getThen()=target_13
		and target_14.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vcb_526, RelationalOperation target_8, PointerDereferenceExpr target_15) {
	exists(FunctionCall target_2 |
		target_2.getTarget().hasName("nlmsg_find_attr")
		and target_2.getArgument(0).(PointerFieldAccess).getTarget().getName()="nlh"
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_526
		and target_2.getArgument(1).(SizeofExprOperator).getValue()="60"
		and target_8.getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vbc_1_532) {
	exists(FunctionCall target_3 |
		target_3.getTarget().hasName("nla_data")
		and target_3.getArgument(0).(VariableAccess).getTarget()=vbc_1_532
		and target_3.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("inet_diag_bc_run")
		and target_3.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0) instanceof PointerArithmeticOperation
		and target_3.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1) instanceof SubExpr
		and target_3.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("inet_diag_entry"))
}

predicate func_4(Variable vbc_1_532, PointerArithmeticOperation target_11) {
	exists(FunctionCall target_4 |
		target_4.getTarget().hasName("nla_len")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vbc_1_532
		and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("inet_diag_bc_run")
		and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0) instanceof PointerArithmeticOperation
		and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1) instanceof SubExpr
		and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("inet_diag_entry")
		and target_4.getArgument(0).(VariableAccess).getLocation().isBefore(target_11.getAnOperand().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vcb_526, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="nlh"
		and target_5.getQualifier().(VariableAccess).getTarget()=vcb_526
}

predicate func_6(Function func, SizeofExprOperator target_6) {
		target_6.getValue()="60"
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vr_528, VariableAccess target_7) {
		target_7.getTarget()=vr_528
}

predicate func_8(Parameter vcb_526, BlockStmt target_13, RelationalOperation target_8) {
		 (target_8 instanceof GTExpr or target_8 instanceof LTExpr)
		and target_8.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nlmsg_len"
		and target_8.getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nlh"
		and target_8.getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_526
		and target_8.getLesserOperand().(AddExpr).getValue()="80"
		and target_8.getParent().(IfStmt).getThen()=target_13
}

predicate func_10(Variable vr_528, PointerArithmeticOperation target_10) {
		target_10.getAnOperand().(VariableAccess).getTarget()=vr_528
		and target_10.getAnOperand().(Literal).getValue()="1"
}

predicate func_11(Variable vbc_1_532, PointerArithmeticOperation target_11) {
		target_11.getAnOperand().(VariableAccess).getTarget()=vbc_1_532
		and target_11.getAnOperand().(AddExpr).getValue()="4"
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("inet_diag_bc_run")
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="rta_len"
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbc_1_532
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(AddExpr).getValue()="4"
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("inet_diag_entry")
}

/*predicate func_12(Variable vbc_1_532, SubExpr target_12) {
		target_12.getLeftOperand().(PointerFieldAccess).getTarget().getName()="rta_len"
		and target_12.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbc_1_532
		and target_12.getRightOperand().(AddExpr).getValue()="4"
		and target_12.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("inet_diag_bc_run")
		and target_12.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vbc_1_532
		and target_12.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getAnOperand().(AddExpr).getValue()="4"
		and target_12.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("inet_diag_entry")
}

*/
predicate func_13(Function func, BlockStmt target_13) {
		target_13.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="family"
		and target_13.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("inet_diag_entry")
		and target_13.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="skc_family"
		and target_13.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="__tw_common"
		and target_13.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("inet_timewait_sock *")
		and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vcb_526, PointerArithmeticOperation target_14) {
		target_14.getAnOperand().(PointerFieldAccess).getTarget().getName()="nlh"
		and target_14.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_526
		and target_14.getAnOperand().(AddExpr).getValue()="16"
}

predicate func_15(Parameter vcb_526, PointerDereferenceExpr target_15) {
		target_15.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cb"
		and target_15.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="skb"
		and target_15.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcb_526
}

from Function func, Parameter vcb_526, Variable vr_528, Variable vbc_1_532, PointerFieldAccess target_5, SizeofExprOperator target_6, VariableAccess target_7, RelationalOperation target_8, PointerArithmeticOperation target_10, PointerArithmeticOperation target_11, BlockStmt target_13, PointerArithmeticOperation target_14, PointerDereferenceExpr target_15
where
not func_0(vcb_526, target_13, target_14)
and not func_2(vcb_526, target_8, target_15)
and not func_3(vbc_1_532)
and not func_4(vbc_1_532, target_11)
and func_5(vcb_526, target_5)
and func_6(func, target_6)
and func_7(vr_528, target_7)
and func_8(vcb_526, target_13, target_8)
and func_10(vr_528, target_10)
and func_11(vbc_1_532, target_11)
and func_13(func, target_13)
and func_14(vcb_526, target_14)
and func_15(vcb_526, target_15)
and vcb_526.getType().hasName("netlink_callback *")
and vr_528.getType().hasName("inet_diag_req *")
and vbc_1_532.getType().hasName("rtattr *")
and vcb_526.getFunction() = func
and vr_528.(LocalVariable).getFunction() = func
and vbc_1_532.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
