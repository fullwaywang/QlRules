/**
 * @name linux-536de747bc48262225889a533db6650731ab25d3-dt9812_rmw_multiple_registers
 * @id cpp/linux/536de747bc48262225889a533db6650731ab25d3/dt9812-rmw-multiple-registers
 * @description linux-536de747bc48262225889a533db6650731ab25d3-drivers/comedi/drivers/dt9812.c-dt9812_rmw_multiple_registers CVE-2021-47477
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vusb_307, Variable vcount_310, Literal target_1) {
	target_1.getValue()="32"
	and not target_1.getValue()="12"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dt9812_private *")
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(2) instanceof AddressOfExpr
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_310
	and target_1.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
}

predicate func_2(Parameter vreg_count_304, ForStmt target_19, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="count"
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="rmw_multi_info"
	and target_2.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vreg_count_304
	and target_2.getLocation().isBefore(target_19.getLocation())
}

predicate func_3(Variable vcmd_309) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getTarget()=vcmd_309
	and target_3.getRValue().(FunctionCall).getTarget().hasName("kzalloc")
	and target_3.getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="32"
	and target_3.getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264")
}

predicate func_4(Variable vcmd_309, ForStmt target_19, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vcmd_309
	and target_4.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_19.getLocation()))
}

/*predicate func_5(Function func) {
exists(UnaryMinusExpr target_5 |
	target_5.getValue()="-12"
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_6(Variable vcmd_309) {
exists(PointerFieldAccess target_6 |
	target_6.getTarget().getName()="cmd"
	and target_6.getQualifier().(VariableAccess).getTarget()=vcmd_309)
}

predicate func_7(Parameter vreg_count_304, Variable vcmd_309, ForStmt target_19, RelationalOperation target_23, ExprStmt target_2, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="count"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="rmw_multi_info"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcmd_309
	and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vreg_count_304
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_19.getLocation())
	and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_23.getGreaterOperand().(VariableAccess).getLocation()))
}

/*predicate func_8(Variable vcmd_309, ExprStmt target_2) {
exists(PointerFieldAccess target_8 |
	target_8.getTarget().getName()="u"
	and target_8.getQualifier().(VariableAccess).getTarget()=vcmd_309)
}

*/
predicate func_9(Variable vcmd_309, ExprStmt target_2) {
exists(PointerFieldAccess target_9 |
	target_9.getTarget().getName()="u"
	and target_9.getQualifier().(VariableAccess).getTarget()=vcmd_309)
}

predicate func_10(Variable vusb_307, Variable vcmd_309, Variable vcount_310, Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vcmd_309
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(SizeofExprOperator).getValue()="32"
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_310
	and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

/*predicate func_12(Function func) {
exists(SizeofExprOperator target_12 |
	target_12.getValue()="32"
	and target_12.getEnclosingFunction() = func)
}

*/
predicate func_13(Variable vcmd_309, Function func) {
exists(ExprStmt target_13 |
	target_13.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcmd_309
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
	and target_13.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_14(Function func) {
exists(ReturnStmt target_14 |
	target_14.getExpr().(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
	and target_14.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_15(Variable vcmd_309, ValueFieldAccess target_15) {
	target_15.getTarget().getName()="cmd"
	and target_15.getQualifier().(VariableAccess).getTarget()=vcmd_309
	and target_15.getParent().(AssignExpr).getLValue() = target_15
}

predicate func_16(Variable vcmd_309, ValueFieldAccess target_16) {
	target_16.getTarget().getName()="u"
	and target_16.getQualifier().(VariableAccess).getTarget()=vcmd_309
}

predicate func_17(Variable vcmd_309, ValueFieldAccess target_17) {
	target_17.getTarget().getName()="u"
	and target_17.getQualifier().(VariableAccess).getTarget()=vcmd_309
}

predicate func_18(Variable vusb_307, Variable vcmd_309, Variable vcount_310, AddressOfExpr target_18) {
	target_18.getOperand().(VariableAccess).getTarget()=vcmd_309
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_bulk_msg")
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-1073741824"
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vusb_307
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cmd_wr"
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dt9812_private *")
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(3) instanceof Literal
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcount_310
	and target_18.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="1000"
}

predicate func_19(Parameter vreg_count_304, ForStmt target_19) {
	target_19.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_19.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vreg_count_304
	and target_19.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="rmw"
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="rmw_multi_info"
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("dt9812_rmw_byte *")
	and target_19.getStmt().(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_23(Parameter vreg_count_304, RelationalOperation target_23) {
	 (target_23 instanceof GTExpr or target_23 instanceof LTExpr)
	and target_23.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_23.getGreaterOperand().(VariableAccess).getTarget()=vreg_count_304
}

from Function func, Parameter vreg_count_304, Variable vusb_307, Variable vcmd_309, Variable vcount_310, Literal target_1, ExprStmt target_2, ValueFieldAccess target_15, ValueFieldAccess target_16, ValueFieldAccess target_17, AddressOfExpr target_18, ForStmt target_19, RelationalOperation target_23
where
func_1(vusb_307, vcount_310, target_1)
and func_2(vreg_count_304, target_19, target_2)
and not func_3(vcmd_309)
and not func_4(vcmd_309, target_19, func)
and not func_6(vcmd_309)
and not func_7(vreg_count_304, vcmd_309, target_19, target_23, target_2, func)
and not func_9(vcmd_309, target_2)
and not func_10(vusb_307, vcmd_309, vcount_310, func)
and not func_13(vcmd_309, func)
and not func_14(func)
and func_15(vcmd_309, target_15)
and func_16(vcmd_309, target_16)
and func_17(vcmd_309, target_17)
and func_18(vusb_307, vcmd_309, vcount_310, target_18)
and func_19(vreg_count_304, target_19)
and func_23(vreg_count_304, target_23)
and vreg_count_304.getType().hasName("int")
and vusb_307.getType().hasName("usb_device *")
and vcmd_309.getType().hasName("dt9812_usb_cmd")
and vcount_310.getType().hasName("int")
and vreg_count_304.getFunction() = func
and vusb_307.(LocalVariable).getFunction() = func
and vcmd_309.(LocalVariable).getFunction() = func
and vcount_310.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
