commit 368421cadfffaf3bbcdd7da2640018dc8c52f2f2	368421cadfffaf3bbcdd7da2640018dc8c52f2f2
Author: Jan Keitel <jkeitel@google.com>
Date:   Fri Oct 6 09:20:35 2023 +0000

    Use multi-window custom cursor suppression in Autofill popup.
    
    Bug: 1478613
    Change-Id: I3014096a98b571d2d9f7e08b2d7a7ca9bae01476
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4891730
    Reviewed-by: Christoph Schwering <schwering@google.com>
    Reviewed-by: Bruno Braga <brunobraga@google.com>
    Commit-Queue: Jan Keitel <jkeitel@google.com>
    Cr-Commit-Position: refs/heads/main@{#1206303}

diff --git a/chrome/browser/ui/views/autofill/popup/popup_base_view.cc b/chrome/browser/ui/views/autofill/popup/popup_base_view.cc
index a2878df2313d7..e111d33c41be7 100644
--- a/chrome/browser/ui/views/autofill/popup/popup_base_view.cc
+++ b/chrome/browser/ui/views/autofill/popup/popup_base_view.cc
@@ -17,6 +17,7 @@
 #include "chrome/browser/platform_util.h"
 #include "chrome/browser/themes/theme_service.h"
 #include "chrome/browser/ui/browser_finder.h"
+#include "chrome/browser/ui/views/autofill/popup/custom_cursor_suppressor.h"
 #include "chrome/browser/ui/views/autofill/popup/popup_view_utils.h"
 #include "chrome/browser/ui/views/chrome_layout_provider.h"
 #include "chrome/browser/ui/views/frame/browser_view.h"
@@ -246,8 +247,14 @@ bool PopupBaseView::DoShow() {
   }
 
   if (content::WebContents* web_contents = GetWebContents()) {
-    custom_cursor_blocker_ = web_contents->CreateDisallowCustomCursorScope(
-        /*max_dimension_dips=*/kMaximumAllowedCustomCursorDimension + 1);
+    if (base::FeatureList::IsEnabled(
+            features::kAutofillPopupMultiWindowCursorSuppression)) {
+      custom_cursor_suppressor_.Start(
+          /*max_dimension_dips=*/kMaximumAllowedCustomCursorDimension + 1);
+    } else {
+      custom_cursor_blocker_ = web_contents->CreateDisallowCustomCursorScope(
+          /*max_dimension_dips=*/kMaximumAllowedCustomCursorDimension + 1);
+    }
   } else {
     // `delegate_` is already gone and `WebContents` is destroying itself.
     return false;
diff --git a/chrome/browser/ui/views/autofill/popup/popup_base_view.h b/chrome/browser/ui/views/autofill/popup/popup_base_view.h
index d646b4a287f6f..60cdc19fd199a 100644
--- a/chrome/browser/ui/views/autofill/popup/popup_base_view.h
+++ b/chrome/browser/ui/views/autofill/popup/popup_base_view.h
@@ -17,6 +17,7 @@
 #include "build/build_config.h"
 #include "chrome/browser/ui/autofill/autofill_popup_view_delegate.h"
 #include "chrome/browser/ui/browser.h"
+#include "chrome/browser/ui/views/autofill/popup/custom_cursor_suppressor.h"
 #include "chrome/browser/ui/views/autofill/popup/popup_base_view.h"
 #include "chrome/browser/ui/views/autofill/popup/popup_row_view.h"
 #include "content/public/browser/web_contents.h"
@@ -154,8 +155,16 @@ class PopupBaseView : public PopupRowView::AccessibilitySelectionDelegate,
   // Ensures that the menu start event is not fired redundantly.
   bool is_ax_menu_start_event_fired_ = false;
 
-  // Responsible for re-enabling custom cursors on popup destruction.
+  // Responsible for re-enabling custom cursors in the triggered tab on popup
+  // destruction.
+  // TODO(crbug.com/1478613): Remove once
+  // `kAutofillPopupMultiWindowCursorSuppression` is removed, since it is
+  // superseded by `custom_cursor_suppressor_`.
   base::ScopedClosureRunner custom_cursor_blocker_;
+
+  // Responsible for blocking (and re-enabling) custom cursors across all
+  // browser windows.
+  CustomCursorSuppressor custom_cursor_suppressor_;
 };
 
 }  // namespace autofill
diff --git a/components/autofill/core/common/autofill_features.cc b/components/autofill/core/common/autofill_features.cc
index 86f6b6fa58507..df35d7ea5f07d 100644
--- a/components/autofill/core/common/autofill_features.cc
+++ b/components/autofill/core/common/autofill_features.cc
@@ -521,6 +521,13 @@ BASE_FEATURE(kAutofillPopupDoesNotOverlapWithContextMenu,
              "AutofillPopupDoesNotOverlapWithContextMenu",
              base::FEATURE_DISABLED_BY_DEFAULT);
 
+// If the feature is enabled, custom cursors exceeding the (24 dips) dimension
+// limit are disallowed for all active tabs in all active windows.
+COMPONENT_EXPORT(AUTOFILL)
+BASE_FEATURE(kAutofillPopupMultiWindowCursorSuppression,
+             "AutofillPopupMultiWindowCursorSuppression",
+             base::FEATURE_ENABLED_BY_DEFAULT);
+
 // Controls whether the threshold for accepting Autofill popup suggestions
 // should take into account latency information of the user event.
 BASE_FEATURE(kAutofillPopupUseLatencyInformationForAcceptThreshold,
diff --git a/components/autofill/core/common/autofill_features.h b/components/autofill/core/common/autofill_features.h
index 7e5d8833e193d..47f007230c26b 100644
--- a/components/autofill/core/common/autofill_features.h
+++ b/components/autofill/core/common/autofill_features.h
@@ -176,6 +176,8 @@ BASE_DECLARE_FEATURE(kAutofillPopupDisablePaintChecks);
 COMPONENT_EXPORT(AUTOFILL)
 BASE_DECLARE_FEATURE(kAutofillPopupDoesNotOverlapWithContextMenu);
 COMPONENT_EXPORT(AUTOFILL)
+BASE_DECLARE_FEATURE(kAutofillPopupMultiWindowCursorSuppression);
+COMPONENT_EXPORT(AUTOFILL)
 BASE_DECLARE_FEATURE(kAutofillPopupUseLatencyInformationForAcceptThreshold);
 COMPONENT_EXPORT(AUTOFILL)
 BASE_DECLARE_FEATURE(kAutofillPreferLabelsInSomeCountries);
