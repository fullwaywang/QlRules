/**
 * @name linux-82f2341c94d270421f383641b7cd670e474db56b-n_hdlc_tty_poll
 * @id cpp/linux/82f2341c94d270421f383641b7cd670e474db56b/n-hdlc-tty-poll
 * @description linux-82f2341c94d270421f383641b7cd670e474db56b-drivers/tty/n_hdlc.c-n_hdlc_tty_poll CVE-2017-2636
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="818"
	and not target_0.getValue()="807"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)n_hdlc_tty_poll() called\n"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vn_hdlc_814, ExprStmt target_7) {
exists(NotExpr target_1 |
	target_1.getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_1.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="list"
	and target_1.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rx_buf_list"
	and target_1.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
	and target_1.getParent().(IfStmt).getThen()=target_7)
}

predicate func_2(Variable vn_hdlc_814, ExprStmt target_9) {
exists(NotExpr target_2 |
	target_2.getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_2.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="list"
	and target_2.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tx_free_buf_list"
	and target_2.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("mutex_is_locked")
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="atomic_write_lock"
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tty_struct *")
	and target_2.getParent().(LogicalAndExpr).getRightOperand() instanceof ValueFieldAccess
	and target_2.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_9)
}

predicate func_3(Variable vn_hdlc_814, ExprStmt target_7, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="rx_buf_list"
	and target_3.getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
	and target_3.getParent().(ValueFieldAccess).getParent().(IfStmt).getThen()=target_7
}

predicate func_4(Variable vn_hdlc_814, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="tx_free_buf_list"
	and target_4.getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
}

predicate func_5(Variable vn_hdlc_814, ExprStmt target_7, ValueFieldAccess target_5) {
	target_5.getTarget().getName()="head"
	and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="rx_buf_list"
	and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
	and target_5.getParent().(IfStmt).getThen()=target_7
}

predicate func_6(Variable vn_hdlc_814, ExprStmt target_9, ValueFieldAccess target_6) {
	target_6.getTarget().getName()="head"
	and target_6.getQualifier().(PointerFieldAccess).getTarget().getName()="tx_free_buf_list"
	and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_814
	and target_6.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("mutex_is_locked")
	and target_6.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="atomic_write_lock"
	and target_6.getParent().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tty_struct *")
	and target_6.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_9
}

predicate func_7(Function func, ExprStmt target_7) {
	target_7.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_7.getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="65"
	and target_7.getEnclosingFunction() = func
}

predicate func_9(Function func, ExprStmt target_9) {
	target_9.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_9.getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="260"
	and target_9.getEnclosingFunction() = func
}

from Function func, Variable vn_hdlc_814, Literal target_0, PointerFieldAccess target_3, PointerFieldAccess target_4, ValueFieldAccess target_5, ValueFieldAccess target_6, ExprStmt target_7, ExprStmt target_9
where
func_0(func, target_0)
and not func_1(vn_hdlc_814, target_7)
and not func_2(vn_hdlc_814, target_9)
and func_3(vn_hdlc_814, target_7, target_3)
and func_4(vn_hdlc_814, target_4)
and func_5(vn_hdlc_814, target_7, target_5)
and func_6(vn_hdlc_814, target_9, target_6)
and func_7(func, target_7)
and func_9(func, target_9)
and vn_hdlc_814.getType().hasName("n_hdlc *")
and vn_hdlc_814.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
