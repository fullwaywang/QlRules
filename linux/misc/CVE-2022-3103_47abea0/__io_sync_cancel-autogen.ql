/**
 * @name linux-47abea041f897d64dbd5777f0cf7745148f85d75-__io_sync_cancel
 * @id cpp/linux/47abea041f897d64dbd5777f0cf7745148f85d75/--io-sync-cancel
 * @description linux-47abea041f897d64dbd5777f0cf7745148f85d75-io_uring/cancel.c-__io_sync_cancel CVE-2022-3103
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfd_212) {
exists(RelationalOperation target_0 |
	 (target_0 instanceof GEExpr or target_0 instanceof LEExpr)
	and target_0.getGreaterOperand().(VariableAccess).getTarget()=vfd_212
	and target_0.getLesserOperand() instanceof ValueFieldAccess
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof RelationalOperation
	and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0")
}

/*predicate func_1(Variable vctx_214, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="nr_user_files"
	and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_214
}

*/
predicate func_2(Parameter vfd_212, VariableAccess target_2) {
	target_2.getTarget()=vfd_212
	and target_2.getParent().(GTExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_2.getParent().(GTExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_3(Parameter vfd_212, RelationalOperation target_3) {
	 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getGreaterOperand().(VariableAccess).getTarget()=vfd_212
	and target_3.getLesserOperand() instanceof ValueFieldAccess
	and target_3.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

from Function func, Parameter vfd_212, Variable vctx_214, VariableAccess target_2, RelationalOperation target_3
where
not func_0(vfd_212)
and func_2(vfd_212, target_2)
and func_3(vfd_212, target_3)
and vfd_212.getType().hasName("int")
and vctx_214.getType().hasName("io_ring_ctx *")
and vfd_212.getFunction() = func
and vctx_214.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
