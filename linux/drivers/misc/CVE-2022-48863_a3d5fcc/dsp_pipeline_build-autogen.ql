/**
 * @name linux-a3d5fcc6cf2ecbba5a269631092570aa285a24cb-dsp_pipeline_build
 * @id cpp/linux/a3d5fcc6cf2ecbba5a269631092570aa285a24cb/dsp-pipeline-build
 * @description linux-a3d5fcc6cf2ecbba5a269631092570aa285a24cb-drivers/isdn/mISDN/dsp_pipeline.c-dsp_pipeline_build CVE-2022-48863
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdup_195, VariableAccess target_0) {
	exists(AddressOfExpr obj_0 | obj_0=target_0.getParent() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getParent() |
			exists(AssignExpr obj_2 | obj_2=obj_1.getParent() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getRValue() |
					obj_3.getTarget().hasName("strsep")
					and obj_3.getArgument(1).(StringLiteral).getValue()="|"
				)
			)
		)
	)
	and target_0.getTarget()=vdup_195
}

predicate func_2(Variable vdup_195) {
exists(AssignExpr target_2 |
	exists(AssignExpr obj_0 | obj_0=target_2.getParent() |
		obj_0.getRValue() = target_2
		and obj_0.getLValue().(VariableAccess).getTarget()=vdup_195
	)
	and target_2.getLValue().(VariableAccess).getType().hasName("char *")
	and target_2.getRValue() instanceof FunctionCall
)
}

predicate func_3(Parameter vcfg_192, Variable vdup_195, FunctionCall target_3) {
	exists(AssignExpr obj_0 | obj_0=target_3.getParent() |
		obj_0.getRValue() = target_3
		and obj_0.getLValue().(VariableAccess).getTarget()=vdup_195
	)
	and target_3.getTarget().hasName("kstrdup")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vcfg_192
	and target_3.getArgument(1).(BitwiseOrExpr).getValue()="2592"
}

from Function func, Parameter vcfg_192, Variable vdup_195, VariableAccess target_0, FunctionCall target_3
where
func_0(vdup_195, target_0)
and not func_2(vdup_195)
and func_3(vcfg_192, vdup_195, target_3)
and vcfg_192.getType().hasName("const char *")
and vdup_195.getType().hasName("char *")
and vcfg_192.getFunction() = func
and vdup_195.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
