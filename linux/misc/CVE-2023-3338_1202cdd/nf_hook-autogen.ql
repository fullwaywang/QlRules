/**
 * @name linux-1202cdd665315c525b5237e96e0bedc76d7e754f-nf_hook
 * @id cpp/linux/1202cdd665315c525b5237e96e0bedc76d7e754f/nf-hook
 * @description linux-1202cdd665315c525b5237e96e0bedc76d7e754f-include/linux/netfilter.h-nf_hook CVE-2023-3338
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1923"
	and not target_0.getValue()="1921"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="1924"
	and not target_1.getValue()="1922"
	and target_1.getEnclosingFunction() = func
}

predicate func_4(Variable vhook_head_216, Variable v__UNIQUE_ID_rcu1921_248, VariableAccess target_18, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vhook_head_216
	and target_4.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_4.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1921_248
	and target_4.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_18
}

predicate func_6(Function func, DoStmt target_6) {
	target_6.getCondition() instanceof Literal
	and target_6.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_6.getEnclosingFunction() = func
}

/*predicate func_8(Function func, IfStmt target_8) {
	target_8.getCondition().(NotExpr).getValue()="0"
	and target_8.getEnclosingFunction() = func
}

*/
predicate func_9(Parameter vhook_211, Parameter vnet_211, ExprStmt target_9) {
	target_9.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="hooks_decnet"
	and target_9.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nf"
	and target_9.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_211
	and target_9.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vhook_211
}

/*predicate func_10(Variable v__warned_248, DoStmt target_10) {
	target_10.getCondition() instanceof Literal
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_248
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_10.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
}

*/
/*predicate func_12(Variable v__warned_248, IfStmt target_12) {
	target_12.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(LogicalOrExpr).getLeftOperand() instanceof Literal
	and target_12.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(LogicalOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("rcu_read_lock_held")
	and target_12.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
	and target_12.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_248
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_12.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
}

*/
/*predicate func_13(Variable v__warned_248, LogicalAndExpr target_19, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_248
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

*/
/*predicate func_14(LogicalAndExpr target_19, Function func, ExprStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("lockdep_rcu_suspicious")
	and target_14.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_14.getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_14.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_check() usage"
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_16(Variable v__UNIQUE_ID_rcu1921_248, ExprStmt target_16) {
	target_16.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1921_248
}

*/
predicate func_17(VariableAccess target_18, Function func, BreakStmt target_17) {
	target_17.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_18
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Parameter vpf_211, VariableAccess target_18) {
	target_18.getTarget()=vpf_211
}

predicate func_19(BlockStmt target_20, Function func, LogicalAndExpr target_19) {
	target_19.getLeftOperand() instanceof LogicalAndExpr
	and target_19.getRightOperand() instanceof NotExpr
	and target_19.getParent().(IfStmt).getThen()=target_20
	and target_19.getEnclosingFunction() = func
}

predicate func_20(LogicalAndExpr target_19, Function func, BlockStmt target_20) {
	target_20.getStmt(0) instanceof ExprStmt
	and target_20.getStmt(1) instanceof ExprStmt
	and target_20.getParent().(IfStmt).getCondition()=target_19
	and target_20.getEnclosingFunction() = func
}

from Function func, Parameter vhook_211, Parameter vnet_211, Variable vhook_head_216, Parameter vpf_211, Variable v__UNIQUE_ID_rcu1921_248, Variable v__warned_248, Literal target_0, Literal target_1, ExprStmt target_4, DoStmt target_6, ExprStmt target_9, BreakStmt target_17, VariableAccess target_18, LogicalAndExpr target_19, BlockStmt target_20
where
func_0(func, target_0)
and func_1(func, target_1)
and func_4(vhook_head_216, v__UNIQUE_ID_rcu1921_248, target_18, target_4)
and func_6(func, target_6)
and func_9(vhook_211, vnet_211, target_9)
and func_17(target_18, func, target_17)
and func_18(vpf_211, target_18)
and func_19(target_20, func, target_19)
and func_20(target_19, func, target_20)
and vhook_211.getType().hasName("unsigned int")
and vnet_211.getType().hasName("net *")
and vhook_head_216.getType().hasName("nf_hook_entries *")
and vpf_211.getType().hasName("u_int8_t")
and v__UNIQUE_ID_rcu1921_248.getType().hasName("nf_hook_entries *")
and v__warned_248.getType().hasName("bool")
and vhook_211.getFunction() = func
and vnet_211.getFunction() = func
and vhook_head_216.(LocalVariable).getFunction() = func
and vpf_211.getFunction() = func
and v__UNIQUE_ID_rcu1921_248.(LocalVariable).getFunction() = func
and v__warned_248.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
