/**
 * @name linux-a63d83f427f-dump_tasks
 * @id cpp/linux/a63d83f427f/dump-tasks
 * @description linux-a63d83f427f-mm/oom_kill.c-dump_tasks CVE-2011-2498
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
		target_0.getValue()="<6>[ pid ]   uid  tgid total_vm      rss cpu oom_adj name\n"
		and not target_0.getValue()="<6>[ pid ]   uid  tgid total_vm      rss cpu oom_adj oom_score_adj name\n"
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, StringLiteral target_1) {
		target_1.getValue()="<6>[%5d] %5d %5d %8lu %8lu %3u     %3d %s\n"
		and not target_1.getValue()="<6>[%5d] %5d %5d %8lu %8lu %3u     %3d         %5d %s\n"
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vtask_397, PointerFieldAccess target_3, ExprStmt target_4) {
	exists(PointerFieldAccess target_2 |
		target_2.getTarget().getName()="oom_score_adj"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="signal"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vtask_397, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="oom_adj"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="signal"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
}

predicate func_4(Variable vtask_397, ExprStmt target_4) {
		target_4.getExpr().(FunctionCall).getTarget().hasName("printk")
		and target_4.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_4.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="pid"
		and target_4.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="uid"
		and target_4.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="tgid"
		and target_4.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="total_vm"
		and target_4.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mm"
		and target_4.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(5).(FunctionCall).getTarget().hasName("get_mm_rss")
		and target_4.getExpr().(FunctionCall).getArgument(5).(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="mm"
		and target_4.getExpr().(FunctionCall).getArgument(5).(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(6).(FunctionCall).getTarget().hasName("task_cpu")
		and target_4.getExpr().(FunctionCall).getArgument(6).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(7).(PointerFieldAccess).getTarget().getName()="oom_adj"
		and target_4.getExpr().(FunctionCall).getArgument(7).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="signal"
		and target_4.getExpr().(FunctionCall).getArgument(7).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
		and target_4.getExpr().(FunctionCall).getArgument(8).(PointerFieldAccess).getTarget().getName()="comm"
		and target_4.getExpr().(FunctionCall).getArgument(8).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtask_397
}

from Function func, Variable vtask_397, StringLiteral target_0, StringLiteral target_1, PointerFieldAccess target_3, ExprStmt target_4
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_2(vtask_397, target_3, target_4)
and func_3(vtask_397, target_3)
and func_4(vtask_397, target_4)
and vtask_397.getType().hasName("task_struct *")
and vtask_397.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
