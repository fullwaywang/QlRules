/**
 * @name linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f-session_user
 * @id cpp/linux/f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f/session-user
 * @description linux-f0a96d1aafd8964e1f9955c830a3e5cb3c60a90f-fs/ksmbd/smb2pdu.c-session_user CVE-2023-38428
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vauth_msg_len_1359, ReturnStmt target_3, ExprStmt target_2, VariableAccess target_0) {
		target_0.getTarget()=vauth_msg_len_1359
		and target_0.getParent().(LTExpr).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_0.getParent().(LTExpr).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_0.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_3
		and target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLocation())
}

predicate func_2(Parameter vreq_1354, Variable vauth_msg_len_1359, Variable vsecbuf_len_1359, Function func, ExprStmt target_2) {
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vauth_msg_len_1359
		and target_2.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="SecurityBufferOffset"
		and target_2.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1354
		and target_2.getExpr().(AssignExpr).getRValue().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vsecbuf_len_1359
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(RelationalOperation target_4, Function func, ReturnStmt target_3) {
		target_3.getExpr().(Literal).getValue()="0"
		and target_3.getParent().(IfStmt).getCondition()=target_4
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable vauth_msg_len_1359, RelationalOperation target_4) {
		 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
		and target_4.getLesserOperand().(VariableAccess).getTarget()=vauth_msg_len_1359
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_4.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

from Function func, Parameter vreq_1354, Variable vauth_msg_len_1359, Variable vsecbuf_len_1359, VariableAccess target_0, ExprStmt target_2, ReturnStmt target_3, RelationalOperation target_4
where
func_0(vauth_msg_len_1359, target_3, target_2, target_0)
and func_2(vreq_1354, vauth_msg_len_1359, vsecbuf_len_1359, func, target_2)
and func_3(target_4, func, target_3)
and func_4(vauth_msg_len_1359, target_4)
and vreq_1354.getType().hasName("smb2_sess_setup_req *")
and vauth_msg_len_1359.getType().hasName("unsigned int")
and vsecbuf_len_1359.getType().hasName("unsigned int")
and vreq_1354.getFunction() = func
and vauth_msg_len_1359.(LocalVariable).getFunction() = func
and vsecbuf_len_1359.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
