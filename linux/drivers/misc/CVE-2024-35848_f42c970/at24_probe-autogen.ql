/**
 * @name linux-f42c97027fb75776e2e9358d16bf4a99aeb04cf2-at24_probe
 * @id cpp/linux/f42c97027fb75776e2e9358d16bf4a99aeb04cf2/at24-probe
 * @description linux-f42c97027fb75776e2e9358d16bf4a99aeb04cf2-drivers/misc/eeprom/at24.c-at24_probe CVE-2024-35848
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdev_592, Variable vat24_595, Variable vfull_power_596, Variable vtest_byte_599, Variable verr_600, IfStmt target_1, IfStmt target_0) {
	target_0.getCondition().(VariableAccess).getTarget()=vfull_power_596
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_600
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("at24_read")
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vat24_595
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtest_byte_599
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="1"
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=verr_600
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("pm_runtime_disable")
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_592
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("pm_runtime_status_suspended")
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("regulator_disable")
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-19"
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vdev_592, Variable vat24_595, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_1.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="nvmem"
	and target_1.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vat24_595
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("pm_runtime_disable")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_592
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("pm_runtime_status_suspended")
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_592
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("regulator_disable")
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="vcc_reg"
	and target_1.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vat24_595
}

from Function func, Variable vdev_592, Variable vat24_595, Variable vfull_power_596, Variable vtest_byte_599, Variable verr_600, IfStmt target_0, IfStmt target_1
where
func_0(vdev_592, vat24_595, vfull_power_596, vtest_byte_599, verr_600, target_1, target_0)
and func_1(vdev_592, vat24_595, target_1)
and vdev_592.getType().hasName("device *")
and vat24_595.getType().hasName("at24_data *")
and vfull_power_596.getType().hasName("bool")
and vtest_byte_599.getType().hasName("u8")
and verr_600.getType().hasName("int")
and vdev_592.(LocalVariable).getFunction() = func
and vat24_595.(LocalVariable).getFunction() = func
and vfull_power_596.(LocalVariable).getFunction() = func
and vtest_byte_599.(LocalVariable).getFunction() = func
and verr_600.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
