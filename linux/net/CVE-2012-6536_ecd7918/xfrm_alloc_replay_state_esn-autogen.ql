/**
 * @name linux-ecd7918745234e423dd87fcc0c077da557909720-xfrm_alloc_replay_state_esn
 * @id cpp/linux/ecd7918745234e423dd87fcc0c077da557909720/xfrm-alloc-replay-state-esn
 * @description linux-ecd7918745234e423dd87fcc0c077da557909720-net/xfrm/xfrm_user.c-xfrm_alloc_replay_state_esn CVE-2012-6536
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vp_390, Variable vup_390, FunctionCall target_0) {
		target_0.getTarget().hasName("kmemdup")
		and not target_0.getTarget().hasName("kzalloc")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vup_390
		and target_0.getArgument(1) instanceof FunctionCall
		and target_0.getArgument(2).(BitwiseOrExpr).getValue()="208"
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vp_390
}

predicate func_1(Variable vpp_390, Variable vup_390, FunctionCall target_1) {
		target_1.getTarget().hasName("kmemdup")
		and not target_1.getTarget().hasName("kzalloc")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vup_390
		and target_1.getArgument(1).(FunctionCall).getTarget().hasName("xfrm_replay_state_esn_len")
		and target_1.getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vup_390
		and target_1.getArgument(2).(BitwiseOrExpr).getValue()="208"
		and target_1.getParent().(AssignExpr).getRValue() = target_1
		and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpp_390
}

predicate func_2(Function func) {
	exists(AssignExpr target_2 |
		target_2.getLValue().(VariableAccess).getType().hasName("int")
		and target_2.getRValue() instanceof FunctionCall
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vrta_388, ExprStmt target_15) {
	exists(AssignExpr target_3 |
		target_3.getLValue().(VariableAccess).getType().hasName("int")
		and target_3.getRValue().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(FunctionCall).getTarget().hasName("nla_len")
		and target_3.getRValue().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrta_388
		and target_3.getRValue().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
		and target_3.getRValue().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("int")
		and target_3.getRValue().(ConditionalExpr).getElse().(SizeofExprOperator).getValue()="24"
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_3.getRValue().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(Variable vp_390, NotExpr target_17, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vp_390
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kzalloc")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("int")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="208"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_17.getOperand().(VariableAccess).getLocation()))
}

predicate func_7(Variable vpp_390, NotExpr target_19, Function func) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpp_390
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kzalloc")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("int")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="208"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
		and target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_19.getOperand().(VariableAccess).getLocation()))
}

predicate func_9(Variable vp_390, Variable vup_390, ExprStmt target_20, ExprStmt target_21, FunctionCall target_11, Function func) {
	exists(ExprStmt target_9 |
		target_9.getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vp_390
		and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vup_390
		and target_9.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
		and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_9.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_21.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
		and target_11.getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_10(Variable vpp_390, Variable vup_390, NotExpr target_19, ExprStmt target_22, Function func) {
	exists(ExprStmt target_10 |
		target_10.getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpp_390
		and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vup_390
		and target_10.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
		and target_19.getOperand().(VariableAccess).getLocation().isBefore(target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_11(Variable vup_390, FunctionCall target_11) {
		target_11.getTarget().hasName("xfrm_replay_state_esn_len")
		and target_11.getArgument(0).(VariableAccess).getTarget()=vup_390
		and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_12(Variable vup_390, VariableAccess target_12) {
		target_12.getTarget()=vup_390
		and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_13(Variable vup_390, VariableAccess target_13) {
		target_13.getTarget()=vup_390
		and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Variable vup_390, VariableAccess target_14) {
		target_14.getTarget()=vup_390
		and target_14.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(1) instanceof FunctionCall
}

predicate func_15(Parameter vrta_388, Variable vup_390, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vup_390
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_data")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrta_388
}

predicate func_17(Variable vp_390, NotExpr target_17) {
		target_17.getOperand().(VariableAccess).getTarget()=vp_390
}

predicate func_19(Variable vpp_390, NotExpr target_19) {
		target_19.getOperand().(VariableAccess).getTarget()=vpp_390
}

predicate func_20(Variable vp_390, ExprStmt target_20) {
		target_20.getExpr().(FunctionCall).getTarget().hasName("kfree")
		and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vp_390
}

predicate func_21(Variable vp_390, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("xfrm_replay_state_esn **")
		and target_21.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vp_390
}

predicate func_22(Variable vpp_390, ExprStmt target_22) {
		target_22.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("xfrm_replay_state_esn **")
		and target_22.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vpp_390
}

from Function func, Parameter vrta_388, Variable vp_390, Variable vpp_390, Variable vup_390, FunctionCall target_0, FunctionCall target_1, FunctionCall target_11, VariableAccess target_12, VariableAccess target_13, VariableAccess target_14, ExprStmt target_15, NotExpr target_17, NotExpr target_19, ExprStmt target_20, ExprStmt target_21, ExprStmt target_22
where
func_0(vp_390, vup_390, target_0)
and func_1(vpp_390, vup_390, target_1)
and not func_2(func)
and not func_3(vrta_388, target_15)
and not func_5(vp_390, target_17, func)
and not func_7(vpp_390, target_19, func)
and not func_9(vp_390, vup_390, target_20, target_21, target_11, func)
and not func_10(vpp_390, vup_390, target_19, target_22, func)
and func_11(vup_390, target_11)
and func_12(vup_390, target_12)
and func_13(vup_390, target_13)
and func_14(vup_390, target_14)
and func_15(vrta_388, vup_390, target_15)
and func_17(vp_390, target_17)
and func_19(vpp_390, target_19)
and func_20(vp_390, target_20)
and func_21(vp_390, target_21)
and func_22(vpp_390, target_22)
and vrta_388.getType().hasName("nlattr *")
and vp_390.getType().hasName("xfrm_replay_state_esn *")
and vpp_390.getType().hasName("xfrm_replay_state_esn *")
and vup_390.getType().hasName("xfrm_replay_state_esn *")
and vrta_388.getFunction() = func
and vp_390.(LocalVariable).getFunction() = func
and vpp_390.(LocalVariable).getFunction() = func
and vup_390.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
