/**
 * @name linux-dbb2483b2a46fbaf833cfb5deb5ed9cace9c7399-validate_tmpl
 * @id cpp/linux/dbb2483b2a46fbaf833cfb5deb5ed9cace9c7399/validate-tmpl
 * @description linux-dbb2483b2a46fbaf833cfb5deb5ed9cace9c7399-net/xfrm/xfrm_user.c-validate_tmpl CVE-2019-25045
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(SwitchStmt target_3, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("xfrm_id_proto_valid")
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0) instanceof ValueFieldAccess
	and target_0.getThen() instanceof ReturnStmt
	and target_0.getLocation().isBefore(target_3.getLocation())
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Parameter vut_1470, Variable vi_1473, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="proto"
	and target_1.getQualifier().(ValueFieldAccess).getTarget().getName()="id"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vut_1470
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1473
}

predicate func_2(ValueFieldAccess target_1, Function func, ReturnStmt target_2) {
	target_2.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_2.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, SwitchStmt target_3) {
	target_3.getExpr() instanceof ValueFieldAccess
	and target_3.getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="43"
	and target_3.getStmt().(BlockStmt).getStmt(4).(SwitchCase).getExpr().(Literal).getValue()="60"
	and target_3.getStmt().(BlockStmt).getStmt(5).(SwitchCase).getExpr().(Literal).getValue()="255"
	and target_3.getStmt().(BlockStmt).getStmt(7).(SwitchCase).toString() = "default: "
	and target_3.getStmt().(BlockStmt).getStmt(8) instanceof ReturnStmt
	and target_3.getEnclosingFunction() = func
}

/*predicate func_7(Function func, SwitchCase target_7) {
	target_7.getExpr().(Literal).getValue()="43"
	and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, SwitchCase target_8) {
	target_8.getExpr().(Literal).getValue()="60"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(Function func, SwitchCase target_9) {
	target_9.getExpr().(Literal).getValue()="255"
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(ValueFieldAccess target_1, Function func, BreakStmt target_10) {
	target_10.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Function func, SwitchCase target_11) {
	target_11.toString() = "default: "
	and target_11.getEnclosingFunction() = func
}

*/
from Function func, Parameter vut_1470, Variable vi_1473, ValueFieldAccess target_1, ReturnStmt target_2, SwitchStmt target_3
where
not func_0(target_3, func)
and func_1(vut_1470, vi_1473, target_1)
and func_2(target_1, func, target_2)
and func_3(func, target_3)
and vut_1470.getType().hasName("xfrm_user_tmpl *")
and vi_1473.getType().hasName("int")
and vut_1470.getFunction() = func
and vi_1473.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
