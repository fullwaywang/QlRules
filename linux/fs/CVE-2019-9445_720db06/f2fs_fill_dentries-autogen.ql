/**
 * @name linux-720db068634c91553a8e1d9a0fcd8c7050e06d2b-f2fs_fill_dentries
 * @id cpp/linux/720db068634c91553a8e1d9a0fcd8c7050e06d2b/f2fs-fill-dentries
 * @description linux-720db068634c91553a8e1d9a0fcd8c7050e06d2b-fs/f2fs/dir.c-f2fs_fill_dentries CVE-2019-9445
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vde_782, ExprStmt target_2, ExprStmt target_3) {
	exists(LogicalOrExpr target_0 |
		target_0.getAnOperand() instanceof RelationalOperation
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="name_len"
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vde_782
		and target_0.getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="255"
		and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof RelationalOperation
		and target_0.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vbit_pos_781, Parameter vd_777, RelationalOperation target_1) {
		 (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
		and target_1.getGreaterOperand().(VariableAccess).getTarget()=vbit_pos_781
		and target_1.getLesserOperand().(PointerFieldAccess).getTarget().getName()="max"
		and target_1.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_777
		and target_1.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_1.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_2(Variable vbit_pos_781, Variable vde_782, ExprStmt target_2) {
		target_2.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vbit_pos_781
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="name_len"
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vde_782
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="8"
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_2.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="3"
}

predicate func_3(Variable vde_782, ExprStmt target_3) {
		target_3.getExpr().(FunctionCall).getTarget().hasName("f2fs_msg")
		and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sb"
		and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("f2fs_sb_info *")
		and target_3.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="4"
		and target_3.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%s: corrupted namelen=%d, run fsck to fix."
		and target_3.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType() instanceof ArrayType
		and target_3.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="name_len"
		and target_3.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vde_782
}

from Function func, Variable vbit_pos_781, Variable vde_782, Parameter vd_777, RelationalOperation target_1, ExprStmt target_2, ExprStmt target_3
where
not func_0(vde_782, target_2, target_3)
and func_1(vbit_pos_781, vd_777, target_1)
and func_2(vbit_pos_781, vde_782, target_2)
and func_3(vde_782, target_3)
and vbit_pos_781.getType().hasName("unsigned int")
and vde_782.getType().hasName("f2fs_dir_entry *")
and vd_777.getType().hasName("f2fs_dentry_ptr *")
and vbit_pos_781.(LocalVariable).getFunction() = func
and vde_782.(LocalVariable).getFunction() = func
and vd_777.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
