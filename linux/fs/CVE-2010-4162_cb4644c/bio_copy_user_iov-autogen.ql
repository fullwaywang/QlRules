/**
 * @name linux-cb4644cac4a2797afc847e6c92736664d4b0ea34-bio_copy_user_iov
 * @id cpp/linux/cb4644cac4a2797afc847e6c92736664d4b0ea34/bio-copy-user-iov
 * @description linux-cb4644cac4a2797afc847e6c92736664d4b0ea34-fs/bio.c-bio_copy_user_iov CVE-2010-4162
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vend_830, Variable vstart_831, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3) {
	exists(IfStmt target_0 |
		target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vend_830
		and target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vstart_831
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("ERR_PTR")
		and target_0.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(UnaryMinusExpr).getValue()="-22"
		and target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
		and target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignAddExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getLocation())
		and target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable vend_830, ExprStmt target_1) {
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vend_830
		and target_1.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_1.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(AddExpr).getAnOperand().(ValueFieldAccess).getTarget().getName()="iov_len"
		and target_1.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_1.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_1.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
}

predicate func_2(Variable vend_830, Variable vstart_831, ExprStmt target_2) {
		target_2.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_2.getExpr().(AssignAddExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vend_830
		and target_2.getExpr().(AssignAddExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vstart_831
}

predicate func_3(Variable vstart_831, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vstart_831
		and target_3.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_3.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
}

from Function func, Variable vend_830, Variable vstart_831, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3
where
not func_0(vend_830, vstart_831, target_1, target_2, target_3)
and func_1(vend_830, target_1)
and func_2(vend_830, vstart_831, target_2)
and func_3(vstart_831, target_3)
and vend_830.getType().hasName("unsigned long")
and vstart_831.getType().hasName("unsigned long")
and vend_830.(LocalVariable).getFunction() = func
and vstart_831.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
