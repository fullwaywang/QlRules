commit 0195cc9b83ebca340aee0a8404ab356cdc5b1d5b	0195cc9b83ebca340aee0a8404ab356cdc5b1d5b
Author: Tommy Steimel <steimel@chromium.org>
Date:   Wed Mar 8 17:30:42 2023 +0000

    PiP2: NOTREACHED when a Document PiP window is duplicated
    
    There was a bug where Document Picture-in-Picture windows could be
    duplicated, leading to spoofing issues since the duplicated window
    would bypass some pip-specific logic. This CL makes it so that if that
    issue regresses, a NOTREACHED will fire when a Document PiP window is
    duplicated.
    
    Bug: 1413919
    Change-Id: I44db29eb59a09d368366f23e9178acb7d2a19499
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4317563
    Commit-Queue: Tommy Steimel <steimel@chromium.org>
    Reviewed-by: Fr <beaufort.francois@gmail.com>
    Cr-Commit-Position: refs/heads/main@{#1114605}

diff --git a/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.cc b/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.cc
index e86494ba0246a..90b83c6b89269 100644
--- a/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.cc
+++ b/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.cc
@@ -245,4 +245,13 @@ void DocumentPictureInPictureWindowControllerImpl::ChildContentsObserver::
     std::move(contents_destroyed_cb_).Run();
 }
 
+void DocumentPictureInPictureWindowControllerImpl::ChildContentsObserver::
+    DidCloneToNewWebContents(WebContents*, WebContents*) {
+  // DocumentPictureInPictureWindows should never be duplicated, since there
+  // should only ever be one PiP window and the duplicated window bypasses some
+  // of the controller logic here. This is a regression check for
+  // https://crbug.com/1413919.
+  NOTREACHED();
+}
+
 }  // namespace content
diff --git a/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.h b/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.h
index a3283933b4de2..89d396963e955 100644
--- a/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.h
+++ b/content/browser/picture_in_picture/document_picture_in_picture_window_controller_impl.h
@@ -107,6 +107,9 @@ class CONTENT_EXPORT DocumentPictureInPictureWindowControllerImpl
     // If the PiP window is destroyed, notify the opener.
     void WebContentsDestroyed() override;
 
+    // The PiP window should never be duplicated.
+    void DidCloneToNewWebContents(WebContents*, WebContents*) override;
+
    private:
     // Called, via post, to request that the pip session end.
     base::OnceClosure force_close_cb_;
