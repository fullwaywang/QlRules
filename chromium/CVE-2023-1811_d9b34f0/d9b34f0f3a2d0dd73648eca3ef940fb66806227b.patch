commit d9b34f0f3a2d0dd73648eca3ef940fb66806227b	d9b34f0f3a2d0dd73648eca3ef940fb66806227b
Author: Dave Tapuska <dtapuska@chromium.org>
Date:   Tue Mar 21 19:34:10 2023 +0000

    Move the edit commands to an on stack variable
    
    DevTools uses nested event loops and the usage of the class member can
    be problematic for iteration because the nested loop can change the
    variable's storage causing a UAF.
    
    Bug: 1420510
    Change-Id: Ie08a71b60401fa4322cca0cc31062ba64672126a
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4355811
    Reviewed-by: David Bokan <bokan@chromium.org>
    Commit-Queue: Dave Tapuska <dtapuska@chromium.org>
    Reviewed-by: Daniel Cheng <dcheng@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1120123}

diff --git a/third_party/blink/renderer/core/frame/web_frame_widget_impl.cc b/third_party/blink/renderer/core/frame/web_frame_widget_impl.cc
index 3c85cbec894ac..004bac1f5230f 100644
--- a/third_party/blink/renderer/core/frame/web_frame_widget_impl.cc
+++ b/third_party/blink/renderer/core/frame/web_frame_widget_impl.cc
@@ -3275,11 +3275,18 @@ void WebFrameWidgetImpl::AddEditCommandForNextKeyEvent(const WebString& name,
 }
 
 bool WebFrameWidgetImpl::HandleCurrentKeyboardEvent() {
-  bool did_execute_command = false;
+  if (edit_commands_.empty()) {
+    return false;
+  }
   WebLocalFrame* frame = FocusedWebLocalFrameInWidget();
   if (!frame)
     frame = local_root_;
-  for (const auto& command : edit_commands_) {
+  bool did_execute_command = false;
+  // Executing an edit command can run JS and we can end up reassigning
+  // `edit_commands_` so move it to a stack variable before iterating on it.
+  Vector<mojom::blink::EditCommandPtr> edit_commands =
+      std::move(edit_commands_);
+  for (const auto& command : edit_commands) {
     // In gtk and cocoa, it's possible to bind multiple edit commands to one
     // key (but it's the exception). Once one edit command is not executed, it
     // seems safest to not execute the rest.
