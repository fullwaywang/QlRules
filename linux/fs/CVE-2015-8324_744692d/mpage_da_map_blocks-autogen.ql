/**
 * @name linux-744692dc059845b2a3022119871846e74d4f6e11-mpage_da_map_blocks
 * @id cpp/linux/744692dc059845b2a3022119871846e74d4f6e11/mpage-da-map-blocks
 * @description linux-744692dc059845b2a3022119871846e74d4f6e11-fs/ext4/inode.c-mpage_da_map_blocks CVE-2015-8324
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmpd_2178, Variable vget_blocks_flags_2180, IfStmt target_1, NotExpr target_2, BitwiseAndExpr target_3, ExprStmt target_4, ExprStmt target_5, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(FunctionCall).getTarget().hasName("ext4_should_dioread_nolock")
	and target_0.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="inode"
	and target_0.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmpd_2178
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vget_blocks_flags_2180
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BitwiseOrExpr).getValue()="11"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation())
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vmpd_2178, Variable vget_blocks_flags_2180, IfStmt target_1) {
	target_1.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="b_state"
	and target_1.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmpd_2178
	and target_1.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="512"
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vget_blocks_flags_2180
	and target_1.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="4"
}

predicate func_2(Parameter vmpd_2178, NotExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="b_size"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmpd_2178
}

predicate func_3(Parameter vmpd_2178, ExprStmt target_5, BitwiseAndExpr target_3) {
	target_3.getLeftOperand().(PointerFieldAccess).getTarget().getName()="b_state"
	and target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmpd_2178
	and target_3.getRightOperand().(BinaryBitwiseOperation).getValue()="512"
	and target_3.getParent().(IfStmt).getThen()=target_5
}

predicate func_4(Variable vget_blocks_flags_2180, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vget_blocks_flags_2180
	and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
}

predicate func_5(Variable vget_blocks_flags_2180, ExprStmt target_5) {
	target_5.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vget_blocks_flags_2180
	and target_5.getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="4"
}

from Function func, Parameter vmpd_2178, Variable vget_blocks_flags_2180, IfStmt target_1, NotExpr target_2, BitwiseAndExpr target_3, ExprStmt target_4, ExprStmt target_5
where
not func_0(vmpd_2178, vget_blocks_flags_2180, target_1, target_2, target_3, target_4, target_5, func)
and func_1(vmpd_2178, vget_blocks_flags_2180, target_1)
and func_2(vmpd_2178, target_2)
and func_3(vmpd_2178, target_5, target_3)
and func_4(vget_blocks_flags_2180, target_4)
and func_5(vget_blocks_flags_2180, target_5)
and vmpd_2178.getType().hasName("mpage_da_data *")
and vget_blocks_flags_2180.getType().hasName("int")
and vmpd_2178.getFunction() = func
and vget_blocks_flags_2180.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
