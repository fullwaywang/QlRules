/**
 * @name linux-3efc61d95259956db25347e2a9562c3e54546e20-fb_deferred_io_cleanup
 * @id cpp/linux/3efc61d95259956db25347e2a9562c3e54546e20/fb-deferred-io-cleanup
 * @description linux-3efc61d95259956db25347e2a9562c3e54546e20-drivers/video/fbdev/core/fb_defio.c-fb_deferred_io_cleanup CVE-2023-52731
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("__builtin_unreachable")
	and not target_0.getTarget().hasName("fb_deferred_io_release")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vinfo_316, VariableAccess target_1) {
	target_1.getTarget()=vinfo_316
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_2(Function func, DeclStmt target_2) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, DoStmt target_4) {
	target_4.getCondition() instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

/*predicate func_5(Variable vfbdefio_318, IfStmt target_5) {
	target_5.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_5.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vfbdefio_318
	and target_5.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_5.getThen().(DoStmt).getCondition() instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
}

*/
/*predicate func_6(Function func, ExprStmt target_6) {
	target_6.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="927"
	and target_6.getEnclosingFunction() = func
}

*/
/*predicate func_7(Function func, AsmStmt target_7) {
	target_7.getChild(0).(Literal).getValue()="927"
	and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, DoStmt target_8) {
	target_8.getCondition() instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_8.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_8.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_8.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(Function func, AsmStmt target_9) {
	target_9.getChild(0) instanceof StringLiteral
	and target_9.getChild(1) instanceof Literal
	and target_9.getChild(2) instanceof Literal
	and target_9.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_9.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(Function func, ExprStmt target_10) {
	target_10.getExpr() instanceof FunctionCall
	and target_10.getEnclosingFunction() = func
}

*/
predicate func_11(Parameter vinfo_316, Function func, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("cancel_delayed_work_sync")
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="deferred_work"
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_316
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Parameter vinfo_316, Variable vpage_319, Variable vi_320, Function func, ForStmt target_12) {
	target_12.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_320
	and target_12.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_12.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_320
	and target_12.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="smem_len"
	and target_12.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="fix"
	and target_12.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_316
	and target_12.getUpdate().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vi_320
	and target_12.getUpdate().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getValue()="4096"
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpage_319
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("fb_deferred_io_page")
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinfo_316
	and target_12.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vi_320
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mapping"
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

/*predicate func_13(Parameter vinfo_316, Variable vpage_319, Variable vi_320, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpage_319
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("fb_deferred_io_page")
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinfo_316
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vi_320
}

*/
/*predicate func_14(Variable vpage_319, AssignExpr target_14) {
	target_14.getLValue().(ValueFieldAccess).getTarget().getName()="mapping"
	and target_14.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpage_319
	and target_14.getRValue().(Literal).getValue()="0"
}

*/
from Function func, Parameter vinfo_316, Variable vfbdefio_318, Variable vpage_319, Variable vi_320, FunctionCall target_0, VariableAccess target_1, DeclStmt target_2, DeclStmt target_3, DoStmt target_4, ExprStmt target_11, ForStmt target_12
where
func_0(func, target_0)
and func_1(vinfo_316, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_11(vinfo_316, func, target_11)
and func_12(vinfo_316, vpage_319, vi_320, func, target_12)
and vinfo_316.getType().hasName("fb_info *")
and vfbdefio_318.getType().hasName("fb_deferred_io *")
and vpage_319.getType().hasName("page *")
and vi_320.getType().hasName("int")
and vinfo_316.getFunction() = func
and vfbdefio_318.(LocalVariable).getFunction() = func
and vpage_319.(LocalVariable).getFunction() = func
and vi_320.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
