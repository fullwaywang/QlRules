commit 88c808fd42b53a7e01a2ac3253ef31fef74cb5af
Author: Avi Kivity <avi@redhat.com>
Date:   Mon Aug 17 22:49:40 2009 +0300

    KVM: Protect update_cr8_intercept() when running without an apic
    
    update_cr8_intercept() can be triggered from userspace while there
    is no apic present.
    
    Signed-off-by: Avi Kivity <avi@redhat.com>

diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c
index 59a8ba4..35e7fc5 100644
--- a/arch/x86/kvm/x86.c
+++ b/arch/x86/kvm/x86.c
@@ -3500,6 +3500,9 @@ static void update_cr8_intercept(struct kvm_vcpu *vcpu)
 	if (!kvm_x86_ops->update_cr8_intercept)
 		return;
 
+	if (!vcpu->arch.apic)
+		return;
+
 	if (!vcpu->arch.apic->vapic_addr)
 		max_irr = kvm_lapic_find_highest_irr(vcpu);
 	else
