commit 57600a7dd2b52c904f7c8d2cac0fd8c23868e680
Author: Huai-Yuan Liu <qq810974084@gmail.com>
Date:   Fri Jun 21 16:25:45 2024 +0800

    scsi: lpfc: Fix a possible null pointer dereference
    
    [ Upstream commit 5e0bf3e8aec2cbc51123f84b29aaacbd91fc56fa ]
    
    In function lpfc_xcvr_data_show, the memory allocation with kmalloc might
    fail, thereby making rdp_context a null pointer. In the following context
    and functions that use this pointer, there are dereferencing operations,
    leading to null pointer dereference.
    
    To fix this issue, a null pointer check should be added. If it is null,
    use scnprintf to notify the user and return len.
    
    Fixes: 479b0917e447 ("scsi: lpfc: Create a sysfs entry called lpfc_xcvr_data for transceiver info")
    Signed-off-by: Huai-Yuan Liu <qq810974084@gmail.com>
    Link: https://lore.kernel.org/r/20240621082545.449170-1-qq810974084@gmail.com
    Reviewed-by: Justin Tee <justin.tee@broadcom.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

diff --git a/drivers/scsi/lpfc/lpfc_attr.c b/drivers/scsi/lpfc/lpfc_attr.c
index 79b45ea5fdb5..8123062ec2fa 100644
--- a/drivers/scsi/lpfc/lpfc_attr.c
+++ b/drivers/scsi/lpfc/lpfc_attr.c
@@ -1904,6 +1904,11 @@ lpfc_xcvr_data_show(struct device *dev, struct device_attribute *attr,
 
 	/* Get transceiver information */
 	rdp_context = kmalloc(sizeof(*rdp_context), GFP_KERNEL);
+	if (!rdp_context) {
+		len = scnprintf(buf, PAGE_SIZE - len,
+				"SPF info NA: alloc failure\n");
+		return len;
+	}
 
 	rc = lpfc_get_sfp_info_wait(phba, rdp_context);
 	if (rc) {
