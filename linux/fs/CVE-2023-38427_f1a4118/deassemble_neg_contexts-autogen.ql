/**
 * @name linux-f1a411873c85b642f13b01f21b534c2bab81fc1b-deassemble_neg_contexts
 * @id cpp/linux/f1a411873c85b642f13b01f21b534c2bab81fc1b/deassemble-neg-contexts
 * @description linux-f1a411873c85b642f13b01f21b534c2bab81fc1b-fs/smb/server/smb2pdu.c-deassemble_neg_contexts CVE-2023-38427
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vclen_984, VariableAccess target_0) {
	target_0.getTarget()=vclen_984
}

predicate func_3(Variable voffset_971, ExprStmt target_10) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getTarget()=voffset_971
	and target_3.getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_3.getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="7"
	and target_3.getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="-8"
	and target_10.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getLocation().isBefore(target_3.getLValue().(VariableAccess).getLocation()))
}

predicate func_5(Variable vclen_984, AssignExpr target_5) {
	target_5.getLValue().(VariableAccess).getTarget()=vclen_984
	and target_5.getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vclen_984
	and target_5.getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="7"
	and target_5.getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="-8"
}

predicate func_6(Variable voffset_971, Variable vclen_984, AssignExpr target_6) {
	target_6.getLValue().(VariableAccess).getTarget()=voffset_971
	and target_6.getRValue().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vclen_984
	and target_6.getRValue().(AddExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_6.getRValue().(AddExpr).getRightOperand().(SizeofTypeOperator).getValue()="8"
}

predicate func_7(Variable vlen_of_ctxts_970, Variable vclen_984, ExprStmt target_7) {
	target_7.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_of_ctxts_970
	and target_7.getExpr().(AssignSubExpr).getRValue().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vclen_984
	and target_7.getExpr().(AssignSubExpr).getRValue().(AddExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_7.getExpr().(AssignSubExpr).getRValue().(AddExpr).getRightOperand().(SizeofTypeOperator).getValue()="8"
}

/*predicate func_8(Variable vlen_of_ctxts_970, Variable vclen_984, RelationalOperation target_11, AddExpr target_8) {
	target_8.getLeftOperand().(VariableAccess).getTarget()=vclen_984
	and target_8.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_8.getRightOperand().(SizeofTypeOperator).getValue()="8"
	and target_8.getParent().(AssignSubExpr).getRValue() = target_8
	and target_8.getParent().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_of_ctxts_970
	and target_11.getLesserOperand().(VariableAccess).getLocation().isBefore(target_8.getParent().(AssignSubExpr).getLValue().(VariableAccess).getLocation())
}

*/
predicate func_10(Variable voffset_971, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("smb2_neg_context *")
	and target_10.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("smb2_neg_context *")
	and target_10.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=voffset_971
}

predicate func_11(Variable vlen_of_ctxts_970, RelationalOperation target_11) {
	 (target_11 instanceof GTExpr or target_11 instanceof LTExpr)
	and target_11.getGreaterOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_11.getLesserOperand().(VariableAccess).getTarget()=vlen_of_ctxts_970
}

from Function func, Variable vlen_of_ctxts_970, Variable voffset_971, Variable vclen_984, VariableAccess target_0, AssignExpr target_5, AssignExpr target_6, ExprStmt target_7, ExprStmt target_10, RelationalOperation target_11
where
func_0(vclen_984, target_0)
and not func_3(voffset_971, target_10)
and func_5(vclen_984, target_5)
and func_6(voffset_971, vclen_984, target_6)
and func_7(vlen_of_ctxts_970, vclen_984, target_7)
and func_10(voffset_971, target_10)
and func_11(vlen_of_ctxts_970, target_11)
and vlen_of_ctxts_970.getType().hasName("int")
and voffset_971.getType().hasName("int")
and vclen_984.getType().hasName("int")
and vlen_of_ctxts_970.(LocalVariable).getFunction() = func
and voffset_971.(LocalVariable).getFunction() = func
and vclen_984.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
