/**
 * @name linux-a58d9166a756a0f4a6618e4f593232593d6df134-nested_svm_vmrun
 * @id cpp/linux/a58d9166a756a0f4a6618e4f593232593d6df134/nested-svm-vmrun
 * @description linux-a58d9166a756a0f4a6618e4f593232593d6df134-nested_svm_vmrun CVE-2021-29657
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vvmcb12_460, Parameter vsvm_457, BlockStmt target_3, FunctionCall target_0) {
		target_0.getTarget().hasName("nested_vmcb_checks")
		and not target_0.getTarget().hasName("nested_vmcb_check_save")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vsvm_457
		and target_0.getArgument(1).(VariableAccess).getTarget()=vvmcb12_460
		and target_0.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_3
}

predicate func_1(Variable vvmcb12_460, Parameter vsvm_457, ExprStmt target_4, NotExpr target_6, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(FunctionCall).getTarget().hasName("load_nested_vmcb_control")
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsvm_457
		and target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="control"
		and target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmcb12_460
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_6.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vvmcb12_460, Parameter vsvm_457, BlockStmt target_3, ExprStmt target_7) {
	exists(LogicalOrExpr target_2 |
		target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("nested_vmcb_check_save")
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsvm_457
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvmcb12_460
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("nested_vmcb_check_controls")
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="ctl"
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nested"
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsvm_457
		and target_2.getParent().(IfStmt).getThen()=target_3
		and target_2.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vvmcb12_460, BlockStmt target_3) {
		target_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="exit_code"
		and target_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="control"
		and target_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmcb12_460
		and target_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="4294967295"
		and target_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="exit_code_hi"
		and target_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="control"
		and target_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmcb12_460
		and target_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_4(Variable vvmcb12_460, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvmcb12_460
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="hva"
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("kvm_host_map")
}

predicate func_6(Parameter vsvm_457, NotExpr target_6) {
		target_6.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="initialized"
		and target_6.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nested"
		and target_6.getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsvm_457
}

predicate func_7(Variable vvmcb12_460, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="exit_code"
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="control"
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmcb12_460
		and target_7.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="4294967295"
}

from Function func, Variable vvmcb12_460, Parameter vsvm_457, FunctionCall target_0, BlockStmt target_3, ExprStmt target_4, NotExpr target_6, ExprStmt target_7
where
func_0(vvmcb12_460, vsvm_457, target_3, target_0)
and not func_1(vvmcb12_460, vsvm_457, target_4, target_6, func)
and not func_2(vvmcb12_460, vsvm_457, target_3, target_7)
and func_3(vvmcb12_460, target_3)
and func_4(vvmcb12_460, target_4)
and func_6(vsvm_457, target_6)
and func_7(vvmcb12_460, target_7)
and vvmcb12_460.getType().hasName("vmcb *")
and vsvm_457.getType().hasName("vcpu_svm *")
and vvmcb12_460.(LocalVariable).getFunction() = func
and vsvm_457.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
