commit 418de85d4ae13cd902a154ac94976c2d6a836268	418de85d4ae13cd902a154ac94976c2d6a836268
Author: Nate Chapin <japhet@chromium.org>
Date:   Wed Aug 23 18:22:04 2023 +0000

    Guard against NavigationThrottle::Resume misbehavior in NavigationRequest:: UnblockPendingSubframeNavigationRequestsIfNeeded
    
    Bug: 1474253
    Change-Id: I7b4dafdda90e3d71e4d2313ea718590c27014866
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4799935
    Reviewed-by: Nasko Oskov <nasko@chromium.org>
    Commit-Queue: Nate Chapin <japhet@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1187391}

diff --git a/content/browser/renderer_host/navigation_request.cc b/content/browser/renderer_host/navigation_request.cc
index a2a92c06f5ef9..c1bbd94b399e8 100644
--- a/content/browser/renderer_host/navigation_request.cc
+++ b/content/browser/renderer_host/navigation_request.cc
@@ -6982,8 +6982,6 @@ void NavigationRequest::DidCommitNavigation(
     frame_tree_node()->SetCollapsed(false);
   }
 
-  UnblockPendingSubframeNavigationRequestsIfNeeded();
-
   if (service_worker_handle_) {
     // Notify the service worker navigation handle that the navigation finished
     // committing.
@@ -7024,6 +7022,11 @@ void NavigationRequest::DidCommitNavigation(
           pending_commit_metrics_.blocked_commit_count);
     }
   }
+
+  // DO NOT ADD CODE after this.
+  // UnblockPendingSubframeNavigationRequestsIfNeeded() resumes throttles, which
+  // may cause the destruction of this NavigationRequest.
+  UnblockPendingSubframeNavigationRequestsIfNeeded();
 }
 
 SiteInfo NavigationRequest::GetSiteInfoForCommonParamsURL() {
@@ -9203,9 +9206,13 @@ void NavigationRequest::UnblockPendingSubframeNavigationRequestsIfNeeded() {
   // After a main frame same-document history navigation completes successfully,
   // we can resume any corresponding subframe history navigations that were
   // blocked on it.
+  base::WeakPtr<NavigationRequest> self = GetWeakPtr();
   for (auto& throttle : subframe_history_navigation_throttles_) {
     if (throttle) {
       throttle->Resume();
+      if (!self) {
+        return;
+      }
     }
   }
   subframe_history_navigation_throttles_.clear();
