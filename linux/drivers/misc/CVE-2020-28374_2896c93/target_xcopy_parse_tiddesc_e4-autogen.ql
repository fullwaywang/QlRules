/**
 * @name linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-target_xcopy_parse_tiddesc_e4
 * @id cpp/linux/2896c93811e39d63a4d9b63ccf12a8fbc226e5e4/target-xcopy-parse-tiddesc-e4
 * @description linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-drivers/target/target_core_xcopy.c-target_xcopy_parse_tiddesc_e4 CVE-2020-28374
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable v__UNIQUE_ID_ddebug887_115, VariableAccess target_1) {
	target_1.getTarget()=v__UNIQUE_ID_ddebug887_115
	and target_1.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_2(Variable v__UNIQUE_ID_ddebug887_115, VariableAccess target_2) {
	target_2.getTarget()=v__UNIQUE_ID_ddebug887_115
	and target_2.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_3(Variable v__UNIQUE_ID_ddebug887_115, VariableAccess target_3) {
	target_3.getTarget()=v__UNIQUE_ID_ddebug887_115
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: RELATIVE INITIATOR PORT IDENTIFIER: %hu\n"
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned short")
}

predicate func_5(Variable v__UNIQUE_ID_ddebug888_141, VariableAccess target_5) {
	target_5.getTarget()=v__UNIQUE_ID_ddebug888_141
	and target_5.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_6(Variable v__UNIQUE_ID_ddebug888_141, VariableAccess target_6) {
	target_6.getTarget()=v__UNIQUE_ID_ddebug888_141
	and target_6.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_7(Variable v__UNIQUE_ID_ddebug888_141, VariableAccess target_7) {
	target_7.getTarget()=v__UNIQUE_ID_ddebug888_141
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: desig_len: %d\n"
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u8")
}

predicate func_9(Variable v__UNIQUE_ID_ddebug889_152, VariableAccess target_9) {
	target_9.getTarget()=v__UNIQUE_ID_ddebug889_152
	and target_9.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_10(Variable v__UNIQUE_ID_ddebug889_152, VariableAccess target_10) {
	target_10.getTarget()=v__UNIQUE_ID_ddebug889_152
	and target_10.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_11(Variable v__UNIQUE_ID_ddebug889_152, VariableAccess target_11) {
	target_11.getTarget()=v__UNIQUE_ID_ddebug889_152
	and target_11.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_11.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: ignoring CSCD entry %d - neither src nor dest\n"
	and target_11.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned short")
}

predicate func_13(Variable v__UNIQUE_ID_ddebug890_166, VariableAccess target_13) {
	target_13.getTarget()=v__UNIQUE_ID_ddebug890_166
	and target_13.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_14(Variable v__UNIQUE_ID_ddebug890_166, VariableAccess target_14) {
	target_14.getTarget()=v__UNIQUE_ID_ddebug890_166
	and target_14.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_15(Variable v__UNIQUE_ID_ddebug890_166, VariableAccess target_15) {
	target_15.getTarget()=v__UNIQUE_ID_ddebug890_166
	and target_15.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_15.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: Set xop->src_dev %p from source received xop\n"
	and target_15.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="src_dev"
	and target_15.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xcopy_op *")
}

predicate func_17(Variable v__UNIQUE_ID_ddebug891_183, VariableAccess target_17) {
	target_17.getTarget()=v__UNIQUE_ID_ddebug891_183
	and target_17.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_18(Variable v__UNIQUE_ID_ddebug891_183, VariableAccess target_18) {
	target_18.getTarget()=v__UNIQUE_ID_ddebug891_183
	and target_18.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_19(Variable v__UNIQUE_ID_ddebug891_183, VariableAccess target_19) {
	target_19.getTarget()=v__UNIQUE_ID_ddebug891_183
	and target_19.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_19.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY 0xe4: Set xop->dst_dev: %p from destination received xop\n"
	and target_19.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="dst_dev"
	and target_19.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xcopy_op *")
}

from Function func, Variable v__UNIQUE_ID_ddebug890_166, Variable v__UNIQUE_ID_ddebug891_183, Variable v__UNIQUE_ID_ddebug887_115, Variable v__UNIQUE_ID_ddebug888_141, Variable v__UNIQUE_ID_ddebug889_152, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, VariableAccess target_9, VariableAccess target_10, VariableAccess target_11, VariableAccess target_13, VariableAccess target_14, VariableAccess target_15, VariableAccess target_17, VariableAccess target_18, VariableAccess target_19
where
func_1(v__UNIQUE_ID_ddebug887_115, target_1)
and func_2(v__UNIQUE_ID_ddebug887_115, target_2)
and func_3(v__UNIQUE_ID_ddebug887_115, target_3)
and func_5(v__UNIQUE_ID_ddebug888_141, target_5)
and func_6(v__UNIQUE_ID_ddebug888_141, target_6)
and func_7(v__UNIQUE_ID_ddebug888_141, target_7)
and func_9(v__UNIQUE_ID_ddebug889_152, target_9)
and func_10(v__UNIQUE_ID_ddebug889_152, target_10)
and func_11(v__UNIQUE_ID_ddebug889_152, target_11)
and func_13(v__UNIQUE_ID_ddebug890_166, target_13)
and func_14(v__UNIQUE_ID_ddebug890_166, target_14)
and func_15(v__UNIQUE_ID_ddebug890_166, target_15)
and func_17(v__UNIQUE_ID_ddebug891_183, target_17)
and func_18(v__UNIQUE_ID_ddebug891_183, target_18)
and func_19(v__UNIQUE_ID_ddebug891_183, target_19)
and v__UNIQUE_ID_ddebug890_166.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug891_183.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug887_115.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug888_141.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug889_152.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug890_166.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug891_183.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug887_115.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug888_141.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug889_152.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
