/**
 * @name linux-ea010070d0a7497253d5a6f919f6dd107450b31a-rds_rdma_extra_size
 * @id cpp/linux/ea010070d0a7497253d5a6f919f6dd107450b31a/rds-rdma-extra-size
 * @description linux-ea010070d0a7497253d5a6f919f6dd107450b31a-net/rds/rdma.c-rds_rdma_extra_size CVE-2022-21385
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vargs_520, ForStmt target_20, EqualityOperation target_21, RelationalOperation target_22, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="iov"
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kcalloc")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1) instanceof SizeofTypeOperator
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(BitwiseOrExpr).getValue()="6291648"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_20.getLocation())
	and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_22.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(ReturnStmt target_23, Function func) {
exists(NotExpr target_2 |
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="iov"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_2.getParent().(IfStmt).getThen()=target_23
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(FunctionCall target_24, Function func) {
exists(ReturnStmt target_3 |
	target_3.getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_3.getParent().(IfStmt).getCondition()=target_24
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(Variable vvec_522, AddressOfExpr target_19, Function func) {
exists(ExprStmt target_4 |
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvec_522
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_4.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof ReturnStmt
	and target_19.getOperand().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

/*predicate func_5(Function func) {
exists(PointerFieldAccess target_5 |
	target_5.getTarget().getName()="iov"
	and target_5.getQualifier().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_7(Parameter vargs_520, Variable vvec_522, Variable vlocal_vec_523, RelationalOperation target_22, AddressOfExpr target_25, Function func) {
exists(IfStmt target_7 |
	target_7.getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
	and target_7.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvec_522
	and target_7.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlocal_vec_523
	and target_7.getCondition().(FunctionCall).getArgument(2).(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_7.getCondition().(FunctionCall).getArgument(2).(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and target_7.getCondition().(FunctionCall).getArgument(2).(MulExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_7.getCondition().(FunctionCall).getArgument(2).(MulExpr).getRightOperand().(SizeofTypeOperator).getValue()="16"
	and target_7.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-14"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt
	and target_22.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getCondition().(FunctionCall).getArgument(2).(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_7.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_25.getOperand().(VariableAccess).getLocation()))
}

/*predicate func_9(Parameter vargs_520, Variable vvec_522, ReturnStmt target_23, RelationalOperation target_22) {
exists(MulExpr target_9 |
	target_9.getLeftOperand().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_9.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and target_9.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_9.getRightOperand().(SizeofTypeOperator).getValue()="16"
	and target_9.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vvec_522
	and target_9.getParent().(FunctionCall).getArgument(1) instanceof AddressOfExpr
	and target_9.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
	and target_9.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_23
	and target_22.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_10(Parameter vargs_520, Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="len"
	and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_11(Variable vvec_522) {
exists(CommaExpr target_11 |
	target_11.getLeftOperand() instanceof PostfixIncrExpr
	and target_11.getRightOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vvec_522)
}

predicate func_13(Variable vi_526, PostfixIncrExpr target_13) {
	target_13.getOperand().(VariableAccess).getTarget()=vi_526
}

predicate func_14(Variable vlocal_vec_523, Variable vi_526, VariableAccess target_14) {
	target_14.getTarget()=vlocal_vec_523
	and target_14.getParent().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_526
}

predicate func_15(Function func, SizeofTypeOperator target_15) {
	target_15.getType() instanceof LongType
	and target_15.getValue()="16"
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Variable vvec_522, Variable vlocal_vec_523, Variable vi_526, PostfixIncrExpr target_13, VariableAccess target_16) {
	target_16.getTarget()=vvec_522
	and target_16.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
	and target_16.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlocal_vec_523
	and target_16.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_526
	and target_16.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
	and target_13.getOperand().(VariableAccess).getLocation().isBefore(target_16.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation())
}

/*predicate func_17(Variable vlocal_vec_523, Variable vi_526, ReturnStmt target_23, AddressOfExpr target_17) {
	target_17.getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlocal_vec_523
	and target_17.getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_526
	and target_17.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
	and target_17.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_23
}

*/
/*predicate func_18(Variable vlocal_vec_523, Variable vi_526, PostfixIncrExpr target_13, VariableAccess target_18) {
	target_18.getTarget()=vi_526
	and target_18.getParent().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlocal_vec_523
	and target_13.getOperand().(VariableAccess).getLocation().isBefore(target_18.getLocation())
}

*/
predicate func_19(Variable vvec_522, AddressOfExpr target_19) {
	target_19.getOperand().(VariableAccess).getTarget()=vvec_522
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_pages_in_vec")
}

predicate func_20(Parameter vargs_520, Variable vvec_522, Variable vi_526, ForStmt target_20) {
	target_20.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_526
	and target_20.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_20.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_526
	and target_20.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_20.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and target_20.getUpdate() instanceof PostfixIncrExpr
	and target_20.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_from_user")
	and target_20.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vvec_522
	and target_20.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof AddressOfExpr
	and target_20.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
	and target_20.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-14"
}

predicate func_21(Parameter vargs_520, EqualityOperation target_21) {
	target_21.getLeftOperand().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
	and target_21.getRightOperand().(Literal).getValue()="0"
}

predicate func_22(Parameter vargs_520, Variable vi_526, RelationalOperation target_22) {
	 (target_22 instanceof GTExpr or target_22 instanceof LTExpr)
	and target_22.getLesserOperand().(VariableAccess).getTarget()=vi_526
	and target_22.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_local"
	and target_22.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vargs_520
}

predicate func_23(Function func, ReturnStmt target_23) {
	target_23.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable vvec_522, FunctionCall target_24) {
	target_24.getTarget().hasName("copy_from_user")
	and target_24.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vvec_522
	and target_24.getArgument(1) instanceof AddressOfExpr
	and target_24.getArgument(2) instanceof SizeofTypeOperator
}

predicate func_25(Variable vvec_522, ReturnStmt target_23, AddressOfExpr target_25) {
	target_25.getOperand().(VariableAccess).getTarget()=vvec_522
	and target_25.getParent().(FunctionCall).getArgument(1) instanceof AddressOfExpr
	and target_25.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
	and target_25.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_23
}

from Function func, Parameter vargs_520, Variable vvec_522, Variable vlocal_vec_523, Variable vi_526, PostfixIncrExpr target_13, VariableAccess target_14, SizeofTypeOperator target_15, VariableAccess target_16, AddressOfExpr target_19, ForStmt target_20, EqualityOperation target_21, RelationalOperation target_22, ReturnStmt target_23, FunctionCall target_24, AddressOfExpr target_25
where
not func_1(vargs_520, target_20, target_21, target_22, func)
and not func_2(target_23, func)
and not func_3(target_24, func)
and not func_4(vvec_522, target_19, func)
and not func_7(vargs_520, vvec_522, vlocal_vec_523, target_22, target_25, func)
and not func_10(vargs_520, func)
and not func_11(vvec_522)
and func_13(vi_526, target_13)
and func_14(vlocal_vec_523, vi_526, target_14)
and func_15(func, target_15)
and func_16(vvec_522, vlocal_vec_523, vi_526, target_13, target_16)
and func_19(vvec_522, target_19)
and func_20(vargs_520, vvec_522, vi_526, target_20)
and func_21(vargs_520, target_21)
and func_22(vargs_520, vi_526, target_22)
and func_23(func, target_23)
and func_24(vvec_522, target_24)
and func_25(vvec_522, target_23, target_25)
and vargs_520.getType().hasName("rds_rdma_args *")
and vvec_522.getType().hasName("rds_iovec")
and vlocal_vec_523.getType().hasName("rds_iovec *")
and vi_526.getType().hasName("unsigned int")
and vargs_520.getFunction() = func
and vvec_522.(LocalVariable).getFunction() = func
and vlocal_vec_523.(LocalVariable).getFunction() = func
and vi_526.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
