/**
 * @name linux-d199fab63c11998a602205f7ee7ff7c05c97164b-fanout_add
 * @id cpp/linux/d199fab63c11998a602205f7ee7ff7c05c97164b/fanout-add
 * @description linux-d199fab63c11998a602205f7ee7ff7c05c97164b-net/packet/af_packet.c-fanout_add CVE-2017-6346
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpo_1622, IfStmt target_33, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("atomic_long_set")
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="num"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_0.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_33.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vfanout_mutex, IfStmt target_34, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vfanout_mutex
	and target_1.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_34.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vpo_1622, Variable verr_1626, IfStmt target_2) {
	target_2.getCondition().(VariableAccess).getTarget()=verr_1626
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rollover"
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_2.getFollowingStmt() instanceof ReturnStmt
}

predicate func_3(Variable verr_1626, IfStmt target_35, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1626
	and target_3.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_35.getLocation()))
}

predicate func_4(NotExpr target_37, Function func) {
exists(GotoStmt target_4 |
	target_4.getName() ="out"
	and target_4.getParent().(IfStmt).getCondition()=target_37
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable verr_1626, IfStmt target_34, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1626
	and target_5.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_34.getLocation()))
}

predicate func_6(PointerFieldAccess target_38, Function func) {
exists(GotoStmt target_6 |
	target_6.getName() ="out"
	and target_6.getParent().(IfStmt).getCondition()=target_38
	and target_6.getEnclosingFunction() = func)
}

predicate func_11(NotExpr target_39, Function func) {
exists(GotoStmt target_11 |
	target_11.getName() ="out"
	and target_11.getParent().(IfStmt).getCondition()=target_39
	and target_11.getEnclosingFunction() = func)
}

predicate func_14(LogicalOrExpr target_40, Function func) {
exists(ExprStmt target_14 |
	target_14.getExpr().(FunctionCall).getTarget().hasName("atomic_long_set")
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="num_failed"
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("packet_rollover *")
	and target_14.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(5)=target_14
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_40
	and target_14.getEnclosingFunction() = func)
}

predicate func_16(Variable vpo_1622, LogicalOrExpr target_40) {
exists(ExprStmt target_16 |
	target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_16.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("packet_rollover *")
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(6)=target_16
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_40)
}

predicate func_17(Variable verr_1626, BlockStmt target_41, ReturnStmt target_42) {
exists(LogicalAndExpr target_17 |
	target_17.getLeftOperand().(VariableAccess).getTarget()=verr_1626
	and target_17.getRightOperand().(VariableAccess).getType().hasName("packet_rollover *")
	and target_17.getParent().(IfStmt).getThen()=target_41
	and target_17.getLeftOperand().(VariableAccess).getLocation().isBefore(target_42.getExpr().(VariableAccess).getLocation()))
}

predicate func_19(Variable vpo_1622, PointerFieldAccess target_19) {
	target_19.getTarget().getName()="rollover"
	and target_19.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_19.getParent().(AssignExpr).getLValue() = target_19
	and target_19.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kzalloc")
	and target_19.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="128"
	and target_19.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="20971712"
}

predicate func_20(Function func, UnaryMinusExpr target_20) {
	target_20.getValue()="-22"
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Function func, UnaryMinusExpr target_21) {
	target_21.getValue()="-114"
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Function func, UnaryMinusExpr target_22) {
	target_22.getValue()="-12"
	and target_22.getEnclosingFunction() = func
}

predicate func_23(Variable verr_1626, BlockStmt target_41, VariableAccess target_23) {
	target_23.getTarget()=verr_1626
	and target_23.getParent().(IfStmt).getThen()=target_41
}

predicate func_24(NotExpr target_37, Function func, ReturnStmt target_24) {
	target_24.getExpr() instanceof UnaryMinusExpr
	and target_24.getParent().(IfStmt).getCondition()=target_37
	and target_24.getEnclosingFunction() = func
}

predicate func_25(PointerFieldAccess target_38, Function func, ReturnStmt target_25) {
	target_25.getExpr() instanceof UnaryMinusExpr
	and target_25.getParent().(IfStmt).getCondition()=target_38
	and target_25.getEnclosingFunction() = func
}

predicate func_26(Variable vpo_1622, NotExpr target_39, PointerFieldAccess target_26) {
	target_26.getTarget().getName()="rollover"
	and target_26.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_26.getQualifier().(VariableAccess).getLocation().isBefore(target_39.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_27(Variable vpo_1622, AddressOfExpr target_44, PointerFieldAccess target_27) {
	target_27.getTarget().getName()="rollover"
	and target_27.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_27.getQualifier().(VariableAccess).getLocation().isBefore(target_44.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_28(NotExpr target_39, Function func, ReturnStmt target_28) {
	target_28.getExpr() instanceof UnaryMinusExpr
	and target_28.getParent().(IfStmt).getCondition()=target_39
	and target_28.getEnclosingFunction() = func
}

predicate func_29(Variable vpo_1622, NotExpr target_39, AddressOfExpr target_45, PointerFieldAccess target_29) {
	target_29.getTarget().getName()="rollover"
	and target_29.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_39.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_29.getQualifier().(VariableAccess).getLocation())
	and target_29.getQualifier().(VariableAccess).getLocation().isBefore(target_45.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_30(Variable vpo_1622, AddressOfExpr target_44, AddressOfExpr target_46, PointerFieldAccess target_30) {
	target_30.getTarget().getName()="rollover"
	and target_30.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_44.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_30.getQualifier().(VariableAccess).getLocation())
	and target_30.getQualifier().(VariableAccess).getLocation().isBefore(target_46.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_31(Variable vpo_1622, AddressOfExpr target_45, ExprStmt target_47, PointerFieldAccess target_31) {
	target_31.getTarget().getName()="rollover"
	and target_31.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_45.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_31.getQualifier().(VariableAccess).getLocation())
	and target_31.getQualifier().(VariableAccess).getLocation().isBefore(target_47.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_32(Variable vpo_1622, ExprStmt target_48, ExprStmt target_49, PointerFieldAccess target_32) {
	target_32.getTarget().getName()="rollover"
	and target_32.getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_48.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_32.getQualifier().(VariableAccess).getLocation())
	and target_32.getQualifier().(VariableAccess).getLocation().isBefore(target_49.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_33(Variable vpo_1622, IfStmt target_33) {
	target_33.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_33.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_33.getThen() instanceof ReturnStmt
}

predicate func_34(Variable vpo_1622, IfStmt target_34) {
	target_34.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u8")
	and target_34.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="3"
	and target_34.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u16")
	and target_34.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4096"
	and target_34.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_34.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_34.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kzalloc")
	and target_34.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="128"
	and target_34.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="20971712"
}

predicate func_35(Variable vpo_1622, IfStmt target_35) {
	target_35.getCondition().(PointerFieldAccess).getTarget().getName()="fanout"
	and target_35.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_35.getThen() instanceof ReturnStmt
}

predicate func_37(Variable vpo_1622, NotExpr target_37) {
	target_37.getOperand().(PointerFieldAccess).getTarget().getName()="running"
	and target_37.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_38(Variable vpo_1622, PointerFieldAccess target_38) {
	target_38.getTarget().getName()="fanout"
	and target_38.getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_39(Variable vpo_1622, NotExpr target_39) {
	target_39.getOperand().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_39.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_40(Function func, LogicalOrExpr target_40) {
	target_40.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u8")
	and target_40.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="3"
	and target_40.getRightOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u16")
	and target_40.getRightOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4096"
	and target_40.getEnclosingFunction() = func
}

predicate func_41(Variable vpo_1622, BlockStmt target_41) {
	target_41.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_41.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rollover"
	and target_41.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_41.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_41.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_41.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_42(Variable verr_1626, ReturnStmt target_42) {
	target_42.getExpr().(VariableAccess).getTarget()=verr_1626
}

predicate func_44(Variable vpo_1622, AddressOfExpr target_44) {
	target_44.getOperand().(PointerFieldAccess).getTarget().getName()="num"
	and target_44.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_44.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_45(Variable vpo_1622, AddressOfExpr target_45) {
	target_45.getOperand().(PointerFieldAccess).getTarget().getName()="num_huge"
	and target_45.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_45.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_46(Variable vpo_1622, AddressOfExpr target_46) {
	target_46.getOperand().(PointerFieldAccess).getTarget().getName()="num_failed"
	and target_46.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_46.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_47(Variable vpo_1622, ExprStmt target_47) {
	target_47.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_47.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="prot_hook"
	and target_47.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("packet_fanout *")
	and target_47.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_47.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="prot_hook"
	and target_47.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
}

predicate func_48(Variable vpo_1622, ExprStmt target_48) {
	target_48.getExpr().(FunctionCall).getTarget().hasName("__fanout_link")
	and target_48.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sock *")
	and target_48.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpo_1622
}

predicate func_49(Variable vpo_1622, ExprStmt target_49) {
	target_49.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="rollover"
	and target_49.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpo_1622
	and target_49.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

from Function func, Variable vpo_1622, Variable verr_1626, Variable vfanout_mutex, ExprStmt target_0, ExprStmt target_1, IfStmt target_2, PointerFieldAccess target_19, UnaryMinusExpr target_20, UnaryMinusExpr target_21, UnaryMinusExpr target_22, VariableAccess target_23, ReturnStmt target_24, ReturnStmt target_25, PointerFieldAccess target_26, PointerFieldAccess target_27, ReturnStmt target_28, PointerFieldAccess target_29, PointerFieldAccess target_30, PointerFieldAccess target_31, PointerFieldAccess target_32, IfStmt target_33, IfStmt target_34, IfStmt target_35, NotExpr target_37, PointerFieldAccess target_38, NotExpr target_39, LogicalOrExpr target_40, BlockStmt target_41, ReturnStmt target_42, AddressOfExpr target_44, AddressOfExpr target_45, AddressOfExpr target_46, ExprStmt target_47, ExprStmt target_48, ExprStmt target_49
where
func_0(vpo_1622, target_33, target_0)
and func_1(vfanout_mutex, target_34, target_1)
and func_2(vpo_1622, verr_1626, target_2)
and not func_3(verr_1626, target_35, func)
and not func_4(target_37, func)
and not func_5(verr_1626, target_34, func)
and not func_6(target_38, func)
and not func_11(target_39, func)
and not func_14(target_40, func)
and not func_16(vpo_1622, target_40)
and not func_17(verr_1626, target_41, target_42)
and func_19(vpo_1622, target_19)
and func_20(func, target_20)
and func_21(func, target_21)
and func_22(func, target_22)
and func_23(verr_1626, target_41, target_23)
and func_24(target_37, func, target_24)
and func_25(target_38, func, target_25)
and func_26(vpo_1622, target_39, target_26)
and func_27(vpo_1622, target_44, target_27)
and func_28(target_39, func, target_28)
and func_29(vpo_1622, target_39, target_45, target_29)
and func_30(vpo_1622, target_44, target_46, target_30)
and func_31(vpo_1622, target_45, target_47, target_31)
and func_32(vpo_1622, target_48, target_49, target_32)
and func_33(vpo_1622, target_33)
and func_34(vpo_1622, target_34)
and func_35(vpo_1622, target_35)
and func_37(vpo_1622, target_37)
and func_38(vpo_1622, target_38)
and func_39(vpo_1622, target_39)
and func_40(func, target_40)
and func_41(vpo_1622, target_41)
and func_42(verr_1626, target_42)
and func_44(vpo_1622, target_44)
and func_45(vpo_1622, target_45)
and func_46(vpo_1622, target_46)
and func_47(vpo_1622, target_47)
and func_48(vpo_1622, target_48)
and func_49(vpo_1622, target_49)
and vpo_1622.getType().hasName("packet_sock *")
and verr_1626.getType().hasName("int")
and vfanout_mutex.getType().hasName("mutex")
and vpo_1622.(LocalVariable).getFunction() = func
and verr_1626.(LocalVariable).getFunction() = func
and not vfanout_mutex.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
