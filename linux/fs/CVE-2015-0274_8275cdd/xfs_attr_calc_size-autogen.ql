/**
 * @name linux-8275cdd0e7ac550dcce2b3ef6d2fb3b808c1ae59-xfs_attr_calc_size
 * @id cpp/linux/8275cdd0e7ac550dcce2b3ef6d2fb3b808c1ae59/xfs-attr-calc-size
 * @description linux-8275cdd0e7ac550dcce2b3ef6d2fb3b808c1ae59-fs/xfs/xfs_attr.c-xfs_attr_calc_size CVE-2015-0274
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvaluelen_191, Variable vmp_194) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("xfs_attr3_rmt_blocks")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vmp_194
	and target_0.getArgument(1).(VariableAccess).getTarget()=vvaluelen_191)
}

predicate func_1(Parameter vvaluelen_191, VariableAccess target_1) {
	target_1.getTarget()=vvaluelen_191
}

predicate func_2(Variable vmp_194, VariableAccess target_2) {
	target_2.getTarget()=vmp_194
}

predicate func_3(Parameter vvaluelen_191, Variable vmp_194, BinaryBitwiseOperation target_3) {
	target_3.getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vvaluelen_191
	and target_3.getLeftOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="m_blockmask"
	and target_3.getLeftOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmp_194
	and target_3.getRightOperand().(ValueFieldAccess).getTarget().getName()="sb_blocklog"
	and target_3.getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="m_sb"
	and target_3.getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmp_194
}

from Function func, Parameter vvaluelen_191, Variable vmp_194, VariableAccess target_1, VariableAccess target_2, BinaryBitwiseOperation target_3
where
not func_0(vvaluelen_191, vmp_194)
and func_1(vvaluelen_191, target_1)
and func_2(vmp_194, target_2)
and func_3(vvaluelen_191, vmp_194, target_3)
and vvaluelen_191.getType().hasName("int")
and vmp_194.getType().hasName("xfs_mount *")
and vvaluelen_191.getFunction() = func
and vmp_194.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
