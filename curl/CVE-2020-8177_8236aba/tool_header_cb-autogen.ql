/**
 * @name curl-8236aba58542c5f-tool_header_cb
 * @id cpp/curl/8236aba58542c5f/tool-header-cb
 * @description curl-8236aba58542c5f-src/tool_cb_hdr.c-tool_header_cb CVE-2020-8177
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vouts_60, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="filename"
		and target_0.getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_0.getParent().(AssignExpr).getLValue() = target_0
		and target_0.getParent().(AssignExpr).getRValue() instanceof Literal
}

predicate func_1(PointerFieldAccess target_11, Function func, DeclStmt target_1) {
		target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vouts_60, PointerFieldAccess target_11, IfStmt target_2) {
		target_2.getCondition().(PointerFieldAccess).getTarget().getName()="fopened"
		and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_2.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("fclose")
		and target_2.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="stream"
		and target_2.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

predicate func_3(Variable vouts_60, PointerFieldAccess target_11, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="stream"
		and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_3.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

predicate func_4(Variable vouts_60, Variable vfilename_166, Variable vrc_189, PointerFieldAccess target_11, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_189
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rename")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="filename"
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vfilename_166
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

predicate func_5(Variable vper_58, Variable vouts_60, Variable vfilename_166, Variable vrc_189, PointerFieldAccess target_11, IfStmt target_5) {
		target_5.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vrc_189
		and target_5.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("warnf")
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="global"
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="config"
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vper_58
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Failed to rename %s -> %s: %s\n"
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="filename"
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vfilename_166
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getTarget().hasName("strerror")
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(PointerDereferenceExpr).getOperand().(FunctionCall).getTarget().hasName("__errno_location")
		and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

/*predicate func_6(Variable vper_58, Variable vouts_60, Variable vfilename_166, EqualityOperation target_12, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("warnf")
		and target_6.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="global"
		and target_6.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="config"
		and target_6.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vper_58
		and target_6.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Failed to rename %s -> %s: %s\n"
		and target_6.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="filename"
		and target_6.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_6.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vfilename_166
		and target_6.getExpr().(FunctionCall).getArgument(4).(FunctionCall).getTarget().hasName("strerror")
		and target_6.getExpr().(FunctionCall).getArgument(4).(FunctionCall).getArgument(0).(PointerDereferenceExpr).getOperand().(FunctionCall).getTarget().hasName("__errno_location")
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
predicate func_7(Variable vouts_60, PointerFieldAccess target_11, IfStmt target_7) {
		target_7.getCondition().(PointerFieldAccess).getTarget().getName()="alloc_filename"
		and target_7.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_7.getThen().(DoStmt).getCondition().(Literal).getValue()="0"
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("free")
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="filename"
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="filename"
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

/*predicate func_8(Variable vouts_60, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("free")
		and target_8.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="filename"
		and target_8.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
}

*/
/*predicate func_9(Variable vouts_60, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="filename"
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vouts_60
		and target_9.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

*/
predicate func_10(Variable vfailure_74, Variable vfilename_166, Variable vrc_189, PointerFieldAccess target_11, IfStmt target_10) {
		target_10.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vrc_189
		and target_10.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("free")
		and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfilename_166
		and target_10.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(VariableAccess).getTarget()=vfailure_74
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
}

predicate func_11(Variable vouts_60, PointerFieldAccess target_11) {
		target_11.getTarget().getName()="stream"
		and target_11.getQualifier().(VariableAccess).getTarget()=vouts_60
}

predicate func_12(Variable vrc_189, EqualityOperation target_12) {
		target_12.getAnOperand().(VariableAccess).getTarget()=vrc_189
		and target_12.getAnOperand() instanceof Literal
}

from Function func, Variable vper_58, Variable vouts_60, Variable vfailure_74, Variable vfilename_166, Variable vrc_189, PointerFieldAccess target_0, DeclStmt target_1, IfStmt target_2, ExprStmt target_3, ExprStmt target_4, IfStmt target_5, IfStmt target_7, IfStmt target_10, PointerFieldAccess target_11, EqualityOperation target_12
where
func_0(vouts_60, target_0)
and func_1(target_11, func, target_1)
and func_2(vouts_60, target_11, target_2)
and func_3(vouts_60, target_11, target_3)
and func_4(vouts_60, vfilename_166, vrc_189, target_11, target_4)
and func_5(vper_58, vouts_60, vfilename_166, vrc_189, target_11, target_5)
and func_7(vouts_60, target_11, target_7)
and func_10(vfailure_74, vfilename_166, vrc_189, target_11, target_10)
and func_11(vouts_60, target_11)
and func_12(vrc_189, target_12)
and vper_58.getType().hasName("per_transfer *")
and vouts_60.getType().hasName("OutStruct *")
and vfailure_74.getType().hasName("size_t")
and vfilename_166.getType().hasName("char *")
and vrc_189.getType().hasName("int")
and vper_58.(LocalVariable).getFunction() = func
and vouts_60.(LocalVariable).getFunction() = func
and vfailure_74.(LocalVariable).getFunction() = func
and vfilename_166.(LocalVariable).getFunction() = func
and vrc_189.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
