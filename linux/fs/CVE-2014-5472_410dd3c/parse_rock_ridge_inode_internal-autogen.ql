/**
 * @name linux-410dd3cf4c9b36f27ed4542ee18b1af5e68645a4-parse_rock_ridge_inode_internal
 * @id cpp/linux/410dd3cf4c9b36f27ed4542ee18b1af5e68645a4/parse-rock-ridge-inode-internal
 * @description linux-410dd3cf4c9b36f27ed4542ee18b1af5e68645a4-fs/isofs/rock.c-parse_rock_ridge_inode_internal CVE-2014-5472
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vregard_xa_293, BlockStmt target_11, VariableAccess target_0) {
	target_0.getTarget()=vregard_xa_293
	and vregard_xa_293.getIndex() = 2
	and target_0.getParent().(IfStmt).getThen()=target_11
}

predicate func_1(Parameter vinode_293, Variable vreloc_297, FunctionCall target_1) {
	target_1.getTarget().hasName("isofs_iget")
	and not target_1.getTarget().hasName("isofs_iget_reloc")
	and target_1.getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
	and target_1.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_293
	and target_1.getArgument(1).(PointerFieldAccess).getTarget().getName()="i_first_extent"
	and target_1.getArgument(1).(PointerFieldAccess).getQualifier() instanceof FunctionCall
	and target_1.getArgument(2).(Literal).getValue()="0"
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreloc_297
}

predicate func_2(BlockStmt target_11, Function func) {
exists(BitwiseAndExpr target_2 |
	target_2.getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_2.getRightOperand().(Literal).getValue()="1"
	and target_2.getParent().(IfStmt).getThen()=target_11
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(VariableAccess target_12, Function func) {
exists(IfStmt target_3 |
	target_3.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_3.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="2"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="3ISOFS: Recursive directory relocation is not supported\n"
	and target_3.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="eio"
	and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_12
	and target_3.getEnclosingFunction() = func)
}

predicate func_5(Parameter vinode_293, VariableAccess target_12, ExprStmt target_13) {
exists(IfStmt target_5 |
	target_5.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_5.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="i_iget5_block"
	and target_5.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier() instanceof FunctionCall
	and target_5.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_iget5_offset"
	and target_5.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ISOFS_I")
	and target_5.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_293
	and target_5.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="3ISOFS: Directory relocation points to itself\n"
	and target_5.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="eio"
	and target_5.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_12
	and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_5.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(Parameter vinode_293, ExprStmt target_15) {
exists(AssignExpr target_6 |
	target_6.getLValue().(PointerFieldAccess).getTarget().getName()="i_first_extent"
	and target_6.getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ISOFS_I")
	and target_6.getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_293
	and target_6.getRValue().(VariableAccess).getType().hasName("unsigned int")
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_7(Parameter vinode_293, Variable vreloc_297, VariableAccess target_12, FunctionCall target_18) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreloc_297
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("isofs_iget_reloc")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="i_sb"
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_293
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned int")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_12
	and target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_18.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_9(Parameter vinode_293, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="i_first_extent"
	and target_9.getQualifier().(FunctionCall).getTarget().hasName("ISOFS_I")
	and target_9.getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_293
	and target_9.getParent().(AssignExpr).getLValue() = target_9
	and target_9.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("isonum_733")
	and target_9.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="location"
	and target_9.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="CL"
	and target_9.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_9.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rock_ridge *")
}

predicate func_10(Parameter vinode_293, FunctionCall target_10) {
	target_10.getTarget().hasName("ISOFS_I")
	and target_10.getArgument(0).(VariableAccess).getTarget()=vinode_293
	and target_10.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_11(Function func, BlockStmt target_11) {
	target_11.getStmt(0).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="chr"
	and target_11.getStmt(0).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rock_state")
	and target_11.getStmt(0).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="14"
	and target_11.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getTarget().getName()="len"
	and target_11.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rock_state")
	and target_11.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(Literal).getValue()="14"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vsig_296, VariableAccess target_12) {
	target_12.getTarget()=vsig_296
}

predicate func_13(Parameter vinode_293, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="i_first_extent"
	and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("ISOFS_I")
	and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_293
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("isonum_733")
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="location"
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="CL"
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rock_ridge *")
}

predicate func_15(Parameter vinode_293, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="i_size"
	and target_15.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_293
}

predicate func_18(Variable vreloc_297, FunctionCall target_18) {
	target_18.getTarget().hasName("IS_ERR")
	and target_18.getArgument(0).(VariableAccess).getTarget()=vreloc_297
}

from Function func, Parameter vinode_293, Parameter vregard_xa_293, Variable vsig_296, Variable vreloc_297, VariableAccess target_0, FunctionCall target_1, PointerFieldAccess target_9, FunctionCall target_10, BlockStmt target_11, VariableAccess target_12, ExprStmt target_13, ExprStmt target_15, FunctionCall target_18
where
func_0(vregard_xa_293, target_11, target_0)
and func_1(vinode_293, vreloc_297, target_1)
and not func_2(target_11, func)
and not func_3(target_12, func)
and not func_5(vinode_293, target_12, target_13)
and not func_6(vinode_293, target_15)
and not func_7(vinode_293, vreloc_297, target_12, target_18)
and func_9(vinode_293, target_9)
and func_10(vinode_293, target_10)
and func_11(func, target_11)
and func_12(vsig_296, target_12)
and func_13(vinode_293, target_13)
and func_15(vinode_293, target_15)
and func_18(vreloc_297, target_18)
and vinode_293.getType().hasName("inode *")
and vregard_xa_293.getType().hasName("int")
and vsig_296.getType().hasName("int")
and vreloc_297.getType().hasName("inode *")
and vinode_293.getFunction() = func
and vregard_xa_293.getFunction() = func
and vsig_296.(LocalVariable).getFunction() = func
and vreloc_297.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
