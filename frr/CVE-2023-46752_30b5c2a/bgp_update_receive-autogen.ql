/**
 * @name frr-30b5c2a434d25981e16792f6f50162beb517ae4d-bgp_update_receive
 * @id cpp/frr/30b5c2a434d25981e16792f6f50162beb517ae4d/bgp-update-receive
 * @description frr-30b5c2a434d25981e16792f6f50162beb517ae4d-bgpd/bgp_packet.c-bgp_update_receive CVE-2023-46752
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vupdate_len_1842, Variable vwithdraw_len_1843, Variable vnlris_1853, BlockStmt target_5, LogicalAndExpr target_0) {
		target_0.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vupdate_len_1842
		and target_0.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vwithdraw_len_1843
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getTarget().getName()="length"
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_1853
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_0.getParent().(LogicalOrExpr).getAnOperand() instanceof EqualityOperation
		and target_0.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_5
}

predicate func_1(Variable vattr_parse_ret_1944, BlockStmt target_5, LogicalOrExpr target_1) {
		target_1.getAnOperand() instanceof LogicalAndExpr
		and target_1.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_1944
		and target_1.getParent().(IfStmt).getThen()=target_5
}

predicate func_2(Variable vnlris_1853, Variable vattr_parse_ret_1944, Variable vafi_2065, Variable vsafi_2066, NotExpr target_6, IfStmt target_2) {
		target_2.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_1944
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vafi_2065
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="afi"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_1853
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsafi_2066
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="safi"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_1853
		and target_2.getParent().(IfStmt).getParent().(IfStmt).getCondition()=target_6
}

/*predicate func_3(Variable vnlris_1853, Variable vafi_2065, EqualityOperation target_7, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vafi_2065
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="afi"
		and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_1853
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
/*predicate func_4(Variable vnlris_1853, Variable vsafi_2066, EqualityOperation target_7, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsafi_2066
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="safi"
		and target_4.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnlris_1853
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

*/
predicate func_5(Function func, BlockStmt target_5) {
		target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("peer *")
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="32"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("peer *")
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="64"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cap"
		and target_5.getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("bool")
		and target_5.getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Function func, NotExpr target_6) {
		target_6.getOperand().(VariableAccess).getTarget().getType().hasName("bgp_size_t")
		and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vattr_parse_ret_1944, BlockStmt target_8, EqualityOperation target_7) {
		target_7.getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_1944
		and target_7.getAnOperand() instanceof EnumConstantAccess
		and target_7.getParent().(IfStmt).getThen()=target_8
}

predicate func_8(Function func, BlockStmt target_8) {
		target_8.getStmt(0) instanceof ExprStmt
		and target_8.getStmt(1) instanceof ExprStmt
		and target_8.getEnclosingFunction() = func
}

from Function func, Variable vupdate_len_1842, Variable vwithdraw_len_1843, Variable vnlris_1853, Variable vattr_parse_ret_1944, Variable vafi_2065, Variable vsafi_2066, LogicalAndExpr target_0, LogicalOrExpr target_1, IfStmt target_2, BlockStmt target_5, NotExpr target_6, EqualityOperation target_7, BlockStmt target_8
where
func_0(vupdate_len_1842, vwithdraw_len_1843, vnlris_1853, target_5, target_0)
and func_1(vattr_parse_ret_1944, target_5, target_1)
and func_2(vnlris_1853, vattr_parse_ret_1944, vafi_2065, vsafi_2066, target_6, target_2)
and func_5(func, target_5)
and func_6(func, target_6)
and func_7(vattr_parse_ret_1944, target_8, target_7)
and func_8(func, target_8)
and vupdate_len_1842.getType().hasName("bgp_size_t")
and vwithdraw_len_1843.getType().hasName("bgp_size_t")
and vnlris_1853.getType().hasName("bgp_nlri[4]")
and vattr_parse_ret_1944.getType().hasName("bgp_attr_parse_ret")
and vafi_2065.getType().hasName("afi_t")
and vsafi_2066.getType().hasName("safi_t")
and vupdate_len_1842.(LocalVariable).getFunction() = func
and vwithdraw_len_1843.(LocalVariable).getFunction() = func
and vnlris_1853.(LocalVariable).getFunction() = func
and vattr_parse_ret_1944.(LocalVariable).getFunction() = func
and vafi_2065.(LocalVariable).getFunction() = func
and vsafi_2066.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
