/**
 * @name linux-55667441c84fa5e0911a0aac44fb059c15ba6da2-__flow_hash_from_keys
 * @id cpp/linux/55667441c84fa5e0911a0aac44fb059c15ba6da2/--flow-hash-from-keys
 * @description linux-55667441c84fa5e0911a0aac44fb059c15ba6da2-__flow_hash_from_keys CVE-2019-18282
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkeyval_1457) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("siphash")
		and target_0.getArgument(0) instanceof FunctionCall
		and target_0.getArgument(1) instanceof FunctionCall
		and target_0.getArgument(2).(VariableAccess).getTarget()=vkeyval_1457
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u32"))
}

predicate func_1(Parameter vkeys_1457, FunctionCall target_1) {
		target_1.getTarget().hasName("flow_keys_hash_length")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vkeys_1457
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_2(Parameter vkeys_1457, FunctionCall target_2) {
		target_2.getTarget().hasName("flow_keys_hash_start")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vkeys_1457
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_3(Parameter vkeyval_1457, FunctionCall target_3) {
		target_3.getTarget().hasName("__flow_hash_words")
		and target_3.getArgument(0) instanceof FunctionCall
		and target_3.getArgument(1) instanceof FunctionCall
		and target_3.getArgument(2).(VariableAccess).getTarget()=vkeyval_1457
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u32")
}

from Function func, Parameter vkeys_1457, Parameter vkeyval_1457, FunctionCall target_1, FunctionCall target_2, FunctionCall target_3
where
not func_0(vkeyval_1457)
and func_1(vkeys_1457, target_1)
and func_2(vkeys_1457, target_2)
and func_3(vkeyval_1457, target_3)
and vkeys_1457.getType().hasName("flow_keys *")
and vkeyval_1457.getType().hasName("u32")
and vkeys_1457.getFunction() = func
and vkeyval_1457.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
