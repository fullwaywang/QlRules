/**
 * @name chromium-8c4aee2a90d08535cfb1bf0a59e00cae956b1762-content__RenderFrameDevToolsAgentHost__DestroyOnRenderFrameGone
 * @id cpp/chromium/8c4aee2a90d08535cfb1bf0a59e00cae956b1762/contentrenderframedevtoolsagenthostdestroyonrenderframegone
 * @description chromium-8c4aee2a90d08535cfb1bf0a59e00cae956b1762-content/browser/devtools/render_frame_devtools_agent_host.cc-content__RenderFrameDevToolsAgentHost__DestroyOnRenderFrameGone CVE-2023-2135
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(ConstructorCall).getArgument(0) instanceof ThisExpr
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_2(Function func) {
exists(FunctionCall target_2 |
	exists(FunctionCall obj_0 | obj_0=target_2.getArgument(0) |
		obj_0.getTarget().hasName("ForceDetachAllSessionsImpl")
		and obj_0.getQualifier() instanceof ThisExpr
	)
	and target_2.getTarget().hasName("operator=")
	and target_2.getQualifier().(VariableAccess).getType().hasName("scoped_refptr<DevToolsAgentHost>")
	and target_2.getEnclosingFunction() = func
)
}

predicate func_4(Function func, ThisExpr target_4) {
	target_4.getType() instanceof PointerType
	and target_4.getEnclosingFunction() = func
}

predicate func_6(Function func, ThisExpr target_6) {
	target_6.getType() instanceof PointerType
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Function func, FunctionCall target_7) {
	target_7.getTarget().hasName("ForceDetachAllSessions")
	and target_7.getQualifier() instanceof ThisExpr
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Variable vprotect_564, VariableAccess target_8) {
	target_8.getTarget()=vprotect_564
}

from Function func, Variable vprotect_564, Initializer target_0, ThisExpr target_4, ThisExpr target_6, FunctionCall target_7, VariableAccess target_8
where
func_0(func, target_0)
and not func_2(func)
and func_4(func, target_4)
and func_6(func, target_6)
and func_7(func, target_7)
and func_8(vprotect_564, target_8)
and vprotect_564.getType().hasName("scoped_refptr<RenderFrameDevToolsAgentHost>")
and vprotect_564.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
