/**
 * @name linux-7bfac9ecf0585962fe13584f5cf526d8c8e76f17-ocfs2_file_splice_write
 * @id cpp/linux/7bfac9ecf0585962fe13584f5cf526d8c8e76f17/ocfs2-file-splice-write
 * @description linux-7bfac9ecf0585962fe13584f5cf526d8c8e76f17-fs/ocfs2/file.c-ocfs2_file_splice_write CVE-2009-1961
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpipe_1915, Variable vinode_1922, FunctionCall target_0) {
		target_0.getTarget().hasName("inode_double_lock")
		and not target_0.getTarget().hasName("mutex_lock_nested")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vinode_1922
		and target_0.getArgument(1).(PointerFieldAccess).getTarget().getName()="inode"
		and target_0.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
}

predicate func_1(Parameter vpipe_1915, Variable vinode_1922, FunctionCall target_1) {
		target_1.getTarget().hasName("inode_double_unlock")
		and not target_1.getTarget().hasName("mutex_lock_nested")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vinode_1922
		and target_1.getArgument(1).(PointerFieldAccess).getTarget().getName()="inode"
		and target_1.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
}

predicate func_2(Variable vinode_1922, ExprStmt target_15) {
	exists(AddressOfExpr target_2 |
		target_2.getOperand().(PointerFieldAccess).getTarget().getName()="i_mutex"
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1922
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Parameter vpipe_1915, ExprStmt target_16, Function func) {
	exists(IfStmt target_4 |
		target_4.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_4.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="inode"
		and target_4.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_4.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="inode"
		and target_4.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_4.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_4.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("int")
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mutex"
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="inode"
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_16.getExpr().(FunctionCall).getArgument(6).(VariableAccess).getLocation().isBefore(target_4.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_5(Parameter vpipe_1915) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(VariableAccess).getType().hasName("int")
		and target_5.getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="inode"
		and target_5.getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915)
}

*/
/*predicate func_6(Parameter vpipe_1915) {
	exists(AddressOfExpr target_6 |
		target_6.getOperand().(PointerFieldAccess).getTarget().getName()="i_mutex"
		and target_6.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="inode"
		and target_6.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall)
}

*/
predicate func_8(Parameter vpipe_1915, ExprStmt target_19, Function func) {
	exists(IfStmt target_8 |
		target_8.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
		and target_8.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="inode"
		and target_8.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_8.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="inode"
		and target_8.getCondition().(ConditionalExpr).getThen().(NotExpr).getOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_8.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_8.getCondition().(ConditionalExpr).getElse().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("int")
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mutex"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="inode"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_8.getCondition().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Variable vinode_1922, ExprStmt target_20, Function func) {
	exists(ExprStmt target_9 |
		target_9.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mutex"
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_1922
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
		and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_10(Parameter vpipe_1915, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="inode"
		and target_10.getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_11(Parameter vpipe_1915, PointerFieldAccess target_11) {
		target_11.getTarget().getName()="inode"
		and target_11.getQualifier().(VariableAccess).getTarget()=vpipe_1915
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_12(Variable vinode_1922, VariableAccess target_12) {
		target_12.getTarget()=vinode_1922
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_13(Variable vinode_1922, VariableAccess target_13) {
		target_13.getTarget()=vinode_1922
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_15(Variable vinode_1922, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ocfs2_rw_lock")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1922
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="1"
}

predicate func_16(Parameter vpipe_1915, ExprStmt target_16) {
		target_16.getExpr().(FunctionCall).getTarget().hasName("printk")
		and target_16.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="<6>(%u,%lu):%s:%d ENTRY:(0x%p, 0x%p, %u, '%.*s')\n"
		and target_16.getExpr().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("task_pid_nr")
		and target_16.getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("get_current")
		and target_16.getExpr().(FunctionCall).getArgument(2).(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
		and target_16.getExpr().(FunctionCall).getArgument(2).(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_16.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType() instanceof ArrayType
		and target_16.getExpr().(FunctionCall).getArgument(4) instanceof Literal
		and target_16.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("file *")
		and target_16.getExpr().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vpipe_1915
		and target_16.getExpr().(FunctionCall).getArgument(7).(VariableAccess).getTarget().getType().hasName("size_t")
		and target_16.getExpr().(FunctionCall).getArgument(8).(ValueFieldAccess).getTarget().getName()="len"
		and target_16.getExpr().(FunctionCall).getArgument(8).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d_name"
		and target_16.getExpr().(FunctionCall).getArgument(8).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dentry"
		and target_16.getExpr().(FunctionCall).getArgument(8).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="f_path"
		and target_16.getExpr().(FunctionCall).getArgument(8).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("file *")
		and target_16.getExpr().(FunctionCall).getArgument(9).(ValueFieldAccess).getTarget().getName()="name"
		and target_16.getExpr().(FunctionCall).getArgument(9).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d_name"
		and target_16.getExpr().(FunctionCall).getArgument(9).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="dentry"
		and target_16.getExpr().(FunctionCall).getArgument(9).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="f_path"
		and target_16.getExpr().(FunctionCall).getArgument(9).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("file *")
}

predicate func_19(Parameter vpipe_1915, ExprStmt target_19) {
		target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("generic_file_splice_write_nolock")
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpipe_1915
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("file *")
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("loff_t *")
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("size_t")
		and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_20(Variable vinode_1922, ExprStmt target_20) {
		target_20.getExpr().(FunctionCall).getTarget().hasName("ocfs2_rw_unlock")
		and target_20.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_1922
		and target_20.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
}

from Function func, Parameter vpipe_1915, Variable vinode_1922, FunctionCall target_0, FunctionCall target_1, PointerFieldAccess target_10, PointerFieldAccess target_11, VariableAccess target_12, VariableAccess target_13, ExprStmt target_15, ExprStmt target_16, ExprStmt target_19, ExprStmt target_20
where
func_0(vpipe_1915, vinode_1922, target_0)
and func_1(vpipe_1915, vinode_1922, target_1)
and not func_2(vinode_1922, target_15)
and not func_4(vpipe_1915, target_16, func)
and not func_8(vpipe_1915, target_19, func)
and not func_9(vinode_1922, target_20, func)
and func_10(vpipe_1915, target_10)
and func_11(vpipe_1915, target_11)
and func_12(vinode_1922, target_12)
and func_13(vinode_1922, target_13)
and func_15(vinode_1922, target_15)
and func_16(vpipe_1915, target_16)
and func_19(vpipe_1915, target_19)
and func_20(vinode_1922, target_20)
and vpipe_1915.getType().hasName("pipe_inode_info *")
and vinode_1922.getType().hasName("inode *")
and vpipe_1915.getFunction() = func
and vinode_1922.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
