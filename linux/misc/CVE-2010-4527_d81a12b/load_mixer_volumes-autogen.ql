/**
 * @name linux-d81a12bc29ae4038770e05dce4ab7f26fd5880fb-load_mixer_volumes
 * @id cpp/linux/d81a12bc29ae4038770e05dce4ab7f26fd5880fb/load-mixer-volumes
 * @description linux-d81a12bc29ae4038770e05dce4ab7f26fd5880fb-sound/oss/soundcard.c-load_mixer_volumes CVE-2010-4527
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_87, Variable vmixer_vols, Parameter vname_85, BlockStmt target_4, FunctionCall target_0) {
		target_0.getTarget().hasName("strcmp")
		and not target_0.getTarget().hasName("strncmp")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vname_85
		and target_0.getArgument(1).(ValueFieldAccess).getTarget().getName()="name"
		and target_0.getArgument(1).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vmixer_vols
		and target_0.getArgument(1).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
		and target_0.getParent().(EQExpr).getAnOperand().(Literal).getValue()="0"
		and target_0.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_4
}

predicate func_1(Variable vn_87, Variable vmixer_vols, Parameter vname_85, FunctionCall target_1) {
		target_1.getTarget().hasName("strcpy")
		and not target_1.getTarget().hasName("strncpy")
		and target_1.getArgument(0).(ValueFieldAccess).getTarget().getName()="name"
		and target_1.getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vmixer_vols
		and target_1.getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vn_87
		and target_1.getArgument(1).(VariableAccess).getTarget()=vname_85
}

predicate func_4(Variable vi_87, Variable vmixer_vols, BlockStmt target_4) {
		target_4.getStmt(0).(IfStmt).getCondition().(VariableAccess).getTarget().getType().hasName("int")
		and target_4.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="num"
		and target_4.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vmixer_vols
		and target_4.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_87
		and target_4.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vi_87
}

from Function func, Variable vi_87, Variable vn_87, Variable vmixer_vols, Parameter vname_85, FunctionCall target_0, FunctionCall target_1, BlockStmt target_4
where
func_0(vi_87, vmixer_vols, vname_85, target_4, target_0)
and func_1(vn_87, vmixer_vols, vname_85, target_1)
and func_4(vi_87, vmixer_vols, target_4)
and vi_87.getType().hasName("int")
and vn_87.getType().hasName("int")
and vmixer_vols.getType() instanceof ArrayType
and vname_85.getType().hasName("char *")
and vi_87.(LocalVariable).getFunction() = func
and vn_87.(LocalVariable).getFunction() = func
and not vmixer_vols.getParentScope+() = func
and vname_85.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
