/**
 * @name linux-75a493e60ac4bbe2e977e7129d6d8cbb0dd236be-ip6_append_data_mtu
 * @id cpp/linux/75a493e60ac4bbe2e977e7129d6d8cbb0dd236be/ip6-append-data-mtu
 * @description linux-75a493e60ac4bbe2e977e7129d6d8cbb0dd236be-net/ipv6/ip6_output.c-ip6_append_data_mtu CVE-2013-4163
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AssignExpr target_0 |
	target_0.getLValue() instanceof PointerDereferenceExpr
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("unsigned int")
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Parameter vrt_1100, Parameter vmtu_1096, FunctionCall target_1) {
	target_1.getTarget().hasName("dst_mtu")
	and target_1.getArgument(0).(ValueFieldAccess).getTarget().getName()="path"
	and target_1.getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dst"
	and target_1.getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrt_1100
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vmtu_1096
}

/*predicate func_2(Parameter vrt_1100, Parameter vmtu_1096, PointerDereferenceExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vmtu_1096
	and target_2.getParent().(AssignExpr).getLValue() = target_2
	and target_2.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dst_mtu")
	and target_2.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="path"
	and target_2.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dst"
	and target_2.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrt_1100
}

*/
predicate func_3(Function func, AssignExpr target_3) {
	target_3.getLValue() instanceof PointerDereferenceExpr
	and target_3.getRValue() instanceof FunctionCall
	and target_3.getEnclosingFunction() = func
}

from Function func, Parameter vrt_1100, Parameter vmtu_1096, FunctionCall target_1, AssignExpr target_3
where
not func_0(func)
and func_1(vrt_1100, vmtu_1096, target_1)
and func_3(func, target_3)
and vrt_1100.getType().hasName("rt6_info *")
and vmtu_1096.getType().hasName("int *")
and vrt_1100.getFunction() = func
and vmtu_1096.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
