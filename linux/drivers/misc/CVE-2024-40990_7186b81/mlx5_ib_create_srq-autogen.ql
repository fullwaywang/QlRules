/**
 * @name linux-7186b81c1f15e39069b1af172c6a951728ed3511-mlx5_ib_create_srq
 * @id cpp/linux/7186b81c1f15e39069b1af172c6a951728ed3511/mlx5-ib-create-srq
 * @description linux-7186b81c1f15e39069b1af172c6a951728ed3511-drivers/infiniband/hw/mlx5/srq.c-mlx5_ib_create_srq CVE-2024-40990
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, StringLiteral target_0) {
	target_0.getValue()="%s:%d:(pid %d): max_wr %d, cap %d\n"
	and not target_0.getValue()="%s:%d:(pid %d): max_wr %d,wr_cap %d,max_sge %d, sge_cap:%d\n"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, StringLiteral target_1) {
	target_1.getValue()="%s:%d:(pid %d): max_wr %d, cap %d\n"
	and not target_1.getValue()="%s:%d:(pid %d): max_wr %d,wr_cap %d,max_sge %d, sge_cap:%d\n"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Parameter vinit_attr_218, BlockStmt target_6, RelationalOperation target_5) {
exists(LogicalOrExpr target_2 |
	exists(RelationalOperation obj_0 | obj_0=target_2.getRightOperand() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getGreaterOperand() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="attr"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vinit_attr_218
			)
			and obj_1.getTarget().getName()="max_sge"
		)
		and obj_0.getLesserOperand().(VariableAccess).getType().hasName("__u32")
	)
	and target_2.getLeftOperand() instanceof RelationalOperation
	and target_2.getParent().(IfStmt).getThen()=target_6
	and target_2.getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getGreaterOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_3(Parameter vinit_attr_218, ValueFieldAccess target_7, AddExpr target_8) {
exists(ValueFieldAccess target_3 |
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getQualifier() |
		obj_0.getTarget().getName()="attr"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinit_attr_218
	)
	and target_3.getTarget().getName()="max_sge"
	and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_5(Parameter vinit_attr_218, Variable vmax_srq_wqes_227, BlockStmt target_6, RelationalOperation target_5) {
	exists(ValueFieldAccess obj_0 | obj_0=target_5.getGreaterOperand() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="attr"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vinit_attr_218
		)
		and obj_0.getTarget().getName()="max_wr"
	)
	and  (target_5 instanceof GEExpr or target_5 instanceof LEExpr)
	and target_5.getLesserOperand().(VariableAccess).getTarget()=vmax_srq_wqes_227
	and target_5.getParent().(IfStmt).getThen()=target_6
}

predicate func_6(Variable vmax_srq_wqes_227, BlockStmt target_6) {
	exists(DoStmt obj_0 | obj_0=target_6.getStmt(0) |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(IfStmt obj_2 | obj_2=obj_1.getStmt(1) |
				exists(ExprStmt obj_3 | obj_3=obj_2.getThen() |
					exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
						obj_4.getTarget().hasName("__dynamic_dev_dbg")
						and obj_4.getArgument(2) instanceof StringLiteral
						and obj_4.getArgument(3).(VariableAccess).getTarget().getType() instanceof ArrayType
						and obj_4.getArgument(4) instanceof Literal
						and obj_4.getArgument(5).(PointerFieldAccess).getTarget().getName()="pid"
						and obj_4.getArgument(6).(ValueFieldAccess).getTarget().getName()="max_wr"
						and obj_4.getArgument(7).(VariableAccess).getTarget()=vmax_srq_wqes_227
					)
				)
			)
		)
		and obj_0.getCondition() instanceof Literal
	)
}

predicate func_7(Parameter vinit_attr_218, ValueFieldAccess target_7) {
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getQualifier() |
		obj_0.getTarget().getName()="attr"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vinit_attr_218
	)
	and target_7.getTarget().getName()="max_wr"
}

predicate func_8(Parameter vinit_attr_218, AddExpr target_8) {
	exists(ValueFieldAccess obj_0 | obj_0=target_8.getLeftOperand() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="attr"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vinit_attr_218
		)
		and obj_0.getTarget().getName()="max_wr"
	)
	and target_8.getRightOperand().(Literal).getValue()="1"
}

from Function func, Parameter vinit_attr_218, Variable vmax_srq_wqes_227, StringLiteral target_0, StringLiteral target_1, RelationalOperation target_5, BlockStmt target_6, ValueFieldAccess target_7, AddExpr target_8
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_2(vinit_attr_218, target_6, target_5)
and not func_3(vinit_attr_218, target_7, target_8)
and func_5(vinit_attr_218, vmax_srq_wqes_227, target_6, target_5)
and func_6(vmax_srq_wqes_227, target_6)
and func_7(vinit_attr_218, target_7)
and func_8(vinit_attr_218, target_8)
and vinit_attr_218.getType().hasName("ib_srq_init_attr *")
and vmax_srq_wqes_227.getType().hasName("__u32")
and vinit_attr_218.getFunction() = func
and vmax_srq_wqes_227.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
