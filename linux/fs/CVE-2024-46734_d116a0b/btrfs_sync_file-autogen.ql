/**
 * @name linux-d116a0b0e02f395cedfb8c725bd67480aa7c428c-btrfs_sync_file
 * @id cpp/linux/d116a0b0e02f395cedfb8c725bd67480aa7c428c/btrfs-sync-file
 * @description linux-d116a0b0e02f395cedfb8c725bd67480aa7c428c-fs/btrfs/file.c-btrfs_sync_file CVE-2024-46734
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfile_2196, Initializer target_0) {
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getExpr() |
		obj_0.getTarget().getName()="private_data"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vfile_2196
	)
}

predicate func_2(Variable vskip_ilock_1_2208, Function func) {
exists(IfStmt target_2 |
	exists(EqualityOperation obj_0 | obj_0=target_2.getCondition() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLeftOperand() |
			obj_1.getTarget().getName()="journal_info"
			and obj_1.getQualifier().(FunctionCall).getTarget().hasName("get_current")
		)
		and obj_0.getRightOperand().(Literal).getValue()="1"
	)
	and exists(BlockStmt obj_2 | obj_2=target_2.getThen() |
		exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(1) |
			exists(AssignExpr obj_4 | obj_4=obj_3.getExpr() |
				exists(PointerFieldAccess obj_5 | obj_5=obj_4.getLValue() |
					obj_5.getTarget().getName()="journal_info"
					and obj_5.getQualifier().(FunctionCall).getTarget().hasName("get_current")
				)
				and obj_4.getRValue().(Literal).getValue()="0"
			)
		)
		and obj_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vskip_ilock_1_2208
		and obj_2.getStmt(2).(DoStmt).getCondition() instanceof Literal
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getFollowingStmt() instanceof DeclStmt
)
}

/*predicate func_3(Function func) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("get_current")
	and target_3.getEnclosingFunction() = func
)
}

*/
/*predicate func_5(Function func) {
exists(NotExpr target_5 |
	exists(NotExpr obj_0 | obj_0=target_5.getOperand() |
		exists(LogicalAndExpr obj_1 | obj_1=obj_0.getOperand() |
			exists(NotExpr obj_2 | obj_2=obj_1.getRightOperand() |
				exists(EqualityOperation obj_3 | obj_3=obj_2.getOperand() |
					obj_3.getLeftOperand().(FunctionCall).getTarget().hasName("lock_is_held")
					and obj_3.getRightOperand() instanceof Literal
				)
			)
			and obj_1.getLeftOperand().(VariableAccess).getType().hasName("int")
		)
	)
	and target_5.getEnclosingFunction() = func
)
}

*/
predicate func_9(Variable vprivate_2198, ConditionalExpr target_9) {
	exists(PointerFieldAccess obj_0 | obj_0=target_9.getThen() |
		obj_0.getTarget().getName()="fsync_skip_inode_lock"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprivate_2198
	)
	and target_9.getCondition().(VariableAccess).getTarget()=vprivate_2198
	and target_9.getElse() instanceof EnumConstantAccess
}

from Function func, Parameter vfile_2196, Variable vprivate_2198, Variable vskip_ilock_1_2208, Initializer target_0, ConditionalExpr target_9
where
func_0(vfile_2196, target_0)
and not func_2(vskip_ilock_1_2208, func)
and func_9(vprivate_2198, target_9)
and vfile_2196.getType().hasName("file *")
and vprivate_2198.getType().hasName("btrfs_file_private *")
and vskip_ilock_1_2208.getType().hasName("const bool")
and vfile_2196.getFunction() = func
and vprivate_2198.(LocalVariable).getFunction() = func
and vskip_ilock_1_2208.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
