/**
 * @name linux-bfc81a8bc18e3c4ba0cbaa7666ff76be2f998991-snd_usb_create_streams
 * @id cpp/linux/bfc81a8bc18e3c4ba0cbaa7666ff76be2f998991/snd-usb-create-streams
 * @description linux-bfc81a8bc18e3c4ba0cbaa7666ff76be2f998991-sound/usb/card.c-snd_usb_create_streams CVE-2017-16529
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vhost_iface_220, Variable vcontrol_header_222, SwitchStmt target_4, ExprStmt target_5, NotExpr target_6, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="extra"
	and target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhost_iface_220
	and target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="extralen"
	and target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhost_iface_220
	and target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vcontrol_header_222
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_4.getLocation())
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_6.getOperand().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable vdev_219, SwitchStmt target_4, AddressOfExpr target_7, AddressOfExpr target_8, Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid control header\n"
	and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_4.getLocation())
	and target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vdev_219, IfStmt target_9, AddressOfExpr target_8, AddressOfExpr target_10) {
exists(IfStmt target_2 |
	target_2.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_2.getCondition().(RelationalOperation).getGreaterOperand().(SizeofExprOperator).getValue()="8"
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="too short v1 buffer descriptor\n"
	and target_2.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_2.getLocation().isBefore(target_9.getLocation())
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vdev_219, Variable vh1_246, IfStmt target_11, AddressOfExpr target_10, AddressOfExpr target_12, NotExpr target_13, RelationalOperation target_14) {
exists(IfStmt target_3 |
	target_3.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_3.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="bLength"
	and target_3.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid buffer length (v1)\n"
	and target_3.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_3.getLocation().isBefore(target_11.getLocation())
	and target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Variable vdev_219, SwitchStmt target_4) {
	target_4.getExpr().(VariableAccess).getTarget().getType().hasName("int")
	and target_4.getStmt().(BlockStmt).getStmt(0).(SwitchCase).toString() = "default: "
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_warn")
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="unknown interface protocol %#02x, assuming v1\n"
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_5(Variable vhost_iface_220, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("usb_interface_descriptor *")
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="desc"
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhost_iface_220
}

predicate func_6(Variable vcontrol_header_222, NotExpr target_6) {
	target_6.getOperand().(VariableAccess).getTarget()=vcontrol_header_222
}

predicate func_7(Variable vdev_219, AddressOfExpr target_7) {
	target_7.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="cannot find UAC_HEADER\n"
}

predicate func_8(Variable vdev_219, AddressOfExpr target_8) {
	target_8.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_8.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_warn")
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="unknown interface protocol %#02x, assuming v1\n"
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_9(Variable vdev_219, Variable vh1_246, IfStmt target_9) {
	target_9.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="bInCollection"
	and target_9.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_info")
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_9.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="skipping empty audio interface (v1)\n"
	and target_9.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
}

predicate func_10(Variable vdev_219, AddressOfExpr target_10) {
	target_10.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_info")
	and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="skipping empty audio interface (v1)\n"
}

predicate func_11(Variable vdev_219, Variable vh1_246, IfStmt target_11) {
	target_11.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="bLength"
	and target_11.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
	and target_11.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getLeftOperand().(SizeofExprOperator).getValue()="8"
	and target_11.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="bInCollection"
	and target_11.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
	and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_11.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid UAC_HEADER (v1)\n"
	and target_11.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
}

predicate func_12(Variable vdev_219, AddressOfExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_219
	and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="invalid UAC_HEADER (v1)\n"
}

predicate func_13(Variable vh1_246, NotExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="bInCollection"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
}

predicate func_14(Variable vh1_246, RelationalOperation target_14) {
	 (target_14 instanceof GTExpr or target_14 instanceof LTExpr)
	and target_14.getLesserOperand().(PointerFieldAccess).getTarget().getName()="bLength"
	and target_14.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
	and target_14.getGreaterOperand().(AddExpr).getLeftOperand().(SizeofExprOperator).getValue()="8"
	and target_14.getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="bInCollection"
	and target_14.getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vh1_246
}

from Function func, Variable vdev_219, Variable vhost_iface_220, Variable vcontrol_header_222, Variable vh1_246, SwitchStmt target_4, ExprStmt target_5, NotExpr target_6, AddressOfExpr target_7, AddressOfExpr target_8, IfStmt target_9, AddressOfExpr target_10, IfStmt target_11, AddressOfExpr target_12, NotExpr target_13, RelationalOperation target_14
where
not func_0(vhost_iface_220, vcontrol_header_222, target_4, target_5, target_6, func)
and not func_1(vdev_219, target_4, target_7, target_8, func)
and not func_2(vdev_219, target_9, target_8, target_10)
and not func_3(vdev_219, vh1_246, target_11, target_10, target_12, target_13, target_14)
and func_4(vdev_219, target_4)
and func_5(vhost_iface_220, target_5)
and func_6(vcontrol_header_222, target_6)
and func_7(vdev_219, target_7)
and func_8(vdev_219, target_8)
and func_9(vdev_219, vh1_246, target_9)
and func_10(vdev_219, target_10)
and func_11(vdev_219, vh1_246, target_11)
and func_12(vdev_219, target_12)
and func_13(vh1_246, target_13)
and func_14(vh1_246, target_14)
and vdev_219.getType().hasName("usb_device *")
and vhost_iface_220.getType().hasName("usb_host_interface *")
and vcontrol_header_222.getType().hasName("void *")
and vh1_246.getType().hasName("uac1_ac_header_descriptor *")
and vdev_219.(LocalVariable).getFunction() = func
and vhost_iface_220.(LocalVariable).getFunction() = func
and vcontrol_header_222.(LocalVariable).getFunction() = func
and vh1_246.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
