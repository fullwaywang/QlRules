/**
 * @name linux-6a137caec23aeb9e036cdfd8a46dd8a366460e5d-hci_dev_do_open
 * @id cpp/linux/6a137caec23aeb9e036cdfd8a46dd8a366460e5d/hci-dev-do-open
 * @description linux-6a137caec23aeb9e036cdfd8a46dd8a366460e5d-net/bluetooth/hci_core.c-hci_dev_do_open CVE-2021-3564
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhdev_1433, AddressOfExpr target_2, AddressOfExpr target_3, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="cmd_work"
	and target_0.getQualifier().(VariableAccess).getTarget()=vhdev_1433
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(VariableAccess).getLocation())
	and target_0.getQualifier().(VariableAccess).getLocation().isBefore(target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_1(Parameter vhdev_1433, AddressOfExpr target_4, AddressOfExpr target_5, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="rx_work"
	and target_1.getQualifier().(VariableAccess).getTarget()=vhdev_1433
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getQualifier().(VariableAccess).getLocation())
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_2(Parameter vhdev_1433, AddressOfExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="tx_work"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_1433
}

predicate func_3(Parameter vhdev_1433, AddressOfExpr target_3) {
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="rx_work"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_1433
}

predicate func_4(Parameter vhdev_1433, AddressOfExpr target_4) {
	target_4.getOperand().(PointerFieldAccess).getTarget().getName()="cmd_work"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_1433
}

predicate func_5(Parameter vhdev_1433, AddressOfExpr target_5) {
	target_5.getOperand().(PointerFieldAccess).getTarget().getName()="cmd_q"
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_1433
}

from Function func, Parameter vhdev_1433, PointerFieldAccess target_0, PointerFieldAccess target_1, AddressOfExpr target_2, AddressOfExpr target_3, AddressOfExpr target_4, AddressOfExpr target_5
where
func_0(vhdev_1433, target_2, target_3, target_0)
and func_1(vhdev_1433, target_4, target_5, target_1)
and func_2(vhdev_1433, target_2)
and func_3(vhdev_1433, target_3)
and func_4(vhdev_1433, target_4)
and func_5(vhdev_1433, target_5)
and vhdev_1433.getType().hasName("hci_dev *")
and vhdev_1433.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
