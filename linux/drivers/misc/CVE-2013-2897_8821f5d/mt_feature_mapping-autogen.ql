/**
 * @name linux-8821f5dc187bdf16cfb32ef5aa8c3035273fa79a-mt_feature_mapping
 * @id cpp/linux/8821f5dc187bdf16cfb32ef5aa8c3035273fa79a/mt-feature-mapping
 * @description linux-8821f5dc187bdf16cfb32ef5aa8c3035273fa79a-drivers/hid/hid-multitouch.c-mt_feature_mapping CVE-2013-2897
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfield_312, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="maxusage"
	and target_0.getQualifier().(VariableAccess).getTarget()=vfield_312
}

predicate func_1(Parameter vusage_312, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="hid"
	and target_1.getQualifier().(VariableAccess).getTarget()=vusage_312
}

predicate func_2(Parameter vfield_312, Parameter vusage_312, BlockStmt target_12, ExprStmt target_13, EqualityOperation target_10) {
exists(RelationalOperation target_2 |
	 (target_2 instanceof GEExpr or target_2 instanceof LEExpr)
	and target_2.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="usage_index"
	and target_2.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vusage_312
	and target_2.getLesserOperand().(PointerFieldAccess).getTarget().getName()="report_count"
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfield_312
	and target_2.getParent().(IfStmt).getThen()=target_12
	and target_13.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vhdev_311, FunctionCall target_14) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("dev_err")
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdev_311
	and target_3.getArgument(1).(StringLiteral).getValue()="HID_DG_INPUTMODE out of range\n"
	and target_14.getArgument(0).(VariableAccess).getLocation().isBefore(target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vusage_312, Variable vtd_314, SwitchStmt target_15, EqualityOperation target_10) {
exists(AssignExpr target_4 |
	target_4.getLValue().(PointerFieldAccess).getTarget().getName()="inputmode_index"
	and target_4.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_4.getRValue().(PointerFieldAccess).getTarget().getName()="usage_index"
	and target_4.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vusage_312
	and target_15.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vtd_314, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="inputmode_index"
	and target_5.getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_5.getParent().(AssignExpr).getLValue() = target_5
	and target_5.getParent().(AssignExpr).getRValue() instanceof Literal
}

predicate func_6(EqualityOperation target_10, Function func, BreakStmt target_6) {
	target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Function func, DeclStmt target_7) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vtd_314, AssignExpr target_8) {
	target_8.getLValue().(PointerFieldAccess).getTarget().getName()="inputmode_index"
	and target_8.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_8.getRValue().(Literal).getValue()="0"
}

predicate func_9(Parameter vfield_312, Parameter vusage_312, Variable vi_315, PointerFieldAccess target_17, ForStmt target_9) {
	target_9.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_315
	and target_9.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_9.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_315
	and target_9.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="maxusage"
	and target_9.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfield_312
	and target_9.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_315
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="hid"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="usage"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_315
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="hid"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vusage_312
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="inputmode_index"
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vi_315
	and target_9.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1) instanceof BreakStmt
	and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
}

predicate func_10(Parameter vfield_312, Parameter vusage_312, Variable vi_315, EqualityOperation target_10) {
	target_10.getLeftOperand().(ValueFieldAccess).getTarget().getName()="hid"
	and target_10.getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="usage"
	and target_10.getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfield_312
	and target_10.getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_315
	and target_10.getRightOperand().(PointerFieldAccess).getTarget().getName()="hid"
	and target_10.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vusage_312
}

/*predicate func_11(Variable vtd_314, Variable vi_315, AssignExpr target_11) {
	target_11.getLValue().(PointerFieldAccess).getTarget().getName()="inputmode_index"
	and target_11.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_11.getRValue().(VariableAccess).getTarget()=vi_315
}

*/
predicate func_12(Function func, BlockStmt target_12) {
	target_12.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_12.getStmt(1) instanceof BreakStmt
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Parameter vfield_312, Variable vtd_314, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="inputmode"
	and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_13.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="id"
	and target_13.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="report"
	and target_13.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfield_312
}

predicate func_14(Parameter vhdev_311, FunctionCall target_14) {
	target_14.getTarget().hasName("hid_get_drvdata")
	and target_14.getArgument(0).(VariableAccess).getTarget()=vhdev_311
}

predicate func_15(Parameter vfield_312, Parameter vusage_312, Variable vtd_314, SwitchStmt target_15) {
	target_15.getExpr().(PointerFieldAccess).getTarget().getName()="hid"
	and target_15.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vusage_312
	and target_15.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="852050"
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="inputmode"
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_314
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="id"
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="report"
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfield_312
}

predicate func_17(Parameter vusage_312, PointerFieldAccess target_17) {
	target_17.getTarget().getName()="hid"
	and target_17.getQualifier().(VariableAccess).getTarget()=vusage_312
}

from Function func, Parameter vhdev_311, Parameter vfield_312, Parameter vusage_312, Variable vtd_314, Variable vi_315, PointerFieldAccess target_0, PointerFieldAccess target_1, PointerFieldAccess target_5, BreakStmt target_6, DeclStmt target_7, AssignExpr target_8, ForStmt target_9, EqualityOperation target_10, BlockStmt target_12, ExprStmt target_13, FunctionCall target_14, SwitchStmt target_15, PointerFieldAccess target_17
where
func_0(vfield_312, target_0)
and func_1(vusage_312, target_1)
and not func_2(vfield_312, vusage_312, target_12, target_13, target_10)
and not func_3(vhdev_311, target_14)
and not func_4(vusage_312, vtd_314, target_15, target_10)
and func_5(vtd_314, target_5)
and func_6(target_10, func, target_6)
and func_7(func, target_7)
and func_8(vtd_314, target_8)
and func_9(vfield_312, vusage_312, vi_315, target_17, target_9)
and func_10(vfield_312, vusage_312, vi_315, target_10)
and func_12(func, target_12)
and func_13(vfield_312, vtd_314, target_13)
and func_14(vhdev_311, target_14)
and func_15(vfield_312, vusage_312, vtd_314, target_15)
and func_17(vusage_312, target_17)
and vhdev_311.getType().hasName("hid_device *")
and vfield_312.getType().hasName("hid_field *")
and vusage_312.getType().hasName("hid_usage *")
and vtd_314.getType().hasName("mt_device *")
and vi_315.getType().hasName("int")
and vhdev_311.getFunction() = func
and vfield_312.getFunction() = func
and vusage_312.getFunction() = func
and vtd_314.(LocalVariable).getFunction() = func
and vi_315.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
