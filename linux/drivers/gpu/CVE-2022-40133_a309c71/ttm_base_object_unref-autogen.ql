/**
 * @name linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-ttm_base_object_unref
 * @id cpp/linux/a309c7194e8a2f8bd4539b9449917913f6c2cd50/ttm-base-object-unref
 * @description linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-drivers/gpu/drm/vmwgfx/ttm_object.c-ttm_base_object_unref CVE-2022-40133
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("kref_put")
	and not target_0.getTarget().hasName("ttm_tfile_find_ref")
	and target_0.getArgument(0) instanceof AddressOfExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_2(Function func) {
exists(FunctionCall target_2 |
	target_2.getTarget().hasName("spin_lock")
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ttm_object_file *")
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(ExprStmt target_17, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ttm_tfile_find_ref")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("ttm_object_file *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("uint64_t")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("vmwgfx_hash_item *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_17.getLocation()))
}

/*predicate func_6(Function func) {
exists(AddressOfExpr target_6 |
	target_6.getOperand().(VariableAccess).getType().hasName("vmwgfx_hash_item *")
	and target_6.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_6.getEnclosingFunction() = func)
}

*/
predicate func_7(Variable vbase_250, ExprStmt target_17, AddressOfExpr target_13, Function func) {
exists(IfStmt target_7 |
	target_7.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("int")
	and target_7.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_7.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbase_250
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="obj"
	and target_7.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("kref_get_unless_zero")
	and target_7.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0) instanceof AddressOfExpr
	and target_7.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbase_250
	and target_7.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_17.getLocation())
	and target_7.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_9(Function func) {
exists(PointerFieldAccess target_9 |
	target_9.getTarget().getName()="obj"
	and target_9.getQualifier().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("void *")
	and target_9.getQualifier().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
	and target_9.getEnclosingFunction() = func)
}

*/
/*predicate func_10(Function func) {
exists(PointerArithmeticOperation target_10 |
	target_10.getLeftOperand().(VariableAccess).getType().hasName("void *")
	and target_10.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
	and target_10.getEnclosingFunction() = func)
}

*/
predicate func_11(ExprStmt target_17, Function func) {
exists(ExprStmt target_11 |
	target_11.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ttm_object_file *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
	and target_11.getLocation().isBefore(target_17.getLocation()))
}

predicate func_13(Variable vbase_250, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbase_250
	and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_15(Parameter vp_base_248, PointerDereferenceExpr target_15) {
	target_15.getOperand().(VariableAccess).getTarget()=vp_base_248
}

predicate func_16(Parameter vp_base_248, PointerDereferenceExpr target_16) {
	target_16.getOperand().(VariableAccess).getTarget()=vp_base_248
	and target_16.getParent().(AssignExpr).getLValue() = target_16
	and target_16.getParent().(AssignExpr).getRValue() instanceof Literal
}

predicate func_17(Function func, ExprStmt target_17) {
	target_17.getExpr() instanceof FunctionCall
	and target_17.getEnclosingFunction() = func
}

from Function func, Parameter vp_base_248, Variable vbase_250, FunctionCall target_0, AddressOfExpr target_13, PointerDereferenceExpr target_15, PointerDereferenceExpr target_16, ExprStmt target_17
where
func_0(func, target_0)
and not func_2(func)
and not func_3(target_17, func)
and not func_7(vbase_250, target_17, target_13, func)
and not func_11(target_17, func)
and func_13(vbase_250, target_13)
and func_15(vp_base_248, target_15)
and func_16(vp_base_248, target_16)
and func_17(func, target_17)
and vp_base_248.getType().hasName("ttm_base_object **")
and vbase_250.getType().hasName("ttm_base_object *")
and vp_base_248.getFunction() = func
and vbase_250.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
