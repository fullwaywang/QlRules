commit 7301cf1e40fdd97594ea491676b867cf4e577edc	7301cf1e40fdd97594ea491676b867cf4e577edc
Author: Steinar H. Gunderson <sesse@chromium.org>
Date:   Mon Feb 27 11:57:46 2023 +0000

    In Typed CSSOM, reject adding to something that is not a list.
    
    Fixed: 1417176
    Change-Id: Idef1a81af46d334c181979778c28f19ce6369718
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4293477
    Reviewed-by: Anders Hartvoll Ruud <andruud@chromium.org>
    Commit-Queue: Steinar H Gunderson <sesse@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1110281}

diff --git a/third_party/blink/renderer/core/css/cssom/style_property_map.cc b/third_party/blink/renderer/core/css/cssom/style_property_map.cc
index 74d6c083ce380..c4ad358a687d7 100644
--- a/third_party/blink/renderer/core/css/cssom/style_property_map.cc
+++ b/third_party/blink/renderer/core/css/cssom/style_property_map.cc
@@ -381,6 +381,17 @@ void StylePropertyMap::append(
           "Cannot append to a list containing a variable reference");
       return;
     }
+    if (!css_value->IsValueList()) {
+      // The standard doesn't seem to cover this explicitly
+      // (https://github.com/w3c/css-houdini-drafts/issues/823),
+      // but the only really reasonable solution seems to be
+      // to throw a TypeError.
+      //
+      // This covers e.g. system-wide CSS keywords, like inherit.
+      exception_state.ThrowTypeError(
+          "Cannot append to something that is not a list");
+      return;
+    }
     current_value = To<CSSValueList>(css_value)->Copy();
   } else {
     current_value = CssValueListForPropertyID(property_id);
diff --git a/third_party/blink/web_tests/external/wpt/css/css-typed-om/the-stylepropertymap/inline/append.tentative.html b/third_party/blink/web_tests/external/wpt/css/css-typed-om/the-stylepropertymap/inline/append.tentative.html
index ee9a9e4ddbcf7..f808756223669 100644
--- a/third_party/blink/web_tests/external/wpt/css/css-typed-om/the-stylepropertymap/inline/append.tentative.html
+++ b/third_party/blink/web_tests/external/wpt/css/css-typed-om/the-stylepropertymap/inline/append.tentative.html
@@ -56,4 +56,10 @@ test(t => {
   assert_style_value_array_equals(result, [CSS.s(5), CSS.s(10), CSS.s(1), CSS.s(2)]);
 }, 'StylePropertyMap.append is case-insensitive');
 
+// https://crbug.com/1417176
+test(t => {
+  let styleMap = createInlineStyleMap(t, 'transition-duration: inherit');
+  assert_throws_js(TypeError, () => styleMap.append('transition-duration', '1s'));
+}, 'StylePropertyMap.append rejects appending to CSS-wide keywords');
+
 </script>
