/**
 * @name linux-6619aa48a011364e9f29083cc76368e6acfe5b11-cs_dsp_coeff_parse_string
 * @id cpp/linux/6619aa48a011364e9f29083cc76368e6acfe5b11/cs-dsp-coeff-parse-string
 * @description linux-6619aa48a011364e9f29083cc76368e6acfe5b11-drivers/firmware/cirrus/cs_dsp.c-cs_dsp_coeff_parse_string CVE-2024-41038
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vpos_1017, ExprStmt target_0) {
	exists(AssignPointerAddExpr obj_0 | obj_0=target_0.getExpr() |
		obj_0.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
		and obj_0.getRValue() instanceof BitwiseAndExpr
	)
	and target_0.getFollowingStmt() instanceof ReturnStmt
}

predicate func_2(Parameter vpos_1017, BlockStmt target_8, ExprStmt target_9, Function func) {
exists(IfStmt target_2 |
	exists(RelationalOperation obj_0 | obj_0=target_2.getCondition() |
		exists(SizeofTypeOperator obj_1 | obj_1=obj_0.getGreaterOperand() |
			obj_1.getType() instanceof LongType
			and obj_1.getValue()="4"
		)
		and obj_0.getLesserOperand().(VariableAccess).getType().hasName("unsigned int")
	)
	and exists(BlockStmt obj_2 | obj_2=target_2.getThen() |
		exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(0) |
			exists(AssignExpr obj_4 | obj_4=obj_3.getExpr() |
				obj_4.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
				and obj_4.getRValue().(Literal).getValue()="0"
			)
		)
		and obj_2.getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_8.getLocation())
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
)
}

predicate func_3(Function func) {
exists(AssignExpr target_3 |
	target_3.getLValue().(VariableAccess).getType().hasName("int")
	and target_3.getRValue() instanceof BitwiseAndExpr
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(Parameter vpos_1017, ExprStmt target_10, ExprStmt target_0, Function func) {
exists(IfStmt target_4 |
	exists(RelationalOperation obj_0 | obj_0=target_4.getCondition() |
		obj_0.getGreaterOperand().(VariableAccess).getType().hasName("int")
		and obj_0.getLesserOperand().(VariableAccess).getType().hasName("unsigned int")
	)
	and exists(BlockStmt obj_1 | obj_1=target_4.getThen() |
		exists(ExprStmt obj_2 | obj_2=obj_1.getStmt(0) |
			exists(AssignExpr obj_3 | obj_3=obj_2.getExpr() |
				obj_3.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
				and obj_3.getRValue().(Literal).getValue()="0"
			)
		)
		and obj_1.getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof ReturnStmt
	and target_10.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignPointerAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
)
}

predicate func_5(Parameter vpos_1017, Function func) {
exists(ExprStmt target_5 |
	exists(AssignPointerAddExpr obj_0 | obj_0=target_5.getExpr() |
		obj_0.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
		and obj_0.getRValue().(VariableAccess).getType().hasName("int")
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt
)
}

predicate func_7(Variable vlength_1019, Parameter vbytes_1017, BitwiseAndExpr target_7) {
	exists(AddExpr obj_0 | obj_0=target_7.getLeftOperand() |
		exists(AddExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			obj_1.getLeftOperand().(VariableAccess).getTarget()=vlength_1019
			and obj_1.getRightOperand().(VariableAccess).getTarget()=vbytes_1017
		)
		and obj_0.getRightOperand().(Literal).getValue()="3"
	)
	and target_7.getRightOperand().(ComplementExpr).getValue()="-4"
}

predicate func_8(Variable vlength_1019, Parameter vbytes_1017, BlockStmt target_8) {
	exists(SwitchStmt obj_0 | obj_0=target_8.getStmt(0) |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			obj_1.getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
			and obj_1.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlength_1019
			and obj_1.getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="2"
			and obj_1.getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlength_1019
			and obj_1.getStmt(6).(SwitchCase).toString() = "default: "
		)
		and obj_0.getExpr().(VariableAccess).getTarget()=vbytes_1017
	)
}

predicate func_9(Parameter vpos_1017, Variable vlength_1019, ExprStmt target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=vlength_1019
		and obj_0.getRValue().(PointerDereferenceExpr).getOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
	)
}

predicate func_10(Parameter vpos_1017, Parameter vbytes_1017, ExprStmt target_10) {
	exists(AssignExpr obj_0 | obj_0=target_10.getExpr() |
		exists(PointerArithmeticOperation obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vpos_1017
			and obj_1.getRightOperand().(VariableAccess).getTarget()=vbytes_1017
		)
		and obj_0.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("const u8 **")
	)
}

from Function func, Parameter vpos_1017, Variable vlength_1019, Parameter vbytes_1017, ExprStmt target_0, BitwiseAndExpr target_7, BlockStmt target_8, ExprStmt target_9, ExprStmt target_10
where
func_0(vpos_1017, target_0)
and not func_2(vpos_1017, target_8, target_9, func)
and not func_3(func)
and not func_4(vpos_1017, target_10, target_0, func)
and not func_5(vpos_1017, func)
and func_7(vlength_1019, vbytes_1017, target_7)
and func_8(vlength_1019, vbytes_1017, target_8)
and func_9(vpos_1017, vlength_1019, target_9)
and func_10(vpos_1017, vbytes_1017, target_10)
and vpos_1017.getType().hasName("const u8 **")
and vlength_1019.getType().hasName("int")
and vbytes_1017.getType().hasName("int")
and vpos_1017.getFunction() = func
and vlength_1019.(LocalVariable).getFunction() = func
and vbytes_1017.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
