/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_grab_files
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-grab-files
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_grab_files CVE-2021-20194
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(UnaryMinusExpr).getValue()="-9"
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Parameter vreq_6068, FunctionCall target_1) {
	target_1.getTarget().hasName("io_req_init_async")
	and not target_1.getTarget().hasName("io_uring_files_cancel")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vreq_6068
}

predicate func_2(Function func, FunctionCall target_2) {
	target_2.getTarget().hasName("rcu_read_lock")
	and not target_2.getTarget().hasName("task_lock")
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("spin_lock_irq")
	and not target_3.getTarget().hasName("task_unlock")
	and target_3.getArgument(0).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vreq_6068, FunctionCall target_4) {
	target_4.getTarget().hasName("list_add")
	and not target_4.getTarget().hasName("put_files_struct")
	and target_4.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="inflight_entry"
	and target_4.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_4.getArgument(1).(AddressOfExpr).getOperand() instanceof ValueFieldAccess
}

predicate func_10(Function func) {
exists(PointerFieldAccess target_10 |
	target_10.getTarget().getName()="files"
	and target_10.getQualifier().(VariableAccess).getType().hasName("task_struct *")
	and target_10.getEnclosingFunction() = func)
}

predicate func_16(Function func, DeclStmt target_16) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(Parameter vreq_6068, ReturnStmt target_34, LogicalOrExpr target_17) {
	target_17.getLeftOperand().(ValueFieldAccess).getTarget().getName()="files"
	and target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_17.getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_17.getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_17.getParent().(IfStmt).getThen()=target_34
}

predicate func_19(Variable vctx_6071, Function func, IfStmt target_19) {
	target_19.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_19.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_19.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-9"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Function func, ExprStmt target_20) {
	target_20.getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

predicate func_21(Variable vctx_6071, NotExpr target_35, EqualityOperation target_36, ValueFieldAccess target_21) {
	target_21.getTarget().getName()="inflight_lock"
	and target_21.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_21.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_35.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_36.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_22(Variable vret_6070, Variable vctx_6071, Parameter vreq_6068, Function func, IfStmt target_22) {
	target_22.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("fcheck_files")
	and target_22.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="files"
	and target_22.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_22.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="ring_fd"
	and target_22.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_22.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_22.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_22.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_22.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_22.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_22.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_22.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_22.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_22.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="files"
	and target_22.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_22.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_6070
	and target_22.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

/*predicate func_23(Variable vctx_6071, FunctionCall target_23) {
	target_23.getTarget().hasName("get_current")
	and target_23.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(EQExpr).getLeftOperand().(FunctionCall).getTarget().hasName("fcheck_files")
	and target_23.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(EQExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="files"
	and target_23.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(EQExpr).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="ring_fd"
	and target_23.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(EQExpr).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
}

*/
predicate func_24(Parameter vreq_6068, PointerFieldAccess target_24) {
	target_24.getTarget().getName()="inflight_entry"
	and target_24.getQualifier().(VariableAccess).getTarget()=vreq_6068
}

predicate func_25(Variable vctx_6071, ValueFieldAccess target_25) {
	target_25.getTarget().getName()="inflight_list"
	and target_25.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_25.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_25.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

/*predicate func_26(Parameter vreq_6068, AssignOrExpr target_26) {
	target_26.getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_26.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
}

*/
/*predicate func_27(Parameter vreq_6068, EqualityOperation target_36, ExprStmt target_27) {
	target_27.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_27.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_27.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="files"
	and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_36
}

*/
/*predicate func_28(Parameter vreq_6068, ValueFieldAccess target_28) {
	target_28.getTarget().getName()="files"
	and target_28.getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_28.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_28.getParent().(AssignExpr).getLValue() = target_28
	and target_28.getParent().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="files"
	and target_28.getParent().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
}

*/
/*predicate func_29(Function func, PointerFieldAccess target_29) {
	target_29.getTarget().getName()="files"
	and target_29.getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_29.getEnclosingFunction() = func
}

*/
/*predicate func_30(Variable vret_6070, AssignExpr target_30) {
	target_30.getLValue().(VariableAccess).getTarget()=vret_6070
	and target_30.getRValue() instanceof Literal
}

*/
predicate func_31(Variable vctx_6071, Function func, ExprStmt target_31) {
	target_31.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irq")
	and target_31.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="inflight_lock"
	and target_31.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_31.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_31
}

predicate func_32(Function func, ExprStmt target_32) {
	target_32.getExpr().(FunctionCall).getTarget().hasName("rcu_read_unlock")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_32
}

predicate func_33(Variable vret_6070, Function func, ReturnStmt target_33) {
	target_33.getExpr().(VariableAccess).getTarget()=vret_6070
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_33
}

predicate func_34(Function func, ReturnStmt target_34) {
	target_34.getExpr() instanceof Literal
	and target_34.getEnclosingFunction() = func
}

predicate func_35(Variable vctx_6071, NotExpr target_35) {
	target_35.getOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_35.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
}

predicate func_36(Variable vctx_6071, EqualityOperation target_36) {
	target_36.getLeftOperand() instanceof FunctionCall
	and target_36.getRightOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_36.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
}

from Function func, Variable vret_6070, Variable vctx_6071, Parameter vreq_6068, Initializer target_0, FunctionCall target_1, FunctionCall target_2, FunctionCall target_3, FunctionCall target_4, DeclStmt target_16, LogicalOrExpr target_17, IfStmt target_19, ExprStmt target_20, ValueFieldAccess target_21, IfStmt target_22, PointerFieldAccess target_24, ValueFieldAccess target_25, ExprStmt target_31, ExprStmt target_32, ReturnStmt target_33, ReturnStmt target_34, NotExpr target_35, EqualityOperation target_36
where
func_0(func, target_0)
and func_1(vreq_6068, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(vreq_6068, target_4)
and not func_10(func)
and func_16(func, target_16)
and func_17(vreq_6068, target_34, target_17)
and func_19(vctx_6071, func, target_19)
and func_20(func, target_20)
and func_21(vctx_6071, target_35, target_36, target_21)
and func_22(vret_6070, vctx_6071, vreq_6068, func, target_22)
and func_24(vreq_6068, target_24)
and func_25(vctx_6071, target_25)
and func_31(vctx_6071, func, target_31)
and func_32(func, target_32)
and func_33(vret_6070, func, target_33)
and func_34(func, target_34)
and func_35(vctx_6071, target_35)
and func_36(vctx_6071, target_36)
and vret_6070.getType().hasName("int")
and vctx_6071.getType().hasName("io_ring_ctx *")
and vreq_6068.getType().hasName("io_kiocb *")
and vret_6070.(LocalVariable).getFunction() = func
and vctx_6071.(LocalVariable).getFunction() = func
and vreq_6068.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
