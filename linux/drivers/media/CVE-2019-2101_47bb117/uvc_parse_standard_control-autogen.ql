/**
 * @name linux-47bb117911b051bbc90764a8bff96543cbd2005f-uvc_parse_standard_control
 * @id cpp/linux/47bb117911b051bbc90764a8bff96543cbd2005f/uvc-parse-standard-control
 * @description linux-47bb117911b051bbc90764a8bff96543cbd2005f-drivers/media/usb/uvc/uvc_driver.c-uvc_parse_standard_control CVE-2019-2101
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtype_1071, BlockStmt target_2, ExprStmt target_3, EqualityOperation target_1) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtype_1071
	and target_0.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="32512"
	and target_0.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtype_1071
	and target_0.getRightOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="32768"
	and target_0.getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getParent().(IfStmt).getThen()=target_2
	and target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_0.getLeftOperand().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_1.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable vtype_1071, BlockStmt target_2, EqualityOperation target_1) {
	target_1.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vtype_1071
	and target_1.getLeftOperand().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="65280"
	and target_1.getRightOperand().(Literal).getValue()="0"
	and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vtype_1071, BlockStmt target_2) {
	target_2.getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2"
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="7uvcvideo: device %d videocontrol interface %d INPUT_TERMINAL %d has invalid type 0x%04x, skipping\n"
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="devnum"
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="bInterfaceNumber"
	and target_2.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vtype_1071
}

predicate func_3(Variable vtype_1071, ArrayExpr target_4, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtype_1071
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("get_unaligned_le16")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("const unsigned char *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="4"
	and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_4
}

predicate func_4(Function func, ArrayExpr target_4) {
	target_4.getArrayBase().(VariableAccess).getTarget().getType().hasName("const unsigned char *")
	and target_4.getArrayOffset().(Literal).getValue()="2"
	and target_4.getEnclosingFunction() = func
}

from Function func, Variable vtype_1071, EqualityOperation target_1, BlockStmt target_2, ExprStmt target_3, ArrayExpr target_4
where
not func_0(vtype_1071, target_2, target_3, target_1)
and func_1(vtype_1071, target_2, target_1)
and func_2(vtype_1071, target_2)
and func_3(vtype_1071, target_4, target_3)
and func_4(func, target_4)
and vtype_1071.getType().hasName("u16")
and vtype_1071.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
