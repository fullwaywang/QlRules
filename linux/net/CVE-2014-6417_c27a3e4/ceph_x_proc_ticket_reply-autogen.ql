/**
 * @name linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-ceph_x_proc_ticket_reply
 * @id cpp/linux/c27a3e4d667fdcad3db7b104f75659478e0c68d8/ceph-x-proc-ticket-reply
 * @description linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-net/ceph/auth_x.c-ceph_x_proc_ticket_reply CVE-2014-6417
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, UnaryMinusExpr target_0) {
	target_0.getValue()="-12"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(ExprStmt target_11, Function func) {
exists(ReturnStmt target_1 |
	target_1.getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_11.getLocation()))
}

predicate func_2(Variable vret_256, Function func, ReturnStmt target_2) {
	target_2.getExpr().(VariableAccess).getTarget()=vret_256
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vret_256, UnaryMinusExpr target_3) {
	target_3.getValue()="-22"
	and target_3.getParent().(AssignExpr).getRValue() = target_3
	and target_3.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_256
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Function func, DeclStmt target_6) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vdbuf_252, Function func, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdbuf_252
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(Literal).getValue()="256"
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="80"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vdbuf_252, Function func, IfStmt target_8) {
	target_8.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vdbuf_252
	and target_8.getThen().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vret_256, Function func, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_256
	and target_9.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

/*predicate func_10(Variable vret_256, UnaryMinusExpr target_10) {
	target_10.getValue()="-12"
	and target_10.getParent().(AssignExpr).getRValue() = target_10
	and target_10.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_256
}

*/
predicate func_11(Variable vticket_buf_253, Function func, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vticket_buf_253
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(Literal).getValue()="256"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="80"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vticket_buf_253, Function func, IfStmt target_12) {
	target_12.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vticket_buf_253
	and target_12.getThen().(GotoStmt).getName() ="out_dbuf"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Parameter vend_249, Variable vp_251, Variable vdbuf_252, Variable vticket_buf_253, Variable vret_256, Parameter vac_247, Parameter vsecret_248, AssignExpr target_13) {
	target_13.getLValue().(VariableAccess).getTarget()=vret_256
	and target_13.getRValue().(FunctionCall).getTarget().hasName("process_one_ticket")
	and target_13.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vac_247
	and target_13.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsecret_248
	and target_13.getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vp_251
	and target_13.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vend_249
	and target_13.getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vdbuf_252
	and target_13.getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vticket_buf_253
}

/*predicate func_14(Parameter vend_249, Variable vp_251, Variable vdbuf_252, Variable vticket_buf_253, Parameter vac_247, Parameter vsecret_248, NotExpr target_23, AddressOfExpr target_24, NotExpr target_25, ExprStmt target_19, NotExpr target_26, ExprStmt target_18, VariableAccess target_14) {
	target_14.getTarget()=vdbuf_252
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("process_one_ticket")
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vac_247
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsecret_248
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vp_251
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vend_249
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vticket_buf_253
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
	and target_24.getOperand().(VariableAccess).getLocation().isBefore(target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
	and target_25.getOperand().(VariableAccess).getLocation().isBefore(target_14.getLocation())
	and target_14.getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_26.getOperand().(VariableAccess).getLocation().isBefore(target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getLocation())
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getLocation().isBefore(target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
/*predicate func_15(Parameter vend_249, Variable vp_251, Variable vdbuf_252, Variable vticket_buf_253, Parameter vac_247, Parameter vsecret_248, NotExpr target_23, AddressOfExpr target_24, NotExpr target_25, ExprStmt target_19, NotExpr target_26, ExprStmt target_18, VariableAccess target_15) {
	target_15.getTarget()=vticket_buf_253
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("process_one_ticket")
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vac_247
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsecret_248
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vp_251
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vend_249
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vdbuf_252
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
	and target_24.getOperand().(VariableAccess).getLocation().isBefore(target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
	and target_25.getOperand().(VariableAccess).getLocation().isBefore(target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation())
	and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_26.getOperand().(VariableAccess).getLocation().isBefore(target_15.getLocation())
	and target_15.getLocation().isBefore(target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
predicate func_16(VariableAccess target_27, Function func, GotoStmt target_16) {
	target_16.getName() ="out"
	and target_16.getParent().(IfStmt).getCondition()=target_27
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vret_256, Function func, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_256
	and target_17.getExpr().(AssignExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

predicate func_18(Variable vticket_buf_253, Function func, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vticket_buf_253
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

predicate func_19(Variable vdbuf_252, Function func, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdbuf_252
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Variable vret_256, Function func, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_256
	and target_20.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

predicate func_21(Function func, GotoStmt target_21) {
	target_21.getName() ="out"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_23(Parameter vend_249, Variable vp_251, NotExpr target_23) {
	target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("ceph_has_room")
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vp_251
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vend_249
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_23.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="4"
}

predicate func_24(Variable vp_251, AddressOfExpr target_24) {
	target_24.getOperand().(VariableAccess).getTarget()=vp_251
	and target_24.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_decode_32")
}

predicate func_25(Variable vdbuf_252, NotExpr target_25) {
	target_25.getOperand().(VariableAccess).getTarget()=vdbuf_252
}

predicate func_26(Variable vticket_buf_253, NotExpr target_26) {
	target_26.getOperand().(VariableAccess).getTarget()=vticket_buf_253
}

predicate func_27(Variable vret_256, VariableAccess target_27) {
	target_27.getTarget()=vret_256
}

from Function func, Parameter vend_249, Variable vp_251, Variable vdbuf_252, Variable vticket_buf_253, Variable vret_256, Parameter vac_247, Parameter vsecret_248, UnaryMinusExpr target_0, ReturnStmt target_2, UnaryMinusExpr target_3, DeclStmt target_5, DeclStmt target_6, ExprStmt target_7, IfStmt target_8, ExprStmt target_9, ExprStmt target_11, IfStmt target_12, AssignExpr target_13, GotoStmt target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19, ExprStmt target_20, GotoStmt target_21, NotExpr target_23, AddressOfExpr target_24, NotExpr target_25, NotExpr target_26, VariableAccess target_27
where
func_0(func, target_0)
and not func_1(target_11, func)
and func_2(vret_256, func, target_2)
and func_3(vret_256, target_3)
and func_5(func, target_5)
and func_6(func, target_6)
and func_7(vdbuf_252, func, target_7)
and func_8(vdbuf_252, func, target_8)
and func_9(vret_256, func, target_9)
and func_11(vticket_buf_253, func, target_11)
and func_12(vticket_buf_253, func, target_12)
and func_13(vend_249, vp_251, vdbuf_252, vticket_buf_253, vret_256, vac_247, vsecret_248, target_13)
and func_16(target_27, func, target_16)
and func_17(vret_256, func, target_17)
and func_18(vticket_buf_253, func, target_18)
and func_19(vdbuf_252, func, target_19)
and func_20(vret_256, func, target_20)
and func_21(func, target_21)
and func_23(vend_249, vp_251, target_23)
and func_24(vp_251, target_24)
and func_25(vdbuf_252, target_25)
and func_26(vticket_buf_253, target_26)
and func_27(vret_256, target_27)
and vend_249.getType().hasName("void *")
and vp_251.getType().hasName("void *")
and vdbuf_252.getType().hasName("char *")
and vticket_buf_253.getType().hasName("char *")
and vret_256.getType().hasName("int")
and vac_247.getType().hasName("ceph_auth_client *")
and vsecret_248.getType().hasName("ceph_crypto_key *")
and vend_249.getFunction() = func
and vp_251.(LocalVariable).getFunction() = func
and vdbuf_252.(LocalVariable).getFunction() = func
and vticket_buf_253.(LocalVariable).getFunction() = func
and vret_256.(LocalVariable).getFunction() = func
and vac_247.getFunction() = func
and vsecret_248.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
