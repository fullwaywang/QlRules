/**
 * @name linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-tcf_mirred_dump
 * @id cpp/linux/1c40be12f7d8ca1d387510d39787b12e512a7ce8/tcf-mirred-dump
 * @description linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-net/sched/act_mirred.c-tcf_mirred_dump CVE-2010-2942
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vm_221, ValueFieldAccess target_1) {
		target_1.getTarget().getName()="tcfc_index"
		and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
}

predicate func_2(Variable vm_221, ValueFieldAccess target_2) {
		target_2.getTarget().getName()="tcfc_action"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
}

predicate func_3(Parameter vref_218, Variable vm_221, SubExpr target_3) {
		target_3.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_refcnt"
		and target_3.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_3.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
		and target_3.getRightOperand().(VariableAccess).getTarget()=vref_218
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_4(Parameter vbind_218, Variable vm_221, SubExpr target_4) {
		target_4.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_bindcnt"
		and target_4.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_4.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
		and target_4.getRightOperand().(VariableAccess).getTarget()=vbind_218
		and target_4.getParent().(AssignExpr).getRValue() = target_4
		and target_4.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_5(Variable vm_221, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="tcfm_eaction"
		and target_5.getQualifier().(VariableAccess).getTarget()=vm_221
		and target_5.getParent().(AssignExpr).getRValue() = target_5
		and target_5.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_6(Variable vm_221, PointerFieldAccess target_6) {
		target_6.getTarget().getName()="tcfm_ifindex"
		and target_6.getQualifier().(VariableAccess).getTarget()=vm_221
		and target_6.getParent().(AssignExpr).getRValue() = target_6
		and target_6.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_7(Variable vopt_222, Function func, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="index"
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_7.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vopt_222, Function func, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="action"
		and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_8.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vopt_222, Function func, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="refcnt"
		and target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_9.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vopt_222, Function func, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bindcnt"
		and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_10.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vm_221, Variable vopt_222, Function func, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="eaction"
		and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="tcfm_eaction"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vm_221, Variable vopt_222, Function func, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ifindex"
		and target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_222
		and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="tcfm_ifindex"
		and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vm_221
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

from Function func, Parameter vbind_218, Parameter vref_218, Variable vm_221, Variable vopt_222, ValueFieldAccess target_1, ValueFieldAccess target_2, SubExpr target_3, SubExpr target_4, PointerFieldAccess target_5, PointerFieldAccess target_6, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, ExprStmt target_12
where
func_1(vm_221, target_1)
and func_2(vm_221, target_2)
and func_3(vref_218, vm_221, target_3)
and func_4(vbind_218, vm_221, target_4)
and func_5(vm_221, target_5)
and func_6(vm_221, target_6)
and func_7(vopt_222, func, target_7)
and func_8(vopt_222, func, target_8)
and func_9(vopt_222, func, target_9)
and func_10(vopt_222, func, target_10)
and func_11(vm_221, vopt_222, func, target_11)
and func_12(vm_221, vopt_222, func, target_12)
and vbind_218.getType().hasName("int")
and vref_218.getType().hasName("int")
and vm_221.getType().hasName("tcf_mirred *")
and vopt_222.getType().hasName("tc_mirred")
and vbind_218.getFunction() = func
and vref_218.getFunction() = func
and vm_221.(LocalVariable).getFunction() = func
and vopt_222.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
