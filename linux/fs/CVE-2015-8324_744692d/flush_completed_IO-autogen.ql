/**
 * @name linux-744692dc059845b2a3022119871846e74d4f6e11-flush_completed_IO
 * @id cpp/linux/744692dc059845b2a3022119871846e74d4f6e11/flush-completed-io
 * @description linux-744692dc059845b2a3022119871846e74d4f6e11-fs/ext4/inode.c-flush_completed_IO CVE-2015-8324
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(ValueFieldAccess).getTarget().getName()="next"
	and target_0.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_completed_io_list"
	and target_0.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier() instanceof StmtExpr
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_2(WhileStmt target_27, Function func) {
exists(DoStmt target_2 |
	target_2.getCondition().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_2.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_27.getLocation()))
}

/*predicate func_3(Function func) {
exists(DoStmt target_3 |
	target_3.getCondition().(Literal).getValue()="0"
	and target_3.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
	and target_3.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_3.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_3.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_3.getFollowingStmt() instanceof DeclStmt
	and target_3.getEnclosingFunction() = func)
}

*/
/*predicate func_4(Function func) {
exists(StmtExpr target_4 |
	target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_4.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
	and target_4.getEnclosingFunction() = func)
}

*/
/*predicate func_6(ExprStmt target_17, Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_6.getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_6.getLocation().isBefore(target_17.getLocation())
	and target_6.getEnclosingFunction() = func)
}

*/
/*predicate func_7(ExprStmt target_17, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(Literal).getValue()="1"
	and target_7.getLocation().isBefore(target_17.getLocation())
	and target_7.getEnclosingFunction() = func)
}

*/
/*predicate func_8(Function func) {
exists(AssignExpr target_8 |
	target_8.getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_8.getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_8.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_8.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_lock"
	and target_8.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ext4_inode_info *")
	and target_8.getParent().(ExprStmt).getParent().(BlockStmt).getParent().(StmtExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_8.getEnclosingFunction() = func)
}

*/
predicate func_10(Variable vio_3609, ExprStmt target_18) {
exists(ExprStmt target_10 |
	target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vio_3609
	and target_10.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_10.getFollowingStmt() instanceof DeclStmt
	and target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_12(Function func) {
exists(FunctionCall target_12 |
	target_12.getTarget().hasName("spin_unlock_irqrestore")
	and target_12.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_lock"
	and target_12.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ext4_inode_info *")
	and target_12.getArgument(1).(VariableAccess).getType().hasName("unsigned long")
	and target_12.getEnclosingFunction() = func)
}

predicate func_13(Function func) {
exists(DoStmt target_13 |
	target_13.getCondition().(Literal).getValue()="0"
	and target_13.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_13.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_13.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_13.getEnclosingFunction() = func)
}

predicate func_15(Function func) {
exists(ExprStmt target_15 |
	target_15.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_lock"
	and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("ext4_inode_info *")
	and target_15.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
	and target_15.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_16(Variable v__mptr_3613, StmtExpr target_16) {
	target_16.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_3613
	and target_16.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="376"
	and target_16.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("list_empty")
	and target_16.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_list"
}

predicate func_17(Variable v__mptr_3618, ExprStmt target_17) {
	target_17.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_3618
	and target_17.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
}

predicate func_18(Variable vio_3609, Variable vret_3610, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_3610
	and target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ext4_end_io_nolock")
	and target_18.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vio_3609
}

predicate func_19(Variable vio_3609, Variable vret_3610, Variable vret2_3611, IfStmt target_19) {
	target_19.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vret_3610
	and target_19.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_19.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret2_3611
	and target_19.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vret_3610
	and target_19.getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_del_init")
	and target_19.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
	and target_19.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vio_3609
}

/*predicate func_20(Variable v__mptr_3617, StmtExpr target_20) {
	target_20.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_3617
	and target_20.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="376"
	and target_20.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_20.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_list"
}

*/
/*predicate func_22(Parameter vinode_3607, ExprStmt target_29, VariableAccess target_22) {
	target_22.getTarget()=vinode_3607
	and target_22.getParent().(Initializer).getParent().(VariableDeclarationEntry).getParent().(DeclStmt).getParent().(BlockStmt).getParent().(StmtExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_29.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_22.getLocation())
}

*/
/*predicate func_23(Variable v__mptr_3617, PointerArithmeticOperation target_23) {
	target_23.getLeftOperand().(VariableAccess).getTarget()=v__mptr_3617
	and target_23.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="376"
	and target_23.getParent().(ExprStmt).getParent().(BlockStmt).getParent().(StmtExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
}

*/
predicate func_24(Variable v__mptr_1_3618, StmtExpr target_24) {
	target_24.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_1_3618
	and target_24.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="376"
}

/*predicate func_26(Variable v__mptr_1_3618, PointerArithmeticOperation target_26) {
	target_26.getLeftOperand().(VariableAccess).getTarget()=v__mptr_1_3618
	and target_26.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="376"
}

*/
predicate func_27(Variable vio_3609, WhileStmt target_27) {
	target_27.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_27.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_completed_io_list"
	and target_27.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier() instanceof StmtExpr
	and target_27.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vio_3609
	and target_27.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_27.getStmt().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_27.getStmt().(BlockStmt).getStmt(2) instanceof IfStmt
}

predicate func_29(Parameter vinode_3607, ExprStmt target_29) {
	target_29.getExpr().(FunctionCall).getTarget().hasName("dump_completed_IO")
	and target_29.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_3607
}

from Function func, Parameter vinode_3607, Variable vio_3609, Variable vret_3610, Variable vret2_3611, Variable v__mptr_3613, Variable v__mptr_3617, Variable v__mptr_3618, Variable v__mptr_1_3618, Initializer target_0, StmtExpr target_16, ExprStmt target_17, ExprStmt target_18, IfStmt target_19, StmtExpr target_24, WhileStmt target_27, ExprStmt target_29
where
func_0(func, target_0)
and not func_2(target_27, func)
and not func_10(vio_3609, target_18)
and not func_12(func)
and not func_13(func)
and not func_15(func)
and func_16(v__mptr_3613, target_16)
and func_17(v__mptr_3618, target_17)
and func_18(vio_3609, vret_3610, target_18)
and func_19(vio_3609, vret_3610, vret2_3611, target_19)
and func_24(v__mptr_1_3618, target_24)
and func_27(vio_3609, target_27)
and func_29(vinode_3607, target_29)
and vinode_3607.getType().hasName("inode *")
and vio_3609.getType().hasName("ext4_io_end_t *")
and vret_3610.getType().hasName("int")
and vret2_3611.getType().hasName("int")
and v__mptr_3613.getType().hasName("const inode *")
and v__mptr_3617.getType().hasName("const inode *")
and v__mptr_3618.getType().hasName("const list_head *")
and v__mptr_1_3618.getType().hasName("const inode *")
and vinode_3607.getFunction() = func
and vio_3609.(LocalVariable).getFunction() = func
and vret_3610.(LocalVariable).getFunction() = func
and vret2_3611.(LocalVariable).getFunction() = func
and v__mptr_3613.(LocalVariable).getFunction() = func
and v__mptr_3617.(LocalVariable).getFunction() = func
and v__mptr_3618.(LocalVariable).getFunction() = func
and v__mptr_1_3618.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
