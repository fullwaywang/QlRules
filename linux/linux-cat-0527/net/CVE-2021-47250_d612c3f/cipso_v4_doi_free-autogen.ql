/**
 * @name linux-d612c3f3fae221e7ea736d196581c2217304bbbc-cipso_v4_doi_free
 * @id cpp/linux/d612c3f3fae221e7ea736d196581c2217304bbbc/cipso-v4-doi-free
 * @description linux-d612c3f3fae221e7ea736d196581c2217304bbbc-net/ipv4/cipso_ipv4.c-cipso_v4_doi_free CVE-2021-47250
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdoi_def_464, PointerFieldAccess target_1, ValueFieldAccess target_2, ExprStmt target_3) {
exists(ExprStmt target_0 |
	target_0.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_0.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="std"
	and target_0.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="map"
	and target_0.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdoi_def_464
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
	and target_2.getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vdoi_def_464, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="type"
	and target_1.getQualifier().(VariableAccess).getTarget()=vdoi_def_464
}

predicate func_2(Parameter vdoi_def_464, ValueFieldAccess target_2) {
	target_2.getTarget().getName()="local"
	and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="cat"
	and target_2.getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="std"
	and target_2.getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="map"
	and target_2.getQualifier().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdoi_def_464
}

predicate func_3(Parameter vdoi_def_464, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdoi_def_464
}

from Function func, Parameter vdoi_def_464, PointerFieldAccess target_1, ValueFieldAccess target_2, ExprStmt target_3
where
not func_0(vdoi_def_464, target_1, target_2, target_3)
and func_1(vdoi_def_464, target_1)
and func_2(vdoi_def_464, target_2)
and func_3(vdoi_def_464, target_3)
and vdoi_def_464.getType().hasName("cipso_v4_doi *")
and vdoi_def_464.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
