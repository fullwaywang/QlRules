/**
 * @name linux-9581d442b9058d3699b4be568b6e5eae38a41493-vmx_save_host_state
 * @id cpp/linux/9581d442b9058d3699b4be568b6e5eae38a41493/vmx-save-host-state
 * @description linux-9581d442b9058d3699b4be568b6e5eae38a41493-arch/x86/kvm/vmx.c-vmx_save_host_state CVE-2010-3698
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(AsmStmt target_0 |
		target_0.getChild(0) instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_1(Function func) {
	exists(AsmStmt target_1 |
		target_1.getChild(0) instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1)
}

predicate func_2(Variable vvmx_793, ValueFieldAccess target_2) {
		target_2.getTarget().getName()="fs_sel"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="host_state"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmx_793
}

predicate func_3(Variable vvmx_793, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="gs_sel"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="host_state"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvmx_793
}

predicate func_4(Function func, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kvm_read_fs")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Function func, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kvm_read_gs")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

from Function func, Variable vvmx_793, ValueFieldAccess target_2, ValueFieldAccess target_3, ExprStmt target_4, ExprStmt target_5
where
not func_0(func)
and not func_1(func)
and func_2(vvmx_793, target_2)
and func_3(vvmx_793, target_3)
and func_4(func, target_4)
and func_5(func, target_5)
and vvmx_793.getType().hasName("vcpu_vmx *")
and vvmx_793.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
