/**
 * @name linux-f67b15037a7a50c57f72e69a6d59941ad90a0f0f-modify_user_hw_breakpoint
 * @id cpp/linux/f67b15037a7a50c57f72e69a6d59941ad90a0f0f/modify-user-hw-breakpoint
 * @description linux-f67b15037a7a50c57f72e69a6d59941ad90a0f0f-kernel/events/hw_breakpoint.c-modify_user_hw_breakpoint CVE-2018-1000199
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbp_433, ExprStmt target_8, ExprStmt target_22, ValueFieldAccess target_0) {
		target_0.getTarget().getName()="bp_addr"
		and target_0.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_2(Parameter vbp_433, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="attr"
		and target_2.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_3(Parameter vbp_433, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="attr"
		and target_3.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_4(Parameter vbp_433, ValueFieldAccess target_4) {
		target_4.getTarget().getName()="disabled"
		and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_5(Parameter vbp_433, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="attr"
		and target_5.getQualifier().(VariableAccess).getTarget()=vbp_433
}

predicate func_6(Parameter vattr_433, PointerFieldAccess target_6) {
		target_6.getTarget().getName()="disabled"
		and target_6.getQualifier().(VariableAccess).getTarget()=vattr_433
		and target_6.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_7(Variable verr_438, Parameter vbp_433, FunctionCall target_7) {
		target_7.getTarget().hasName("validate_hw_breakpoint")
		and target_7.getArgument(0).(VariableAccess).getTarget()=vbp_433
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_438
}

predicate func_8(Parameter vbp_433, NotExpr target_28, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
		and target_8.getParent().(IfStmt).getCondition()=target_28
}

predicate func_9(Variable verr_438, VariableAccess target_10, ReturnStmt target_9) {
		target_9.getExpr().(VariableAccess).getTarget()=verr_438
		and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

predicate func_10(Variable verr_438, BlockStmt target_29, VariableAccess target_10) {
		target_10.getTarget()=verr_438
		and target_10.getParent().(IfStmt).getThen()=target_29
}

predicate func_13(Function func, DeclStmt target_13) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Function func, DeclStmt target_14) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Function func, DeclStmt target_15) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(PointerFieldAccess target_6, Function func, GotoStmt target_16) {
		target_16.getParent().(IfStmt).getCondition()=target_6
		and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable verr_438, AssignExpr target_17) {
		target_17.getLValue().(VariableAccess).getTarget()=verr_438
		and target_17.getRValue() instanceof FunctionCall
}

predicate func_18(Variable verr_438, ExprStmt target_8, IfStmt target_19, VariableAccess target_18) {
		target_18.getTarget()=verr_438
		and target_18.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_8
		and target_18.getLocation().isBefore(target_19.getCondition().(VariableAccess).getLocation())
}

predicate func_19(Variable vold_addr_435, Variable vold_len_436, Variable vold_type_437, Variable verr_438, Parameter vbp_433, Function func, IfStmt target_19) {
		target_19.getCondition().(VariableAccess).getTarget()=verr_438
		and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
		and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_addr_435
		and target_19.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_type"
		and target_19.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_19.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_19.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_type_437
		and target_19.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
		and target_19.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_19.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_19.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
		and target_19.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="disabled"
		and target_19.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_19.getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_19.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
		and target_19.getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
		and target_19.getThen().(BlockStmt).getStmt(4) instanceof ReturnStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Parameter vbp_433, ExprStmt target_8, ExprStmt target_22, PointerFieldAccess target_20) {
		target_20.getTarget().getName()="attr"
		and target_20.getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_20.getQualifier().(VariableAccess).getLocation())
		and target_20.getQualifier().(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

/*predicate func_21(Variable vold_addr_435, VariableAccess target_21) {
		target_21.getTarget()=vold_addr_435
		and target_21.getParent().(AssignExpr).getRValue() = target_21
		and target_21.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

*/
predicate func_22(Variable vold_type_437, Parameter vbp_433, ExprStmt target_22) {
		target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_type"
		and target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_22.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_type_437
}

/*predicate func_23(Variable vold_len_436, Parameter vbp_433, VariableAccess target_10, ExprStmt target_23) {
		target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
		and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_23.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_23.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
		and target_23.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
/*predicate func_24(Variable vold_len_436, Parameter vbp_433, DeclStmt target_13, ExprStmt target_22, ValueFieldAccess target_24) {
		target_24.getTarget().getName()="bp_len"
		and target_24.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_24.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_24.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_24.getParent().(AssignExpr).getLValue() = target_24
		and target_24.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_len_436
		and target_22.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_24.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_25(Variable vold_len_436, Parameter vbp_433, VariableAccess target_25) {
		target_25.getTarget()=vold_len_436
		and target_25.getParent().(AssignExpr).getRValue() = target_25
		and target_25.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bp_len"
		and target_25.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_25.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_25.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
}

*/
/*predicate func_26(Parameter vbp_433, VariableAccess target_10, IfStmt target_26) {
		target_26.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="disabled"
		and target_26.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="attr"
		and target_26.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbp_433
		and target_26.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("perf_event_enable")
		and target_26.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbp_433
		and target_26.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
predicate func_27(Parameter vattr_433, Function func, ExprStmt target_27) {
		target_27.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
		and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="disabled"
		and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vattr_433
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_27
}

predicate func_28(Variable verr_438, NotExpr target_28) {
		target_28.getOperand().(VariableAccess).getTarget()=verr_438
}

predicate func_29(Variable vold_addr_435, BlockStmt target_29) {
		target_29.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
		and target_29.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vold_addr_435
		and target_29.getStmt(1) instanceof ExprStmt
		and target_29.getStmt(2) instanceof ExprStmt
		and target_29.getStmt(3) instanceof IfStmt
}

from Function func, Variable vold_addr_435, Variable vold_len_436, Variable vold_type_437, Variable verr_438, Parameter vbp_433, Parameter vattr_433, ValueFieldAccess target_0, PointerFieldAccess target_2, PointerFieldAccess target_3, ValueFieldAccess target_4, PointerFieldAccess target_5, PointerFieldAccess target_6, FunctionCall target_7, ExprStmt target_8, ReturnStmt target_9, VariableAccess target_10, DeclStmt target_13, DeclStmt target_14, DeclStmt target_15, GotoStmt target_16, AssignExpr target_17, VariableAccess target_18, IfStmt target_19, PointerFieldAccess target_20, ExprStmt target_22, ExprStmt target_27, NotExpr target_28, BlockStmt target_29
where
func_0(vbp_433, target_8, target_22, target_0)
and func_2(vbp_433, target_2)
and func_3(vbp_433, target_3)
and func_4(vbp_433, target_4)
and func_5(vbp_433, target_5)
and func_6(vattr_433, target_6)
and func_7(verr_438, vbp_433, target_7)
and func_8(vbp_433, target_28, target_8)
and func_9(verr_438, target_10, target_9)
and func_10(verr_438, target_29, target_10)
and func_13(func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(target_6, func, target_16)
and func_17(verr_438, target_17)
and func_18(verr_438, target_8, target_19, target_18)
and func_19(vold_addr_435, vold_len_436, vold_type_437, verr_438, vbp_433, func, target_19)
and func_20(vbp_433, target_8, target_22, target_20)
and func_22(vold_type_437, vbp_433, target_22)
and func_27(vattr_433, func, target_27)
and func_28(verr_438, target_28)
and func_29(vold_addr_435, target_29)
and vold_addr_435.getType().hasName("u64")
and vold_len_436.getType().hasName("u64")
and vold_type_437.getType().hasName("int")
and verr_438.getType().hasName("int")
and vbp_433.getType().hasName("perf_event *")
and vattr_433.getType().hasName("perf_event_attr *")
and vold_addr_435.(LocalVariable).getFunction() = func
and vold_len_436.(LocalVariable).getFunction() = func
and vold_type_437.(LocalVariable).getFunction() = func
and verr_438.(LocalVariable).getFunction() = func
and vbp_433.getFunction() = func
and vattr_433.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
