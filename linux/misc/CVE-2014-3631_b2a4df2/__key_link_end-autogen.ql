/**
 * @name linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-__key_link_end
 * @id cpp/linux/b2a4df200d570b2c33a57e1ebfa5896e4bc81b69/--key-link-end
 * @description linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-security/keys/keyring.c-__key_link_end CVE-2014-3631
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
		target_0.getTarget().hasName("__builtin_unreachable")
		and not target_0.getTarget().hasName("assoc_array_cancel_edit")
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, StringLiteral target_1) {
		target_1.getValue()="7==> %s(%d,%s,%lx)\n"
		and not target_1.getValue()="7==> %s(%d,%s,)\n"
		and target_1.getEnclosingFunction() = func
}

predicate func_4(Parameter vkeyring_957, BitwiseAndExpr target_13, ExprStmt target_4) {
		target_4.getExpr().(FunctionCall).getTarget().hasName("key_payload_reserve")
		and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkeyring_957
		and target_4.getExpr().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="datalen"
		and target_4.getExpr().(FunctionCall).getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_957
		and target_4.getExpr().(FunctionCall).getArgument(1).(SubExpr).getRightOperand().(Literal).getValue()="4"
		and target_4.getParent().(IfStmt).getCondition()=target_13
}

predicate func_5(Function func, DoStmt target_5) {
		target_5.getCondition() instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

/*predicate func_6(Function func, IfStmt target_6) {
		target_6.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_6.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="name"
		and target_6.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="type"
		and target_6.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getAnOperand() instanceof Literal
		and target_6.getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_6.getThen().(DoStmt).getCondition() instanceof Literal
		and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
		and target_6.getEnclosingFunction() = func
}

*/
/*predicate func_7(Function func, AsmStmt target_7) {
		target_7.getChild(0) instanceof StringLiteral
		and target_7.getChild(1) instanceof Literal
		and target_7.getChild(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_7.getChild(2).(SizeofTypeOperator).getValue()="12"
		and target_7.getEnclosingFunction() = func
}

*/
predicate func_8(Parameter vindex_key_958, Parameter vprealloc_959, Variable v__func__, Parameter vkeyring_957, Function func, ExprStmt target_8) {
		target_8.getExpr().(FunctionCall).getTarget().hasName("no_printk")
		and target_8.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_8.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
		and target_8.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="serial"
		and target_8.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_957
		and target_8.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="name"
		and target_8.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="type"
		and target_8.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_958
		and target_8.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vprealloc_959
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_9(Parameter vindex_key_958, Parameter vprealloc_959, Variable v__func__, Parameter vkeyring_957, EqualityOperation target_15, IfStmt target_16, ExprStmt target_4, VariableAccess target_9) {
		target_9.getTarget()=vprealloc_959
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("no_printk")
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="serial"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_957
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="name"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="type"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_958
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_9.getLocation().isBefore(target_16.getCondition().(VariableAccess).getLocation())
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
predicate func_10(Parameter vprealloc_959, BlockStmt target_17, ExprStmt target_8, BitwiseAndExpr target_13, VariableAccess target_10) {
		target_10.getTarget()=vprealloc_959
		and target_10.getParent().(IfStmt).getThen()=target_17
		and target_8.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_10.getLocation())
		and target_10.getLocation().isBefore(target_13.getLeftOperand().(VariableAccess).getLocation())
}

predicate func_11(Parameter vprealloc_959, VariableAccess target_10, IfStmt target_11) {
		target_11.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vprealloc_959
		and target_11.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
		and target_11.getThen() instanceof ExprStmt
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

predicate func_12(Parameter vprealloc_959, FunctionCall target_12) {
		target_12.getTarget().hasName("kfree")
		and target_12.getArgument(0).(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vprealloc_959
		and target_12.getArgument(0).(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073709551614"
}

predicate func_13(Parameter vprealloc_959, BitwiseAndExpr target_13) {
		target_13.getLeftOperand().(VariableAccess).getTarget()=vprealloc_959
		and target_13.getRightOperand() instanceof Literal
}

predicate func_15(Parameter vindex_key_958, EqualityOperation target_15) {
		target_15.getAnOperand().(PointerFieldAccess).getTarget().getName()="type"
		and target_15.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vindex_key_958
		and target_15.getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("key_type")
}

predicate func_16(Parameter vprealloc_959, IfStmt target_16) {
		target_16.getCondition().(VariableAccess).getTarget()=vprealloc_959
		and target_16.getThen() instanceof BlockStmt
}

predicate func_17(Function func, BlockStmt target_17) {
		target_17.getStmt(0) instanceof IfStmt
		and target_17.getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
		and target_17.getEnclosingFunction() = func
}

from Function func, Parameter vindex_key_958, Parameter vprealloc_959, Variable v__func__, Parameter vkeyring_957, FunctionCall target_0, StringLiteral target_1, ExprStmt target_4, DoStmt target_5, ExprStmt target_8, VariableAccess target_10, IfStmt target_11, FunctionCall target_12, BitwiseAndExpr target_13, EqualityOperation target_15, IfStmt target_16, BlockStmt target_17
where
func_0(func, target_0)
and func_1(func, target_1)
and func_4(vkeyring_957, target_13, target_4)
and func_5(func, target_5)
and func_8(vindex_key_958, vprealloc_959, v__func__, vkeyring_957, func, target_8)
and func_10(vprealloc_959, target_17, target_8, target_13, target_10)
and func_11(vprealloc_959, target_10, target_11)
and func_12(vprealloc_959, target_12)
and func_13(vprealloc_959, target_13)
and func_15(vindex_key_958, target_15)
and func_16(vprealloc_959, target_16)
and func_17(func, target_17)
and vindex_key_958.getType().hasName("const keyring_index_key *")
and vprealloc_959.getType().hasName("unsigned long")
and v__func__.getType() instanceof ArrayType
and vkeyring_957.getType().hasName("key *")
and vindex_key_958.getFunction() = func
and vprealloc_959.getFunction() = func
and not v__func__.getParentScope+() = func
and vkeyring_957.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
