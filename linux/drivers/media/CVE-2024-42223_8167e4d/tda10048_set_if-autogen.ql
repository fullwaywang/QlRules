/**
 * @name linux-8167e4d7dc086d4f7ca7897dcff3827e4d22c99a-tda10048_set_if
 * @id cpp/linux/8167e4d7dc086d4f7ca7897dcff3827e4d22c99a/tda10048-set-if
 * @description linux-8167e4d7dc086d4f7ca7897dcff3827e4d22c99a-drivers/media/dvb-frontends/tda10048.c-tda10048_set_if CVE-2024-42223
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(DoStmt target_14, Function func, ExprStmt target_0) {
	target_0.getExpr() instanceof AssignDivExpr
	and target_0.getLocation().isBefore(target_14.getLocation())
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vstate_421) {
exists(AssignExpr target_1 |
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getRValue() |
		obj_0.getTarget().getName()="xtal_hz"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_1.getLValue().(VariableAccess).getType().hasName("u64")
)
}

predicate func_2(Function func) {
exists(AssignMulExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("u64")
	and target_2.getRValue() instanceof AddExpr
	and target_2.getEnclosingFunction() = func
)
}

predicate func_3(Function func) {
exists(StmtExpr target_3 |
	exists(BlockStmt obj_0 | obj_0=target_3.getStmt() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(AssignExpr obj_2 | obj_2=obj_1.getExpr() |
				exists(RemExpr obj_3 | obj_3=obj_2.getRValue() |
					obj_3.getLeftOperand().(VariableAccess).getType().hasName("u64")
					and obj_3.getRightOperand().(VariableAccess).getType().hasName("uint32_t")
				)
				and obj_2.getLValue().(VariableAccess).getType().hasName("uint32_t")
			)
		)
		and exists(ExprStmt obj_4 | obj_4=obj_0.getStmt(3) |
			exists(AssignExpr obj_5 | obj_5=obj_4.getExpr() |
				exists(DivExpr obj_6 | obj_6=obj_5.getRValue() |
					obj_6.getLeftOperand().(VariableAccess).getType().hasName("u64")
					and obj_6.getRightOperand().(VariableAccess).getType().hasName("uint32_t")
				)
				and obj_5.getLValue().(VariableAccess).getType().hasName("u64")
			)
		)
		and obj_0.getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("uint32_t")
	)
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(DoStmt target_14, Function func) {
exists(ExprStmt target_4 |
	exists(StmtExpr obj_0 | obj_0=target_4.getExpr() |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(ExprStmt obj_2 | obj_2=obj_1.getStmt(2) |
				exists(AssignExpr obj_3 | obj_3=obj_2.getExpr() |
					exists(RemExpr obj_4 | obj_4=obj_3.getRValue() |
						obj_4.getLeftOperand().(VariableAccess).getType().hasName("u64")
						and obj_4.getRightOperand().(VariableAccess).getType().hasName("uint32_t")
					)
					and obj_3.getLValue().(VariableAccess).getType().hasName("uint32_t")
				)
			)
			and exists(ExprStmt obj_5 | obj_5=obj_1.getStmt(3) |
				exists(AssignExpr obj_6 | obj_6=obj_5.getExpr() |
					exists(DivExpr obj_7 | obj_7=obj_6.getRValue() |
						obj_7.getLeftOperand().(VariableAccess).getType().hasName("u64")
						and obj_7.getRightOperand().(VariableAccess).getType().hasName("uint32_t")
					)
					and obj_6.getLValue().(VariableAccess).getType().hasName("u64")
				)
			)
			and obj_1.getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("uint32_t")
		)
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_14.getLocation())
)
}

predicate func_5(Variable vstate_421, DoStmt target_14, ExprStmt target_15, Function func) {
exists(ExprStmt target_5 |
	exists(AssignExpr obj_0 | obj_0=target_5.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="sample_freq"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vstate_421
		)
		and obj_0.getRValue().(VariableAccess).getType().hasName("u64")
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_14.getLocation())
	and target_15.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_7(Variable vstate_421, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="xtal_hz"
	and target_7.getQualifier().(VariableAccess).getTarget()=vstate_421
}

predicate func_8(Variable vstate_421, AddExpr target_8) {
	exists(PointerFieldAccess obj_0 | obj_0=target_8.getLeftOperand() |
		obj_0.getTarget().getName()="pll_mfactor"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_8.getRightOperand().(Literal).getValue()="45"
}

predicate func_9(Variable vstate_421, AddExpr target_9) {
	exists(PointerFieldAccess obj_0 | obj_0=target_9.getLeftOperand() |
		obj_0.getTarget().getName()="pll_nfactor"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_9.getRightOperand().(Literal).getValue()="1"
}

predicate func_10(Variable vstate_421, AddExpr target_10) {
	exists(PointerFieldAccess obj_0 | obj_0=target_10.getLeftOperand() |
		obj_0.getTarget().getName()="pll_pfactor"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_10.getRightOperand().(Literal).getValue()="4"
}

predicate func_11(Variable vstate_421, MulExpr target_11) {
	exists(PointerFieldAccess obj_0 | obj_0=target_11.getLeftOperand() |
		obj_0.getTarget().getName()="xtal_hz"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and exists(AssignExpr obj_1 | obj_1=target_11.getParent() |
		exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLValue() |
			obj_2.getTarget().getName()="sample_freq"
			and obj_2.getQualifier().(VariableAccess).getTarget()=vstate_421
		)
		and obj_1.getRValue() = target_11
	)
	and target_11.getRightOperand() instanceof AddExpr
}

predicate func_12(Variable vstate_421, AssignDivExpr target_12) {
	exists(PointerFieldAccess obj_0 | obj_0=target_12.getLValue() |
		obj_0.getTarget().getName()="sample_freq"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_12.getRValue() instanceof AddExpr
}

predicate func_13(Variable vstate_421, AssignDivExpr target_13) {
	exists(PointerFieldAccess obj_0 | obj_0=target_13.getLValue() |
		obj_0.getTarget().getName()="sample_freq"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vstate_421
	)
	and target_13.getRValue() instanceof AddExpr
}

predicate func_14(Variable vstate_421, DoStmt target_14) {
	exists(BlockStmt obj_0 | obj_0=target_14.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(RelationalOperation obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getGreaterOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
				and obj_2.getLesserOperand().(Literal).getValue()="1"
			)
			and exists(ExprStmt obj_3 | obj_3=obj_1.getThen() |
				exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
					exists(PointerFieldAccess obj_5 | obj_5=obj_4.getArgument(1) |
						obj_5.getTarget().getName()="sample_freq"
						and obj_5.getQualifier().(VariableAccess).getTarget()=vstate_421
					)
					and obj_4.getTarget().hasName("printk")
					and obj_4.getArgument(0).(StringLiteral).getValue()="7tda10048: - sample_freq = %d\n"
				)
			)
		)
	)
	and target_14.getCondition().(Literal).getValue()="0"
}

predicate func_15(Variable vstate_421, ExprStmt target_15) {
	exists(FunctionCall obj_0 | obj_0=target_15.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getArgument(1) |
			obj_1.getTarget().getName()="pll_pfactor"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vstate_421
		)
		and obj_0.getTarget().hasName("printk")
		and obj_0.getArgument(0).(StringLiteral).getValue()="7tda10048: - pll_pfactor = %d\n"
	)
}

from Function func, Variable vstate_421, ExprStmt target_0, PointerFieldAccess target_7, AddExpr target_8, AddExpr target_9, AddExpr target_10, MulExpr target_11, AssignDivExpr target_12, AssignDivExpr target_13, DoStmt target_14, ExprStmt target_15
where
func_0(target_14, func, target_0)
and not func_1(vstate_421)
and not func_2(func)
and not func_3(func)
and not func_4(target_14, func)
and not func_5(vstate_421, target_14, target_15, func)
and func_7(vstate_421, target_7)
and func_8(vstate_421, target_8)
and func_9(vstate_421, target_9)
and func_10(vstate_421, target_10)
and func_11(vstate_421, target_11)
and func_12(vstate_421, target_12)
and func_13(vstate_421, target_13)
and func_14(vstate_421, target_14)
and func_15(vstate_421, target_15)
and vstate_421.getType().hasName("tda10048_state *")
and vstate_421.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
