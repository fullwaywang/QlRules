/**
 * @name linux-4ea99936a1630f51fc3a2d61a58ec4a1c4b7d55a-ext4_clamp_want_extra_isize
 * @id cpp/linux/4ea99936a1630f51fc3a2d61a58ec4a1c4b7d55a/ext4-clamp-want-extra-isize
 * @description linux-4ea99936a1630f51fc3a2d61a58ec4a1c4b7d55a-fs/ext4/super.c-ext4_clamp_want_extra_isize CVE-2019-19767
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="128"
	and not target_0.getValue()="4"
	and target_0.getParent().(SubExpr).getParent().(AssignExpr).getRValue() instanceof SubExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vsbi_3546, IfStmt target_1) {
	target_1.getCondition() instanceof RelationalOperation
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof SubExpr
	and target_1.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_1.getFollowingStmt() instanceof ReturnStmt
}

predicate func_2(Variable vsbi_3546, BlockStmt target_19, ExprStmt target_20) {
exists(RelationalOperation target_2 |
	 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
	and target_2.getLesserOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_2.getGreaterOperand().(Literal).getValue()="4"
	and target_2.getParent().(IfStmt).getThen()=target_19
	and target_2.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Variable vsbi_3546, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="s_inode_size"
	and target_4.getCondition().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_4.getCondition().(LogicalOrExpr).getRightOperand() instanceof RelationalOperation
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("unsigned int")
	and target_4.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof ReturnStmt)
}

/*predicate func_6(Variable vsbi_3546, LogicalAndExpr target_17) {
exists(PointerFieldAccess target_6 |
	target_6.getTarget().getName()="s_inode_size"
	and target_6.getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_6.getQualifier().(VariableAccess).getLocation().isBefore(target_17.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_7(Function func) {
exists(ReturnStmt target_7 |
	func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_8(Variable vsbi_3546, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="s_inode_size"
	and target_8.getQualifier().(VariableAccess).getTarget()=vsbi_3546
}

predicate func_9(Variable vsbi_3546, PointerFieldAccess target_9) {
	target_9.getTarget().getName()="s_want_extra_isize"
	and target_9.getQualifier().(VariableAccess).getTarget()=vsbi_3546
}

predicate func_10(Variable vsbi_3546, SubExpr target_10) {
	target_10.getValue()="32"
	and target_10.getParent().(AssignExpr).getRValue() = target_10
	and target_10.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_10.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
}

predicate func_11(Parameter vsb_3544, Variable vsbi_3546, Variable ves_3547, LogicalAndExpr target_17, IfStmt target_11) {
	target_11.getCondition().(FunctionCall).getTarget().hasName("ext4_has_feature_extra_isize")
	and target_11.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsb_3544
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ves_3547
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ves_3547
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="s_min_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ves_3547
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="s_min_extra_isize"
	and target_11.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ves_3547
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

predicate func_12(Variable vsbi_3546, BlockStmt target_21, RelationalOperation target_12) {
	 (target_12 instanceof GTExpr or target_12 instanceof LTExpr)
	and target_12.getGreaterOperand().(AddExpr).getLeftOperand().(Literal).getValue()="128"
	and target_12.getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_12.getGreaterOperand().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_12.getLesserOperand().(PointerFieldAccess).getTarget().getName()="s_inode_size"
	and target_12.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_12.getParent().(IfStmt).getThen()=target_21
}

predicate func_13(Parameter vsb_3544, RelationalOperation target_12, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("__ext4_msg")
	and target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsb_3544
	and target_13.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="6"
	and target_13.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="required extra inode space not available"
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

predicate func_16(Function func, ReturnStmt target_16) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(Variable vsbi_3546, BlockStmt target_19, LogicalAndExpr target_17) {
	target_17.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="s_inode_size"
	and target_17.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_17.getLeftOperand().(RelationalOperation).getLesserOperand() instanceof Literal
	and target_17.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_17.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_17.getRightOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_17.getParent().(IfStmt).getThen()=target_19
}

predicate func_18(Variable vsbi_3546, SubExpr target_18) {
	target_18.getValue()="32"
	and target_18.getParent().(AssignExpr).getRValue() = target_18
	and target_18.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_18.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
}

predicate func_19(Variable vsbi_3546, BlockStmt target_19) {
	target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof SubExpr
	and target_19.getStmt(1) instanceof IfStmt
}

predicate func_20(Variable vsbi_3546, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_20.getExpr().(AssignExpr).getRValue() instanceof SubExpr
}

predicate func_21(Variable vsbi_3546, BlockStmt target_21) {
	target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_want_extra_isize"
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_3546
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof SubExpr
	and target_21.getStmt(1) instanceof ExprStmt
}

from Function func, Parameter vsb_3544, Variable vsbi_3546, Variable ves_3547, Literal target_0, IfStmt target_1, PointerFieldAccess target_8, PointerFieldAccess target_9, SubExpr target_10, IfStmt target_11, RelationalOperation target_12, ExprStmt target_13, ReturnStmt target_16, LogicalAndExpr target_17, SubExpr target_18, BlockStmt target_19, ExprStmt target_20, BlockStmt target_21
where
func_0(func, target_0)
and func_1(vsbi_3546, target_1)
and not func_2(vsbi_3546, target_19, target_20)
and not func_4(vsbi_3546, func)
and not func_7(func)
and func_8(vsbi_3546, target_8)
and func_9(vsbi_3546, target_9)
and func_10(vsbi_3546, target_10)
and func_11(vsb_3544, vsbi_3546, ves_3547, target_17, target_11)
and func_12(vsbi_3546, target_21, target_12)
and func_13(vsb_3544, target_12, target_13)
and func_16(func, target_16)
and func_17(vsbi_3546, target_19, target_17)
and func_18(vsbi_3546, target_18)
and func_19(vsbi_3546, target_19)
and func_20(vsbi_3546, target_20)
and func_21(vsbi_3546, target_21)
and vsb_3544.getType().hasName("super_block *")
and vsbi_3546.getType().hasName("ext4_sb_info *")
and ves_3547.getType().hasName("ext4_super_block *")
and vsb_3544.getFunction() = func
and vsbi_3546.(LocalVariable).getFunction() = func
and ves_3547.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
