/**
 * @name linux-5c17c861a357e9458001f021a7afa7aab9937439-tty_ioctl
 * @id cpp/linux/5c17c861a357e9458001f021a7afa7aab9937439/tty-ioctl
 * @description linux-5c17c861a357e9458001f021a7afa7aab9937439-drivers/tty/tty_io.c-tty_ioctl CVE-2016-0723
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtty_2817, Variable vp_2819, FunctionCall target_25, FunctionCall target_26) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("tiocgetd")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vtty_2817
		and target_0.getArgument(1).(VariableAccess).getTarget()=vp_2819
		and target_25.getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(VariableAccess).getLocation())
		and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_26.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Function func, ExprStmt target_1) {
		target_1.getExpr().(Literal).getValue()="0"
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, SwitchCase target_2) {
		target_2.getExpr().(Literal).getValue()="2"
		and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, SwitchCase target_3) {
		target_3.getExpr().(Literal).getValue()="4"
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, SwitchCase target_4) {
		target_4.getExpr().(Literal).getValue()="8"
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable v__ret_pu_2887, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_5.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_6(Variable vtty_2817, VariableAccess target_6) {
		target_6.getTarget()=vtty_2817
}

predicate func_7(Variable vp_2819, VariableAccess target_7) {
		target_7.getTarget()=vp_2819
}

predicate func_8(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, StmtExpr target_8) {
		target_8.getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_8.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__might_fault")
		and target_8.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_8.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
		and target_8.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="num"
		and target_8.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
		and target_8.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ldisc"
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getExpr().(SizeofExprOperator).getValue()="4"
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(3) instanceof SwitchCase
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(6) instanceof SwitchCase
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(9) instanceof SwitchCase
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(12).(SwitchCase).toString() = "default: "
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_8.getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_8.getStmt().(BlockStmt).getStmt(6) instanceof LabelStmt
		and target_8.getStmt().(BlockStmt).getStmt(7) instanceof ExprStmt
}

/*predicate func_11(Variable v__pu_val_2887, Variable vtty_2817, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__pu_val_2887
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="num"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ldisc"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtty_2817
}

*/
/*predicate func_12(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, FunctionCall target_26, SwitchStmt target_12) {
		target_12.getExpr().(SizeofExprOperator).getValue()="4"
		and target_12.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
		and target_12.getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_12.getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_12.getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_12.getStmt().(BlockStmt).getStmt(3) instanceof SwitchCase
		and target_12.getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_12.getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_12.getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_12.getStmt().(BlockStmt).getStmt(6) instanceof SwitchCase
		and target_12.getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_12.getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_12.getStmt().(BlockStmt).getStmt(7).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_12.getStmt().(BlockStmt).getStmt(9) instanceof SwitchCase
		and target_12.getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_12.getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_12.getStmt().(BlockStmt).getStmt(10).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_12.getStmt().(BlockStmt).getStmt(12).(SwitchCase).toString() = "default: "
		and target_12.getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_12.getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_12.getStmt().(BlockStmt).getStmt(13).(AsmStmt).getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_12.getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(2).(VariableAccess).getLocation().isBefore(target_26.getArgument(1).(VariableAccess).getLocation())
}

*/
/*predicate func_13(Function func, SwitchCase target_13) {
		target_13.getExpr().(Literal).getValue()="1"
		and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, SizeofExprOperator target_27, AsmStmt target_14) {
		target_14.getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_14.getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_14.getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_14.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
}

*/
/*predicate func_15(SizeofExprOperator target_27, Function func, BreakStmt target_15) {
		target_15.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_16(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, SizeofExprOperator target_27, AsmStmt target_16) {
		target_16.getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_16.getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_16.getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_16.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
}

*/
/*predicate func_17(SizeofExprOperator target_27, Function func, BreakStmt target_17) {
		target_17.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_17.getEnclosingFunction() = func
}

*/
/*predicate func_18(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, SizeofExprOperator target_27, AsmStmt target_18) {
		target_18.getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_18.getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_18.getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_18.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
}

*/
/*predicate func_19(SizeofExprOperator target_27, Function func, BreakStmt target_19) {
		target_19.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_19.getEnclosingFunction() = func
}

*/
/*predicate func_20(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, SizeofExprOperator target_27, AsmStmt target_20) {
		target_20.getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_20.getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_20.getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_20.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
}

*/
/*predicate func_21(SizeofExprOperator target_27, Function func, BreakStmt target_21) {
		target_21.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_21.getEnclosingFunction() = func
}

*/
/*predicate func_22(Function func, SwitchCase target_22) {
		target_22.toString() = "default: "
		and target_22.getEnclosingFunction() = func
}

*/
/*predicate func_23(Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vp_2819, SizeofExprOperator target_27, FunctionCall target_26, AsmStmt target_23) {
		target_23.getChild(0).(VariableAccess).getTarget()=v__ret_pu_2887
		and target_23.getChild(1).(VariableAccess).getTarget()=v__pu_val_2887
		and target_23.getChild(2).(VariableAccess).getTarget()=vp_2819
		and target_23.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_23.getChild(2).(VariableAccess).getLocation().isBefore(target_26.getArgument(1).(VariableAccess).getLocation())
}

*/
/*predicate func_24(SizeofExprOperator target_27, Function func, BreakStmt target_24) {
		target_24.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_27
		and target_24.getEnclosingFunction() = func
}

*/
predicate func_25(Variable vtty_2817, Variable vp_2819, FunctionCall target_25) {
		target_25.getTarget().hasName("tiocgsid")
		and target_25.getArgument(0).(VariableAccess).getTarget()=vtty_2817
		and target_25.getArgument(1).(VariableAccess).getTarget().getType().hasName("tty_struct *")
		and target_25.getArgument(2).(VariableAccess).getTarget()=vp_2819
}

predicate func_26(Variable vtty_2817, Variable vp_2819, FunctionCall target_26) {
		target_26.getTarget().hasName("tiocsetd")
		and target_26.getArgument(0).(VariableAccess).getTarget()=vtty_2817
		and target_26.getArgument(1).(VariableAccess).getTarget()=vp_2819
}

predicate func_27(Function func, SizeofExprOperator target_27) {
		target_27.getValue()="4"
		and target_27.getEnclosingFunction() = func
}

from Function func, Variable v__ret_pu_2887, Variable v__pu_val_2887, Variable vtty_2817, Variable vp_2819, ExprStmt target_1, SwitchCase target_2, SwitchCase target_3, SwitchCase target_4, ExprStmt target_5, VariableAccess target_6, VariableAccess target_7, StmtExpr target_8, FunctionCall target_25, FunctionCall target_26, SizeofExprOperator target_27
where
not func_0(vtty_2817, vp_2819, target_25, target_26)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(v__ret_pu_2887, target_5)
and func_6(vtty_2817, target_6)
and func_7(vp_2819, target_7)
and func_8(v__ret_pu_2887, v__pu_val_2887, vp_2819, target_8)
and func_25(vtty_2817, vp_2819, target_25)
and func_26(vtty_2817, vp_2819, target_26)
and func_27(func, target_27)
and v__ret_pu_2887.getType().hasName("int")
and v__pu_val_2887.getType().hasName("int")
and vtty_2817.getType().hasName("tty_struct *")
and vp_2819.getType().hasName("void *")
and v__ret_pu_2887.(LocalVariable).getFunction() = func
and v__pu_val_2887.(LocalVariable).getFunction() = func
and vtty_2817.(LocalVariable).getFunction() = func
and vp_2819.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
