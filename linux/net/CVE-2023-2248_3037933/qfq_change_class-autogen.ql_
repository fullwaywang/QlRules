/**
 * @name linux-3037933448f60f9acb705997eae62013ecb81e0d-qfq_change_class
 * @id cpp/linux/3037933448f60f9acb705997eae62013ecb81e0d/qfq-change-class
 * @description linux-3037933448f60f9acb705997eae62013ecb81e0d-net/sched/sch_qfq.c-qfq_change_class CVE-2023-2248
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtb_399, Variable vlmax_401, ArrayExpr target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlmax_401
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_get_u32")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vtb_399
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
}

predicate func_1(Variable vtb_399, ArrayExpr target_1) {
	target_1.getArrayBase().(VariableAccess).getTarget()=vtb_399
}

from Function func, Variable vtb_399, Variable vlmax_401, ExprStmt target_0, ArrayExpr target_1
where
func_0(vtb_399, vlmax_401, target_1, target_0)
and func_1(vtb_399, target_1)
and vtb_399.getType().hasName("nlattr *[3]")
and vlmax_401.getType().hasName("u32")
and vtb_399.(LocalVariable).getFunction() = func
and vlmax_401.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
