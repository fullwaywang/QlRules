commit 1f798a8525fb85be1a4aa526bdb8420f8cdced0e	1f798a8525fb85be1a4aa526bdb8420f8cdced0e
Author: Daniel Cheng <dcheng@chromium.org>
Date:   Mon Jul 17 19:06:10 2023 +0000

    Set current document when processing xsl document().
    
    This is needed to look up various properties of the owning document when
    parsing XML in Blink.
    
    Bug: 1458911
    Change-Id: If97b6a0a3364c526539c5b7bc0fd40dc01fd1731
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4691202
    Reviewed-by: Joey Arhar <jarhar@chromium.org>
    Commit-Queue: Daniel Cheng <dcheng@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1171307}

diff --git a/third_party/blink/renderer/core/xml/xslt_processor_libxslt.cc b/third_party/blink/renderer/core/xml/xslt_processor_libxslt.cc
index 3f563c5eb021b..133e0b3355d2f 100644
--- a/third_party/blink/renderer/core/xml/xslt_processor_libxslt.cc
+++ b/third_party/blink/renderer/core/xml/xslt_processor_libxslt.cc
@@ -34,6 +34,7 @@
 #include "third_party/blink/renderer/core/frame/local_frame.h"
 #include "third_party/blink/renderer/core/inspector/console_message.h"
 #include "third_party/blink/renderer/core/xml/parser/xml_document_parser.h"
+#include "third_party/blink/renderer/core/xml/parser/xml_document_parser_scope.h"
 #include "third_party/blink/renderer/core/xml/xsl_style_sheet.h"
 #include "third_party/blink/renderer/core/xml/xslt_extensions.h"
 #include "third_party/blink/renderer/core/xml/xslt_unicode_sort.h"
@@ -106,6 +107,9 @@ static xmlDocPtr DocLoaderFunc(const xmlChar* uri,
 
   switch (type) {
     case XSLT_LOAD_DOCUMENT: {
+      XMLDocumentParserScope scope(
+          g_global_processor->XslStylesheet()->OwnerDocument());
+
       xsltTransformContextPtr context = (xsltTransformContextPtr)ctxt;
       xmlChar* base = xmlNodeGetBase(context->document->doc, context->node);
       KURL url(KURL(reinterpret_cast<const char*>(base)),
diff --git a/third_party/blink/web_tests/http/tests/xsl/resources/xsl-using-document-with-external-entity-target-document.xml b/third_party/blink/web_tests/http/tests/xsl/resources/xsl-using-document-with-external-entity-target-document.xml
new file mode 100644
index 0000000000000..41d6d906db262
--- /dev/null
+++ b/third_party/blink/web_tests/http/tests/xsl/resources/xsl-using-document-with-external-entity-target-document.xml
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!DOCTYPE p [
+<!ENTITY secretfile SYSTEM "file:///secret/file">
+<!ENTITY secreturl SYSTEM "http://example.com">
+]>
+<p>
+    &secretfile;
+    &secreturl;
+</p>
diff --git a/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity-expected.txt b/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity-expected.txt
new file mode 100644
index 0000000000000..04e3c4a1e079e
--- /dev/null
+++ b/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity-expected.txt
@@ -0,0 +1,5 @@
+CONSOLE ERROR: Unsafe attempt to load URL xsl-using-document-with-external-entity.xml. Domains, protocols and ports must match.
+
+CONSOLE ERROR: Unsafe attempt to load URL http://example.com/ from frame with URL http://127.0.0.1:8000/xsl/xsl-using-document-with-external-entity.xml. Domains, protocols and ports must match.
+
+Test that loading external entities from an XML document created by the XSL document() function are denied. On success, there will be two console errors that the load attempt was denied.
diff --git a/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity.xml b/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity.xml
new file mode 100644
index 0000000000000..bad68e4085b27
--- /dev/null
+++ b/third_party/blink/web_tests/http/tests/xsl/xsl-using-document-with-external-entity.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<?xml-stylesheet type="text/xsl"?>
+<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
+  <xsl:output method="html" encoding="UTF-8"/>
+  <xsl:template match="/">
+    <html>
+      <body>
+        <script>if (testRunner) testRunner.dumpAsText();</script>
+        <p>
+          Test that loading external entities from an XML document created by
+          the XSL document() function are denied. On success, there will be
+          two console errors that the load attempt was denied.
+        </p>
+        <xsl:value-of select="document('resources/xsl-using-document-with-external-entity-target-document.xml')"/>
+      </body>
+    </html>
+  </xsl:template>
+</xsl:stylesheet>
