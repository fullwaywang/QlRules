/**
 * @name linux-531eab2da27dd42d68dfb841d82e987f4a6738b8-mlx5_lag_create_port_sel_table
 * @id cpp/linux/531eab2da27dd42d68dfb841d82e987f4a6738b8/mlx5-lag-create-port-sel-table
 * @description linux-531eab2da27dd42d68dfb841d82e987f4a6738b8-drivers/net/ethernet/mellanox/mlx5/core/lag/port_sel.c-mlx5_lag_create_port_sel_table CVE-2024-40940
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vidx_48, Variable vj_49, Parameter vldev_38, FunctionCall target_6, ArrayExpr target_7, ArrayExpr target_8, ExprStmt target_9) {
exists(DoStmt target_0 |
	exists(BlockStmt obj_0 | obj_0=target_0.getStmt() |
		exists(WhileStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				obj_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vidx_48
				and obj_2.getStmt(1) instanceof ExprStmt
			)
			and obj_1.getCondition() instanceof PostfixDecrExpr
		)
		and exists(ExprStmt obj_3 | obj_3=obj_0.getStmt(1) |
			exists(AssignExpr obj_4 | obj_4=obj_3.getExpr() |
				exists(PointerFieldAccess obj_5 | obj_5=obj_4.getRValue() |
					obj_5.getTarget().getName()="buckets"
					and obj_5.getQualifier().(VariableAccess).getTarget()=vldev_38
				)
				and obj_4.getLValue().(VariableAccess).getTarget()=vj_49
			)
		)
	)
	and exists(BlockStmt obj_6 | obj_6=target_0.getParent() |
		exists(IfStmt obj_7 | obj_7=obj_6.getParent() |
			obj_7.getThen().(BlockStmt).getStmt(1)=target_0
			and obj_7.getCondition()=target_6
		)
	)
	and target_0.getCondition() instanceof PostfixDecrExpr
	and target_7.getArrayOffset().(VariableAccess).getLocation().isBefore(target_0.getStmt().(BlockStmt).getStmt(0).(WhileStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_0.getStmt().(BlockStmt).getStmt(0).(WhileStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_8.getArrayOffset().(VariableAccess).getLocation())
	and target_9.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
)
}

/*predicate func_1(Variable vi_47, Variable vidx_48, Variable vj_49, Parameter vldev_38, PostfixDecrExpr target_2, ArrayExpr target_7, ArrayExpr target_8, PostfixDecrExpr target_3) {
exists(ExprStmt target_1 |
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		exists(AddExpr obj_1 | obj_1=obj_0.getRValue() |
			exists(MulExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getRightOperand() |
					obj_3.getTarget().getName()="buckets"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vldev_38
				)
				and obj_2.getLeftOperand().(VariableAccess).getTarget()=vi_47
			)
			and obj_1.getRightOperand().(VariableAccess).getTarget()=vj_49
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vidx_48
	)
	and exists(AssignExpr obj_4 | obj_4=target_1.getExpr() |
		obj_4.getLValue().(VariableAccess).getLocation().isBefore(target_8.getArrayOffset().(VariableAccess).getLocation())
		and obj_4.getRValue().(AddExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_3.getOperand().(VariableAccess).getLocation())
	)
	and target_2.getOperand().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(MulExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_7.getArrayOffset().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
)
}

*/
predicate func_2(Variable vi_47, PostfixDecrExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vi_47
}

predicate func_3(Variable vj_49, PostfixDecrExpr target_3) {
	target_3.getOperand().(VariableAccess).getTarget()=vj_49
}

predicate func_4(Variable vidx_48, Parameter vlag_definer_39, PostfixDecrExpr target_3, ExprStmt target_4) {
	exists(FunctionCall obj_0 | obj_0=target_4.getExpr() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getArrayBase() |
				obj_2.getTarget().getName()="rules"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vlag_definer_39
			)
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vidx_48
		)
		and obj_0.getTarget().hasName("mlx5_del_flow_rules")
	)
	and target_4.getParent().(WhileStmt).getCondition()=target_3
}

predicate func_5(PostfixDecrExpr target_2, Function func, WhileStmt target_5) {
	target_5.getCondition() instanceof PostfixDecrExpr
	and target_5.getStmt() instanceof ExprStmt
	and target_5.getParent().(WhileStmt).getCondition()=target_2
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Variable vidx_48, Parameter vlag_definer_39, FunctionCall target_6) {
	exists(ArrayExpr obj_0 | obj_0=target_6.getArgument(0) |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getArrayBase() |
			obj_1.getTarget().getName()="rules"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vlag_definer_39
		)
		and obj_0.getArrayOffset().(VariableAccess).getTarget()=vidx_48
	)
	and target_6.getTarget().hasName("IS_ERR")
}

predicate func_7(Variable vidx_48, Parameter vlag_definer_39, ArrayExpr target_7) {
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getArrayBase() |
		obj_0.getTarget().getName()="rules"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vlag_definer_39
	)
	and target_7.getArrayOffset().(VariableAccess).getTarget()=vidx_48
	and target_7.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("PTR_ERR")
}

predicate func_8(Variable vidx_48, Parameter vlag_definer_39, ArrayExpr target_8) {
	exists(PointerFieldAccess obj_0 | obj_0=target_8.getArrayBase() |
		obj_0.getTarget().getName()="rules"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vlag_definer_39
	)
	and target_8.getArrayOffset().(VariableAccess).getTarget()=vidx_48
	and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mlx5_del_flow_rules")
}

predicate func_9(Variable vi_47, Variable vidx_48, Variable vj_49, Parameter vldev_38, ExprStmt target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getExpr() |
		exists(AddExpr obj_1 | obj_1=obj_0.getRValue() |
			exists(MulExpr obj_2 | obj_2=obj_1.getLeftOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getRightOperand() |
					obj_3.getTarget().getName()="buckets"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vldev_38
				)
				and obj_2.getLeftOperand().(VariableAccess).getTarget()=vi_47
			)
			and obj_1.getRightOperand().(VariableAccess).getTarget()=vj_49
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vidx_48
	)
}

from Function func, Variable vi_47, Variable vidx_48, Variable vj_49, Parameter vldev_38, Parameter vlag_definer_39, PostfixDecrExpr target_2, PostfixDecrExpr target_3, ExprStmt target_4, WhileStmt target_5, FunctionCall target_6, ArrayExpr target_7, ArrayExpr target_8, ExprStmt target_9
where
not func_0(vidx_48, vj_49, vldev_38, target_6, target_7, target_8, target_9)
and func_2(vi_47, target_2)
and func_3(vj_49, target_3)
and func_4(vidx_48, vlag_definer_39, target_3, target_4)
and func_5(target_2, func, target_5)
and func_6(vidx_48, vlag_definer_39, target_6)
and func_7(vidx_48, vlag_definer_39, target_7)
and func_8(vidx_48, vlag_definer_39, target_8)
and func_9(vi_47, vidx_48, vj_49, vldev_38, target_9)
and vi_47.getType().hasName("int")
and vidx_48.getType().hasName("int")
and vj_49.getType().hasName("int")
and vldev_38.getType().hasName("mlx5_lag *")
and vlag_definer_39.getType().hasName("mlx5_lag_definer *")
and vi_47.(LocalVariable).getFunction() = func
and vidx_48.(LocalVariable).getFunction() = func
and vj_49.(LocalVariable).getFunction() = func
and vldev_38.getFunction() = func
and vlag_definer_39.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
