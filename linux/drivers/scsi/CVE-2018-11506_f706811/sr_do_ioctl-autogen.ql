/**
 * @name linux-f7068114d45ec55996b9040e98111afa56e010fe-sr_do_ioctl
 * @id cpp/linux/f7068114d45ec55996b9040e98111afa56e010fe/sr-do-ioctl
 * @description linux-f7068114d45ec55996b9040e98111afa56e010fe-drivers/scsi/sr_ioctl.c-sr_do_ioctl CVE-2018-11506
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcgc_186, ExprStmt target_6, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(PointerFieldAccess).getTarget().getName()="sense"
		and target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned char *")
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("unsigned char[96]")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_1(Function func) {
	exists(AssignExpr target_1 |
		target_1.getLValue().(VariableAccess).getType().hasName("unsigned char *")
		and target_1.getRValue().(VariableAccess).getType().hasName("unsigned char[96]")
		and target_1.getEnclosingFunction() = func)
}

*/
predicate func_2(Variable vsshdr_189, Variable vresult_190, Parameter vcgc_186, Variable vSDev_188, ValueFieldAccess target_8, EqualityOperation target_10, NotExpr target_11, NotExpr target_12, ExprStmt target_13, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_190
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("scsi_execute")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vSDev_188
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="cmd"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="data_direction"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="buffer"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="buflen"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getType().hasName("unsigned char *")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vsshdr_189
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getTarget().getName()="timeout"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="3"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(9).(Literal).getValue()="0"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(10).(Literal).getValue()="0"
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(11).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_8.getQualifier().(VariableAccess).getLocation())
		and target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getAnOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getLocation())
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_12.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vcgc_186, Function func) {
	exists(IfStmt target_4 |
		target_4.getCondition().(PointerFieldAccess).getTarget().getName()="sense"
		and target_4.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sense"
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned char[96]")
		and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="64"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4)
}

predicate func_5(Variable vsshdr_189, Parameter vcgc_186, Variable vSDev_188, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="sense"
		and target_5.getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("scsi_execute")
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vSDev_188
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="cmd"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="data_direction"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="buffer"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="buflen"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vsshdr_189
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getTarget().getName()="timeout"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="3"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(9).(Literal).getValue()="0"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(10).(Literal).getValue()="0"
		and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(11).(Literal).getValue()="0"
}

predicate func_6(Variable vsshdr_189, Variable vresult_190, Parameter vcgc_186, Variable vSDev_188, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_190
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("scsi_execute")
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vSDev_188
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="cmd"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="data_direction"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="buffer"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="buflen"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(PointerFieldAccess).getTarget().getName()="sense"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vsshdr_189
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getTarget().getName()="timeout"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="3"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(9).(Literal).getValue()="0"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(10).(Literal).getValue()="0"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(11).(Literal).getValue()="0"
}

predicate func_8(Variable vsshdr_189, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="sense_key"
		and target_8.getQualifier().(VariableAccess).getTarget()=vsshdr_189
}

predicate func_10(Variable vresult_190, EqualityOperation target_10) {
		target_10.getAnOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vresult_190
		and target_10.getAnOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="24"
		and target_10.getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
		and target_10.getAnOperand().(Literal).getValue()="0"
}

predicate func_11(Parameter vcgc_186, ExprStmt target_14, NotExpr target_11) {
		target_11.getOperand().(PointerFieldAccess).getTarget().getName()="quiet"
		and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcgc_186
		and target_11.getParent().(IfStmt).getThen()=target_14
}

predicate func_12(Variable vSDev_188, NotExpr target_12) {
		target_12.getOperand().(FunctionCall).getTarget().hasName("scsi_block_when_processing_errors")
		and target_12.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vSDev_188
}

predicate func_13(Variable vSDev_188, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="changed"
		and target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vSDev_188
		and target_13.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
}

predicate func_14(Function func, ExprStmt target_14) {
		target_14.getExpr().(FunctionCall).getTarget().hasName("sdev_prefix_printk")
		and target_14.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6"
		and target_14.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="device"
		and target_14.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("Scsi_CD *")
		and target_14.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="name"
		and target_14.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cdi"
		and target_14.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("Scsi_CD *")
		and target_14.getExpr().(FunctionCall).getArgument(3).(StringLiteral).getValue()="disc change detected.\n"
		and target_14.getEnclosingFunction() = func
}

from Function func, Variable vsshdr_189, Variable vresult_190, Parameter vcgc_186, Variable vSDev_188, PointerFieldAccess target_5, ExprStmt target_6, ValueFieldAccess target_8, EqualityOperation target_10, NotExpr target_11, NotExpr target_12, ExprStmt target_13, ExprStmt target_14
where
not func_0(vcgc_186, target_6, func)
and not func_2(vsshdr_189, vresult_190, vcgc_186, vSDev_188, target_8, target_10, target_11, target_12, target_13, func)
and not func_4(vcgc_186, func)
and func_5(vsshdr_189, vcgc_186, vSDev_188, target_5)
and func_6(vsshdr_189, vresult_190, vcgc_186, vSDev_188, target_6)
and func_8(vsshdr_189, target_8)
and func_10(vresult_190, target_10)
and func_11(vcgc_186, target_14, target_11)
and func_12(vSDev_188, target_12)
and func_13(vSDev_188, target_13)
and func_14(func, target_14)
and vsshdr_189.getType().hasName("scsi_sense_hdr")
and vresult_190.getType().hasName("int")
and vcgc_186.getType().hasName("packet_command *")
and vSDev_188.getType().hasName("scsi_device *")
and vsshdr_189.(LocalVariable).getFunction() = func
and vresult_190.(LocalVariable).getFunction() = func
and vcgc_186.getFunction() = func
and vSDev_188.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
