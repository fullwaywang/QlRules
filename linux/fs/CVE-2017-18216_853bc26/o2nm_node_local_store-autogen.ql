/**
 * @name linux-853bc26a7ea39e354b9f8889ae7ad1492ffa28d2-o2nm_node_local_store
 * @id cpp/linux/853bc26a7ea39e354b9f8889ae7ad1492ffa28d2/o2nm-node-local-store
 * @description linux-853bc26a7ea39e354b9f8889ae7ad1492ffa28d2-fs/ocfs2/cluster/nodemanager.c-o2nm_node_local_store CVE-2017-18216
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(FunctionCall).getTarget().hasName("o2nm_lock_subsystem")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_1(Variable vcluster_318, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vcluster_318
		and target_1.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1)
}

predicate func_2(Variable vcluster_318, ReturnStmt target_15, LogicalAndExpr target_10) {
	exists(NotExpr target_2 |
		target_2.getOperand().(VariableAccess).getTarget()=vcluster_318
		and target_2.getParent().(IfStmt).getThen()=target_15
		and target_2.getOperand().(VariableAccess).getLocation().isBefore(target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vret_321, LogicalAndExpr target_10) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_321
		and target_3.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_3
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10)
}

predicate func_4(LogicalAndExpr target_10, Function func) {
	exists(GotoStmt target_4 |
		target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_4
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vret_321, Function func) {
	exists(IfStmt target_5 |
		target_5.getCondition() instanceof LogicalAndExpr
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_321
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5)
}

predicate func_6(VariableAccess target_19, Function func) {
	exists(GotoStmt target_6 |
		target_6.getParent().(IfStmt).getCondition()=target_19
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(Parameter vcount_315, Variable vret_321, ReturnStmt target_12, Function func) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_321
		and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vcount_315
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
		and target_12.getExpr().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_8(Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(FunctionCall).getTarget().hasName("o2nm_unlock_subsystem")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

predicate func_9(Variable vnode_317, FunctionCall target_9) {
		target_9.getTarget().hasName("to_o2nm_cluster_from_node")
		and target_9.getArgument(0).(VariableAccess).getTarget()=vnode_317
}

predicate func_10(Variable vnode_317, Variable vcluster_318, Variable vtmp_319, ReturnStmt target_15, LogicalAndExpr target_10) {
		target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vtmp_319
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vtmp_319
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="cl_has_local"
		and target_10.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcluster_318
		and target_10.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="cl_local_node"
		and target_10.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcluster_318
		and target_10.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="nd_num"
		and target_10.getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnode_317
		and target_10.getParent().(IfStmt).getThen()=target_15
}

predicate func_11(Function func, UnaryMinusExpr target_11) {
		target_11.getValue()="-16"
		and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vret_321, VariableAccess target_19, ReturnStmt target_12) {
		target_12.getExpr().(VariableAccess).getTarget()=vret_321
		and target_12.getParent().(IfStmt).getCondition()=target_19
}

predicate func_13(Parameter vcount_315, VariableAccess target_13) {
		target_13.getTarget()=vcount_315
}

predicate func_14(Function func, Initializer target_14) {
		target_14.getExpr() instanceof FunctionCall
		and target_14.getExpr().getEnclosingFunction() = func
}

predicate func_15(LogicalAndExpr target_10, Function func, ReturnStmt target_15) {
		target_15.getExpr() instanceof UnaryMinusExpr
		and target_15.getParent().(IfStmt).getCondition()=target_10
		and target_15.getEnclosingFunction() = func
}

predicate func_16(Parameter vcount_315, Function func, ReturnStmt target_16) {
		target_16.getExpr().(VariableAccess).getTarget()=vcount_315
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_19(Variable vret_321, ReturnStmt target_12, VariableAccess target_19) {
		target_19.getTarget()=vret_321
		and target_19.getParent().(IfStmt).getThen()=target_12
}

from Function func, Parameter vcount_315, Variable vnode_317, Variable vcluster_318, Variable vtmp_319, Variable vret_321, FunctionCall target_9, LogicalAndExpr target_10, UnaryMinusExpr target_11, ReturnStmt target_12, VariableAccess target_13, Initializer target_14, ReturnStmt target_15, ReturnStmt target_16, VariableAccess target_19
where
not func_0(func)
and not func_1(vcluster_318, func)
and not func_2(vcluster_318, target_15, target_10)
and not func_3(vret_321, target_10)
and not func_4(target_10, func)
and not func_5(vret_321, func)
and not func_6(target_19, func)
and not func_7(vcount_315, vret_321, target_12, func)
and not func_8(func)
and func_9(vnode_317, target_9)
and func_10(vnode_317, vcluster_318, vtmp_319, target_15, target_10)
and func_11(func, target_11)
and func_12(vret_321, target_19, target_12)
and func_13(vcount_315, target_13)
and func_14(func, target_14)
and func_15(target_10, func, target_15)
and func_16(vcount_315, func, target_16)
and func_19(vret_321, target_12, target_19)
and vcount_315.getType().hasName("size_t")
and vnode_317.getType().hasName("o2nm_node *")
and vcluster_318.getType().hasName("o2nm_cluster *")
and vtmp_319.getType().hasName("unsigned long")
and vret_321.getType().hasName("ssize_t")
and vcount_315.getFunction() = func
and vnode_317.(LocalVariable).getFunction() = func
and vcluster_318.(LocalVariable).getFunction() = func
and vtmp_319.(LocalVariable).getFunction() = func
and vret_321.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
