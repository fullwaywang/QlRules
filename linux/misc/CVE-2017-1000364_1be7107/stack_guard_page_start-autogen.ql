/**
 * @name linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-stack_guard_page_start
 * @id cpp/linux/1be7107fbe18eed3e319a6c3e83c78254b693acb/stack-guard-page-start
 * @description linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-include/linux/mm.h-stack_guard_page_start CVE-2017-1000364
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvma_1417, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="vm_flags"
	and target_0.getQualifier().(VariableAccess).getTarget()=vvma_1417
}

predicate func_1(Parameter vvma_1417, VariableAccess target_1) {
	target_1.getTarget()=vvma_1417
	and vvma_1417.getIndex() = 0
}

predicate func_2(Parameter vvma_1417, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="vm_prev"
	and target_2.getQualifier().(VariableAccess).getTarget()=vvma_1417
}

predicate func_3(Parameter vaddr_1418, VariableAccess target_3) {
	target_3.getTarget()=vaddr_1418
	and vaddr_1418.getIndex() = 1
}

predicate func_4(Parameter vaddr_1418, VariableAccess target_4) {
	target_4.getTarget()=vaddr_1418
	and vaddr_1418.getIndex() = 1
	and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_5(Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("lru_add_drain")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_6(Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(FunctionCall).getTarget().hasName("tlb_gather_mmu")
	and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mmu_gather")
	and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("mm_struct *")
	and target_6.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("unsigned long")
	and target_6.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_7(Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(FunctionCall).getTarget().hasName("update_hiwater_rss")
	and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("mm_struct *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_8(Parameter vvma_1417, Function func) {
exists(ExprStmt target_8 |
	target_8.getExpr().(FunctionCall).getTarget().hasName("unmap_vmas")
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mmu_gather")
	and target_8.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_1417
	and target_8.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("unsigned long")
	and target_8.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_9(Parameter vvma_1417, LogicalAndExpr target_11, Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("free_pgtables")
	and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mmu_gather")
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_1417
	and target_9.getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getCondition().(VariableAccess).getType().hasName("vm_area_struct *")
	and target_9.getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="vm_end"
	and target_9.getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("vm_area_struct *")
	and target_9.getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_9.getExpr().(FunctionCall).getArgument(3).(ConditionalExpr).getCondition().(VariableAccess).getType().hasName("vm_area_struct *")
	and target_9.getExpr().(FunctionCall).getArgument(3).(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="vm_start"
	and target_9.getExpr().(FunctionCall).getArgument(3).(ConditionalExpr).getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("vm_area_struct *")
	and target_9.getExpr().(FunctionCall).getArgument(3).(ConditionalExpr).getElse().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getFollowingStmt() instanceof ReturnStmt
	and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_11.getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_10(Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(FunctionCall).getTarget().hasName("tlb_finish_mmu")
	and target_10.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mmu_gather")
	and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("unsigned long")
	and target_10.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("unsigned long")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_11(Parameter vvma_1417, Parameter vaddr_1418, LogicalAndExpr target_11) {
	target_11.getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
	and target_11.getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_1417
	and target_11.getLeftOperand().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
	and target_11.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_start"
	and target_11.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_1417
	and target_11.getLeftOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vaddr_1418
	and target_11.getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("vma_growsdown")
	and target_11.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="vm_prev"
	and target_11.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_1417
	and target_11.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vaddr_1418
}

from Function func, Parameter vvma_1417, Parameter vaddr_1418, PointerFieldAccess target_0, VariableAccess target_1, PointerFieldAccess target_2, VariableAccess target_3, VariableAccess target_4, LogicalAndExpr target_11
where
func_0(vvma_1417, target_0)
and func_1(vvma_1417, target_1)
and func_2(vvma_1417, target_2)
and func_3(vaddr_1418, target_3)
and func_4(vaddr_1418, target_4)
and not func_5(func)
and not func_6(func)
and not func_7(func)
and not func_8(vvma_1417, func)
and not func_9(vvma_1417, target_11, func)
and not func_10(func)
and func_11(vvma_1417, vaddr_1418, target_11)
and vvma_1417.getType().hasName("vm_area_struct *")
and vaddr_1418.getType().hasName("unsigned long")
and vvma_1417.getFunction() = func
and vaddr_1418.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
