/**
 * @name linux-89e66809684485590ea0b32c3178e42cba36ac09-g_audio_setup
 * @id cpp/linux/89e66809684485590ea0b32c3178e42cba36ac09/g-audio-setup
 * @description linux-89e66809684485590ea0b32c3178e42cba36ac09-drivers/usb/gadget/function/u_audio.c-g_audio_setup CVE-2024-38628
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, SizeofExprOperator target_0) {
	target_0.getValue()="424"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vprm_1295, Variable vkctl_1161, ExprStmt target_13) {
exists(AssignExpr target_1 |
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_mute_id"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and exists(PointerFieldAccess obj_1 | obj_1=target_1.getRValue() |
		obj_1.getTarget().getName()="id"
		and obj_1.getQualifier().(VariableAccess).getTarget()=vkctl_1161
	)
	and target_1.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_2(Variable vprm_1295, Variable vkctl_1161, ExprStmt target_14) {
exists(AssignExpr target_2 |
	exists(PointerFieldAccess obj_0 | obj_0=target_2.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_volume_id"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and exists(PointerFieldAccess obj_1 | obj_1=target_2.getRValue() |
		obj_1.getTarget().getName()="id"
		and obj_1.getQualifier().(VariableAccess).getTarget()=vkctl_1161
	)
	and target_2.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_3(Variable vprm_1295, Variable vkctl_1161) {
exists(AssignExpr target_3 |
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_rate_id"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and exists(PointerFieldAccess obj_1 | obj_1=target_3.getRValue() |
		obj_1.getTarget().getName()="id"
		and obj_1.getQualifier().(VariableAccess).getTarget()=vkctl_1161
	)
)
}

/*predicate func_4(Variable vprm_1295, VariableAccess target_4) {
	target_4.getTarget()=vprm_1295
}

*/
/*predicate func_5(Variable vprm_1295, VariableAccess target_5) {
	target_5.getTarget()=vprm_1295
}

*/
/*predicate func_6(Variable vprm_1295, VariableAccess target_6) {
	target_6.getTarget()=vprm_1295
}

*/
predicate func_7(Variable vprm_1295, Variable vkctl_1161, VariableAccess target_7) {
	exists(AssignExpr obj_0 | obj_0=target_7.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="snd_kctl_mute"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vprm_1295
		)
		and obj_0.getRValue() = target_7
	)
	and target_7.getTarget()=vkctl_1161
}

predicate func_8(Variable vprm_1295, Variable vkctl_1161, VariableAccess target_8) {
	exists(AssignExpr obj_0 | obj_0=target_8.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="snd_kctl_volume"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vprm_1295
		)
		and obj_0.getRValue() = target_8
	)
	and target_8.getTarget()=vkctl_1161
}

predicate func_9(Variable vprm_1295, Variable vkctl_1161, VariableAccess target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="snd_kctl_rate"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vprm_1295
		)
		and obj_0.getRValue() = target_9
	)
	and target_9.getTarget()=vkctl_1161
}

predicate func_10(Variable vprm_1295, Variable vkctl_1161, AssignExpr target_10) {
	exists(PointerFieldAccess obj_0 | obj_0=target_10.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_mute"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and target_10.getRValue().(VariableAccess).getTarget()=vkctl_1161
}

predicate func_11(Variable vprm_1295, Variable vkctl_1161, AssignExpr target_11) {
	exists(PointerFieldAccess obj_0 | obj_0=target_11.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_volume"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and target_11.getRValue().(VariableAccess).getTarget()=vkctl_1161
}

predicate func_12(Variable vprm_1295, Variable vkctl_1161, AssignExpr target_12) {
	exists(PointerFieldAccess obj_0 | obj_0=target_12.getLValue() |
		obj_0.getTarget().getName()="snd_kctl_rate"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_1295
	)
	and target_12.getRValue().(VariableAccess).getTarget()=vkctl_1161
}

predicate func_13(Variable vprm_1295, ExprStmt target_13) {
	exists(AssignExpr obj_0 | obj_0=target_13.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="mute"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vprm_1295
		)
		and obj_0.getRValue().(Literal).getValue()="0"
	)
}

predicate func_14(Variable vprm_1295, ExprStmt target_14) {
	exists(AssignExpr obj_0 | obj_0=target_14.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="volume"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vprm_1295
		)
		and exists(PointerFieldAccess obj_2 | obj_2=obj_0.getRValue() |
			obj_2.getTarget().getName()="volume_max"
			and obj_2.getQualifier().(VariableAccess).getTarget().getType().hasName("uac_fu_params *")
		)
	)
}

from Function func, Variable vprm_1295, Variable vkctl_1161, SizeofExprOperator target_0, VariableAccess target_7, VariableAccess target_8, VariableAccess target_9, AssignExpr target_10, AssignExpr target_11, AssignExpr target_12, ExprStmt target_13, ExprStmt target_14
where
func_0(func, target_0)
and not func_1(vprm_1295, vkctl_1161, target_13)
and not func_2(vprm_1295, vkctl_1161, target_14)
and not func_3(vprm_1295, vkctl_1161)
and func_7(vprm_1295, vkctl_1161, target_7)
and func_8(vprm_1295, vkctl_1161, target_8)
and func_9(vprm_1295, vkctl_1161, target_9)
and func_10(vprm_1295, vkctl_1161, target_10)
and func_11(vprm_1295, vkctl_1161, target_11)
and func_12(vprm_1295, vkctl_1161, target_12)
and func_13(vprm_1295, target_13)
and func_14(vprm_1295, target_14)
and vprm_1295.getType().hasName("uac_rtd_params *")
and vkctl_1161.getType().hasName("snd_kcontrol *")
and vprm_1295.(LocalVariable).getFunction() = func
and vkctl_1161.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
