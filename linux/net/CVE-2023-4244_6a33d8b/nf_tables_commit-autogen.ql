/**
 * @name linux-6a33d8b73dfac0a41f3877894b38082bd0c9a5bc-nf_tables_commit
 * @id cpp/linux/6a33d8b73dfac0a41f3877894b38082bd0c9a5bc/nf-tables-commit
 * @description linux-6a33d8b73dfac0a41f3877894b38082bd0c9a5bc-net/netfilter/nf_tables_api.c-nf_tables_commit CVE-2023-4244
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vnft_net_9744, Variable vgc_seq_9746) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("nft_gc_seq_begin")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vnft_net_9744
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgc_seq_9746)
}

predicate func_5(Variable vnft_net_9744, VariableAccess target_5) {
	target_5.getTarget()=vnft_net_9744
}

predicate func_6(Variable vnft_net_9744, VariableAccess target_6) {
	target_6.getTarget()=vnft_net_9744
}

predicate func_7(Variable vnft_net_9744, Variable vgc_seq_9746, StmtExpr target_7) {
	target_7.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnft_net_9744
	and target_7.getParent().(AssignExpr).getRValue() = target_7
	and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgc_seq_9746
}

/*predicate func_8(Function func, DoStmt target_8) {
	target_8.getCondition().(Literal).getValue()="0"
	and target_8.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(Function func, IfStmt target_9) {
	target_9.getCondition().(NotExpr).getValue()="0"
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(Variable vnft_net_9744, PointerDereferenceExpr target_10) {
	target_10.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_10.getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnft_net_9744
}

*/
predicate func_11(Function func, DoStmt target_11) {
	target_11.getCondition().(Literal).getValue()="0"
	and target_11.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_11.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_11.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

/*predicate func_12(Function func, DoStmt target_12) {
	target_12.getCondition().(Literal).getValue()="0"
	and target_12.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_12.getEnclosingFunction() = func
}

*/
/*predicate func_13(Function func, IfStmt target_13) {
	target_13.getCondition().(NotExpr).getValue()="0"
	and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(Variable vgc_seq_9746, ExprStmt target_22, DoStmt target_14) {
	target_14.getCondition().(Literal).getValue()="0"
	and target_14.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_14.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vgc_seq_9746
	and target_22.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_14.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getLocation())
}

*/
/*predicate func_15(Variable vnft_net_9744, Variable vgc_seq_9746, PointerFieldAccess target_23, ExprStmt target_22, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_15.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnft_net_9744
	and target_15.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vgc_seq_9746
	and target_15.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_23.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_22.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getLocation())
}

*/
predicate func_16(Function func, DoStmt target_16) {
	target_16.getCondition().(Literal).getValue()="0"
	and target_16.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_16.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_16.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_16.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

/*predicate func_17(Function func, DoStmt target_17) {
	target_17.getCondition().(Literal).getValue()="0"
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_17.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_17.getEnclosingFunction() = func
}

*/
/*predicate func_19(Function func, IfStmt target_19) {
	target_19.getCondition().(NotExpr).getValue()="0"
	and target_19.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_19.getEnclosingFunction() = func
}

*/
/*predicate func_20(Variable vgc_seq_9746, DoStmt target_20) {
	target_20.getCondition().(Literal).getValue()="0"
	and target_20.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_20.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vgc_seq_9746
}

*/
/*predicate func_21(Variable vnft_net_9744, Variable vgc_seq_9746, ExprStmt target_21) {
	target_21.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="gc_seq"
	and target_21.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnft_net_9744
	and target_21.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vgc_seq_9746
}

*/
predicate func_22(Variable vgc_seq_9746, ExprStmt target_22) {
	target_22.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgc_seq_9746
	and target_22.getExpr().(AssignExpr).getRValue() instanceof StmtExpr
}

predicate func_23(Variable vnft_net_9744, PointerFieldAccess target_23) {
	target_23.getTarget().getName()="next"
	and target_23.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="commit_list"
	and target_23.getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnft_net_9744
}

from Function func, Variable vnft_net_9744, Variable vgc_seq_9746, VariableAccess target_5, VariableAccess target_6, StmtExpr target_7, DoStmt target_11, DoStmt target_16, ExprStmt target_22, PointerFieldAccess target_23
where
not func_1(vnft_net_9744, vgc_seq_9746)
and func_5(vnft_net_9744, target_5)
and func_6(vnft_net_9744, target_6)
and func_7(vnft_net_9744, vgc_seq_9746, target_7)
and func_11(func, target_11)
and func_16(func, target_16)
and func_22(vgc_seq_9746, target_22)
and func_23(vnft_net_9744, target_23)
and vnft_net_9744.getType().hasName("nftables_pernet *")
and vgc_seq_9746.getType().hasName("unsigned int")
and vnft_net_9744.(LocalVariable).getFunction() = func
and vgc_seq_9746.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
