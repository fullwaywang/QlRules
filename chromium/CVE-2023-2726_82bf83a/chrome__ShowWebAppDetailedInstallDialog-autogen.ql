/**
 * @name chromium-82bf83a0639fbcd6c8daaf7a67ab6ce4f5654551-chrome__ShowWebAppDetailedInstallDialog
 * @id cpp/chromium/82bf83a0639fbcd6c8daaf7a67ab6ce4f5654551/chromeshowwebappdetailedinstalldialog
 * @description chromium-82bf83a0639fbcd6c8daaf7a67ab6ce4f5654551-chrome/browser/ui/views/web_apps/web_app_detailed_install_dialog.cc-chrome__ShowWebAppDetailedInstallDialog CVE-2023-2726
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("OverrideDefaultButton")
	and target_0.getQualifier() instanceof FunctionCall
	and target_0.getEnclosingFunction() = func
)
}

predicate func_1(Parameter vscreenshots_317, Variable vdelegate_ptr_340, FunctionCall target_1) {
	exists(FunctionCall obj_0 | obj_0=target_1.getQualifier() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getQualifier() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getQualifier() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getQualifier() |
					exists(FunctionCall obj_4 | obj_4=obj_3.getQualifier() |
						obj_4.getTarget().hasName("SetSubtitle")
						and obj_4.getQualifier().(FunctionCall).getTarget().hasName("SetTitle")
						and obj_4.getArgument(0).(FunctionCall).getTarget().hasName("UTF8ToUTF16")
					)
					and exists(FunctionCall obj_5 | obj_5=obj_3.getArgument(1) |
						obj_5.getTarget().hasName("GetStringUTF16")
						and obj_5.getArgument(0).(Literal).getValue()="9330"
					)
					and obj_3.getTarget().hasName("AddParagraph")
					and obj_3.getArgument(0).(FunctionCall).getTarget().hasName("set_is_secondary")
				)
				and exists(FunctionCall obj_6 | obj_6=obj_2.getArgument(0) |
					exists(FunctionCall obj_7 | obj_7=obj_6.getArgument(1) |
						obj_7.getTarget().hasName("Unretained")
						and obj_7.getArgument(0).(VariableAccess).getTarget()=vdelegate_ptr_340
					)
					and obj_6.getTarget().hasName("BindOnce")
				)
				and exists(FunctionCall obj_8 | obj_8=obj_2.getArgument(1) |
					exists(FunctionCall obj_9 | obj_9=obj_8.getArgument(0) |
						obj_9.getTarget().hasName("GetStringUTF16")
						and obj_9.getArgument(0).(Literal).getValue()="33573"
					)
					and obj_8.getTarget().hasName("SetLabel")
					and obj_8.getQualifier().(ConstructorCall).getType() instanceof VoidType
				)
				and obj_2.getTarget().hasName("AddOkButton")
			)
			and exists(FunctionCall obj_10 | obj_10=obj_1.getArgument(0) |
				exists(FunctionCall obj_11 | obj_11=obj_10.getArgument(1) |
					obj_11.getTarget().hasName("Unretained")
					and obj_11.getArgument(0).(VariableAccess).getTarget()=vdelegate_ptr_340
				)
				and obj_10.getTarget().hasName("BindOnce")
			)
			and obj_1.getTarget().hasName("AddCancelButton")
		)
		and exists(ConstructorCall obj_12 | obj_12=obj_0.getArgument(0) |
			exists(FunctionCall obj_13 | obj_13=obj_12.getArgument(0) |
				exists(FunctionCall obj_14 | obj_14=obj_13.getArgument(0) |
					obj_14.getTarget().hasName("make_unique")
					and obj_14.getArgument(0).(VariableAccess).getTarget()=vscreenshots_317
				)
				and obj_13.getTarget().hasName("make_unique")
			)
		)
		and obj_0.getTarget().hasName("AddCustomField")
	)
	and exists(FunctionCall obj_15 | obj_15=target_1.getArgument(0) |
		exists(FunctionCall obj_16 | obj_16=obj_15.getArgument(1) |
			obj_16.getTarget().hasName("Unretained")
			and obj_16.getArgument(0).(VariableAccess).getTarget()=vdelegate_ptr_340
		)
		and obj_15.getTarget().hasName("BindOnce")
		and obj_15.getArgument(0).(LambdaExpression).getType() instanceof LocalClass
	)
	and target_1.getTarget().hasName("SetDialogDestroyingCallback")
}

from Function func, Parameter vscreenshots_317, Variable vdelegate_ptr_340, FunctionCall target_1
where
not func_0(func)
and func_1(vscreenshots_317, vdelegate_ptr_340, target_1)
and vscreenshots_317.getType().hasName("const vector<Screenshot, allocator<Screenshot>> &")
and vdelegate_ptr_340.getType().hasName("WebAppDetailedInstallDialogDelegate *")
and vscreenshots_317.getFunction() = func
and vdelegate_ptr_340.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
