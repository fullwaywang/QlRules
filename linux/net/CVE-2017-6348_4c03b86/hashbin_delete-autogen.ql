/**
 * @name linux-4c03b862b12f980456f9de92db6d508a4999b788-hashbin_delete
 * @id cpp/linux/4c03b862b12f980456f9de92db6d508a4999b788/hashbin-delete
 * @description linux-4c03b862b12f980456f9de92db6d508a4999b788-net/irda/irqueue.c-hashbin_delete CVE-2017-6348
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhashbin_389, Variable vflags_392, Variable vhashbin_lock_depth, FunctionCall target_0) {
	target_0.getTarget().hasName("_raw_spin_lock_irqsave_nested")
	and not target_0.getTarget().hasName("_raw_spin_lock_irqsave")
	and target_0.getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_0.getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="hb_spinlock"
	and target_0.getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_0.getArgument(1).(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vhashbin_lock_depth
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_392
}

predicate func_1(Variable vflags_392, BitwiseAndExpr target_25) {
exists(DoStmt target_1 |
	target_1.getCondition() instanceof Literal
	and target_1.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_1.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_392
	and target_1.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_1.getParent().(IfStmt).getCondition()=target_25)
}

predicate func_3(Variable vqueue_391, BitwiseAndExpr target_25) {
exists(IfStmt target_3 |
	target_3.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vqueue_391
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25)
}

predicate func_4(Parameter vhashbin_389, Parameter vfree_func_389, Variable vqueue_391, BitwiseAndExpr target_25, ExprStmt target_28) {
exists(IfStmt target_4 |
	target_4.getCondition().(VariableAccess).getTarget()=vfree_func_389
	and target_4.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_4.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_4.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_4.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen() instanceof ExprStmt
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getExpr().(VariableAccess).getTarget()=vfree_func_389
	and target_4.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vqueue_391
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_4
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
	and target_4.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_5(Parameter vhashbin_389, ExprStmt target_29) {
exists(BitwiseAndExpr target_5 |
	target_5.getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_5.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_5.getRightOperand().(Literal).getValue()="1"
	and target_5.getParent().(IfStmt).getThen()=target_29)
}

*/
/*predicate func_6(Parameter vfree_func_389, Variable vqueue_391) {
exists(VariableCall target_6 |
	target_6.getExpr().(VariableAccess).getTarget()=vfree_func_389
	and target_6.getArgument(0).(VariableAccess).getTarget()=vqueue_391)
}

*/
/*predicate func_7(Parameter vhashbin_389, ExprStmt target_28) {
exists(IfStmt target_7 |
	target_7.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_7.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_7.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_7.getThen().(DoStmt).getCondition().(Literal).getValue()="0"
	and target_7.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_7.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_10(Parameter vhashbin_389, Variable vflags_392, AddressOfExpr target_31, ExprStmt target_32, ExprStmt target_13) {
exists(AssignExpr target_10 |
	target_10.getLValue().(VariableAccess).getTarget()=vflags_392
	and target_10.getRValue().(FunctionCall).getTarget().hasName("_raw_spin_lock_irqsave")
	and target_10.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_10.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="hb_spinlock"
	and target_10.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_31.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_10.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_32.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_10.getLValue().(VariableAccess).getLocation()))
}

*/
predicate func_11(Parameter vhashbin_389, Variable vflags_392, AddressOfExpr target_33, ExprStmt target_35, ExprStmt target_13) {
exists(FunctionCall target_11 |
	target_11.getTarget().hasName("spin_unlock_irqrestore")
	and target_11.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="hb_spinlock"
	and target_11.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_11.getArgument(1).(VariableAccess).getTarget()=vflags_392
	and target_33.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_35.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getArgument(1).(VariableAccess).getLocation())
	and target_11.getArgument(1).(VariableAccess).getLocation().isBefore(target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_12(Parameter vhashbin_389, Variable vqueue_391, Variable vi_393, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vqueue_391
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dequeue_first")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="hb_queue"
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_393
}

predicate func_13(Parameter vhashbin_389, Variable vflags_392, BitwiseAndExpr target_36, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="hb_spinlock"
	and target_13.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_392
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_36
}

predicate func_16(Parameter vfree_func_389, ExprStmt target_29, VariableAccess target_16) {
	target_16.getTarget()=vfree_func_389
	and target_16.getParent().(IfStmt).getThen()=target_29
}

predicate func_17(Variable vqueue_391, VariableAccess target_17) {
	target_17.getTarget()=vqueue_391
	and target_17.getParent().(ExprCall).getParent().(ExprStmt).getExpr() instanceof ExprCall
}

predicate func_18(Parameter vhashbin_389, VariableAccess target_18) {
	target_18.getTarget()=vhashbin_389
	and target_18.getParent().(PointerFieldAccess).getParent().(ArrayExpr).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_19(Variable vqueue_391, VariableAccess target_19) {
	target_19.getTarget()=vqueue_391
}

predicate func_20(Parameter vfree_func_389, VariableAccess target_20) {
	target_20.getTarget()=vfree_func_389
}

predicate func_21(Variable vhashbin_lock_depth, VariableAccess target_21) {
	target_21.getTarget()=vhashbin_lock_depth
	and target_21.getParent().(PostfixIncrExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_22(Parameter vfree_func_389, Variable vqueue_391, ExprCall target_22) {
	target_22.getExpr().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vfree_func_389
	and target_22.getArgument(0).(VariableAccess).getTarget()=vqueue_391
}

predicate func_23(Parameter vhashbin_389, Variable vqueue_391, Variable vi_393, AssignExpr target_23) {
	target_23.getLValue().(VariableAccess).getTarget()=vqueue_391
	and target_23.getRValue().(FunctionCall).getTarget().hasName("dequeue_first")
	and target_23.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="hb_queue"
	and target_23.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_23.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_393
}

predicate func_24(Variable vhashbin_lock_depth, PostfixDecrExpr target_24) {
	target_24.getOperand().(VariableAccess).getTarget()=vhashbin_lock_depth
}

predicate func_25(Parameter vhashbin_389, BlockStmt target_38, BitwiseAndExpr target_25) {
	target_25.getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_25.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_25.getRightOperand().(Literal).getValue()="1"
	and target_25.getParent().(IfStmt).getThen()=target_38
}

predicate func_28(Parameter vhashbin_389, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="hb_current"
	and target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_28.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_29(Function func, ExprStmt target_29) {
	target_29.getExpr() instanceof ExprCall
	and target_29.getEnclosingFunction() = func
}

predicate func_31(Parameter vhashbin_389, Variable vflags_392, AddressOfExpr target_31) {
	target_31.getOperand().(PointerFieldAccess).getTarget().getName()="hb_spinlock"
	and target_31.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_31.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock_irqrestore")
	and target_31.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vflags_392
}

predicate func_32(Parameter vhashbin_389, ExprStmt target_32) {
	target_32.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_32.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhashbin_389
}

predicate func_33(Parameter vhashbin_389, Variable vi_393, AddressOfExpr target_33) {
	target_33.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="hb_queue"
	and target_33.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_33.getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_393
	and target_33.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dequeue_first")
}

predicate func_35(Variable vflags_392, ExprStmt target_35) {
	target_35.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_392
	and target_35.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_36(Parameter vhashbin_389, BlockStmt target_39, BitwiseAndExpr target_36) {
	target_36.getLeftOperand().(PointerFieldAccess).getTarget().getName()="hb_type"
	and target_36.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhashbin_389
	and target_36.getRightOperand().(Literal).getValue()="1"
	and target_36.getParent().(IfStmt).getThen()=target_39
}

predicate func_38(Function func, BlockStmt target_38) {
	target_38.getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_38.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_38.getEnclosingFunction() = func
}

predicate func_39(Function func, BlockStmt target_39) {
	target_39.getStmt(0) instanceof ExprStmt
	and target_39.getStmt(1).(ExprStmt).getExpr() instanceof PostfixDecrExpr
	and target_39.getEnclosingFunction() = func
}

from Function func, Parameter vhashbin_389, Parameter vfree_func_389, Variable vqueue_391, Variable vflags_392, Variable vi_393, Variable vhashbin_lock_depth, FunctionCall target_0, ExprStmt target_12, ExprStmt target_13, VariableAccess target_16, VariableAccess target_17, VariableAccess target_18, VariableAccess target_19, VariableAccess target_20, VariableAccess target_21, ExprCall target_22, AssignExpr target_23, PostfixDecrExpr target_24, BitwiseAndExpr target_25, ExprStmt target_28, ExprStmt target_29, AddressOfExpr target_31, ExprStmt target_32, AddressOfExpr target_33, ExprStmt target_35, BitwiseAndExpr target_36, BlockStmt target_38, BlockStmt target_39
where
func_0(vhashbin_389, vflags_392, vhashbin_lock_depth, target_0)
and not func_1(vflags_392, target_25)
and not func_3(vqueue_391, target_25)
and not func_4(vhashbin_389, vfree_func_389, vqueue_391, target_25, target_28)
and not func_11(vhashbin_389, vflags_392, target_33, target_35, target_13)
and func_12(vhashbin_389, vqueue_391, vi_393, target_12)
and func_13(vhashbin_389, vflags_392, target_36, target_13)
and func_16(vfree_func_389, target_29, target_16)
and func_17(vqueue_391, target_17)
and func_18(vhashbin_389, target_18)
and func_19(vqueue_391, target_19)
and func_20(vfree_func_389, target_20)
and func_21(vhashbin_lock_depth, target_21)
and func_22(vfree_func_389, vqueue_391, target_22)
and func_23(vhashbin_389, vqueue_391, vi_393, target_23)
and func_24(vhashbin_lock_depth, target_24)
and func_25(vhashbin_389, target_38, target_25)
and func_28(vhashbin_389, target_28)
and func_29(func, target_29)
and func_31(vhashbin_389, vflags_392, target_31)
and func_32(vhashbin_389, target_32)
and func_33(vhashbin_389, vi_393, target_33)
and func_35(vflags_392, target_35)
and func_36(vhashbin_389, target_39, target_36)
and func_38(func, target_38)
and func_39(func, target_39)
and vhashbin_389.getType().hasName("hashbin_t *")
and vfree_func_389.getType().hasName("FREE_FUNC")
and vqueue_391.getType().hasName("irda_queue_t *")
and vflags_392.getType().hasName("unsigned long")
and vi_393.getType().hasName("int")
and vhashbin_lock_depth.getType().hasName("int")
and vhashbin_389.getFunction() = func
and vfree_func_389.getFunction() = func
and vqueue_391.(LocalVariable).getFunction() = func
and vflags_392.(LocalVariable).getFunction() = func
and vi_393.(LocalVariable).getFunction() = func
and not vhashbin_lock_depth.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
