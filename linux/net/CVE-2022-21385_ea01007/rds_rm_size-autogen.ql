/**
 * @name linux-ea010070d0a7497253d5a6f919f6dd107450b31a-rds_rm_size
 * @id cpp/linux/ea010070d0a7497253d5a6f919f6dd107450b31a/rds-rm-size
 * @description linux-ea010070d0a7497253d5a6f919f6dd107450b31a-net/rds/send.c-rds_rm_size CVE-2022-21385
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vcmsg_881, Variable vretval_884, IfStmt target_7, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_884
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_rdma_extra_size")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vcmsg_881
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getValue()="16"
	and target_0.getLocation().isBefore(target_7.getLocation())
}

predicate func_1(PointerFieldAccess target_8, Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="indx"
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="len"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="incr"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("krealloc")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="vec"
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(MulExpr).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(MulExpr).getRightOperand().(SizeofTypeOperator).getValue()="16"
	and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(BitwiseOrExpr).getValue()="6291648"
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(PointerFieldAccess).getTarget().getName()="len"
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(PointerFieldAccess).getTarget().getName()="incr"
	and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="vec"
	and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_8
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_2.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="vec"
	and target_2.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_2.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="indx"
	and target_2.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(PointerFieldAccess target_8, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(FunctionCall).getTarget().hasName("__memset")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_3.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getExpr().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
	and target_3.getExpr().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="16"
	and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_8
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(PointerFieldAccess target_8, Function func) {
exists(ExprStmt target_4 |
	target_4.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="indx"
	and target_4.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr *")
	and target_4.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_8
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vcmsg_881, Variable vretval_884, PointerFieldAccess target_8, SwitchStmt target_9, RelationalOperation target_11) {
exists(ExprStmt target_5 |
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_884
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_rdma_extra_size")
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vcmsg_881
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getValue()="16"
	and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("rds_iov_vector *")
	and target_5.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_8
	and target_9.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getLocation())
	and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_7(Variable vretval_884, IfStmt target_7) {
	target_7.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vretval_884
	and target_7.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_7.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vretval_884
}

predicate func_8(Variable vcmsg_881, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="cmsg_type"
	and target_8.getQualifier().(VariableAccess).getTarget()=vcmsg_881
}

predicate func_9(Variable vcmsg_881, Variable vretval_884, SwitchStmt target_9) {
	target_9.getExpr().(PointerFieldAccess).getTarget().getName()="cmsg_type"
	and target_9.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcmsg_881
	and target_9.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
	and target_9.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_9.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="1"
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_884
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_rdma_extra_size")
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vcmsg_881
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getRightOperand().(SizeofTypeOperator).getValue()="16"
}

predicate func_11(Variable vretval_884, RelationalOperation target_11) {
	 (target_11 instanceof GTExpr or target_11 instanceof LTExpr)
	and target_11.getLesserOperand().(VariableAccess).getTarget()=vretval_884
	and target_11.getGreaterOperand().(Literal).getValue()="0"
}

from Function func, Variable vcmsg_881, Variable vretval_884, ExprStmt target_0, IfStmt target_7, PointerFieldAccess target_8, SwitchStmt target_9, RelationalOperation target_11
where
func_0(vcmsg_881, vretval_884, target_7, target_0)
and not func_1(target_8, func)
and not func_2(func)
and not func_3(target_8, func)
and not func_4(target_8, func)
and not func_5(vcmsg_881, vretval_884, target_8, target_9, target_11)
and func_7(vretval_884, target_7)
and func_8(vcmsg_881, target_8)
and func_9(vcmsg_881, vretval_884, target_9)
and func_11(vretval_884, target_11)
and vcmsg_881.getType().hasName("cmsghdr *")
and vretval_884.getType().hasName("int")
and vcmsg_881.(LocalVariable).getFunction() = func
and vretval_884.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
