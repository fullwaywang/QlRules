/**
 * @name linux-fb1a3132ee1ac968316e45d21a48703a6db0b6c3-mlx5e_get_next_valid_encap
 * @id cpp/linux/fb1a3132ee1ac968316e45d21a48703a6db0b6c3/mlx5e-get-next-valid-encap
 * @description linux-fb1a3132ee1ac968316e45d21a48703a6db0b6c3-drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c-mlx5e_get_next_valid_encap CVE-2021-47247
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vnhe_255, Parameter ve_256, AddressOfExpr target_65) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("mlx5e_get_next_matching_encap")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vnhe_255
	and target_0.getArgument(1).(VariableAccess).getTarget()=ve_256
	and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_65.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter ve_256, VariableAccess target_1) {
	target_1.getTarget()=ve_256
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_2(Parameter vnhe_255, VariableAccess target_2) {
	target_2.getTarget()=vnhe_255
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, ExprStmt target_4) {
	target_4.getExpr().(FunctionCall).getTarget().hasName("rcu_read_lock")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Parameter ve_256, Variable vnext_258, Function func, ForStmt target_5) {
	target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnext_258
	and target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(VariableAccess).getTarget()=ve_256
	and target_5.getCondition().(VariableAccess).getTarget()=vnext_258
	and target_5.getUpdate().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnext_258
	and target_5.getUpdate().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_5.getUpdate().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
	and target_5.getStmt().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("mlx5e_encap_take")
	and target_5.getStmt().(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnext_258
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_9(Function func, DoStmt target_9) {
	target_9.getCondition().(Literal).getValue()="0"
	and target_9.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_9.getEnclosingFunction() = func
}

/*predicate func_11(Function func, IfStmt target_11) {
	target_11.getCondition().(NotExpr).getValue()="0"
	and target_11.getEnclosingFunction() = func
}

*/
predicate func_12(Variable v__ptr_265, ExprStmt target_12) {
	target_12.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="next"
	and target_12.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=v__ptr_265
}

/*predicate func_13(Variable v__head_265, Variable v__next_265, Variable v__mptr_265, ExprStmt target_13) {
	target_13.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_13.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=v__next_265
	and target_13.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=v__head_265
	and target_13.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_13.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_13.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_265
	and target_13.getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

*/
/*predicate func_15(Function func, DoStmt target_15) {
	target_15.getCondition().(Literal).getValue()="0"
	and target_15.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_17(Function func, IfStmt target_17) {
	target_17.getCondition().(NotExpr).getValue()="0"
	and target_17.getEnclosingFunction() = func
}

*/
/*predicate func_18(Variable v__next_265, ExprStmt target_18) {
	target_18.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__next_265
}

*/
/*predicate func_19(Function func, DoStmt target_19) {
	target_19.getCondition().(Literal).getValue()="0"
	and target_19.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_19.getEnclosingFunction() = func
}

*/
/*predicate func_21(Function func, IfStmt target_21) {
	target_21.getCondition().(NotExpr).getValue()="0"
	and target_21.getEnclosingFunction() = func
}

*/
/*predicate func_22(Variable v__mptr_265, ExprStmt target_22) {
	target_22.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_265
	and target_22.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="8"
}

*/
predicate func_25(Function func, DoStmt target_25) {
	target_25.getCondition().(Literal).getValue()="0"
	and target_25.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_25.getEnclosingFunction() = func
}

/*predicate func_27(Function func, IfStmt target_27) {
	target_27.getCondition().(NotExpr).getValue()="0"
	and target_27.getEnclosingFunction() = func
}

*/
predicate func_28(Variable v__ptr_269, ExprStmt target_28) {
	target_28.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="next"
	and target_28.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=v__ptr_269
}

/*predicate func_29(Variable v__ptr_269, Variable v__next_269, Variable v__mptr_269, ExprStmt target_29) {
	target_29.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_29.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=v__ptr_269
	and target_29.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=v__next_269
	and target_29.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_29.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_29.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_269
	and target_29.getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

*/
/*predicate func_31(Function func, DoStmt target_31) {
	target_31.getCondition().(Literal).getValue()="0"
	and target_31.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_31.getEnclosingFunction() = func
}

*/
/*predicate func_33(Function func, IfStmt target_33) {
	target_33.getCondition().(NotExpr).getValue()="0"
	and target_33.getEnclosingFunction() = func
}

*/
/*predicate func_34(Variable v__next_269, ExprStmt target_34) {
	target_34.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__next_269
}

*/
/*predicate func_35(Function func, DoStmt target_35) {
	target_35.getCondition().(Literal).getValue()="0"
	and target_35.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_35.getEnclosingFunction() = func
}

*/
/*predicate func_37(Function func, IfStmt target_37) {
	target_37.getCondition().(NotExpr).getValue()="0"
	and target_37.getEnclosingFunction() = func
}

*/
/*predicate func_38(Variable v__mptr_269, ExprStmt target_38) {
	target_38.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_269
	and target_38.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="8"
}

*/
predicate func_42(Function func, DoStmt target_42) {
	target_42.getCondition().(Literal).getValue()="0"
	and target_42.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_42.getEnclosingFunction() = func
}

/*predicate func_44(Function func, IfStmt target_44) {
	target_44.getCondition().(NotExpr).getValue()="0"
	and target_44.getEnclosingFunction() = func
}

*/
predicate func_45(Variable v__ptr_273, ExprStmt target_45) {
	target_45.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="next"
	and target_45.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=v__ptr_273
}

/*predicate func_46(Variable v__next_273, Variable v__mptr_273, Variable v__head_273, ExprStmt target_46) {
	target_46.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_46.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=v__next_273
	and target_46.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=v__head_273
	and target_46.getExpr().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and target_46.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_46.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_273
	and target_46.getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

*/
/*predicate func_48(Function func, DoStmt target_48) {
	target_48.getCondition().(Literal).getValue()="0"
	and target_48.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_48.getEnclosingFunction() = func
}

*/
/*predicate func_50(Function func, IfStmt target_50) {
	target_50.getCondition().(NotExpr).getValue()="0"
	and target_50.getEnclosingFunction() = func
}

*/
/*predicate func_51(Variable v__next_273, ExprStmt target_51) {
	target_51.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__next_273
}

*/
/*predicate func_52(Function func, DoStmt target_52) {
	target_52.getCondition().(Literal).getValue()="0"
	and target_52.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_52.getEnclosingFunction() = func
}

*/
/*predicate func_54(Function func, IfStmt target_54) {
	target_54.getCondition().(NotExpr).getValue()="0"
	and target_54.getEnclosingFunction() = func
}

*/
/*predicate func_55(Variable v__mptr_273, ExprStmt target_55) {
	target_55.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_273
	and target_55.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="8"
}

*/
predicate func_56(Function func, ExprStmt target_56) {
	target_56.getExpr().(FunctionCall).getTarget().hasName("rcu_read_unlock")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_56
}

predicate func_57(Parameter ve_256, Function func, IfStmt target_57) {
	target_57.getCondition().(VariableAccess).getTarget()=ve_256
	and target_57.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mlx5e_encap_put")
	and target_57.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("netdev_priv")
	and target_57.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="out_dev"
	and target_57.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_256
	and target_57.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=ve_256
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_57
}

predicate func_58(Variable vnext_258, Function func, IfStmt target_58) {
	target_58.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vnext_258
	and target_58.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vnext_258
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_58
}

/*predicate func_59(Variable vnext_258, NotExpr target_66, AddressOfExpr target_67, VariableAccess target_59) {
	target_59.getTarget()=vnext_258
	and target_66.getOperand().(VariableAccess).getLocation().isBefore(target_59.getLocation())
	and target_59.getLocation().isBefore(target_67.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_60(Variable vnext_258, Function func, ExprStmt target_60) {
	target_60.getExpr().(FunctionCall).getTarget().hasName("wait_for_completion")
	and target_60.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="res_ready"
	and target_60.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnext_258
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_60
}

predicate func_61(Parameter ve_256, Variable vnext_258, Function func, IfStmt target_61) {
	target_61.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_61.getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnext_258
	and target_61.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_256
	and target_61.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnext_258
	and target_61.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="retry"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_61
}

/*predicate func_62(Parameter ve_256, Variable vnext_258, NotExpr target_68, ExprStmt target_62) {
	target_62.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=ve_256
	and target_62.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnext_258
	and target_62.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_68
}

*/
/*predicate func_63(NotExpr target_68, Function func, GotoStmt target_63) {
	target_63.getName() ="retry"
	and target_63.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_68
	and target_63.getEnclosingFunction() = func
}

*/
predicate func_64(Variable vnext_258, Function func, ReturnStmt target_64) {
	target_64.getExpr().(VariableAccess).getTarget()=vnext_258
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_64
}

predicate func_65(Parameter vnhe_255, AddressOfExpr target_65) {
	target_65.getOperand().(PointerFieldAccess).getTarget().getName()="encap_list"
	and target_65.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnhe_255
}

predicate func_66(Variable vnext_258, NotExpr target_66) {
	target_66.getOperand().(VariableAccess).getTarget()=vnext_258
}

predicate func_67(Variable vnext_258, AddressOfExpr target_67) {
	target_67.getOperand().(PointerFieldAccess).getTarget().getName()="res_ready"
	and target_67.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnext_258
}

predicate func_68(Function func, NotExpr target_68) {
	target_68.getOperand() instanceof BitwiseAndExpr
	and target_68.getEnclosingFunction() = func
}

from Function func, Variable v__next_273, Variable v__mptr_273, Parameter vnhe_255, Parameter ve_256, Variable vnext_258, Variable v__head_265, Variable v__ptr_265, Variable v__next_265, Variable v__mptr_265, Variable v__ptr_269, Variable v__next_269, Variable v__mptr_269, Variable v__head_273, Variable v__ptr_273, VariableAccess target_1, VariableAccess target_2, DeclStmt target_3, ExprStmt target_4, ForStmt target_5, DoStmt target_9, ExprStmt target_12, DoStmt target_25, ExprStmt target_28, DoStmt target_42, ExprStmt target_45, ExprStmt target_56, IfStmt target_57, IfStmt target_58, ExprStmt target_60, IfStmt target_61, ReturnStmt target_64, AddressOfExpr target_65, NotExpr target_66, AddressOfExpr target_67, NotExpr target_68
where
not func_0(vnhe_255, ve_256, target_65)
and func_1(ve_256, target_1)
and func_2(vnhe_255, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(ve_256, vnext_258, func, target_5)
and func_9(func, target_9)
and func_12(v__ptr_265, target_12)
and func_25(func, target_25)
and func_28(v__ptr_269, target_28)
and func_42(func, target_42)
and func_45(v__ptr_273, target_45)
and func_56(func, target_56)
and func_57(ve_256, func, target_57)
and func_58(vnext_258, func, target_58)
and func_60(vnext_258, func, target_60)
and func_61(ve_256, vnext_258, func, target_61)
and func_64(vnext_258, func, target_64)
and func_65(vnhe_255, target_65)
and func_66(vnext_258, target_66)
and func_67(vnext_258, target_67)
and func_68(func, target_68)
and v__next_273.getType().hasName("list_head *")
and v__mptr_273.getType().hasName("void *")
and vnhe_255.getType().hasName("mlx5e_neigh_hash_entry *")
and ve_256.getType().hasName("mlx5e_encap_entry *")
and vnext_258.getType().hasName("mlx5e_encap_entry *")
and v__head_265.getType().hasName("list_head *")
and v__ptr_265.getType().hasName("list_head *")
and v__next_265.getType().hasName("list_head *")
and v__mptr_265.getType().hasName("void *")
and v__ptr_269.getType().hasName("list_head *")
and v__next_269.getType().hasName("list_head *")
and v__mptr_269.getType().hasName("void *")
and v__head_273.getType().hasName("list_head *")
and v__ptr_273.getType().hasName("list_head *")
and v__next_273.(LocalVariable).getFunction() = func
and v__mptr_273.(LocalVariable).getFunction() = func
and vnhe_255.getFunction() = func
and ve_256.getFunction() = func
and vnext_258.(LocalVariable).getFunction() = func
and v__head_265.(LocalVariable).getFunction() = func
and v__ptr_265.(LocalVariable).getFunction() = func
and v__next_265.(LocalVariable).getFunction() = func
and v__mptr_265.(LocalVariable).getFunction() = func
and v__ptr_269.(LocalVariable).getFunction() = func
and v__next_269.(LocalVariable).getFunction() = func
and v__mptr_269.(LocalVariable).getFunction() = func
and v__head_273.(LocalVariable).getFunction() = func
and v__ptr_273.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
