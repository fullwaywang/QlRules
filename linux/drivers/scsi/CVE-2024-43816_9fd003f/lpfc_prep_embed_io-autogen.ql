/**
 * @name linux-9fd003f344d502f65252963169df3dd237054e49-lpfc_prep_embed_io
 * @id cpp/linux/9fd003f344d502f65252963169df3dd237054e49/lpfc-prep-embed-io
 * @description linux-9fd003f344d502f65252963169df3dd237054e49-drivers/scsi/lpfc/lpfc_sli.c-lpfc_prep_embed_io CVE-2024-43816
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(ExprStmt target_49, Function func, ExprStmt target_2) {
	target_2.getExpr() instanceof StmtExpr
	and target_49.getLocation().isBefore(target_2.getLocation())
	and target_2.getEnclosingFunction() = func
}

predicate func_4(Variable vsgl_10582) {
exists(AssignExpr target_4 |
	exists(PointerFieldAccess obj_0 | obj_0=target_4.getRValue() |
		obj_0.getTarget().getName()="sge_len"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vsgl_10582
	)
	and target_4.getLValue().(VariableAccess).getType().hasName("u32")
)
}

predicate func_5(Function func) {
exists(AssignOrExpr target_5 |
	target_5.getLValue().(VariableAccess).getType().hasName("u32")
	and target_5.getEnclosingFunction() = func
)
}

predicate func_6(Function func) {
exists(AssignExpr target_6 |
	exists(ValueFieldAccess obj_0 | obj_0=target_6.getLValue() |
		obj_0.getTarget().getName()="w"
		and obj_0.getQualifier() instanceof ValueFieldAccess
	)
	and target_6.getRValue().(VariableAccess).getType().hasName("u32")
	and target_6.getEnclosingFunction() = func
)
}

predicate func_7(Variable vsgl_10582, Variable vfcp_cmnd_10588, Variable vptr_10589, ExprStmt target_50) {
exists(FunctionCall target_7 |
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getArgument(2) |
		exists(VariableAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget()=vsgl_10582
			and obj_1.getLocation().isBefore(target_50.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		)
		and obj_0.getTarget().getName()="sge_len"
	)
	and target_7.getTarget().hasName("lpfc_sli_pcimem_bcopy")
	and target_7.getArgument(0).(VariableAccess).getTarget()=vfcp_cmnd_10588
	and target_7.getArgument(1).(VariableAccess).getTarget()=vptr_10589
)
}

predicate func_8(Variable vwqe_10581, ValueFieldAccess target_8) {
	exists(ValueFieldAccess obj_0 | obj_0=target_8.getQualifier() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="generic"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vwqe_10581
				)
				and obj_2.getTarget().getName()="bde"
			)
			and obj_1.getTarget().getName()="tus"
		)
		and obj_0.getTarget().getName()="f"
	)
	and target_8.getTarget().getName()="bdeFlags"
}

predicate func_9(Variable vwqe_10581, ValueFieldAccess target_9) {
	exists(ValueFieldAccess obj_0 | obj_0=target_9.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="generic"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vwqe_10581
		)
		and obj_0.getTarget().getName()="bde"
	)
	and target_9.getTarget().getName()="tus"
}

predicate func_10(Variable vsgl_10582, PointerFieldAccess target_51, ExprStmt target_10) {
	exists(AssignExpr obj_0 | obj_0=target_10.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				exists(ValueFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					exists(ValueFieldAccess obj_4 | obj_4=obj_3.getQualifier() |
						obj_4.getTarget().getName()="bde"
						and obj_4.getQualifier().(PointerFieldAccess).getTarget().getName()="generic"
					)
					and obj_3.getTarget().getName()="tus"
				)
				and obj_2.getTarget().getName()="f"
			)
			and obj_1.getTarget().getName()="bdeSize"
		)
		and exists(PointerFieldAccess obj_5 | obj_5=obj_0.getRValue() |
			obj_5.getTarget().getName()="sge_len"
			and obj_5.getQualifier().(VariableAccess).getTarget()=vsgl_10582
		)
	)
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_51
}

predicate func_11(Variable vsgl_10582, PointerFieldAccess target_11) {
	target_11.getTarget().getName()="sge_len"
	and target_11.getQualifier().(VariableAccess).getTarget()=vsgl_10582
}

predicate func_12(Variable vfcp_cmnd_10588, VariableAccess target_12) {
	target_12.getTarget()=vfcp_cmnd_10588
	and target_12.getParent().(FunctionCall).getParent().(Initializer).getExpr() instanceof FunctionCall
}

predicate func_13(Variable vptr_10589, VariableAccess target_13) {
	target_13.getTarget()=vptr_10589
	and target_13.getParent().(FunctionCall).getParent().(Initializer).getExpr() instanceof FunctionCall
}

predicate func_14(Function func, AssignExpr target_14) {
	target_14.getLValue() instanceof ValueFieldAccess
	and target_14.getRValue().(Literal).getValue()="1"
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Variable vfcp_cmnd_10588, Variable vptr_10589, Variable v__fortify_size_10605, StmtExpr target_15) {
	exists(BlockStmt obj_0 | obj_0=target_15.getStmt() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getStmt(6) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getExpr() |
				obj_2.getTarget().hasName("__builtin_memcpy")
				and obj_2.getArgument(0).(VariableAccess).getTarget()=vptr_10589
				and obj_2.getArgument(1).(VariableAccess).getTarget()=vfcp_cmnd_10588
				and obj_2.getArgument(2).(VariableAccess).getTarget()=v__fortify_size_10605
			)
		)
		and obj_0.getStmt(5).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	)
}

/*predicate func_21(Variable v__ret_do_once_10605, StmtExpr target_21) {
	exists(BlockStmt obj_0 | obj_0=target_21.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(1) |
			exists(StmtExpr obj_2 | obj_2=obj_1.getCondition() |
				exists(BlockStmt obj_3 | obj_3=obj_2.getStmt() |
					obj_3.getStmt(3).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
					and obj_3.getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
				)
			)
		)
		and exists(ExprStmt obj_4 | obj_4=obj_0.getStmt(2) |
			exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
				obj_5.getTarget().hasName("__builtin_expect")
				and obj_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_do_once_10605
				and obj_5.getArgument(1) instanceof Literal
			)
		)
	)
}

*/
/*predicate func_23(Function func, IfStmt target_23) {
	exists(StmtExpr obj_0 | obj_0=target_23.getCondition() |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(IfStmt obj_2 | obj_2=obj_1.getStmt(3) |
				exists(FunctionCall obj_3 | obj_3=obj_2.getCondition() |
					obj_3.getTarget().hasName("__builtin_expect")
					and obj_3.getArgument(1) instanceof Literal
				)
			)
			and exists(ExprStmt obj_4 | obj_4=obj_1.getStmt(4) |
				exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
					obj_5.getTarget().hasName("__builtin_expect")
					and obj_5.getArgument(1) instanceof Literal
				)
			)
		)
	)
	and exists(ExprStmt obj_6 | obj_6=target_23.getThen() |
		exists(StmtExpr obj_7 | obj_7=obj_6.getExpr() |
			exists(BlockStmt obj_8 | obj_8=obj_7.getStmt() |
				exists(IfStmt obj_9 | obj_9=obj_8.getStmt(1) |
					exists(FunctionCall obj_10 | obj_10=obj_9.getCondition() |
						obj_10.getTarget().hasName("__builtin_expect")
						and obj_10.getArgument(1) instanceof Literal
					)
					and obj_9.getThen().(DoStmt).getCondition() instanceof Literal
				)
				and exists(ExprStmt obj_11 | obj_11=obj_8.getStmt(2) |
					exists(FunctionCall obj_12 | obj_12=obj_11.getExpr() |
						obj_12.getTarget().hasName("__builtin_expect")
						and obj_12.getArgument(1) instanceof Literal
					)
				)
			)
		)
	)
	and target_23.getEnclosingFunction() = func
}

*/
/*predicate func_27(Variable v__already_done_10605, Variable v__ret_cond_10605, Variable v__ret_once_10605, IfStmt target_27) {
	exists(FunctionCall obj_0 | obj_0=target_27.getCondition() |
		exists(NotExpr obj_1 | obj_1=obj_0.getArgument(0) |
			exists(NotExpr obj_2 | obj_2=obj_1.getOperand() |
				exists(LogicalAndExpr obj_3 | obj_3=obj_2.getOperand() |
					obj_3.getLeftOperand().(VariableAccess).getTarget()=v__ret_cond_10605
					and obj_3.getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__already_done_10605
				)
			)
		)
		and obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(1) instanceof Literal
	)
	and exists(BlockStmt obj_4 | obj_4=target_27.getThen() |
		obj_4.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_10605
		and obj_4.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_10605
	)
}

*/
/*predicate func_28(Variable v__already_done_10605, AssignExpr target_28) {
	target_28.getLValue().(VariableAccess).getTarget()=v__already_done_10605
}

*/
/*predicate func_29(Variable v__ret_once_10605, FunctionCall target_52, ExprStmt target_29) {
	target_29.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_10605
	and target_29.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_52
}

*/
/*predicate func_30(Variable v__ret_once_10605, ExprStmt target_30) {
	exists(FunctionCall obj_0 | obj_0=target_30.getExpr() |
		obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_once_10605
		and obj_0.getArgument(1) instanceof Literal
	)
}

*/
/*predicate func_32(Variable v__ret_warn_on_10605, IfStmt target_32) {
	exists(FunctionCall obj_0 | obj_0=target_32.getCondition() |
		obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_10605
		and obj_0.getArgument(1) instanceof Literal
	)
	and exists(DoStmt obj_1 | obj_1=target_32.getThen() |
		exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
			exists(DoStmt obj_3 | obj_3=obj_2.getStmt(2) |
				obj_3.getCondition() instanceof Literal
				and obj_3.getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition() instanceof Literal
			)
		)
		and obj_1.getCondition() instanceof Literal
	)
}

*/
/*predicate func_33(Function func, ExprStmt target_33) {
	target_33.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1447"
	and target_33.getEnclosingFunction() = func
}

*/
/*predicate func_34(Function func, AsmStmt target_34) {
	target_34.getChild(0).(Literal).getValue()="1447"
	and target_34.getEnclosingFunction() = func
}

*/
/*predicate func_36(Variable v__flags_10605, DoStmt target_36) {
	exists(BlockStmt obj_0 | obj_0=target_36.getStmt() |
		exists(DoStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(AsmStmt obj_3 | obj_3=obj_2.getStmt(0) |
					exists(SizeofTypeOperator obj_4 | obj_4=obj_3.getChild(3) |
						obj_4.getType() instanceof LongType
						and obj_4.getValue()="12"
					)
					and obj_3.getChild(0) instanceof StringLiteral
					and obj_3.getChild(1) instanceof Literal
					and obj_3.getChild(2).(VariableAccess).getTarget()=v__flags_10605
				)
			)
			and obj_1.getCondition() instanceof Literal
		)
		and obj_0.getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1448"
		and obj_0.getStmt(3).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1449"
	)
	and target_36.getCondition() instanceof Literal
}

*/
/*predicate func_38(Function func, ExprStmt target_38) {
	target_38.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1448"
	and target_38.getEnclosingFunction() = func
}

*/
/*predicate func_39(Function func, AsmStmt target_39) {
	target_39.getChild(0).(Literal).getValue()="1448"
	and target_39.getEnclosingFunction() = func
}

*/
/*predicate func_40(Variable v__flags_10605, DoStmt target_40) {
	exists(BlockStmt obj_0 | obj_0=target_40.getStmt() |
		exists(AsmStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(SizeofTypeOperator obj_2 | obj_2=obj_1.getChild(3) |
				obj_2.getType() instanceof LongType
				and obj_2.getValue()="12"
			)
			and obj_1.getChild(0) instanceof StringLiteral
			and obj_1.getChild(1) instanceof Literal
			and obj_1.getChild(2).(VariableAccess).getTarget()=v__flags_10605
		)
	)
	and target_40.getCondition() instanceof Literal
}

*/
/*predicate func_41(Variable v__flags_10605, AsmStmt target_41) {
	exists(SizeofTypeOperator obj_0 | obj_0=target_41.getChild(3) |
		obj_0.getType() instanceof LongType
		and obj_0.getValue()="12"
	)
	and target_41.getChild(0) instanceof StringLiteral
	and target_41.getChild(1) instanceof Literal
	and target_41.getChild(2).(VariableAccess).getTarget()=v__flags_10605
}

*/
/*predicate func_42(Function func, ExprStmt target_42) {
	target_42.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1449"
	and target_42.getEnclosingFunction() = func
}

*/
/*predicate func_43(Function func, AsmStmt target_43) {
	target_43.getChild(0).(Literal).getValue()="1449"
	and target_43.getEnclosingFunction() = func
}

*/
/*predicate func_44(Function func, ExprStmt target_44) {
	target_44.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1450"
	and target_44.getEnclosingFunction() = func
}

*/
/*predicate func_45(Function func, AsmStmt target_45) {
	target_45.getChild(0).(Literal).getValue()="1450"
	and target_45.getEnclosingFunction() = func
}

*/
/*predicate func_46(Variable v__ret_warn_on_10605, ExprStmt target_46) {
	exists(FunctionCall obj_0 | obj_0=target_46.getExpr() |
		obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_10605
		and obj_0.getArgument(1) instanceof Literal
	)
}

*/
/*predicate func_47(Variable v__ret_do_once_10605, ExprStmt target_47) {
	exists(FunctionCall obj_0 | obj_0=target_47.getExpr() |
		obj_0.getTarget().hasName("__builtin_expect")
		and obj_0.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_do_once_10605
		and obj_0.getArgument(1) instanceof Literal
	)
}

*/
/*predicate func_48(Variable vfcp_cmnd_10588, Variable vptr_10589, Variable v__fortify_size_10605, ExprStmt target_48) {
	exists(FunctionCall obj_0 | obj_0=target_48.getExpr() |
		obj_0.getTarget().hasName("__builtin_memcpy")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vptr_10589
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vfcp_cmnd_10588
		and obj_0.getArgument(2).(VariableAccess).getTarget()=v__fortify_size_10605
	)
}

*/
predicate func_49(Variable vwqe_10581, Variable vptr_10589, ExprStmt target_49) {
	exists(AssignExpr obj_0 | obj_0=target_49.getExpr() |
		exists(AddressOfExpr obj_1 | obj_1=obj_0.getRValue() |
			exists(ArrayExpr obj_2 | obj_2=obj_1.getOperand() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getArrayBase() |
					obj_3.getTarget().getName()="words"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vwqe_10581
				)
				and obj_2.getArrayOffset().(Literal).getValue()="18"
			)
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vptr_10589
	)
}

predicate func_50(Variable vsgl_10582, ExprStmt target_50) {
	exists(AssignExpr obj_0 | obj_0=target_50.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="f"
				and obj_2.getQualifier() instanceof ValueFieldAccess
			)
			and obj_1.getTarget().getName()="bdeSize"
		)
		and exists(PointerFieldAccess obj_3 | obj_3=obj_0.getRValue() |
			obj_3.getTarget().getName()="sge_len"
			and obj_3.getQualifier().(VariableAccess).getTarget()=vsgl_10582
		)
	)
}

predicate func_51(Function func, PointerFieldAccess target_51) {
	target_51.getTarget().getName()="fcp_embed_io"
	and target_51.getQualifier().(VariableAccess).getTarget().getType().hasName("lpfc_hba *")
	and target_51.getEnclosingFunction() = func
}

predicate func_52(Function func, FunctionCall target_52) {
	target_52.getTarget().hasName("__builtin_expect")
	and target_52.getArgument(0) instanceof NotExpr
	and target_52.getArgument(1) instanceof Literal
	and target_52.getEnclosingFunction() = func
}

from Function func, Variable vwqe_10581, Variable vsgl_10582, Variable vfcp_cmnd_10588, Variable vptr_10589, Variable v__fortify_size_10605, Variable v__ret_do_once_10605, Variable v__already_done_10605, Variable v__ret_cond_10605, Variable v__ret_once_10605, Variable v__ret_warn_on_10605, Variable v__flags_10605, ExprStmt target_2, ValueFieldAccess target_8, ValueFieldAccess target_9, ExprStmt target_10, PointerFieldAccess target_11, VariableAccess target_12, VariableAccess target_13, AssignExpr target_14, StmtExpr target_15, ExprStmt target_49, ExprStmt target_50, PointerFieldAccess target_51, FunctionCall target_52
where
func_2(target_49, func, target_2)
and not func_4(vsgl_10582)
and not func_5(func)
and not func_6(func)
and not func_7(vsgl_10582, vfcp_cmnd_10588, vptr_10589, target_50)
and func_8(vwqe_10581, target_8)
and func_9(vwqe_10581, target_9)
and func_10(vsgl_10582, target_51, target_10)
and func_11(vsgl_10582, target_11)
and func_12(vfcp_cmnd_10588, target_12)
and func_13(vptr_10589, target_13)
and func_14(func, target_14)
and func_15(vfcp_cmnd_10588, vptr_10589, v__fortify_size_10605, target_15)
and func_49(vwqe_10581, vptr_10589, target_49)
and func_50(vsgl_10582, target_50)
and func_51(func, target_51)
and func_52(func, target_52)
and vwqe_10581.getType().hasName("lpfc_wqe128 *")
and vsgl_10582.getType().hasName("sli4_sge *")
and vfcp_cmnd_10588.getType().hasName("fcp_cmnd *")
and vptr_10589.getType().hasName("u32 *")
and v__fortify_size_10605.getType().hasName("const size_t")
and v__ret_do_once_10605.getType().hasName("bool")
and v__already_done_10605.getType().hasName("bool")
and v__ret_cond_10605.getType().hasName("bool")
and v__ret_once_10605.getType().hasName("bool")
and v__ret_warn_on_10605.getType().hasName("int")
and v__flags_10605.getType().hasName("int")
and vwqe_10581.(LocalVariable).getFunction() = func
and vsgl_10582.(LocalVariable).getFunction() = func
and vfcp_cmnd_10588.(LocalVariable).getFunction() = func
and vptr_10589.(LocalVariable).getFunction() = func
and v__fortify_size_10605.(LocalVariable).getFunction() = func
and v__ret_do_once_10605.(LocalVariable).getFunction() = func
and v__already_done_10605.(LocalVariable).getFunction() = func
and v__ret_cond_10605.(LocalVariable).getFunction() = func
and v__ret_once_10605.(LocalVariable).getFunction() = func
and v__ret_warn_on_10605.(LocalVariable).getFunction() = func
and v__flags_10605.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
