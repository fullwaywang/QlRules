/**
 * @name linux-1f5a81e41f8b1a782c68d3843e9ec1bfaadf7d72-mext_check_arguments
 * @id cpp/linux/1f5a81e41f8b1a782c68d3843e9ec1bfaadf7d72/mext-check-arguments
 * @description linux-1f5a81e41f8b1a782c68d3843e9ec1bfaadf7d72-fs/ext4/move_extent.c-mext_check_arguments CVE-2010-2066
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdonor_inode_949, BitwiseAndExpr target_1, LogicalOrExpr target_2, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_flags"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdonor_inode_949
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="8"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_flags"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdonor_inode_949
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4"
		and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vdonor_inode_949, BitwiseAndExpr target_1) {
		target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdonor_inode_949
		and target_1.getRightOperand().(BitwiseOrExpr).getValue()="3072"
}

predicate func_2(Parameter vdonor_inode_949, LogicalOrExpr target_2) {
		target_2.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_flags"
		and target_2.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("inode *")
		and target_2.getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
		and target_2.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_flags"
		and target_2.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdonor_inode_949
		and target_2.getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
}

from Function func, Parameter vdonor_inode_949, BitwiseAndExpr target_1, LogicalOrExpr target_2
where
not func_0(vdonor_inode_949, target_1, target_2, func)
and func_1(vdonor_inode_949, target_1)
and func_2(vdonor_inode_949, target_2)
and vdonor_inode_949.getType().hasName("inode *")
and vdonor_inode_949.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
