/**
 * @name linux-ea3d7209ca01da209cda6f0dea8be9cc4b7a933b-ext4_insert_range
 * @id cpp/linux/ea3d7209ca01da209cda6f0dea8be9cc4b7a933b/ext4-insert-range
 * @description linux-ea3d7209ca01da209cda6f0dea8be9cc4b7a933b-fs/ext4/extents.c-ext4_insert_range CVE-2015-8839
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BuiltInOperationBuiltInOffsetOf target_0) {
		target_0.getValue()="432"
		and target_0.getEnclosingFunction() = func
}

/*predicate func_1(Function func, BuiltInOperationBuiltInOffsetOf target_1) {
		target_1.getValue()="432"
		and target_1.getEnclosingFunction() = func
}

*/
predicate func_2(Variable v__mptr_5684, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="i_data_sem"
		and target_2.getQualifier().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_5684
		and target_2.getQualifier().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="432"
}

predicate func_3(Function func, BuiltInOperationBuiltInOffsetOf target_3) {
		target_3.getValue()="432"
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, BuiltInOperationBuiltInOffsetOf target_4) {
		target_4.getValue()="432"
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Function func, BuiltInOperationBuiltInOffsetOf target_5) {
		target_5.getValue()="432"
		and target_5.getEnclosingFunction() = func
}

/*predicate func_6(Function func, BuiltInOperationBuiltInOffsetOf target_6) {
		target_6.getValue()="432"
		and target_6.getEnclosingFunction() = func
}

*/
predicate func_7(Function func, FunctionCall target_7) {
		target_7.getTarget().hasName("up_write")
		and not target_7.getTarget().hasName("down_write")
		and target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_data_sem"
		and target_7.getEnclosingFunction() = func
}

predicate func_9(Function func) {
	exists(ExprStmt target_9 |
		target_9.getExpr().(FunctionCall).getTarget().hasName("up_write")
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i_mmap_sem"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9)
}

predicate func_10(Function func, ValueFieldAccess target_10) {
		target_10.getTarget().getName()="vfs_inode"
		and target_10.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_10.getEnclosingFunction() = func
}

predicate func_11(Function func, ValueFieldAccess target_11) {
		target_11.getTarget().getName()="vfs_inode"
		and target_11.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_11.getEnclosingFunction() = func
}

predicate func_12(Function func, ValueFieldAccess target_12) {
		target_12.getTarget().getName()="vfs_inode"
		and target_12.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_12.getEnclosingFunction() = func
}

predicate func_13(Function func, ValueFieldAccess target_13) {
		target_13.getTarget().getName()="vfs_inode"
		and target_13.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_13.getEnclosingFunction() = func
}

predicate func_14(Function func, ValueFieldAccess target_14) {
		target_14.getTarget().getName()="vfs_inode"
		and target_14.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, ValueFieldAccess target_15) {
		target_15.getTarget().getName()="vfs_inode"
		and target_15.getQualifier().(PointerDereferenceExpr).getOperand().(Literal).getValue()="0"
		and target_15.getEnclosingFunction() = func
}

from Function func, Variable v__mptr_5684, BuiltInOperationBuiltInOffsetOf target_0, PointerFieldAccess target_2, BuiltInOperationBuiltInOffsetOf target_3, BuiltInOperationBuiltInOffsetOf target_4, BuiltInOperationBuiltInOffsetOf target_5, FunctionCall target_7, ValueFieldAccess target_10, ValueFieldAccess target_11, ValueFieldAccess target_12, ValueFieldAccess target_13, ValueFieldAccess target_14, ValueFieldAccess target_15
where
func_0(func, target_0)
and func_2(v__mptr_5684, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(func, target_5)
and func_7(func, target_7)
and not func_9(func)
and func_10(func, target_10)
and func_11(func, target_11)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and v__mptr_5684.getType().hasName("const inode *")
and v__mptr_5684.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
