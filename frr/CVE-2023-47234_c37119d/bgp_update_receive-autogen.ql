/**
 * @name frr-c37119df45bbf4ef713bc10475af2ee06e12f3bf-bgp_update_receive
 * @id cpp/frr/c37119df45bbf4ef713bc10475af2ee06e12f3bf/bgp-update-receive
 * @description frr-c37119df45bbf4ef713bc10475af2ee06e12f3bf-bgpd/bgp_packet.c-bgp_update_receive CVE-2023-47234
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vattr_parse_ret_2320, BlockStmt target_2, EqualityOperation target_3, ConditionalExpr target_4) {
	exists(LogicalAndExpr target_0 |
		target_0.getAnOperand() instanceof LogicalAndExpr
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2320
		and target_0.getParent().(IfStmt).getThen()=target_2
		and target_3.getAnOperand().(VariableAccess).getLocation().isBefore(target_0.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation())
		and target_0.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable vattribute_len_2216, Variable vupdate_len_2217, BlockStmt target_2, LogicalAndExpr target_1) {
		target_1.getAnOperand().(VariableAccess).getTarget()=vupdate_len_2217
		and target_1.getAnOperand().(VariableAccess).getTarget()=vattribute_len_2216
		and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Function func, BlockStmt target_2) {
		target_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="afi"
		and target_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("bgp_nlri[4]")
		and target_2.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="safi"
		and target_2.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("bgp_nlri[4]")
		and target_2.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="nlri"
		and target_2.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("bgp_nlri[4]")
		and target_2.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("stream_pnt")
		and target_2.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("stream *")
		and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vattr_parse_ret_2320, DoStmt target_5, EqualityOperation target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2320
		and target_3.getParent().(IfStmt).getThen()=target_5
}

predicate func_4(Variable vattr_parse_ret_2320, ConditionalExpr target_4) {
		target_4.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vattr_parse_ret_2320
		and target_4.getThen().(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("attr")
		and target_4.getElse().(Literal).getValue()="0"
		and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bgp_nlri_parse")
		and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("peer *")
		and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("bgp_nlri[4]")
		and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
}

predicate func_5(Function func, DoStmt target_5) {
		target_5.getCondition().(Literal).getValue()="0"
		and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("zlog_ref")
		and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("const xref_logmsg")
		and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="%pBP rcvd UPDATE with errors in attr(s)!! Withdrawing route."
		and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("peer *")
		and target_5.getEnclosingFunction() = func
}

from Function func, Variable vattribute_len_2216, Variable vupdate_len_2217, Variable vattr_parse_ret_2320, LogicalAndExpr target_1, BlockStmt target_2, EqualityOperation target_3, ConditionalExpr target_4, DoStmt target_5
where
not func_0(vattr_parse_ret_2320, target_2, target_3, target_4)
and func_1(vattribute_len_2216, vupdate_len_2217, target_2, target_1)
and func_2(func, target_2)
and func_3(vattr_parse_ret_2320, target_5, target_3)
and func_4(vattr_parse_ret_2320, target_4)
and func_5(func, target_5)
and vattribute_len_2216.getType().hasName("bgp_size_t")
and vupdate_len_2217.getType().hasName("bgp_size_t")
and vattr_parse_ret_2320.getType().hasName("bgp_attr_parse_ret")
and vattribute_len_2216.(LocalVariable).getFunction() = func
and vupdate_len_2217.(LocalVariable).getFunction() = func
and vattr_parse_ret_2320.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
