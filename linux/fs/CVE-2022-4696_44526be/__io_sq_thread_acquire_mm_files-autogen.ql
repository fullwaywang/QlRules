/**
 * @name linux-44526bedc2ff8fcd58552e3c5bae928524b6f13c-__io_sq_thread_acquire_mm_files
 * @id cpp/linux/44526bedc2ff8fcd58552e3c5bae928524b6f13c/--io-sq-thread-acquire-mm-files
 * @description linux-44526bedc2ff8fcd58552e3c5bae928524b6f13c-fs/io_uring.c-__io_sq_thread_acquire_mm_files CVE-2022-4696
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vret_1223, Parameter vctx_1219, BitwiseAndExpr target_7, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1223
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__io_sq_thread_acquire_mm")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_1219
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

predicate func_1(Variable vret_1223, BitwiseAndExpr target_7, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_1223
	and target_1.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_1.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_1223
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
}

predicate func_2(Variable vret_1223, Parameter vctx_1219, LogicalOrExpr target_8, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1223
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__io_sq_thread_acquire_files")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_1219
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
}

predicate func_3(Variable vret_1223, LogicalOrExpr target_8, IfStmt target_3) {
	target_3.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_1223
	and target_3.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_1223
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
}

predicate func_4(Function func, DeclStmt target_4) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable vdef_1222, Function func, IfStmt target_5) {
	target_5.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="work_flags"
	and target_5.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1222
	and target_5.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_5.getThen().(BlockStmt).getStmt(1) instanceof IfStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vdef_1222, Function func, IfStmt target_6) {
	target_6.getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="needs_file"
	and target_6.getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1222
	and target_6.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="work_flags"
	and target_6.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1222
	and target_6.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_6.getThen().(BlockStmt).getStmt(1) instanceof IfStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vdef_1222, BitwiseAndExpr target_7) {
	target_7.getLeftOperand().(PointerFieldAccess).getTarget().getName()="work_flags"
	and target_7.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1222
	and target_7.getRightOperand() instanceof EnumConstantAccess
}

predicate func_8(Variable vdef_1222, LogicalOrExpr target_8) {
	target_8.getLeftOperand().(PointerFieldAccess).getTarget().getName()="needs_file"
	and target_8.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1222
	and target_8.getRightOperand() instanceof BitwiseAndExpr
}

from Function func, Variable vdef_1222, Variable vret_1223, Parameter vctx_1219, ExprStmt target_0, IfStmt target_1, ExprStmt target_2, IfStmt target_3, DeclStmt target_4, IfStmt target_5, IfStmt target_6, BitwiseAndExpr target_7, LogicalOrExpr target_8
where
func_0(vret_1223, vctx_1219, target_7, target_0)
and func_1(vret_1223, target_7, target_1)
and func_2(vret_1223, vctx_1219, target_8, target_2)
and func_3(vret_1223, target_8, target_3)
and func_4(func, target_4)
and func_5(vdef_1222, func, target_5)
and func_6(vdef_1222, func, target_6)
and func_7(vdef_1222, target_7)
and func_8(vdef_1222, target_8)
and vdef_1222.getType().hasName("const io_op_def *")
and vret_1223.getType().hasName("int")
and vctx_1219.getType().hasName("io_ring_ctx *")
and vdef_1222.(LocalVariable).getFunction() = func
and vret_1223.(LocalVariable).getFunction() = func
and vctx_1219.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
