commit aa066afaaac32caf2160d58d4e3010ee04421c62
Author: Thomas Weißschuh <linux@weissschuh.net>
Date:   Fri Jun 28 12:37:04 2024 +0100

    nvmem: core: limit cell sysfs permissions to main attribute ones
    
    commit 6bef98bafd82903a8d461463f9594f19f1fd6a85 upstream.
    
    The cell sysfs attribute should not provide more access to the nvmem
    data than the main attribute itself.
    For example if nvme_config::root_only was set, the cell attribute
    would still provide read access to everybody.
    
    Mask out permissions not available on the main attribute.
    
    Fixes: 0331c611949f ("nvmem: core: Expose cells through sysfs")
    Cc: stable@vger.kernel.org
    Signed-off-by: Thomas Weißschuh <linux@weissschuh.net>
    Signed-off-by: Srinivas Kandagatla <srinivas.kandagatla@linaro.org>
    Link: https://lore.kernel.org/r/20240628113704.13742-5-srinivas.kandagatla@linaro.org
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/drivers/nvmem/core.c b/drivers/nvmem/core.c
index 8b32f9696c10..3a3f9b5018ca 100644
--- a/drivers/nvmem/core.c
+++ b/drivers/nvmem/core.c
@@ -462,7 +462,7 @@ static int nvmem_populate_sysfs_cells(struct nvmem_device *nvmem)
 						    "%s@%x,%x", entry->name,
 						    entry->offset,
 						    entry->bit_offset);
-		attrs[i].attr.mode = 0444;
+		attrs[i].attr.mode = 0444 & nvmem_bin_attr_get_umode(nvmem);
 		attrs[i].size = entry->bytes;
 		attrs[i].read = &nvmem_cell_attr_read;
 		attrs[i].private = entry;
