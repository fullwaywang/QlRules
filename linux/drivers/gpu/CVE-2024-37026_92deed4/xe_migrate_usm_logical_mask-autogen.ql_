/**
 * @name linux-92deed4a9bfd9ef187764225bba530116c49e15c-xe_migrate_usm_logical_mask
 * @id cpp/linux/92deed4a9bfd9ef187764225bba530116c49e15c/xe-migrate-usm-logical-mask
 * @description linux-92deed4a9bfd9ef187764225bba530116c49e15c-drivers/gpu/drm/xe/xe_migrate.c-xe_migrate_usm_logical_mask CVE-2024-37026
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vhwe_312, Parameter vgt_309, FunctionCall target_0) {
	target_0.getTarget().hasName("xe_gt_is_usm_hwe")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vgt_309
	and target_0.getArgument(1).(VariableAccess).getTarget()=vhwe_312
}

predicate func_1(Variable vhwe_312, ExprStmt target_2, LogicalOrExpr target_1) {
	exists(LogicalOrExpr obj_0 | obj_0=target_1.getLeftOperand() |
		exists(NotExpr obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(ConditionalExpr obj_2 | obj_2=obj_1.getOperand() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getThen() |
					exists(ValueFieldAccess obj_4 | obj_4=obj_3.getArgument(1) |
						obj_4.getTarget().getName()="oob"
						and obj_4.getQualifier().(PointerFieldAccess).getTarget().getName()="wa_active"
					)
					and obj_3.getTarget().hasName("const_test_bit")
				)
				and exists(FunctionCall obj_5 | obj_5=obj_2.getElse() |
					exists(ValueFieldAccess obj_6 | obj_6=obj_5.getArgument(1) |
						obj_6.getTarget().getName()="oob"
						and obj_6.getQualifier().(PointerFieldAccess).getTarget().getName()="wa_active"
					)
					and obj_5.getTarget().hasName("_test_bit")
				)
				and obj_2.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("__builtin_constant_p")
			)
		)
		and obj_0.getRightOperand() instanceof FunctionCall
	)
	and exists(BitwiseAndExpr obj_7 | obj_7=target_1.getRightOperand() |
		exists(PointerFieldAccess obj_8 | obj_8=obj_7.getLeftOperand() |
			obj_8.getTarget().getName()="instance"
			and obj_8.getQualifier().(VariableAccess).getTarget()=vhwe_312
		)
		and obj_7.getRightOperand().(Literal).getValue()="1"
	)
	and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vhwe_312, ExprStmt target_2) {
	exists(AssignOrExpr obj_0 | obj_0=target_2.getExpr() |
		exists(BinaryBitwiseOperation obj_1 | obj_1=obj_0.getRValue() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getRightOperand() |
				obj_2.getTarget().getName()="logical_instance"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vhwe_312
			)
			and obj_1.getLeftOperand().(Literal).getValue()="1"
		)
		and obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("u32")
	)
}

from Function func, Variable vhwe_312, Parameter vgt_309, FunctionCall target_0, LogicalOrExpr target_1, ExprStmt target_2
where
func_0(vhwe_312, vgt_309, target_0)
and func_1(vhwe_312, target_2, target_1)
and func_2(vhwe_312, target_2)
and vhwe_312.getType().hasName("xe_hw_engine *")
and vgt_309.getType().hasName("xe_gt *")
and vhwe_312.(LocalVariable).getFunction() = func
and vgt_309.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
