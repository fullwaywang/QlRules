/**
 * @name linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-target_xcopy_parse_target_descriptors
 * @id cpp/linux/2896c93811e39d63a4d9b63ccf12a8fbc226e5e4/target-xcopy-parse-target-descriptors
 * @description linux-2896c93811e39d63a4d9b63ccf12a8fbc226e5e4-drivers/target/target_core_xcopy.c-target_xcopy_parse_target_descriptors CVE-2020-28374
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable v__UNIQUE_ID_ddebug892_273, VariableAccess target_1) {
	target_1.getTarget()=v__UNIQUE_ID_ddebug892_273
	and target_1.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_2(Variable v__UNIQUE_ID_ddebug892_273, VariableAccess target_2) {
	target_2.getTarget()=v__UNIQUE_ID_ddebug892_273
	and target_2.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_3(Variable v__UNIQUE_ID_ddebug892_273, Parameter vxop_192, VariableAccess target_3) {
	target_3.getTarget()=v__UNIQUE_ID_ddebug892_273
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY TGT desc: Source dev: %p NAA IEEE WWN: 0x%16phN\n"
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="src_dev"
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="src_tid_wwn"
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset() instanceof Literal
}

predicate func_5(Variable v__UNIQUE_ID_ddebug893_275, VariableAccess target_5) {
	target_5.getTarget()=v__UNIQUE_ID_ddebug893_275
	and target_5.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_6(Variable v__UNIQUE_ID_ddebug893_275, VariableAccess target_6) {
	target_6.getTarget()=v__UNIQUE_ID_ddebug893_275
	and target_6.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_7(Variable v__UNIQUE_ID_ddebug893_275, Parameter vxop_192, VariableAccess target_7) {
	target_7.getTarget()=v__UNIQUE_ID_ddebug893_275
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="XCOPY TGT desc: Dest dev: %p NAA IEEE WWN: 0x%16phN\n"
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="dst_dev"
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="dst_tid_wwn"
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_7.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset() instanceof Literal
}

predicate func_8(Parameter vse_cmd_191, ExprStmt target_12) {
exists(PointerFieldAccess target_8 |
	target_8.getTarget().getName()="se_sess"
	and target_8.getQualifier().(VariableAccess).getTarget()=vse_cmd_191
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_8.getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Parameter vxop_192, AddressOfExpr target_13, ExprStmt target_14) {
exists(AddressOfExpr target_9 |
	target_9.getOperand().(PointerFieldAccess).getTarget().getName()="remote_lun_ref"
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("target_xcopy_locate_se_dev_e4")
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dst_tid_wwn"
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dst_dev"
	and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_10(Parameter vse_cmd_191) {
exists(PointerFieldAccess target_10 |
	target_10.getTarget().getName()="se_sess"
	and target_10.getQualifier().(VariableAccess).getTarget()=vse_cmd_191)
}

predicate func_11(Parameter vxop_192, AddressOfExpr target_15, ExprStmt target_16) {
exists(AddressOfExpr target_11 |
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="remote_lun_ref"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("target_xcopy_locate_se_dev_e4")
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="src_tid_wwn"
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="src_dev"
	and target_11.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_15.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_12(Parameter vse_cmd_191, Parameter vxop_192, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("target_xcopy_parse_tiddesc_e4")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vse_cmd_191
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vxop_192
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("unsigned char *")
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned short")
}

predicate func_13(Parameter vxop_192, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="dst_dev"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
}

predicate func_14(Parameter vxop_192, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("target_xcopy_locate_se_dev_e4")
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="src_tid_wwn"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="src_dev"
	and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
}

predicate func_15(Parameter vxop_192, AddressOfExpr target_15) {
	target_15.getOperand().(PointerFieldAccess).getTarget().getName()="src_dev"
	and target_15.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
}

predicate func_16(Parameter vxop_192, ExprStmt target_16) {
	target_16.getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_16.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="3XCOPY CSCD descriptor IDs not found in CSCD list - stdi: %hu dtdi: %hu\n"
	and target_16.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="stdi"
	and target_16.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
	and target_16.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="dtdi"
	and target_16.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vxop_192
}

from Function func, Variable v__UNIQUE_ID_ddebug892_273, Variable v__UNIQUE_ID_ddebug893_275, Parameter vse_cmd_191, Parameter vxop_192, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, ExprStmt target_12, AddressOfExpr target_13, ExprStmt target_14, AddressOfExpr target_15, ExprStmt target_16
where
func_1(v__UNIQUE_ID_ddebug892_273, target_1)
and func_2(v__UNIQUE_ID_ddebug892_273, target_2)
and func_3(v__UNIQUE_ID_ddebug892_273, vxop_192, target_3)
and func_5(v__UNIQUE_ID_ddebug893_275, target_5)
and func_6(v__UNIQUE_ID_ddebug893_275, target_6)
and func_7(v__UNIQUE_ID_ddebug893_275, vxop_192, target_7)
and not func_8(vse_cmd_191, target_12)
and not func_9(vxop_192, target_13, target_14)
and not func_10(vse_cmd_191)
and not func_11(vxop_192, target_15, target_16)
and func_12(vse_cmd_191, vxop_192, target_12)
and func_13(vxop_192, target_13)
and func_14(vxop_192, target_14)
and func_15(vxop_192, target_15)
and func_16(vxop_192, target_16)
and v__UNIQUE_ID_ddebug892_273.getType().hasName("_ddebug")
and v__UNIQUE_ID_ddebug893_275.getType().hasName("_ddebug")
and vse_cmd_191.getType().hasName("se_cmd *")
and vxop_192.getType().hasName("xcopy_op *")
and v__UNIQUE_ID_ddebug892_273.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug893_275.(LocalVariable).getFunction() = func
and vse_cmd_191.getFunction() = func
and vxop_192.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
