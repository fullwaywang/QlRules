/**
 * @name linux-0c97527e916054acc4a46ffb02842988acb2e92b-cdrom_ioctl_timed_media_change
 * @id cpp/linux/0c97527e916054acc4a46ffb02842988acb2e92b/cdrom-ioctl-timed-media-change
 * @description linux-0c97527e916054acc4a46ffb02842988acb2e92b-drivers/cdrom/cdrom.c-cdrom_ioctl_timed_media_change CVE-2024-42136
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcdi_2354, ExprStmt target_4, ExprStmt target_5) {
exists(RelationalOperation target_0 |
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getGreaterOperand() |
		obj_0.getTarget().getName()="last_media_change_ms"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vcdi_2354
	)
	and  (target_0 instanceof GTExpr or target_0 instanceof LTExpr)
	and target_0.getLesserOperand() instanceof ValueFieldAccess
	and target_0.getParent().(IfStmt).getThen()=target_4
	and target_0.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_1(Variable vtmp_info_2359, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="last_media_change"
	and target_1.getQualifier().(VariableAccess).getTarget()=vtmp_info_2359
}

predicate func_2(Parameter vcdi_2354, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="last_media_change_ms"
	and target_2.getQualifier().(VariableAccess).getTarget()=vcdi_2354
}

predicate func_3(Parameter vcdi_2354, ExprStmt target_4, RelationalOperation target_3) {
	exists(SubExpr obj_0 | obj_0=target_3.getLesserOperand() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getRightOperand() |
			obj_1.getTarget().getName()="last_media_change_ms"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vcdi_2354
		)
		and obj_0.getLeftOperand() instanceof ValueFieldAccess
	)
	and  (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getGreaterOperand().(Literal).getValue()="0"
	and target_3.getParent().(IfStmt).getThen()=target_4
}

predicate func_4(Variable vtmp_info_2359, ExprStmt target_4) {
	exists(AssignOrExpr obj_0 | obj_0=target_4.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="media_flags"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vtmp_info_2359
		)
		and obj_0.getRValue().(Literal).getValue()="1"
	)
}

predicate func_5(Variable vtmp_info_2359, Parameter vcdi_2354, ExprStmt target_5) {
	exists(AssignExpr obj_0 | obj_0=target_5.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="last_media_change"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vtmp_info_2359
		)
		and exists(PointerFieldAccess obj_2 | obj_2=obj_0.getRValue() |
			obj_2.getTarget().getName()="last_media_change_ms"
			and obj_2.getQualifier().(VariableAccess).getTarget()=vcdi_2354
		)
	)
}

from Function func, Variable vtmp_info_2359, Parameter vcdi_2354, ValueFieldAccess target_1, PointerFieldAccess target_2, RelationalOperation target_3, ExprStmt target_4, ExprStmt target_5
where
not func_0(vcdi_2354, target_4, target_5)
and func_1(vtmp_info_2359, target_1)
and func_2(vcdi_2354, target_2)
and func_3(vcdi_2354, target_4, target_3)
and func_4(vtmp_info_2359, target_4)
and func_5(vtmp_info_2359, vcdi_2354, target_5)
and vtmp_info_2359.getType().hasName("cdrom_timed_media_change_info")
and vcdi_2354.getType().hasName("cdrom_device_info *")
and vtmp_info_2359.(LocalVariable).getFunction() = func
and vcdi_2354.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
