/**
 * @name linux-b0a873ebbf87bf38bf70b5e39a7cadc96099fa13-perf_event_alloc
 * @id cpp/linux/b0a873ebbf87bf38bf70b5e39a7cadc96099fa13/perf-event-alloc
 * @description linux-b0a873ebbf87bf38bf70b5e39a7cadc96099fa13-kernel/perf_event.c-perf_event_alloc CVE-2013-2094
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpmu_5031, Variable vevent_5032, FunctionCall target_0) {
		target_0.getTarget().hasName("hw_perf_event_init")
		and not target_0.getTarget().hasName("perf_init_event")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
}

predicate func_1(Variable vpmu_5031, Variable vevent_5032, Parameter vattr_5023, Function func, SwitchStmt target_1) {
		target_1.getExpr().(PointerFieldAccess).getTarget().getName()="type"
		and target_1.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vattr_5023
		and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_1.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and target_1.getStmt().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_1.getStmt().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sw_perf_event_init")
		and target_1.getStmt().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_1.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_1.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("tp_perf_event_init")
		and target_1.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_1.getStmt().(BlockStmt).getStmt(12).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_1.getStmt().(BlockStmt).getStmt(12).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bp_perf_event_init")
		and target_1.getStmt().(BlockStmt).getStmt(12).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_1.getStmt().(BlockStmt).getStmt(14).(SwitchCase).toString() = "default: "
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

/*predicate func_5(PointerFieldAccess target_17, Function func, BreakStmt target_5) {
		target_5.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_5.getEnclosingFunction() = func
}

*/
/*predicate func_7(Variable vpmu_5031, Variable vevent_5032, PointerFieldAccess target_17, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sw_perf_event_init")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
}

*/
/*predicate func_8(PointerFieldAccess target_17, Function func, BreakStmt target_8) {
		target_8.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_10(Variable vpmu_5031, Variable vevent_5032, PointerFieldAccess target_17, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("tp_perf_event_init")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_10.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
}

*/
/*predicate func_11(PointerFieldAccess target_17, Function func, BreakStmt target_11) {
		target_11.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_13(Variable vpmu_5031, Variable vevent_5032, PointerFieldAccess target_17, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpmu_5031
		and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bp_perf_event_init")
		and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vevent_5032
		and target_13.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
}

*/
/*predicate func_14(PointerFieldAccess target_17, Function func, BreakStmt target_14) {
		target_14.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_15(Function func, SwitchCase target_15) {
		target_15.toString() = "default: "
		and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_16(PointerFieldAccess target_17, Function func, BreakStmt target_16) {
		target_16.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_17
		and target_16.getEnclosingFunction() = func
}

*/
predicate func_17(Parameter vattr_5023, PointerFieldAccess target_17) {
		target_17.getTarget().getName()="type"
		and target_17.getQualifier().(VariableAccess).getTarget()=vattr_5023
}

from Function func, Variable vpmu_5031, Variable vevent_5032, Parameter vattr_5023, FunctionCall target_0, SwitchStmt target_1, PointerFieldAccess target_17
where
func_0(vpmu_5031, vevent_5032, target_0)
and func_1(vpmu_5031, vevent_5032, vattr_5023, func, target_1)
and func_17(vattr_5023, target_17)
and vpmu_5031.getType().hasName("pmu *")
and vevent_5032.getType().hasName("perf_event *")
and vattr_5023.getType().hasName("perf_event_attr *")
and vpmu_5031.(LocalVariable).getFunction() = func
and vevent_5032.(LocalVariable).getFunction() = func
and vattr_5023.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
