commit bb04074866a59716ce7e78ec045f5a11eeab08df	bb04074866a59716ce7e78ec045f5a11eeab08df
Author: Devlin Cronin <rdevlin.cronin@chromium.org>
Date:   Tue Jun 6 20:24:19 2023 +0000

    [Extensions] Remove bad DCHECK in offscreen API
    
    Bug: 1450784
    Change-Id: I84f280200b31cb95a13fe3e14838707decb344a4
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4590681
    Reviewed-by: Tim <tjudkins@chromium.org>
    Commit-Queue: Devlin Cronin <rdevlin.cronin@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1154035}

diff --git a/chrome/browser/extensions/api/offscreen/offscreen_apitest.cc b/chrome/browser/extensions/api/offscreen/offscreen_apitest.cc
index 2325d388a0823..2ea7a92588272 100644
--- a/chrome/browser/extensions/api/offscreen/offscreen_apitest.cc
+++ b/chrome/browser/extensions/api/offscreen/offscreen_apitest.cc
@@ -431,6 +431,44 @@ IN_PROC_BROWSER_TEST_F(OffscreenApiTest, LifetimeEnforcement) {
   EXPECT_FALSE(manager->GetOffscreenDocumentForExtension(*extension));
 }
 
+// Tests opening and immediately closing an offscreen document (so that the
+// close happens before it's fully loaded). Regression test for
+// https://crbug.com/1450784.
+IN_PROC_BROWSER_TEST_F(OffscreenApiTest, OpenAndImmediatelyCloseDocument) {
+  static constexpr char kManifest[] =
+      R"({
+           "name": "Test",
+           "manifest_version": 3,
+           "version": "0.1",
+           "background": {"service_worker": "background.js"},
+           "permissions": ["offscreen"]
+         })";
+  static constexpr char kBackgroundJs[] =
+      R"(chrome.test.runTests([
+           async function openAndRapidlyClose() {
+             let openResult =
+                 chrome.offscreen.createDocument(
+                     {
+                       url: 'offscreen.html',
+                       reasons: ['TESTING'],
+                       justification: 'Testing'
+                     });
+             chrome.offscreen.closeDocument();
+             await chrome.test.assertPromiseRejects(
+                 openResult,
+                 'Error: Offscreen document closed before fully loading.');
+             chrome.test.succeed();
+           },
+         ]);)";
+
+  TestExtensionDir test_dir;
+  test_dir.WriteManifest(kManifest);
+  test_dir.WriteFile(FILE_PATH_LITERAL("background.js"), kBackgroundJs);
+  test_dir.WriteFile(FILE_PATH_LITERAL("offscreen.html"), "<html></html>");
+
+  ASSERT_TRUE(RunExtensionTest(test_dir.UnpackedPath(), {}, {})) << message_;
+}
+
 #if BUILDFLAG(IS_CHROMEOS_ASH)
 class GetAllScreensMediaOffscreenApiTest : public OffscreenApiTest {
  public:
diff --git a/extensions/browser/api/offscreen/offscreen_api.cc b/extensions/browser/api/offscreen/offscreen_api.cc
index 04225a45bb551..c4fdebaf55ee5 100644
--- a/extensions/browser/api/offscreen/offscreen_api.cc
+++ b/extensions/browser/api/offscreen/offscreen_api.cc
@@ -131,8 +131,7 @@ void OffscreenCreateDocumentFunction::OnExtensionHostDestroyed(
     ExtensionHost* host) {
   SendResponseToExtension(
       Error("Offscreen document closed before fully loading."));
-  // The host is destroyed, so ensure we're no longer observing it.
-  DCHECK(!host_observer_.IsObserving());
+  // WARNING: `this` can be deleted now!
 }
 
 void OffscreenCreateDocumentFunction::OnExtensionHostDidStopFirstLoad(
@@ -153,6 +152,7 @@ void OffscreenCreateDocumentFunction::SendResponseToExtension(
 
   Respond(std::move(response_value));
   Release();  // Balanced in Run().
+  // WARNING: `this` can be deleted now!
 }
 
 OffscreenCloseDocumentFunction::OffscreenCloseDocumentFunction() = default;
