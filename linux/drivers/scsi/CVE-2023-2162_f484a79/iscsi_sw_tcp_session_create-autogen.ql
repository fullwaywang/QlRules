/**
 * @name linux-f484a794e4ee2a9ce61f52a78e810ac45f3fe3b3-iscsi_sw_tcp_session_create
 * @id cpp/linux/f484a794e4ee2a9ce61f52a78e810ac45f3fe3b3/iscsi-sw-tcp-session-create
 * @description linux-f484a794e4ee2a9ce61f52a78e810ac45f3fe3b3-drivers/scsi/iscsi_tcp.c-iscsi_sw_tcp_session_create CVE-2023-2162
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsession_925, ExprStmt target_1, IfStmt target_0) {
	target_0.getCondition().(FunctionCall).getTarget().hasName("iscsi_tcp_r2tpool_alloc")
	and target_0.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsession_925
	and target_0.getThen().(GotoStmt).getName() ="remove_session"
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vsession_925, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="session"
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("iscsi_sw_tcp_host *")
	and target_1.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsession_925
}

from Function func, Variable vsession_925, IfStmt target_0, ExprStmt target_1
where
func_0(vsession_925, target_1, target_0)
and func_1(vsession_925, target_1)
and vsession_925.getType().hasName("iscsi_session *")
and vsession_925.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
