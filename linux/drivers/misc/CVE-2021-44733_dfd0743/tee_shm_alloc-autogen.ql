/**
 * @name linux-dfd0743f1d9ea76931510ed150334d571fbab49d-tee_shm_alloc
 * @id cpp/linux/dfd0743f1d9ea76931510ed150334d571fbab49d/tee-shm-alloc
 * @description linux-dfd0743f1d9ea76931510ed150334d571fbab49d-drivers/tee/tee_shm.c-tee_shm_alloc CVE-2021-44733
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vteedev_111, FunctionCall target_0) {
	target_0.getTarget().hasName("mutex_lock_nested")
	and not target_0.getTarget().hasName("refcount_set")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_0.getArgument(1).(Literal).getValue()="0"
}

predicate func_1(Variable vpoolm_112, Variable vshm_113, LabelStmt target_20, ExprStmt target_1) {
	target_1.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="free"
	and target_1.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
	and target_1.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpoolm_112
	and target_1.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vpoolm_112
	and target_1.getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vshm_113
	and target_20.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vshm_113, LabelStmt target_21, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vshm_113
	and target_21.getLocation().isBefore(target_2.getLocation())
}

predicate func_3(Variable vshm_113, ExprStmt target_10) {
exists(AddressOfExpr target_3 |
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_4(Variable vshm_113, VariableAccess target_4) {
	target_4.getTarget()=vshm_113
}

predicate func_6(BitwiseAndExpr target_22, Function func, DeclStmt target_6) {
	target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vexp_info_158, Variable vtee_shm_dma_buf_ops, AssignExpr target_7) {
	target_7.getLValue().(ValueFieldAccess).getTarget().getName()="ops"
	and target_7.getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_158
	and target_7.getRValue().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtee_shm_dma_buf_ops
}

predicate func_8(Variable vshm_113, Variable vexp_info_158, BitwiseAndExpr target_22, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="size"
	and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_158
	and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

predicate func_9(Variable vexp_info_158, BitwiseAndExpr target_22, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_158
	and target_9.getExpr().(AssignExpr).getRValue().(Literal).getValue()="2"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

predicate func_10(Variable vshm_113, Variable vexp_info_158, BitwiseAndExpr target_22, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="priv"
	and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_158
	and target_10.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vshm_113
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

predicate func_11(Variable vshm_113, Variable vexp_info_158, BitwiseAndExpr target_22, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_11.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dma_buf_export")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vexp_info_158
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

predicate func_12(Variable vshm_113, Variable vret_114, BitwiseAndExpr target_22, IfStmt target_12) {
	target_12.getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_12.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_12.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_114
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ERR_CAST")
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_12.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="err_rem"
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

/*predicate func_13(Variable vshm_113, Variable vret_114, FunctionCall target_23, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_114
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ERR_CAST")
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_13.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

*/
/*predicate func_14(FunctionCall target_23, Function func, GotoStmt target_14) {
	target_14.getName() ="err_rem"
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
	and target_14.getEnclosingFunction() = func
}

*/
predicate func_15(Parameter vflags_109, Variable vteedev_111, Variable vshm_113, Function func, IfStmt target_15) {
	target_15.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vflags_109
	and target_15.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2"
	and target_15.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("idr_remove")
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="idr"
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="id"
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_15.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_15.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_15.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

/*predicate func_16(BitwiseAndExpr target_24, Function func, ExprStmt target_16) {
	target_16.getExpr() instanceof FunctionCall
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
	and target_16.getEnclosingFunction() = func
}

*/
predicate func_17(Variable vteedev_111, AddressOfExpr target_25, AddressOfExpr target_26, PointerFieldAccess target_17) {
	target_17.getTarget().getName()="mutex"
	and target_17.getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_25.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getQualifier().(VariableAccess).getLocation())
	and target_17.getQualifier().(VariableAccess).getLocation().isBefore(target_26.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

/*predicate func_18(Variable vteedev_111, Variable vshm_113, BitwiseAndExpr target_24, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("idr_remove")
	and target_18.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="idr"
	and target_18.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_18.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="id"
	and target_18.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
}

*/
/*predicate func_19(Variable vteedev_111, BitwiseAndExpr target_24, AddressOfExpr target_26, ExprStmt target_27, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
	and target_26.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_27.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

*/
predicate func_20(Function func, LabelStmt target_20) {
	target_20.getName() ="err_pool_free"
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Function func, LabelStmt target_21) {
	target_21.getName() ="err_kfree"
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Parameter vflags_109, BlockStmt target_28, BitwiseAndExpr target_22) {
	target_22.getLeftOperand().(VariableAccess).getTarget()=vflags_109
	and target_22.getRightOperand().(BinaryBitwiseOperation).getValue()="2"
	and target_22.getParent().(IfStmt).getThen()=target_28
}

predicate func_23(Variable vshm_113, FunctionCall target_23) {
	target_23.getTarget().hasName("IS_ERR")
	and target_23.getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_23.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
}

predicate func_24(Parameter vflags_109, BlockStmt target_29, BitwiseAndExpr target_24) {
	target_24.getLeftOperand().(VariableAccess).getTarget()=vflags_109
	and target_24.getRightOperand() instanceof BinaryBitwiseOperation
	and target_24.getParent().(IfStmt).getThen()=target_29
}

predicate func_25(Variable vteedev_111, AddressOfExpr target_25) {
	target_25.getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_25.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_25.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
}

predicate func_26(Variable vteedev_111, AddressOfExpr target_26) {
	target_26.getOperand().(PointerFieldAccess).getTarget().getName()="idr"
	and target_26.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_26.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_27(Variable vteedev_111, ExprStmt target_27) {
	target_27.getExpr().(FunctionCall).getTarget().hasName("tee_device_put")
	and target_27.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vteedev_111
}

predicate func_28(Variable vteedev_111, Variable vshm_113, BlockStmt target_28) {
	target_28.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_28.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mutex"
	and target_28.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_28.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="id"
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_113
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("idr_alloc")
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="idr"
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_111
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vshm_113
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="1"
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_28.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(BitwiseOrExpr).getValue()="3264"
}

predicate func_29(Function func, BlockStmt target_29) {
	target_29.getStmt(0) instanceof ExprStmt
	and target_29.getStmt(1) instanceof ExprStmt
	and target_29.getStmt(2) instanceof ExprStmt
	and target_29.getEnclosingFunction() = func
}

from Function func, Parameter vflags_109, Variable vteedev_111, Variable vpoolm_112, Variable vshm_113, Variable vret_114, Variable vexp_info_158, Variable vtee_shm_dma_buf_ops, FunctionCall target_0, ExprStmt target_1, ExprStmt target_2, VariableAccess target_4, DeclStmt target_6, AssignExpr target_7, ExprStmt target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, IfStmt target_12, IfStmt target_15, PointerFieldAccess target_17, LabelStmt target_20, LabelStmt target_21, BitwiseAndExpr target_22, FunctionCall target_23, BitwiseAndExpr target_24, AddressOfExpr target_25, AddressOfExpr target_26, ExprStmt target_27, BlockStmt target_28, BlockStmt target_29
where
func_0(vteedev_111, target_0)
and func_1(vpoolm_112, vshm_113, target_20, target_1)
and func_2(vshm_113, target_21, target_2)
and not func_3(vshm_113, target_10)
and func_4(vshm_113, target_4)
and func_6(target_22, func, target_6)
and func_7(vexp_info_158, vtee_shm_dma_buf_ops, target_7)
and func_8(vshm_113, vexp_info_158, target_22, target_8)
and func_9(vexp_info_158, target_22, target_9)
and func_10(vshm_113, vexp_info_158, target_22, target_10)
and func_11(vshm_113, vexp_info_158, target_22, target_11)
and func_12(vshm_113, vret_114, target_22, target_12)
and func_15(vflags_109, vteedev_111, vshm_113, func, target_15)
and func_17(vteedev_111, target_25, target_26, target_17)
and func_20(func, target_20)
and func_21(func, target_21)
and func_22(vflags_109, target_28, target_22)
and func_23(vshm_113, target_23)
and func_24(vflags_109, target_29, target_24)
and func_25(vteedev_111, target_25)
and func_26(vteedev_111, target_26)
and func_27(vteedev_111, target_27)
and func_28(vteedev_111, vshm_113, target_28)
and func_29(func, target_29)
and vflags_109.getType().hasName("u32")
and vteedev_111.getType().hasName("tee_device *")
and vpoolm_112.getType().hasName("tee_shm_pool_mgr *")
and vshm_113.getType().hasName("tee_shm *")
and vret_114.getType().hasName("void *")
and vexp_info_158.getType().hasName("dma_buf_export_info")
and vtee_shm_dma_buf_ops.getType().hasName("const dma_buf_ops")
and vflags_109.getFunction() = func
and vteedev_111.(LocalVariable).getFunction() = func
and vpoolm_112.(LocalVariable).getFunction() = func
and vshm_113.(LocalVariable).getFunction() = func
and vret_114.(LocalVariable).getFunction() = func
and vexp_info_158.(LocalVariable).getFunction() = func
and not vtee_shm_dma_buf_ops.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
