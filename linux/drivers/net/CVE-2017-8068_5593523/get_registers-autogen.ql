/**
 * @name linux-5593523f968bc86d42a035c6df47d5e0979b5ace-get_registers
 * @id cpp/linux/5593523f968bc86d42a035c6df47d5e0979b5ace/get-registers
 * @description linux-5593523f968bc86d42a035c6df47d5e0979b5ace-drivers/net/usb/pegasus.c-get_registers CVE-2017-8068
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsize_127, ExprStmt target_9) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getType().hasName("u8 *")
	and target_0.getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_0.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsize_127
	and target_0.getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="20971520"
	and target_0.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(VariableAccess).getLocation()))
}

predicate func_1(DoStmt target_10, Function func) {
exists(NotExpr target_1 |
	target_1.getOperand().(VariableAccess).getType().hasName("u8 *")
	and target_1.getParent().(IfStmt).getThen()=target_10
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(RelationalOperation target_7, Function func) {
exists(ReturnStmt target_2 |
	target_2.getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_2.getParent().(IfStmt).getCondition()=target_7
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Variable vret_129, Parameter vindx_127, Parameter vsize_127, Parameter vpegasus_127, RelationalOperation target_7, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_129
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("usb_control_msg")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-2147483648"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(Literal).getValue()="128"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="240"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="192"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vindx_127
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getType().hasName("u8 *")
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(VariableAccess).getTarget()=vsize_127
	and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="1000"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof ReturnStmt
	and target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_5(Variable vret_129, Parameter vsize_127, Parameter vdata_127, Parameter vpegasus_127, ExprStmt target_12, ReturnStmt target_13, ExprStmt target_9, BitwiseOrExpr target_14, Function func) {
exists(IfStmt target_5 |
	target_5.getCondition() instanceof RelationalOperation
	and target_5.getThen().(DoStmt).getCondition() instanceof Literal
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="msg_enable"
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_5.getElse().(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vret_129
	and target_5.getElse().(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vsize_127
	and target_5.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memcpy")
	and target_5.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_127
	and target_5.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("u8 *")
	and target_5.getElse().(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vret_129
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt
	and target_12.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_5.getElse().(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
	and target_5.getElse().(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_13.getExpr().(VariableAccess).getLocation())
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(VariableAccess).getLocation().isBefore(target_5.getElse().(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation())
	and target_14.getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("u8 *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_7(Variable vret_129, DoStmt target_10, RelationalOperation target_7) {
	 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
	and target_7.getLesserOperand().(VariableAccess).getTarget()=vret_129
	and target_7.getGreaterOperand().(Literal).getValue()="0"
	and target_7.getParent().(IfStmt).getThen()=target_10
}

predicate func_8(Parameter vindx_127, Parameter vsize_127, Parameter vdata_127, Parameter vpegasus_127, VariableAccess target_8) {
	target_8.getTarget()=vdata_127
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("usb_control_msg")
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-2147483648"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(Literal).getValue()="128"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="240"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="192"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vindx_127
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(VariableAccess).getTarget()=vsize_127
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="1000"
}

predicate func_9(Variable vret_129, Parameter vindx_127, Parameter vsize_127, Parameter vdata_127, Parameter vpegasus_127, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_129
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("usb_control_msg")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-2147483648"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getRightOperand().(Literal).getValue()="128"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="240"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="192"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vindx_127
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vdata_127
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(VariableAccess).getTarget()=vsize_127
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(8).(Literal).getValue()="1000"
}

predicate func_10(Parameter vpegasus_127, DoStmt target_10) {
	target_10.getCondition() instanceof Literal
	and target_10.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="msg_enable"
	and target_10.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_10.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
}

predicate func_12(Variable vret_129, Parameter vpegasus_127, ExprStmt target_12) {
	target_12.getExpr().(FunctionCall).getTarget().hasName("__dynamic_netdev_dbg")
	and target_12.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("_ddebug")
	and target_12.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="net"
	and target_12.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_12.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%s returned %d\n"
	and target_12.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_12.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vret_129
}

predicate func_13(Variable vret_129, ReturnStmt target_13) {
	target_13.getExpr().(VariableAccess).getTarget()=vret_129
}

predicate func_14(Parameter vpegasus_127, BitwiseOrExpr target_14) {
	target_14.getLeftOperand().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="-2147483648"
	and target_14.getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("__create_pipe")
	and target_14.getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="usb"
	and target_14.getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpegasus_127
	and target_14.getLeftOperand().(BitwiseOrExpr).getRightOperand().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_14.getRightOperand().(Literal).getValue()="128"
}

from Function func, Variable vret_129, Parameter vindx_127, Parameter vsize_127, Parameter vdata_127, Parameter vpegasus_127, RelationalOperation target_7, VariableAccess target_8, ExprStmt target_9, DoStmt target_10, ExprStmt target_12, ReturnStmt target_13, BitwiseOrExpr target_14
where
not func_0(vsize_127, target_9)
and not func_1(target_10, func)
and not func_2(target_7, func)
and not func_3(vret_129, vindx_127, vsize_127, vpegasus_127, target_7, func)
and not func_5(vret_129, vsize_127, vdata_127, vpegasus_127, target_12, target_13, target_9, target_14, func)
and not func_6(func)
and func_7(vret_129, target_10, target_7)
and func_8(vindx_127, vsize_127, vdata_127, vpegasus_127, target_8)
and func_9(vret_129, vindx_127, vsize_127, vdata_127, vpegasus_127, target_9)
and func_10(vpegasus_127, target_10)
and func_12(vret_129, vpegasus_127, target_12)
and func_13(vret_129, target_13)
and func_14(vpegasus_127, target_14)
and vret_129.getType().hasName("int")
and vindx_127.getType().hasName("__u16")
and vsize_127.getType().hasName("__u16")
and vdata_127.getType().hasName("void *")
and vpegasus_127.getType().hasName("pegasus_t *")
and vret_129.(LocalVariable).getFunction() = func
and vindx_127.getFunction() = func
and vsize_127.getFunction() = func
and vdata_127.getFunction() = func
and vpegasus_127.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
