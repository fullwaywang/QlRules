/**
 * @name linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-check_helper_call
 * @id cpp/linux/c25b2ae136039ffa820c26138ed4a5e5f3ab3841/check-helper-call
 * @description linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-kernel/bpf/verifier.c-check_helper_call CVE-2022-23222
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vregs_6477, ExprStmt target_31, FunctionCall target_0) {
	target_0.getTarget().hasName("reg_type_may_be_null")
	and not target_0.getTarget().hasName("type_may_be_null")
	and target_0.getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
	and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_0.getParent().(IfStmt).getThen()=target_31
}

predicate func_8(Variable vfn_6475, ExprStmt target_32, ExprStmt target_33) {
exists(AssignExpr target_8 |
	target_8.getLValue().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_8.getRValue().(FunctionCall).getTarget().hasName("type_flag")
	and target_8.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ret_type"
	and target_8.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfn_6475
	and target_32.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_8.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_33.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_9(Variable vregs_6477) {
exists(BitwiseOrExpr target_9 |
	target_9.getLeftOperand() instanceof EnumConstantAccess
	and target_9.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_9.getParent().(AssignExpr).getRValue() = target_9
	and target_9.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_9.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_10(BlockStmt target_34, Function func) {
exists(LogicalAndExpr target_10 |
	target_10.getLeftOperand().(NotExpr).getOperand() instanceof FunctionCall
	and target_10.getRightOperand() instanceof FunctionCall
	and target_10.getParent().(IfStmt).getThen()=target_34
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(Parameter venv_6472, ExprStmt target_35) {
exists(AssignExpr target_11 |
	target_11.getLValue().(ValueFieldAccess).getTarget().getName()="id"
	and target_11.getLValue().(ValueFieldAccess).getQualifier() instanceof ArrayExpr
	and target_11.getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id_gen"
	and target_11.getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_6472
	and target_11.getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_35.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_12(Variable vregs_6477) {
exists(BitwiseOrExpr target_12 |
	target_12.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_12.getParent().(AssignExpr).getRValue() = target_12
	and target_12.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_12.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_13(Variable vregs_6477) {
exists(BitwiseOrExpr target_13 |
	target_13.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_13.getParent().(AssignExpr).getRValue() = target_13
	and target_13.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_13.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_14(Variable vregs_6477) {
exists(BitwiseOrExpr target_14 |
	target_14.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_14.getParent().(AssignExpr).getRValue() = target_14
	and target_14.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_14.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_15(Variable vregs_6477) {
exists(BitwiseOrExpr target_15 |
	target_15.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_15.getParent().(AssignExpr).getRValue() = target_15
	and target_15.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_15.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_16(Variable vregs_6477) {
exists(BitwiseOrExpr target_16 |
	target_16.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_16.getParent().(AssignExpr).getRValue() = target_16
	and target_16.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_16.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_17(Variable vregs_6477) {
exists(BitwiseOrExpr target_17 |
	target_17.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_17.getParent().(AssignExpr).getRValue() = target_17
	and target_17.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_17.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

predicate func_18(Variable vregs_6477) {
exists(BitwiseOrExpr target_18 |
	target_18.getRightOperand().(VariableAccess).getType().hasName("bpf_type_flag")
	and target_18.getParent().(AssignExpr).getRValue() = target_18
	and target_18.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_18.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477)
}

/*predicate func_19(Parameter venv_6472, Variable vregs_6477, AssignExpr target_19) {
	target_19.getLValue().(ValueFieldAccess).getTarget().getName()="id"
	and target_19.getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_19.getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id_gen"
	and target_19.getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_6472
}

*/
predicate func_20(Variable vregs_6477, Variable vmeta_6478, NotExpr target_36, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="btf"
	and target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_20.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="ret_btf"
	and target_20.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vmeta_6478
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_36
}

predicate func_21(Variable vregs_6477, Variable vmeta_6478, NotExpr target_36, ExprStmt target_21) {
	target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="btf_id"
	and target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_21.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_21.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="ret_btf_id"
	and target_21.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vmeta_6478
	and target_21.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_36
}

predicate func_22(Variable vret_type_6476, BlockStmt target_34, FunctionCall target_22) {
	target_22.getTarget().hasName("type_may_be_null")
	and target_22.getArgument(0).(VariableAccess).getTarget()=vret_type_6476
	and target_22.getParent().(IfStmt).getThen()=target_34
}

predicate func_23(Variable vmeta_6478, ExprStmt target_24, FunctionCall target_23) {
	target_23.getTarget().hasName("map_value_has_spin_lock")
	and target_23.getArgument(0).(ValueFieldAccess).getTarget().getName()="map_ptr"
	and target_23.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vmeta_6478
	and target_23.getParent().(IfStmt).getThen()=target_24
}

predicate func_24(Parameter venv_6472, Variable vregs_6477, FunctionCall target_23, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="id"
	and target_24.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_24.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id_gen"
	and target_24.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_6472
	and target_24.getParent().(IfStmt).getCondition()=target_23
}

predicate func_25(Variable vregs_6477, ArrayExpr target_25) {
	target_25.getArrayBase().(VariableAccess).getTarget()=vregs_6477
}

predicate func_27(FunctionCall target_22, Function func, IfStmt target_27) {
	target_27.getCondition() instanceof FunctionCall
	and target_27.getThen() instanceof ExprStmt
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_27.getEnclosingFunction() = func
}

predicate func_28(Variable vret_type_6476, Variable vregs_6477, ConditionalExpr target_28) {
	target_28.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vret_type_6476
	and target_28.getCondition().(BitwiseAndExpr).getRightOperand() instanceof EnumConstantAccess
	and target_28.getThen() instanceof EnumConstantAccess
	and target_28.getParent().(AssignExpr).getRValue() = target_28
	and target_28.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_28.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
}

predicate func_29(Variable vret_type_6476, Variable vregs_6477, EqualityOperation target_38, ExprStmt target_39, ExprStmt target_20, ConditionalExpr target_29) {
	target_29.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vret_type_6476
	and target_29.getParent().(AssignExpr).getRValue() = target_29
	and target_29.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_29.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_29.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_38.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_39.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_29.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
	and target_29.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
}

predicate func_30(Variable vret_type_6476, AssignExpr target_30) {
	target_30.getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_30.getLValue().(ValueFieldAccess).getQualifier() instanceof ArrayExpr
	and target_30.getRValue().(ConditionalExpr).getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vret_type_6476
}

predicate func_31(Parameter venv_6472, Variable vregs_6477, ExprStmt target_31) {
	target_31.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="id"
	and target_31.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_31.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id_gen"
	and target_31.getExpr().(AssignExpr).getRValue().(PrefixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=venv_6472
}

predicate func_32(Variable vfn_6475, Variable vret_type_6476, ExprStmt target_32) {
	target_32.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_type_6476
	and target_32.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="ret_type"
	and target_32.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfn_6475
}

predicate func_33(Variable vfn_6475, ExprStmt target_33) {
	target_33.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_33.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ret_btf_id"
	and target_33.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfn_6475
}

predicate func_34(Variable vregs_6477, BlockStmt target_34) {
	target_34.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="type"
	and target_34.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_34.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof EnumConstantAccess
}

predicate func_35(Parameter venv_6472, Variable vregs_6477, EqualityOperation target_40, ExprStmt target_35) {
	target_35.getExpr().(FunctionCall).getTarget().hasName("mark_reg_known_zero")
	and target_35.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=venv_6472
	and target_35.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vregs_6477
	and target_35.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_40
}

predicate func_36(Function func, NotExpr target_36) {
	target_36.getOperand().(FunctionCall).getTarget().hasName("btf_type_is_struct")
	and target_36.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("const btf_type *")
	and target_36.getEnclosingFunction() = func
}

predicate func_38(Variable vret_type_6476, EqualityOperation target_38) {
	target_38.getLeftOperand().(FunctionCall).getTarget().hasName("base_type")
	and target_38.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vret_type_6476
}

predicate func_39(Variable vregs_6477, ExprStmt target_39) {
	target_39.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mem_size"
	and target_39.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_39.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vregs_6477
	and target_39.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("u32")
}

predicate func_40(Variable vret_type_6476, EqualityOperation target_40) {
	target_40.getLeftOperand().(FunctionCall).getTarget().hasName("base_type")
	and target_40.getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vret_type_6476
}

from Function func, Parameter venv_6472, Variable vfn_6475, Variable vret_type_6476, Variable vregs_6477, Variable vmeta_6478, FunctionCall target_0, ExprStmt target_20, ExprStmt target_21, FunctionCall target_22, FunctionCall target_23, ExprStmt target_24, ArrayExpr target_25, IfStmt target_27, ConditionalExpr target_28, ConditionalExpr target_29, AssignExpr target_30, ExprStmt target_31, ExprStmt target_32, ExprStmt target_33, BlockStmt target_34, ExprStmt target_35, NotExpr target_36, EqualityOperation target_38, ExprStmt target_39, EqualityOperation target_40
where
func_0(vregs_6477, target_31, target_0)
and not func_8(vfn_6475, target_32, target_33)
and not func_9(vregs_6477)
and not func_10(target_34, func)
and not func_11(venv_6472, target_35)
and not func_12(vregs_6477)
and not func_13(vregs_6477)
and not func_14(vregs_6477)
and not func_15(vregs_6477)
and not func_16(vregs_6477)
and not func_17(vregs_6477)
and not func_18(vregs_6477)
and func_20(vregs_6477, vmeta_6478, target_36, target_20)
and func_21(vregs_6477, vmeta_6478, target_36, target_21)
and func_22(vret_type_6476, target_34, target_22)
and func_23(vmeta_6478, target_24, target_23)
and func_24(venv_6472, vregs_6477, target_23, target_24)
and func_25(vregs_6477, target_25)
and func_27(target_22, func, target_27)
and func_28(vret_type_6476, vregs_6477, target_28)
and func_29(vret_type_6476, vregs_6477, target_38, target_39, target_20, target_29)
and func_30(vret_type_6476, target_30)
and func_31(venv_6472, vregs_6477, target_31)
and func_32(vfn_6475, vret_type_6476, target_32)
and func_33(vfn_6475, target_33)
and func_34(vregs_6477, target_34)
and func_35(venv_6472, vregs_6477, target_40, target_35)
and func_36(func, target_36)
and func_38(vret_type_6476, target_38)
and func_39(vregs_6477, target_39)
and func_40(vret_type_6476, target_40)
and venv_6472.getType().hasName("bpf_verifier_env *")
and vfn_6475.getType().hasName("const bpf_func_proto *")
and vret_type_6476.getType().hasName("bpf_return_type")
and vregs_6477.getType().hasName("bpf_reg_state *")
and vmeta_6478.getType().hasName("bpf_call_arg_meta")
and venv_6472.getFunction() = func
and vfn_6475.(LocalVariable).getFunction() = func
and vret_type_6476.(LocalVariable).getFunction() = func
and vregs_6477.(LocalVariable).getFunction() = func
and vmeta_6478.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
