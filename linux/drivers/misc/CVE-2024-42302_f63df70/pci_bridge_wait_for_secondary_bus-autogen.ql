/**
 * @name linux-f63df70b439bb8331358a306541893bf415bf1da-pci_bridge_wait_for_secondary_bus
 * @id cpp/linux/f63df70b439bb8331358a306541893bf415bf1da/pci-bridge-wait-for-secondary-bus
 * @description linux-f63df70b439bb8331358a306541893bf415bf1da-drivers/pci/pci.c-pci_bridge_wait_for_secondary_bus CVE-2024-42302
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(Initializer target_0 |
	target_0.getExpr().(Literal).getValue()="0"
	and target_0.getExpr().getEnclosingFunction() = func
)
}

predicate func_1(Function func) {
exists(FunctionCall target_1 |
	exists(AssignExpr obj_0 | obj_0=target_1.getParent() |
		obj_0.getRValue() = target_1
		and obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("pci_dev *")
	)
	and target_1.getTarget().hasName("pci_dev_get")
	and target_1.getArgument(0) instanceof StmtExpr
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(Variable v__mptr_5039, StmtExpr target_2) {
	exists(BlockStmt obj_0 | obj_0=target_2.getStmt() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(PointerArithmeticOperation obj_2 | obj_2=obj_1.getExpr() |
				obj_2.getLeftOperand().(VariableAccess).getTarget()=v__mptr_5039
				and obj_2.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
			)
		)
	)
	and exists(AssignExpr obj_3 | obj_3=target_2.getParent() |
		obj_3.getRValue() = target_2
		and obj_3.getLValue().(VariableAccess).getTarget().getType().hasName("pci_dev *")
	)
}

from Function func, Variable v__mptr_5039, StmtExpr target_2
where
not func_0(func)
and not func_1(func)
and func_2(v__mptr_5039, target_2)
and v__mptr_5039.getType().hasName("void *")
and v__mptr_5039.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
