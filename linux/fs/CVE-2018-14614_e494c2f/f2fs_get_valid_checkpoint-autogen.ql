/**
 * @name linux-e494c2f995d6181d6e29c4927d68e0f295ecf75b-f2fs_get_valid_checkpoint
 * @id cpp/linux/e494c2f995d6181d6e29c4927d68e0f295ecf75b/f2fs-get-valid-checkpoint
 * @description linux-e494c2f995d6181d6e29c4927d68e0f295ecf75b-fs/f2fs/checkpoint.c-f2fs_get_valid_checkpoint CVE-2018-14614
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsbi_839, Variable vcp1_843, Variable vcur_page_843, IfStmt target_1, IfStmt target_0) {
	target_0.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vcur_page_843
	and target_0.getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vcp1_843
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cur_cp_pack"
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_839
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_0.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cur_cp_pack"
	and target_0.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbi_839
	and target_0.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="2"
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Parameter vsbi_839, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("f2fs_sanity_check_ckpt")
	and target_1.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsbi_839
	and target_1.getThen().(GotoStmt).getName() ="free_fail_no_cp"
}

from Function func, Parameter vsbi_839, Variable vcp1_843, Variable vcur_page_843, IfStmt target_0, IfStmt target_1
where
func_0(vsbi_839, vcp1_843, vcur_page_843, target_1, target_0)
and func_1(vsbi_839, target_1)
and vsbi_839.getType().hasName("f2fs_sb_info *")
and vcp1_843.getType().hasName("page *")
and vcur_page_843.getType().hasName("page *")
and vsbi_839.getFunction() = func
and vcp1_843.(LocalVariable).getFunction() = func
and vcur_page_843.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
