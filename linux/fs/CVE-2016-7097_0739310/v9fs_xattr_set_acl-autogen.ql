/**
 * @name linux-073931017b49d9458aa351605b43a7e34598caef-v9fs_xattr_set_acl
 * @id cpp/linux/073931017b49d9458aa351605b43a7e34598caef/v9fs-xattr-set-acl
 * @description linux-073931017b49d9458aa351605b43a7e34598caef-fs/9p/acl.c-v9fs_xattr_set_acl CVE-2016-7097
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vretval_246, Variable vacl_247, Variable vmode_279, FunctionCall target_0) {
	target_0.getTarget().hasName("posix_acl_equiv_mode")
	and not target_0.getTarget().hasName("posix_acl_update_mode")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vacl_247
	and target_0.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vmode_279
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_246
}

predicate func_1(Variable vacl_247, ExprStmt target_19) {
exists(AddressOfExpr target_1 |
	target_1.getOperand().(VariableAccess).getTarget()=vacl_247
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_1.getOperand().(VariableAccess).getLocation().isBefore(target_19.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(VariableAccess).getLocation()))
}

predicate func_2(Variable vacl_247, BlockStmt target_20) {
exists(NotExpr target_2 |
	target_2.getOperand().(VariableAccess).getTarget()=vacl_247
	and target_2.getParent().(IfStmt).getThen()=target_20)
}

predicate func_3(Parameter vvalue_243, EqualityOperation target_16, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvalue_243
	and target_3.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_4(Parameter vsize_244, EqualityOperation target_16, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsize_244
	and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_5(Variable viattr_284, RelationalOperation target_15, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ia_valid"
	and target_5.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=viattr_284
	and target_5.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getValue()="1"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_6(Parameter vdentry_242, Variable viattr_284, RelationalOperation target_15, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("v9fs_vfs_setattr_dotl")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdentry_242
	and target_6.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=viattr_284
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_7(RelationalOperation target_15, Function func, DeclStmt target_7) {
	target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Variable viattr_284, ValueFieldAccess target_8) {
	target_8.getTarget().getName()="ia_mode"
	and target_8.getQualifier().(VariableAccess).getTarget()=viattr_284
}

predicate func_9(Parameter vinode_242, VariableAccess target_9) {
	target_9.getTarget()=vinode_242
}

predicate func_10(Variable vacl_247, VariableAccess target_10) {
	target_10.getTarget()=vacl_247
	and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_11(Variable vretval_246, VariableAccess target_11) {
	target_11.getTarget()=vretval_246
	and target_11.getParent().(LTExpr).getGreaterOperand() instanceof Literal
	and target_11.getParent().(LTExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_12(Variable vacl_247, VariableAccess target_12) {
	target_12.getTarget()=vacl_247
	and target_12.getParent().(AssignExpr).getLValue() = target_12
	and target_12.getParent().(AssignExpr).getRValue() instanceof Literal
}

predicate func_13(VariableAccess target_21, Function func, DeclStmt target_13) {
	target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Variable vmode_279, VariableAccess target_14) {
	target_14.getTarget()=vmode_279
	and target_14.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_15(Variable vretval_246, RelationalOperation target_15) {
	 (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
	and target_15.getLesserOperand().(VariableAccess).getTarget()=vretval_246
	and target_15.getGreaterOperand().(Literal).getValue()="0"
	and target_15.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_16(Variable vretval_246, BlockStmt target_20, EqualityOperation target_16) {
	target_16.getLeftOperand().(VariableAccess).getTarget()=vretval_246
	and target_16.getRightOperand().(Literal).getValue()="0"
	and target_16.getParent().(IfStmt).getThen()=target_20
}

predicate func_17(Variable vacl_247, EqualityOperation target_16, ExprStmt target_19, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vacl_247
	and target_17.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
	and target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_19.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(VariableAccess).getLocation())
}

predicate func_18(Parameter vinode_242, Variable vmode_279, RelationalOperation target_15, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_18.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vmode_279
	and target_18.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="4095"
	and target_18.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
	and target_18.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_242
	and target_18.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="-4096"
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_19(Variable vretval_246, Variable vacl_247, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_246
	and target_19.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(VariableAccess).getTarget()=vacl_247
	and target_19.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(UnaryMinusExpr).getValue()="-22"
	and target_19.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

predicate func_20(Function func, BlockStmt target_20) {
	target_20.getStmt(0) instanceof ExprStmt
	and target_20.getStmt(1) instanceof ExprStmt
	and target_20.getStmt(2) instanceof ExprStmt
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Variable vacl_247, BlockStmt target_22, VariableAccess target_21) {
	target_21.getTarget()=vacl_247
	and target_21.getParent().(IfStmt).getThen()=target_22
}

predicate func_22(Variable vretval_246, BlockStmt target_22) {
	target_22.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_246
	and target_22.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_22.getStmt(2).(IfStmt).getCondition() instanceof RelationalOperation
	and target_22.getStmt(2).(IfStmt).getThen().(GotoStmt).getName() ="err_out"
	and target_22.getStmt(2).(IfStmt).getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition() instanceof EqualityOperation
	and target_22.getStmt(2).(IfStmt).getElse().(BlockStmt).getStmt(1).(IfStmt).getThen() instanceof BlockStmt
	and target_22.getStmt(2).(IfStmt).getElse().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_22.getStmt(2).(IfStmt).getElse().(BlockStmt).getStmt(3) instanceof ExprStmt
	and target_22.getStmt(2).(IfStmt).getElse().(BlockStmt).getStmt(4) instanceof ExprStmt
}

from Function func, Parameter vdentry_242, Parameter vinode_242, Parameter vvalue_243, Parameter vsize_244, Variable vretval_246, Variable vacl_247, Variable vmode_279, Variable viattr_284, FunctionCall target_0, ExprStmt target_3, ExprStmt target_4, ExprStmt target_5, ExprStmt target_6, DeclStmt target_7, ValueFieldAccess target_8, VariableAccess target_9, VariableAccess target_10, VariableAccess target_11, VariableAccess target_12, DeclStmt target_13, VariableAccess target_14, RelationalOperation target_15, EqualityOperation target_16, ExprStmt target_17, ExprStmt target_18, ExprStmt target_19, BlockStmt target_20, VariableAccess target_21, BlockStmt target_22
where
func_0(vretval_246, vacl_247, vmode_279, target_0)
and not func_1(vacl_247, target_19)
and not func_2(vacl_247, target_20)
and func_3(vvalue_243, target_16, target_3)
and func_4(vsize_244, target_16, target_4)
and func_5(viattr_284, target_15, target_5)
and func_6(vdentry_242, viattr_284, target_15, target_6)
and func_7(target_15, func, target_7)
and func_8(viattr_284, target_8)
and func_9(vinode_242, target_9)
and func_10(vacl_247, target_10)
and func_11(vretval_246, target_11)
and func_12(vacl_247, target_12)
and func_13(target_21, func, target_13)
and func_14(vmode_279, target_14)
and func_15(vretval_246, target_15)
and func_16(vretval_246, target_20, target_16)
and func_17(vacl_247, target_16, target_19, target_17)
and func_18(vinode_242, vmode_279, target_15, target_18)
and func_19(vretval_246, vacl_247, target_19)
and func_20(func, target_20)
and func_21(vacl_247, target_22, target_21)
and func_22(vretval_246, target_22)
and vdentry_242.getType().hasName("dentry *")
and vinode_242.getType().hasName("inode *")
and vvalue_243.getType().hasName("const void *")
and vsize_244.getType().hasName("size_t")
and vretval_246.getType().hasName("int")
and vacl_247.getType().hasName("posix_acl *")
and vmode_279.getType().hasName("umode_t")
and viattr_284.getType().hasName("iattr")
and vdentry_242.getFunction() = func
and vinode_242.getFunction() = func
and vvalue_243.getFunction() = func
and vsize_244.getFunction() = func
and vretval_246.(LocalVariable).getFunction() = func
and vacl_247.(LocalVariable).getFunction() = func
and vmode_279.(LocalVariable).getFunction() = func
and viattr_284.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
