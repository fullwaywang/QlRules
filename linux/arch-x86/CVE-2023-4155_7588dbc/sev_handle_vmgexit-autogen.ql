/**
 * @name linux-7588dbcebcbf0193ab5b76987396d0254270b04a-sev_handle_vmgexit
 * @id cpp/linux/7588dbcebcbf0193ab5b76987396d0254270b04a/sev-handle-vmgexit
 * @description linux-7588dbcebcbf0193ab5b76987396d0254270b04a-arch/x86/kvm/svm/sev.c-sev_handle_vmgexit CVE-2023-4155
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vexit_code_2825, Variable vghcb_2826, FunctionCall target_0) {
	target_0.getTarget().hasName("ghcb_get_sw_exit_code")
	and not target_0.getTarget().hasName("kvm_ghcb_get_sw_exit_code")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vghcb_2826
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vexit_code_2825
}

predicate func_1(Variable vexit_code_2825, ExprStmt target_3, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vexit_code_2825
	and target_1.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_1.getLocation().isBefore(target_3.getLocation())
}

predicate func_3(Function func, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("sev_es_sync_from_ghcb")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("vcpu_svm *")
	and target_3.getEnclosingFunction() = func
}

from Function func, Variable vexit_code_2825, Variable vghcb_2826, FunctionCall target_0, ExprStmt target_1, ExprStmt target_3
where
func_0(vexit_code_2825, vghcb_2826, target_0)
and func_1(vexit_code_2825, target_3, target_1)
and func_3(func, target_3)
and vexit_code_2825.getType().hasName("u64")
and vghcb_2826.getType().hasName("ghcb *")
and vexit_code_2825.(LocalVariable).getFunction() = func
and vghcb_2826.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
