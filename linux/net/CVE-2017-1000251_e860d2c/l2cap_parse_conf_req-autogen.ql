/**
 * @name linux-e860d2c904d1a9f38a24eb44c9f34b8f915a6ea3-l2cap_parse_conf_req
 * @id cpp/linux/e860d2c904d1a9f38a24eb44c9f34b8f915a6ea3/l2cap-parse-conf-req
 * @description linux-e860d2c904d1a9f38a24eb44c9f34b8f915a6ea3-net/bluetooth/l2cap_core.c-l2cap_parse_conf_req CVE-2017-1000251
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_8, AddressOfExpr target_9) {
	exists(PointerArithmeticOperation target_0 |
		target_0.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_0.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
		and target_8.getOperand().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(VariableAccess).getLocation())
		and target_0.getRightOperand().(VariableAccess).getLocation().isBefore(target_9.getOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vchan_3315, Variable vptr_3318, AddressOfExpr target_9, AddressOfExpr target_10) {
	exists(PointerArithmeticOperation target_1 |
		target_1.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_1.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="2"
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="omtu"
		and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchan_3315
		and target_9.getOperand().(VariableAccess).getLocation().isBefore(target_1.getRightOperand().(VariableAccess).getLocation())
		and target_1.getRightOperand().(VariableAccess).getLocation().isBefore(target_10.getOperand().(VariableAccess).getLocation()))
}

predicate func_2(Variable vptr_3318, AddressOfExpr target_10, AddressOfExpr target_11) {
	exists(PointerArithmeticOperation target_2 |
		target_2.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_2.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="6"
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="16"
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("l2cap_conf_efs")
		and target_10.getOperand().(VariableAccess).getLocation().isBefore(target_2.getRightOperand().(VariableAccess).getLocation())
		and target_2.getRightOperand().(VariableAccess).getLocation().isBefore(target_11.getOperand().(VariableAccess).getLocation()))
}

predicate func_3(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_11, AddressOfExpr target_12) {
	exists(PointerArithmeticOperation target_3 |
		target_3.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_3.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
		and target_11.getOperand().(VariableAccess).getLocation().isBefore(target_3.getRightOperand().(VariableAccess).getLocation())
		and target_3.getRightOperand().(VariableAccess).getLocation().isBefore(target_12.getOperand().(VariableAccess).getLocation()))
}

predicate func_4(Variable vptr_3318, AddressOfExpr target_12, AddressOfExpr target_13) {
	exists(PointerArithmeticOperation target_4 |
		target_4.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_4.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="6"
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="16"
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("l2cap_conf_efs")
		and target_12.getOperand().(VariableAccess).getLocation().isBefore(target_4.getRightOperand().(VariableAccess).getLocation())
		and target_4.getRightOperand().(VariableAccess).getLocation().isBefore(target_13.getOperand().(VariableAccess).getLocation()))
}

predicate func_5(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_13, PointerArithmeticOperation target_14) {
	exists(PointerArithmeticOperation target_5 |
		target_5.getLeftOperand().(VariableAccess).getType().hasName("void *")
		and target_5.getRightOperand().(VariableAccess).getTarget()=vptr_3318
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
		and target_13.getOperand().(VariableAccess).getLocation().isBefore(target_5.getRightOperand().(VariableAccess).getLocation())
		and target_5.getRightOperand().(VariableAccess).getLocation().isBefore(target_14.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_6(Variable vresult_3327, BlockStmt target_15, EqualityOperation target_6) {
		target_6.getAnOperand().(VariableAccess).getTarget()=vresult_3327
		and target_6.getAnOperand().(Literal).getValue()="0"
		and target_6.getParent().(IfStmt).getThen()=target_15
}

predicate func_7(Parameter vchan_3315, Variable vrfc_3323, BlockStmt target_16, EqualityOperation target_7) {
		target_7.getAnOperand().(PointerFieldAccess).getTarget().getName()="mode"
		and target_7.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchan_3315
		and target_7.getAnOperand().(ValueFieldAccess).getTarget().getName()="mode"
		and target_7.getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrfc_3323
		and target_7.getParent().(IfStmt).getThen()=target_16
}

predicate func_8(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_8) {
		target_8.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
}

predicate func_9(Parameter vchan_3315, Variable vptr_3318, AddressOfExpr target_9) {
		target_9.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="2"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="omtu"
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchan_3315
}

predicate func_10(Variable vptr_3318, AddressOfExpr target_10) {
		target_10.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="6"
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="16"
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("l2cap_conf_efs")
}

predicate func_11(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_11) {
		target_11.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
}

predicate func_12(Variable vptr_3318, AddressOfExpr target_12) {
		target_12.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="6"
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="16"
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("l2cap_conf_efs")
}

predicate func_13(Variable vptr_3318, Variable vrfc_3323, AddressOfExpr target_13) {
		target_13.getOperand().(VariableAccess).getTarget()=vptr_3318
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("l2cap_add_conf_opt")
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="4"
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="9"
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrfc_3323
}

predicate func_14(Variable vptr_3318, PointerArithmeticOperation target_14) {
		target_14.getLeftOperand().(VariableAccess).getTarget()=vptr_3318
		and target_14.getRightOperand().(VariableAccess).getTarget().getType().hasName("void *")
}

predicate func_15(Parameter vchan_3315, Variable vresult_3327, BlockStmt target_15) {
		target_15.getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("u16")
		and target_15.getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="48"
		and target_15.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3327
		and target_15.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_15.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="omtu"
		and target_15.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchan_3315
		and target_15.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("u16")
		and target_15.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_bit")
		and target_15.getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="conf_state"
}

predicate func_16(Parameter vchan_3315, Variable vrfc_3323, Variable vresult_3327, BlockStmt target_16) {
		target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_3327
		and target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mode"
		and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrfc_3323
		and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mode"
		and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchan_3315
}

from Function func, Parameter vchan_3315, Variable vptr_3318, Variable vrfc_3323, Variable vresult_3327, EqualityOperation target_6, EqualityOperation target_7, AddressOfExpr target_8, AddressOfExpr target_9, AddressOfExpr target_10, AddressOfExpr target_11, AddressOfExpr target_12, AddressOfExpr target_13, PointerArithmeticOperation target_14, BlockStmt target_15, BlockStmt target_16
where
not func_0(vptr_3318, vrfc_3323, target_8, target_9)
and not func_1(vchan_3315, vptr_3318, target_9, target_10)
and not func_2(vptr_3318, target_10, target_11)
and not func_3(vptr_3318, vrfc_3323, target_11, target_12)
and not func_4(vptr_3318, target_12, target_13)
and not func_5(vptr_3318, vrfc_3323, target_13, target_14)
and func_6(vresult_3327, target_15, target_6)
and func_7(vchan_3315, vrfc_3323, target_16, target_7)
and func_8(vptr_3318, vrfc_3323, target_8)
and func_9(vchan_3315, vptr_3318, target_9)
and func_10(vptr_3318, target_10)
and func_11(vptr_3318, vrfc_3323, target_11)
and func_12(vptr_3318, target_12)
and func_13(vptr_3318, vrfc_3323, target_13)
and func_14(vptr_3318, target_14)
and func_15(vchan_3315, vresult_3327, target_15)
and func_16(vchan_3315, vrfc_3323, vresult_3327, target_16)
and vchan_3315.getType().hasName("l2cap_chan *")
and vptr_3318.getType().hasName("void *")
and vrfc_3323.getType().hasName("l2cap_conf_rfc")
and vresult_3327.getType().hasName("u16")
and vchan_3315.getFunction() = func
and vptr_3318.(LocalVariable).getFunction() = func
and vrfc_3323.(LocalVariable).getFunction() = func
and vresult_3327.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
