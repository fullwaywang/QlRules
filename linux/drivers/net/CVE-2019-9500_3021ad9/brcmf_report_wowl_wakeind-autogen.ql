/**
 * @name linux-3021ad9a4f009265e6063e617fb91306980af16c-brcmf_report_wowl_wakeind
 * @id cpp/linux/3021ad9a4f009265e6063e617fb91306980af16c/brcmf-report-wowl-wakeind
 * @description linux-3021ad9a4f009265e6063e617fb91306980af16c-drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c-brcmf_report_wowl_wakeind CVE-2019-9500
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vwakeind_3126, BlockStmt target_5) {
	exists(BitwiseOrExpr target_0 |
		target_0.getValue()="67108895"
		and target_0.getParent().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwakeind_3126
		and target_0.getParent().(BitwiseAndExpr).getRightOperand() instanceof BitwiseOrExpr
		and target_0.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_5)
}

predicate func_1(Variable vwakeup_data_3124, Variable vwakeind_3126, Variable v__func__, BitwiseAndExpr target_6, ExprStmt target_7, BitwiseAndExpr target_8, ExprStmt target_9) {
	exists(IfStmt target_1 |
		target_1.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwakeind_3126
		and target_1.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="67108864"
		and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__brcmf_dbg")
		and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="4"
		and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
		and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="WOWL Wake indicator: BRCMF_WOWL_PFN_FOUND\n"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__brcmf_err")
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=v__func__
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="No result for wowl net detect\n"
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="net_detect"
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vwakeup_data_3124
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="nd_info"
		and target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(8)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(2).(IfStmt).getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getLeftOperand().(VariableAccess).getLocation().isBefore(target_1.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation())
		and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

/*predicate func_2(Variable verr_3127, BlockStmt target_10) {
	exists(StmtExpr target_2 |
		target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getType().hasName("bool")
		and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("long")
		and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("long")
		and target_2.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_2.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(LogicalOrExpr).getAnOperand().(VariableAccess).getType().hasName("bool")
		and target_2.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("long")
		and target_2.getParent().(NotExpr).getOperand().(VariableAccess).getTarget()=verr_3127
		and target_2.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_10)
}

*/
predicate func_3(Variable vwakeind_3126, BlockStmt target_5, BitwiseOrExpr target_3) {
		target_3.getValue()="31"
		and target_3.getParent().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwakeind_3126
		and target_3.getParent().(BitwiseAndExpr).getParent().(IfStmt).getThen()=target_5
}

predicate func_4(Variable verr_3127, BlockStmt target_10, VariableAccess target_4) {
		target_4.getTarget()=verr_3127
		and target_4.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_10
}

predicate func_5(Variable vwakeup_data_3124, BlockStmt target_5) {
		target_5.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("cfg80211_wowlan_wakeup *")
		and target_5.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwakeup_data_3124
		and target_5.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memset")
		and target_5.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwakeup_data_3124
		and target_5.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_5.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="40"
}

predicate func_6(Variable vwakeind_3126, BitwiseAndExpr target_6) {
		target_6.getLeftOperand().(VariableAccess).getTarget()=vwakeind_3126
		and target_6.getRightOperand() instanceof BitwiseOrExpr
}

predicate func_7(Variable vwakeup_data_3124, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pattern_idx"
		and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vwakeup_data_3124
		and target_7.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_8(Variable vwakeind_3126, BitwiseAndExpr target_8) {
		target_8.getLeftOperand().(VariableAccess).getTarget()=vwakeind_3126
		and target_8.getRightOperand().(BinaryBitwiseOperation).getValue()="2"
}

predicate func_9(Variable v__func__, ExprStmt target_9) {
		target_9.getExpr().(FunctionCall).getTarget().hasName("__brcmf_dbg")
		and target_9.getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="4"
		and target_9.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
		and target_9.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="WOWL Wake indicator: BRCMF_WOWL_NET\n"
}

predicate func_10(Variable verr_3127, Variable v__func__, BlockStmt target_10) {
		target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__brcmf_err")
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=v__func__
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Get wowl_wakeind failed, err = %d\n"
		and target_10.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=verr_3127
}

from Function func, Variable vwakeup_data_3124, Variable vwakeind_3126, Variable verr_3127, Variable v__func__, BitwiseOrExpr target_3, VariableAccess target_4, BlockStmt target_5, BitwiseAndExpr target_6, ExprStmt target_7, BitwiseAndExpr target_8, ExprStmt target_9, BlockStmt target_10
where
not func_0(vwakeind_3126, target_5)
and not func_1(vwakeup_data_3124, vwakeind_3126, v__func__, target_6, target_7, target_8, target_9)
and func_3(vwakeind_3126, target_5, target_3)
and func_4(verr_3127, target_10, target_4)
and func_5(vwakeup_data_3124, target_5)
and func_6(vwakeind_3126, target_6)
and func_7(vwakeup_data_3124, target_7)
and func_8(vwakeind_3126, target_8)
and func_9(v__func__, target_9)
and func_10(verr_3127, v__func__, target_10)
and vwakeup_data_3124.getType().hasName("cfg80211_wowlan_wakeup")
and vwakeind_3126.getType().hasName("u32")
and verr_3127.getType().hasName("s32")
and v__func__.getType() instanceof ArrayType
and vwakeup_data_3124.(LocalVariable).getFunction() = func
and vwakeind_3126.(LocalVariable).getFunction() = func
and verr_3127.(LocalVariable).getFunction() = func
and not v__func__.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
