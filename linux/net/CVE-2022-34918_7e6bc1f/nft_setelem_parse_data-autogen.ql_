/**
 * @name linux-7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6-nft_setelem_parse_data
 * @id cpp/linux/7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6/nft-setelem-parse-data
 * @description linux-7e6bc1f6cabcd30aba0b11219d8e01b952eacbb6-net/netfilter/nf_tables_api.c-nft_setelem_parse_data CVE-2022-34918
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vset_5211, BlockStmt target_7, LogicalAndExpr target_6) {
exists(EqualityOperation target_0 |
	target_0.getLeftOperand().(PointerFieldAccess).getTarget().getName()="dtype"
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_5211
	and target_0.getRightOperand() instanceof EnumConstantAccess
	and target_0.getParent().(IfStmt).getThen()=target_7
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(LogicalAndExpr target_6, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32")
	and target_1.getParent().(IfStmt).getCondition()=target_6
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(LogicalAndExpr target_6, Function func) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u32")
	and target_2.getParent().(IfStmt).getCondition()=target_6
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vset_5211, Parameter vdesc_5212, Parameter vdata_5213, ExprStmt target_8, Function func) {
exists(IfStmt target_3 |
	target_3.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u32")
	and target_3.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_3.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_3.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="dlen"
	and target_3.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_5211
	and target_3.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_3.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("nft_data_release")
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_5213
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="type"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_3.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof ReturnStmt
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_3.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vset_5211, Parameter vdesc_5212, BlockStmt target_7, LogicalAndExpr target_6) {
	target_6.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_6.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_6.getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_6.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_6.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_6.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="dlen"
	and target_6.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_5211
	and target_6.getParent().(IfStmt).getThen()=target_7
}

predicate func_7(Parameter vdesc_5212, Parameter vdata_5213, BlockStmt target_7) {
	target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("nft_data_release")
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_5213
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="type"
	and target_7.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdesc_5212
	and target_7.getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
}

predicate func_8(Parameter vdesc_5212, Parameter vdata_5213, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_data_init")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("nft_ctx *")
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdata_5213
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="64"
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdesc_5212
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("nlattr *")
}

from Function func, Parameter vset_5211, Parameter vdesc_5212, Parameter vdata_5213, LogicalAndExpr target_6, BlockStmt target_7, ExprStmt target_8
where
not func_0(vset_5211, target_7, target_6)
and not func_1(target_6, func)
and not func_2(target_6, func)
and not func_3(vset_5211, vdesc_5212, vdata_5213, target_8, func)
and func_6(vset_5211, vdesc_5212, target_7, target_6)
and func_7(vdesc_5212, vdata_5213, target_7)
and func_8(vdesc_5212, vdata_5213, target_8)
and vset_5211.getType().hasName("nft_set *")
and vdesc_5212.getType().hasName("nft_data_desc *")
and vdata_5213.getType().hasName("nft_data *")
and vset_5211.getFunction() = func
and vdesc_5212.getFunction() = func
and vdata_5213.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
