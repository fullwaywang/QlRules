/**
 * @name linux-7bada55ab50697861eee6bb7d60b41e68a961a9c-binder_alloc_prepare_to_free_locked
 * @id cpp/linux/7bada55ab50697861eee6bb7d60b41e68a961a9c/binder-alloc-prepare-to-free-locked
 * @description linux-7bada55ab50697861eee6bb7d60b41e68a961a9c-drivers/android/binder_alloc.c-binder_alloc_prepare_to_free_locked CVE-2019-2025
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vbuffer_138, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="free_in_progress"
	and target_0.getQualifier().(VariableAccess).getTarget()=vbuffer_138
}

/*predicate func_2(Variable vbuffer_138, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="free_in_progress"
	and target_2.getQualifier().(VariableAccess).getTarget()=vbuffer_138
}

*/
predicate func_3(Variable vbuffer_138, IfStmt target_12, ReturnStmt target_13, Literal target_3) {
	target_3.getValue()="1"
	and not target_3.getValue()="0"
	and target_3.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="free_in_progress"
	and target_3.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuffer_138
	and target_12.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getParent().(AssignExpr).getParent().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(VariableAccess).getLocation())
}

predicate func_4(Variable vbuffer_138, BlockStmt target_14, RelationalOperation target_15, ExprStmt target_16) {
exists(NotExpr target_4 |
	target_4.getOperand().(PointerFieldAccess).getTarget().getName()="allow_user_free"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuffer_138
	and target_4.getParent().(IfStmt).getThen()=target_14
	and target_15.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Function func) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("ERR_PTR")
	and target_5.getArgument(0).(UnaryMinusExpr).getValue()="-1"
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(PointerFieldAccess target_0, Function func, ReturnStmt target_6) {
	target_6.getExpr().(Literal).getValue()="0"
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_0
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vbinder_alloc_debug_mask, PointerFieldAccess target_0, DoStmt target_7) {
	target_7.getCondition().(Literal).getValue()="0"
	and target_7.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vbinder_alloc_debug_mask
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_0
}

/*predicate func_8(Variable vbinder_alloc_debug_mask, Variable v__func__, IfStmt target_8) {
	target_8.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vbinder_alloc_debug_mask
	and target_8.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("___ratelimit")
	and target_8.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
	and target_8.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
}

*/
/*predicate func_10(Variable v_rs_157, Variable v__func__, Parameter valloc_134, Parameter vuser_ptr_135, IfStmt target_10) {
	target_10.getCondition().(FunctionCall).getTarget().hasName("___ratelimit")
	and target_10.getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v_rs_157
	and target_10.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=v__func__
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6binder_alloc: %d:%d FREE_BUFFER u%016llx user freed buffer twice\n"
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="pid"
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valloc_134
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="pid"
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_10.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vuser_ptr_135
}

*/
predicate func_12(Variable vbuffer_138, IfStmt target_12) {
	target_12.getCondition().(PointerFieldAccess).getTarget().getName()="free_in_progress"
	and target_12.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuffer_138
	and target_12.getThen() instanceof BlockStmt
}

predicate func_13(Variable vbuffer_138, ReturnStmt target_13) {
	target_13.getExpr().(VariableAccess).getTarget()=vbuffer_138
}

predicate func_14(Function func, BlockStmt target_14) {
	target_14.getStmt(0) instanceof DoStmt
	and target_14.getStmt(1) instanceof ReturnStmt
	and target_14.getEnclosingFunction() = func
}

predicate func_15(Variable vbuffer_138, RelationalOperation target_15) {
	 (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
	and target_15.getGreaterOperand().(VariableAccess).getTarget().getType().hasName("void *")
	and target_15.getLesserOperand().(PointerFieldAccess).getTarget().getName()="data"
	and target_15.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuffer_138
}

predicate func_16(Variable vbuffer_138, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="free_in_progress"
	and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbuffer_138
	and target_16.getExpr().(AssignExpr).getRValue() instanceof Literal
}

from Function func, Variable vbuffer_138, Variable vbinder_alloc_debug_mask, Variable v_rs_157, Variable v__func__, Parameter valloc_134, Parameter vuser_ptr_135, PointerFieldAccess target_0, Literal target_3, ReturnStmt target_6, DoStmt target_7, IfStmt target_12, ReturnStmt target_13, BlockStmt target_14, RelationalOperation target_15, ExprStmt target_16
where
func_0(vbuffer_138, target_0)
and func_3(vbuffer_138, target_12, target_13, target_3)
and not func_4(vbuffer_138, target_14, target_15, target_16)
and not func_5(func)
and func_6(target_0, func, target_6)
and func_7(vbinder_alloc_debug_mask, target_0, target_7)
and func_12(vbuffer_138, target_12)
and func_13(vbuffer_138, target_13)
and func_14(func, target_14)
and func_15(vbuffer_138, target_15)
and func_16(vbuffer_138, target_16)
and vbuffer_138.getType().hasName("binder_buffer *")
and vbinder_alloc_debug_mask.getType().hasName("uint32_t")
and v_rs_157.getType().hasName("ratelimit_state")
and v__func__.getType() instanceof ArrayType
and valloc_134.getType().hasName("binder_alloc *")
and vuser_ptr_135.getType().hasName("uintptr_t")
and vbuffer_138.(LocalVariable).getFunction() = func
and not vbinder_alloc_debug_mask.getParentScope+() = func
and v_rs_157.(LocalVariable).getFunction() = func
and not v__func__.getParentScope+() = func
and valloc_134.getFunction() = func
and vuser_ptr_135.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
