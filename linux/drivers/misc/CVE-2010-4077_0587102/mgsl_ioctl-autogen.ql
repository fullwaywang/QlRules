/**
 * @name linux-0587102cf9f427c185bfdeb2cef41e13ee0264b1-mgsl_ioctl
 * @id cpp/linux/0587102cf9f427c185bfdeb2cef41e13ee0264b1/mgsl-ioctl
 * @description linux-0587102cf9f427c185bfdeb2cef41e13ee0264b1-drivers/char/synclink.c-mgsl_ioctl CVE-2010-4077
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcmd_2940, Literal target_0) {
		target_0.getValue()="2945"
		and not target_0.getValue()="2977"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d):mgsl_ioctl %s cmd=%08X\n"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/char/synclink.c"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="device_name"
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("mgsl_struct *")
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vcmd_2940
}

predicate func_1(Parameter vcmd_2940, BlockStmt target_3, LogicalAndExpr target_1) {
		target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcmd_2940
		and target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="21534"
		and target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcmd_2940
		and target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="21535"
		and target_1.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcmd_2940
		and target_1.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="21596"
		and target_1.getParent().(LogicalAndExpr).getAnOperand() instanceof EqualityOperation
		and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_3
}

predicate func_2(Parameter vcmd_2940, BlockStmt target_3, LogicalAndExpr target_2) {
		target_2.getAnOperand() instanceof LogicalAndExpr
		and target_2.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vcmd_2940
		and target_2.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="21597"
		and target_2.getParent().(IfStmt).getThen()=target_3
}

predicate func_3(Function func, BlockStmt target_3) {
		target_3.getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tty_struct *")
		and target_3.getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2"
		and target_3.getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-5"
		and target_3.getEnclosingFunction() = func
}

from Function func, Parameter vcmd_2940, Literal target_0, LogicalAndExpr target_1, LogicalAndExpr target_2, BlockStmt target_3
where
func_0(vcmd_2940, target_0)
and func_1(vcmd_2940, target_3, target_1)
and func_2(vcmd_2940, target_3, target_2)
and func_3(func, target_3)
and vcmd_2940.getType().hasName("unsigned int")
and vcmd_2940.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
