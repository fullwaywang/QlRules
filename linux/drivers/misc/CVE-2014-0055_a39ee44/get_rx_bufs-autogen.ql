/**
 * @name linux-a39ee449f96a2cd44ce056d8a0a112211a9b1a1f-get_rx_bufs
 * @id cpp/linux/a39ee449f96a2cd44ce056d8a0a112211a9b1a1f/get-rx-bufs
 * @description linux-a39ee449f96a2cd44ce056d8a0a112211a9b1a1f-drivers/vhost/net.c-get_rx_bufs CVE-2014-0055
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vr_501, ExprStmt target_5) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getTarget()=vr_501
	and target_0.getRValue() instanceof FunctionCall
	and target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getLValue().(VariableAccess).getLocation()))
}

predicate func_1(Variable vr_501, IfStmt target_6) {
exists(IfStmt target_1 |
	target_1.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_1.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vr_501
	and target_1.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_1.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_1.getThen().(GotoStmt).getName() ="err"
	and target_1.getLocation().isBefore(target_6.getLocation()))
}

predicate func_2(Variable vd_500, Variable vr_501, IfStmt target_6, EqualityOperation target_8) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vd_500
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vr_501
	and target_2.getLocation().isBefore(target_6.getLocation())
	and target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_8.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vlog_493, Parameter vlog_num_494, Variable vout_497, Variable vin_497, Variable vseg_498, Variable vd_500, Parameter vvq_489, FunctionCall target_4) {
	target_4.getTarget().hasName("vhost_get_vq_desc")
	and target_4.getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_489
	and target_4.getArgument(1).(VariableAccess).getTarget()=vvq_489
	and target_4.getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="iov"
	and target_4.getArgument(2).(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_489
	and target_4.getArgument(2).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vseg_498
	and target_4.getArgument(3).(SubExpr).getLeftOperand().(AddExpr).getValue()="1024"
	and target_4.getArgument(3).(SubExpr).getRightOperand().(VariableAccess).getTarget()=vseg_498
	and target_4.getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vout_497
	and target_4.getArgument(5).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vin_497
	and target_4.getArgument(6).(VariableAccess).getTarget()=vlog_493
	and target_4.getArgument(7).(VariableAccess).getTarget()=vlog_num_494
	and target_4.getParent().(AssignExpr).getRValue() = target_4
	and target_4.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vd_500
}

predicate func_5(Variable vr_501, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_501
	and target_5.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-105"
}

predicate func_6(Variable vd_500, Variable vr_501, Parameter vvq_489, IfStmt target_6) {
	target_6.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vd_500
	and target_6.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="num"
	and target_6.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_489
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_501
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_6.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="err"
}

predicate func_8(Variable vd_500, Parameter vvq_489, EqualityOperation target_8) {
	target_8.getLeftOperand().(VariableAccess).getTarget()=vd_500
	and target_8.getRightOperand().(PointerFieldAccess).getTarget().getName()="num"
	and target_8.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvq_489
}

from Function func, Parameter vlog_493, Parameter vlog_num_494, Variable vout_497, Variable vin_497, Variable vseg_498, Variable vd_500, Variable vr_501, Parameter vvq_489, FunctionCall target_4, ExprStmt target_5, IfStmt target_6, EqualityOperation target_8
where
not func_0(vr_501, target_5)
and not func_1(vr_501, target_6)
and not func_2(vd_500, vr_501, target_6, target_8)
and func_4(vlog_493, vlog_num_494, vout_497, vin_497, vseg_498, vd_500, vvq_489, target_4)
and func_5(vr_501, target_5)
and func_6(vd_500, vr_501, vvq_489, target_6)
and func_8(vd_500, vvq_489, target_8)
and vlog_493.getType().hasName("vhost_log *")
and vlog_num_494.getType().hasName("unsigned int *")
and vout_497.getType().hasName("unsigned int")
and vin_497.getType().hasName("unsigned int")
and vseg_498.getType().hasName("int")
and vd_500.getType().hasName("unsigned int")
and vr_501.getType().hasName("int")
and vvq_489.getType().hasName("vhost_virtqueue *")
and vlog_493.getFunction() = func
and vlog_num_494.getFunction() = func
and vout_497.(LocalVariable).getFunction() = func
and vin_497.(LocalVariable).getFunction() = func
and vseg_498.(LocalVariable).getFunction() = func
and vd_500.(LocalVariable).getFunction() = func
and vr_501.(LocalVariable).getFunction() = func
and vvq_489.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
