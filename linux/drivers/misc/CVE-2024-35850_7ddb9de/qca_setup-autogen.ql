/**
 * @name linux-7ddb9de6af0f1c71147785b12fd7c8ec3f06cc86-qca_setup
 * @id cpp/linux/7ddb9de6af0f1c71147785b12fd7c8ec3f06cc86/qca-setup
 * @description linux-7ddb9de6af0f1c71147785b12fd7c8ec3f06cc86-drivers/bluetooth/hci_qca.c-qca_setup CVE-2024-35850
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhu_1839, NotExpr target_2, ExprStmt target_3, ValueFieldAccess target_4) {
exists(IfStmt target_0 |
	target_0.getCondition().(PointerFieldAccess).getTarget().getName()="serdev"
	and target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_1839
	and target_0.getThen().(BlockStmt).getStmt(0) instanceof IfStmt
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(4)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vhu_1839, NotExpr target_2, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("device_can_wakeup")
	and target_1.getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="parent"
	and target_1.getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ctrl"
	and target_1.getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="serdev"
	and target_1.getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_1839
	and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="wakeup"
	and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="hdev"
	and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_1839
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
}

predicate func_2(Function func, NotExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vhu_1839, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cmd_timeout"
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="hdev"
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_1839
}

predicate func_4(Parameter vhu_1839, ValueFieldAccess target_4) {
	target_4.getTarget().getName()="parent"
	and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ctrl"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="serdev"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_1839
}

from Function func, Parameter vhu_1839, IfStmt target_1, NotExpr target_2, ExprStmt target_3, ValueFieldAccess target_4
where
not func_0(vhu_1839, target_2, target_3, target_4)
and func_1(vhu_1839, target_2, target_1)
and func_2(func, target_2)
and func_3(vhu_1839, target_3)
and func_4(vhu_1839, target_4)
and vhu_1839.getType().hasName("hci_uart *")
and vhu_1839.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
