/**
 * @name linux-6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da-locks_delete_block
 * @id cpp/linux/6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da/locks-delete-block
 * @description linux-6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da-fs/locks.c-locks_delete_block CVE-2019-19769
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vwaiter_752, Variable vstatus_754, Function func, IfStmt target_0) {
	target_0.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="fl_blocker"
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwaiter_752
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="fl_blocked_requests"
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwaiter_752
	and target_0.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vstatus_754
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

from Function func, Parameter vwaiter_752, Variable vstatus_754, IfStmt target_0
where
func_0(vwaiter_752, vstatus_754, func, target_0)
and vwaiter_752.getType().hasName("file_lock *")
and vstatus_754.getType().hasName("int")
and vwaiter_752.getFunction() = func
and vstatus_754.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
