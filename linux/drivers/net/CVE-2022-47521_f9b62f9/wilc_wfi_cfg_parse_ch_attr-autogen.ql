/**
 * @name linux-f9b62f9843c7b0afdaecabbcebf1dbba18599408-wilc_wfi_cfg_parse_ch_attr
 * @id cpp/linux/f9b62f9843c7b0afdaecabbcebf1dbba18599408/wilc-wfi-cfg-parse-ch-attr
 * @description linux-f9b62f9843c7b0afdaecabbcebf1dbba18599408-drivers/net/wireless/microchip/wilc1000/cfg80211.c-wilc_wfi_cfg_parse_ch_attr CVE-2022-47521
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vattr_size_962, ExprStmt target_2, RelationalOperation target_3, LogicalAndExpr target_4) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand() instanceof EqualityOperation
	and target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vattr_size_962
	and target_0.getRightOperand().(RelationalOperation).getLesserOperand().(SubExpr).getValue()="3"
	and target_0.getParent().(IfStmt).getThen()=target_2
	and target_3.getGreaterOperand().(AddExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation())
	and target_0.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation().isBefore(target_4.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable ve_951, ExprStmt target_2, EqualityOperation target_1) {
	target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
	and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
	and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Function func, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u8")
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("u32")
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vattr_size_962, RelationalOperation target_3) {
	 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getGreaterOperand().(AddExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u32")
	and target_3.getGreaterOperand().(AddExpr).getLeftOperand().(AddExpr).getRightOperand().(SizeofExprOperator).getValue()="3"
	and target_3.getGreaterOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vattr_size_962
	and target_3.getLesserOperand().(VariableAccess).getTarget().getType().hasName("u32")
}

predicate func_4(Variable ve_951, Variable vattr_size_962, LogicalAndExpr target_4) {
	target_4.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="attr_type"
	and target_4.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=ve_951
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vattr_size_962
	and target_4.getRightOperand().(EqualityOperation).getRightOperand().(SubExpr).getValue()="5"
}

from Function func, Variable ve_951, Variable vattr_size_962, EqualityOperation target_1, ExprStmt target_2, RelationalOperation target_3, LogicalAndExpr target_4
where
not func_0(vattr_size_962, target_2, target_3, target_4)
and func_1(ve_951, target_2, target_1)
and func_2(func, target_2)
and func_3(vattr_size_962, target_3)
and func_4(ve_951, vattr_size_962, target_4)
and ve_951.getType().hasName("wilc_attr_entry *")
and vattr_size_962.getType().hasName("u16")
and ve_951.(LocalVariable).getFunction() = func
and vattr_size_962.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
