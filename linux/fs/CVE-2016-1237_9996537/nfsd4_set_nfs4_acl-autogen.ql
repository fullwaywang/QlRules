/**
 * @name linux-999653786df6954a31044528ac3f7a5dadca08f4-nfsd4_set_nfs4_acl
 * @id cpp/linux/999653786df6954a31044528ac3f7a5dadca08f4/nfsd4-set-nfs4-acl
 * @description linux-999653786df6954a31044528ac3f7a5dadca08f4-fs/nfsd/nfs4acl.c-nfsd4_set_nfs4_acl CVE-2016-1237
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfhp_755, ExprStmt target_14, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(FunctionCall).getTarget().hasName("fh_lock")
		and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfhp_755
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vinode_761, Variable vpacl_762, PointerFieldAccess target_15, EqualityOperation target_16, AddressOfExpr target_17, ExprStmt target_18) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("set_posix_acl")
		and target_1.getArgument(0).(VariableAccess).getTarget()=vinode_761
		and target_1.getArgument(1) instanceof Literal
		and target_1.getArgument(2).(VariableAccess).getTarget()=vpacl_762
		and target_1.getParent().(AssignExpr).getRValue() = target_1
		and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_15.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getArgument(0).(VariableAccess).getLocation())
		and target_1.getArgument(0).(VariableAccess).getLocation().isBefore(target_16.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_17.getOperand().(VariableAccess).getLocation().isBefore(target_1.getArgument(2).(VariableAccess).getLocation())
		and target_1.getArgument(2).(VariableAccess).getLocation().isBefore(target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vinode_761, Variable vdpacl_762, PointerFieldAccess target_19, AddressOfExpr target_20, ExprStmt target_21) {
	exists(FunctionCall target_2 |
		target_2.getTarget().hasName("set_posix_acl")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vinode_761
		and target_2.getArgument(1) instanceof Literal
		and target_2.getArgument(2).(VariableAccess).getTarget()=vdpacl_762
		and target_2.getParent().(AssignExpr).getRValue() = target_2
		and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_19.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getArgument(0).(VariableAccess).getLocation())
		and target_20.getOperand().(VariableAccess).getLocation().isBefore(target_2.getArgument(2).(VariableAccess).getLocation())
		and target_2.getArgument(2).(VariableAccess).getLocation().isBefore(target_21.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Parameter vfhp_755, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(FunctionCall).getTarget().hasName("fh_unlock")
		and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfhp_755
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Function func, FunctionCall target_4) {
		target_4.getTarget().hasName("__builtin_bswap32")
		and target_4.getValue()="807862272"
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vinode_761, VariableAccess target_5) {
		target_5.getTarget()=vinode_761
		and target_5.getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
}

predicate func_6(Variable vinode_761, VariableAccess target_6) {
		target_6.getTarget()=vinode_761
		and target_6.getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
}

predicate func_7(Variable vpacl_762, VariableAccess target_7) {
		target_7.getTarget()=vpacl_762
		and target_7.getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
}

predicate func_9(Variable vdpacl_762, VariableAccess target_9) {
		target_9.getTarget()=vdpacl_762
		and target_9.getParent().(VariableCall).getParent().(AssignExpr).getRValue() instanceof VariableCall
}

predicate func_11(Variable vinode_761, Function func, IfStmt target_11) {
		target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="set_acl"
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_op"
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="s_flags"
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_sb"
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
		and target_11.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="65536"
		and target_11.getThen().(ReturnStmt).getExpr() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vinode_761, Variable vpacl_762, VariableCall target_12) {
		target_12.getExpr().(PointerFieldAccess).getTarget().getName()="set_acl"
		and target_12.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_op"
		and target_12.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
		and target_12.getArgument(0).(VariableAccess).getTarget()=vinode_761
		and target_12.getArgument(1).(VariableAccess).getTarget()=vpacl_762
		and target_12.getArgument(2) instanceof Literal
}

predicate func_13(Variable vinode_761, Variable vdpacl_762, VariableCall target_13) {
		target_13.getExpr().(PointerFieldAccess).getTarget().getName()="set_acl"
		and target_13.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="i_op"
		and target_13.getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
		and target_13.getArgument(0).(VariableAccess).getTarget()=vinode_761
		and target_13.getArgument(1).(VariableAccess).getTarget()=vdpacl_762
		and target_13.getArgument(2) instanceof Literal
}

predicate func_14(Parameter vfhp_755, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("dentry *")
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="fh_dentry"
		and target_14.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfhp_755
}

predicate func_15(Variable vinode_761, PointerFieldAccess target_15) {
		target_15.getTarget().getName()="set_acl"
		and target_15.getQualifier().(PointerFieldAccess).getTarget().getName()="i_op"
		and target_15.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
}

predicate func_16(Variable vinode_761, BlockStmt target_22, EqualityOperation target_16) {
		target_16.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="i_mode"
		and target_16.getAnOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
		and target_16.getAnOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="61440"
		and target_16.getAnOperand().(Literal).getValue()="16384"
		and target_16.getParent().(IfStmt).getThen()=target_22
}

predicate func_17(Variable vpacl_762, AddressOfExpr target_17) {
		target_17.getOperand().(VariableAccess).getTarget()=vpacl_762
}

predicate func_18(Variable vpacl_762, ExprStmt target_18) {
		target_18.getExpr().(FunctionCall).getTarget().hasName("posix_acl_release")
		and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpacl_762
}

predicate func_19(Variable vinode_761, PointerFieldAccess target_19) {
		target_19.getTarget().getName()="set_acl"
		and target_19.getQualifier().(PointerFieldAccess).getTarget().getName()="i_op"
		and target_19.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinode_761
}

predicate func_20(Variable vdpacl_762, AddressOfExpr target_20) {
		target_20.getOperand().(VariableAccess).getTarget()=vdpacl_762
}

predicate func_21(Variable vdpacl_762, ExprStmt target_21) {
		target_21.getExpr().(FunctionCall).getTarget().hasName("posix_acl_release")
		and target_21.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdpacl_762
}

predicate func_22(Function func, BlockStmt target_22) {
		target_22.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_22.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof VariableCall
		and target_22.getEnclosingFunction() = func
}

from Function func, Parameter vfhp_755, Variable vinode_761, Variable vpacl_762, Variable vdpacl_762, FunctionCall target_4, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, VariableAccess target_9, IfStmt target_11, VariableCall target_12, VariableCall target_13, ExprStmt target_14, PointerFieldAccess target_15, EqualityOperation target_16, AddressOfExpr target_17, ExprStmt target_18, PointerFieldAccess target_19, AddressOfExpr target_20, ExprStmt target_21, BlockStmt target_22
where
not func_0(vfhp_755, target_14, func)
and not func_1(vinode_761, vpacl_762, target_15, target_16, target_17, target_18)
and not func_2(vinode_761, vdpacl_762, target_19, target_20, target_21)
and not func_3(vfhp_755, func)
and func_4(func, target_4)
and func_5(vinode_761, target_5)
and func_6(vinode_761, target_6)
and func_7(vpacl_762, target_7)
and func_9(vdpacl_762, target_9)
and func_11(vinode_761, func, target_11)
and func_12(vinode_761, vpacl_762, target_12)
and func_13(vinode_761, vdpacl_762, target_13)
and func_14(vfhp_755, target_14)
and func_15(vinode_761, target_15)
and func_16(vinode_761, target_22, target_16)
and func_17(vpacl_762, target_17)
and func_18(vpacl_762, target_18)
and func_19(vinode_761, target_19)
and func_20(vdpacl_762, target_20)
and func_21(vdpacl_762, target_21)
and func_22(func, target_22)
and vfhp_755.getType().hasName("svc_fh *")
and vinode_761.getType().hasName("inode *")
and vpacl_762.getType().hasName("posix_acl *")
and vdpacl_762.getType().hasName("posix_acl *")
and vfhp_755.getFunction() = func
and vinode_761.(LocalVariable).getFunction() = func
and vpacl_762.(LocalVariable).getFunction() = func
and vdpacl_762.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
