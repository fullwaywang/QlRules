/**
 * @name linux-8246bbf818ed7b8d5afc92b951e6d562b45c2450-hda_dai_suspend
 * @id cpp/linux/8246bbf818ed7b8d5afc92b951e6d562b45c2450/hda-dai-suspend
 * @description linux-8246bbf818ed7b8d5afc92b951e6d562b45c2450-sound/soc/sof/intel/hda-dai.c-hda_dai_suspend CVE-2024-41037
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vhext_stream_506, Variable vret_508, Variable vops_522, Variable vcpu_dai_525, Variable vsdev_526, IfStmt target_1, IfStmt target_0) {
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getCondition() |
		obj_0.getTarget().getName()="post_trigger"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vops_522
	)
	and exists(BlockStmt obj_1 | obj_1=target_0.getThen() |
		exists(ExprStmt obj_2 | obj_2=obj_1.getStmt(0) |
			exists(AssignExpr obj_3 | obj_3=obj_2.getExpr() |
				exists(VariableCall obj_4 | obj_4=obj_3.getRValue() |
					exists(PointerFieldAccess obj_5 | obj_5=obj_4.getExpr() |
						obj_5.getTarget().getName()="post_trigger"
						and obj_5.getQualifier().(VariableAccess).getTarget()=vops_522
					)
					and exists(PointerFieldAccess obj_6 | obj_6=obj_4.getArgument(2) |
						obj_6.getTarget().getName()="link_substream"
						and obj_6.getQualifier().(VariableAccess).getTarget()=vhext_stream_506
					)
					and obj_4.getArgument(0).(VariableAccess).getTarget()=vsdev_526
					and obj_4.getArgument(1).(VariableAccess).getTarget()=vcpu_dai_525
					and obj_4.getArgument(3).(Literal).getValue()="5"
				)
				and obj_3.getLValue().(VariableAccess).getTarget()=vret_508
			)
		)
		and exists(IfStmt obj_7 | obj_7=obj_1.getStmt(1) |
			exists(RelationalOperation obj_8 | obj_8=obj_7.getCondition() |
				obj_8.getLesserOperand().(VariableAccess).getTarget()=vret_508
				and obj_8.getGreaterOperand().(Literal).getValue()="0"
			)
			and obj_7.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_508
		)
	)
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vret_508, IfStmt target_1) {
	exists(RelationalOperation obj_0 | obj_0=target_1.getCondition() |
		obj_0.getLesserOperand().(VariableAccess).getTarget()=vret_508
		and obj_0.getGreaterOperand().(Literal).getValue()="0"
	)
	and target_1.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_508
}

from Function func, Variable vhext_stream_506, Variable vret_508, Variable vops_522, Variable vcpu_dai_525, Variable vsdev_526, IfStmt target_0, IfStmt target_1
where
func_0(vhext_stream_506, vret_508, vops_522, vcpu_dai_525, vsdev_526, target_1, target_0)
and func_1(vret_508, target_1)
and vhext_stream_506.getType().hasName("hdac_ext_stream *")
and vret_508.getType().hasName("int")
and vops_522.getType().hasName("const hda_dai_widget_dma_ops *")
and vcpu_dai_525.getType().hasName("snd_soc_dai *")
and vsdev_526.getType().hasName("snd_sof_dev *")
and vhext_stream_506.(LocalVariable).getFunction() = func
and vret_508.(LocalVariable).getFunction() = func
and vops_522.(LocalVariable).getFunction() = func
and vcpu_dai_525.(LocalVariable).getFunction() = func
and vsdev_526.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
