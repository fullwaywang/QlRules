/**
 * @name linux-5535be3099717646781ce1540cf725965d680e7b-follow_devmap_pmd
 * @id cpp/linux/5535be3099717646781ce1540cf725965d680e7b/follow-devmap-pmd
 * @description linux-5535be3099717646781ce1540cf725965d680e7b-mm/huge_memory.c-follow_devmap_pmd CVE-2022-2590
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BitwiseOrExpr target_0) {
	target_0.getValue()="2313"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="991"
	and not target_1.getValue()="990"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="992"
	and not target_2.getValue()="991"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, Literal target_3) {
	target_3.getValue()="994"
	and not target_3.getValue()="990"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, Literal target_4) {
	target_4.getValue()="995"
	and not target_4.getValue()="991"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable v__ret_warn_on_1047, DoStmt target_24, FunctionCall target_5) {
	target_5.getTarget().hasName("__builtin_expect")
	and target_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1047
	and target_5.getArgument(1) instanceof Literal
	and target_5.getParent().(IfStmt).getThen()=target_24
}

predicate func_6(Function func, ExprStmt target_6) {
	target_6.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="990"
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable v__ret_warn_on_1047, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_7.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1047
	and target_7.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

predicate func_8(Function func, ExprStmt target_8) {
	target_8.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_8.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_10(Function func, IfStmt target_10) {
	target_10.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_10.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_10.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_10.getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_10.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition() instanceof FunctionCall
	and target_10.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_10.getThen().(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_14(Variable v__already_done_1047, Variable v__ret_cond_1047, Variable v__ret_once_1047, IfStmt target_14) {
	target_14.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_14.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=v__ret_cond_1047
	and target_14.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__already_done_1047
	and target_14.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_14.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_1047
	and target_14.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_1047
}

*/
/*predicate func_15(Variable v__already_done_1047, FunctionCall target_25, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_1047
	and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

*/
/*predicate func_16(Variable v__ret_once_1047, FunctionCall target_25, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_1047
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

*/
/*predicate func_17(Variable v__ret_once_1047, ExprStmt target_17) {
	target_17.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_17.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_once_1047
	and target_17.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
/*predicate func_19(Function func, IfStmt target_19) {
	target_19.getCondition() instanceof FunctionCall
	and target_19.getThen().(DoStmt).getCondition() instanceof Literal
	and target_19.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_19.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition() instanceof Literal
	and target_19.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition() instanceof Literal
	and target_19.getEnclosingFunction() = func
}

*/
/*predicate func_21(Function func, ExprStmt target_21) {
	target_21.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="993"
	and target_21.getEnclosingFunction() = func
}

*/
/*predicate func_22(Function func, AsmStmt target_22) {
	target_22.getChild(0).(Literal).getValue()="993"
	and target_22.getEnclosingFunction() = func
}

*/
/*predicate func_23(Variable v__ret_do_once_1047, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_23.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_do_once_1047
	and target_23.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
predicate func_24(Function func, DoStmt target_24) {
	target_24.getCondition() instanceof Literal
	and target_24.getStmt() instanceof BlockStmt
	and target_24.getEnclosingFunction() = func
}

predicate func_25(Function func, FunctionCall target_25) {
	target_25.getTarget().hasName("__builtin_expect")
	and target_25.getArgument(0) instanceof NotExpr
	and target_25.getArgument(1) instanceof Literal
	and target_25.getEnclosingFunction() = func
}

from Function func, Variable v__ret_do_once_1047, Variable v__already_done_1047, Variable v__ret_cond_1047, Variable v__ret_once_1047, Variable v__ret_warn_on_1047, BitwiseOrExpr target_0, Literal target_1, Literal target_2, Literal target_3, Literal target_4, FunctionCall target_5, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, DoStmt target_24, FunctionCall target_25
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(v__ret_warn_on_1047, target_24, target_5)
and func_6(func, target_6)
and func_7(v__ret_warn_on_1047, target_7)
and func_8(func, target_8)
and func_24(func, target_24)
and func_25(func, target_25)
and v__ret_do_once_1047.getType().hasName("bool")
and v__already_done_1047.getType().hasName("bool")
and v__ret_cond_1047.getType().hasName("bool")
and v__ret_once_1047.getType().hasName("bool")
and v__ret_warn_on_1047.getType().hasName("int")
and v__ret_do_once_1047.(LocalVariable).getFunction() = func
and v__already_done_1047.(LocalVariable).getFunction() = func
and v__ret_cond_1047.(LocalVariable).getFunction() = func
and v__ret_once_1047.(LocalVariable).getFunction() = func
and v__ret_warn_on_1047.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
