/**
 * @name linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-vmw_execbuf_res_noctx_val_add
 * @id cpp/linux/a309c7194e8a2f8bd4539b9449917913f6c2cd50/vmw-execbuf-res-noctx-val-add
 * @description linux-a309c7194e8a2f8bd4539b9449917913f6c2cd50-drivers/gpu/drm/vmwgfx/vmwgfx_execbuf.c-vmw_execbuf_res_noctx_val_add CVE-2022-40133
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vptr_362, VariableAccess target_0) {
	target_0.getTarget()=vptr_362
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_1(Variable vrcache_360, Parameter vres_357) {
exists(AssignExpr target_1 |
	target_1.getLValue().(PointerFieldAccess).getTarget().getName()="res"
	and target_1.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_1.getRValue().(VariableAccess).getTarget()=vres_357)
}

predicate func_2(Variable vrcache_360) {
exists(AssignExpr target_2 |
	target_2.getLValue().(PointerFieldAccess).getTarget().getName()="private"
	and target_2.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_2.getRValue().(VariableAccess).getType().hasName("void *"))
}

predicate func_3(Variable vrcache_360) {
exists(AssignExpr target_3 |
	target_3.getLValue().(PointerFieldAccess).getTarget().getName()="valid"
	and target_3.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_3.getRValue() instanceof Literal)
}

predicate func_4(Variable vrcache_360) {
exists(AssignExpr target_4 |
	target_4.getLValue().(PointerFieldAccess).getTarget().getName()="valid_handle"
	and target_4.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_4.getRValue() instanceof Literal)
}

predicate func_5(Variable vrcache_360, VariableAccess target_5) {
	target_5.getTarget()=vrcache_360
	and target_5.getParent().(PointerFieldAccess).getParent().(LogicalAndExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_6(Variable vrcache_360, VariableAccess target_6) {
	target_6.getTarget()=vrcache_360
	and target_6.getParent().(PointerFieldAccess).getParent().(EQExpr).getParent().(LogicalAndExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_7(Variable vrcache_360, VariableAccess target_7) {
	target_7.getTarget()=vrcache_360
	and target_7.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_8(Parameter vres_357, VariableAccess target_8) {
	target_8.getTarget()=vres_357
	and target_8.getParent().(FunctionCall).getParent().(Initializer).getExpr() instanceof FunctionCall
}

predicate func_11(Variable vrcache_360, VariableAccess target_11) {
	target_11.getTarget()=vrcache_360
	and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_12(Function func, DeclStmt target_12) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Function func, DeclStmt target_13) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Function func, DeclStmt target_14) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Function func, DeclStmt target_15) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Variable vrcache_360, Variable vres_type_361, Parameter vsw_context_356, AssignExpr target_16) {
	target_16.getLValue().(VariableAccess).getTarget()=vrcache_360
	and target_16.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="res_cache"
	and target_16.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsw_context_356
	and target_16.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vres_type_361
}

predicate func_17(Parameter vdirty_358, Variable vrcache_360, Parameter vsw_context_356, Parameter vres_357, Function func, IfStmt target_17) {
	target_17.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_17.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="valid"
	and target_17.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_17.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="res"
	and target_17.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vres_357
	and target_17.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableAccess).getTarget()=vdirty_358
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("vmw_validation_res_set_dirty")
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsw_context_356
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="private"
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_17.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdirty_358
	and target_17.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

/*predicate func_18(Parameter vdirty_358, Variable vrcache_360, Parameter vsw_context_356, FunctionCall target_27, IfStmt target_18) {
	target_18.getCondition().(VariableAccess).getTarget()=vdirty_358
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("vmw_validation_res_set_dirty")
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsw_context_356
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="private"
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_18.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vdirty_358
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

*/
/*predicate func_19(Parameter vdirty_358, Variable vrcache_360, Parameter vsw_context_356, FunctionCall target_19) {
	target_19.getTarget().hasName("vmw_validation_res_set_dirty")
	and target_19.getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_19.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsw_context_356
	and target_19.getArgument(1).(PointerFieldAccess).getTarget().getName()="private"
	and target_19.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrcache_360
	and target_19.getArgument(2).(VariableAccess).getTarget()=vdirty_358
}

*/
predicate func_20(Parameter vdirty_358, Variable vptr_362, Variable vret_363, Parameter vsw_context_356, Parameter vres_357, AssignExpr target_20) {
	target_20.getLValue().(VariableAccess).getTarget()=vret_363
	and target_20.getRValue().(FunctionCall).getTarget().hasName("vmw_validation_add_resource")
	and target_20.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_20.getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsw_context_356
	and target_20.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vres_357
	and target_20.getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_20.getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vdirty_358
	and target_20.getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vptr_362
	and target_20.getRValue().(FunctionCall).getArgument(5).(Literal).getValue()="0"
}

predicate func_21(Variable vret_363, Function func, IfStmt target_21) {
	target_21.getCondition().(VariableAccess).getTarget()=vret_363
	and target_21.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_363
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_22(Variable vrcache_360, Variable vptr_362, Parameter vres_357, FunctionCall target_22) {
	target_22.getTarget().hasName("vmw_execbuf_rcache_update")
	and target_22.getArgument(0).(VariableAccess).getTarget()=vrcache_360
	and target_22.getArgument(1).(VariableAccess).getTarget()=vres_357
	and target_22.getArgument(2).(VariableAccess).getTarget()=vptr_362
}

predicate func_23(Function func, ReturnStmt target_23) {
	target_23.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_23
}

predicate func_27(Function func, FunctionCall target_27) {
	target_27.getTarget().hasName("__builtin_expect")
	and target_27.getArgument(0) instanceof NotExpr
	and target_27.getArgument(1) instanceof Literal
	and target_27.getEnclosingFunction() = func
}

from Function func, Parameter vdirty_358, Variable vrcache_360, Variable vres_type_361, Variable vptr_362, Variable vret_363, Parameter vsw_context_356, Parameter vres_357, VariableAccess target_0, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, VariableAccess target_8, VariableAccess target_11, DeclStmt target_12, DeclStmt target_13, DeclStmt target_14, DeclStmt target_15, AssignExpr target_16, IfStmt target_17, AssignExpr target_20, IfStmt target_21, FunctionCall target_22, ReturnStmt target_23, FunctionCall target_27
where
func_0(vptr_362, target_0)
and not func_1(vrcache_360, vres_357)
and not func_2(vrcache_360)
and not func_3(vrcache_360)
and not func_4(vrcache_360)
and func_5(vrcache_360, target_5)
and func_6(vrcache_360, target_6)
and func_7(vrcache_360, target_7)
and func_8(vres_357, target_8)
and func_11(vrcache_360, target_11)
and func_12(func, target_12)
and func_13(func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(vrcache_360, vres_type_361, vsw_context_356, target_16)
and func_17(vdirty_358, vrcache_360, vsw_context_356, vres_357, func, target_17)
and func_20(vdirty_358, vptr_362, vret_363, vsw_context_356, vres_357, target_20)
and func_21(vret_363, func, target_21)
and func_22(vrcache_360, vptr_362, vres_357, target_22)
and func_23(func, target_23)
and func_27(func, target_27)
and vdirty_358.getType().hasName("u32")
and vrcache_360.getType().hasName("vmw_res_cache_entry *")
and vres_type_361.getType().hasName("vmw_res_type")
and vptr_362.getType().hasName("void *")
and vret_363.getType().hasName("int")
and vsw_context_356.getType().hasName("vmw_sw_context *")
and vres_357.getType().hasName("vmw_resource *")
and vdirty_358.getFunction() = func
and vrcache_360.(LocalVariable).getFunction() = func
and vres_type_361.(LocalVariable).getFunction() = func
and vptr_362.(LocalVariable).getFunction() = func
and vret_363.(LocalVariable).getFunction() = func
and vsw_context_356.getFunction() = func
and vres_357.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
