/**
 * @name linux-b49a0e69a7b1a68c8d3f64097d06dabb770fec96-aspeed_lpc_ctrl_mmap
 * @id cpp/linux/b49a0e69a7b1a68c8d3f64097d06dabb770fec96/aspeed-lpc-ctrl-mmap
 * @description linux-b49a0e69a7b1a68c8d3f64097d06dabb770fec96-aspeed_lpc_ctrl_mmap CVE-2021-42252
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvma_48, RelationalOperation target_5, FunctionCall target_6) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("vma_pages")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vvma_48
		and target_5.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(VariableAccess).getLocation())
		and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_6.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Parameter vvma_48, Variable vlpc_ctrl_50, Variable vvsize_51, ReturnStmt target_7, RelationalOperation target_5, AddExpr target_8) {
	exists(BinaryBitwiseOperation target_1 |
		target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="mem_size"
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
		and target_1.getRightOperand().(Literal).getValue()="12"
		and target_1.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
		and target_1.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
		and target_1.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vvsize_51
		and target_1.getParent().(GTExpr).getLesserOperand() instanceof AddExpr
		and target_1.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_7
		and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vlpc_ctrl_50, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="mem_size"
		and target_2.getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
}

/*predicate func_3(Variable vvsize_51, FunctionCall target_6, VariableAccess target_3) {
		target_3.getTarget()=vvsize_51
		and target_3.getLocation().isBefore(target_6.getArgument(3).(VariableAccess).getLocation())
}

*/
predicate func_4(Parameter vvma_48, Variable vlpc_ctrl_50, Variable vvsize_51, ReturnStmt target_7, AddExpr target_4) {
		target_4.getAnOperand().(PointerFieldAccess).getTarget().getName()="mem_base"
		and target_4.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
		and target_4.getAnOperand().(PointerFieldAccess).getTarget().getName()="mem_size"
		and target_4.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
		and target_4.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
		and target_4.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
		and target_4.getParent().(GTExpr).getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vvsize_51
		and target_4.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_7
}

predicate func_5(Parameter vvma_48, Variable vvsize_51, RelationalOperation target_5) {
		 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
		and target_5.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
		and target_5.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
		and target_5.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vvsize_51
		and target_5.getLesserOperand() instanceof AddExpr
}

predicate func_6(Parameter vvma_48, Variable vlpc_ctrl_50, Variable vvsize_51, FunctionCall target_6) {
		target_6.getTarget().hasName("remap_pfn_range")
		and target_6.getArgument(0).(VariableAccess).getTarget()=vvma_48
		and target_6.getArgument(1).(PointerFieldAccess).getTarget().getName()="vm_start"
		and target_6.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
		and target_6.getArgument(2).(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mem_base"
		and target_6.getArgument(2).(AddExpr).getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
		and target_6.getArgument(2).(AddExpr).getAnOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
		and target_6.getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
		and target_6.getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
		and target_6.getArgument(3).(VariableAccess).getTarget()=vvsize_51
		and target_6.getArgument(4).(VariableAccess).getTarget().getType().hasName("pgprot_t")
}

predicate func_7(Function func, ReturnStmt target_7) {
		target_7.getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vvma_48, Variable vlpc_ctrl_50, AddExpr target_8) {
		target_8.getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mem_base"
		and target_8.getAnOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlpc_ctrl_50
		and target_8.getAnOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
		and target_8.getAnOperand().(PointerFieldAccess).getTarget().getName()="vm_pgoff"
		and target_8.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_48
}

from Function func, Parameter vvma_48, Variable vlpc_ctrl_50, Variable vvsize_51, PointerFieldAccess target_2, AddExpr target_4, RelationalOperation target_5, FunctionCall target_6, ReturnStmt target_7, AddExpr target_8
where
not func_0(vvma_48, target_5, target_6)
and not func_1(vvma_48, vlpc_ctrl_50, vvsize_51, target_7, target_5, target_8)
and func_2(vlpc_ctrl_50, target_2)
and func_4(vvma_48, vlpc_ctrl_50, vvsize_51, target_7, target_4)
and func_5(vvma_48, vvsize_51, target_5)
and func_6(vvma_48, vlpc_ctrl_50, vvsize_51, target_6)
and func_7(func, target_7)
and func_8(vvma_48, vlpc_ctrl_50, target_8)
and vvma_48.getType().hasName("vm_area_struct *")
and vlpc_ctrl_50.getType().hasName("aspeed_lpc_ctrl *")
and vvsize_51.getType().hasName("unsigned long")
and vvma_48.getFunction() = func
and vlpc_ctrl_50.(LocalVariable).getFunction() = func
and vvsize_51.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
