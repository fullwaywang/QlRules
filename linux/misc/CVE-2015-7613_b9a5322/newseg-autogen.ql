/**
 * @name linux-b9a532277938798b53178d5a66af6e2915cb27cf-newseg
 * @id cpp/linux/b9a532277938798b53178d5a66af6e2915cb27cf/newseg
 * @description linux-b9a532277938798b53178d5a66af6e2915cb27cf-ipc/shm.c-newseg CVE-2015-7613
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vshp_490, Variable vid_494, Parameter vns_484, ExprStmt target_2, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_494
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ipc_addid")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="ids"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vns_484
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="2"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="shm_perm"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshp_490
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="shm_ctlmni"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vns_484
	and target_0.getLocation().isBefore(target_2.getLocation())
}

predicate func_1(Variable verror_489, Variable vid_494, ExprStmt target_2, IfStmt target_1) {
	target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vid_494
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_489
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vid_494
	and target_1.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="no_id"
	and target_1.getLocation().isBefore(target_2.getLocation())
}

predicate func_2(Variable vshp_490, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="shm_cprid"
	and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshp_490
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("task_tgid_vnr")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("get_current")
}

from Function func, Variable verror_489, Variable vshp_490, Variable vid_494, Parameter vns_484, ExprStmt target_0, IfStmt target_1, ExprStmt target_2
where
func_0(vshp_490, vid_494, vns_484, target_2, target_0)
and func_1(verror_489, vid_494, target_2, target_1)
and func_2(vshp_490, target_2)
and verror_489.getType().hasName("int")
and vshp_490.getType().hasName("shmid_kernel *")
and vid_494.getType().hasName("int")
and vns_484.getType().hasName("ipc_namespace *")
and verror_489.(LocalVariable).getFunction() = func
and vshp_490.(LocalVariable).getFunction() = func
and vid_494.(LocalVariable).getFunction() = func
and vns_484.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
