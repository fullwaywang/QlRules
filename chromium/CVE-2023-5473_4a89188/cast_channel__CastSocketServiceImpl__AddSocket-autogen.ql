/**
 * @name chromium-4a89188f9b98ba9611807d0de7becc1e0c43a19d-cast_channel__CastSocketServiceImpl__AddSocket
 * @id cpp/chromium/4a89188f9b98ba9611807d0de7becc1e0c43a19d/castchannelcastsocketserviceimpladdsocket
 * @description chromium-4a89188f9b98ba9611807d0de7becc1e0c43a19d-components/media_router/common/providers/cast/channel/cast_socket_service.cc-cast_channel__CastSocketServiceImpl__AddSocket CVE-2023-5473
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vid_46, VariableAccess target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getParent() |
		exists(ExprStmt obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getExpr() |
				obj_2.getTarget().hasName("set_id")
				and obj_2.getQualifier().(FunctionCall).getQualifier().(VariableAccess).getTarget().getType().hasName("unique_ptr<CastSocket, default_delete<CastSocket>>")
			)
		)
	)
	and target_0.getTarget()=vid_46
}

predicate func_1(Variable vid_46, VariableAccess target_1) {
	exists(FunctionCall obj_0 | obj_0=target_1.getParent() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getArgument(0) |
				exists(FunctionCall obj_3 | obj_3=obj_2.getArgument(1) |
					obj_3.getTarget().hasName("move")
					and obj_3.getArgument(0).(VariableAccess).getTarget().getType().hasName("unique_ptr<CastSocket, default_delete<CastSocket>>")
				)
				and obj_2.getTarget().hasName("make_pair")
			)
		)
	)
	and target_1.getTarget()=vid_46
}

predicate func_2(Variable vlast_channel_id_, Initializer target_2) {
	target_2.getExpr().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vlast_channel_id_
}

predicate func_3(Function func) {
exists(SwitchStmt target_3 |
	exists(BlockStmt obj_0 | obj_0=target_3.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("__builtin_expect")
				and obj_2.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
				and obj_2.getArgument(1).(Literal).getValue()="1"
			)
			and exists(ExprStmt obj_3 | obj_3=obj_1.getElse() |
				exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
					exists(FunctionCall obj_5 | obj_5=obj_4.getQualifier() |
						obj_5.getTarget().hasName("Check")
						and obj_5.getArgument(0).(StringLiteral).getValue()="base::CheckAdd(last_channel_id_, 1).AssignIfValid(&last_channel_id_)"
					)
					and obj_4.getTarget().hasName("operator<<")
					and obj_4.getArgument(0).(StringLiteral).getValue()="Overflow in channel_id!"
				)
			)
		)
		and obj_0.getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="0"
		and obj_0.getStmt(1).(SwitchCase).toString() = "default: "
	)
	and target_3.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof DeclStmt
)
}

predicate func_5(Function func) {
exists(FunctionCall target_5 |
	exists(FunctionCall obj_0 | obj_0=target_5.getQualifier() |
		obj_0.getTarget().hasName("CheckAdd")
		and obj_0.getArgument(0).(VariableAccess).getType().hasName("int")
		and obj_0.getArgument(1).(Literal).getValue()="1"
	)
	and target_5.getTarget().hasName("AssignIfValid")
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_5.getEnclosingFunction() = func
)
}

/*predicate func_6(Function func) {
exists(FunctionCall target_6 |
	exists(FunctionCall obj_0 | obj_0=target_6.getQualifier() |
		obj_0.getTarget().hasName("Check")
		and obj_0.getArgument(0).(StringLiteral).getValue()="base::CheckAdd(last_channel_id_, 1).AssignIfValid(&last_channel_id_)"
	)
	and target_6.getTarget().hasName("operator<<")
	and target_6.getArgument(0).(StringLiteral).getValue()="Overflow in channel_id!"
	and target_6.getEnclosingFunction() = func
)
}

*/
predicate func_7(Function func) {
exists(SwitchStmt target_7 |
	exists(BlockStmt obj_0 | obj_0=target_7.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("__builtin_expect")
				and obj_2.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
				and obj_2.getArgument(1).(Literal).getValue()="1"
			)
			and exists(ExprStmt obj_3 | obj_3=obj_1.getElse() |
				exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
					obj_4.getTarget().hasName("Check")
					and obj_4.getArgument(0).(StringLiteral).getValue()="sockets_.insert(std::make_pair(last_channel_id_, std::move(socket))) .second"
				)
			)
		)
		and obj_0.getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="0"
		and obj_0.getStmt(1).(SwitchCase).toString() = "default: "
	)
	and target_7.getExpr().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof DeclStmt
)
}

predicate func_8(Variable vlast_channel_id_, VariableAccess target_8) {
	target_8.getTarget()=vlast_channel_id_
}

from Function func, Variable vid_46, Variable vlast_channel_id_, VariableAccess target_0, VariableAccess target_1, Initializer target_2, VariableAccess target_8
where
func_0(vid_46, target_0)
and func_1(vid_46, target_1)
and func_2(vlast_channel_id_, target_2)
and not func_3(func)
and not func_5(func)
and not func_7(func)
and func_8(vlast_channel_id_, target_8)
and vid_46.getType().hasName("int")
and vlast_channel_id_.getType().hasName("int")
and vid_46.(LocalVariable).getFunction() = func
and not vlast_channel_id_.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
