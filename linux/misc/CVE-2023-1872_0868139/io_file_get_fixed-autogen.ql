/**
 * @name linux-08681391b84da27133deefaaddefd0acfa90c2be-io_file_get_fixed
 * @id cpp/linux/08681391b84da27133deefaaddefd0acfa90c2be/io-file-get-fixed
 * @description linux-08681391b84da27133deefaaddefd0acfa90c2be-io_file_get_fixed CVE-2023-1872
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(Initializer target_0 |
		target_0.getExpr() instanceof Literal
		and target_0.getExpr().getEnclosingFunction() = func)
}

predicate func_1(Parameter vctx_6878, NotExpr target_6, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(FunctionCall).getTarget().hasName("io_ring_submit_lock")
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_6878
		and target_1.getExpr().(FunctionCall).getArgument(1).(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_6.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(FunctionCall target_7, Function func) {
	exists(GotoStmt target_2 |
		target_2.getParent().(IfStmt).getCondition()=target_7
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vctx_6878, AddressOfExpr target_8, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(FunctionCall).getTarget().hasName("io_ring_submit_unlock")
		and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_6878
		and target_3.getExpr().(FunctionCall).getArgument(1).(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_8.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(FunctionCall target_7, Function func, ReturnStmt target_5) {
		target_5.getExpr() instanceof Literal
		and target_5.getParent().(IfStmt).getCondition()=target_7
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vctx_6878, NotExpr target_6) {
		target_6.getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getTarget().getName()="nr_user_files"
		and target_6.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_6.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6878
}

predicate func_7(Parameter vctx_6878, FunctionCall target_7) {
		target_7.getTarget().hasName("__builtin_expect")
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getTarget().getName()="nr_user_files"
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_7.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6878
		and target_7.getArgument(1).(Literal).getValue()="0"
}

predicate func_8(Parameter vctx_6878, AddressOfExpr target_8) {
		target_8.getOperand().(ValueFieldAccess).getTarget().getName()="file_table"
		and target_8.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_8.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6878
}

from Function func, Parameter vctx_6878, ReturnStmt target_5, NotExpr target_6, FunctionCall target_7, AddressOfExpr target_8
where
not func_0(func)
and not func_1(vctx_6878, target_6, func)
and not func_2(target_7, func)
and not func_3(vctx_6878, target_8, func)
and func_5(target_7, func, target_5)
and func_6(vctx_6878, target_6)
and func_7(vctx_6878, target_7)
and func_8(vctx_6878, target_8)
and vctx_6878.getType().hasName("io_ring_ctx *")
and vctx_6878.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
