/**
 * @name chromium-a707ac2d95e4726f4cf0267c9b0c038926c2a691-viz__HostFrameSinkManager__UnregisterFrameSinkHierarchy_
 * @id cpp/chromium/a707ac2d95e4726f4cf0267c9b0c038926c2a691/vizhostframesinkmanagerunregisterframesinkhierarchy
 * @description chromium-a707ac2d95e4726f4cf0267c9b0c038926c2a691-components/viz/service/frame_sinks/frame_sink_manager_impl.cc-viz__HostFrameSinkManager__UnregisterFrameSinkHierarchy_ CVE-2023-1810
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vchild_frame_sink_id_241, Initializer target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getExpr() |
		obj_0.getTarget().hasName("Contains")
		and obj_0.getArgument(0) instanceof ReferenceFieldAccess
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vchild_frame_sink_id_241
	)
}

predicate func_2(Function func) {
exists(ConditionDeclExpr target_2 |
	exists(FunctionCall obj_0 | obj_0=target_2.getChild(0) |
		obj_0.getTarget().hasName("operator bool")
		and obj_0.getQualifier().(VariableAccess).getType().hasName("CheckOpResult")
	)
	and target_2.getEnclosingFunction() = func
)
}

predicate func_4(Function func) {
exists(ConstructorCall target_4 |
	exists(FunctionCall obj_0 | obj_0=target_4.getArgument(0) |
		obj_0.getTarget().hasName("log_message")
		and obj_0.getQualifier().(VariableAccess).getType().hasName("CheckOpResult")
	)
	and target_4.getEnclosingFunction() = func
)
}

predicate func_5(Variable vparent_data_243, ReferenceFieldAccess target_5) {
	target_5.getTarget().getName()="children"
	and target_5.getQualifier().(VariableAccess).getTarget()=vparent_data_243
}

predicate func_6(Parameter vchild_frame_sink_id_241, Variable vparent_data_243, FunctionCall target_6) {
	exists(ReferenceFieldAccess obj_0 | obj_0=target_6.getArgument(0) |
		obj_0.getTarget().getName()="children"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vparent_data_243
	)
	and target_6.getTarget().hasName("Erase")
	and target_6.getArgument(1).(VariableAccess).getTarget()=vchild_frame_sink_id_241
}

predicate func_8(Variable vchecky_bool_lol_244, FunctionCall target_8) {
	target_8.getTarget().hasName("__builtin_expect")
	and target_8.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vchecky_bool_lol_244
	and target_8.getArgument(1).(Literal).getValue()="1"
}

predicate func_9(Function func, FunctionCall target_9) {
	target_9.getTarget().hasName("DCheck")
	and target_9.getArgument(0).(StringLiteral).getValue()="../../components/viz/host/host_frame_sink_manager.cc"
	and target_9.getArgument(1).(Literal).getValue()="244"
	and target_9.getArgument(2).(StringLiteral).getValue()="base::Contains(parent_data.children, child_frame_sink_id)"
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Function func, ExprStmt target_10) {
	target_10.getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

from Function func, Parameter vchild_frame_sink_id_241, Variable vparent_data_243, Variable vchecky_bool_lol_244, Initializer target_0, ReferenceFieldAccess target_5, FunctionCall target_6, FunctionCall target_8, FunctionCall target_9, ExprStmt target_10
where
func_0(vchild_frame_sink_id_241, target_0)
and not func_2(func)
and not func_4(func)
and func_5(vparent_data_243, target_5)
and func_6(vchild_frame_sink_id_241, vparent_data_243, target_6)
and func_8(vchecky_bool_lol_244, target_8)
and func_9(func, target_9)
and func_10(func, target_10)
and vchild_frame_sink_id_241.getType().hasName("const FrameSinkId &")
and vparent_data_243.getType().hasName("FrameSinkData &")
and vchecky_bool_lol_244.getType().hasName("const bool")
and vchild_frame_sink_id_241.getFunction() = func
and vparent_data_243.(LocalVariable).getFunction() = func
and vchecky_bool_lol_244.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
