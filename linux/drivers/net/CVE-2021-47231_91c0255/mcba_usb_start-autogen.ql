/**
 * @name linux-91c02557174be7f72e46ed7311e3bea1939840b0-mcba_usb_start
 * @id cpp/linux/91c02557174be7f72e46ed7311e3bea1939840b0/mcba-usb-start
 * @description linux-91c02557174be7f72e46ed7311e3bea1939840b0-drivers/net/can/usb/mcba_usb.c-mcba_usb_start CVE-2021-47231
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Variable vi_629, Variable vbuf_635, Parameter vpriv_626, ExprStmt target_6, PostfixIncrExpr target_7, ExprStmt target_8) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rxbuf"
	and target_2.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_626
	and target_2.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_629
	and target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vbuf_635
	and target_2.getLocation().isBefore(target_6.getLocation())
	and target_7.getOperand().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation())
	and target_8.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_3(Variable vi_629, Parameter vpriv_626, ExprStmt target_6, EqualityOperation target_9, ExprStmt target_10) {
exists(ExprStmt target_3 |
	target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="rxbuf_dma"
	and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_626
	and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_629
	and target_3.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("dma_addr_t")
	and target_3.getLocation().isBefore(target_6.getLocation())
	and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_9.getLeftOperand().(VariableAccess).getLocation())
	and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_4(Variable vurb_634, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="transfer_dma"
	and target_4.getQualifier().(VariableAccess).getTarget()=vurb_634
}

predicate func_5(Variable vurb_634, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="transfer_dma"
	and target_5.getQualifier().(VariableAccess).getTarget()=vurb_634
}

predicate func_6(Variable vurb_634, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("usb_free_urb")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vurb_634
}

predicate func_7(Variable vi_629, PostfixIncrExpr target_7) {
	target_7.getOperand().(VariableAccess).getTarget()=vi_629
}

predicate func_8(Variable vurb_634, Variable vbuf_635, Parameter vpriv_626, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("usb_free_coherent")
	and target_8.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="udev"
	and target_8.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_626
	and target_8.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="64"
	and target_8.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vbuf_635
	and target_8.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="transfer_dma"
	and target_8.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vurb_634
}

predicate func_9(Variable vi_629, EqualityOperation target_9) {
	target_9.getLeftOperand().(VariableAccess).getTarget()=vi_629
	and target_9.getRightOperand().(Literal).getValue()="0"
}

predicate func_10(Parameter vpriv_626, ExprStmt target_10) {
	target_10.getExpr().(FunctionCall).getTarget().hasName("mcba_usb_xmit_read_fw_ver")
	and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpriv_626
	and target_10.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
}

from Function func, Variable vi_629, Variable vurb_634, Variable vbuf_635, Parameter vpriv_626, PointerFieldAccess target_4, PointerFieldAccess target_5, ExprStmt target_6, PostfixIncrExpr target_7, ExprStmt target_8, EqualityOperation target_9, ExprStmt target_10
where
not func_2(vi_629, vbuf_635, vpriv_626, target_6, target_7, target_8)
and not func_3(vi_629, vpriv_626, target_6, target_9, target_10)
and func_4(vurb_634, target_4)
and func_5(vurb_634, target_5)
and func_6(vurb_634, target_6)
and func_7(vi_629, target_7)
and func_8(vurb_634, vbuf_635, vpriv_626, target_8)
and func_9(vi_629, target_9)
and func_10(vpriv_626, target_10)
and vi_629.getType().hasName("int")
and vurb_634.getType().hasName("urb *")
and vbuf_635.getType().hasName("u8 *")
and vpriv_626.getType().hasName("mcba_priv *")
and vi_629.(LocalVariable).getFunction() = func
and vurb_634.(LocalVariable).getFunction() = func
and vbuf_635.(LocalVariable).getFunction() = func
and vpriv_626.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
