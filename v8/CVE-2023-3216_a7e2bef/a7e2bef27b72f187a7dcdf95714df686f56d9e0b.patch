commit a7e2bef27b72f187a7dcdf95714df686f56d9e0b	a7e2bef27b72f187a7dcdf95714df686f56d9e0b
Author: Shu-yu Guo <syg@chromium.org>
Date:   Mon Jun 5 16:05:52 2023 -0700

    Check for encoding when appending in string builder
    
    Fixed: chromium:1450114
    Change-Id: I6d1a790b213d24d2737f4b268e8c35ba999f8adf
    Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/4591495
    Reviewed-by: Jakob Linke <jgruber@chromium.org>
    Reviewed-by: Jakob Kummerow <jkummerow@chromium.org>
    Commit-Queue: Shu-yu Guo <syg@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#88091}

diff --git a/src/strings/string-builder.cc b/src/strings/string-builder.cc
index 59a4253b1ab..83f42abd4c9 100644
--- a/src/strings/string-builder.cc
+++ b/src/strings/string-builder.cc
@@ -320,12 +320,21 @@ bool IncrementalStringBuilder::CanAppendByCopy(Handle<String> string) {
 void IncrementalStringBuilder::AppendStringByCopy(Handle<String> string) {
   DCHECK(CanAppendByCopy(string));
 
-  Handle<SeqOneByteString> part =
-      Handle<SeqOneByteString>::cast(current_part());
   {
     DisallowGarbageCollection no_gc;
-    String::WriteToFlat(*string, part->GetChars(no_gc) + current_index_, 0,
-                        string->length());
+    if (encoding_ == String::ONE_BYTE_ENCODING) {
+      String::WriteToFlat(
+          *string,
+          Handle<SeqOneByteString>::cast(current_part())->GetChars(no_gc) +
+              current_index_,
+          0, string->length());
+    } else {
+      String::WriteToFlat(
+          *string,
+          Handle<SeqTwoByteString>::cast(current_part())->GetChars(no_gc) +
+              current_index_,
+          0, string->length());
+    }
   }
   current_index_ += string->length();
   DCHECK(current_index_ <= part_length_);
