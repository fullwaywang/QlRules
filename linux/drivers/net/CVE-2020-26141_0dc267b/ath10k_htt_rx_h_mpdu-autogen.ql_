/**
 * @name linux-0dc267b13f3a7e8424a898815dd357211b737330-ath10k_htt_rx_h_mpdu
 * @id cpp/linux/0dc267b13f3a7e8424a898815dd357211b737330/ath10k-htt-rx-h-mpdu
 * @description linux-0dc267b13f3a7e8424a898815dd357211b737330-drivers/net/wireless/ath/ath10k/htt_rx.c-ath10k_htt_rx_h_mpdu CVE-2020-26141
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vstatus_1830, Parameter vfill_crypt_header_1831, Parameter vfrag_1835, Variable venctype_1842, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4, IfStmt target_5, IfStmt target_6, ExprStmt target_7) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vfrag_1835
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vfill_crypt_header_1831
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=venctype_1842
	and target_0.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flag"
	and target_0.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vstatus_1830
	and target_0.getThen().(ExprStmt).getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="4294967287"
	and target_0.getLocation().isBefore(target_2.getLocation())
	and target_3.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getLeftOperand().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getLocation())
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_5.getCondition().(VariableAccess).getLocation())
	and target_6.getCondition().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getLocation())
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vstatus_1830, Parameter vfill_crypt_header_1831, Parameter vfrag_1835, Variable venctype_1842, ExprStmt target_2, IfStmt target_5) {
exists(IfStmt target_1 |
	target_1.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vfrag_1835
	and target_1.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vfill_crypt_header_1831
	and target_1.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=venctype_1842
	and target_1.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flag"
	and target_1.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vstatus_1830
	and target_1.getThen().(ExprStmt).getExpr().(AssignAndExpr).getRValue().(BitwiseAndExpr).getValue()="4294967271"
	and target_2.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_1.getThen().(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_5.getCondition().(VariableAccess).getLocation().isBefore(target_1.getCondition().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vstatus_1830, Variable venctype_1842, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("ath10k_htt_rx_h_undecap")
	and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("ath10k *")
	and target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_2.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vstatus_1830
	and target_2.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("u8[64]")
	and target_2.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=venctype_1842
	and target_2.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("bool")
}

predicate func_3(Parameter vstatus_1830, ExprStmt target_3) {
	target_3.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flag"
	and target_3.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vstatus_1830
}

predicate func_4(Parameter vfill_crypt_header_1831, Parameter vfrag_1835, Variable venctype_1842, LogicalAndExpr target_4) {
	target_4.getLeftOperand().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vfrag_1835
	and target_4.getLeftOperand().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vfill_crypt_header_1831
	and target_4.getLeftOperand().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("bool")
	and target_4.getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=venctype_1842
}

predicate func_5(Parameter vfill_crypt_header_1831, IfStmt target_5) {
	target_5.getCondition().(VariableAccess).getTarget()=vfill_crypt_header_1831
}

predicate func_6(Parameter vfrag_1835, IfStmt target_6) {
	target_6.getCondition().(VariableAccess).getTarget()=vfrag_1835
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("bool")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ath10k_htt_rx_h_frag_multicast_check")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("ath10k *")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_6.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
}

predicate func_7(Variable venctype_1842, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("bool")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ath10k_htt_rx_h_frag_pn_check")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("ath10k *")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("sk_buff *")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u16")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=venctype_1842
}

from Function func, Parameter vstatus_1830, Parameter vfill_crypt_header_1831, Parameter vfrag_1835, Variable venctype_1842, ExprStmt target_2, ExprStmt target_3, LogicalAndExpr target_4, IfStmt target_5, IfStmt target_6, ExprStmt target_7
where
not func_0(vstatus_1830, vfill_crypt_header_1831, vfrag_1835, venctype_1842, target_2, target_3, target_4, target_5, target_6, target_7)
and not func_1(vstatus_1830, vfill_crypt_header_1831, vfrag_1835, venctype_1842, target_2, target_5)
and func_2(vstatus_1830, venctype_1842, target_2)
and func_3(vstatus_1830, target_3)
and func_4(vfill_crypt_header_1831, vfrag_1835, venctype_1842, target_4)
and func_5(vfill_crypt_header_1831, target_5)
and func_6(vfrag_1835, target_6)
and func_7(venctype_1842, target_7)
and vstatus_1830.getType().hasName("ieee80211_rx_status *")
and vfill_crypt_header_1831.getType().hasName("bool")
and vfrag_1835.getType().hasName("bool")
and venctype_1842.getType().hasName("htt_rx_mpdu_encrypt_type")
and vstatus_1830.getFunction() = func
and vfill_crypt_header_1831.getFunction() = func
and vfrag_1835.getFunction() = func
and venctype_1842.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
