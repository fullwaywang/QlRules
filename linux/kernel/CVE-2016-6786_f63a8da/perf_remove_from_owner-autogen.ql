/**
 * @name linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-perf_remove_from_owner
 * @id cpp/linux/f63a8daa5812afef4f06c962351687e1ff9ccb2b/perf-remove-from-owner
 * @description linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-kernel/events/core.c-perf_remove_from_owner CVE-2016-6786
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("rcu_read_lock")
	and not target_0.getTarget().hasName("__compiletime_assert")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vowner_3414, FunctionCall target_1) {
	target_1.getTarget().hasName("atomic_inc")
	and not target_1.getTarget().hasName("put_ctx")
	and target_1.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="usage"
	and target_1.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
}

/*predicate func_2(Variable vowner_3414, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="usage"
	and target_2.getQualifier().(VariableAccess).getTarget()=vowner_3414
}

*/
predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("rcu_read_unlock")
	and not target_3.getTarget().hasName("kfree_call_rcu")
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vevent_3412, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="owner"
	and target_4.getQualifier().(VariableAccess).getTarget()=vevent_3412
}

predicate func_5(BlockStmt target_29, Function func) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("atomic_dec_and_test")
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_5.getParent().(IfStmt).getThen()=target_29
	and target_5.getEnclosingFunction() = func)
}

predicate func_7(Function func) {
exists(PointerFieldAccess target_7 |
	target_7.getTarget().getName()="parent_ctx"
	and target_7.getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_7.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
exists(PointerFieldAccess target_8 |
	target_8.getTarget().getName()="parent_ctx"
	and target_8.getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_8.getEnclosingFunction() = func)
}

predicate func_10(Function func) {
exists(PointerFieldAccess target_10 |
	target_10.getTarget().getName()="task"
	and target_10.getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(VariableAccess target_21, Function func) {
exists(DoStmt target_11 |
	target_11.getCondition() instanceof Literal
	and target_11.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_11.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(VariableAccess).getType().hasName("bool")
	and target_11.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(3) instanceof DoStmt
	and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree_call_rcu")
	and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="callback_head"
	and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_11.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(BuiltInOperationBuiltInOffsetOf).getValue()="392"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_11
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
	and target_11.getEnclosingFunction() = func)
}

/*predicate func_13(VariableAccess target_23, Function func) {
exists(IfStmt target_13 |
	target_13.getCondition().(VariableAccess).getType().hasName("bool")
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_13
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
	and target_13.getEnclosingFunction() = func)
}

*/
/*predicate func_14(Function func) {
exists(AddressOfExpr target_14 |
	target_14.getOperand().(PointerFieldAccess).getTarget().getName()="callback_head"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event_context *")
	and target_14.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_14.getEnclosingFunction() = func)
}

*/
/*predicate func_15(Function func) {
exists(BuiltInOperationBuiltInOffsetOf target_15 |
	target_15.getValue()="392"
	and target_15.getEnclosingFunction() = func)
}

*/
predicate func_16(Function func, DoStmt target_16) {
	target_16.getCondition().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_20(Variable vowner_3414, Parameter vevent_3412, AssignExpr target_20) {
	target_20.getLValue().(VariableAccess).getTarget()=vowner_3414
	and target_20.getRValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="owner"
	and target_20.getRValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3412
}

predicate func_21(Variable vowner_3414, BlockStmt target_30, AddressOfExpr target_32, VariableAccess target_21) {
	target_21.getTarget()=vowner_3414
	and target_21.getParent().(IfStmt).getThen()=target_30
	and target_21.getLocation().isBefore(target_32.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_22(Function func, ExprStmt target_22) {
	target_22.getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

predicate func_23(Variable vowner_3414, BlockStmt target_29, AddressOfExpr target_32, AddressOfExpr target_33, VariableAccess target_23) {
	target_23.getTarget()=vowner_3414
	and target_23.getParent().(IfStmt).getThen()=target_29
	and target_32.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_23.getLocation())
	and target_23.getLocation().isBefore(target_33.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_24(Variable vowner_3414, VariableAccess target_23, ExprStmt target_24) {
	target_24.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
	and target_24.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_24.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
	and target_24.getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_24.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

predicate func_25(Parameter vevent_3412, FunctionCall target_25) {
	target_25.getTarget().hasName("list_del_init")
	and target_25.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="owner_entry"
	and target_25.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3412
}

predicate func_26(Variable vowner_3414, VariableAccess target_23, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_26.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_26.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
	and target_26.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

predicate func_27(Variable vowner_3414, VariableAccess target_23, ExprStmt target_27) {
	target_27.getExpr().(FunctionCall).getTarget().hasName("put_task_struct")
	and target_27.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vowner_3414
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

/*predicate func_28(Variable vowner_3414, AddressOfExpr target_34, VariableAccess target_28) {
	target_28.getTarget()=vowner_3414
	and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_task_struct")
	and target_34.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getLocation())
}

*/
predicate func_29(Parameter vevent_3412, BlockStmt target_29) {
	target_29.getStmt(0) instanceof ExprStmt
	and target_29.getStmt(1).(IfStmt).getCondition().(PointerFieldAccess).getTarget().getName()="owner"
	and target_29.getStmt(1).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vevent_3412
	and target_29.getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_29.getStmt(2) instanceof ExprStmt
}

predicate func_30(Function func, BlockStmt target_30) {
	target_30.getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_30.getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_30.getEnclosingFunction() = func
}

predicate func_32(Variable vowner_3414, AddressOfExpr target_32) {
	target_32.getOperand().(PointerFieldAccess).getTarget().getName()="usage"
	and target_32.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
}

predicate func_33(Variable vowner_3414, AddressOfExpr target_33) {
	target_33.getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_33.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
	and target_33.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_34(Variable vowner_3414, AddressOfExpr target_34) {
	target_34.getOperand().(PointerFieldAccess).getTarget().getName()="perf_event_mutex"
	and target_34.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vowner_3414
	and target_34.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Variable vowner_3414, Parameter vevent_3412, FunctionCall target_0, FunctionCall target_1, FunctionCall target_3, PointerFieldAccess target_4, DoStmt target_16, AssignExpr target_20, VariableAccess target_21, ExprStmt target_22, VariableAccess target_23, ExprStmt target_24, FunctionCall target_25, ExprStmt target_26, ExprStmt target_27, BlockStmt target_29, BlockStmt target_30, AddressOfExpr target_32, AddressOfExpr target_33, AddressOfExpr target_34
where
func_0(func, target_0)
and func_1(vowner_3414, target_1)
and func_3(func, target_3)
and func_4(vevent_3412, target_4)
and not func_5(target_29, func)
and not func_7(func)
and not func_8(func)
and not func_10(func)
and not func_11(target_21, func)
and func_16(func, target_16)
and func_20(vowner_3414, vevent_3412, target_20)
and func_21(vowner_3414, target_30, target_32, target_21)
and func_22(func, target_22)
and func_23(vowner_3414, target_29, target_32, target_33, target_23)
and func_24(vowner_3414, target_23, target_24)
and func_25(vevent_3412, target_25)
and func_26(vowner_3414, target_23, target_26)
and func_27(vowner_3414, target_23, target_27)
and func_29(vevent_3412, target_29)
and func_30(func, target_30)
and func_32(vowner_3414, target_32)
and func_33(vowner_3414, target_33)
and func_34(vowner_3414, target_34)
and vowner_3414.getType().hasName("task_struct *")
and vevent_3412.getType().hasName("perf_event *")
and vowner_3414.(LocalVariable).getFunction() = func
and vevent_3412.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
