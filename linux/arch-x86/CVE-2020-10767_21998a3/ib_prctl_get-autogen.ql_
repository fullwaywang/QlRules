/**
 * @name linux-21998a351512eba4ed5969006f0c55882d995ada-ib_prctl_get
 * @id cpp/linux/21998a351512eba4ed5969006f0c55882d995ada/ib-prctl-get
 * @description linux-21998a351512eba4ed5969006f0c55882d995ada-arch/x86/kernel/cpu/bugs.c-ib_prctl_get CVE-2020-10767
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vspectre_v2_user, VariableAccess target_0) {
	target_0.getTarget()=vspectre_v2_user
}

predicate func_1(Parameter vtask_1245, SwitchStmt target_10, Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getCondition().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_1.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getThen() instanceof ReturnStmt
	and target_1.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_1.getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof EnumConstantAccess
	and target_1.getElse().(IfStmt).getThen() instanceof ReturnStmt
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("spectre_v2_user_mitigation")
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("task_spec_ib_force_disable")
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_1245
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("task_spec_ib_disable")
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_1245
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(BitwiseOrExpr).getValue()="3"
	and target_1.getElse().(IfStmt).getElse().(IfStmt).getElse() instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_10.getLocation()))
}

predicate func_2(VariableAccess target_0, Function func, ReturnStmt target_2) {
	target_2.getExpr().(BinaryBitwiseOperation).getValue()="2"
	and target_2.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_0
	and target_2.getEnclosingFunction() = func
}

predicate func_3(VariableAccess target_0, Function func, ReturnStmt target_3) {
	target_3.getExpr().(BinaryBitwiseOperation).getValue()="4"
	and target_3.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_0
	and target_3.getEnclosingFunction() = func
}

predicate func_4(VariableAccess target_0, Function func, ReturnStmt target_4) {
	target_4.getExpr().(Literal).getValue()="0"
	and target_4.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_0
	and target_4.getEnclosingFunction() = func
}

predicate func_10(Parameter vtask_1245, Variable vspectre_v2_user, Function func, SwitchStmt target_10) {
	target_10.getExpr().(VariableAccess).getTarget()=vspectre_v2_user
	and target_10.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(1) instanceof ReturnStmt
	and target_10.getStmt().(BlockStmt).getStmt(2).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("task_spec_ib_force_disable")
	and target_10.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_1245
	and target_10.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(ReturnStmt).getExpr().(BitwiseOrExpr).getValue()="9"
	and target_10.getStmt().(BlockStmt).getStmt(5).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("task_spec_ib_disable")
	and target_10.getStmt().(BlockStmt).getStmt(5).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtask_1245
	and target_10.getStmt().(BlockStmt).getStmt(5).(IfStmt).getThen().(ReturnStmt).getExpr().(BitwiseOrExpr).getValue()="5"
	and target_10.getStmt().(BlockStmt).getStmt(6).(ReturnStmt).getExpr().(BitwiseOrExpr).getValue()="3"
	and target_10.getStmt().(BlockStmt).getStmt(7).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(8).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(9) instanceof ReturnStmt
	and target_10.getStmt().(BlockStmt).getStmt(10).(SwitchCase).toString() = "default: "
	and target_10.getStmt().(BlockStmt).getStmt(11) instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Function func, SwitchCase target_11) {
	target_11.getExpr() instanceof EnumConstantAccess
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_12(Function func, SwitchCase target_12) {
	target_12.getExpr() instanceof EnumConstantAccess
	and target_12.getEnclosingFunction() = func
}

*/
/*predicate func_13(Function func, SwitchCase target_13) {
	target_13.getExpr() instanceof EnumConstantAccess
	and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(Function func, SwitchCase target_14) {
	target_14.getExpr() instanceof EnumConstantAccess
	and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_15(Function func, SwitchCase target_15) {
	target_15.getExpr() instanceof EnumConstantAccess
	and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_16(Function func, SwitchCase target_16) {
	target_16.toString() = "default: "
	and target_16.getEnclosingFunction() = func
}

*/
from Function func, Parameter vtask_1245, Variable vspectre_v2_user, VariableAccess target_0, ReturnStmt target_2, ReturnStmt target_3, ReturnStmt target_4, SwitchStmt target_10
where
func_0(vspectre_v2_user, target_0)
and not func_1(vtask_1245, target_10, func)
and func_2(target_0, func, target_2)
and func_3(target_0, func, target_3)
and func_4(target_0, func, target_4)
and func_10(vtask_1245, vspectre_v2_user, func, target_10)
and vtask_1245.getType().hasName("task_struct *")
and vspectre_v2_user.getType().hasName("spectre_v2_user_mitigation")
and vtask_1245.getFunction() = func
and not vspectre_v2_user.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
