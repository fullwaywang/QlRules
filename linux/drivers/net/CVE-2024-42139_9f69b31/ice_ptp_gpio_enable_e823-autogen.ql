/**
 * @name linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-ice_ptp_gpio_enable_e823
 * @id cpp/linux/9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3/ice-ptp-gpio-enable-e823
 * @description linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-drivers/net/ethernet/intel/ice/ice_ptp.c-ice_ptp_gpio_enable_e823 CVE-2024-42139
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BuiltInOperationBuiltInOffsetOf target_0) {
	target_0.getValue()="2560"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func) {
exists(AssignExpr target_1 |
	exists(ValueFieldAccess obj_0 | obj_0=target_1.getLValue() |
		obj_0.getTarget().getName()="flags"
		and obj_0.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
	)
	and target_1.getRValue() instanceof ValueFieldAccess
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(Function func) {
exists(ExprStmt target_2 |
	exists(AssignExpr obj_0 | obj_0=target_2.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="gpio_pin"
			and obj_1.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
		)
		and obj_0.getRValue() instanceof Literal
	)
	and target_2.getEnclosingFunction() = func
)
}

predicate func_3(Function func) {
exists(ExprStmt target_3 |
	exists(AssignExpr obj_0 | obj_0=target_3.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="ena"
			and obj_1.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
		)
		and obj_0.getRValue() instanceof NotExpr
	)
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(Variable vpf_1890) {
exists(ExprStmt target_4 |
	exists(FunctionCall obj_0 | obj_0=target_4.getExpr() |
		obj_0.getTarget().hasName("ice_ptp_cfg_extts")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vpf_1890
		and obj_0.getArgument(1) instanceof ValueFieldAccess
		and obj_0.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ice_extts_channel")
	)
)
}

predicate func_5(Function func) {
exists(ReturnStmt target_5 |
	target_5.getExpr() instanceof Literal
	and target_5.getEnclosingFunction() = func
)
}

predicate func_6(Variable vclk_cfg_1891, PointerFieldAccess target_21, ExprStmt target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="gpio_pin"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1891
		)
		and obj_0.getRValue().(Literal).getValue()="5"
	)
	and target_6.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
}

predicate func_7(Variable vclk_cfg_1891, PointerFieldAccess target_21, ExprStmt target_7) {
	exists(AssignExpr obj_0 | obj_0=target_7.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="period"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1891
		)
		and obj_0.getRValue().(Literal).getValue()="1000000000"
	)
	and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
}

predicate func_8(Parameter von_1888, Variable vclk_cfg_1891, PointerFieldAccess target_21, ExprStmt target_8) {
	exists(AssignExpr obj_0 | obj_0=target_8.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="ena"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1891
		)
		and obj_0.getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=von_1888
	)
	and target_8.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
}

predicate func_9(Variable vpf_1890, Variable vclk_cfg_1891, Variable verr_1892, PointerFieldAccess target_21, ExprStmt target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("ice_ptp_cfg_clkout")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vpf_1890
			and obj_1.getArgument(1).(Literal).getValue()="3"
			and obj_1.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vclk_cfg_1891
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=verr_1892
	)
	and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
}

/*predicate func_10(Parameter vrq_1888, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="(unknown field)"
	and target_10.getQualifier().(VariableAccess).getTarget()=vrq_1888
	and target_10.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

*/
/*predicate func_11(Parameter vrq_1888, PointerFieldAccess target_11) {
	target_11.getTarget().getName()="(unknown field)"
	and target_11.getQualifier().(VariableAccess).getTarget()=vrq_1888
	and target_11.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

*/
predicate func_12(Parameter von_1888, NotExpr target_12) {
	target_12.getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=von_1888
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_13(Parameter vrq_1888, ValueFieldAccess target_13) {
	exists(ValueFieldAccess obj_0 | obj_0=target_13.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="(unknown field)"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vrq_1888
		)
		and obj_0.getTarget().getName()="extts"
	)
	and target_13.getTarget().getName()="index"
}

predicate func_14(Parameter vrq_1888, ValueFieldAccess target_14) {
	exists(ValueFieldAccess obj_0 | obj_0=target_14.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="(unknown field)"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vrq_1888
		)
		and obj_0.getTarget().getName()="extts"
	)
	and target_14.getTarget().getName()="flags"
}

predicate func_15(PointerFieldAccess target_21, Function func, BreakStmt target_15) {
	target_15.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
	and target_15.getEnclosingFunction() = func
}

predicate func_16(Variable vpf_1890, VariableAccess target_16) {
	target_16.getTarget()=vpf_1890
	and target_16.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_19(Variable vpf_1890, Variable verr_1892, AssignExpr target_19) {
	exists(FunctionCall obj_0 | obj_0=target_19.getRValue() |
		obj_0.getTarget().hasName("ice_ptp_cfg_extts")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vpf_1890
		and obj_0.getArgument(1) instanceof NotExpr
		and obj_0.getArgument(2) instanceof ValueFieldAccess
		and obj_0.getArgument(3) instanceof Literal
		and obj_0.getArgument(4) instanceof ValueFieldAccess
	)
	and target_19.getLValue().(VariableAccess).getTarget()=verr_1892
}

predicate func_20(PointerFieldAccess target_21, Function func, BreakStmt target_20) {
	target_20.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_21
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Parameter vrq_1888, PointerFieldAccess target_21) {
	target_21.getTarget().getName()="type"
	and target_21.getQualifier().(VariableAccess).getTarget()=vrq_1888
}

from Function func, Parameter vrq_1888, Parameter von_1888, Variable vpf_1890, Variable vclk_cfg_1891, Variable verr_1892, BuiltInOperationBuiltInOffsetOf target_0, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9, NotExpr target_12, ValueFieldAccess target_13, ValueFieldAccess target_14, BreakStmt target_15, VariableAccess target_16, AssignExpr target_19, BreakStmt target_20, PointerFieldAccess target_21
where
func_0(func, target_0)
and not func_1(func)
and not func_2(func)
and not func_3(func)
and not func_4(vpf_1890)
and not func_5(func)
and func_6(vclk_cfg_1891, target_21, target_6)
and func_7(vclk_cfg_1891, target_21, target_7)
and func_8(von_1888, vclk_cfg_1891, target_21, target_8)
and func_9(vpf_1890, vclk_cfg_1891, verr_1892, target_21, target_9)
and func_12(von_1888, target_12)
and func_13(vrq_1888, target_13)
and func_14(vrq_1888, target_14)
and func_15(target_21, func, target_15)
and func_16(vpf_1890, target_16)
and func_19(vpf_1890, verr_1892, target_19)
and func_20(target_21, func, target_20)
and func_21(vrq_1888, target_21)
and vrq_1888.getType().hasName("ptp_clock_request *")
and von_1888.getType().hasName("int")
and vpf_1890.getType().hasName("ice_pf *")
and vclk_cfg_1891.getType().hasName("ice_perout_channel")
and verr_1892.getType().hasName("int")
and vrq_1888.getFunction() = func
and von_1888.getFunction() = func
and vpf_1890.(LocalVariable).getFunction() = func
and vclk_cfg_1891.(LocalVariable).getFunction() = func
and verr_1892.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
