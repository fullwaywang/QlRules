/**
 * @name linux-ac4dfccb96571ca03af7cac64b7a0b2952c97f3a-xtensa_stack
 * @id cpp/linux/ac4dfccb96571ca03af7cac64b7a0b2952c97f3a/xtensa-stack
 * @description linux-ac4dfccb96571ca03af7cac64b7a0b2952c97f3a-sound/soc/sof/xtensa/core.c-xtensa_stack CVE-2021-47381
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_116, MulExpr target_0) {
	target_0.getLeftOperand().(VariableAccess).getTarget()=vi_116
	and target_0.getRightOperand().(Literal).getValue()="4"
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("hex_dump_to_buffer")
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="16"
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="16"
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="4"
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("unsigned char[36]")
	and target_0.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(SizeofExprOperator).getValue()="36"
}

predicate func_1(Variable vi_116, VariableAccess target_1) {
	target_1.getTarget()=vi_116
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_err")
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("snd_sof_dev *")
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="0x%08x: %s\n"
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u32")
	and target_1.getParent().(AddExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("unsigned char[36]")
}

from Function func, Variable vi_116, MulExpr target_0, VariableAccess target_1
where
func_0(vi_116, target_0)
and func_1(vi_116, target_1)
and vi_116.getType().hasName("int")
and vi_116.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
