/**
 * @name linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-keyring_clear
 * @id cpp/linux/b2a4df200d570b2c33a57e1ebfa5896e4bc81b69/keyring-clear
 * @description linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-security/keys/keyring.c-keyring_clear CVE-2014-3631
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkeyring_1131, ExprStmt target_28, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="payload"
		and target_0.getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_0.getQualifier().(VariableAccess).getLocation().isBefore(target_28.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_1(Function func, FunctionCall target_1) {
		target_1.getTarget().hasName("lockdep_rcu_suspicious")
		and not target_1.getTarget().hasName("assoc_array_apply_edit")
		and target_1.getArgument(0) instanceof StringLiteral
		and target_1.getArgument(1) instanceof Literal
		and target_1.getArgument(2).(StringLiteral).getValue()="suspicious rcu_dereference_protected() usage"
		and target_1.getEnclosingFunction() = func
}

predicate func_3(BlockStmt target_35, Function func) {
	exists(EqualityOperation target_3 |
		target_3.getAnOperand() instanceof ValueFieldAccess
		and target_3.getAnOperand() instanceof AddressOfExpr
		and target_3.getParent().(IfStmt).getThen()=target_35
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(VariableAccess target_27, Function func) {
	exists(ReturnStmt target_4 |
		target_4.getExpr() instanceof UnaryMinusExpr
		and target_4.getParent().(IfStmt).getCondition()=target_27
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Parameter vkeyring_1131, AddressOfExpr target_36, ExprStmt target_28) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(VariableAccess).getType().hasName("assoc_array_edit *")
		and target_5.getRValue().(FunctionCall).getTarget().hasName("assoc_array_clear")
		and target_5.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="keys"
		and target_5.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_5.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_5.getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("const assoc_array_ops")
		and target_36.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(BlockStmt target_37, Function func) {
	exists(FunctionCall target_6 |
		target_6.getTarget().hasName("IS_ERR")
		and target_6.getArgument(0).(VariableAccess).getType().hasName("assoc_array_edit *")
		and target_6.getParent().(IfStmt).getThen()=target_37
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(Variable vret_1134) {
	exists(FunctionCall target_7 |
		target_7.getTarget().hasName("PTR_ERR")
		and target_7.getArgument(0).(VariableAccess).getType().hasName("assoc_array_edit *")
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1134)
}

/*predicate func_10(Parameter vkeyring_1131, ValueFieldAccess target_10) {
		target_10.getTarget().getName()="type"
		and target_10.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_10.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_10.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
}

*/
predicate func_11(Variable vkey_type_keyring, Parameter vkeyring_1131, BlockStmt target_37, AddressOfExpr target_11) {
		target_11.getOperand().(VariableAccess).getTarget()=vkey_type_keyring
		and target_11.getParent().(EQExpr).getAnOperand().(ValueFieldAccess).getTarget().getName()="type"
		and target_11.getParent().(EQExpr).getAnOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_11.getParent().(EQExpr).getAnOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_11.getParent().(EQExpr).getAnOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_11.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_37
}

predicate func_12(Parameter vkeyring_1131, PointerFieldAccess target_12) {
		target_12.getTarget().getName()="sem"
		and target_12.getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_12.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_13(Variable vret_1134, UnaryMinusExpr target_13) {
		target_13.getValue()="-20"
		and target_13.getParent().(AssignExpr).getRValue() = target_13
		and target_13.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1134
}

predicate func_14(Parameter vkeyring_1131, EqualityOperation target_19, ExprStmt target_14) {
		target_14.getExpr().(FunctionCall).getTarget().hasName("down_write")
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

predicate func_15(Parameter vkeyring_1131, EqualityOperation target_19, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("up_write")
		and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_15.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

predicate func_16(Variable vret_1134, EqualityOperation target_19, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1134
		and target_16.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

predicate func_18(Variable vret_1134, Function func, ExprStmt target_18) {
		target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1134
		and target_18.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

predicate func_19(BlockStmt target_37, Function func, EqualityOperation target_19) {
		target_19.getAnOperand() instanceof ValueFieldAccess
		and target_19.getAnOperand() instanceof AddressOfExpr
		and target_19.getParent().(IfStmt).getThen()=target_37
		and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable vklist_1133, Parameter vkeyring_1131, AssignExpr target_20) {
		target_20.getLValue().(VariableAccess).getTarget()=vklist_1133
		and target_20.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
		and target_20.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_20.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_20.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
}

/*predicate func_21(Variable v__warned_1141, DoStmt target_21) {
		target_21.getCondition() instanceof Literal
		and target_21.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_21.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_1141
		and target_21.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("rwsem_is_locked")
		and target_21.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__warned_1141
		and target_21.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
}

*/
/*predicate func_23(Variable v__warned_1141, Parameter vkeyring_1131, BlockStmt target_38, LogicalAndExpr target_23) {
		target_23.getAnOperand().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("debug_lockdep_rcu_enabled")
		and target_23.getAnOperand().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__warned_1141
		and target_23.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("rwsem_is_locked")
		and target_23.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_23.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_23.getParent().(IfStmt).getThen()=target_38
}

*/
/*predicate func_24(Variable v__warned_1141, AssignExpr target_24) {
		target_24.getLValue().(VariableAccess).getTarget()=v__warned_1141
}

*/
/*predicate func_26(Parameter vkeyring_1131, ExprStmt target_26) {
		target_26.getExpr().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_26.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_26.getExpr().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
}

*/
predicate func_27(Variable vklist_1133, BlockStmt target_35, IfStmt target_33, VariableAccess target_27) {
		target_27.getTarget()=vklist_1133
		and target_27.getParent().(IfStmt).getThen()=target_35
		and target_27.getLocation().isBefore(target_33.getCondition().(VariableAccess).getLocation())
}

predicate func_28(Parameter vkeyring_1131, VariableAccess target_27, ExprStmt target_28) {
		target_28.getExpr().(FunctionCall).getTarget().hasName("key_payload_reserve")
		and target_28.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkeyring_1131
		and target_28.getExpr().(FunctionCall).getArgument(1).(SizeofTypeOperator).getType() instanceof LongType
		and target_28.getExpr().(FunctionCall).getArgument(1).(SizeofTypeOperator).getValue()="24"
		and target_28.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

/*predicate func_29(Function func, SizeofTypeOperator target_29) {
		target_29.getType() instanceof LongType
		and target_29.getValue()="24"
		and target_29.getEnclosingFunction() = func
}

*/
predicate func_30(Parameter vkeyring_1131, VariableAccess target_27, DoStmt target_30) {
		target_30.getCondition().(Literal).getValue()="0"
		and target_30.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_30.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_30.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_30.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_30.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

/*predicate func_32(Parameter vkeyring_1131, ExprStmt target_32) {
		target_32.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="subscriptions"
		and target_32.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="payload"
		and target_32.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_32.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

*/
predicate func_33(Variable vklist_1133, EqualityOperation target_19, IfStmt target_33) {
		target_33.getCondition().(VariableAccess).getTarget()=vklist_1133
		and target_33.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("call_rcu_sched")
		and target_33.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_33.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vklist_1133
		and target_33.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

/*predicate func_34(Variable vklist_1133, FunctionCall target_34) {
		target_34.getTarget().hasName("call_rcu_sched")
		and target_34.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_34.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vklist_1133
}

*/
predicate func_35(Function func, BlockStmt target_35) {
		target_35.getStmt(0) instanceof ExprStmt
		and target_35.getStmt(1) instanceof DoStmt
		and target_35.getEnclosingFunction() = func
}

predicate func_36(Parameter vkeyring_1131, AddressOfExpr target_36) {
		target_36.getOperand().(PointerFieldAccess).getTarget().getName()="sem"
		and target_36.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_1131
		and target_36.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_37(Variable vklist_1133, BlockStmt target_37) {
		target_37.getStmt(0) instanceof ExprStmt
		and target_37.getStmt(1).(ExprStmt).getExpr() instanceof AssignExpr
		and target_37.getStmt(2).(IfStmt).getCondition().(VariableAccess).getTarget()=vklist_1133
		and target_37.getStmt(2).(IfStmt).getThen() instanceof BlockStmt
		and target_37.getStmt(3) instanceof ExprStmt
}

predicate func_38(Function func, BlockStmt target_38) {
		target_38.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
		and target_38.getStmt(1).(ExprStmt).getExpr() instanceof FunctionCall
		and target_38.getEnclosingFunction() = func
}

from Function func, Variable vret_1134, Variable vkey_type_keyring, Variable v__warned_1141, Variable vklist_1133, Parameter vkeyring_1131, PointerFieldAccess target_0, FunctionCall target_1, AddressOfExpr target_11, PointerFieldAccess target_12, UnaryMinusExpr target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_18, EqualityOperation target_19, AssignExpr target_20, VariableAccess target_27, ExprStmt target_28, DoStmt target_30, IfStmt target_33, BlockStmt target_35, AddressOfExpr target_36, BlockStmt target_37, BlockStmt target_38
where
func_0(vkeyring_1131, target_28, target_0)
and func_1(func, target_1)
and not func_3(target_35, func)
and not func_4(target_27, func)
and not func_5(vkeyring_1131, target_36, target_28)
and not func_6(target_37, func)
and not func_7(vret_1134)
and func_11(vkey_type_keyring, vkeyring_1131, target_37, target_11)
and func_12(vkeyring_1131, target_12)
and func_13(vret_1134, target_13)
and func_14(vkeyring_1131, target_19, target_14)
and func_15(vkeyring_1131, target_19, target_15)
and func_16(vret_1134, target_19, target_16)
and func_18(vret_1134, func, target_18)
and func_19(target_37, func, target_19)
and func_20(vklist_1133, vkeyring_1131, target_20)
and func_27(vklist_1133, target_35, target_33, target_27)
and func_28(vkeyring_1131, target_27, target_28)
and func_30(vkeyring_1131, target_27, target_30)
and func_33(vklist_1133, target_19, target_33)
and func_35(func, target_35)
and func_36(vkeyring_1131, target_36)
and func_37(vklist_1133, target_37)
and func_38(func, target_38)
and vret_1134.getType().hasName("int")
and vkey_type_keyring.getType().hasName("key_type")
and v__warned_1141.getType().hasName("bool")
and vklist_1133.getType().hasName("keyring_list *")
and vkeyring_1131.getType().hasName("key *")
and vret_1134.(LocalVariable).getFunction() = func
and not vkey_type_keyring.getParentScope+() = func
and v__warned_1141.(LocalVariable).getFunction() = func
and vklist_1133.(LocalVariable).getFunction() = func
and vkeyring_1131.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
