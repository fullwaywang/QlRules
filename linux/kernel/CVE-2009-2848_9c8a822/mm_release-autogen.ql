/**
 * @name linux-9c8a8228d0827e0d91d28527209988f672f97d28-mm_release
 * @id cpp/linux/9c8a8228d0827e0d91d28527209988f672f97d28/mm-release
 * @description linux-9c8a8228d0827e0d91d28527209988f672f97d28-kernel/fork.c-mm_release CVE-2009-2848
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vmm_542, Parameter vtsk_542, LogicalAndExpr target_47) {
	exists(IfStmt target_1 |
		target_1.getCondition().(LogicalAndExpr).getAnOperand() instanceof NotExpr
		and target_1.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getTarget().hasName("atomic_read")
		and target_1.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mm_users"
		and target_1.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmm_542
		and target_1.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(4) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(6) instanceof LabelStmt
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(7) instanceof ExprStmt
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sys_futex")
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="clear_child_tid"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="0"
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_47)
}

/*predicate func_2(Parameter vtsk_542, LogicalAndExpr target_47, ExprStmt target_48) {
	exists(PointerDereferenceExpr target_2 |
		target_2.getOperand().(PointerFieldAccess).getTarget().getName()="clear_child_tid"
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_48.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_4(Parameter vtsk_542, ExprStmt target_48) {
	exists(PointerFieldAccess target_4 |
		target_4.getTarget().getName()="clear_child_tid"
		and target_4.getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_48.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_14(Function func, ExprStmt target_14) {
		target_14.getExpr().(Literal).getValue()="0"
		and target_14.getEnclosingFunction() = func
}

predicate func_15(Function func, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("might_fault")
		and target_15.getEnclosingFunction() = func
}

predicate func_16(Function func, SwitchCase target_16) {
		target_16.getExpr().(Literal).getValue()="2"
		and target_16.getEnclosingFunction() = func
}

predicate func_17(Function func, SwitchCase target_17) {
		target_17.getExpr().(Literal).getValue()="4"
		and target_17.getEnclosingFunction() = func
}

predicate func_18(Function func, SwitchCase target_18) {
		target_18.getExpr().(Literal).getValue()="8"
		and target_18.getEnclosingFunction() = func
}

predicate func_19(Parameter vtsk_542, PointerFieldAccess target_19) {
		target_19.getTarget().getName()="clear_child_tid"
		and target_19.getQualifier().(VariableAccess).getTarget()=vtsk_542
}

predicate func_20(Parameter vtsk_542, NotExpr target_20) {
		target_20.getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_20.getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_20.getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1024"
}

predicate func_21(Parameter vtsk_542, PointerFieldAccess target_21) {
		target_21.getTarget().getName()="clear_child_tid"
		and target_21.getQualifier().(VariableAccess).getTarget()=vtsk_542
}

predicate func_23(Function func, SwitchCase target_23) {
		target_23.getExpr().(Literal).getValue()="1"
		and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable v__ret_pu_581, ExprStmt target_24) {
		target_24.getExpr().(VariableAccess).getTarget()=v__ret_pu_581
}

predicate func_26(Variable v__pu_val_581, ExprStmt target_26) {
		target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__pu_val_581
		and target_26.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_27(SizeofExprOperator target_49, Function func, BreakStmt target_27) {
		target_27.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
		and target_27.getEnclosingFunction() = func
}

predicate func_28(SizeofExprOperator target_49, Function func, BreakStmt target_28) {
		target_28.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
		and target_28.getEnclosingFunction() = func
}

predicate func_29(SizeofExprOperator target_49, Function func, BreakStmt target_29) {
		target_29.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
		and target_29.getEnclosingFunction() = func
}

predicate func_30(SizeofExprOperator target_49, Function func, BreakStmt target_30) {
		target_30.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
		and target_30.getEnclosingFunction() = func
}

predicate func_31(Function func, SwitchCase target_31) {
		target_31.toString() = "default: "
		and target_31.getEnclosingFunction() = func
}

predicate func_32(SizeofExprOperator target_49, Function func, BreakStmt target_32) {
		target_32.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
		and target_32.getEnclosingFunction() = func
}

predicate func_33(Parameter vmm_542, Parameter vtsk_542, BlockStmt target_50, LogicalAndExpr target_33) {
		target_33.getAnOperand().(PointerFieldAccess).getTarget().getName()="clear_child_tid"
		and target_33.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_33.getAnOperand() instanceof NotExpr
		and target_33.getParent().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getTarget().hasName("atomic_read")
		and target_33.getParent().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mm_users"
		and target_33.getParent().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmm_542
		and target_33.getParent().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1"
		and target_33.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_50
}

predicate func_34(LogicalAndExpr target_47, Function func, DeclStmt target_34) {
		target_34.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_47
		and target_34.getEnclosingFunction() = func
}

predicate func_35(Variable vtidptr_574, PointerDereferenceExpr target_35) {
		target_35.getOperand().(VariableAccess).getTarget()=vtidptr_574
}

predicate func_36(Variable v__pu_val_581, VariableAccess target_36) {
		target_36.getTarget()=v__pu_val_581
}

predicate func_37(Variable vtidptr_574, VariableAccess target_37) {
		target_37.getTarget()=vtidptr_574
}

predicate func_38(Variable v__pu_val_581, VariableAccess target_38) {
		target_38.getTarget()=v__pu_val_581
}

predicate func_39(Variable vtidptr_574, VariableAccess target_39) {
		target_39.getTarget()=vtidptr_574
}

predicate func_40(Variable v__pu_val_581, VariableAccess target_40) {
		target_40.getTarget()=v__pu_val_581
}

predicate func_41(Variable vtidptr_574, VariableAccess target_41) {
		target_41.getTarget()=vtidptr_574
}

predicate func_42(Variable v__pu_val_581, VariableAccess target_42) {
		target_42.getTarget()=v__pu_val_581
}

predicate func_43(Variable vtidptr_574, VariableAccess target_43) {
		target_43.getTarget()=vtidptr_574
}

predicate func_44(Variable v__pu_val_581, VariableAccess target_44) {
		target_44.getTarget()=v__pu_val_581
}

predicate func_45(Variable vtidptr_574, ExprStmt target_51, VariableAccess target_45) {
		target_45.getTarget()=vtidptr_574
		and target_45.getLocation().isBefore(target_51.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_46(Variable vtidptr_574, AsmStmt target_52, VariableAccess target_46) {
		target_46.getTarget()=vtidptr_574
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sys_futex")
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
		and target_46.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="0"
		and target_52.getChild(2).(VariableAccess).getLocation().isBefore(target_46.getLocation())
}

predicate func_47(Parameter vmm_542, LogicalAndExpr target_47) {
		target_47.getAnOperand() instanceof LogicalAndExpr
		and target_47.getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getTarget().hasName("atomic_read")
		and target_47.getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mm_users"
		and target_47.getAnOperand().(RelationalOperation).getGreaterOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmm_542
		and target_47.getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="1"
}

predicate func_48(Parameter vtsk_542, ExprStmt target_48) {
		target_48.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="clear_child_tid"
		and target_48.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_48.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_49(Function func, SizeofExprOperator target_49) {
		target_49.getValue()="4"
		and target_49.getEnclosingFunction() = func
}

predicate func_50(Parameter vtsk_542, BlockStmt target_50) {
		target_50.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="clear_child_tid"
		and target_50.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtsk_542
		and target_50.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(4) instanceof ExprStmt
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getExpr().(SizeofExprOperator).getValue()="4"
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(0) instanceof SwitchCase
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(2) instanceof BreakStmt
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(3) instanceof SwitchCase
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(5) instanceof BreakStmt
		and target_50.getStmt(2).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(5).(SwitchStmt).getStmt().(BlockStmt).getStmt(6) instanceof SwitchCase
}

predicate func_51(Variable vtidptr_574, ExprStmt target_51) {
		target_51.getExpr().(FunctionCall).getTarget().hasName("sys_futex")
		and target_51.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtidptr_574
		and target_51.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and target_51.getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
		and target_51.getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
		and target_51.getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
		and target_51.getExpr().(FunctionCall).getArgument(5).(Literal).getValue()="0"
}

predicate func_52(Variable v__ret_pu_581, Variable v__pu_val_581, Variable vtidptr_574, SizeofExprOperator target_49, AsmStmt target_52) {
		target_52.getChild(0).(VariableAccess).getTarget()=v__ret_pu_581
		and target_52.getChild(1).(VariableAccess).getTarget()=v__pu_val_581
		and target_52.getChild(2).(VariableAccess).getTarget()=vtidptr_574
		and target_52.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_49
}

from Function func, Variable v__ret_pu_581, Variable v__pu_val_581, Parameter vmm_542, Variable vtidptr_574, Parameter vtsk_542, ExprStmt target_14, ExprStmt target_15, SwitchCase target_16, SwitchCase target_17, SwitchCase target_18, PointerFieldAccess target_19, NotExpr target_20, PointerFieldAccess target_21, SwitchCase target_23, ExprStmt target_24, ExprStmt target_26, BreakStmt target_27, BreakStmt target_28, BreakStmt target_29, BreakStmt target_30, SwitchCase target_31, BreakStmt target_32, LogicalAndExpr target_33, DeclStmt target_34, PointerDereferenceExpr target_35, VariableAccess target_36, VariableAccess target_37, VariableAccess target_38, VariableAccess target_39, VariableAccess target_40, VariableAccess target_41, VariableAccess target_42, VariableAccess target_43, VariableAccess target_44, VariableAccess target_45, VariableAccess target_46, LogicalAndExpr target_47, ExprStmt target_48, SizeofExprOperator target_49, BlockStmt target_50, ExprStmt target_51, AsmStmt target_52
where
not func_1(vmm_542, vtsk_542, target_47)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(func, target_16)
and func_17(func, target_17)
and func_18(func, target_18)
and func_19(vtsk_542, target_19)
and func_20(vtsk_542, target_20)
and func_21(vtsk_542, target_21)
and func_23(func, target_23)
and func_24(v__ret_pu_581, target_24)
and func_26(v__pu_val_581, target_26)
and func_27(target_49, func, target_27)
and func_28(target_49, func, target_28)
and func_29(target_49, func, target_29)
and func_30(target_49, func, target_30)
and func_31(func, target_31)
and func_32(target_49, func, target_32)
and func_33(vmm_542, vtsk_542, target_50, target_33)
and func_34(target_47, func, target_34)
and func_35(vtidptr_574, target_35)
and func_36(v__pu_val_581, target_36)
and func_37(vtidptr_574, target_37)
and func_38(v__pu_val_581, target_38)
and func_39(vtidptr_574, target_39)
and func_40(v__pu_val_581, target_40)
and func_41(vtidptr_574, target_41)
and func_42(v__pu_val_581, target_42)
and func_43(vtidptr_574, target_43)
and func_44(v__pu_val_581, target_44)
and func_45(vtidptr_574, target_51, target_45)
and func_46(vtidptr_574, target_52, target_46)
and func_47(vmm_542, target_47)
and func_48(vtsk_542, target_48)
and func_49(func, target_49)
and func_50(vtsk_542, target_50)
and func_51(vtidptr_574, target_51)
and func_52(v__ret_pu_581, v__pu_val_581, vtidptr_574, target_49, target_52)
and v__ret_pu_581.getType().hasName("int")
and v__pu_val_581.getType().hasName("u32")
and vmm_542.getType().hasName("mm_struct *")
and vtidptr_574.getType().hasName("u32 *")
and vtsk_542.getType().hasName("task_struct *")
and v__ret_pu_581.(LocalVariable).getFunction() = func
and v__pu_val_581.(LocalVariable).getFunction() = func
and vmm_542.getFunction() = func
and vtidptr_574.(LocalVariable).getFunction() = func
and vtsk_542.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
