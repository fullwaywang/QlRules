/**
 * @name linux-87797fad6cce28ec9be3c13f031776ff4f104cfc-xen_irq_lateeoi_worker
 * @id cpp/linux/87797fad6cce28ec9be3c13f031776ff4f104cfc/xen-irq-lateeoi-worker
 * @description linux-87797fad6cce28ec9be3c13f031776ff4f104cfc-drivers/xen/events/events_base.c-xen_irq_lateeoi_worker CVE-2023-34324
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vflags_667, Variable vevtchn_rwlock, FunctionCall target_0) {
	target_0.getTarget().hasName("_raw_read_lock_irqsave")
	and not target_0.getTarget().hasName("_raw_spin_lock_irqsave")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vevtchn_rwlock
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vflags_667
}

predicate func_1(Function func, FunctionCall target_1) {
	target_1.getTarget().hasName("spin_lock")
	and not target_1.getTarget().hasName("rcu_read_lock")
	and target_1.getArgument(0) instanceof AddressOfExpr
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable veoi_664, FunctionCall target_2) {
	target_2.getTarget().hasName("spin_unlock")
	and not target_2.getTarget().hasName("spin_unlock_irqrestore")
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="eoi_list_lock"
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=veoi_664
}

predicate func_3(Variable veoi_664, FunctionCall target_3) {
	target_3.getTarget().hasName("spin_unlock")
	and not target_3.getTarget().hasName("spin_unlock_irqrestore")
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="eoi_list_lock"
	and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=veoi_664
}

predicate func_4(Variable vflags_667, Variable vevtchn_rwlock, FunctionCall target_4) {
	target_4.getTarget().hasName("_raw_read_unlock_irqrestore")
	and not target_4.getTarget().hasName("rcu_read_unlock")
	and target_4.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vevtchn_rwlock
	and target_4.getArgument(1).(VariableAccess).getTarget()=vflags_667
}

predicate func_5(ExprStmt target_25, Function func, ExprStmt target_5) {
	target_5.getExpr() instanceof FunctionCall
	and target_5.getLocation().isBefore(target_25.getLocation())
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Function func) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("spinlock_check")
	and target_6.getArgument(0) instanceof AddressOfExpr
	and target_6.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_6.getEnclosingFunction() = func)
}

predicate func_7(LogicalOrExpr target_16, Function func) {
exists(BreakStmt target_7 |
	target_7.getParent().(IfStmt).getCondition()=target_16
	and target_7.getEnclosingFunction() = func)
}

predicate func_9(Variable v__dummy_671, Variable v__dummy2_671, ExprStmt target_9) {
	target_9.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy_671
	and target_9.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy2_671
	and target_9.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
}

predicate func_10(Variable veoi_664, AddressOfExpr target_10) {
	target_10.getOperand().(PointerFieldAccess).getTarget().getName()="eoi_list_lock"
	and target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=veoi_664
	and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_11(Variable vinfo_665, Variable vnow_666, BlockStmt target_26, EqualityOperation target_11) {
	target_11.getLeftOperand().(VariableAccess).getTarget()=vinfo_665
	and target_11.getRightOperand().(Literal).getValue()="0"
	and target_11.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vnow_666
	and target_11.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="eoi_time"
	and target_11.getParent().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_665
	and target_11.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_26
}

/*predicate func_12(Variable vinfo_665, Variable vnow_666, BlockStmt target_26, RelationalOperation target_12) {
	 (target_12 instanceof GTExpr or target_12 instanceof LTExpr)
	and target_12.getLesserOperand().(VariableAccess).getTarget()=vnow_666
	and target_12.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="eoi_time"
	and target_12.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_665
	and target_12.getParent().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vinfo_665
	and target_12.getParent().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_12.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_26
}

*/
predicate func_13(Variable vsystem_wq, Variable veoi_664, Variable vinfo_665, Variable vnow_666, VariableAccess target_17, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("mod_delayed_work_on")
	and target_13.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="eoi_cpu"
	and target_13.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_665
	and target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsystem_wq
	and target_13.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="delayed"
	and target_13.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=veoi_664
	and target_13.getExpr().(FunctionCall).getArgument(3).(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="eoi_time"
	and target_13.getExpr().(FunctionCall).getArgument(3).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_665
	and target_13.getExpr().(FunctionCall).getArgument(3).(SubExpr).getRightOperand().(VariableAccess).getTarget()=vnow_666
	and target_13.getParent().(IfStmt).getCondition()=target_17
}

predicate func_14(Variable vflags_667, VariableAccess target_14) {
	target_14.getTarget()=vflags_667
	and target_14.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_15(Variable vevtchn_rwlock, AddressOfExpr target_27, VariableAccess target_15) {
	target_15.getTarget()=vevtchn_rwlock
	and target_15.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_15.getLocation().isBefore(target_27.getOperand().(VariableAccess).getLocation())
}

predicate func_16(BlockStmt target_26, Function func, LogicalOrExpr target_16) {
	target_16.getLeftOperand() instanceof EqualityOperation
	and target_16.getRightOperand() instanceof RelationalOperation
	and target_16.getParent().(IfStmt).getThen()=target_26
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vinfo_665, ExprStmt target_13, ExprStmt target_28, VariableAccess target_17) {
	target_17.getTarget()=vinfo_665
	and target_17.getParent().(IfStmt).getThen()=target_13
	and target_28.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_17.getLocation())
}

predicate func_18(Variable v__dummy_697, Variable v__dummy2_697, StmtExpr target_18) {
	target_18.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy_697
	and target_18.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy2_697
	and target_18.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(Literal).getValue()="1"
}

/*predicate func_21(Variable v__dummy_697, Variable v__dummy2_697, ExprStmt target_21) {
	target_21.getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy_697
	and target_21.getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__dummy2_697
}

*/
/*predicate func_22(Function func, ExprStmt target_22) {
	target_22.getExpr().(Literal).getValue()="1"
	and target_22.getEnclosingFunction() = func
}

*/
predicate func_23(Function func, ExprStmt target_23) {
	target_23.getExpr() instanceof FunctionCall
	and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable vevtchn_rwlock, AddressOfExpr target_29, VariableAccess target_24) {
	target_24.getTarget()=vevtchn_rwlock
	and target_24.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_29.getOperand().(VariableAccess).getLocation().isBefore(target_24.getLocation())
}

predicate func_25(Variable vinfo_665, ExprStmt target_25) {
	target_25.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vinfo_665
	and target_25.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

predicate func_26(Function func, BlockStmt target_26) {
	target_26.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_26.getEnclosingFunction() = func
}

predicate func_27(Variable vevtchn_rwlock, AddressOfExpr target_27) {
	target_27.getOperand().(VariableAccess).getTarget()=vevtchn_rwlock
	and target_27.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_28(Variable vinfo_665, ExprStmt target_28) {
	target_28.getExpr().(FunctionCall).getTarget().hasName("xen_irq_lateeoi_locked")
	and target_28.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinfo_665
}

predicate func_29(Variable vevtchn_rwlock, AddressOfExpr target_29) {
	target_29.getOperand().(VariableAccess).getTarget()=vevtchn_rwlock
	and target_29.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

from Function func, Variable vsystem_wq, Variable v__dummy_697, Variable v__dummy2_697, Variable veoi_664, Variable vinfo_665, Variable vnow_666, Variable vflags_667, Variable v__dummy_671, Variable v__dummy2_671, Variable vevtchn_rwlock, FunctionCall target_0, FunctionCall target_1, FunctionCall target_2, FunctionCall target_3, FunctionCall target_4, ExprStmt target_5, ExprStmt target_9, AddressOfExpr target_10, EqualityOperation target_11, ExprStmt target_13, VariableAccess target_14, VariableAccess target_15, LogicalOrExpr target_16, VariableAccess target_17, StmtExpr target_18, ExprStmt target_23, VariableAccess target_24, ExprStmt target_25, BlockStmt target_26, AddressOfExpr target_27, ExprStmt target_28, AddressOfExpr target_29
where
func_0(vflags_667, vevtchn_rwlock, target_0)
and func_1(func, target_1)
and func_2(veoi_664, target_2)
and func_3(veoi_664, target_3)
and func_4(vflags_667, vevtchn_rwlock, target_4)
and func_5(target_25, func, target_5)
and not func_6(func)
and not func_7(target_16, func)
and func_9(v__dummy_671, v__dummy2_671, target_9)
and func_10(veoi_664, target_10)
and func_11(vinfo_665, vnow_666, target_26, target_11)
and func_13(vsystem_wq, veoi_664, vinfo_665, vnow_666, target_17, target_13)
and func_14(vflags_667, target_14)
and func_15(vevtchn_rwlock, target_27, target_15)
and func_16(target_26, func, target_16)
and func_17(vinfo_665, target_13, target_28, target_17)
and func_18(v__dummy_697, v__dummy2_697, target_18)
and func_23(func, target_23)
and func_24(vevtchn_rwlock, target_29, target_24)
and func_25(vinfo_665, target_25)
and func_26(func, target_26)
and func_27(vevtchn_rwlock, target_27)
and func_28(vinfo_665, target_28)
and func_29(vevtchn_rwlock, target_29)
and vsystem_wq.getType().hasName("workqueue_struct *")
and v__dummy_697.getType().hasName("unsigned long")
and v__dummy2_697.getType().hasName("unsigned long")
and veoi_664.getType().hasName("lateeoi_work *")
and vinfo_665.getType().hasName("irq_info *")
and vnow_666.getType().hasName("u64")
and vflags_667.getType().hasName("unsigned long")
and v__dummy_671.getType().hasName("unsigned long")
and v__dummy2_671.getType().hasName("unsigned long")
and vevtchn_rwlock.getType().hasName("rwlock_t")
and not vsystem_wq.getParentScope+() = func
and v__dummy_697.(LocalVariable).getFunction() = func
and v__dummy2_697.(LocalVariable).getFunction() = func
and veoi_664.(LocalVariable).getFunction() = func
and vinfo_665.(LocalVariable).getFunction() = func
and vnow_666.(LocalVariable).getFunction() = func
and vflags_667.(LocalVariable).getFunction() = func
and v__dummy_671.(LocalVariable).getFunction() = func
and v__dummy2_671.(LocalVariable).getFunction() = func
and not vevtchn_rwlock.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
