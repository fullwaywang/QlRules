/**
 * @name linux-45c1380358b12bf2d1db20a5874e9544f56b34ab-sof_set_get_large_ctrl_data
 * @id cpp/linux/45c1380358b12bf2d1db20a5874e9544f56b34ab/sof-set-get-large-ctrl-data
 * @description linux-45c1380358b12bf2d1db20a5874e9544f56b34ab-sound/soc/sof/ipc.c-sof_set_get_large_ctrl_data CVE-2019-18811
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpartdata_556, ExprStmt target_1, ValueFieldAccess target_4, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpartdata_556
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_4.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vpartdata_556, Function func, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpartdata_556
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Variable verr_561, Function func, ReturnStmt target_2) {
	target_2.getExpr().(VariableAccess).getTarget()=verr_561
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable verr_561, RelationalOperation target_5, ReturnStmt target_3) {
	target_3.getExpr().(VariableAccess).getTarget()=verr_561
	and target_3.getParent().(IfStmt).getCondition()=target_5
}

predicate func_4(Variable vpartdata_556, ValueFieldAccess target_4) {
	target_4.getTarget().getName()="size"
	and target_4.getQualifier().(ValueFieldAccess).getTarget().getName()="hdr"
	and target_4.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="rhdr"
	and target_4.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpartdata_556
}

predicate func_5(Variable verr_561, ReturnStmt target_3, RelationalOperation target_5) {
	 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
	and target_5.getLesserOperand().(VariableAccess).getTarget()=verr_561
	and target_5.getGreaterOperand().(Literal).getValue()="0"
	and target_5.getParent().(IfStmt).getThen()=target_3
}

from Function func, Variable vpartdata_556, Variable verr_561, ExprStmt target_1, ReturnStmt target_2, ReturnStmt target_3, ValueFieldAccess target_4, RelationalOperation target_5
where
not func_0(vpartdata_556, target_1, target_4, func)
and func_1(vpartdata_556, func, target_1)
and func_2(verr_561, func, target_2)
and func_3(verr_561, target_5, target_3)
and func_4(vpartdata_556, target_4)
and func_5(verr_561, target_3, target_5)
and vpartdata_556.getType().hasName("sof_ipc_ctrl_data *")
and verr_561.getType().hasName("int")
and vpartdata_556.(LocalVariable).getFunction() = func
and verr_561.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
