/**
 * @name openssl-aab7c770353b1dc4ba045938c8fb446dd1c4531e-BN_consttime_swap
 * @id cpp/openssl/aab7c770353b1dc4ba045938c8fb446dd1c4531e/bn-consttime-swap
 * @description openssl-aab7c770353b1dc4ba045938c8fb446dd1c4531e-crypto/bn/bn_lib.c-BN_consttime_swap CVE-2018-5407
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcondition_809, Parameter va_809, Parameter vb_809, Variable vt_811, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_811
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="neg"
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="neg"
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_809
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter va_809, Variable vt_811, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="neg"
		and target_1.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_1.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1)
}

predicate func_2(Parameter vb_809, Variable vt_811, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="neg"
		and target_2.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_2.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2)
}

predicate func_3(Parameter vcondition_809, Parameter va_809, Parameter vb_809, Variable vt_811, ExprStmt target_9, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_811
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_809
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_3.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_4(Parameter va_809, Variable vt_811, ExprStmt target_9, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
		and target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_4.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_4.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vb_809, Variable vt_811, ExprStmt target_9, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
		and target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_5.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_5.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vcondition_809, Parameter va_809, Parameter vb_809, Variable vt_811, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_811
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="top"
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="top"
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_6.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_809
}

predicate func_7(Parameter va_809, Variable vt_811, ExprStmt target_7) {
		target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="top"
		and target_7.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_7.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
}

predicate func_8(Parameter vb_809, Variable vt_811, ExprStmt target_8) {
		target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getTarget().getName()="top"
		and target_8.getExpr().(AssignXorExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_8.getExpr().(AssignXorExpr).getRValue().(VariableAccess).getTarget()=vt_811
}

predicate func_9(Parameter vcondition_809, Parameter va_809, Parameter vb_809, Variable vt_811, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_811
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="d"
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_809
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getLeftOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="d"
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_809
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BitwiseXorExpr).getRightOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(VariableAccess).getTarget()=vcondition_809
}

from Function func, Parameter vcondition_809, Parameter va_809, Parameter vb_809, Variable vt_811, ExprStmt target_6, ExprStmt target_7, ExprStmt target_8, ExprStmt target_9
where
not func_0(vcondition_809, va_809, vb_809, vt_811, target_6, target_7, target_8, func)
and not func_1(va_809, vt_811, func)
and not func_2(vb_809, vt_811, func)
and not func_3(vcondition_809, va_809, vb_809, vt_811, target_9, func)
and not func_4(va_809, vt_811, target_9, func)
and not func_5(vb_809, vt_811, target_9, func)
and func_6(vcondition_809, va_809, vb_809, vt_811, target_6)
and func_7(va_809, vt_811, target_7)
and func_8(vb_809, vt_811, target_8)
and func_9(vcondition_809, va_809, vb_809, vt_811, target_9)
and vcondition_809.getType().hasName("unsigned long")
and va_809.getType().hasName("BIGNUM *")
and vb_809.getType().hasName("BIGNUM *")
and vt_811.getType().hasName("unsigned long")
and vcondition_809.getFunction() = func
and va_809.getFunction() = func
and vb_809.getFunction() = func
and vt_811.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
