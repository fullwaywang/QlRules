/**
 * @name linux-770cacc75b0091ece17349195d72133912c1ca7c-xhci_mem_cleanup
 * @id cpp/linux/770cacc75b0091ece17349195d72133912c1ca7c/xhci-mem-cleanup
 * @description linux-770cacc75b0091ece17349195d72133912c1ca7c-drivers/usb/host/xhci-mem.c-xhci_mem_cleanup CVE-2024-45027
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vxhci_1873, BlockStmt target_2, AddressOfExpr target_3, RelationalOperation target_1) {
exists(LogicalAndExpr target_0 |
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getLeftOperand() |
		obj_0.getTarget().getName()="interrupters"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vxhci_1873
	)
	and target_0.getRightOperand() instanceof RelationalOperation
	and target_0.getParent().(ForStmt).getStmt()=target_2
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_1(Variable vi_1876, Parameter vxhci_1873, BlockStmt target_2, RelationalOperation target_1) {
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getGreaterOperand() |
		obj_0.getTarget().getName()="max_interrupters"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vxhci_1873
	)
	and  (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
	and target_1.getLesserOperand().(VariableAccess).getTarget()=vi_1876
	and target_1.getParent().(ForStmt).getStmt()=target_2
}

predicate func_2(Variable vi_1876, Parameter vxhci_1873, BlockStmt target_2) {
	exists(IfStmt obj_0 | obj_0=target_2.getStmt(0) |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getCondition() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getArrayBase() |
				obj_2.getTarget().getName()="interrupters"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vxhci_1873
			)
			and obj_1.getArrayOffset().(VariableAccess).getTarget()=vi_1876
		)
		and exists(BlockStmt obj_3 | obj_3=obj_0.getThen() |
			exists(ExprStmt obj_4 | obj_4=obj_3.getStmt(0) |
				exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
					exists(ArrayExpr obj_6 | obj_6=obj_5.getArgument(1) |
						obj_6.getArrayBase().(PointerFieldAccess).getTarget().getName()="interrupters"
						and obj_6.getArrayOffset().(VariableAccess).getTarget()=vi_1876
					)
					and obj_5.getTarget().hasName("xhci_remove_interrupter")
					and obj_5.getArgument(0).(VariableAccess).getTarget()=vxhci_1873
				)
			)
			and exists(ExprStmt obj_7 | obj_7=obj_3.getStmt(1) |
				exists(FunctionCall obj_8 | obj_8=obj_7.getExpr() |
					exists(ArrayExpr obj_9 | obj_9=obj_8.getArgument(1) |
						obj_9.getArrayBase().(PointerFieldAccess).getTarget().getName()="interrupters"
						and obj_9.getArrayOffset().(VariableAccess).getTarget()=vi_1876
					)
					and obj_8.getTarget().hasName("xhci_free_interrupter")
					and obj_8.getArgument(0).(VariableAccess).getTarget()=vxhci_1873
				)
			)
		)
	)
}

predicate func_3(Parameter vxhci_1873, AddressOfExpr target_3) {
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getOperand() |
		obj_0.getTarget().getName()="cmd_timer"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vxhci_1873
	)
}

from Function func, Variable vi_1876, Parameter vxhci_1873, RelationalOperation target_1, BlockStmt target_2, AddressOfExpr target_3
where
not func_0(vxhci_1873, target_2, target_3, target_1)
and func_1(vi_1876, vxhci_1873, target_2, target_1)
and func_2(vi_1876, vxhci_1873, target_2)
and func_3(vxhci_1873, target_3)
and vi_1876.getType().hasName("int")
and vxhci_1873.getType().hasName("xhci_hcd *")
and vi_1876.(LocalVariable).getFunction() = func
and vxhci_1873.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
