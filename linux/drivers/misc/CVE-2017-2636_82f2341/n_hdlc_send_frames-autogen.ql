/**
 * @name linux-82f2341c94d270421f383641b7cd670e474db56b-n_hdlc_send_frames
 * @id cpp/linux/82f2341c94d270421f383641b7cd670e474db56b/n-hdlc-send-frames
 * @description linux-82f2341c94d270421f383641b7cd670e474db56b-drivers/tty/n_hdlc.c-n_hdlc_send_frames CVE-2017-2636
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="392"
	and not target_0.getValue()="383"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)n_hdlc_send_frames() called\n"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vtbuf_389, Literal target_1) {
	target_1.getValue()="415"
	and not target_1.getValue()="400"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)sending frame %p, count=%d\n"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtbuf_389
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="count"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtbuf_389
}

predicate func_2(Variable vtbuf_389, Literal target_2) {
	target_2.getValue()="434"
	and not target_2.getValue()="419"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)frame %p completed\n"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtbuf_389
}

predicate func_3(Variable vtbuf_389, Literal target_3) {
	target_3.getValue()="450"
	and not target_3.getValue()="432"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)frame %p pending\n"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtbuf_389
}

predicate func_4(Function func, Literal target_4) {
	target_4.getValue()="471"
	and not target_4.getValue()="455"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)n_hdlc_send_frames() exit\n"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vtbuf_389, Parameter vn_hdlc_385, AddressOfExpr target_17) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("n_hdlc_buf_return")
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_5.getArgument(1).(VariableAccess).getTarget()=vtbuf_389
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Variable vtbuf_389, Parameter vn_hdlc_385, ExprStmt target_18, AddressOfExpr target_19) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("n_hdlc_buf_return")
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_6.getArgument(1).(VariableAccess).getTarget()=vtbuf_389
	and target_6.getArgument(1).(VariableAccess).getLocation().isBefore(target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_7(Variable vtbuf_389, Parameter vn_hdlc_385, NotExpr target_20, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtbuf_389
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("n_hdlc_buf_get")
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_7.getParent().(IfStmt).getCondition()=target_20
}

predicate func_8(Parameter vn_hdlc_385, VariableAccess target_8) {
	target_8.getTarget()=vn_hdlc_385
}

/*predicate func_9(Parameter vn_hdlc_385, VariableAccess target_9) {
	target_9.getTarget()=vn_hdlc_385
}

*/
predicate func_10(Variable vtbuf_389, ExprStmt target_7, VariableAccess target_10) {
	target_10.getTarget()=vtbuf_389
	and target_10.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_7
}

predicate func_11(Variable vtbuf_389, Parameter vn_hdlc_385, VariableAccess target_11) {
	target_11.getTarget()=vtbuf_389
	and target_11.getParent().(AssignExpr).getRValue() = target_11
	and target_11.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="tbuf"
	and target_11.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
}

predicate func_12(Variable vtbuf_389, Parameter vn_hdlc_385, Function func, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtbuf_389
	and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="tbuf"
	and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Variable vtbuf_389, Function func, IfStmt target_13) {
	target_13.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vtbuf_389
	and target_13.getThen() instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Variable vtbuf_389, Parameter vn_hdlc_385, ExprStmt target_18, AddressOfExpr target_19, AssignExpr target_14) {
	target_14.getLValue().(PointerFieldAccess).getTarget().getName()="tbuf"
	and target_14.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_14.getRValue().(VariableAccess).getTarget()=vtbuf_389
	and target_14.getRValue().(VariableAccess).getLocation().isBefore(target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_14.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_15(Parameter vn_hdlc_385, EqualityOperation target_21, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="tbuf"
	and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_15.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
}

predicate func_16(Variable vtbuf_389, Parameter vn_hdlc_385, ExprStmt target_22, NotExpr target_23, AddressOfExpr target_24, AddressOfExpr target_25, AssignExpr target_16) {
	target_16.getLValue().(PointerFieldAccess).getTarget().getName()="tbuf"
	and target_16.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_16.getRValue().(VariableAccess).getTarget()=vtbuf_389
	and target_22.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_16.getRValue().(VariableAccess).getLocation())
	and target_16.getRValue().(VariableAccess).getLocation().isBefore(target_23.getOperand().(VariableAccess).getLocation())
	and target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_16.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_17(Parameter vn_hdlc_385, AddressOfExpr target_17) {
	target_17.getOperand().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_17.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("n_hdlc_buf_get")
}

predicate func_18(Variable vtbuf_389, ExprStmt target_18) {
	target_18.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="count"
	and target_18.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtbuf_389
}

predicate func_19(Parameter vn_hdlc_385, AddressOfExpr target_19) {
	target_19.getOperand().(PointerFieldAccess).getTarget().getName()="tx_free_buf_list"
	and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
}

predicate func_20(Variable vtbuf_389, ExprStmt target_7, NotExpr target_20) {
	target_20.getOperand().(VariableAccess).getTarget()=vtbuf_389
	and target_20.getParent().(IfStmt).getThen()=target_7
}

predicate func_21(Variable vtbuf_389, EqualityOperation target_21) {
	target_21.getLeftOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_21.getRightOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_21.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtbuf_389
}

predicate func_22(Variable vtbuf_389, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_22.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="%s(%d)frame %p pending\n"
	and target_22.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="drivers/tty/n_hdlc.c"
	and target_22.getExpr().(FunctionCall).getArgument(2) instanceof Literal
	and target_22.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtbuf_389
}

predicate func_23(Variable vtbuf_389, ExprStmt target_26, NotExpr target_23) {
	target_23.getOperand().(VariableAccess).getTarget()=vtbuf_389
	and target_23.getParent().(IfStmt).getThen()=target_26
}

predicate func_24(Parameter vn_hdlc_385, AddressOfExpr target_24) {
	target_24.getOperand().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
}

predicate func_25(Parameter vn_hdlc_385, AddressOfExpr target_25) {
	target_25.getOperand().(ValueFieldAccess).getTarget().getName()="spinlock"
	and target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tx_buf_list"
	and target_25.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_hdlc_385
	and target_25.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
}

predicate func_26(Function func, ExprStmt target_26) {
	target_26.getExpr().(FunctionCall).getTarget().hasName("clear_bit")
	and target_26.getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="5"
	and target_26.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_26.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tty_struct *")
	and target_26.getEnclosingFunction() = func
}

from Function func, Variable vtbuf_389, Parameter vn_hdlc_385, Literal target_0, Literal target_1, Literal target_2, Literal target_3, Literal target_4, ExprStmt target_7, VariableAccess target_8, VariableAccess target_10, VariableAccess target_11, ExprStmt target_12, IfStmt target_13, AssignExpr target_14, ExprStmt target_15, AssignExpr target_16, AddressOfExpr target_17, ExprStmt target_18, AddressOfExpr target_19, NotExpr target_20, EqualityOperation target_21, ExprStmt target_22, NotExpr target_23, AddressOfExpr target_24, AddressOfExpr target_25, ExprStmt target_26
where
func_0(func, target_0)
and func_1(vtbuf_389, target_1)
and func_2(vtbuf_389, target_2)
and func_3(vtbuf_389, target_3)
and func_4(func, target_4)
and not func_5(vtbuf_389, vn_hdlc_385, target_17)
and not func_6(vtbuf_389, vn_hdlc_385, target_18, target_19)
and func_7(vtbuf_389, vn_hdlc_385, target_20, target_7)
and func_8(vn_hdlc_385, target_8)
and func_10(vtbuf_389, target_7, target_10)
and func_11(vtbuf_389, vn_hdlc_385, target_11)
and func_12(vtbuf_389, vn_hdlc_385, func, target_12)
and func_13(vtbuf_389, func, target_13)
and func_14(vtbuf_389, vn_hdlc_385, target_18, target_19, target_14)
and func_15(vn_hdlc_385, target_21, target_15)
and func_16(vtbuf_389, vn_hdlc_385, target_22, target_23, target_24, target_25, target_16)
and func_17(vn_hdlc_385, target_17)
and func_18(vtbuf_389, target_18)
and func_19(vn_hdlc_385, target_19)
and func_20(vtbuf_389, target_7, target_20)
and func_21(vtbuf_389, target_21)
and func_22(vtbuf_389, target_22)
and func_23(vtbuf_389, target_26, target_23)
and func_24(vn_hdlc_385, target_24)
and func_25(vn_hdlc_385, target_25)
and func_26(func, target_26)
and vtbuf_389.getType().hasName("n_hdlc_buf *")
and vn_hdlc_385.getType().hasName("n_hdlc *")
and vtbuf_389.(LocalVariable).getFunction() = func
and vn_hdlc_385.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
