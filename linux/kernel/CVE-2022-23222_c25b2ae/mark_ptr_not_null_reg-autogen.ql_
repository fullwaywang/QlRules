/**
 * @name linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-mark_ptr_not_null_reg
 * @id cpp/linux/c25b2ae136039ffa820c26138ed4a5e5f3ab3841/mark-ptr-not-null-reg
 * @description linux-c25b2ae136039ffa820c26138ed4a5e5f3ab3841-kernel/bpf/verifier.c-mark_ptr_not_null_reg CVE-2022-23222
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_3(Parameter vreg_1203, BlockStmt target_59, ValueFieldAccess target_60) {
exists(EqualityOperation target_3 |
	target_3.getLeftOperand().(FunctionCall).getTarget().hasName("base_type")
	and target_3.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="type"
	and target_3.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_3.getParent().(IfStmt).getThen()=target_59
	and target_3.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_60.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vreg_1203, ExprStmt target_17) {
exists(AssignAndExpr target_4 |
	target_4.getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_4.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_4.getRValue().(ComplementExpr).getValue()="4294967039"
	and target_4.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Function func) {
exists(ReturnStmt target_5 |
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_6(Parameter vreg_1203, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="type"
	and target_6.getQualifier().(VariableAccess).getTarget()=vreg_1203
}

predicate func_8(Parameter vreg_1203, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="type"
	and target_8.getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_8.getParent().(AssignExpr).getLValue() = target_8
	and target_8.getParent().(AssignExpr).getRValue() instanceof EnumConstantAccess
}

predicate func_9(Function func, ReturnStmt target_9) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Parameter vreg_1203, Variable vmap_1207, Function func, SwitchStmt target_10) {
	target_10.getExpr().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(1).(BlockStmt).getStmt(1).(IfStmt).getCondition().(PointerFieldAccess).getTarget().getName()="inner_map_meta"
	and target_10.getStmt().(BlockStmt).getStmt(1).(BlockStmt).getStmt(1).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmap_1207
	and target_10.getStmt().(BlockStmt).getStmt(1).(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("map_value_has_timer")
	and target_10.getStmt().(BlockStmt).getStmt(1).(BlockStmt).getStmt(1).(IfStmt).getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="map_type"
	and target_10.getStmt().(BlockStmt).getStmt(2).(SwitchCase).getExpr() instanceof EnumConstantAccess
	and target_10.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(12).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(12).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(15).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(15).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(18).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(18).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(21).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getStmt().(BlockStmt).getStmt(21).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_10.getStmt().(BlockStmt).getStmt(23).(SwitchCase).toString() = "default: "
	and target_10.getStmt().(BlockStmt).getStmt(24).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_10.getStmt().(BlockStmt).getStmt(24).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Function func, SwitchCase target_11) {
	target_11.getExpr() instanceof EnumConstantAccess
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_13(Function func, SwitchCase target_13) {
	target_13.getExpr() instanceof EnumConstantAccess
	and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_17, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_14.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_14.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_15(PointerFieldAccess target_6, Function func, BreakStmt target_15) {
	target_15.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_15.getEnclosingFunction() = func
}

*/
predicate func_17(Parameter vreg_1203, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
}

/*predicate func_18(PointerFieldAccess target_6, Function func, BreakStmt target_18) {
	target_18.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_18.getEnclosingFunction() = func
}

*/
/*predicate func_20(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_20.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

*/
/*predicate func_21(PointerFieldAccess target_6, Function func, BreakStmt target_21) {
	target_21.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_21.getEnclosingFunction() = func
}

*/
/*predicate func_23(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_23) {
	target_23.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_23.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_23.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

*/
/*predicate func_24(PointerFieldAccess target_6, Function func, BreakStmt target_24) {
	target_24.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_24.getEnclosingFunction() = func
}

*/
/*predicate func_26(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_26) {
	target_26.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_26.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_26.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

*/
/*predicate func_27(PointerFieldAccess target_6, Function func, BreakStmt target_27) {
	target_27.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_27.getEnclosingFunction() = func
}

*/
/*predicate func_29(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_29) {
	target_29.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_29.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_29.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

*/
/*predicate func_30(PointerFieldAccess target_6, Function func, BreakStmt target_30) {
	target_30.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_30.getEnclosingFunction() = func
}

*/
/*predicate func_32(Parameter vreg_1203, PointerFieldAccess target_6, ExprStmt target_32) {
	target_32.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="type"
	and target_32.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
	and target_32.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
}

*/
/*predicate func_33(PointerFieldAccess target_6, Function func, BreakStmt target_33) {
	target_33.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_33.getEnclosingFunction() = func
}

*/
/*predicate func_34(Function func, SwitchCase target_34) {
	target_34.toString() = "default: "
	and target_34.getEnclosingFunction() = func
}

*/
/*predicate func_35(PointerFieldAccess target_6, Function func, ExprStmt target_35) {
	target_35.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_35.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_35.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_35.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_35.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_6
	and target_35.getEnclosingFunction() = func
}

*/
/*predicate func_38(Variable v__already_done_1249, Variable v__ret_do_once_1249, BlockStmt target_59, FunctionCall target_38) {
	target_38.getTarget().hasName("__builtin_expect")
	and target_38.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=v__ret_do_once_1249
	and target_38.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__already_done_1249
	and target_38.getArgument(1) instanceof Literal
	and target_38.getParent().(IfStmt).getThen()=target_59
}

*/
/*predicate func_39(Variable v__already_done_1249, FunctionCall target_38, ExprStmt target_39) {
	target_39.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_1249
	and target_39.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_38
}

*/
/*predicate func_40(Variable v__ret_warn_on_1249, StmtExpr target_40) {
	target_40.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_40.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1249
	and target_40.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_40.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_40.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition() instanceof Literal
	and target_40.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_40.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1249
	and target_40.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
/*predicate func_42(Variable v__ret_warn_on_1249, IfStmt target_42) {
	target_42.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_42.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1249
	and target_42.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_42.getThen().(DoStmt).getCondition() instanceof Literal
	and target_42.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition() instanceof Literal
	and target_42.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
}

*/
/*predicate func_46(Function func, DoStmt target_46) {
	target_46.getCondition() instanceof Literal
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(BitwiseOrExpr).getValue()="2313"
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_46.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_46.getEnclosingFunction() = func
}

*/
/*predicate func_49(Function func, DoStmt target_49) {
	target_49.getCondition() instanceof Literal
	and target_49.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_49.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_49.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(BitwiseOrExpr).getValue()="2313"
	and target_49.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_49.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_49.getEnclosingFunction() = func
}

*/
/*predicate func_50(Function func, AsmStmt target_50) {
	target_50.getChild(0) instanceof StringLiteral
	and target_50.getChild(1) instanceof Literal
	and target_50.getChild(2).(BitwiseOrExpr).getValue()="2313"
	and target_50.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_50.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_50.getEnclosingFunction() = func
}

*/
/*predicate func_57(Variable v__ret_warn_on_1249, ExprStmt target_57) {
	target_57.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_57.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1249
	and target_57.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
/*predicate func_58(Variable v__ret_do_once_1249, ExprStmt target_58) {
	target_58.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_58.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_do_once_1249
	and target_58.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
predicate func_59(Function func, BlockStmt target_59) {
	target_59.getStmt(0) instanceof ExprStmt
	and target_59.getStmt(1).(ExprStmt).getExpr() instanceof StmtExpr
	and target_59.getEnclosingFunction() = func
}

predicate func_60(Parameter vreg_1203, ValueFieldAccess target_60) {
	target_60.getTarget().getName()="map_ptr"
	and target_60.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_60.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_60.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreg_1203
}

from Function func, Variable v__already_done_1249, Variable v__ret_do_once_1249, Variable v__ret_warn_on_1249, Parameter vreg_1203, Variable vmap_1207, PointerFieldAccess target_6, PointerFieldAccess target_8, ReturnStmt target_9, SwitchStmt target_10, ExprStmt target_17, BlockStmt target_59, ValueFieldAccess target_60
where
not func_3(vreg_1203, target_59, target_60)
and not func_4(vreg_1203, target_17)
and not func_5(func)
and func_6(vreg_1203, target_6)
and func_8(vreg_1203, target_8)
and func_9(func, target_9)
and func_10(vreg_1203, vmap_1207, func, target_10)
and func_17(vreg_1203, target_17)
and func_59(func, target_59)
and func_60(vreg_1203, target_60)
and v__already_done_1249.getType().hasName("bool")
and v__ret_do_once_1249.getType().hasName("bool")
and v__ret_warn_on_1249.getType().hasName("int")
and vreg_1203.getType().hasName("bpf_reg_state *")
and vmap_1207.getType().hasName("const bpf_map *")
and v__already_done_1249.(LocalVariable).getFunction() = func
and v__ret_do_once_1249.(LocalVariable).getFunction() = func
and v__ret_warn_on_1249.(LocalVariable).getFunction() = func
and vreg_1203.getFunction() = func
and vmap_1207.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
