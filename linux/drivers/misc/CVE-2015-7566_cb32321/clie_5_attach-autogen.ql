/**
 * @name linux-cb3232138e37129e88240a98a1d2aba2187ff57c-clie_5_attach
 * @id cpp/linux/cb3232138e37129e88240a98a1d2aba2187ff57c/clie-5-attach
 * @description linux-cb3232138e37129e88240a98a1d2aba2187ff57c-drivers/usb/serial/visor.c-clie_5_attach CVE-2015-7566
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, UnaryMinusExpr target_0) {
	target_0.getValue()="-1"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vserial_590) {
exists(PointerFieldAccess target_1 |
	target_1.getTarget().getName()="num_bulk_out"
	and target_1.getQualifier().(VariableAccess).getTarget()=vserial_590)
}

predicate func_2(Parameter vserial_590, RelationalOperation target_5, ExprStmt target_6) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="interface"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vserial_590
	and target_2.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="missing bulk out endpoints\n"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vserial_590, VariableAccess target_3) {
	target_3.getTarget()=vserial_590
}

predicate func_4(Parameter vserial_590, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="num_ports"
	and target_4.getQualifier().(VariableAccess).getTarget()=vserial_590
}

predicate func_5(Parameter vserial_590, RelationalOperation target_5) {
	 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
	and target_5.getLesserOperand().(PointerFieldAccess).getTarget().getName()="num_ports"
	and target_5.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vserial_590
	and target_5.getGreaterOperand().(Literal).getValue()="2"
}

predicate func_6(Parameter vserial_590, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("usb_serial_port *")
	and target_6.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="port"
	and target_6.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vserial_590
	and target_6.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
}

from Function func, Parameter vserial_590, UnaryMinusExpr target_0, VariableAccess target_3, PointerFieldAccess target_4, RelationalOperation target_5, ExprStmt target_6
where
func_0(func, target_0)
and not func_1(vserial_590)
and not func_2(vserial_590, target_5, target_6)
and func_3(vserial_590, target_3)
and func_4(vserial_590, target_4)
and func_5(vserial_590, target_5)
and func_6(vserial_590, target_6)
and vserial_590.getType().hasName("usb_serial *")
and vserial_590.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
