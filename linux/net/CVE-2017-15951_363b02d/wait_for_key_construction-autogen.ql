/**
 * @name linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-wait_for_key_construction
 * @id cpp/linux/363b02dab09b3226f3bd1420dad9c72b79a42a76/wait-for-key-construction
 * @description linux-363b02dab09b3226f3bd1420dad9c72b79a42a76-security/keys/request_key.c-wait_for_key_construction CVE-2017-15951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkey_590, Literal target_0) {
		target_0.getValue()="4"
		and not target_0.getValue()="3"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("wait_on_bit")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_590
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getCondition().(VariableAccess).getTarget().getType().hasName("bool")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getThen().(Literal).getValue()="1"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getElse().(Literal).getValue()="2"
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="1"
		and not target_1.getValue()="0"
		and target_1.getParent().(ConditionalExpr).getParent().(IfStmt).getCondition() instanceof ConditionalExpr
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vret_592, Parameter vkey_590, IfStmt target_9, AddressOfExpr target_10, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_592
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("key_read_state")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vkey_590
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_9.getCondition().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Variable vret_592, BlockStmt target_11) {
	exists(RelationalOperation target_3 |
		 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
		and target_3.getLesserOperand().(VariableAccess).getTarget()=vret_592
		and target_3.getGreaterOperand().(Literal).getValue()="0"
		and target_3.getParent().(IfStmt).getThen()=target_11)
}

predicate func_5(Parameter vkey_590, VariableAccess target_5) {
		target_5.getTarget()=vkey_590
		and target_5.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ConditionalExpr).getThen() instanceof FunctionCall
}

predicate func_6(Parameter vkey_590, BlockStmt target_11, ConditionalExpr target_6) {
		target_6.getCondition() instanceof Literal
		and target_6.getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
		and target_6.getThen().(FunctionCall).getArgument(0).(Literal).getValue()="5"
		and target_6.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_6.getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_590
		and target_6.getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
		and target_6.getElse().(FunctionCall).getArgument(0).(Literal).getValue()="5"
		and target_6.getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_6.getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_590
		and target_6.getParent().(IfStmt).getThen()=target_11
}

predicate func_7(ConditionalExpr target_6, Function func, AsmStmt target_7) {
		target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_7.getEnclosingFunction() = func
}

predicate func_8(Parameter vkey_590, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="reject_error"
		and target_8.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_590
}

predicate func_9(Variable vret_592, IfStmt target_9) {
		target_9.getCondition().(VariableAccess).getTarget()=vret_592
		and target_9.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-512"
}

predicate func_10(Parameter vkey_590, AddressOfExpr target_10) {
		target_10.getOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_10.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkey_590
		and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("wait_on_bit")
		and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1) instanceof Literal
		and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getCondition().(VariableAccess).getTarget().getType().hasName("bool")
		and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getThen().(Literal).getValue()="1"
		and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ConditionalExpr).getElse().(Literal).getValue()="2"
}

predicate func_11(Function func, BlockStmt target_11) {
		target_11.getStmt(0) instanceof AsmStmt
		and target_11.getStmt(1).(ReturnStmt).getExpr() instanceof ValueFieldAccess
		and target_11.getEnclosingFunction() = func
}

from Function func, Variable vret_592, Parameter vkey_590, Literal target_0, Literal target_1, VariableAccess target_5, ConditionalExpr target_6, AsmStmt target_7, ValueFieldAccess target_8, IfStmt target_9, AddressOfExpr target_10, BlockStmt target_11
where
func_0(vkey_590, target_0)
and func_1(func, target_1)
and not func_2(vret_592, vkey_590, target_9, target_10, func)
and not func_3(vret_592, target_11)
and func_5(vkey_590, target_5)
and func_6(vkey_590, target_11, target_6)
and func_7(target_6, func, target_7)
and func_8(vkey_590, target_8)
and func_9(vret_592, target_9)
and func_10(vkey_590, target_10)
and func_11(func, target_11)
and vret_592.getType().hasName("int")
and vkey_590.getType().hasName("key *")
and vret_592.(LocalVariable).getFunction() = func
and vkey_590.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
