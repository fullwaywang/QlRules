/**
 * @name linux-a2f18db0c68fec96631c10cad9384c196e9008ac-nft_flush_table
 * @id cpp/linux/a2f18db0c68fec96631c10cad9384c196e9008ac/nft-flush-table
 * @description linux-a2f18db0c68fec96631c10cad9384c196e9008ac-net/netfilter/nf_tables_api.c-nft_flush_table CVE-2015-1573
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vchain_713) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vchain_713
		and target_0.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("const list_head *"))
}

predicate func_1(Variable vchain_713, ValueFieldAccess target_13) {
	exists(AssignExpr target_1 |
		target_1.getLValue().(VariableAccess).getTarget()=vchain_713
		and target_1.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("const list_head *")
		and target_1.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
		and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getLValue().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vctx_710, Variable verr_712, Variable vchain_713, ExprStmt target_14, AddressOfExpr target_15, RelationalOperation target_16, RelationalOperation target_9, ExprStmt target_7, Function func) {
	exists(ForStmt target_2 |
		target_2.getInitialization() instanceof ExprStmt
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchain_713
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="chains"
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="table"
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
		and target_2.getUpdate() instanceof CommaExpr
		and target_2.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="chain"
		and target_2.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
		and target_2.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vchain_713
		and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_712
		and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_delchain")
		and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_710
		and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition() instanceof RelationalOperation
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_16.getLesserOperand().(VariableAccess).getLocation().isBefore(target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_9.getLesserOperand().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_2.getCondition().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_3(Parameter vctx_710, Variable vchain_713, EqualityOperation target_17, ExprStmt target_7, CommaExpr target_6) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="chain"
		and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
		and target_3.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vchain_713
		and target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_6.getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

*/
predicate func_5(Variable vchain_713, Variable vnc_713, ExprStmt target_5) {
		target_5.getExpr().(CommaExpr).getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vchain_713
		and target_5.getExpr().(CommaExpr).getRightOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnc_713
}

predicate func_6(Variable vchain_713, Variable vnc_713, Variable v__mptr_2_716, CommaExpr target_6) {
		target_6.getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vchain_713
		and target_6.getLeftOperand().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnc_713
		and target_6.getRightOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnc_713
		and target_6.getRightOperand().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_2_716
}

predicate func_7(Parameter vctx_710, Variable vchain_713, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="chain"
		and target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
		and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vchain_713
}

predicate func_8(Parameter vctx_710, Variable verr_712, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_712
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_delrule_by_chain")
		and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_710
}

predicate func_9(Variable verr_712, RelationalOperation target_9) {
		 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
		and target_9.getLesserOperand().(VariableAccess).getTarget()=verr_712
		and target_9.getGreaterOperand().(Literal).getValue()="0"
		and target_9.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_10(Variable verr_712, IfStmt target_10) {
		target_10.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_712
		and target_10.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
}

predicate func_11(Variable verr_712, IfStmt target_11) {
		target_11.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_712
		and target_11.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
}

predicate func_13(Variable vchain_713, ValueFieldAccess target_13) {
		target_13.getTarget().getName()="next"
		and target_13.getQualifier().(PointerFieldAccess).getTarget().getName()="list"
		and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchain_713
}

predicate func_14(Parameter vctx_710, Variable verr_712, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_712
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_delset")
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vctx_710
		and target_14.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("nft_set *")
}

predicate func_15(Parameter vctx_710, AddressOfExpr target_15) {
		target_15.getOperand().(PointerFieldAccess).getTarget().getName()="sets"
		and target_15.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="table"
		and target_15.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
}

predicate func_16(Variable verr_712, RelationalOperation target_16) {
		 (target_16 instanceof GTExpr or target_16 instanceof LTExpr)
		and target_16.getLesserOperand().(VariableAccess).getTarget()=verr_712
		and target_16.getGreaterOperand().(Literal).getValue()="0"
		and target_16.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_17(Parameter vctx_710, Variable vchain_713, EqualityOperation target_17) {
		target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="list"
		and target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchain_713
		and target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="chains"
		and target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="table"
		and target_17.getAnOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_710
}

from Function func, Parameter vctx_710, Variable verr_712, Variable vchain_713, Variable vnc_713, Variable v__mptr_2_716, ExprStmt target_5, CommaExpr target_6, ExprStmt target_7, ExprStmt target_8, RelationalOperation target_9, IfStmt target_10, IfStmt target_11, ValueFieldAccess target_13, ExprStmt target_14, AddressOfExpr target_15, RelationalOperation target_16, EqualityOperation target_17
where
not func_0(vchain_713)
and not func_1(vchain_713, target_13)
and not func_2(vctx_710, verr_712, vchain_713, target_14, target_15, target_16, target_9, target_7, func)
and func_5(vchain_713, vnc_713, target_5)
and func_6(vchain_713, vnc_713, v__mptr_2_716, target_6)
and func_7(vctx_710, vchain_713, target_7)
and func_8(vctx_710, verr_712, target_8)
and func_9(verr_712, target_9)
and func_10(verr_712, target_10)
and func_11(verr_712, target_11)
and func_13(vchain_713, target_13)
and func_14(vctx_710, verr_712, target_14)
and func_15(vctx_710, target_15)
and func_16(verr_712, target_16)
and func_17(vctx_710, vchain_713, target_17)
and vctx_710.getType().hasName("nft_ctx *")
and verr_712.getType().hasName("int")
and vchain_713.getType().hasName("nft_chain *")
and vnc_713.getType().hasName("nft_chain *")
and v__mptr_2_716.getType().hasName("const list_head *")
and vctx_710.getFunction() = func
and verr_712.(LocalVariable).getFunction() = func
and vchain_713.(LocalVariable).getFunction() = func
and vnc_713.(LocalVariable).getFunction() = func
and v__mptr_2_716.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
