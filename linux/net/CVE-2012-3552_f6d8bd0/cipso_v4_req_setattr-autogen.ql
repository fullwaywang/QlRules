/**
 * @name linux-f6d8bd051c391c1c0458a30b2a7abcd939329259-cipso_v4_req_setattr
 * @id cpp/linux/f6d8bd051c391c1c0458a30b2a7abcd939329259/cipso-v4-req-setattr
 * @description linux-f6d8bd051c391c1c0458a30b2a7abcd939329259-net/ipv4/cipso_ipv4.c-cipso_v4_req_setattr CVE-2012-3552
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Function func, SizeofExprOperator target_2) {
		target_2.getValue()="12"
		and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vopt_1963, FunctionCall target_3) {
		target_3.getTarget().hasName("kfree")
		and not target_3.getTarget().hasName("call_rcu_sched")
		and target_3.getArgument(0).(VariableAccess).getTarget()=vopt_1963
}

predicate func_4(Variable vopt_len_1962, Variable vopt_1963, ExprStmt target_15, ExprStmt target_16) {
	exists(AssignExpr target_4 |
		target_4.getLValue().(VariableAccess).getTarget()=vopt_1963
		and target_4.getRValue().(FunctionCall).getTarget().hasName("kzalloc")
		and target_4.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand().(SizeofExprOperator).getValue()="32"
		and target_4.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vopt_len_1962
		and target_4.getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="32"
		and target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand().(VariableAccess).getLocation())
		and target_4.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_5(Variable vopt_1963, EqualityOperation target_18, ExprStmt target_19) {
	exists(ValueFieldAccess target_5 |
		target_5.getTarget().getName()="__data"
		and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_18.getAnOperand().(VariableAccess).getLocation().isBefore(target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Variable vopt_1963, ExprStmt target_19, ExprStmt target_16) {
	exists(ValueFieldAccess target_6 |
		target_6.getTarget().getName()="optlen"
		and target_6.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_7(Variable vopt_1963, ExprStmt target_16, ExprStmt target_20) {
	exists(ValueFieldAccess target_7 |
		target_7.getTarget().getName()="cipso"
		and target_7.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_8(Variable vopt_1963, Function func) {
	exists(IfStmt target_8 |
		target_8.getCondition().(VariableAccess).getTarget()=vopt_1963
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("call_rcu_sched")
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_8.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

/*predicate func_9(Variable vopt_1963, ExprStmt target_22) {
	exists(AddressOfExpr target_9 |
		target_9.getOperand().(PointerFieldAccess).getTarget().getName()="rcu"
		and target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
		and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_11(Variable vopt_len_1962, Variable vopt_1963, AssignExpr target_11) {
		target_11.getLValue().(VariableAccess).getTarget()=vopt_1963
		and target_11.getRValue().(FunctionCall).getTarget().hasName("kzalloc")
		and target_11.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand() instanceof SizeofExprOperator
		and target_11.getRValue().(FunctionCall).getArgument(0).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vopt_len_1962
		and target_11.getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="32"
}

predicate func_12(Variable vopt_1963, PointerFieldAccess target_12) {
		target_12.getTarget().getName()="__data"
		and target_12.getQualifier().(VariableAccess).getTarget()=vopt_1963
}

predicate func_13(Variable vopt_1963, PointerFieldAccess target_13) {
		target_13.getTarget().getName()="optlen"
		and target_13.getQualifier().(VariableAccess).getTarget()=vopt_1963
}

predicate func_14(Variable vopt_1963, PointerFieldAccess target_14) {
		target_14.getTarget().getName()="cipso"
		and target_14.getQualifier().(VariableAccess).getTarget()=vopt_1963
}

predicate func_15(Variable vopt_len_1962, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vopt_len_1962
		and target_15.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("u32")
		and target_15.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="3"
		and target_15.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="4294967292"
}

predicate func_16(Variable vopt_len_1962, Variable vopt_1963, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_16.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vopt_len_1962
}

predicate func_18(Variable vopt_1963, EqualityOperation target_18) {
		target_18.getAnOperand().(VariableAccess).getTarget()=vopt_1963
		and target_18.getAnOperand().(Literal).getValue()="0"
}

predicate func_19(Variable vopt_1963, ExprStmt target_19) {
		target_19.getExpr().(FunctionCall).getTarget().hasName("memcpy")
		and target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="__data"
		and target_19.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_19.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned char *")
		and target_19.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u32")
}

predicate func_20(Variable vopt_1963, ExprStmt target_20) {
		target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cipso"
		and target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_1963
		and target_20.getExpr().(AssignExpr).getRValue().(SizeofTypeOperator).getType() instanceof LongType
		and target_20.getExpr().(AssignExpr).getRValue().(SizeofTypeOperator).getValue()="20"
}

predicate func_22(Variable vopt_1963, ExprStmt target_22) {
		target_22.getExpr().(FunctionCall).getTarget().hasName("kfree")
		and target_22.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vopt_1963
}

from Function func, Variable vopt_len_1962, Variable vopt_1963, SizeofExprOperator target_2, FunctionCall target_3, AssignExpr target_11, PointerFieldAccess target_12, PointerFieldAccess target_13, PointerFieldAccess target_14, ExprStmt target_15, ExprStmt target_16, EqualityOperation target_18, ExprStmt target_19, ExprStmt target_20, ExprStmt target_22
where
func_2(func, target_2)
and func_3(vopt_1963, target_3)
and not func_4(vopt_len_1962, vopt_1963, target_15, target_16)
and not func_5(vopt_1963, target_18, target_19)
and not func_6(vopt_1963, target_19, target_16)
and not func_7(vopt_1963, target_16, target_20)
and not func_8(vopt_1963, func)
and func_11(vopt_len_1962, vopt_1963, target_11)
and func_12(vopt_1963, target_12)
and func_13(vopt_1963, target_13)
and func_14(vopt_1963, target_14)
and func_15(vopt_len_1962, target_15)
and func_16(vopt_len_1962, vopt_1963, target_16)
and func_18(vopt_1963, target_18)
and func_19(vopt_1963, target_19)
and func_20(vopt_1963, target_20)
and func_22(vopt_1963, target_22)
and vopt_len_1962.getType().hasName("u32")
and vopt_1963.getType().hasName("ip_options *")
and vopt_len_1962.(LocalVariable).getFunction() = func
and vopt_1963.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
