/**
 * @name linux-3cf521f7dc87c031617fd47e4b7aa2593c2f3daf-pppol2tp_getsockopt
 * @id cpp/linux/3cf521f7dc87c031617fd47e4b7aa2593c2f3daf/pppol2tp-getsockopt
 * @description linux-3cf521f7dc87c031617fd47e4b7aa2593c2f3daf-net/l2tp/l2tp_ppp.c-pppol2tp_getsockopt CVE-2014-4943
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vlevel_1483, Parameter voptname_1483, Parameter voptval_1484, Parameter voptlen_1484, Variable vsk_1486, Variable vudp_prot, VariableCall target_1) {
	target_1.getExpr().(ValueFieldAccess).getTarget().getName()="getsockopt"
	and target_1.getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vudp_prot
	and target_1.getArgument(0).(VariableAccess).getTarget()=vsk_1486
	and target_1.getArgument(1).(VariableAccess).getTarget()=vlevel_1483
	and target_1.getArgument(2).(VariableAccess).getTarget()=voptname_1483
	and target_1.getArgument(3).(VariableAccess).getTarget()=voptval_1484
	and target_1.getArgument(4).(VariableAccess).getTarget()=voptlen_1484
}

from Function func, Parameter vlevel_1483, Parameter voptname_1483, Parameter voptval_1484, Parameter voptlen_1484, Variable vsk_1486, Variable vudp_prot, VariableCall target_1
where
func_1(vlevel_1483, voptname_1483, voptval_1484, voptlen_1484, vsk_1486, vudp_prot, target_1)
and vlevel_1483.getType().hasName("int")
and voptname_1483.getType().hasName("int")
and voptval_1484.getType().hasName("char *")
and voptlen_1484.getType().hasName("int *")
and vsk_1486.getType().hasName("sock *")
and vudp_prot.getType().hasName("proto")
and vlevel_1483.getFunction() = func
and voptname_1483.getFunction() = func
and voptval_1484.getFunction() = func
and voptlen_1484.getFunction() = func
and vsk_1486.(LocalVariable).getFunction() = func
and not vudp_prot.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
