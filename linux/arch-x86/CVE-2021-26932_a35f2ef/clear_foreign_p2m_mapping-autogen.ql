/**
 * @name linux-a35f2ef3b7376bfd0a57f7844bd7454389aae1fc-clear_foreign_p2m_mapping
 * @id cpp/linux/a35f2ef3b7376bfd0a57f7844bd7454389aae1fc/clear-foreign-p2m-mapping
 * @description linux-a35f2ef3b7376bfd0a57f7844bd7454389aae1fc-arch/x86/xen/p2m.c-clear_foreign_p2m_mapping CVE-2021-26932
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmfn_750, BlockStmt target_10) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vmfn_750
	and target_0.getLeftOperand().(EqualityOperation).getRightOperand() instanceof ComplementExpr
	and target_0.getRightOperand() instanceof BitwiseAndExpr
	and target_0.getParent().(IfStmt).getThen()=target_10)
}

predicate func_1(Variable vret_744, ExprStmt target_11, ReturnStmt target_12) {
exists(ConditionalExpr target_1 |
	target_1.getCondition() instanceof FunctionCall
	and target_1.getElse().(VariableAccess).getTarget()=vret_744
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_744
	and target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getElse().(VariableAccess).getLocation())
	and target_1.getElse().(VariableAccess).getLocation().isBefore(target_12.getExpr().(VariableAccess).getLocation()))
}

predicate func_2(Function func, ComplementExpr target_2) {
	target_2.getValue()="18446744073709551615"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vmfn_750, BitwiseAndExpr target_3) {
	target_3.getLeftOperand().(VariableAccess).getTarget()=vmfn_750
	and target_3.getRightOperand().(BinaryBitwiseOperation).getValue()="9223372036854775808"
}

predicate func_4(Variable vret_744, LogicalOrExpr target_8, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_744
	and target_4.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
}

predicate func_5(Variable vpfn_751, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("set_phys_to_machine")
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpfn_751
	and target_5.getExpr().(FunctionCall).getArgument(1).(ComplementExpr).getValue()="18446744073709551615"
}

predicate func_6(Parameter vkunmap_ops_741, Parameter vcount_742, Variable vret_744, FunctionCall target_6) {
	target_6.getTarget().hasName("HYPERVISOR_grant_table_op")
	and target_6.getArgument(0).(Literal).getValue()="1"
	and target_6.getArgument(1).(VariableAccess).getTarget()=vkunmap_ops_741
	and target_6.getArgument(2).(VariableAccess).getTarget()=vcount_742
	and target_6.getParent().(AssignExpr).getRValue() = target_6
	and target_6.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_744
}

predicate func_7(Variable vmfn_750, VariableAccess target_7) {
	target_7.getTarget()=vmfn_750
}

predicate func_8(Variable vmfn_750, BlockStmt target_10, LogicalOrExpr target_8) {
	target_8.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vmfn_750
	and target_8.getLeftOperand().(EqualityOperation).getRightOperand() instanceof ComplementExpr
	and target_8.getRightOperand().(NotExpr).getOperand() instanceof BitwiseAndExpr
	and target_8.getParent().(IfStmt).getThen()=target_10
}

predicate func_9(LogicalOrExpr target_8, Function func, GotoStmt target_9) {
	target_9.getName() ="out"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Function func, BlockStmt target_10) {
	target_10.getStmt(0) instanceof ExprStmt
	and target_10.getStmt(1) instanceof GotoStmt
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Variable vret_744, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_744
	and target_11.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_12(Variable vret_744, ReturnStmt target_12) {
	target_12.getExpr().(VariableAccess).getTarget()=vret_744
}

from Function func, Parameter vkunmap_ops_741, Parameter vcount_742, Variable vret_744, Variable vmfn_750, Variable vpfn_751, ComplementExpr target_2, BitwiseAndExpr target_3, ExprStmt target_4, ExprStmt target_5, FunctionCall target_6, VariableAccess target_7, LogicalOrExpr target_8, GotoStmt target_9, BlockStmt target_10, ExprStmt target_11, ReturnStmt target_12
where
not func_0(vmfn_750, target_10)
and not func_1(vret_744, target_11, target_12)
and func_2(func, target_2)
and func_3(vmfn_750, target_3)
and func_4(vret_744, target_8, target_4)
and func_5(vpfn_751, target_5)
and func_6(vkunmap_ops_741, vcount_742, vret_744, target_6)
and func_7(vmfn_750, target_7)
and func_8(vmfn_750, target_10, target_8)
and func_9(target_8, func, target_9)
and func_10(func, target_10)
and func_11(vret_744, target_11)
and func_12(vret_744, target_12)
and vkunmap_ops_741.getType().hasName("gnttab_unmap_grant_ref *")
and vcount_742.getType().hasName("unsigned int")
and vret_744.getType().hasName("int")
and vmfn_750.getType().hasName("unsigned long")
and vpfn_751.getType().hasName("unsigned long")
and vkunmap_ops_741.getFunction() = func
and vcount_742.getFunction() = func
and vret_744.(LocalVariable).getFunction() = func
and vmfn_750.(LocalVariable).getFunction() = func
and vpfn_751.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
