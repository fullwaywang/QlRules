commit 9f3c30fce2008686da2e15e1afaaf1db30181922	9f3c30fce2008686da2e15e1afaaf1db30181922
Author: Tommy Steimel <steimel@chromium.org>
Date:   Wed Mar 29 19:13:18 2023 +0000

    pip2: Don't allow picture-in-picture windows to be discarded
    
    This CL prevents tabs in a picture-in-picture (PiP) window from being
    discarded. Although `CanDiscard` would already return false for PiP
    tabs (since they are always the active tab of the window), they can
    still end up being discarded when an extension requests it, as that
    does not check `CanDiscard`. So this CL add logic directly into
    `Discard` to prevent PiP windows from being discarded.
    
    The reason PiP windows should not be discarded is that discarding them
    leaves the PiP window in a state where it's no longer connected to the
    DocumentPictureInPictureWindowControllerImpl and therefore just
    displays "about:blank" and the toolbar controls no longer function.
    
    Bug: 1413919
    Change-Id: I6d3207503cf1ed5644fdbaa821a80e17ac519c7b
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4347922
    Reviewed-by: Patrick Monette <pmonette@chromium.org>
    Commit-Queue: Tommy Steimel <steimel@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1123745}

diff --git a/chrome/browser/resource_coordinator/tab_lifecycle_unit.cc b/chrome/browser/resource_coordinator/tab_lifecycle_unit.cc
index e83205b2305f3..e3350dee38ef3 100644
--- a/chrome/browser/resource_coordinator/tab_lifecycle_unit.cc
+++ b/chrome/browser/resource_coordinator/tab_lifecycle_unit.cc
@@ -31,6 +31,8 @@
 #include "chrome/browser/resource_coordinator/time.h"
 #include "chrome/browser/resource_coordinator/utils.h"
 #include "chrome/browser/tab_contents/form_interaction_tab_helper.h"
+#include "chrome/browser/ui/browser.h"
+#include "chrome/browser/ui/browser_finder.h"
 #include "chrome/browser/ui/tabs/tab_strip_model.h"
 #include "chrome/browser/web_applications/web_app_provider.h"
 #include "chrome/browser/web_applications/web_app_ui_manager.h"
@@ -578,6 +580,15 @@ bool TabLifecycleUnitSource::TabLifecycleUnit::Discard(
     return false;
   }
 
+  // Can't discard a tab displayed in a picture-in-picture window. We check this
+  // here instead of in `CanDiscard` as not all calls to `Discard` check
+  // `CanDiscard` and discarding a picture-in-picture WebContents leaves the
+  // window in a bad state.
+  Browser* browser = chrome::FindBrowserWithWebContents(web_contents());
+  if (browser && browser->is_type_picture_in_picture()) {
+    return false;
+  }
+
   discard_reason_ = reason;
 
   FinishDiscard(reason, tab_memory_footprint_estimate);
diff --git a/chrome/browser/resource_coordinator/tab_lifecycle_unit_unittest.cc b/chrome/browser/resource_coordinator/tab_lifecycle_unit_unittest.cc
index 9824514bae75e..1de9ceb7014ef 100644
--- a/chrome/browser/resource_coordinator/tab_lifecycle_unit_unittest.cc
+++ b/chrome/browser/resource_coordinator/tab_lifecycle_unit_unittest.cc
@@ -34,9 +34,11 @@
 #include "chrome/browser/resource_coordinator/usage_clock.h"
 #include "chrome/browser/resource_coordinator/utils.h"
 #include "chrome/browser/tab_contents/form_interaction_tab_helper.h"
+#include "chrome/browser/ui/browser.h"
 #include "chrome/browser/ui/tabs/tab_strip_model.h"
 #include "chrome/browser/ui/tabs/test_tab_strip_model_delegate.h"
 #include "chrome/test/base/chrome_render_view_host_test_harness.h"
+#include "chrome/test/base/test_browser_window.h"
 #include "chrome/test/base/testing_profile.h"
 #include "content/public/browser/web_contents.h"
 #include "content/public/common/referrer.h"
@@ -511,4 +513,33 @@ TEST_F(TabLifecycleUnitTest, NotifiedOfWebContentsVisibilityChanges) {
   tab_lifecycle_unit.RemoveObserver(&observer);
 }
 
+TEST_F(TabLifecycleUnitTest, CannotDiscardPictureInPictureWindow) {
+  // Create picture-in-picture browser.
+  auto pip_window = std::make_unique<TestBrowserWindow>();
+  Browser::CreateParams params(profile(), true);
+  params.type = Browser::TYPE_PICTURE_IN_PICTURE;
+  params.window = pip_window.get();
+  std::unique_ptr<Browser> pip_browser;
+  pip_browser.reset(Browser::Create(params));
+  std::unique_ptr<content::WebContents> contents(
+      content::WebContentsTester::CreateTestWebContents(profile(), nullptr));
+  content::WebContents* raw_contents = contents.get();
+  ResourceCoordinatorTabHelper::CreateForWebContents(raw_contents);
+  pip_browser->tab_strip_model()->AppendWebContents(std::move(contents),
+                                                    /*foreground=*/true);
+
+  // Attempt to discard the tab. This should fail as picture-in-picture tabs
+  // should not be discardable.
+  TabLifecycleUnit tab_lifecycle_unit(GetTabLifecycleUnitSource(), &observers_,
+                                      usage_clock_.get(), raw_contents,
+                                      pip_browser->tab_strip_model());
+  EXPECT_FALSE(
+      tab_lifecycle_unit.Discard(LifecycleUnitDiscardReason::EXTERNAL, 0));
+
+  // Tear down picture-in-picture browser.
+  pip_browser->tab_strip_model()->DetachAndDeleteWebContentsAt(0);
+  pip_browser.reset();
+  pip_window.reset();
+}
+
 }  // namespace resource_coordinator
