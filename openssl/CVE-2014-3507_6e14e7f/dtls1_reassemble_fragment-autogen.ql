/**
 * @name openssl-6e14e7fc19ab8c16ec7e7cb69404b96cf591a575-dtls1_reassemble_fragment
 * @id cpp/openssl/6e14e7fc19ab8c16ec7e7cb69404b96cf591a575/dtls1-reassemble-fragment
 * @description openssl-6e14e7fc19ab8c16ec7e7cb69404b96cf591a575-ssl/d1_both.c-dtls1_reassemble_fragment CVE-2014-3507
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_600, LogicalOrExpr target_4) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_600
		and target_0.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-1"
		and target_0.getParent().(IfStmt).getCondition()=target_4)
}

predicate func_2(Variable vi_600, Variable vfrag_len_602, RelationalOperation target_2) {
		 (target_2 instanceof GEExpr or target_2 instanceof LEExpr)
		and target_2.getLesserOperand().(VariableAccess).getTarget()=vi_600
		and target_2.getGreaterOperand().(Literal).getValue()="0"
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vi_600
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vfrag_len_602
		and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

/*predicate func_3(Variable vi_600, Variable vfrag_len_602, EqualityOperation target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vi_600
		and target_3.getAnOperand().(VariableAccess).getTarget()=vfrag_len_602
		and target_3.getParent().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_600
		and target_3.getParent().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_3.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

*/
predicate func_4(Function func, LogicalOrExpr target_4) {
		target_4.getAnOperand() instanceof RelationalOperation
		and target_4.getAnOperand() instanceof EqualityOperation
		and target_4.getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_4.getEnclosingFunction() = func
}

from Function func, Variable vi_600, Variable vfrag_len_602, RelationalOperation target_2, LogicalOrExpr target_4
where
not func_0(vi_600, target_4)
and func_2(vi_600, vfrag_len_602, target_2)
and func_4(func, target_4)
and vi_600.getType().hasName("int")
and vfrag_len_602.getType().hasName("unsigned long")
and vi_600.(LocalVariable).getFunction() = func
and vfrag_len_602.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
