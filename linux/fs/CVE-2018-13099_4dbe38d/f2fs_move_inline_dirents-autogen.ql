/**
 * @name linux-4dbe38dc386910c668c75ae616b99b823b59f3eb-f2fs_move_inline_dirents
 * @id cpp/linux/4dbe38dc386910c668c75ae616b99b823b59f3eb/f2fs-move-inline-dirents
 * @description linux-4dbe38dc386910c668c75ae616b99b823b59f3eb-fs/f2fs/inline.c-f2fs_move_inline_dirents CVE-2018-13099
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdir_346, Variable vpage_349, Variable vdn_350, Variable verr_353, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, NotExpr target_4, AddressOfExpr target_5, IfStmt target_6, ReturnStmt target_7, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_0.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="data_blkaddr"
	and target_0.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vdn_350
	and target_0.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="4294967295"
	and target_0.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("f2fs_put_dnode")
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdn_350
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("set_sbi_flag")
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("F2FS_P_SB")
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_349
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("f2fs_msg")
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="sb"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("F2FS_P_SB")
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_349
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="4"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%s: corrupted inline inode ino=%lx, i_addr[0]:0x%x, run fsck to fix."
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getType().hasName("const char[25]")
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="i_ino"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdir_346
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getTarget().getName()="data_blkaddr"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vdn_350
	and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_353
	and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_0.getThen().(BlockStmt).getStmt(4).(GotoStmt).getName() ="out"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_4.getOperand().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_5.getOperand().(VariableAccess).getLocation().isBefore(target_0.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_6.getCondition().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getExpr().(VariableAccess).getLocation()))
}

predicate func_1(Variable vpage_349, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("f2fs_wait_on_page_writeback")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_349
}

predicate func_2(Parameter vdir_346, Variable vdn_350, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("set_new_dnode")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdn_350
	and target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vdir_346
	and target_2.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("page *")
	and target_2.getExpr().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_2.getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_3(Parameter vdir_346, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("make_dentry_ptr_inline")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdir_346
	and target_3.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("f2fs_dentry_ptr")
	and target_3.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("void *")
}

predicate func_4(Variable vpage_349, NotExpr target_4) {
	target_4.getOperand().(VariableAccess).getTarget()=vpage_349
}

predicate func_5(Variable vdn_350, AddressOfExpr target_5) {
	target_5.getOperand().(VariableAccess).getTarget()=vdn_350
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("f2fs_reserve_block")
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_6(Variable verr_353, IfStmt target_6) {
	target_6.getCondition().(VariableAccess).getTarget()=verr_353
	and target_6.getThen().(GotoStmt).getName() ="out"
}

predicate func_7(Variable verr_353, ReturnStmt target_7) {
	target_7.getExpr().(VariableAccess).getTarget()=verr_353
}

from Function func, Parameter vdir_346, Variable vpage_349, Variable vdn_350, Variable verr_353, ExprStmt target_1, ExprStmt target_2, ExprStmt target_3, NotExpr target_4, AddressOfExpr target_5, IfStmt target_6, ReturnStmt target_7
where
not func_0(vdir_346, vpage_349, vdn_350, verr_353, target_1, target_2, target_3, target_4, target_5, target_6, target_7, func)
and func_1(vpage_349, target_1)
and func_2(vdir_346, vdn_350, target_2)
and func_3(vdir_346, target_3)
and func_4(vpage_349, target_4)
and func_5(vdn_350, target_5)
and func_6(verr_353, target_6)
and func_7(verr_353, target_7)
and vdir_346.getType().hasName("inode *")
and vpage_349.getType().hasName("page *")
and vdn_350.getType().hasName("dnode_of_data")
and verr_353.getType().hasName("int")
and vdir_346.getFunction() = func
and vpage_349.(LocalVariable).getFunction() = func
and vdn_350.(LocalVariable).getFunction() = func
and verr_353.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
