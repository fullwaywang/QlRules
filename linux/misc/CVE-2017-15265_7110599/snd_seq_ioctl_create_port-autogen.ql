/**
 * @name linux-71105998845fb012937332fe2e806d443c09e026-snd_seq_ioctl_create_port
 * @id cpp/linux/71105998845fb012937332fe2e806d443c09e026/snd-seq-ioctl-create-port
 * @description linux-71105998845fb012937332fe2e806d443c09e026-sound/core/seq/seq_clientmgr.c-snd_seq_ioctl_create_port CVE-2017-15265
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getType().hasName("int")
	and target_0.getRValue() instanceof ValueFieldAccess
	and target_0.getEnclosingFunction() = func)
}

predicate func_2(Variable vport_1260, LogicalAndExpr target_8, ValueFieldAccess target_7, ExprStmt target_9) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("atomic_dec")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="use_lock"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vport_1260
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
	and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vclient_1257, LogicalAndExpr target_8, EqualityOperation target_10) {
exists(ExprStmt target_3 |
	target_3.getExpr().(FunctionCall).getTarget().hasName("snd_seq_delete_port")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vclient_1257
	and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("int")
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_10.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable vport_1260, ValueFieldAccess target_11, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("atomic_dec")
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="use_lock"
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vport_1260
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt
	and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_6(Parameter vclient_1257, Variable vport_1260, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="addr"
	and target_6.getQualifier().(VariableAccess).getTarget()=vport_1260
	and target_6.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("snd_seq_delete_port")
	and target_6.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vclient_1257
	and target_6.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="port"
}

*/
predicate func_7(Variable vport_1260, ValueFieldAccess target_7) {
	target_7.getTarget().getName()="port"
	and target_7.getQualifier().(PointerFieldAccess).getTarget().getName()="addr"
	and target_7.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vport_1260
}

predicate func_8(Parameter vclient_1257, LogicalAndExpr target_8) {
	target_8.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_8.getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclient_1257
	and target_8.getLeftOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="1"
	and target_8.getRightOperand().(PointerFieldAccess).getTarget().getName()="kernel"
	and target_8.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("snd_seq_port_info *")
}

predicate func_9(Variable vport_1260, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="owner"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vport_1260
	and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="owner"
	and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("snd_seq_port_callback *")
}

predicate func_10(Parameter vclient_1257, EqualityOperation target_10) {
	target_10.getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_10.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vclient_1257
	and target_10.getRightOperand().(Literal).getValue()="2"
}

predicate func_11(Variable vport_1260, ValueFieldAccess target_11) {
	target_11.getTarget().getName()="port"
	and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="addr"
	and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vport_1260
}

from Function func, Parameter vclient_1257, Variable vport_1260, ValueFieldAccess target_7, LogicalAndExpr target_8, ExprStmt target_9, EqualityOperation target_10, ValueFieldAccess target_11
where
not func_0(func)
and not func_2(vport_1260, target_8, target_7, target_9)
and not func_3(vclient_1257, target_8, target_10)
and not func_5(vport_1260, target_11, func)
and func_7(vport_1260, target_7)
and func_8(vclient_1257, target_8)
and func_9(vport_1260, target_9)
and func_10(vclient_1257, target_10)
and func_11(vport_1260, target_11)
and vclient_1257.getType().hasName("snd_seq_client *")
and vport_1260.getType().hasName("snd_seq_client_port *")
and vclient_1257.getFunction() = func
and vport_1260.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
