/**
 * @name linux-654b404f2a222f918af9b0cd18ad469d0c941a8e-edge_bulk_in_callback
 * @id cpp/linux/654b404f2a222f918af9b0cd18ad469d0c941a8e/edge-bulk-in-callback
 * @description linux-654b404f2a222f918af9b0cd18ad469d0c941a8e-drivers/usb/serial/io_ti.c-edge_bulk_in_callback CVE-2017-8924
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vedge_port_1733, Parameter vurb_1731, BlockStmt target_2, ExprStmt target_3, AddressOfExpr target_4, ExprStmt target_5) {
exists(LogicalAndExpr target_0 |
	target_0.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="actual_length"
	and target_0.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vurb_1731
	and target_0.getLeftOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_0.getRightOperand().(PointerFieldAccess).getTarget().getName()="lsr_event"
	and target_0.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vedge_port_1733
	and target_0.getParent().(IfStmt).getThen()=target_2
	and target_0.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(PrefixDecrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vedge_port_1733, BlockStmt target_2, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="lsr_event"
	and target_1.getQualifier().(VariableAccess).getTarget()=vedge_port_1733
	and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vedge_port_1733, BlockStmt target_2) {
	target_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="lsr_event"
	and target_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vedge_port_1733
	and target_2.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_2.getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_2.getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
}

predicate func_3(Variable vedge_port_1733, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="lsr_event"
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vedge_port_1733
	and target_3.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_4(Parameter vurb_1731, AddressOfExpr target_4) {
	target_4.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_4.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vurb_1731
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="%s - stopping read!\n"
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType() instanceof ArrayType
}

predicate func_5(Parameter vurb_1731, ExprStmt target_5) {
	target_5.getExpr().(PrefixDecrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="actual_length"
	and target_5.getExpr().(PrefixDecrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vurb_1731
}

from Function func, Variable vedge_port_1733, Parameter vurb_1731, PointerFieldAccess target_1, BlockStmt target_2, ExprStmt target_3, AddressOfExpr target_4, ExprStmt target_5
where
not func_0(vedge_port_1733, vurb_1731, target_2, target_3, target_4, target_5)
and func_1(vedge_port_1733, target_2, target_1)
and func_2(vedge_port_1733, target_2)
and func_3(vedge_port_1733, target_3)
and func_4(vurb_1731, target_4)
and func_5(vurb_1731, target_5)
and vedge_port_1733.getType().hasName("edgeport_port *")
and vurb_1731.getType().hasName("urb *")
and vedge_port_1733.(LocalVariable).getFunction() = func
and vurb_1731.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
