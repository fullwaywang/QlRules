/**
 * @name linux-415e3d3e90ce9e18727e8843ae343eda5a58fad6-unix_attach_fds
 * @id cpp/linux/415e3d3e90ce9e18727e8843ae343eda5a58fad6/unix-attach-fds
 * @description linux-415e3d3e90ce9e18727e8843ae343eda5a58fad6-net/unix/af_unix.c-unix_attach_fds CVE-2016-2550
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vscm_1533, ExprStmt target_1, ArrayExpr target_2) {
exists(PointerFieldAccess target_0 |
	target_0.getTarget().getName()="user"
	and target_0.getQualifier().(PointerFieldAccess).getTarget().getName()="fp"
	and target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vscm_1533
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vscm_1533, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="fp"
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vscm_1533
	and target_1.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(Literal).getValue()="1"
}

predicate func_2(Parameter vscm_1533, ArrayExpr target_2) {
	target_2.getArrayBase().(PointerFieldAccess).getTarget().getName()="fp"
	and target_2.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="fp"
	and target_2.getArrayBase().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vscm_1533
	and target_2.getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("unix_inflight")
}

from Function func, Parameter vscm_1533, ExprStmt target_1, ArrayExpr target_2
where
not func_0(vscm_1533, target_1, target_2)
and func_1(vscm_1533, target_1)
and func_2(vscm_1533, target_2)
and vscm_1533.getType().hasName("scm_cookie *")
and vscm_1533.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
