commit 173806cbb25a091b71dd5e462447dbaf48ccd161	173806cbb25a091b71dd5e462447dbaf48ccd161
Author: Samuel Groß <saelo@chromium.org>
Date:   Thu Aug 17 08:23:48 2023 +0000

    Merged: Squashed multiple commits.
    
    Merged: [runtime] Recreate enum cache on map update
    Revision: 1c623f9ff6e077be1c66f155485ea4005ddb6574
    
    Merged: [runtime] Don't try to create empty enum cache.
    Revision: 5516e06237c9f0013121f47319e8c253c896d52d
    
    BUG=chromium:1470668,chromium:1472317
    R=olivf@chromium.org
    
    Change-Id: I9cd54930946c55df0d960899b4a41310a7455378
    Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/4789108
    Reviewed-by: Tobias Tebbi <tebbi@chromium.org>
    Commit-Queue: Samuel Groß <saelo@chromium.org>
    Cr-Commit-Position: refs/branch-heads/11.7@{#8}
    Cr-Branched-From: fe608691065e23ae83720392bf61a59e8166bee6-refs/heads/11.7.439@{#1}
    Cr-Branched-From: aeb45525398afa173aa91fcf83eb6341c83850ea-refs/heads/main@{#89415}

diff --git a/src/objects/map-updater.cc b/src/objects/map-updater.cc
index 7660fab201a..9c204911dcf 100644
--- a/src/objects/map-updater.cc
+++ b/src/objects/map-updater.cc
@@ -12,6 +12,7 @@
 #include "src/handles/handles.h"
 #include "src/heap/parked-scope-inl.h"
 #include "src/objects/field-type.h"
+#include "src/objects/keys.h"
 #include "src/objects/objects-inl.h"
 #include "src/objects/objects.h"
 #include "src/objects/property-details.h"
@@ -1038,6 +1039,13 @@ MapUpdater::State MapUpdater::ConstructNewMap() {
   // the new descriptors to maintain descriptors sharing invariant.
   split_map->ReplaceDescriptors(isolate_, *new_descriptors);
 
+  // If the old descriptors had an enum cache, make sure the new ones do too.
+  if (old_descriptors_->enum_cache()->keys()->length() > 0 &&
+      new_map->NumberOfEnumerableProperties() > 0) {
+    FastKeyAccumulator::InitializeFastPropertyEnumCache(
+        isolate_, new_map, new_map->NumberOfEnumerableProperties());
+  }
+
   if (has_integrity_level_transition_) {
     target_map_ = new_map;
     state_ = kAtIntegrityLevelSource;
