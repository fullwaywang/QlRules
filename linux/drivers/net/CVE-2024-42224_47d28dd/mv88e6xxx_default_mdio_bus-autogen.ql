/**
 * @name linux-47d28dde172696031c880c5778633cdca30394ee-mv88e6xxx_default_mdio_bus
 * @id cpp/linux/47d28dde172696031c880c5778633cdca30394ee/mv88e6xxx-default-mdio-bus
 * @description linux-47d28dde172696031c880c5778633cdca30394ee-drivers/net/dsa/mv88e6xxx/chip.c-mv88e6xxx_default_mdio_bus CVE-2024-42224
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(DoStmt target_3, Function func) {
exists(ExprStmt target_1 |
	exists(ConditionalExpr obj_0 | obj_0=target_1.getExpr() |
		exists(EqualityOperation obj_1 | obj_1=obj_0.getCondition() |
			obj_1.getLeftOperand().(VariableAccess).getType().hasName("list_head *")
			and obj_1.getRightOperand().(VariableAccess).getType().hasName("list_head *")
		)
		and exists(StmtExpr obj_2 | obj_2=obj_0.getThen() |
			exists(BlockStmt obj_3 | obj_3=obj_2.getStmt() |
				obj_3.getStmt(1) instanceof DoStmt
				and obj_3.getStmt(2) instanceof ExprStmt
			)
		)
		and obj_0.getElse().(Literal).getValue()="0"
	)
	and target_1.getLocation().isBefore(target_3.getLocation())
	and target_1.getEnclosingFunction() = func
)
}

predicate func_3(Function func, DoStmt target_3) {
	target_3.getCondition().(Literal).getValue()="0"
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Variable v__mptr_234, ExprStmt target_4) {
	exists(PointerArithmeticOperation obj_0 | obj_0=target_4.getExpr() |
		obj_0.getLeftOperand().(VariableAccess).getTarget()=v__mptr_234
		and obj_0.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
	)
}

predicate func_5(Parameter vchip_230, AddressOfExpr target_5) {
	exists(PointerFieldAccess obj_0 | obj_0=target_5.getOperand() |
		obj_0.getTarget().getName()="mdios"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vchip_230
	)
}

predicate func_6(Function func, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="next"
	and target_6.getQualifier() instanceof AddressOfExpr
	and target_6.getEnclosingFunction() = func
}

from Function func, Parameter vchip_230, Variable v__mptr_234, DoStmt target_3, ExprStmt target_4, AddressOfExpr target_5, PointerFieldAccess target_6
where
not func_1(target_3, func)
and func_3(func, target_3)
and func_4(v__mptr_234, target_4)
and func_5(vchip_230, target_5)
and func_6(func, target_6)
and vchip_230.getType().hasName("mv88e6xxx_chip *")
and v__mptr_234.getType().hasName("void *")
and vchip_230.getFunction() = func
and v__mptr_234.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
