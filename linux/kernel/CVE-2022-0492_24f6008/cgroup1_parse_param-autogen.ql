/**
 * @name linux-24f6008564183aa120d07c03d9289519c2fe02af-cgroup1_parse_param
 * @id cpp/linux/24f6008564183aa120d07c03d9289519c2fe02af/cgroup1-parse-param
 * @description linux-24f6008564183aa120d07c03d9289519c2fe02af-cgroup1_parse_param CVE-2022-0492
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfc_905, VariableAccess target_1, AddressOfExpr target_2) {
	exists(IfStmt target_0 |
		target_0.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="user_ns"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfc_905
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("user_namespace")
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("capable")
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(Literal).getValue()="21"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getTarget().hasName("logfc")
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="log"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="log"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="prefix"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="log"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(2).(Literal).getValue()="101"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(3).(StringLiteral).getValue()="Setting release_agent not allowed"
		and target_0.getThen().(ReturnStmt).getExpr().(CommaExpr).getRightOperand().(UnaryMinusExpr).getValue()="-22"
		and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_1
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vopt_910, VariableAccess target_1) {
		target_1.getTarget()=vopt_910
}

predicate func_2(Parameter vfc_905, AddressOfExpr target_2) {
		target_2.getOperand().(PointerFieldAccess).getTarget().getName()="log"
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfc_905
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getTarget().hasName("logfc")
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="log"
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="log"
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfc_905
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="prefix"
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(2).(Literal).getValue()="101"
		and target_2.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(CommaExpr).getLeftOperand().(FunctionCall).getArgument(3).(StringLiteral).getValue()="release_agent respecified"
}

from Function func, Parameter vfc_905, Variable vopt_910, VariableAccess target_1, AddressOfExpr target_2
where
not func_0(vfc_905, target_1, target_2)
and func_1(vopt_910, target_1)
and func_2(vfc_905, target_2)
and vfc_905.getType().hasName("fs_context *")
and vopt_910.getType().hasName("int")
and vfc_905.getFunction() = func
and vopt_910.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
