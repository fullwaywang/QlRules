/**
 * @name linux-661412e301e2ca86799aa4f400d1cf0bd38c57c6-vm_access
 * @id cpp/linux/661412e301e2ca86799aa4f400d1cf0bd38c57c6/vm-access
 * @description linux-661412e301e2ca86799aa4f400d1cf0bd38c57c6-drivers/gpu/drm/i915/gem/i915_gem_mman.c-vm_access CVE-2023-28410
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(ReturnStmt target_5, Function func) {
exists(StmtExpr target_0 |
	target_0.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(LogicalOrExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(LogicalOrExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(LogicalOrExpr).getRightOperand().(RelationalOperation).getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getParent().(IfStmt).getThen()=target_5
	and target_0.getEnclosingFunction() = func)
}

/*predicate func_3(Variable vobj_449, ValueFieldAccess target_3) {
	target_3.getTarget().getName()="size"
	and target_3.getQualifier().(ValueFieldAccess).getTarget().getName()="base"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vobj_449
}

*/
predicate func_4(Parameter vaddr_445, Variable vobj_449, ReturnStmt target_5, VariableAccess target_4) {
	target_4.getTarget()=vaddr_445
	and target_4.getParent().(GEExpr).getLesserOperand().(ValueFieldAccess).getTarget().getName()="size"
	and target_4.getParent().(GEExpr).getLesserOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="base"
	and target_4.getParent().(GEExpr).getLesserOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_4.getParent().(GEExpr).getLesserOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vobj_449
	and target_4.getParent().(GEExpr).getParent().(IfStmt).getThen()=target_5
}

predicate func_5(Function func, ReturnStmt target_5) {
	target_5.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_5.getEnclosingFunction() = func
}

from Function func, Parameter vaddr_445, Variable vobj_449, VariableAccess target_4, ReturnStmt target_5
where
not func_0(target_5, func)
and func_4(vaddr_445, vobj_449, target_5, target_4)
and func_5(func, target_5)
and vaddr_445.getType().hasName("unsigned long")
and vobj_449.getType().hasName("drm_i915_gem_object *")
and vaddr_445.getFunction() = func
and vobj_449.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
