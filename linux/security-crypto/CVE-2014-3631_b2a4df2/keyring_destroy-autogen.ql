/**
 * @name linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-keyring_destroy
 * @id cpp/linux/b2a4df200d570b2c33a57e1ebfa5896e4bc81b69/keyring-destroy
 * @description linux-b2a4df200d570b2c33a57e1ebfa5896e4bc81b69-security/keys/keyring.c-keyring_destroy CVE-2014-3631
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vkeyring_156, AddressOfExpr target_16, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="payload"
		and target_0.getQualifier().(VariableAccess).getTarget()=vkeyring_156
		and target_16.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(VariableAccess).getLocation())
}

predicate func_1(Function func, FunctionCall target_1) {
		target_1.getTarget().hasName("key_put")
		and not target_1.getTarget().hasName("assoc_array_destroy")
		and target_1.getArgument(0).(StmtExpr).getStmt() instanceof BlockStmt
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Parameter vkeyring_156, AddressOfExpr target_16) {
	exists(AddressOfExpr target_2 |
		target_2.getOperand().(ValueFieldAccess).getTarget().getName()="keys"
		and target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_156
		and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
		and target_16.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
	exists(AddressOfExpr target_3 |
		target_3.getOperand().(VariableAccess).getType().hasName("const assoc_array_ops")
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(Function func, DeclStmt target_4) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Function func, DeclStmt target_5) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable v_________p1_171, Variable vklist_158, AssignExpr target_6) {
		target_6.getLValue().(VariableAccess).getTarget()=vklist_158
		and target_6.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(VariableAccess).getTarget()=v_________p1_171
}

/*predicate func_9(Variable v_________p1_171, ExprStmt target_9) {
		target_9.getExpr().(VariableAccess).getTarget()=v_________p1_171
}

*/
predicate func_10(Variable vklist_158, Variable vloop_159, Function func, IfStmt target_10) {
		target_10.getCondition().(VariableAccess).getTarget()=vklist_158
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vloop_159
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="nkeys"
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vloop_159
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getUpdate().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vloop_159
		and target_10.getThen().(BlockStmt).getStmt(0).(ForStmt).getStmt().(ExprStmt).getExpr() instanceof FunctionCall
		and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
		and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vklist_158
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Variable vklist_158, Variable vloop_159, VariableAccess target_17, ForStmt target_11) {
		target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vloop_159
		and target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="nkeys"
		and target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vklist_158
		and target_11.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_11.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vloop_159
		and target_11.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
		and target_11.getUpdate().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vloop_159
		and target_11.getStmt().(ExprStmt).getExpr() instanceof FunctionCall
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
predicate func_14(Variable v_________p1_174, ExprStmt target_14) {
		target_14.getExpr().(VariableAccess).getTarget()=v_________p1_174
}

/*predicate func_15(Variable vklist_158, VariableAccess target_17, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("kfree")
		and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vklist_158
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
predicate func_16(Parameter vkeyring_156, AddressOfExpr target_16) {
		target_16.getOperand().(ValueFieldAccess).getTarget().getName()="link"
		and target_16.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="type_data"
		and target_16.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vkeyring_156
		and target_16.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("list_del")
}

predicate func_17(Variable vklist_158, BlockStmt target_18, VariableAccess target_17) {
		target_17.getTarget()=vklist_158
		and target_17.getParent().(IfStmt).getThen()=target_18
}

predicate func_18(Function func, BlockStmt target_18) {
		target_18.getStmt(0) instanceof ForStmt
		and target_18.getStmt(1) instanceof ExprStmt
		and target_18.getEnclosingFunction() = func
}

from Function func, Variable v_________p1_171, Variable v_________p1_174, Variable vklist_158, Variable vloop_159, Parameter vkeyring_156, PointerFieldAccess target_0, FunctionCall target_1, DeclStmt target_4, DeclStmt target_5, AssignExpr target_6, IfStmt target_10, ExprStmt target_14, AddressOfExpr target_16, VariableAccess target_17, BlockStmt target_18
where
func_0(vkeyring_156, target_16, target_0)
and func_1(func, target_1)
and not func_2(vkeyring_156, target_16)
and not func_3(func)
and func_4(func, target_4)
and func_5(func, target_5)
and func_6(v_________p1_171, vklist_158, target_6)
and func_10(vklist_158, vloop_159, func, target_10)
and func_14(v_________p1_174, target_14)
and func_16(vkeyring_156, target_16)
and func_17(vklist_158, target_18, target_17)
and func_18(func, target_18)
and v_________p1_171.getType().hasName("keyring_list *")
and v_________p1_174.getType().hasName("key *")
and vklist_158.getType().hasName("keyring_list *")
and vloop_159.getType().hasName("int")
and vkeyring_156.getType().hasName("key *")
and v_________p1_171.(LocalVariable).getFunction() = func
and v_________p1_174.(LocalVariable).getFunction() = func
and vklist_158.(LocalVariable).getFunction() = func
and vloop_159.(LocalVariable).getFunction() = func
and vkeyring_156.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
