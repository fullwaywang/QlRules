/**
 * @name linux-3021ad9a4f009265e6063e617fb91306980af16c-brcmf_configure_wowl
 * @id cpp/linux/3021ad9a4f009265e6063e617fb91306980af16c/brcmf-configure-wowl
 * @description linux-3021ad9a4f009265e6063e617fb91306980af16c-drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c-brcmf_configure_wowl CVE-2019-9500
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcfg_3200) {
	exists(ValueFieldAccess target_0 |
		target_0.getTarget().getName()="pre_pmmode"
		and target_0.getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200)
}

predicate func_1(Parameter vcfg_3200, Parameter vifp_3201, Parameter vwowl_3202, Variable vwowl_config_3204, PointerFieldAccess target_11, ExprStmt target_12, ArrayExpr target_13, ExprStmt target_14, Function func) {
	exists(IfStmt target_1 |
		target_1.getCondition().(PointerFieldAccess).getTarget().getName()="nd_config"
		and target_1.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brcmf_cfg80211_sched_scan_start")
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="wiphy"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="ndev"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vifp_3201
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="nd_config"
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vwowl_config_3204
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="67108864"
		and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="nd_data_completed"
		and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_1.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="nd_enabled"
		and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_1.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof EnumConstantAccess
		and target_1.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brcmf_fweh_unregister")
		and target_1.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="pub"
		and target_1.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_1.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brcmf_fweh_register")
		and target_1.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="pub"
		and target_1.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_12.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_13.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_14.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation()))
}

/*predicate func_2(Parameter vcfg_3200, ExprStmt target_15) {
	exists(ValueFieldAccess target_2 |
		target_2.getTarget().getName()="nd_data_completed"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_4(Variable vwowl_config_3204, ExprStmt target_16, Function func) {
	exists(IfStmt target_4 |
		target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getCondition().(Literal).getValue()="1"
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getTarget().hasName("constant_test_bit")
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sme_state"
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getThen().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("variable_test_bit")
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sme_state"
		and target_4.getCondition().(NotExpr).getOperand().(ConditionalExpr).getElse().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
		and target_4.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vwowl_config_3204
		and target_4.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="16777216"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_4.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_16.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_5(Parameter vcfg_3200, PointerFieldAccess target_11) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(ValueFieldAccess).getTarget().getName()="active"
		and target_5.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="wowl"
		and target_5.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vcfg_3200, Parameter vifp_3201, VariableAccess target_6) {
		target_6.getTarget()=vcfg_3200
		and target_6.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brcmf_fil_cmd_int_get")
		and target_6.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vifp_3201
		and target_6.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="85"
		and target_6.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pre_wowl_pmmode"
}

predicate func_7(Parameter vcfg_3200, VariableAccess target_7) {
		target_7.getTarget()=vcfg_3200
}

predicate func_9(Parameter vcfg_3200, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="pre_wowl_pmmode"
		and target_9.getQualifier().(VariableAccess).getTarget()=vcfg_3200
}

predicate func_10(Parameter vcfg_3200, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="wowl_enabled"
		and target_10.getQualifier().(VariableAccess).getTarget()=vcfg_3200
}

predicate func_11(Parameter vcfg_3200, PointerFieldAccess target_11) {
		target_11.getTarget().getName()="bus_if"
		and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="pub"
		and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
}

predicate func_12(Parameter vifp_3201, Parameter vwowl_3202, ExprStmt target_12) {
		target_12.getExpr().(FunctionCall).getTarget().hasName("brcmf_config_wowl_pattern")
		and target_12.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vifp_3201
		and target_12.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="add"
		and target_12.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="pattern"
		and target_12.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_12.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_12.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_12.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="pattern_len"
		and target_12.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_12.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_12.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_12.getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getTarget().getName()="mask"
		and target_12.getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_12.getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_12.getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_12.getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getTarget().getName()="pkt_offset"
		and target_12.getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_12.getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_12.getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
}

predicate func_13(Parameter vifp_3201, Parameter vwowl_3202, ArrayExpr target_13) {
		target_13.getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_13.getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_13.getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("brcmf_config_wowl_pattern")
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vifp_3201
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="add"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="pattern"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="pattern_len"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getTarget().getName()="mask"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="patterns"
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwowl_3202
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("u32")
		and target_13.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(ValueFieldAccess).getTarget().getName()="pkt_offset"
}

predicate func_14(Variable vwowl_config_3204, ExprStmt target_14) {
		target_14.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vwowl_config_3204
		and target_14.getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="2"
}

predicate func_15(Parameter vcfg_3200, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="wowl_enabled"
		and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_3200
		and target_15.getExpr().(AssignExpr).getRValue() instanceof EnumConstantAccess
}

predicate func_16(Parameter vifp_3201, Variable vwowl_config_3204, ExprStmt target_16) {
		target_16.getExpr().(FunctionCall).getTarget().hasName("brcmf_fil_iovar_int_set")
		and target_16.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vifp_3201
		and target_16.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="wowl"
		and target_16.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vwowl_config_3204
}

from Function func, Parameter vcfg_3200, Parameter vifp_3201, Parameter vwowl_3202, Variable vwowl_config_3204, VariableAccess target_6, VariableAccess target_7, PointerFieldAccess target_9, PointerFieldAccess target_10, PointerFieldAccess target_11, ExprStmt target_12, ArrayExpr target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16
where
not func_0(vcfg_3200)
and not func_1(vcfg_3200, vifp_3201, vwowl_3202, vwowl_config_3204, target_11, target_12, target_13, target_14, func)
and not func_4(vwowl_config_3204, target_16, func)
and not func_5(vcfg_3200, target_11)
and func_6(vcfg_3200, vifp_3201, target_6)
and func_7(vcfg_3200, target_7)
and func_9(vcfg_3200, target_9)
and func_10(vcfg_3200, target_10)
and func_11(vcfg_3200, target_11)
and func_12(vifp_3201, vwowl_3202, target_12)
and func_13(vifp_3201, vwowl_3202, target_13)
and func_14(vwowl_config_3204, target_14)
and func_15(vcfg_3200, target_15)
and func_16(vifp_3201, vwowl_config_3204, target_16)
and vcfg_3200.getType().hasName("brcmf_cfg80211_info *")
and vifp_3201.getType().hasName("brcmf_if *")
and vwowl_3202.getType().hasName("cfg80211_wowlan *")
and vwowl_config_3204.getType().hasName("u32")
and vcfg_3200.getFunction() = func
and vifp_3201.getFunction() = func
and vwowl_3202.getFunction() = func
and vwowl_config_3204.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
