/**
 * @name linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-io_prep_async_work
 * @id cpp/linux/4379bf8bd70b5de6bba7d53015b0c36c57a634ee/io-prep-async-work
 * @description linux-4379bf8bd70b5de6bba7d53015b0c36c57a634ee-fs/io_uring.c-io_prep_async_work CVE-2022-20409
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Function func) {
exists(BinaryBitwiseOperation target_1 |
	target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_wq_work *")
	and target_1.getEnclosingFunction() = func)
}

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, DeclStmt target_4) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Parameter vreq_1397, Function func, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("io_req_init_async")
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1397
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Parameter vreq_1397, Function func, IfStmt target_6) {
	target_6.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_6.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_6.getCondition().(BitwiseAndExpr).getRightOperand() instanceof EnumConstantAccess
	and target_6.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_6.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_6.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

/*predicate func_7(Parameter vreq_1397, ExprStmt target_5, VariableAccess target_7) {
	target_7.getTarget()=vreq_1397
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_7.getLocation())
}

*/
predicate func_8(Variable vdef_1399, Parameter vreq_1397, Function func, IfStmt target_8) {
	target_8.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_8.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hash_reg_file"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1399
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="1"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_wq_hash_work")
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="work"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("file_inode")
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="file"
	and target_8.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getTarget().getName()="unbound_nonreg_file"
	and target_8.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1399
	and target_8.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_8.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

/*predicate func_9(Variable vdef_1399, Variable vctx_1400, Parameter vreq_1397, BitwiseAndExpr target_12, IfStmt target_9) {
	target_9.getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="hash_reg_file"
	and target_9.getCondition().(LogicalOrExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1399
	and target_9.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_9.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_9.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_1400
	and target_9.getCondition().(LogicalOrExpr).getRightOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="1"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("io_wq_hash_work")
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="work"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("file_inode")
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="file"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
/*predicate func_10(Variable vdef_1399, Parameter vreq_1397, BitwiseAndExpr target_12, IfStmt target_10) {
	target_10.getCondition().(PointerFieldAccess).getTarget().getName()="unbound_nonreg_file"
	and target_10.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdef_1399
	and target_10.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_10.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_10.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
}

*/
predicate func_12(Parameter vreq_1397, BitwiseAndExpr target_12) {
	target_12.getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_12.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1397
	and target_12.getRightOperand() instanceof EnumConstantAccess
}

from Function func, Variable vdef_1399, Variable vctx_1400, Parameter vreq_1397, DeclStmt target_3, DeclStmt target_4, ExprStmt target_5, IfStmt target_6, IfStmt target_8, BitwiseAndExpr target_12
where
not func_1(func)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(vreq_1397, func, target_5)
and func_6(vreq_1397, func, target_6)
and func_8(vdef_1399, vreq_1397, func, target_8)
and func_12(vreq_1397, target_12)
and vdef_1399.getType().hasName("const io_op_def *")
and vctx_1400.getType().hasName("io_ring_ctx *")
and vreq_1397.getType().hasName("io_kiocb *")
and vdef_1399.(LocalVariable).getFunction() = func
and vctx_1400.(LocalVariable).getFunction() = func
and vreq_1397.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
