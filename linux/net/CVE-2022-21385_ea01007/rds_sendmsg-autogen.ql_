/**
 * @name linux-ea010070d0a7497253d5a6f919f6dd107450b31a-rds_sendmsg
 * @id cpp/linux/ea010070d0a7497253d5a6f919f6dd107450b31a/rds-sendmsg
 * @description linux-ea010070d0a7497253d5a6f919f6dd107450b31a-net/rds/send.c-rds_sendmsg CVE-2022-21385
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(IfStmt target_12, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="incr"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_12.getLocation()))
}

/*predicate func_1(Function func) {
exists(ValueFieldAccess target_1 |
	target_1.getTarget().getName()="incr"
	and target_1.getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_1.getEnclosingFunction() = func)
}

*/
predicate func_3(Parameter vmsg_1066) {
exists(AddressOfExpr target_3 |
	target_3.getOperand().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_rm_size")
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmsg_1066
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int"))
}

predicate func_4(Parameter vmsg_1066, Variable vrs_1069, Variable vrm_1073, Variable vret_1075, Variable vallocated_mr_1076, AddressOfExpr target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, LogicalAndExpr target_17, IfStmt target_18, IfStmt target_20) {
exists(AssignExpr target_4 |
	target_4.getLValue().(VariableAccess).getTarget()=vret_1075
	and target_4.getRValue().(FunctionCall).getTarget().hasName("rds_cmsg_send")
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrs_1069
	and target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vrm_1073
	and target_4.getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsg_1066
	and target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vallocated_mr_1076
	and target_4.getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(2).(VariableAccess).getLocation())
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
	and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getLValue().(VariableAccess).getLocation().isBefore(target_18.getCondition().(VariableAccess).getLocation())
	and target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_20.getCondition().(VariableAccess).getLocation()))
}

/*predicate func_5(Parameter vmsg_1066, Variable vrs_1069, Variable vrm_1073, Variable vallocated_mr_1076) {
exists(AddressOfExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_cmsg_send")
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrs_1069
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vrm_1073
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsg_1066
	and target_5.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vallocated_mr_1076)
}

*/
predicate func_6(Function func) {
exists(ForStmt target_6 |
	target_6.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_6.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_6.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_6.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="indx"
	and target_6.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_6.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_6.getStmt().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_6.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="iov"
	and target_6.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="vec"
	and target_6.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_6.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_7(Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_7.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="vec"
	and target_7.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_8(IfStmt target_20, Function func) {
exists(ForStmt target_8 |
	target_8.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_8.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_8.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_8.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="indx"
	and target_8.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_8.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_8.getStmt().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_8.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="iov"
	and target_8.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="vec"
	and target_8.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and target_8.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getType().hasName("int")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_20.getLocation()))
}

predicate func_9(IfStmt target_20, Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_9.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="vec"
	and target_9.getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("rds_iov_vector_arr")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getLocation().isBefore(target_20.getLocation()))
}

predicate func_10(Parameter vmsg_1066, Variable vret_1075, VariableAccess target_10) {
	target_10.getTarget()=vret_1075
	and target_10.getParent().(AssignExpr).getLValue() = target_10
	and target_10.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_rm_size")
	and target_10.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmsg_1066
	and target_10.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_11(Parameter vmsg_1066, Variable vrs_1069, Variable vrm_1073, Variable vret_1075, Variable vallocated_mr_1076, VariableAccess target_11) {
	target_11.getTarget()=vret_1075
	and target_11.getParent().(AssignExpr).getLValue() = target_11
	and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_cmsg_send")
	and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrs_1069
	and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vrm_1073
	and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vmsg_1066
	and target_11.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vallocated_mr_1076
}

predicate func_12(Parameter vmsg_1066, Variable vret_1075, IfStmt target_12) {
	target_12.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="msg_flags"
	and target_12.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_1066
	and target_12.getCondition().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="2080374719"
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1075
	and target_12.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-95"
	and target_12.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out"
}

predicate func_13(Parameter vmsg_1066, Variable vrm_1073, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="msg_iter"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_1066
	and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_message_copy_from_user")
	and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrm_1073
	and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("bool")
}

predicate func_14(Variable vrs_1069, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("rds_conn_path *")
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="c_path"
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rds_connection *")
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(FunctionCall).getTarget().hasName("rds_send_mprds_hash")
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrs_1069
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("rds_connection *")
	and target_14.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_15(Variable vrs_1069, Variable vret_1075, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1075
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("rds_cong_wait")
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="c_fcong"
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rds_connection *")
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("__be16")
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int")
	and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vrs_1069
}

predicate func_16(Variable vrm_1073, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="m_conn_path"
	and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrm_1073
	and target_16.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("rds_conn_path *")
}

predicate func_17(Variable vrm_1073, LogicalAndExpr target_17) {
	target_17.getLeftOperand().(ValueFieldAccess).getTarget().getName()="op_active"
	and target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="rdma"
	and target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_17.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrm_1073
	and target_17.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="xmit_rdma"
	and target_17.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="c_trans"
	and target_17.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("rds_connection *")
}

predicate func_18(Variable vret_1075, IfStmt target_18) {
	target_18.getCondition().(VariableAccess).getTarget()=vret_1075
	and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vret_1075
	and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="-11"
	and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("rds_conn_connect_if_down")
	and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("rds_connection *")
	and target_18.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out"
}

predicate func_20(Variable vrs_1069, Variable vrm_1073, Variable vallocated_mr_1076, IfStmt target_20) {
	target_20.getCondition().(VariableAccess).getTarget()=vallocated_mr_1076
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("rds_rdma_unuse")
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrs_1069
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("rds_rdma_cookie_key")
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="m_rdma_cookie"
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrm_1073
	and target_20.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="1"
}

from Function func, Parameter vmsg_1066, Variable vrs_1069, Variable vrm_1073, Variable vret_1075, Variable vallocated_mr_1076, VariableAccess target_10, VariableAccess target_11, IfStmt target_12, AddressOfExpr target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, LogicalAndExpr target_17, IfStmt target_18, IfStmt target_20
where
not func_0(target_12, func)
and not func_3(vmsg_1066)
and not func_4(vmsg_1066, vrs_1069, vrm_1073, vret_1075, vallocated_mr_1076, target_13, target_14, target_15, target_16, target_17, target_18, target_20)
and not func_6(func)
and not func_7(func)
and not func_8(target_20, func)
and not func_9(target_20, func)
and func_10(vmsg_1066, vret_1075, target_10)
and func_11(vmsg_1066, vrs_1069, vrm_1073, vret_1075, vallocated_mr_1076, target_11)
and func_12(vmsg_1066, vret_1075, target_12)
and func_13(vmsg_1066, vrm_1073, target_13)
and func_14(vrs_1069, target_14)
and func_15(vrs_1069, vret_1075, target_15)
and func_16(vrm_1073, target_16)
and func_17(vrm_1073, target_17)
and func_18(vret_1075, target_18)
and func_20(vrs_1069, vrm_1073, vallocated_mr_1076, target_20)
and vmsg_1066.getType().hasName("msghdr *")
and vrs_1069.getType().hasName("rds_sock *")
and vrm_1073.getType().hasName("rds_message *")
and vret_1075.getType().hasName("int")
and vallocated_mr_1076.getType().hasName("int")
and vmsg_1066.getFunction() = func
and vrs_1069.(LocalVariable).getFunction() = func
and vrm_1073.(LocalVariable).getFunction() = func
and vret_1075.(LocalVariable).getFunction() = func
and vallocated_mr_1076.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
