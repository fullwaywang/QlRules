/**
 * @name linux-d42334578eba1390859012ebb91e1e556d51db49-exfat_get_uniname_from_ext_entry
 * @id cpp/linux/d42334578eba1390859012ebb91e1e556d51db49/exfat-get-uniname-from-ext-entry
 * @description linux-d42334578eba1390859012ebb91e1e556d51db49-exfat_get_uniname_from_ext_entry CVE-2023-4273
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_0.getRValue() instanceof FunctionCall
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getType().hasName("unsigned int")
		and target_1.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getType().hasName("unsigned int")
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
	exists(IfStmt target_2 |
		target_2.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="15"
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned int")
		and target_2.getCondition().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="255"
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vuniname_33, Variable vep_49, FunctionCall target_3) {
		target_3.getTarget().hasName("exfat_extract_uni_name")
		and target_3.getArgument(0).(VariableAccess).getTarget()=vep_49
		and target_3.getArgument(1).(VariableAccess).getTarget()=vuniname_33
}

from Function func, Parameter vuniname_33, Variable vep_49, FunctionCall target_3
where
not func_0(func)
and not func_1(func)
and not func_2(func)
and func_3(vuniname_33, vep_49, target_3)
and vuniname_33.getType().hasName("unsigned short *")
and vep_49.getType().hasName("exfat_dentry *")
and vuniname_33.getFunction() = func
and vep_49.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
