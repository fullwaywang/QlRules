/**
 * @name v8-185d6116ae7d7771c590f38be8b08530f979d226-v8__internal__compiler__JSNativeContextSpecialization__BuildPropertyLoad_
 * @id cpp/v8/185d6116ae7d7771c590f38be8b08530f979d226/v8internalcompilerjsnativecontextspecializationbuildpropertyload
 * @description v8-185d6116ae7d7771c590f38be8b08530f979d226-src/ic/accessor-assembler.cc-v8__internal__compiler__JSNativeContextSpecialization__BuildPropertyLoad_ CVE-2022-1134
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="2301"
	and not target_0.getValue()="2307"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("V8_Dcheck")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="../../src/compiler/js-native-context-specialization.cc"
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(FunctionCall).getTarget().hasName("c_str")
	and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(FunctionCall).getQualifier().(VariableAccess).getTarget().getType().hasName("string *")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="2305"
	and not target_1.getValue()="2311"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("V8_Dcheck")
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="../../src/compiler/js-native-context-specialization.cc"
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="access_info.IsDataField() || access_info.IsFastDataConstant() || access_info.IsDictionaryProtoDataConstant()"
	and target_1.getEnclosingFunction() = func
}

predicate func_3(Variable vvalue_2283, ExprStmt target_6, ConstructorCall target_7, Function func) {
exists(IfStmt target_3 |
	target_3.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vvalue_2283
	and target_3.getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(0) instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof ReturnStmt
	and target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_3.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation())
	and target_3.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_7.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(Parameter veffect_2272, Parameter vcontrol_2272, Variable vvalue_2283, Function func, ReturnStmt target_5) {
	target_5.getExpr().(ConstructorCall).getArgument(0).(ConstructorCall).getArgument(0).(VariableAccess).getTarget()=vvalue_2283
	and target_5.getExpr().(ConstructorCall).getArgument(0).(ConstructorCall).getArgument(1).(VariableAccess).getTarget()=veffect_2272
	and target_5.getExpr().(ConstructorCall).getArgument(0).(ConstructorCall).getArgument(2).(VariableAccess).getTarget()=vcontrol_2272
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Parameter veffect_2272, Parameter vcontrol_2272, Variable vvalue_2283, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvalue_2283
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("BuildLoadDataField")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getQualifier().(VariableAccess).getTarget().getType().hasName("PropertyAccessBuilder")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("const NameRef &")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("const PropertyAccessInfo &")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("Node *")
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=veffect_2272
	and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vcontrol_2272
}

predicate func_7(Parameter veffect_2272, Parameter vcontrol_2272, Variable vvalue_2283, ConstructorCall target_7) {
	target_7.getArgument(0).(VariableAccess).getTarget()=vvalue_2283
	and target_7.getArgument(1).(VariableAccess).getTarget()=veffect_2272
	and target_7.getArgument(2).(VariableAccess).getTarget()=vcontrol_2272
}

from Function func, Parameter veffect_2272, Parameter vcontrol_2272, Variable vvalue_2283, Literal target_0, Literal target_1, ReturnStmt target_5, ExprStmt target_6, ConstructorCall target_7
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_3(vvalue_2283, target_6, target_7, func)
and func_5(veffect_2272, vcontrol_2272, vvalue_2283, func, target_5)
and func_6(veffect_2272, vcontrol_2272, vvalue_2283, target_6)
and func_7(veffect_2272, vcontrol_2272, vvalue_2283, target_7)
and veffect_2272.getType().hasName("Node *")
and vcontrol_2272.getType().hasName("Node *")
and vvalue_2283.getType().hasName("Node *")
and veffect_2272.getFunction() = func
and vcontrol_2272.getFunction() = func
and vvalue_2283.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
