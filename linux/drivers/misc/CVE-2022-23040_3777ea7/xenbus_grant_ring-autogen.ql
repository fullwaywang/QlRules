/**
 * @name linux-3777ea7bac3113005b7180e6b9dadf16d19a5827-xenbus_grant_ring
 * @id cpp/linux/3777ea7bac3113005b7180e6b9dadf16d19a5827/xenbus-grant-ring
 * @description linux-3777ea7bac3113005b7180e6b9dadf16d19a5827-drivers/xen/xenbus/xenbus_client.c-xenbus_grant_ring CVE-2022-23040
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable verr_381, Variable vgfn_385, Parameter vdev_378, FunctionCall target_0) {
	target_0.getTarget().hasName("gnttab_grant_foreign_access")
	and not target_0.getTarget().hasName("gnttab_alloc_grant_references")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="otherend_id"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_378
	and target_0.getArgument(1).(VariableAccess).getTarget()=vgfn_385
	and target_0.getArgument(2) instanceof Literal
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_381
}

predicate func_1(Parameter vgrefs_379, Variable vj_382, FunctionCall target_1) {
	target_1.getTarget().hasName("gnttab_end_foreign_access_ref")
	and not target_1.getTarget().hasName("gnttab_claim_grant_reference")
	and target_1.getArgument(0).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vgrefs_379
	and target_1.getArgument(0).(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vj_382
	and target_1.getArgument(1).(Literal).getValue()="0"
}

predicate func_4(Function func) {
exists(AddressOfExpr target_4 |
	target_4.getOperand().(VariableAccess).getType().hasName("grant_ref_t")
	and target_4.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_4.getEnclosingFunction() = func)
}

predicate func_5(Function func) {
exists(AddressOfExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("grant_ref_t")
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Parameter vgrefs_379, Variable vi_1_382, Variable vgfn_385, Parameter vdev_378, ExprStmt target_25, RelationalOperation target_26, ExprStmt target_11) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("gnttab_grant_foreign_access_ref")
	and target_6.getArgument(0).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vgrefs_379
	and target_6.getArgument(0).(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1_382
	and target_6.getArgument(1).(PointerFieldAccess).getTarget().getName()="otherend_id"
	and target_6.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_378
	and target_6.getArgument(2).(VariableAccess).getTarget()=vgfn_385
	and target_6.getArgument(3) instanceof Literal
	and target_25.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_6.getArgument(0).(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
	and target_26.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_6.getArgument(0).(ArrayExpr).getArrayOffset().(VariableAccess).getLocation())
	and target_6.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_9(Parameter vvaddr_378, Variable vgfn_385, IfStmt target_9) {
	target_9.getCondition().(FunctionCall).getTarget().hasName("is_vmalloc_addr")
	and target_9.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvaddr_378
	and target_9.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgfn_385
	and target_9.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pfn_to_gfn")
	and target_9.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("vmalloc_to_pfn")
	and target_9.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvaddr_378
	and target_9.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgfn_385
	and target_9.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pfn_to_gfn")
	and target_9.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("__phys_addr")
	and target_9.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvaddr_378
	and target_9.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
}

predicate func_10(Parameter vdev_378, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="otherend_id"
	and target_10.getQualifier().(VariableAccess).getTarget()=vdev_378
	and target_10.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_11(Variable verr_381, Parameter vdev_378, RelationalOperation target_19, ExprStmt target_11) {
	target_11.getExpr().(FunctionCall).getTarget().hasName("xenbus_dev_fatal")
	and target_11.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_378
	and target_11.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=verr_381
	and target_11.getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="granting access to ring page"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

predicate func_12(Parameter vvaddr_378, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvaddr_378
	and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vvaddr_378
	and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getValue()="4096"
}

predicate func_13(Variable verr_381, Function func, ReturnStmt target_13) {
	target_13.getExpr().(VariableAccess).getTarget()=verr_381
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Variable vgfn_385, VariableAccess target_14) {
	target_14.getTarget()=vgfn_385
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_16(Variable verr_381, BlockStmt target_27, VariableAccess target_16) {
	target_16.getTarget()=verr_381
	and target_16.getParent().(LTExpr).getGreaterOperand() instanceof Literal
	and target_16.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_27
}

predicate func_19(Variable verr_381, BlockStmt target_27, RelationalOperation target_19) {
	 (target_19 instanceof GTExpr or target_19 instanceof LTExpr)
	and target_19.getLesserOperand().(VariableAccess).getTarget()=verr_381
	and target_19.getGreaterOperand().(Literal).getValue()="0"
	and target_19.getParent().(IfStmt).getThen()=target_27
}

predicate func_20(RelationalOperation target_19, Function func, GotoStmt target_20) {
	target_20.getName() ="fail"
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Parameter vgrefs_379, Variable verr_381, Variable vi_1_382, VariableAccess target_21) {
	target_21.getTarget()=verr_381
	and target_21.getParent().(AssignExpr).getRValue() = target_21
	and target_21.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vgrefs_379
	and target_21.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1_382
}

predicate func_22(Variable vi_1_382, Variable vj_382, Function func, ForStmt target_22) {
	target_22.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_382
	and target_22.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_22.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vj_382
	and target_22.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vi_1_382
	and target_22.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vj_382
	and target_22.getStmt().(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

/*predicate func_23(Variable vj_382, AssignExpr target_23) {
	target_23.getLValue().(VariableAccess).getTarget()=vj_382
	and target_23.getRValue().(Literal).getValue()="0"
}

*/
predicate func_24(Parameter vgrefs_379, Variable vj_382, ExprStmt target_25, PostfixIncrExpr target_28, VariableAccess target_24) {
	target_24.getTarget()=vj_382
	and target_24.getParent().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vgrefs_379
	and target_25.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_24.getParent().(ArrayExpr).getArrayBase().(VariableAccess).getLocation())
	and target_28.getOperand().(VariableAccess).getLocation().isBefore(target_24.getLocation())
}

predicate func_25(Parameter vgrefs_379, Variable verr_381, Variable vi_1_382, ExprStmt target_25) {
	target_25.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vgrefs_379
	and target_25.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_1_382
	and target_25.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=verr_381
}

predicate func_26(Variable vi_1_382, Variable vj_382, RelationalOperation target_26) {
	 (target_26 instanceof GTExpr or target_26 instanceof LTExpr)
	and target_26.getLesserOperand().(VariableAccess).getTarget()=vj_382
	and target_26.getGreaterOperand().(VariableAccess).getTarget()=vi_1_382
}

predicate func_27(Function func, BlockStmt target_27) {
	target_27.getStmt(0) instanceof ExprStmt
	and target_27.getStmt(1) instanceof GotoStmt
	and target_27.getEnclosingFunction() = func
}

predicate func_28(Variable vj_382, PostfixIncrExpr target_28) {
	target_28.getOperand().(VariableAccess).getTarget()=vj_382
}

from Function func, Parameter vvaddr_378, Parameter vgrefs_379, Variable verr_381, Variable vi_1_382, Variable vj_382, Variable vgfn_385, Parameter vdev_378, FunctionCall target_0, FunctionCall target_1, IfStmt target_9, PointerFieldAccess target_10, ExprStmt target_11, ExprStmt target_12, ReturnStmt target_13, VariableAccess target_14, VariableAccess target_16, RelationalOperation target_19, GotoStmt target_20, VariableAccess target_21, ForStmt target_22, VariableAccess target_24, ExprStmt target_25, RelationalOperation target_26, BlockStmt target_27, PostfixIncrExpr target_28
where
func_0(verr_381, vgfn_385, vdev_378, target_0)
and func_1(vgrefs_379, vj_382, target_1)
and not func_4(func)
and not func_5(func)
and not func_6(vgrefs_379, vi_1_382, vgfn_385, vdev_378, target_25, target_26, target_11)
and func_9(vvaddr_378, vgfn_385, target_9)
and func_10(vdev_378, target_10)
and func_11(verr_381, vdev_378, target_19, target_11)
and func_12(vvaddr_378, target_12)
and func_13(verr_381, func, target_13)
and func_14(vgfn_385, target_14)
and func_16(verr_381, target_27, target_16)
and func_19(verr_381, target_27, target_19)
and func_20(target_19, func, target_20)
and func_21(vgrefs_379, verr_381, vi_1_382, target_21)
and func_22(vi_1_382, vj_382, func, target_22)
and func_24(vgrefs_379, vj_382, target_25, target_28, target_24)
and func_25(vgrefs_379, verr_381, vi_1_382, target_25)
and func_26(vi_1_382, vj_382, target_26)
and func_27(func, target_27)
and func_28(vj_382, target_28)
and vvaddr_378.getType().hasName("void *")
and vgrefs_379.getType().hasName("grant_ref_t *")
and verr_381.getType().hasName("int")
and vi_1_382.getType().hasName("int")
and vj_382.getType().hasName("int")
and vgfn_385.getType().hasName("unsigned long")
and vdev_378.getType().hasName("xenbus_device *")
and vvaddr_378.getFunction() = func
and vgrefs_379.getFunction() = func
and verr_381.(LocalVariable).getFunction() = func
and vi_1_382.(LocalVariable).getFunction() = func
and vj_382.(LocalVariable).getFunction() = func
and vgfn_385.(LocalVariable).getFunction() = func
and vdev_378.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
