/**
 * @name linux-f6d8bd051c391c1c0458a30b2a7abcd939329259-ip_build_and_send_pkt
 * @id cpp/linux/f6d8bd051c391c1c0458a30b2a7abcd939329259/ip-build-and-send-pkt
 * @description linux-f6d8bd051c391c1c0458a30b2a7abcd939329259-net/ipv4/ip_output.c-ip_build_and_send_pkt CVE-2012-3552
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vopt_143, AddExpr target_12) {
	exists(ValueFieldAccess target_1 |
		target_1.getTarget().getName()="optlen"
		and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(ConditionalExpr).getCondition().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vopt_143, LogicalAndExpr target_13) {
	exists(ValueFieldAccess target_3 |
		target_3.getTarget().getName()="optlen"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getAnOperand().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vopt_143, LogicalAndExpr target_13, ExprStmt target_14) {
	exists(ValueFieldAccess target_4 |
		target_4.getTarget().getName()="optlen"
		and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="opt"
		and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_13.getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vopt_143, ExprStmt target_14, ExprStmt target_15) {
	exists(AddressOfExpr target_5 |
		target_5.getOperand().(PointerFieldAccess).getTarget().getName()="opt"
		and target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ip_options_build")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vopt_143
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("__be32")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("rtable *")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
		and target_14.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_6(Parameter vopt_143, VariableAccess target_6) {
		target_6.getTarget()=vopt_143
}

predicate func_7(Parameter vopt_143, PointerFieldAccess target_7) {
		target_7.getTarget().getName()="optlen"
		and target_7.getQualifier().(VariableAccess).getTarget()=vopt_143
}

predicate func_8(Parameter vopt_143, BlockStmt target_16, VariableAccess target_8) {
		target_8.getTarget()=vopt_143
		and target_8.getParent().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_8.getParent().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_8.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_16
}

/*predicate func_9(Parameter vopt_143, PointerFieldAccess target_9) {
		target_9.getTarget().getName()="optlen"
		and target_9.getQualifier().(VariableAccess).getTarget()=vopt_143
}

*/
predicate func_10(Parameter vopt_143, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="optlen"
		and target_10.getQualifier().(VariableAccess).getTarget()=vopt_143
}

predicate func_11(Parameter vopt_143, VariableAccess target_11) {
		target_11.getTarget()=vopt_143
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ip_options_build")
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("__be32")
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("rtable *")
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_12(Parameter vopt_143, AddExpr target_12) {
		target_12.getAnOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_12.getAnOperand().(SizeofTypeOperator).getValue()="20"
		and target_12.getAnOperand().(ConditionalExpr).getCondition().(VariableAccess).getTarget()=vopt_143
		and target_12.getAnOperand().(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_12.getAnOperand().(ConditionalExpr).getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_12.getAnOperand().(ConditionalExpr).getElse().(Literal).getValue()="0"
}

predicate func_13(Parameter vopt_143, LogicalAndExpr target_13) {
		target_13.getAnOperand().(VariableAccess).getTarget()=vopt_143
		and target_13.getAnOperand().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_13.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
}

predicate func_14(Parameter vopt_143, ExprStmt target_14) {
		target_14.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="ihl"
		and target_14.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("iphdr *")
		and target_14.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_14.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_14.getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="2"
}

predicate func_15(Parameter vopt_143, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("ip_options_build")
		and target_15.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_15.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vopt_143
		and target_15.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("__be32")
		and target_15.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("rtable *")
		and target_15.getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_16(Parameter vopt_143, BlockStmt target_16) {
		target_16.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="ihl"
		and target_16.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("iphdr *")
		and target_16.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="optlen"
		and target_16.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_143
		and target_16.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="2"
}

from Function func, Parameter vopt_143, VariableAccess target_6, PointerFieldAccess target_7, VariableAccess target_8, PointerFieldAccess target_10, VariableAccess target_11, AddExpr target_12, LogicalAndExpr target_13, ExprStmt target_14, ExprStmt target_15, BlockStmt target_16
where
not func_1(vopt_143, target_12)
and not func_3(vopt_143, target_13)
and not func_4(vopt_143, target_13, target_14)
and not func_5(vopt_143, target_14, target_15)
and func_6(vopt_143, target_6)
and func_7(vopt_143, target_7)
and func_8(vopt_143, target_16, target_8)
and func_10(vopt_143, target_10)
and func_11(vopt_143, target_11)
and func_12(vopt_143, target_12)
and func_13(vopt_143, target_13)
and func_14(vopt_143, target_14)
and func_15(vopt_143, target_15)
and func_16(vopt_143, target_16)
and vopt_143.getType().hasName("ip_options *")
and vopt_143.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
