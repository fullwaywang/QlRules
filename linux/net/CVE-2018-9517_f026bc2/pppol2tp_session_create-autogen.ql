/**
 * @name linux-f026bc29a8e093edfbb2a77700454b285c97e8ad-pppol2tp_session_create
 * @id cpp/linux/f026bc29a8e093edfbb2a77700454b285c97e8ad/pppol2tp-session-create
 * @description linux-f026bc29a8e093edfbb2a77700454b285c97e8ad-net/l2tp/l2tp_ppp.c-pppol2tp_session_create CVE-2018-9517
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtunnel_796, EqualityOperation target_9, ExprStmt target_10) {
	exists(NotExpr target_0 |
		target_0.getOperand().(PointerFieldAccess).getTarget().getName()="sock"
		and target_0.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtunnel_796
		and target_0.getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_9.getAnOperand().(VariableAccess).getLocation().isBefore(target_0.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable verror_795, Function func, ExprStmt target_1) {
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_795
		and target_1.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-2"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

predicate func_2(Variable vtunnel_796, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="sock"
		and target_2.getQualifier().(VariableAccess).getTarget()=vtunnel_796
		and target_2.getParent().(EQExpr).getAnOperand() instanceof Literal
		and target_2.getParent().(EQExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_3(EqualityOperation target_9, Function func, GotoStmt target_3) {
		target_3.getParent().(IfStmt).getCondition()=target_9
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, DeclStmt target_4) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable vtunnel_796, Parameter vtunnel_id_793, Parameter vnet_793, Function func, ExprStmt target_5) {
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtunnel_796
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("l2tp_tunnel_find")
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_793
		and target_5.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vtunnel_id_793
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vtunnel_796, Function func, IfStmt target_6) {
		target_6.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vtunnel_796
		and target_6.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_6.getThen() instanceof GotoStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vtunnel_796, EqualityOperation target_7) {
		target_7.getAnOperand().(PointerFieldAccess).getTarget().getName()="sock"
		and target_7.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtunnel_796
		and target_7.getAnOperand().(Literal).getValue()="0"
		and target_7.getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_8(EqualityOperation target_7, Function func, GotoStmt target_8) {
		target_8.getParent().(IfStmt).getCondition()=target_7
		and target_8.getEnclosingFunction() = func
}

predicate func_9(Variable vtunnel_796, EqualityOperation target_9) {
		target_9.getAnOperand().(VariableAccess).getTarget()=vtunnel_796
		and target_9.getAnOperand() instanceof Literal
}

predicate func_10(Variable vtunnel_796, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("l2tp_session *")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("l2tp_session_create")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofTypeOperator).getType() instanceof LongType
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofTypeOperator).getValue()="32"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vtunnel_796
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u32")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("u32")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("l2tp_session_cfg *")
}

from Function func, Variable verror_795, Variable vtunnel_796, Parameter vtunnel_id_793, Parameter vnet_793, ExprStmt target_1, PointerFieldAccess target_2, GotoStmt target_3, DeclStmt target_4, ExprStmt target_5, IfStmt target_6, EqualityOperation target_7, GotoStmt target_8, EqualityOperation target_9, ExprStmt target_10
where
not func_0(vtunnel_796, target_9, target_10)
and func_1(verror_795, func, target_1)
and func_2(vtunnel_796, target_2)
and func_3(target_9, func, target_3)
and func_4(func, target_4)
and func_5(vtunnel_796, vtunnel_id_793, vnet_793, func, target_5)
and func_6(vtunnel_796, func, target_6)
and func_7(vtunnel_796, target_7)
and func_8(target_7, func, target_8)
and func_9(vtunnel_796, target_9)
and func_10(vtunnel_796, target_10)
and verror_795.getType().hasName("int")
and vtunnel_796.getType().hasName("l2tp_tunnel *")
and vtunnel_id_793.getType().hasName("u32")
and vnet_793.getType().hasName("net *")
and verror_795.(LocalVariable).getFunction() = func
and vtunnel_796.(LocalVariable).getFunction() = func
and vtunnel_id_793.getFunction() = func
and vnet_793.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
