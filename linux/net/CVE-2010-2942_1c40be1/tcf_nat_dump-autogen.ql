/**
 * @name linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-tcf_nat_dump
 * @id cpp/linux/1c40be12f7d8ca1d387510d39787b12e512a7ce8/tcf-nat-dump
 * @description linux-1c40be12f7d8ca1d387510d39787b12e512a7ce8-net/sched/act_nat.c-tcf_nat_dump CVE-2010-2942
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vp_274, PointerFieldAccess target_1) {
		target_1.getTarget().getName()="old_addr"
		and target_1.getQualifier().(VariableAccess).getTarget()=vp_274
		and target_1.getParent().(AssignExpr).getRValue() = target_1
		and target_1.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_2(Variable vp_274, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="new_addr"
		and target_2.getQualifier().(VariableAccess).getTarget()=vp_274
		and target_2.getParent().(AssignExpr).getRValue() = target_2
		and target_2.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_3(Variable vp_274, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="mask"
		and target_3.getQualifier().(VariableAccess).getTarget()=vp_274
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_4(Variable vp_274, PointerFieldAccess target_4) {
		target_4.getTarget().getName()="flags"
		and target_4.getQualifier().(VariableAccess).getTarget()=vp_274
		and target_4.getParent().(AssignExpr).getRValue() = target_4
		and target_4.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_5(Variable vp_274, ValueFieldAccess target_5) {
		target_5.getTarget().getName()="tcfc_index"
		and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
}

predicate func_6(Variable vp_274, ValueFieldAccess target_6) {
		target_6.getTarget().getName()="tcfc_action"
		and target_6.getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_6.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
}

predicate func_7(Parameter vref_271, Variable vp_274, SubExpr target_7) {
		target_7.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_refcnt"
		and target_7.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_7.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and target_7.getRightOperand().(VariableAccess).getTarget()=vref_271
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_8(Parameter vbind_271, Variable vp_274, SubExpr target_8) {
		target_8.getLeftOperand().(ValueFieldAccess).getTarget().getName()="tcfc_bindcnt"
		and target_8.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="common"
		and target_8.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and target_8.getRightOperand().(VariableAccess).getTarget()=vbind_271
		and target_8.getParent().(AssignExpr).getRValue() = target_8
		and target_8.getParent().(AssignExpr).getLValue() instanceof ValueFieldAccess
}

predicate func_9(Variable vp_274, Variable vopt_275, Function func, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="old_addr"
		and target_9.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="old_addr"
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vp_274, Variable vopt_275, Function func, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="new_addr"
		and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="new_addr"
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vp_274, Variable vopt_275, Function func, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mask"
		and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mask"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vp_274, Variable vopt_275, Function func, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
		and target_12.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="flags"
		and target_12.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_274
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Variable vopt_275, Function func, ExprStmt target_13) {
		target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="index"
		and target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_13.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Variable vopt_275, Function func, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="action"
		and target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_14.getExpr().(AssignExpr).getRValue() instanceof ValueFieldAccess
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Variable vopt_275, Function func, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="refcnt"
		and target_15.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_15.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Variable vopt_275, Function func, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="bindcnt"
		and target_16.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vopt_275
		and target_16.getExpr().(AssignExpr).getRValue() instanceof SubExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

from Function func, Parameter vbind_271, Parameter vref_271, Variable vp_274, Variable vopt_275, PointerFieldAccess target_1, PointerFieldAccess target_2, PointerFieldAccess target_3, PointerFieldAccess target_4, ValueFieldAccess target_5, ValueFieldAccess target_6, SubExpr target_7, SubExpr target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, ExprStmt target_12, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16
where
func_1(vp_274, target_1)
and func_2(vp_274, target_2)
and func_3(vp_274, target_3)
and func_4(vp_274, target_4)
and func_5(vp_274, target_5)
and func_6(vp_274, target_6)
and func_7(vref_271, vp_274, target_7)
and func_8(vbind_271, vp_274, target_8)
and func_9(vp_274, vopt_275, func, target_9)
and func_10(vp_274, vopt_275, func, target_10)
and func_11(vp_274, vopt_275, func, target_11)
and func_12(vp_274, vopt_275, func, target_12)
and func_13(vopt_275, func, target_13)
and func_14(vopt_275, func, target_14)
and func_15(vopt_275, func, target_15)
and func_16(vopt_275, func, target_16)
and vbind_271.getType().hasName("int")
and vref_271.getType().hasName("int")
and vp_274.getType().hasName("tcf_nat *")
and vopt_275.getType().hasName("tc_nat")
and vbind_271.getFunction() = func
and vref_271.getFunction() = func
and vp_274.(LocalVariable).getFunction() = func
and vopt_275.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
