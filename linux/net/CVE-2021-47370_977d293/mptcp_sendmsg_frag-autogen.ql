/**
 * @name linux-977d293e23b48a1129830d7968605f61c4af71a0-mptcp_sendmsg_frag
 * @id cpp/linux/977d293e23b48a1129830d7968605f61c4af71a0/mptcp-sendmsg-frag
 * @description linux-977d293e23b48a1129830d7968605f61c4af71a0-net/mptcp/protocol.c-mptcp_sendmsg_frag CVE-2021-47370
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vinfo_1287, PointerFieldAccess target_0) {
	target_0.getTarget().getName()="size_goal"
	and target_0.getQualifier().(VariableAccess).getTarget()=vinfo_1287
}

predicate func_1(Variable vskb_1293, PointerFieldAccess target_1) {
	target_1.getTarget().getName()="len"
	and target_1.getQualifier().(VariableAccess).getTarget()=vskb_1293
}

predicate func_2(Variable vmust_collapse_1294, NotExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vmust_collapse_1294
}

predicate func_3(Parameter vinfo_1287, Variable vskb_1293, ExprStmt target_6, ExprStmt target_7, SubExpr target_3) {
	target_3.getLeftOperand().(PointerFieldAccess).getTarget().getName()="size_goal"
	and target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1287
	and target_3.getRightOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_3.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1293
	and target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_5(Parameter vinfo_1287, Parameter vssk_1285, ReturnStmt target_8, LogicalAndExpr target_5) {
	target_5.getLeftOperand() instanceof NotExpr
	and target_5.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_tx_skb_cache"
	and target_5.getRightOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vssk_1285
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("mptcp_alloc_tx_skb")
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sock *")
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vssk_1285
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="data_lock_held"
	and target_5.getParent().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1287
	and target_5.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_8
}

predicate func_6(Parameter vinfo_1287, Variable vskb_1293, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_6.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="size_goal"
	and target_6.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1287
	and target_6.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_6.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_1293
}

predicate func_7(Variable vskb_1293, Variable vmust_collapse_1294, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vmust_collapse_1294
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand() instanceof SubExpr
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand() instanceof Literal
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_1293
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_8(LogicalAndExpr target_9, Function func, ReturnStmt target_8) {
	target_8.getExpr().(Literal).getValue()="0"
	and target_8.getParent().(IfStmt).getCondition()=target_9
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vinfo_1287, Parameter vssk_1285, LogicalAndExpr target_9) {
	target_9.getLeftOperand() instanceof LogicalAndExpr
	and target_9.getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("mptcp_alloc_tx_skb")
	and target_9.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sock *")
	and target_9.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vssk_1285
	and target_9.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="data_lock_held"
	and target_9.getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_1287
}

from Function func, Parameter vinfo_1287, Variable vskb_1293, Variable vmust_collapse_1294, Parameter vssk_1285, PointerFieldAccess target_0, PointerFieldAccess target_1, NotExpr target_2, SubExpr target_3, LogicalAndExpr target_5, ExprStmt target_6, ExprStmt target_7, ReturnStmt target_8, LogicalAndExpr target_9
where
func_0(vinfo_1287, target_0)
and func_1(vskb_1293, target_1)
and func_2(vmust_collapse_1294, target_2)
and func_3(vinfo_1287, vskb_1293, target_6, target_7, target_3)
and func_5(vinfo_1287, vssk_1285, target_8, target_5)
and func_6(vinfo_1287, vskb_1293, target_6)
and func_7(vskb_1293, vmust_collapse_1294, target_7)
and func_8(target_9, func, target_8)
and func_9(vinfo_1287, vssk_1285, target_9)
and vinfo_1287.getType().hasName("mptcp_sendmsg_info *")
and vskb_1293.getType().hasName("sk_buff *")
and vmust_collapse_1294.getType().hasName("bool")
and vssk_1285.getType().hasName("sock *")
and vinfo_1287.getFunction() = func
and vskb_1293.(LocalVariable).getFunction() = func
and vmust_collapse_1294.(LocalVariable).getFunction() = func
and vssk_1285.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
