/**
 * @name linux-7aed44babc7f97e82b38e9a68515e699692cc100-vringh_iov_xfer
 * @id cpp/linux/7aed44babc7f97e82b38e9a68515e699692cc100/vringh-iov-xfer
 * @description linux-7aed44babc7f97e82b38e9a68515e699692cc100-drivers/vhost/vringh.c-vringh_iov_xfer CVE-2023-5158
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter viov_108, Variable vpartlen_117) {
exists(AssignAddExpr target_0 |
	target_0.getLValue().(PointerFieldAccess).getTarget().getName()="consumed"
	and target_0.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_0.getRValue().(VariableAccess).getTarget()=vpartlen_117)
}

predicate func_1(Parameter viov_108, Variable vpartlen_117) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_len"
	and target_1.getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_1.getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_1.getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="i"
	and target_1.getExpr().(AssignSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_1.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vpartlen_117)
}

predicate func_2(Parameter viov_108, Variable vpartlen_117) {
exists(ExprStmt target_2 |
	target_2.getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_base"
	and target_2.getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_2.getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_2.getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="i"
	and target_2.getExpr().(AssignPointerAddExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_2.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vpartlen_117)
}

predicate func_3(Parameter viov_108) {
exists(IfStmt target_3 |
	target_3.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="iov_len"
	and target_3.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_3.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_3.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="i"
	and target_3.getCondition().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_len"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="i"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="consumed"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerSubExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_base"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="iov"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerSubExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="i"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerSubExpr).getRValue().(PointerFieldAccess).getTarget().getName()="consumed"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerSubExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="consumed"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="i"
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=viov_108)
}

predicate func_4(Parameter viov_108, VariableAccess target_4) {
	target_4.getTarget()=viov_108
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Variable vpartlen_117, VariableAccess target_5) {
	target_5.getTarget()=vpartlen_117
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_6(Parameter viov_108, Variable vpartlen_117, FunctionCall target_6) {
	target_6.getTarget().hasName("vringh_kiov_advance")
	and target_6.getArgument(0).(VariableAccess).getTarget()=viov_108
	and target_6.getArgument(1).(VariableAccess).getTarget()=vpartlen_117
}

from Function func, Parameter viov_108, Variable vpartlen_117, VariableAccess target_4, VariableAccess target_5, FunctionCall target_6
where
not func_0(viov_108, vpartlen_117)
and not func_1(viov_108, vpartlen_117)
and not func_2(viov_108, vpartlen_117)
and not func_3(viov_108)
and func_4(viov_108, target_4)
and func_5(vpartlen_117, target_5)
and func_6(viov_108, vpartlen_117, target_6)
and viov_108.getType().hasName("vringh_kiov *")
and vpartlen_117.getType().hasName("size_t")
and viov_108.getFunction() = func
and vpartlen_117.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
