/**
 * @name linux-6402939ec86eaf226c8b8ae00ed983936b164908-ca8210_probe
 * @id cpp/linux/6402939ec86eaf226c8b8ae00ed983936b164908/ca8210-probe
 * @description linux-6402939ec86eaf226c8b8ae00ed983936b164908-drivers/net/ieee802154/ca8210.c-ca8210_probe CVE-2019-19075
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpriv_3110, Variable vpdata_3112, IfStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="platform_data"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="spi"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpriv_3110
	and target_0.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vpdata_3112
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Function func, IfStmt target_1) {
	target_1.getCondition().(VariableAccess).getTarget().getType().hasName("int")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_crit")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("spi_device *")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="ca8210_get_platform_data failed\n"
	and target_1.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="error"
	and target_1.getEnclosingFunction() = func
}

from Function func, Variable vpriv_3110, Variable vpdata_3112, ExprStmt target_0, IfStmt target_1
where
func_0(vpriv_3110, vpdata_3112, target_1, target_0)
and func_1(func, target_1)
and vpriv_3110.getType().hasName("ca8210_priv *")
and vpdata_3112.getType().hasName("ca8210_platform_data *")
and vpriv_3110.(LocalVariable).getFunction() = func
and vpdata_3112.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
