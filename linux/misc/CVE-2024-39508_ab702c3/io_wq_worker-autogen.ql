/**
 * @name linux-ab702c3483db9046bab9f40306f1a28b22dbbdc0-io_wq_worker
 * @id cpp/linux/ab702c3483db9046bab9f40306f1a28b22dbbdc0/io-wq-worker
 * @description linux-ab702c3483db9046bab9f40306f1a28b22dbbdc0-io_uring/io-wq.c-io_wq_worker CVE-2024-39508
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1320"
	and not target_0.getValue()="1321"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="1321"
	and not target_1.getValue()="1322"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="1322"
	and not target_2.getValue()="1323"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, Literal target_3) {
	target_3.getValue()="1323"
	and not target_3.getValue()="1324"
	and target_3.getEnclosingFunction() = func
}

predicate func_6(Function func) {
exists(StmtExpr target_6 |
	exists(BlockStmt obj_0 | obj_0=target_6.getStmt() |
		obj_0.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
		and obj_0.getStmt(3).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
		and obj_0.getStmt(4).(ExprStmt).getExpr().(VariableAccess).getType().hasName("unsigned long")
	)
	and target_6.getEnclosingFunction() = func
)
}

/*predicate func_7(Function func) {
exists(ExprStmt target_7 |
	exists(AssignExpr obj_0 | obj_0=target_7.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("unsigned long")
		and obj_0.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	)
	and target_7.getEnclosingFunction() = func
)
}

*/
/*predicate func_8(Function func) {
exists(DoStmt target_8 |
	exists(NotExpr obj_0 | obj_0=target_8.getCondition() |
		exists(StmtExpr obj_1 | obj_1=obj_0.getOperand() |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(3) |
					exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
						obj_4.getTarget().hasName("instrument_atomic_read_write")
						and obj_4.getArgument(0).(VariableAccess).getType().hasName("unsigned long *")
					)
				)
				and exists(ExprStmt obj_5 | obj_5=obj_2.getStmt(4) |
					exists(FunctionCall obj_6 | obj_6=obj_5.getExpr() |
						obj_6.getTarget().hasName("instrument_read_write")
						and obj_6.getArgument(0).(VariableAccess).getType().hasName("unsigned long *")
					)
				)
				and obj_2.getStmt(2).(DoStmt).getCondition().(Literal).getValue()="0"
			)
		)
	)
	and exists(BlockStmt obj_7 | obj_7=target_8.getStmt() |
		exists(ExprStmt obj_8 | obj_8=obj_7.getStmt(0) |
			exists(AssignExpr obj_9 | obj_9=obj_8.getExpr() |
				exists(BitwiseOrExpr obj_10 | obj_10=obj_9.getRValue() |
					obj_10.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getType().hasName("unsigned long")
					and obj_10.getRightOperand().(VariableAccess).getType().hasName("unsigned long")
				)
				and obj_9.getLValue().(VariableAccess).getType().hasName("unsigned long")
			)
		)
	)
	and target_8.getEnclosingFunction() = func
)
}

*/
/*predicate func_9(Function func) {
exists(ExprStmt target_9 |
	target_9.getExpr().(VariableAccess).getType().hasName("unsigned long")
	and target_9.getEnclosingFunction() = func
)
}

*/
predicate func_10(Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1324"
	and target_10.getEnclosingFunction() = func
)
}

predicate func_11(Function func, ExprStmt target_11) {
	target_11.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vworker_631, PointerFieldAccess target_12) {
	target_12.getTarget().getName()="flags"
	and target_12.getQualifier().(VariableAccess).getTarget()=vworker_631
}

predicate func_13(Variable vworker_631, AssignOrExpr target_13) {
	exists(PointerFieldAccess obj_0 | obj_0=target_13.getLValue() |
		obj_0.getTarget().getName()="flags"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vworker_631
	)
	and target_13.getRValue().(BitwiseOrExpr).getValue()="3"
}

from Function func, Variable vworker_631, Literal target_0, Literal target_1, Literal target_2, Literal target_3, ExprStmt target_11, PointerFieldAccess target_12, AssignOrExpr target_13
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and not func_6(func)
and not func_10(func)
and func_11(func, target_11)
and func_12(vworker_631, target_12)
and func_13(vworker_631, target_13)
and vworker_631.getType().hasName("io_worker *")
and vworker_631.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
