/**
 * @name linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-perf_compat_ioctl
 * @id cpp/linux/f63a8daa5812afef4f06c962351687e1ff9ccb2b/perf-compat-ioctl
 * @description linux-f63a8daa5812afef4f06c962351687e1ff9ccb2b-kernel/events/core.c-perf_compat_ioctl CVE-2016-6786
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1"
	and not target_0.getValue()="3859"
	and target_0.getParent().(LShiftExpr).getParent().(SubExpr).getLeftOperand() instanceof BinaryBitwiseOperation
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vfile_3877, Parameter vcmd_3877, Parameter varg_3878, FunctionCall target_1) {
	target_1.getTarget().hasName("perf_ioctl")
	and not target_1.getTarget().hasName("__builtin_expect")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vfile_3877
	and target_1.getArgument(1).(VariableAccess).getTarget()=vcmd_3877
	and target_1.getArgument(2).(VariableAccess).getTarget()=varg_3878
}

predicate func_2(SwitchStmt target_14, Function func) {
exists(DoStmt target_2 |
	target_2.getCondition() instanceof Literal
	and target_2.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_2.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_14.getLocation()))
}

/*predicate func_3(Function func) {
exists(StmtExpr target_3 |
	target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("warn_slowpath_null")
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_3.getEnclosingFunction() = func)
}

*/
/*predicate func_4(Function func) {
exists(NotExpr target_4 |
	target_4.getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_4.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr() instanceof FunctionCall
	and target_4.getEnclosingFunction() = func)
}

*/
/*predicate func_5(EqualityOperation target_17, Function func) {
exists(ExprStmt target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("warn_slowpath_null")
	and target_5.getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_5.getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_5.getParent().(IfStmt).getCondition()=target_17
	and target_5.getEnclosingFunction() = func)
}

*/
/*predicate func_6(EqualityOperation target_17, Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_6.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_6.getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_6
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
	and target_6.getEnclosingFunction() = func)
}

*/
predicate func_7(SwitchStmt target_14, Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("perf_event *")
	and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="group_leader"
	and target_7.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_14.getLocation()))
}

predicate func_8(SwitchStmt target_14, Function func) {
exists(ExprStmt target_8 |
	target_8.getExpr().(FunctionCall).getTarget().hasName("perf_event_for_each_child")
	and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("perf_event *")
	and target_8.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("..(*)(..)")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_14.getLocation()))
}

predicate func_9(SwitchStmt target_14, Function func) {
exists(ForStmt target_9 |
	target_9.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("perf_event *")
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="group_entry"
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event *")
	and target_9.getCondition().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sibling_list"
	and target_9.getCondition().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("perf_event *")
	and target_9.getUpdate().(AssignExpr).getLValue().(VariableAccess).getType().hasName("perf_event *")
	and target_9.getUpdate().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getType().hasName("const list_head *")
	and target_9.getStmt().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("perf_event_for_each_child")
	and target_9.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("perf_event *")
	and target_9.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("..(*)(..)")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getLocation().isBefore(target_14.getLocation()))
}

/*predicate func_10(Function func) {
exists(PointerArithmeticOperation target_10 |
	target_10.getLeftOperand().(VariableAccess).getType().hasName("const list_head *")
	and target_10.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="16"
	and target_10.getEnclosingFunction() = func)
}

*/
predicate func_14(Parameter vcmd_3877, Function func, SwitchStmt target_14) {
	target_14.getExpr().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vcmd_3877
	and target_14.getExpr().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
	and target_14.getExpr().(BitwiseAndExpr).getRightOperand().(SubExpr).getValue()="255"
	and target_14.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(BitwiseAndExpr).getValue()="6"
	and target_14.getStmt().(BlockStmt).getStmt(1).(SwitchCase).getExpr().(BitwiseAndExpr).getValue()="7"
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vcmd_3877
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(SubExpr).getValue()="16383"
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(SizeofTypeOperator).getValue()="4"
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=vcmd_3877
	and target_14.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vcmd_3877
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

/*predicate func_15(Function func, SwitchCase target_15) {
	target_15.getExpr().(BitwiseAndExpr).getValue()="6"
	and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_16(Function func, SwitchCase target_16) {
	target_16.getExpr().(BitwiseAndExpr).getValue()="7"
	and target_16.getEnclosingFunction() = func
}

*/
/*predicate func_17(Parameter vcmd_3877, BlockStmt target_21, EqualityOperation target_17) {
	target_17.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vcmd_3877
	and target_17.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(AddExpr).getValue()="16"
	and target_17.getLeftOperand().(BitwiseAndExpr).getRightOperand().(SubExpr).getValue()="16383"
	and target_17.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_17.getRightOperand().(SizeofTypeOperator).getValue()="4"
	and target_17.getParent().(IfStmt).getThen()=target_21
}

*/
/*predicate func_18(Parameter vcmd_3877, AssignAndExpr target_18) {
	target_18.getLValue().(VariableAccess).getTarget()=vcmd_3877
	and target_18.getRValue().(ComplementExpr).getValue()="3221291007"
}

*/
/*predicate func_19(Parameter vcmd_3877, AssignOrExpr target_19) {
	target_19.getLValue().(VariableAccess).getTarget()=vcmd_3877
	and target_19.getRValue().(BinaryBitwiseOperation).getValue()="524288"
}

*/
/*predicate func_20(BitwiseAndExpr target_22, Function func, BreakStmt target_20) {
	target_20.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_22
	and target_20.getEnclosingFunction() = func
}

*/
predicate func_21(Function func, BlockStmt target_21) {
	target_21.getStmt(0).(ExprStmt).getExpr() instanceof AssignAndExpr
	and target_21.getStmt(1).(ExprStmt).getExpr() instanceof AssignOrExpr
	and target_21.getEnclosingFunction() = func
}

predicate func_22(Function func, BitwiseAndExpr target_22) {
	target_22.getLeftOperand() instanceof BinaryBitwiseOperation
	and target_22.getRightOperand() instanceof SubExpr
	and target_22.getEnclosingFunction() = func
}

from Function func, Parameter vfile_3877, Parameter vcmd_3877, Parameter varg_3878, Literal target_0, FunctionCall target_1, SwitchStmt target_14, BlockStmt target_21, BitwiseAndExpr target_22
where
func_0(func, target_0)
and func_1(vfile_3877, vcmd_3877, varg_3878, target_1)
and not func_2(target_14, func)
and not func_7(target_14, func)
and not func_8(target_14, func)
and not func_9(target_14, func)
and func_14(vcmd_3877, func, target_14)
and func_21(func, target_21)
and func_22(func, target_22)
and vfile_3877.getType().hasName("file *")
and vcmd_3877.getType().hasName("unsigned int")
and varg_3878.getType().hasName("unsigned long")
and vfile_3877.getFunction() = func
and vcmd_3877.getFunction() = func
and varg_3878.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
