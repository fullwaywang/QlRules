/**
 * @name linux-b5fdf5c6e6bee35837e160c00ac89327bdad031b-max3421_set_address
 * @id cpp/linux/b5fdf5c6e6bee35837e160c00ac89327bdad031b/max3421-set-address
 * @description linux-b5fdf5c6e6bee35837e160c00ac89327bdad031b-drivers/usb/host/max3421-hcd.c-max3421_set_address CVE-2021-38204
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_3(Function func, DeclStmt target_3) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Function func, DeclStmt target_4) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable vmax3421_hcd_498, Variable vold_dev_500, Function func, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vold_dev_500
	and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="loaded_dev"
	and target_5.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmax3421_hcd_498
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vmax3421_hcd_498, Variable vold_epnum_499, Function func, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vold_epnum_499
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="loaded_epnum"
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmax3421_hcd_498
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Parameter vdev_495, Parameter vepnum_495, Variable vold_epnum_499, Variable vsame_ep_499, Variable vold_dev_500, Function func, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsame_ep_499
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vdev_495
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vold_dev_500
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vepnum_495
	and target_7.getExpr().(AssignExpr).getRValue().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Parameter vforce_toggles_496, Variable vsame_ep_499, Function func, IfStmt target_8) {
	target_8.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vsame_ep_499
	and target_8.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vforce_toggles_496
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vold_epnum_499, Variable vsame_ep_499, Variable vrcvtog_499, Variable vsndtog_499, Variable vold_dev_500, Variable vhrsl_512, Function func, IfStmt target_9) {
	target_9.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vold_dev_500
	and target_9.getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vsame_ep_499
	and target_9.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrcvtog_499
	and target_9.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vhrsl_512
	and target_9.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsndtog_499
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vhrsl_512
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vrcvtog_499
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and target_9.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_9.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_9.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
	and target_9.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vsndtog_499
	and target_9.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(LogicalAndExpr target_17, Function func, DeclStmt target_10) {
	target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
	and target_10.getEnclosingFunction() = func
}

/*predicate func_11(Variable vrcvtog_499, Variable vhrsl_512, LogicalAndExpr target_17, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrcvtog_499
	and target_11.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vhrsl_512
	and target_11.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_12(Variable vsndtog_499, Variable vhrsl_512, LogicalAndExpr target_17, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsndtog_499
	and target_12.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vhrsl_512
	and target_12.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_13(Variable vold_epnum_499, Variable vrcvtog_499, Variable vold_dev_500, LogicalAndExpr target_17, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getOperand().(BinaryBitwiseOperation).getLeftOperand().(Literal).getValue()="1"
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vrcvtog_499
	and target_13.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
/*predicate func_14(Variable vold_epnum_499, Variable vsndtog_499, Variable vold_dev_500, LogicalAndExpr target_17, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="toggle"
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vold_dev_500
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getOperand().(BinaryBitwiseOperation).getLeftOperand().(Literal).getValue()="1"
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getLeftOperand().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=vsndtog_499
	and target_14.getExpr().(AssignExpr).getRValue().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vold_epnum_499
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

*/
predicate func_15(Parameter vepnum_495, Variable vmax3421_hcd_498, Function func, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="loaded_epnum"
	and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmax3421_hcd_498
	and target_15.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vepnum_495
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Parameter vdev_495, Variable vmax3421_hcd_498, Function func, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="loaded_dev"
	and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmax3421_hcd_498
	and target_16.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdev_495
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(Variable vold_dev_500, LogicalAndExpr target_17) {
	target_17.getLeftOperand().(VariableAccess).getTarget()=vold_dev_500
	and target_17.getRightOperand() instanceof NotExpr
}

from Function func, Parameter vdev_495, Parameter vepnum_495, Parameter vforce_toggles_496, Variable vmax3421_hcd_498, Variable vold_epnum_499, Variable vsame_ep_499, Variable vrcvtog_499, Variable vsndtog_499, Variable vold_dev_500, Variable vhrsl_512, DeclStmt target_3, DeclStmt target_4, ExprStmt target_5, ExprStmt target_6, ExprStmt target_7, IfStmt target_8, IfStmt target_9, DeclStmt target_10, ExprStmt target_15, ExprStmt target_16, LogicalAndExpr target_17
where
func_3(func, target_3)
and func_4(func, target_4)
and func_5(vmax3421_hcd_498, vold_dev_500, func, target_5)
and func_6(vmax3421_hcd_498, vold_epnum_499, func, target_6)
and func_7(vdev_495, vepnum_495, vold_epnum_499, vsame_ep_499, vold_dev_500, func, target_7)
and func_8(vforce_toggles_496, vsame_ep_499, func, target_8)
and func_9(vold_epnum_499, vsame_ep_499, vrcvtog_499, vsndtog_499, vold_dev_500, vhrsl_512, func, target_9)
and func_10(target_17, func, target_10)
and func_15(vepnum_495, vmax3421_hcd_498, func, target_15)
and func_16(vdev_495, vmax3421_hcd_498, func, target_16)
and func_17(vold_dev_500, target_17)
and vdev_495.getType().hasName("usb_device *")
and vepnum_495.getType().hasName("int")
and vforce_toggles_496.getType().hasName("int")
and vmax3421_hcd_498.getType().hasName("max3421_hcd *")
and vold_epnum_499.getType().hasName("int")
and vsame_ep_499.getType().hasName("int")
and vrcvtog_499.getType().hasName("int")
and vsndtog_499.getType().hasName("int")
and vold_dev_500.getType().hasName("usb_device *")
and vhrsl_512.getType().hasName("u8")
and vdev_495.getFunction() = func
and vepnum_495.getFunction() = func
and vforce_toggles_496.getFunction() = func
and vmax3421_hcd_498.(LocalVariable).getFunction() = func
and vold_epnum_499.(LocalVariable).getFunction() = func
and vsame_ep_499.(LocalVariable).getFunction() = func
and vrcvtog_499.(LocalVariable).getFunction() = func
and vsndtog_499.(LocalVariable).getFunction() = func
and vold_dev_500.(LocalVariable).getFunction() = func
and vhrsl_512.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
