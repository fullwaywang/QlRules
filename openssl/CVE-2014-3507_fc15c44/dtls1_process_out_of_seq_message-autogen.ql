/**
 * @name openssl-fc15c440498f815e384f496c5913fe1db9f69a28-dtls1_process_out_of_seq_message
 * @id cpp/openssl/fc15c440498f815e384f496c5913fe1db9f69a28/dtls1-process-out-of-seq-message
 * @description openssl-fc15c440498f815e384f496c5913fe1db9f69a28-ssl/d1_both.c-dtls1_process_out_of_seq_message CVE-2014-3507
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vi_708, LogicalOrExpr target_4, ReturnStmt target_5) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_708
		and target_0.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-1"
		and target_0.getParent().(IfStmt).getCondition()=target_4
		and target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getExpr().(VariableAccess).getLocation()))
}

predicate func_1(VariableAccess target_6, Function func) {
	exists(IfStmt target_1 |
		target_1.getCondition() instanceof RelationalOperation
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(Variable vi_708, Variable vfrag_len_712, RelationalOperation target_2) {
		 (target_2 instanceof GEExpr or target_2 instanceof LEExpr)
		and target_2.getLesserOperand().(VariableAccess).getTarget()=vi_708
		and target_2.getGreaterOperand().(Literal).getValue()="0"
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vi_708
		and target_2.getParent().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vfrag_len_712
		and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

/*predicate func_3(Variable vi_708, Variable vfrag_len_712, EqualityOperation target_3) {
		target_3.getAnOperand().(VariableAccess).getTarget()=vi_708
		and target_3.getAnOperand().(VariableAccess).getTarget()=vfrag_len_712
		and target_3.getParent().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_708
		and target_3.getParent().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_3.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen() instanceof GotoStmt
}

*/
predicate func_4(Function func, LogicalOrExpr target_4) {
		target_4.getAnOperand() instanceof RelationalOperation
		and target_4.getAnOperand() instanceof EqualityOperation
		and target_4.getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vi_708, ReturnStmt target_5) {
		target_5.getExpr().(VariableAccess).getTarget()=vi_708
}

predicate func_6(Variable vfrag_len_712, BlockStmt target_7, VariableAccess target_6) {
		target_6.getTarget()=vfrag_len_712
		and target_6.getParent().(IfStmt).getThen()=target_7
}

predicate func_7(Variable vi_708, Variable vfrag_len_712, BlockStmt target_7) {
		target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_708
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="ssl_read_bytes"
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(Literal).getValue()="22"
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="fragment"
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("hm_fragment *")
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(3).(VariableAccess).getTarget()=vfrag_len_712
		and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(4).(Literal).getValue()="0"
}

from Function func, Variable vi_708, Variable vfrag_len_712, RelationalOperation target_2, LogicalOrExpr target_4, ReturnStmt target_5, VariableAccess target_6, BlockStmt target_7
where
not func_0(vi_708, target_4, target_5)
and not func_1(target_6, func)
and func_2(vi_708, vfrag_len_712, target_2)
and func_4(func, target_4)
and func_5(vi_708, target_5)
and func_6(vfrag_len_712, target_7, target_6)
and func_7(vi_708, vfrag_len_712, target_7)
and vi_708.getType().hasName("int")
and vfrag_len_712.getType().hasName("unsigned long")
and vi_708.(LocalVariable).getFunction() = func
and vfrag_len_712.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
