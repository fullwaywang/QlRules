/**
 * @name linux-bd771cf5c4254511cc4abb88f3dab3bd58bdf8e8-smtcfb_read
 * @id cpp/linux/bd771cf5c4254511cc4abb88f3dab3bd58bdf8e8/smtcfb-read
 * @description linux-bd771cf5c4254511cc4abb88f3dab3bd58bdf8e8-drivers/video/fbdev/sm712fb.c-smtcfb_read CVE-2022-2380
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="3"
	and not target_0.getValue()="12"
	and target_0.getParent().(BitwiseAndExpr).getParent().(AssignExpr).getRValue() instanceof BitwiseAndExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_2(Variable vc_1027, BitwiseAndExpr target_24) {
exists(AddExpr target_2 |
	target_2.getLeftOperand().(VariableAccess).getTarget()=vc_1027
	and target_2.getRightOperand() instanceof Literal
	and target_2.getLeftOperand().(VariableAccess).getLocation().isBefore(target_24.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vcount_1021, RelationalOperation target_6) {
	 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
	and target_6.getGreaterOperand().(VariableAccess).getTarget()=vcount_1021
	and target_6.getLesserOperand().(BinaryBitwiseOperation).getValue()="4096"
}

predicate func_7(Variable vdst_1025, Variable vsrc_1026, PointerDereferenceExpr target_7) {
	target_7.getOperand().(VariableAccess).getTarget()=vdst_1025
	and target_7.getParent().(AssignExpr).getLValue() = target_7
	and target_7.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readl")
	and target_7.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vsrc_1026
}

/*predicate func_8(Variable vsrc_1026, PostfixIncrExpr target_8) {
	target_8.getOperand().(VariableAccess).getTarget()=vsrc_1026
	and target_8.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readl")
}

*/
predicate func_9(Variable vc_1027, VariableAccess target_9) {
	target_9.getTarget()=vc_1027
}

predicate func_11(Variable vsrc_1026, VariableAccess target_11) {
	target_11.getTarget()=vsrc_1026
}

predicate func_12(Parameter vcount_1021, WhileStmt target_25, ConditionalExpr target_12) {
	target_12.getCondition() instanceof RelationalOperation
	and target_12.getThen().(BinaryBitwiseOperation).getValue()="4096"
	and target_12.getElse().(VariableAccess).getTarget()=vcount_1021
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264"
	and target_12.getElse().(VariableAccess).getLocation().isBefore(target_25.getCondition().(VariableAccess).getLocation())
}

predicate func_13(Variable vdst_1025, PointerDereferenceExpr target_13) {
	target_13.getOperand().(VariableAccess).getTarget()=vdst_1025
	and target_13.getParent().(AssignExpr).getLValue() = target_13
	and target_13.getParent().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vdst_1025
}

/*predicate func_14(Variable vdst_1025, PointerDereferenceExpr target_14) {
	target_14.getOperand().(VariableAccess).getTarget()=vdst_1025
	and target_14.getParent().(AssignExpr).getRValue() = target_14
	and target_14.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vdst_1025
}

*/
predicate func_15(Variable vsrc8_1069, Variable vsrc_1026, Variable vc_1027, Variable vi_1027, IfStmt target_15) {
	target_15.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vc_1027
	and target_15.getCondition().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_1027
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vc_1027
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getCondition().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vi_1027
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vi_1027
	and target_15.getThen().(BlockStmt).getStmt(2).(ForStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_15.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vsrc_1026
	and target_15.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vsrc8_1069
}

predicate func_17(BitwiseAndExpr target_24, Function func, DeclStmt target_17) {
	target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
	and target_17.getEnclosingFunction() = func
}

/*predicate func_18(Variable vsrc8_1069, Variable vc_1027, Variable vi_1027, BitwiseAndExpr target_24, ForStmt target_18) {
	target_18.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_1027
	and target_18.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vc_1027
	and target_18.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_18.getCondition().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vi_1027
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vi_1027
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vsrc8_1069
	and target_18.getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="2"
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
}

*/
/*predicate func_19(Variable vdst8_1068, Variable vsrc8_1069, Variable vi_1027, IfStmt target_19) {
	target_19.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vi_1027
	and target_19.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1"
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdst8_1068
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_19.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vsrc8_1069
	and target_19.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdst8_1068
	and target_19.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_19.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PrefixDecrExpr).getOperand().(VariableAccess).getTarget()=vsrc8_1069
	and target_19.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vsrc8_1069
	and target_19.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="2"
}

*/
/*predicate func_20(Variable vdst8_1068, Variable vsrc8_1069, BitwiseAndExpr target_26, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdst8_1068
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vsrc8_1069
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
}

*/
/*predicate func_21(Variable vdst8_1068, Variable vsrc8_1069, BitwiseAndExpr target_26, ExprStmt target_21) {
	target_21.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdst8_1068
	and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__readb")
	and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PrefixDecrExpr).getOperand().(VariableAccess).getTarget()=vsrc8_1069
	and target_21.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
}

*/
/*predicate func_22(Variable vsrc8_1069, BitwiseAndExpr target_26, ExprStmt target_22) {
	target_22.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vsrc8_1069
	and target_22.getExpr().(AssignPointerAddExpr).getRValue().(Literal).getValue()="2"
	and target_22.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_26
}

*/
/*predicate func_23(Variable vsrc8_1069, Variable vsrc_1026, AssignExpr target_23) {
	target_23.getLValue().(VariableAccess).getTarget()=vsrc_1026
	and target_23.getRValue().(VariableAccess).getTarget()=vsrc8_1069
}

*/
predicate func_24(Variable vc_1027, BlockStmt target_27, BitwiseAndExpr target_24) {
	target_24.getLeftOperand().(VariableAccess).getTarget()=vc_1027
	and target_24.getRightOperand() instanceof Literal
	and target_24.getParent().(IfStmt).getThen()=target_27
}

predicate func_25(Parameter vcount_1021, Variable vdst_1025, Variable vc_1027, WhileStmt target_25) {
	target_25.getCondition().(VariableAccess).getTarget()=vcount_1021
	and target_25.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vc_1027
	and target_25.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vcount_1021
	and target_25.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BinaryBitwiseOperation).getValue()="4096"
	and target_25.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(VariableAccess).getTarget()=vcount_1021
	and target_25.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdst_1025
	and target_25.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("u32 *")
}

predicate func_26(Variable vi_1027, BitwiseAndExpr target_26) {
	target_26.getLeftOperand().(VariableAccess).getTarget()=vi_1027
	and target_26.getRightOperand() instanceof Literal
}

predicate func_27(Function func, BlockStmt target_27) {
	target_27.getStmt(2) instanceof ForStmt
	and target_27.getStmt(3).(ExprStmt).getExpr() instanceof AssignExpr
	and target_27.getEnclosingFunction() = func
}

from Function func, Variable vdst8_1068, Variable vsrc8_1069, Parameter vcount_1021, Variable vdst_1025, Variable vsrc_1026, Variable vc_1027, Variable vi_1027, Literal target_0, RelationalOperation target_6, PointerDereferenceExpr target_7, VariableAccess target_9, VariableAccess target_11, ConditionalExpr target_12, PointerDereferenceExpr target_13, IfStmt target_15, DeclStmt target_17, BitwiseAndExpr target_24, WhileStmt target_25, BitwiseAndExpr target_26, BlockStmt target_27
where
func_0(func, target_0)
and not func_2(vc_1027, target_24)
and func_6(vcount_1021, target_6)
and func_7(vdst_1025, vsrc_1026, target_7)
and func_9(vc_1027, target_9)
and func_11(vsrc_1026, target_11)
and func_12(vcount_1021, target_25, target_12)
and func_13(vdst_1025, target_13)
and func_15(vsrc8_1069, vsrc_1026, vc_1027, vi_1027, target_15)
and func_17(target_24, func, target_17)
and func_24(vc_1027, target_27, target_24)
and func_25(vcount_1021, vdst_1025, vc_1027, target_25)
and func_26(vi_1027, target_26)
and func_27(func, target_27)
and vdst8_1068.getType().hasName("u8 *")
and vsrc8_1069.getType().hasName("u8 *")
and vcount_1021.getType().hasName("size_t")
and vdst_1025.getType().hasName("u32 *")
and vsrc_1026.getType().hasName("u32 *")
and vc_1027.getType().hasName("int")
and vi_1027.getType().hasName("int")
and vdst8_1068.(LocalVariable).getFunction() = func
and vsrc8_1069.(LocalVariable).getFunction() = func
and vcount_1021.getFunction() = func
and vdst_1025.(LocalVariable).getFunction() = func
and vsrc_1026.(LocalVariable).getFunction() = func
and vc_1027.(LocalVariable).getFunction() = func
and vi_1027.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
