/**
 * @name linux-5ec0811d30378ae104f250bfc9b3640242d81e3f-propagate_one
 * @id cpp/linux/5ec0811d30378ae104f250bfc9b3640242d81e3f/propagate-one
 * @description linux-5ec0811d30378ae104f250bfc9b3640242d81e3f-fs/pnode.c-propagate_one CVE-2016-4581
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vlast_dest, VariableAccess target_0) {
	target_0.getTarget()=vlast_dest
}

predicate func_1(Variable vlast_dest, Variable vn_223, VariableAccess target_1) {
	target_1.getTarget()=vlast_dest
	and target_1.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("peers")
	and target_1.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vn_223
}

predicate func_2(Variable vlast_source, VariableAccess target_2) {
	target_2.getTarget()=vlast_source
}

predicate func_3(Variable vlast_source, Variable vn_223, Variable vp_223, FunctionCall target_18, ExprStmt target_17, ExprStmt target_19) {
exists(DoStmt target_3 |
	target_3.getCondition().(NotExpr).getOperand().(VariableAccess).getType().hasName("bool")
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vlast_source
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getType().hasName("mount *")
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("mount *")
	and target_3.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vp_223
	and target_3.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getType().hasName("bool")
	and target_3.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("peers")
	and target_3.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vn_223
	and target_3.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("mount *")
	and target_3.getStmt().(BlockStmt).getStmt(4) instanceof ExprStmt
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(4)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
	and target_3.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_19.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_5(Variable vlast_source, BlockStmt target_20, ExprStmt target_17) {
exists(EqualityOperation target_5 |
	target_5.getLeftOperand().(VariableAccess).getTarget()=vlast_source
	and target_5.getRightOperand().(VariableAccess).getType().hasName("mount *")
	and target_5.getParent().(IfStmt).getThen()=target_20
	and target_5.getLeftOperand().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_6(NotExpr target_21, Function func) {
exists(BreakStmt target_6 |
	target_6.getParent().(IfStmt).getCondition()=target_21
	and target_6.getEnclosingFunction() = func)
}

*/
/*predicate func_7(Variable vp_223) {
exists(AssignExpr target_7 |
	target_7.getLValue().(VariableAccess).getType().hasName("bool")
	and target_7.getRValue().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_7.getRValue().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("mount *")
	and target_7.getRValue().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vp_223)
}

*/
/*predicate func_8(Variable vn_223, LogicalOrExpr target_22, ExprStmt target_19) {
exists(IfStmt target_8 |
	target_8.getCondition().(LogicalAndExpr).getLeftOperand().(VariableAccess).getType().hasName("bool")
	and target_8.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getTarget().hasName("peers")
	and target_8.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vn_223
	and target_8.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(1).(VariableAccess).getType().hasName("mount *")
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_8
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_19.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getCondition().(LogicalAndExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

*/
predicate func_9(Variable vlast_source, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlast_source
	and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_source
}

predicate func_10(Variable vlast_source, Variable vlast_dest, PointerFieldAccess target_10) {
	target_10.getTarget().getName()="mnt_parent"
	and target_10.getQualifier().(VariableAccess).getTarget()=vlast_source
	and target_10.getParent().(AssignExpr).getRValue() = target_10
	and target_10.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlast_dest
}

predicate func_11(Variable vlast_dest, Variable vp_223, VariableAccess target_11) {
	target_11.getTarget()=vp_223
	and target_11.getParent().(NEExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_11.getParent().(NEExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_dest
}

predicate func_12(Variable vlast_source, VariableAccess target_12) {
	target_12.getTarget()=vlast_source
}

predicate func_13(LogicalOrExpr target_22, Function func, BreakStmt target_13) {
	target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Variable vlast_source, Variable vlast_dest, Variable vp_223, LogicalOrExpr target_22, WhileStmt target_14) {
	target_14.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_14.getCondition().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_dest
	and target_14.getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vp_223
	and target_14.getStmt().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlast_dest
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mnt_parent"
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_source
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_22
}

/*predicate func_15(Variable vlast_source, Variable vlast_dest, EqualityOperation target_23, NotExpr target_21, AssignExpr target_15) {
	target_15.getLValue().(VariableAccess).getTarget()=vlast_dest
	and target_15.getRValue().(PointerFieldAccess).getTarget().getName()="mnt_parent"
	and target_15.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_source
	and target_23.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getLValue().(VariableAccess).getLocation())
	and target_15.getLValue().(VariableAccess).getLocation().isBefore(target_21.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
}

*/
predicate func_16(Variable vlast_source, NotExpr target_21, ExprStmt target_16) {
	target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlast_source
	and target_16.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_16.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_source
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
}

predicate func_17(Variable vlast_source, Variable vlast_dest, NotExpr target_21, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlast_dest
	and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mnt_parent"
	and target_17.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_source
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_21
}

predicate func_18(Variable vlast_dest, FunctionCall target_18) {
	target_18.getTarget().hasName("peers")
	and target_18.getArgument(0).(VariableAccess).getTarget().getType().hasName("mount *")
	and target_18.getArgument(1).(VariableAccess).getTarget()=vlast_dest
}

predicate func_19(Variable vn_223, Variable vp_223, ExprStmt target_19) {
	target_19.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vp_223
	and target_19.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_19.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vn_223
}

predicate func_20(Function func, BlockStmt target_20) {
	target_20.getStmt(0) instanceof ExprStmt
	and target_20.getStmt(1) instanceof ExprStmt
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Variable vlast_dest, Variable vn_223, NotExpr target_21) {
	target_21.getOperand().(FunctionCall).getTarget().hasName("peers")
	and target_21.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vn_223
	and target_21.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlast_dest
}

predicate func_22(Variable vp_223, LogicalOrExpr target_22) {
	target_22.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vp_223
	and target_22.getLeftOperand().(EqualityOperation).getRightOperand().(VariableAccess).getTarget().getType().hasName("mount *")
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="mnt_flags"
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mnt"
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vp_223
	and target_22.getRightOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="67108864"
}

predicate func_23(Variable vlast_dest, Variable vp_223, EqualityOperation target_23) {
	target_23.getLeftOperand().(PointerFieldAccess).getTarget().getName()="mnt_master"
	and target_23.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vlast_dest
	and target_23.getRightOperand().(VariableAccess).getTarget()=vp_223
}

from Function func, Variable vlast_source, Variable vlast_dest, Variable vn_223, Variable vp_223, VariableAccess target_0, VariableAccess target_1, VariableAccess target_2, ExprStmt target_9, PointerFieldAccess target_10, VariableAccess target_11, VariableAccess target_12, BreakStmt target_13, WhileStmt target_14, ExprStmt target_16, ExprStmt target_17, FunctionCall target_18, ExprStmt target_19, BlockStmt target_20, NotExpr target_21, LogicalOrExpr target_22, EqualityOperation target_23
where
func_0(vlast_dest, target_0)
and func_1(vlast_dest, vn_223, target_1)
and func_2(vlast_source, target_2)
and not func_3(vlast_source, vn_223, vp_223, target_18, target_17, target_19)
and func_9(vlast_source, target_9)
and func_10(vlast_source, vlast_dest, target_10)
and func_11(vlast_dest, vp_223, target_11)
and func_12(vlast_source, target_12)
and func_13(target_22, func, target_13)
and func_14(vlast_source, vlast_dest, vp_223, target_22, target_14)
and func_16(vlast_source, target_21, target_16)
and func_17(vlast_source, vlast_dest, target_21, target_17)
and func_18(vlast_dest, target_18)
and func_19(vn_223, vp_223, target_19)
and func_20(func, target_20)
and func_21(vlast_dest, vn_223, target_21)
and func_22(vp_223, target_22)
and func_23(vlast_dest, vp_223, target_23)
and vlast_source.getType().hasName("mount *")
and vlast_dest.getType().hasName("mount *")
and vn_223.getType().hasName("mount *")
and vp_223.getType().hasName("mount *")
and not vlast_source.getParentScope+() = func
and not vlast_dest.getParentScope+() = func
and vn_223.(LocalVariable).getFunction() = func
and vp_223.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
