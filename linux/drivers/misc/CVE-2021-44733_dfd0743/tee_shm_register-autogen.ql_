/**
 * @name linux-dfd0743f1d9ea76931510ed150334d571fbab49d-tee_shm_register
 * @id cpp/linux/dfd0743f1d9ea76931510ed150334d571fbab49d/tee-shm-register
 * @description linux-dfd0743f1d9ea76931510ed150334d571fbab49d-drivers/tee/tee_shm.c-tee_shm_register CVE-2021-44733
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vshm_223, ExprStmt target_8) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("refcount_set")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_0.getArgument(1) instanceof Literal
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_1(Variable vshm_223, VariableAccess target_1) {
	target_1.getTarget()=vshm_223
}

predicate func_3(Parameter vctx_217, Parameter vflags_218, Variable vshm_223, Variable vret_224, Variable vexp_info_310, Variable vtee_shm_dma_buf_ops, Function func, IfStmt target_3) {
	target_3.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vflags_218
	and target_3.getCondition().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ops"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtee_shm_dma_buf_ops
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="size"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="2"
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="priv"
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vshm_223
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dma_buf_export")
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vexp_info_310
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_224
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ERR_CAST")
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="shm_unregister"
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vctx_217
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vshm_223
	and target_3.getThen().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(2).(GotoStmt).getName() ="err"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(BitwiseAndExpr target_14, Function func, DeclStmt target_4) {
	target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_4.getEnclosingFunction() = func
}

/*predicate func_5(Variable vexp_info_310, Variable vtee_shm_dma_buf_ops, AssignExpr target_5) {
	target_5.getLValue().(ValueFieldAccess).getTarget().getName()="ops"
	and target_5.getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_5.getRValue().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtee_shm_dma_buf_ops
}

*/
/*predicate func_6(Variable vshm_223, Variable vexp_info_310, BitwiseAndExpr target_14, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="size"
	and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="size"
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

*/
/*predicate func_7(Variable vexp_info_310, BitwiseAndExpr target_14, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="flags"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_7.getExpr().(AssignExpr).getRValue().(Literal).getValue()="2"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

*/
predicate func_8(Variable vshm_223, Variable vexp_info_310, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="priv"
	and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vexp_info_310
	and target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vshm_223
}

/*predicate func_9(Variable vshm_223, Variable vexp_info_310, BitwiseAndExpr target_14, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("dma_buf_export")
	and target_9.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vexp_info_310
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

*/
/*predicate func_10(Parameter vctx_217, Variable vshm_223, Variable vret_224, BitwiseAndExpr target_14, IfStmt target_10) {
	target_10.getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_10.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_10.getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_224
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ERR_CAST")
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_10.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="shm_unregister"
	and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
	and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="desc"
	and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vctx_217
	and target_10.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vshm_223
	and target_10.getThen().(BlockStmt).getStmt(2).(GotoStmt).getName() ="err"
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

*/
/*predicate func_11(Variable vshm_223, Variable vret_224, FunctionCall target_15, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_224
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ERR_CAST")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

*/
/*predicate func_12(Parameter vctx_217, Variable vteedev_220, Variable vshm_223, FunctionCall target_15, ExprStmt target_12) {
	target_12.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="shm_unregister"
	and target_12.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
	and target_12.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="desc"
	and target_12.getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vteedev_220
	and target_12.getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vctx_217
	and target_12.getExpr().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vshm_223
	and target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

*/
/*predicate func_13(FunctionCall target_15, Function func, GotoStmt target_13) {
	target_13.getName() ="err"
	and target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_13.getEnclosingFunction() = func
}

*/
predicate func_14(Parameter vflags_218, BitwiseAndExpr target_14) {
	target_14.getLeftOperand().(VariableAccess).getTarget()=vflags_218
	and target_14.getRightOperand() instanceof BinaryBitwiseOperation
}

predicate func_15(Variable vshm_223, FunctionCall target_15) {
	target_15.getTarget().hasName("IS_ERR")
	and target_15.getArgument(0).(PointerFieldAccess).getTarget().getName()="dmabuf"
	and target_15.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshm_223
}

from Function func, Parameter vctx_217, Parameter vflags_218, Variable vteedev_220, Variable vshm_223, Variable vret_224, Variable vexp_info_310, Variable vtee_shm_dma_buf_ops, VariableAccess target_1, IfStmt target_3, DeclStmt target_4, ExprStmt target_8, BitwiseAndExpr target_14, FunctionCall target_15
where
not func_0(vshm_223, target_8)
and func_1(vshm_223, target_1)
and func_3(vctx_217, vflags_218, vshm_223, vret_224, vexp_info_310, vtee_shm_dma_buf_ops, func, target_3)
and func_4(target_14, func, target_4)
and func_8(vshm_223, vexp_info_310, target_8)
and func_14(vflags_218, target_14)
and func_15(vshm_223, target_15)
and vctx_217.getType().hasName("tee_context *")
and vflags_218.getType().hasName("u32")
and vteedev_220.getType().hasName("tee_device *")
and vshm_223.getType().hasName("tee_shm *")
and vret_224.getType().hasName("void *")
and vexp_info_310.getType().hasName("dma_buf_export_info")
and vtee_shm_dma_buf_ops.getType().hasName("const dma_buf_ops")
and vctx_217.getFunction() = func
and vflags_218.getFunction() = func
and vteedev_220.(LocalVariable).getFunction() = func
and vshm_223.(LocalVariable).getFunction() = func
and vret_224.(LocalVariable).getFunction() = func
and vexp_info_310.(LocalVariable).getFunction() = func
and not vtee_shm_dma_buf_ops.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
