/**
 * @name linux-aaac9a1bd370338ce372669eb9a6059d16b929aa-mtk_phy_init
 * @id cpp/linux/aaac9a1bd370338ce372669eb9a6059d16b929aa/mtk-phy-init
 * @description linux-aaac9a1bd370338ce372669eb9a6059d16b929aa-drivers/phy/mediatek/phy-mtk-tphy.c-mtk_phy_init CVE-2021-47234
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinstance_919, PointerFieldAccess target_2, ExprStmt target_3) {
exists(ExprStmt target_0 |
	target_0.getExpr().(FunctionCall).getTarget().hasName("clk_disable_unprepare")
	and target_0.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ref_clk"
	and target_0.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinstance_919
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_2
	and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vinstance_919, PointerFieldAccess target_2) {
exists(ExprStmt target_1 |
	target_1.getExpr().(FunctionCall).getTarget().hasName("clk_disable_unprepare")
	and target_1.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="da_ref_clk"
	and target_1.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinstance_919
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_2)
}

predicate func_2(Variable vinstance_919, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="type"
	and target_2.getQualifier().(VariableAccess).getTarget()=vinstance_919
}

predicate func_3(Variable vinstance_919, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("sata_phy_instance_init")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("mtk_tphy *")
	and target_3.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vinstance_919
}

from Function func, Variable vinstance_919, PointerFieldAccess target_2, ExprStmt target_3
where
not func_0(vinstance_919, target_2, target_3)
and not func_1(vinstance_919, target_2)
and func_2(vinstance_919, target_2)
and func_3(vinstance_919, target_3)
and vinstance_919.getType().hasName("mtk_phy_instance *")
and vinstance_919.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
