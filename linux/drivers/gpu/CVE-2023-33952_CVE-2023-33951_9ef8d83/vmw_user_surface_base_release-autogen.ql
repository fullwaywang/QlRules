/**
 * @name linux-9ef8d83e8e25d5f1811b3a38eb1484f85f64296c-vmw_user_surface_base_release
 * @id cpp/linux/9ef8d83e8e25d5f1811b3a38eb1484f85f64296c/vmw-user-surface-base-release
 * @description linux-9ef8d83e8e25d5f1811b3a38eb1484f85f64296c-vmw_user_surface_base_release CVE-2023-33952 CVE-2023-33951
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vres_687, ExprStmt target_2, PointerFieldAccess target_0) {
		target_0.getTarget().getName()="guest_memory_bo"
		and target_0.getQualifier().(VariableAccess).getTarget()=vres_687
		and target_0.getParent().(LogicalAndExpr).getAnOperand() instanceof LogicalAndExpr
		and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
}

predicate func_1(Variable vbase_684, Variable vres_687, ExprStmt target_2, LogicalAndExpr target_1) {
		target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="shareable"
		and target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbase_684
		and target_1.getAnOperand().(LogicalAndExpr).getAnOperand().(VariableAccess).getTarget()=vres_687
		and target_1.getAnOperand().(PointerFieldAccess).getTarget().getName()="guest_memory_bo"
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vres_687
		and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vres_687, ExprStmt target_2) {
		target_2.getExpr().(FunctionCall).getTarget().hasName("drm_gem_object_put")
		and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="base"
		and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tbo"
		and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="guest_memory_bo"
		and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vres_687
}

from Function func, Variable vbase_684, Variable vres_687, PointerFieldAccess target_0, LogicalAndExpr target_1, ExprStmt target_2
where
func_0(vres_687, target_2, target_0)
and func_1(vbase_684, vres_687, target_2, target_1)
and func_2(vres_687, target_2)
and vbase_684.getType().hasName("ttm_base_object *")
and vres_687.getType().hasName("vmw_resource *")
and vbase_684.(LocalVariable).getFunction() = func
and vres_687.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
