/**
 * @name linux-fffb0b52d5258554c645c966c6cbef7de50b851d-set_con2fb_map
 * @id cpp/linux/fffb0b52d5258554c645c966c6cbef7de50b851d/set-con2fb-map
 * @description linux-fffb0b52d5258554c645c966c6cbef7de50b851d-drivers/video/fbdev/core/fbcon.c-set_con2fb_map CVE-2023-38409
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vnewidx_820, Variable vcon2fb_map, Parameter vunit_820, NotExpr target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vcon2fb_map
	and target_0.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vunit_820
	and target_0.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnewidx_820
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
}

predicate func_1(Parameter vnewidx_820, NotExpr target_1) {
	target_1.getOperand().(FunctionCall).getTarget().hasName("search_fb_in_map")
	and target_1.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnewidx_820
}

from Function func, Parameter vnewidx_820, Variable vcon2fb_map, Parameter vunit_820, ExprStmt target_0, NotExpr target_1
where
func_0(vnewidx_820, vcon2fb_map, vunit_820, target_1, target_0)
and func_1(vnewidx_820, target_1)
and vnewidx_820.getType().hasName("int")
and vcon2fb_map.getType() instanceof ArrayType
and vunit_820.getType().hasName("int")
and vnewidx_820.getFunction() = func
and not vcon2fb_map.getParentScope+() = func
and vunit_820.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
