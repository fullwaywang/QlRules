/**
 * @name linux-415e3d3e90ce9e18727e8843ae343eda5a58fad6-scm_fp_copy
 * @id cpp/linux/415e3d3e90ce9e18727e8843ae343eda5a58fad6/scm-fp-copy
 * @description linux-415e3d3e90ce9e18727e8843ae343eda5a58fad6-net/core/scm.c-scm_fp_copy CVE-2016-2550
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, SizeofTypeOperator target_0) {
	target_0.getType() instanceof LongType
	and target_0.getValue()="2032"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vfpl_70, NotExpr target_3, ExprStmt target_4, ExprStmt target_5) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="user"
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
	and target_1.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(5)=target_1
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vfpl_70, ExprStmt target_6, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="user"
	and target_2.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="user"
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
	and target_2.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("get_uid")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getFollowingStmt() instanceof ReturnStmt
	and target_6.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vfpl_70, BlockStmt target_7, NotExpr target_3) {
	target_3.getOperand().(VariableAccess).getTarget()=vfpl_70
	and target_3.getParent().(IfStmt).getThen()=target_7
}

predicate func_4(Variable vfpl_70, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="max"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
	and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="253"
}

predicate func_5(Variable vfpl_70, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("file **")
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="fp"
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getTarget().getName()="count"
	and target_5.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
}

predicate func_6(Variable vfpl_70, ExprStmt target_6) {
	target_6.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="count"
	and target_6.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfpl_70
}

predicate func_7(Variable vfpl_70, BlockStmt target_7) {
	target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfpl_70
	and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0) instanceof SizeofTypeOperator
	and target_7.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="37748928"
	and target_7.getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vfpl_70
	and target_7.getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
}

from Function func, Variable vfpl_70, SizeofTypeOperator target_0, NotExpr target_3, ExprStmt target_4, ExprStmt target_5, ExprStmt target_6, BlockStmt target_7
where
func_0(func, target_0)
and not func_1(vfpl_70, target_3, target_4, target_5)
and not func_2(vfpl_70, target_6, func)
and func_3(vfpl_70, target_7, target_3)
and func_4(vfpl_70, target_4)
and func_5(vfpl_70, target_5)
and func_6(vfpl_70, target_6)
and func_7(vfpl_70, target_7)
and vfpl_70.getType().hasName("scm_fp_list *")
and vfpl_70.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
