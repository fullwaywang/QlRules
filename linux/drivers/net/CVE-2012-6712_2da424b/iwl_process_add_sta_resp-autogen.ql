/**
 * @name linux-2da424b0773cea3db47e1e81db71eeebde8269d4-iwl_process_add_sta_resp
 * @id cpp/linux/2da424b0773cea3db47e1e81db71eeebde8269d4/iwl-process-add-sta-resp
 * @description linux-2da424b0773cea3db47e1e81db71eeebde8269d4-drivers/net/wireless/iwlwifi/iwl-agn-sta.c-iwl_process_add_sta_resp CVE-2012-6712
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsta_id_62, Parameter vpriv_58, FunctionCall target_0) {
	target_0.getTarget().hasName("iwl_sta_ucode_activate")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vpriv_58
	and target_0.getArgument(1).(VariableAccess).getTarget()=vsta_id_62
}

predicate func_1(Variable vret_64, ValueFieldAccess target_3, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_64
	and target_1.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_3
}

predicate func_3(Function func, ValueFieldAccess target_3) {
	target_3.getTarget().getName()="status"
	and target_3.getQualifier().(ValueFieldAccess).getTarget().getName()="add_sta"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="u"
	and target_3.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("iwl_rx_packet *")
	and target_3.getEnclosingFunction() = func
}

from Function func, Variable vsta_id_62, Variable vret_64, Parameter vpriv_58, FunctionCall target_0, ExprStmt target_1, ValueFieldAccess target_3
where
func_0(vsta_id_62, vpriv_58, target_0)
and func_1(vret_64, target_3, target_1)
and func_3(func, target_3)
and vsta_id_62.getType().hasName("u8")
and vret_64.getType().hasName("int")
and vpriv_58.getType().hasName("iwl_priv *")
and vsta_id_62.(LocalVariable).getFunction() = func
and vret_64.(LocalVariable).getFunction() = func
and vpriv_58.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
