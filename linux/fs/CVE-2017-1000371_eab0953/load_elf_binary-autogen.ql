/**
 * @name linux-eab09532d40090698b05a07c1c87f39fdbc5fab5-load_elf_binary
 * @id cpp/linux/eab09532d40090698b05a07c1c87f39fdbc5fab5/load-elf-binary
 * @description linux-eab09532d40090698b05a07c1c87f39fdbc5fab5-fs/binfmt_elf.c-load_elf_binary CVE-2017-1000371
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="3"
	and not target_0.getValue()="16"
	and target_0.getParent().(DivExpr).getParent().(MulExpr).getLeftOperand() instanceof DivExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="2"
	and not target_1.getValue()="0"
	and target_1.getParent().(MulExpr).getParent().(SubExpr).getLeftOperand() instanceof MulExpr
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vload_bias_685, Variable velf_interpreter_687, Variable velf_flags_886, EqualityOperation target_13, IfStmt target_14, IfStmt target_15, ExprStmt target_16, ExprStmt target_17) {
exists(IfStmt target_2 |
	target_2.getCondition().(VariableAccess).getTarget()=velf_interpreter_687
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("mmap_is_ia32")
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(Literal).getValue()="4194304"
	and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="4294967296"
	and target_2.getThen().(BlockStmt).getStmt(1) instanceof IfStmt
	and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=velf_flags_886
	and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="16"
	and target_2.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_2.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
	and target_14.getCondition().(VariableAccess).getLocation().isBefore(target_2.getCondition().(VariableAccess).getLocation())
	and target_2.getCondition().(VariableAccess).getLocation().isBefore(target_15.getCondition().(VariableAccess).getLocation())
	and target_16.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation())
	and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation()))
}

/*predicate func_3(Function func) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("mmap_is_ia32")
	and target_3.getEnclosingFunction() = func)
}

*/
/*predicate func_6(Variable velf_flags_886, ExprStmt target_16, ExprStmt target_17) {
exists(AssignOrExpr target_6 |
	target_6.getLValue().(VariableAccess).getTarget()=velf_flags_886
	and target_6.getRValue().(Literal).getValue()="16"
	and target_16.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_6.getLValue().(VariableAccess).getLocation())
	and target_6.getLValue().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation()))
}

*/
predicate func_7(Variable vload_bias_685, Variable vvaddr_887, EqualityOperation target_13, PointerArithmeticOperation target_18, AddExpr target_19, ExprStmt target_20) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vload_bias_685
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vvaddr_887
	and target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073709547520"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_7
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
	and target_18.getRightOperand().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_19.getLeftOperand().(VariableAccess).getLocation())
	and target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_8(Function func, FunctionCall target_8) {
	target_8.getTarget().hasName("test_ti_thread_flag")
	and target_8.getArgument(0).(FunctionCall).getTarget().hasName("get_current")
	and target_8.getArgument(1).(Literal).getValue()="29"
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Function func, SubExpr target_9) {
	target_9.getValue()="140737488351232"
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Variable vload_bias_685, EqualityOperation target_13, IfStmt target_10) {
	target_10.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_10.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_10.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4194304"
	and target_10.getThen().(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_10.getThen().(ExprStmt).getExpr().(AssignAddExpr).getRValue().(FunctionCall).getTarget().hasName("arch_mmap_rnd")
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
}

predicate func_11(Variable vload_bias_685, VariableAccess target_11) {
	target_11.getTarget()=vload_bias_685
}

predicate func_12(Function func, MulExpr target_12) {
	target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getCondition() instanceof FunctionCall
	and target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="personality"
	and target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getThen().(Literal).getValue()="3221225472"
	and target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getThen().(ConditionalExpr).getElse().(Literal).getValue()="4294959104"
	and target_12.getLeftOperand().(DivExpr).getLeftOperand().(ConditionalExpr).getElse() instanceof SubExpr
	and target_12.getLeftOperand().(DivExpr).getRightOperand() instanceof Literal
	and target_12.getRightOperand() instanceof Literal
	and target_12.getEnclosingFunction() = func
}

predicate func_13(BlockStmt target_21, Function func, EqualityOperation target_13) {
	target_13.getLeftOperand().(ValueFieldAccess).getTarget().getName()="e_type"
	and target_13.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="elf_ex"
	and target_13.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("struct <unnamed> *")
	and target_13.getRightOperand().(Literal).getValue()="3"
	and target_13.getParent().(IfStmt).getThen()=target_21
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Variable velf_interpreter_687, IfStmt target_14) {
	target_14.getCondition().(VariableAccess).getTarget()=velf_interpreter_687
	and target_14.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-80"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("memcmp")
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="e_ident"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="interp_elf_ex"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(StringLiteral).getValue()="ELF"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(2).(Literal).getValue()="4"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_14.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(GotoStmt).getName() ="out_free_dentry"
}

predicate func_15(Variable vload_bias_685, Variable velf_interpreter_687, IfStmt target_15) {
	target_15.getCondition().(VariableAccess).getTarget()=velf_interpreter_687
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("load_elf_interp")
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="interp_elf_ex"
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("file *")
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vload_bias_685
	and target_15.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("elf64_phdr *")
	and target_15.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_15.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="e_entry"
	and target_15.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="elf_ex"
	and target_15.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("struct <unnamed> *")
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("test_ti_thread_flag")
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("get_current")
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="29"
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getThen().(ConditionalExpr).getThen().(Literal).getValue()="3221225472"
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getThen().(ConditionalExpr).getElse().(Literal).getValue()="4294959104"
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ConditionalExpr).getElse().(SubExpr).getValue()="140737488351232"
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_15.getElse().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out_free_dentry"
}

predicate func_16(Variable velf_flags_886, ExprStmt target_16) {
	target_16.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=velf_flags_886
	and target_16.getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="16"
}

predicate func_17(Variable vload_bias_685, Variable velf_flags_886, Variable vvaddr_887, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("elf_map")
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="file"
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("linux_binprm *")
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vload_bias_685
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddExpr).getRightOperand().(VariableAccess).getTarget()=vvaddr_887
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("elf64_phdr *")
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("int")
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=velf_flags_886
	and target_17.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("unsigned long")
}

predicate func_18(Variable vload_bias_685, PointerArithmeticOperation target_18) {
	target_18.getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
	and target_18.getRightOperand().(VariableAccess).getTarget()=vload_bias_685
}

predicate func_19(Variable vload_bias_685, Variable velf_flags_886, Variable vvaddr_887, AddExpr target_19) {
	target_19.getLeftOperand().(VariableAccess).getTarget()=vload_bias_685
	and target_19.getRightOperand().(VariableAccess).getTarget()=vvaddr_887
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("elf_map")
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="file"
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("linux_binprm *")
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("elf64_phdr *")
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("int")
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=velf_flags_886
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("unsigned long")
}

predicate func_20(Variable vvaddr_887, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vvaddr_887
	and target_20.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="p_vaddr"
	and target_20.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("elf64_phdr *")
}

predicate func_21(Variable vload_bias_685, Variable vvaddr_887, BlockStmt target_21) {
	target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand() instanceof MulExpr
	and target_21.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vvaddr_887
	and target_21.getStmt(1) instanceof IfStmt
	and target_21.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vload_bias_685
	and target_21.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vload_bias_685
	and target_21.getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="18446744073709547520"
}

from Function func, Variable vload_bias_685, Variable velf_interpreter_687, Variable velf_flags_886, Variable vvaddr_887, Literal target_0, Literal target_1, FunctionCall target_8, SubExpr target_9, IfStmt target_10, VariableAccess target_11, MulExpr target_12, EqualityOperation target_13, IfStmt target_14, IfStmt target_15, ExprStmt target_16, ExprStmt target_17, PointerArithmeticOperation target_18, AddExpr target_19, ExprStmt target_20, BlockStmt target_21
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_2(vload_bias_685, velf_interpreter_687, velf_flags_886, target_13, target_14, target_15, target_16, target_17)
and not func_7(vload_bias_685, vvaddr_887, target_13, target_18, target_19, target_20)
and func_8(func, target_8)
and func_9(func, target_9)
and func_10(vload_bias_685, target_13, target_10)
and func_11(vload_bias_685, target_11)
and func_12(func, target_12)
and func_13(target_21, func, target_13)
and func_14(velf_interpreter_687, target_14)
and func_15(vload_bias_685, velf_interpreter_687, target_15)
and func_16(velf_flags_886, target_16)
and func_17(vload_bias_685, velf_flags_886, vvaddr_887, target_17)
and func_18(vload_bias_685, target_18)
and func_19(vload_bias_685, velf_flags_886, vvaddr_887, target_19)
and func_20(vvaddr_887, target_20)
and func_21(vload_bias_685, vvaddr_887, target_21)
and vload_bias_685.getType().hasName("unsigned long")
and velf_interpreter_687.getType().hasName("char *")
and velf_flags_886.getType().hasName("int")
and vvaddr_887.getType().hasName("unsigned long")
and vload_bias_685.(LocalVariable).getFunction() = func
and velf_interpreter_687.(LocalVariable).getFunction() = func
and velf_flags_886.(LocalVariable).getFunction() = func
and vvaddr_887.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
