/**
 * @name linux-5f2f97656ada8d811d3c1bef503ced266fcd53a0-rxrpc_krb5_decode_principal
 * @id cpp/linux/5f2f97656ada8d811d3c1bef503ced266fcd53a0/rxrpc-krb5-decode-principal
 * @description linux-5f2f97656ada8d811d3c1bef503ced266fcd53a0-net/rxrpc/key.c-rxrpc_krb5_decode_principal CVE-2017-7482
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtmp_220, ReturnStmt target_11, VariableAccess target_0) {
	target_0.getTarget()=vtmp_220
	and target_0.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_0.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_11
}

predicate func_1(Variable vtmp_220, VariableAccess target_1) {
	target_1.getTarget()=vtmp_220
	and target_1.getParent().(AssignExpr).getLValue() = target_1
	and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_220
	and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="3"
	and target_1.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="4294967292"
}

predicate func_2(Variable vtmp_220, VariableAccess target_2) {
	target_2.getTarget()=vtmp_220
	and target_2.getParent().(AssignSubExpr).getRValue() = target_2
	and target_2.getParent().(AssignSubExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_3(Variable vtmp_220, VariableAccess target_3) {
	target_3.getTarget()=vtmp_220
}

predicate func_4(Variable vtmp_220, ReturnStmt target_12, VariableAccess target_4) {
	target_4.getTarget()=vtmp_220
	and target_4.getParent().(GTExpr).getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_4.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_12
}

predicate func_5(Variable vtmp_220, VariableAccess target_5) {
	target_5.getTarget()=vtmp_220
	and target_5.getParent().(AssignExpr).getLValue() = target_5
	and target_5.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_220
	and target_5.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="3"
	and target_5.getParent().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="4294967292"
}

predicate func_6(Variable vtmp_220, VariableAccess target_6) {
	target_6.getTarget()=vtmp_220
	and target_6.getParent().(AssignSubExpr).getRValue() = target_6
	and target_6.getParent().(AssignSubExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_7(Variable vtmp_220, VariableAccess target_7) {
	target_7.getTarget()=vtmp_220
}

predicate func_8(Variable vtmp_220, ExprStmt target_13, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtmp_220
	and target_8.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_220
	and target_8.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="3"
	and target_8.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="4294967292"
	and target_13.getLocation().isBefore(target_8.getLocation())
}

predicate func_9(Variable vtmp_220, ExprStmt target_14, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtmp_220
	and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vtmp_220
	and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="3"
	and target_9.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="4294967292"
	and target_14.getLocation().isBefore(target_9.getLocation())
}

predicate func_11(RelationalOperation target_15, Function func, ReturnStmt target_11) {
	target_11.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_11.getParent().(IfStmt).getCondition()=target_15
	and target_11.getEnclosingFunction() = func
}

predicate func_12(RelationalOperation target_16, Function func, ReturnStmt target_12) {
	target_12.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_12.getParent().(IfStmt).getCondition()=target_16
	and target_12.getEnclosingFunction() = func
}

predicate func_13(Variable vtmp_220, ExprStmt target_13) {
	target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="name_parts"
	and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("krb5_principal *")
	and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_13.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vtmp_220
	and target_13.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_14(Variable vtmp_220, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="realm"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("krb5_principal *")
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vtmp_220
	and target_14.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_15(Variable vtmp_220, ReturnStmt target_11, RelationalOperation target_15) {
	 (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
	and target_15.getGreaterOperand().(VariableAccess).getTarget()=vtmp_220
	and target_15.getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_15.getParent().(IfStmt).getThen()=target_11
}

predicate func_16(Variable vtmp_220, ReturnStmt target_12, RelationalOperation target_16) {
	 (target_16 instanceof GTExpr or target_16 instanceof LTExpr)
	and target_16.getGreaterOperand().(VariableAccess).getTarget()=vtmp_220
	and target_16.getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_16.getParent().(IfStmt).getThen()=target_12
}

from Function func, Variable vtmp_220, VariableAccess target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_4, VariableAccess target_5, VariableAccess target_6, VariableAccess target_7, ExprStmt target_8, ExprStmt target_9, ReturnStmt target_11, ReturnStmt target_12, ExprStmt target_13, ExprStmt target_14, RelationalOperation target_15, RelationalOperation target_16
where
func_0(vtmp_220, target_11, target_0)
and func_1(vtmp_220, target_1)
and func_2(vtmp_220, target_2)
and func_3(vtmp_220, target_3)
and func_4(vtmp_220, target_12, target_4)
and func_5(vtmp_220, target_5)
and func_6(vtmp_220, target_6)
and func_7(vtmp_220, target_7)
and func_8(vtmp_220, target_13, target_8)
and func_9(vtmp_220, target_14, target_9)
and func_11(target_15, func, target_11)
and func_12(target_16, func, target_12)
and func_13(vtmp_220, target_13)
and func_14(vtmp_220, target_14)
and func_15(vtmp_220, target_11, target_15)
and func_16(vtmp_220, target_12, target_16)
and vtmp_220.getType().hasName("unsigned int")
and vtmp_220.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
