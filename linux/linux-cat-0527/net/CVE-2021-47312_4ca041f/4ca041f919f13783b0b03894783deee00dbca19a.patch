commit 4ca041f919f13783b0b03894783deee00dbca19a
Author: Colin Ian King <colin.king@canonical.com>
Date:   Thu Jun 24 20:57:18 2021 +0100

    netfilter: nf_tables: Fix dereference of null pointer flow
    
    In the case where chain->flags & NFT_CHAIN_HW_OFFLOAD is false then
    nft_flow_rule_create is not called and flow is NULL. The subsequent
    error handling execution via label err_destroy_flow_rule will lead
    to a null pointer dereference on flow when calling nft_flow_rule_destroy.
    Since the error path to err_destroy_flow_rule has to cater for null
    and non-null flows, only call nft_flow_rule_destroy if flow is non-null
    to fix this issue.
    
    Addresses-Coverity: ("Explicity null dereference")
    Fixes: 3c5e44622011 ("netfilter: nf_tables: memleak in hw offload abort path")
    Signed-off-by: Colin Ian King <colin.king@canonical.com>
    Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>

diff --git a/net/netfilter/nf_tables_api.c b/net/netfilter/nf_tables_api.c
index 390d4466567f..de182d1f7c4e 100644
--- a/net/netfilter/nf_tables_api.c
+++ b/net/netfilter/nf_tables_api.c
@@ -3446,7 +3446,8 @@ static int nf_tables_newrule(struct sk_buff *skb, const struct nfnl_info *info,
 	return 0;
 
 err_destroy_flow_rule:
-	nft_flow_rule_destroy(flow);
+	if (flow)
+		nft_flow_rule_destroy(flow);
 err_release_rule:
 	nf_tables_rule_release(&ctx, rule);
 err_release_expr:
