/**
 * @name linux-567320c46a60a3c39b69aa1df802d753817a3f86-smb2_check_message
 * @id cpp/linux/567320c46a60a3c39b69aa1df802d753817a3f86/smb2-check-message
 * @description linux-567320c46a60a3c39b69aa1df802d753817a3f86-fs/smb/client/smb2misc.c-smb2_check_message CVE-2023-6610
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlen_136, Variable vshdr_139, Variable vhdr_size_141, Variable vpdu_size_142, IfStmt target_2, IfStmt target_0) {
	target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vlen_136
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vpdu_size_142
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_136
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vhdr_size_141
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="Status"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshdr_139
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="StructureSize2"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_0.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="1"
	and target_0.getLocation().isBefore(target_2.getLocation())
}

predicate func_1(Variable vCIFSMaxBufSize, Parameter vlen_136, IfStmt target_2, IfStmt target_1) {
	target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_136
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vCIFSMaxBufSize
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(AddExpr).getRightOperand().(Literal).getValue()="204"
	and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_1.getThen().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getElse().(DoStmt).getCondition() instanceof Literal
	and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(Literal).getValue()="1"
	and target_1.getLocation().isBefore(target_2.getLocation())
}

predicate func_2(Variable vshdr_139, IfStmt target_2) {
	target_2.getCondition().(FunctionCall).getTarget().hasName("check_smb2_hdr")
	and target_2.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vshdr_139
	and target_2.getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("__u64")
	and target_2.getThen().(ReturnStmt).getExpr().(Literal).getValue()="1"
}

from Function func, Variable vCIFSMaxBufSize, Parameter vlen_136, Variable vshdr_139, Variable vhdr_size_141, Variable vpdu_size_142, IfStmt target_0, IfStmt target_1, IfStmt target_2
where
func_0(vlen_136, vshdr_139, vhdr_size_141, vpdu_size_142, target_2, target_0)
and func_1(vCIFSMaxBufSize, vlen_136, target_2, target_1)
and func_2(vshdr_139, target_2)
and vCIFSMaxBufSize.getType().hasName("unsigned int")
and vlen_136.getType().hasName("unsigned int")
and vshdr_139.getType().hasName("smb2_hdr *")
and vhdr_size_141.getType().hasName("int")
and vpdu_size_142.getType().hasName("int")
and not vCIFSMaxBufSize.getParentScope+() = func
and vlen_136.getFunction() = func
and vshdr_139.(LocalVariable).getFunction() = func
and vhdr_size_141.(LocalVariable).getFunction() = func
and vpdu_size_142.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
