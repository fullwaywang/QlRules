/**
 * @name linux-5d53cd33f4253aa4cf02bf7e670b3c6a99674351-lcd2s_i2c_probe
 * @id cpp/linux/5d53cd33f4253aa4cf02bf7e670b3c6a99674351/lcd2s-i2c-probe
 * @description linux-5d53cd33f4253aa4cf02bf7e670b3c6a99674351-drivers/auxdisplay/lcd2s.c-lcd2s_i2c_probe CVE-2022-48907
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vlcd2s_293, FunctionCall target_0) {
	exists(SizeofTypeOperator obj_0 | obj_0=target_0.getArgument(0) |
		obj_0.getType() instanceof LongType
		and obj_0.getValue()="16"
	)
	and exists(AssignExpr obj_1 | obj_1=target_0.getParent() |
		obj_1.getRValue() = target_0
		and obj_1.getLValue().(VariableAccess).getTarget()=vlcd2s_293
	)
	and target_0.getTarget().hasName("kzalloc")
	and not target_0.getTarget().hasName("devm_kzalloc")
	and target_0.getArgument(1).(BitwiseOrExpr).getValue()="3264"
}

predicate func_1(Variable vlcd2s_293, IfStmt target_11, ExprStmt target_1) {
	exists(AssignExpr obj_0 | obj_0=target_1.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=vlcd2s_293
		and obj_0.getRValue() instanceof FunctionCall
	)
	and target_11.getLocation().isBefore(target_1.getLocation())
}

predicate func_2(Variable vlcd2s_293, IfStmt target_11, IfStmt target_2) {
	target_2.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vlcd2s_293
	and target_2.getThen() instanceof BlockStmt
	and target_11.getLocation().isBefore(target_2.getLocation())
}

predicate func_3(Parameter vi2c_289, ExprStmt target_12, ExprStmt target_13) {
exists(AddressOfExpr target_3 |
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getOperand() |
		obj_0.getTarget().getName()="dev"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vi2c_289
	)
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
)
}

predicate func_4(Function func) {
exists(SizeofExprOperator target_4 |
	target_4.getValue()="16"
	and target_4.getEnclosingFunction() = func
)
}

predicate func_5(NotExpr target_14, Function func) {
exists(ReturnStmt target_5 |
	target_5.getExpr() instanceof UnaryMinusExpr
	and target_5.getParent().(IfStmt).getCondition()=target_14
	and target_5.getEnclosingFunction() = func
)
}

predicate func_6(Variable verr_294, UnaryMinusExpr target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getParent() |
		obj_0.getRValue() = target_6
		and obj_0.getLValue().(VariableAccess).getTarget()=verr_294
	)
	and target_6.getValue()="-12"
}

predicate func_7(Variable vlcd2s_293, VariableAccess target_7) {
	target_7.getTarget()=vlcd2s_293
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_8(Variable verr_294, NotExpr target_14, ExprStmt target_8) {
	exists(AssignExpr obj_0 | obj_0=target_8.getExpr() |
		obj_0.getLValue().(VariableAccess).getTarget()=verr_294
		and obj_0.getRValue() instanceof UnaryMinusExpr
	)
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

predicate func_9(NotExpr target_14, Function func, GotoStmt target_9) {
	target_9.getName() ="fail1"
	and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Variable vlcd2s_293, Function func, ExprStmt target_10) {
	exists(FunctionCall obj_0 | obj_0=target_10.getExpr() |
		obj_0.getTarget().hasName("kfree")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vlcd2s_293
	)
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Function func, IfStmt target_11) {
	target_11.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget().getType().hasName("charlcd *")
	and target_11.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Parameter vi2c_289, Variable verr_294, ExprStmt target_12) {
	exists(AssignExpr obj_0 | obj_0=target_12.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("lcd2s_i2c_smbus_write_byte")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vi2c_289
			and obj_1.getArgument(1).(Literal).getValue()="18"
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=verr_294
	)
}

predicate func_13(Parameter vi2c_289, Variable vlcd2s_293, ExprStmt target_13) {
	exists(AssignExpr obj_0 | obj_0=target_13.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="i2c"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vlcd2s_293
		)
		and obj_0.getRValue().(VariableAccess).getTarget()=vi2c_289
	)
}

predicate func_14(Variable vlcd2s_293, NotExpr target_14) {
	target_14.getOperand().(VariableAccess).getTarget()=vlcd2s_293
}

from Function func, Parameter vi2c_289, Variable vlcd2s_293, Variable verr_294, FunctionCall target_0, ExprStmt target_1, IfStmt target_2, UnaryMinusExpr target_6, VariableAccess target_7, ExprStmt target_8, GotoStmt target_9, ExprStmt target_10, IfStmt target_11, ExprStmt target_12, ExprStmt target_13, NotExpr target_14
where
func_0(vlcd2s_293, target_0)
and func_1(vlcd2s_293, target_11, target_1)
and func_2(vlcd2s_293, target_11, target_2)
and not func_3(vi2c_289, target_12, target_13)
and not func_4(func)
and not func_5(target_14, func)
and func_6(verr_294, target_6)
and func_7(vlcd2s_293, target_7)
and func_8(verr_294, target_14, target_8)
and func_9(target_14, func, target_9)
and func_10(vlcd2s_293, func, target_10)
and func_11(func, target_11)
and func_12(vi2c_289, verr_294, target_12)
and func_13(vi2c_289, vlcd2s_293, target_13)
and func_14(vlcd2s_293, target_14)
and vi2c_289.getType().hasName("i2c_client *")
and vlcd2s_293.getType().hasName("lcd2s_data *")
and verr_294.getType().hasName("int")
and vi2c_289.getFunction() = func
and vlcd2s_293.(LocalVariable).getFunction() = func
and verr_294.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
