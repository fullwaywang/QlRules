/**
 * @name linux-04c4f2ee3f68c9a4bf1653d15f1a9a435ae33f7a-__vmx_handle_exit
 * @id cpp/linux/04c4f2ee3f68c9a4bf1653d15f1a9a435ae33f7a/--vmx-handle-exit
 * @description linux-04c4f2ee3f68c9a4bf1653d15f1a9a435ae33f7a-arch/x86/kvm/vmx/vmx.c-__vmx_handle_exit CVE-2021-3501
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vvcpu_5944, ExprStmt target_11, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ndata"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
	and target_0.getExpr().(AssignExpr).getRValue() instanceof Literal
	and target_0.getLocation().isBefore(target_11.getLocation())
}

predicate func_1(Parameter vvcpu_5944) {
exists(PostfixIncrExpr target_1 |
	target_1.getOperand().(VariableAccess).getType().hasName("int")
	and target_1.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_1.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_1.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_1.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944)
}

predicate func_2(Parameter vvcpu_5944) {
exists(PostfixIncrExpr target_2 |
	target_2.getOperand().(VariableAccess).getType().hasName("int")
	and target_2.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_2.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_2.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_2.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_2.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944)
}

predicate func_4(Parameter vvcpu_5944, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="(unknown field)"
	and target_4.getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_4.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
}

predicate func_5(Parameter vvcpu_5944, PointerFieldAccess target_5) {
	target_5.getTarget().getName()="(unknown field)"
	and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
}

predicate func_7(Parameter vvcpu_5944, ExprStmt target_12, ExprStmt target_8, PostfixIncrExpr target_7) {
	target_7.getOperand().(ValueFieldAccess).getTarget().getName()="ndata"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_7.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
	and target_12.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_8(EqualityOperation target_13, Function func, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_8.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="3"
	and target_8.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("vmcs_read64")
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_13
	and target_8.getEnclosingFunction() = func
}

predicate func_10(Parameter vvcpu_5944, ExprStmt target_14, PostfixIncrExpr target_10) {
	target_10.getOperand().(ValueFieldAccess).getTarget().getName()="ndata"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
	and target_10.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_10.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_10.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_10.getParent().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_11(Function func, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_11.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_11.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_11.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_11.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_11.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("u32")
	and target_11.getEnclosingFunction() = func
}

predicate func_12(Parameter vvcpu_5944, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_12.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_12.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_12.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_12.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="2"
	and target_12.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="exit_qualification"
	and target_12.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="arch"
	and target_12.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
}

predicate func_13(BlockStmt target_15, Function func, EqualityOperation target_13) {
	target_13.getLeftOperand().(ValueFieldAccess).getTarget().getName()="basic"
	and target_13.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_13.getLeftOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("vmx_exit_reason")
	and target_13.getRightOperand().(Literal).getValue()="49"
	and target_13.getParent().(IfStmt).getThen()=target_15
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vvcpu_5944, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="data"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="internal"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="run"
	and target_14.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset() instanceof PostfixIncrExpr
	and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="last_vmentry_cpu"
	and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="arch"
	and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_5944
}

predicate func_15(Function func, BlockStmt target_15) {
	target_15.getStmt(0).(ExprStmt).getExpr() instanceof PostfixIncrExpr
	and target_15.getStmt(1) instanceof ExprStmt
	and target_15.getEnclosingFunction() = func
}

from Function func, Parameter vvcpu_5944, ExprStmt target_0, PointerFieldAccess target_4, PointerFieldAccess target_5, PostfixIncrExpr target_7, ExprStmt target_8, PostfixIncrExpr target_10, ExprStmt target_11, ExprStmt target_12, EqualityOperation target_13, ExprStmt target_14, BlockStmt target_15
where
func_0(vvcpu_5944, target_11, target_0)
and not func_1(vvcpu_5944)
and not func_2(vvcpu_5944)
and func_4(vvcpu_5944, target_4)
and func_5(vvcpu_5944, target_5)
and func_7(vvcpu_5944, target_12, target_8, target_7)
and func_8(target_13, func, target_8)
and func_10(vvcpu_5944, target_14, target_10)
and func_11(func, target_11)
and func_12(vvcpu_5944, target_12)
and func_13(target_15, func, target_13)
and func_14(vvcpu_5944, target_14)
and func_15(func, target_15)
and vvcpu_5944.getType().hasName("kvm_vcpu *")
and vvcpu_5944.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
