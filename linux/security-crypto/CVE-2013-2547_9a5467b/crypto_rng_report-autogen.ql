/**
 * @name linux-9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6-crypto_rng_report
 * @id cpp/linux/9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6/crypto-rng-report
 * @description linux-9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6-crypto/rng.c-crypto_rng_report CVE-2013-2547
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vrrng_66, ValueFieldAccess target_0) {
		target_0.getTarget().getName()="seedsize"
		and target_0.getQualifier().(VariableAccess).getTarget()=vrrng_66
}

predicate func_1(Parameter valg_64, ValueFieldAccess target_1) {
		target_1.getTarget().getName()="seedsize"
		and target_1.getQualifier().(ValueFieldAccess).getTarget().getName()="rng"
		and target_1.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_1.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
}

predicate func_3(Function func, SizeofTypeOperator target_3) {
		target_3.getType() instanceof LongType
		and target_3.getValue()="68"
		and target_3.getEnclosingFunction() = func
}

predicate func_5(Function func) {
	exists(FunctionCall target_5 |
		target_5.getTarget().hasName("strncpy")
		and target_5.getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
		and target_5.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_5.getArgument(1).(StringLiteral).getValue()="givcipher"
		and target_5.getArgument(2).(SizeofExprOperator).getValue()="64"
		and target_5.getEnclosingFunction() = func)
}

predicate func_7(Parameter valg_64) {
	exists(FunctionCall target_7 |
		target_7.getTarget().hasName("strncpy")
		and target_7.getArgument(0).(ValueFieldAccess).getTarget().getName()="geniv"
		and target_7.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_7.getArgument(1).(ConditionalExpr).getCondition().(ValueFieldAccess).getTarget().getName()="geniv"
		and target_7.getArgument(1).(ConditionalExpr).getCondition().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="ablkcipher"
		and target_7.getArgument(1).(ConditionalExpr).getCondition().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_7.getArgument(1).(ConditionalExpr).getCondition().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and target_7.getArgument(1).(ConditionalExpr).getElse().(StringLiteral).getValue()="<built-in>"
		and target_7.getArgument(2).(SizeofExprOperator).getValue()="64")
}

predicate func_8(Parameter valg_64, Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="blocksize"
		and target_8.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="cra_blocksize"
		and target_8.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

/*predicate func_10(Parameter valg_64) {
	exists(PointerFieldAccess target_10 |
		target_10.getTarget().getName()="cra_blocksize"
		and target_10.getQualifier().(VariableAccess).getTarget()=valg_64)
}

*/
predicate func_11(Parameter valg_64, ValueFieldAccess target_21, Function func) {
	exists(ExprStmt target_11 |
		target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="min_keysize"
		and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_11.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="min_keysize"
		and target_11.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="ablkcipher"
		and target_11.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_11.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
		and target_11.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_12(Parameter valg_64, ValueFieldAccess target_21) {
	exists(ValueFieldAccess target_12 |
		target_12.getTarget().getName()="ablkcipher"
		and target_12.getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and target_12.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_13(Parameter valg_64, ValueFieldAccess target_21, Function func) {
	exists(ExprStmt target_13 |
		target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="max_keysize"
		and target_13.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_13.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="max_keysize"
		and target_13.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="ablkcipher"
		and target_13.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_13.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
		and target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_14(Parameter valg_64, Function func) {
	exists(ExprStmt target_14 |
		target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="ivsize"
		and target_14.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="ivsize"
		and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="ablkcipher"
		and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_14.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_14)
}

predicate func_15(Function func) {
	exists(AddressOfExpr target_15 |
		target_15.getOperand().(VariableAccess).getType().hasName("crypto_report_blkcipher")
		and target_15.getParent().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_15.getParent().(FunctionCall).getArgument(1) instanceof EnumConstantAccess
		and target_15.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
		and target_15.getParent().(FunctionCall).getArgument(3) instanceof AddressOfExpr
		and target_15.getParent().(FunctionCall).getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_15.getEnclosingFunction() = func)
}

predicate func_16(Parameter valg_64, PointerFieldAccess target_16) {
		target_16.getTarget().getName()="cra_u"
		and target_16.getQualifier().(VariableAccess).getTarget()=valg_64
}

predicate func_18(Variable vrrng_66, FunctionCall target_18) {
		target_18.getTarget().hasName("snprintf")
		and target_18.getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
		and target_18.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrrng_66
		and target_18.getArgument(1).(Literal).getValue()="64"
		and target_18.getArgument(2).(StringLiteral).getValue()="%s"
		and target_18.getArgument(3).(StringLiteral).getValue()="rng"
}

/*predicate func_19(Variable vrrng_66, VariableAccess target_19) {
		target_19.getTarget()=vrrng_66
		and target_19.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("snprintf")
		and target_19.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
		and target_19.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="64"
		and target_19.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%s"
		and target_19.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(StringLiteral).getValue()="rng"
}

*/
predicate func_20(Variable vrrng_66, AddressOfExpr target_20) {
		target_20.getOperand().(VariableAccess).getTarget()=vrrng_66
		and target_20.getParent().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_20.getParent().(FunctionCall).getArgument(1) instanceof EnumConstantAccess
		and target_20.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
		and target_20.getParent().(FunctionCall).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_21(Parameter valg_64, ValueFieldAccess target_21) {
		target_21.getTarget().getName()="rng"
		and target_21.getQualifier().(PointerFieldAccess).getTarget().getName()="cra_u"
		and target_21.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_64
}

from Function func, Parameter valg_64, Variable vrrng_66, ValueFieldAccess target_0, ValueFieldAccess target_1, SizeofTypeOperator target_3, PointerFieldAccess target_16, FunctionCall target_18, AddressOfExpr target_20, ValueFieldAccess target_21
where
func_0(vrrng_66, target_0)
and func_1(valg_64, target_1)
and func_3(func, target_3)
and not func_5(func)
and not func_7(valg_64)
and not func_8(valg_64, func)
and not func_11(valg_64, target_21, func)
and not func_13(valg_64, target_21, func)
and not func_14(valg_64, func)
and not func_15(func)
and func_16(valg_64, target_16)
and func_18(vrrng_66, target_18)
and func_20(vrrng_66, target_20)
and func_21(valg_64, target_21)
and valg_64.getType().hasName("crypto_alg *")
and vrrng_66.getType().hasName("crypto_report_rng")
and valg_64.getFunction() = func
and vrrng_66.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
