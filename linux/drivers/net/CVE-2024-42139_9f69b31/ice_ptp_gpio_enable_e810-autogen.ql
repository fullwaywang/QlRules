/**
 * @name linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-ice_ptp_gpio_enable_e810
 * @id cpp/linux/9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3/ice-ptp-gpio-enable-e810
 * @description linux-9f69b31ae9e25dec27ad31fbc64dd99af16ee3d3-drivers/net/ethernet/intel/ice/ice_ptp.c-ice_ptp_gpio_enable_e810 CVE-2024-42139
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, BuiltInOperationBuiltInOffsetOf target_0) {
	target_0.getValue()="2560"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func) {
exists(AssignExpr target_1 |
	exists(ValueFieldAccess obj_0 | obj_0=target_1.getLValue() |
		obj_0.getTarget().getName()="flags"
		and obj_0.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
	)
	and target_1.getRValue() instanceof ValueFieldAccess
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(Variable vgpio_pin_1820) {
exists(ExprStmt target_2 |
	exists(AssignExpr obj_0 | obj_0=target_2.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="gpio_pin"
			and obj_1.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
		)
		and obj_0.getRValue().(VariableAccess).getTarget()=vgpio_pin_1820
	)
)
}

predicate func_3(Function func) {
exists(ExprStmt target_3 |
	exists(AssignExpr obj_0 | obj_0=target_3.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="ena"
			and obj_1.getQualifier().(VariableAccess).getType().hasName("ice_extts_channel")
		)
		and obj_0.getRValue() instanceof NotExpr
	)
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(Variable vpf_1816, Variable vchan_1819) {
exists(ExprStmt target_4 |
	exists(FunctionCall obj_0 | obj_0=target_4.getExpr() |
		obj_0.getTarget().hasName("ice_ptp_cfg_extts")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vpf_1816
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vchan_1819
		and obj_0.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("ice_extts_channel")
	)
)
}

predicate func_5(Function func) {
exists(ReturnStmt target_5 |
	target_5.getExpr() instanceof Literal
	and target_5.getEnclosingFunction() = func
)
}

predicate func_6(Parameter vrq_1814, Variable vchan_1819, PointerFieldAccess target_23, ExprStmt target_6) {
	exists(AssignExpr obj_0 | obj_0=target_6.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getRValue() |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="(unknown field)"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vrq_1814
				)
				and obj_2.getTarget().getName()="perout"
			)
			and obj_1.getTarget().getName()="index"
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vchan_1819
	)
	and target_6.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_7(Variable vpf_1816, Variable vclk_cfg_1817, Variable vsma_pres_1818, Variable vchan_1819, Variable vice_pin_desc_e810t, PointerFieldAccess target_23, IfStmt target_7) {
	exists(BlockStmt obj_0 | obj_0=target_7.getThen() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(EqualityOperation obj_2 | obj_2=obj_1.getCondition() |
				exists(ValueFieldAccess obj_3 | obj_3=obj_2.getRightOperand() |
					obj_3.getTarget().getName()="chan"
					and obj_3.getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vice_pin_desc_e810t
				)
				and obj_2.getLeftOperand().(VariableAccess).getTarget()=vchan_1819
			)
			and exists(ExprStmt obj_4 | obj_4=obj_1.getThen() |
				exists(AssignExpr obj_5 | obj_5=obj_4.getExpr() |
					exists(ValueFieldAccess obj_6 | obj_6=obj_5.getLValue() |
						obj_6.getTarget().getName()="gpio_pin"
						and obj_6.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1817
					)
				)
			)
			and exists(IfStmt obj_7 | obj_7=obj_1.getElse() |
				exists(EqualityOperation obj_8 | obj_8=obj_7.getCondition() |
					obj_8.getLeftOperand().(VariableAccess).getTarget()=vchan_1819
					and obj_8.getRightOperand().(ValueFieldAccess).getTarget().getName()="chan"
				)
				and obj_7.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="gpio_pin"
				and obj_7.getElse().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-1"
			)
		)
	)
	and exists(IfStmt obj_9 | obj_9=target_7.getElse() |
		exists(FunctionCall obj_10 | obj_10=obj_9.getCondition() |
			exists(AddressOfExpr obj_11 | obj_11=obj_10.getArgument(0) |
				exists(PointerFieldAccess obj_12 | obj_12=obj_11.getOperand() |
					obj_12.getTarget().getName()="hw"
					and obj_12.getQualifier().(VariableAccess).getTarget()=vpf_1816
				)
			)
			and obj_10.getTarget().hasName("ice_is_e810t")
		)
		and exists(BlockStmt obj_13 | obj_13=obj_9.getThen() |
			exists(IfStmt obj_14 | obj_14=obj_13.getStmt(0) |
				exists(EqualityOperation obj_15 | obj_15=obj_14.getCondition() |
					obj_15.getLeftOperand().(VariableAccess).getTarget()=vchan_1819
					and obj_15.getRightOperand().(Literal).getValue()="0"
				)
				and obj_14.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="gpio_pin"
				and obj_14.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="gpio_pin"
			)
		)
		and exists(IfStmt obj_16 | obj_16=obj_9.getElse() |
			exists(EqualityOperation obj_17 | obj_17=obj_16.getCondition() |
				obj_17.getLeftOperand().(VariableAccess).getTarget()=vchan_1819
				and obj_17.getRightOperand().(Literal).getValue()="3"
			)
			and exists(BlockStmt obj_18 | obj_18=obj_16.getThen() |
				exists(ExprStmt obj_19 | obj_19=obj_18.getStmt(0) |
					exists(AssignExpr obj_20 | obj_20=obj_19.getExpr() |
						obj_20.getLValue().(ValueFieldAccess).getTarget().getName()="gpio_pin"
						and obj_20.getRValue().(Literal).getValue()="5"
					)
				)
			)
			and exists(BlockStmt obj_21 | obj_21=obj_16.getElse() |
				exists(ExprStmt obj_22 | obj_22=obj_21.getStmt(0) |
					exists(AssignExpr obj_23 | obj_23=obj_22.getExpr() |
						obj_23.getLValue().(ValueFieldAccess).getTarget().getName()="gpio_pin"
						and obj_23.getRValue().(VariableAccess).getTarget()=vchan_1819
					)
				)
			)
		)
	)
	and target_7.getCondition().(VariableAccess).getTarget()=vsma_pres_1818
	and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_8(Variable vclk_cfg_1817, PointerFieldAccess target_23, ExprStmt target_8) {
	exists(AssignExpr obj_0 | obj_0=target_8.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="period"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1817
		)
		and exists(AddExpr obj_2 | obj_2=obj_0.getRValue() |
			exists(MulExpr obj_3 | obj_3=obj_2.getLeftOperand() |
				exists(ValueFieldAccess obj_4 | obj_4=obj_3.getLeftOperand() |
					exists(ValueFieldAccess obj_5 | obj_5=obj_4.getQualifier() |
						obj_5.getTarget().getName()="period"
						and obj_5.getQualifier().(ValueFieldAccess).getTarget().getName()="perout"
					)
					and obj_4.getTarget().getName()="sec"
				)
				and obj_3.getRightOperand().(Literal).getValue()="1000000000"
			)
			and exists(ValueFieldAccess obj_6 | obj_6=obj_2.getRightOperand() |
				exists(ValueFieldAccess obj_7 | obj_7=obj_6.getQualifier() |
					exists(ValueFieldAccess obj_8 | obj_8=obj_7.getQualifier() |
						obj_8.getTarget().getName()="perout"
						and obj_8.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
					)
					and obj_7.getTarget().getName()="period"
				)
				and obj_6.getTarget().getName()="nsec"
			)
		)
	)
	and target_8.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_9(Variable vclk_cfg_1817, PointerFieldAccess target_23, ExprStmt target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="start_time"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1817
		)
		and exists(AddExpr obj_2 | obj_2=obj_0.getRValue() |
			exists(MulExpr obj_3 | obj_3=obj_2.getLeftOperand() |
				exists(ValueFieldAccess obj_4 | obj_4=obj_3.getLeftOperand() |
					exists(ValueFieldAccess obj_5 | obj_5=obj_4.getQualifier() |
						obj_5.getTarget().getName()="start"
						and obj_5.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
					)
					and obj_4.getTarget().getName()="sec"
				)
				and obj_3.getRightOperand().(Literal).getValue()="1000000000"
			)
			and exists(ValueFieldAccess obj_6 | obj_6=obj_2.getRightOperand() |
				exists(ValueFieldAccess obj_7 | obj_7=obj_6.getQualifier() |
					exists(ValueFieldAccess obj_8 | obj_8=obj_7.getQualifier() |
						obj_8.getTarget().getName()="(unknown field)"
						and obj_8.getQualifier().(ValueFieldAccess).getTarget().getName()="perout"
					)
					and obj_7.getTarget().getName()="start"
				)
				and obj_6.getTarget().getName()="nsec"
			)
		)
	)
	and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_10(Parameter von_1814, Variable vclk_cfg_1817, PointerFieldAccess target_23, ExprStmt target_10) {
	exists(AssignExpr obj_0 | obj_0=target_10.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="ena"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vclk_cfg_1817
		)
		and obj_0.getRValue().(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=von_1814
	)
	and target_10.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_11(Variable vpf_1816, Variable vclk_cfg_1817, Variable vchan_1819, Variable verr_1821, PointerFieldAccess target_23, ExprStmt target_11) {
	exists(AssignExpr obj_0 | obj_0=target_11.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("ice_ptp_cfg_clkout")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vpf_1816
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vchan_1819
			and obj_1.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vclk_cfg_1817
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=verr_1821
	)
	and target_11.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_12(Parameter vrq_1814, Variable vchan_1819, PointerFieldAccess target_23, ExprStmt target_12) {
	exists(AssignExpr obj_0 | obj_0=target_12.getExpr() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getRValue() |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="(unknown field)"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vrq_1814
				)
				and obj_2.getTarget().getName()="extts"
			)
			and obj_1.getTarget().getName()="index"
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vchan_1819
	)
	and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_13(Variable vpf_1816, Variable vsma_pres_1818, Variable vchan_1819, Variable vgpio_pin_1820, Variable vice_pin_desc_e810t, PointerFieldAccess target_23, IfStmt target_13) {
	exists(BlockStmt obj_0 | obj_0=target_13.getThen() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(RelationalOperation obj_2 | obj_2=obj_1.getCondition() |
				exists(ValueFieldAccess obj_3 | obj_3=obj_2.getGreaterOperand() |
					obj_3.getTarget().getName()="chan"
					and obj_3.getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vice_pin_desc_e810t
				)
				and obj_2.getLesserOperand().(VariableAccess).getTarget()=vchan_1819
			)
			and obj_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgpio_pin_1820
			and obj_1.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgpio_pin_1820
		)
	)
	and exists(IfStmt obj_4 | obj_4=target_13.getElse() |
		exists(FunctionCall obj_5 | obj_5=obj_4.getCondition() |
			exists(AddressOfExpr obj_6 | obj_6=obj_5.getArgument(0) |
				exists(PointerFieldAccess obj_7 | obj_7=obj_6.getOperand() |
					obj_7.getTarget().getName()="hw"
					and obj_7.getQualifier().(VariableAccess).getTarget()=vpf_1816
				)
			)
			and obj_5.getTarget().hasName("ice_is_e810t")
		)
		and exists(BlockStmt obj_8 | obj_8=obj_4.getThen() |
			exists(IfStmt obj_9 | obj_9=obj_8.getStmt(0) |
				exists(EqualityOperation obj_10 | obj_10=obj_9.getCondition() |
					obj_10.getLeftOperand().(VariableAccess).getTarget()=vchan_1819
					and obj_10.getRightOperand().(Literal).getValue()="0"
				)
				and obj_9.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgpio_pin_1820
				and obj_9.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vgpio_pin_1820
			)
		)
		and exists(BlockStmt obj_11 | obj_11=obj_4.getElse() |
			exists(ExprStmt obj_12 | obj_12=obj_11.getStmt(0) |
				exists(AssignExpr obj_13 | obj_13=obj_12.getExpr() |
					obj_13.getLValue().(VariableAccess).getTarget()=vgpio_pin_1820
					and obj_13.getRValue().(VariableAccess).getTarget()=vchan_1819
				)
			)
		)
	)
	and target_13.getCondition().(VariableAccess).getTarget()=vsma_pres_1818
	and target_13.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
}

predicate func_14(Parameter von_1814, NotExpr target_14) {
	target_14.getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=von_1814
	and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_15(Parameter vrq_1814, ValueFieldAccess target_15) {
	exists(ValueFieldAccess obj_0 | obj_0=target_15.getQualifier() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getQualifier() |
			obj_1.getTarget().getName()="(unknown field)"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vrq_1814
		)
		and obj_0.getTarget().getName()="extts"
	)
	and target_15.getTarget().getName()="flags"
}

predicate func_16(PointerFieldAccess target_23, Function func, BreakStmt target_16) {
	target_16.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vpf_1816, VariableAccess target_17) {
	target_17.getTarget()=vpf_1816
	and target_17.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_19(Variable vchan_1819, VariableAccess target_19) {
	target_19.getTarget()=vchan_1819
	and target_19.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_20(Variable vgpio_pin_1820, VariableAccess target_20) {
	target_20.getTarget()=vgpio_pin_1820
	and target_20.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_21(Variable vpf_1816, Variable vchan_1819, Variable vgpio_pin_1820, Variable verr_1821, AssignExpr target_21) {
	exists(FunctionCall obj_0 | obj_0=target_21.getRValue() |
		obj_0.getTarget().hasName("ice_ptp_cfg_extts")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vpf_1816
		and obj_0.getArgument(1) instanceof NotExpr
		and obj_0.getArgument(2).(VariableAccess).getTarget()=vchan_1819
		and obj_0.getArgument(3).(VariableAccess).getTarget()=vgpio_pin_1820
		and obj_0.getArgument(4) instanceof ValueFieldAccess
	)
	and target_21.getLValue().(VariableAccess).getTarget()=verr_1821
}

predicate func_22(PointerFieldAccess target_23, Function func, BreakStmt target_22) {
	target_22.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_23
	and target_22.getEnclosingFunction() = func
}

predicate func_23(Parameter vrq_1814, PointerFieldAccess target_23) {
	target_23.getTarget().getName()="type"
	and target_23.getQualifier().(VariableAccess).getTarget()=vrq_1814
}

from Function func, Variable vpf_1816, Parameter von_1814, Parameter vrq_1814, Variable vclk_cfg_1817, Variable vsma_pres_1818, Variable vchan_1819, Variable vgpio_pin_1820, Variable verr_1821, Variable vice_pin_desc_e810t, BuiltInOperationBuiltInOffsetOf target_0, ExprStmt target_6, IfStmt target_7, ExprStmt target_8, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, ExprStmt target_12, IfStmt target_13, NotExpr target_14, ValueFieldAccess target_15, BreakStmt target_16, VariableAccess target_17, VariableAccess target_19, VariableAccess target_20, AssignExpr target_21, BreakStmt target_22, PointerFieldAccess target_23
where
func_0(func, target_0)
and not func_1(func)
and not func_2(vgpio_pin_1820)
and not func_3(func)
and not func_4(vpf_1816, vchan_1819)
and not func_5(func)
and func_6(vrq_1814, vchan_1819, target_23, target_6)
and func_7(vpf_1816, vclk_cfg_1817, vsma_pres_1818, vchan_1819, vice_pin_desc_e810t, target_23, target_7)
and func_8(vclk_cfg_1817, target_23, target_8)
and func_9(vclk_cfg_1817, target_23, target_9)
and func_10(von_1814, vclk_cfg_1817, target_23, target_10)
and func_11(vpf_1816, vclk_cfg_1817, vchan_1819, verr_1821, target_23, target_11)
and func_12(vrq_1814, vchan_1819, target_23, target_12)
and func_13(vpf_1816, vsma_pres_1818, vchan_1819, vgpio_pin_1820, vice_pin_desc_e810t, target_23, target_13)
and func_14(von_1814, target_14)
and func_15(vrq_1814, target_15)
and func_16(target_23, func, target_16)
and func_17(vpf_1816, target_17)
and func_19(vchan_1819, target_19)
and func_20(vgpio_pin_1820, target_20)
and func_21(vpf_1816, vchan_1819, vgpio_pin_1820, verr_1821, target_21)
and func_22(target_23, func, target_22)
and func_23(vrq_1814, target_23)
and vpf_1816.getType().hasName("ice_pf *")
and von_1814.getType().hasName("int")
and vrq_1814.getType().hasName("ptp_clock_request *")
and vclk_cfg_1817.getType().hasName("ice_perout_channel")
and vsma_pres_1818.getType().hasName("bool")
and vchan_1819.getType().hasName("unsigned int")
and vgpio_pin_1820.getType().hasName("u32")
and verr_1821.getType().hasName("int")
and vice_pin_desc_e810t.getType() instanceof ArrayType
and vpf_1816.(LocalVariable).getFunction() = func
and von_1814.getFunction() = func
and vrq_1814.getFunction() = func
and vclk_cfg_1817.(LocalVariable).getFunction() = func
and vsma_pres_1818.(LocalVariable).getFunction() = func
and vchan_1819.(LocalVariable).getFunction() = func
and vgpio_pin_1820.(LocalVariable).getFunction() = func
and verr_1821.(LocalVariable).getFunction() = func
and not vice_pin_desc_e810t.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
