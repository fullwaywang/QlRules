/**
 * @name linux-de53fd7aedb100f03e5d2231cfce0e4993282425-__return_cfs_rq_runtime
 * @id cpp/linux/de53fd7aedb100f03e5d2231cfce0e4993282425/--return-cfs-rq-runtime
 * @description linux-de53fd7aedb100f03e5d2231cfce0e4993282425-kernel/sched/fair.c-__return_cfs_rq_runtime CVE-2019-19922
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vcfs_b_4830, BlockStmt target_2, EqualityOperation target_0) {
	target_0.getLeftOperand().(PointerFieldAccess).getTarget().getName()="quota"
	and target_0.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4830
	and target_0.getRightOperand().(ComplementExpr).getValue()="18446744073709551615"
	and target_0.getParent().(LogicalAndExpr).getRightOperand() instanceof EqualityOperation
	and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_2
}

predicate func_1(Parameter vcfs_rq_4828, Variable vcfs_b_4830, BlockStmt target_2, LogicalAndExpr target_1) {
	target_1.getLeftOperand() instanceof EqualityOperation
	and target_1.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_1.getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_rq_4828
	and target_1.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="runtime_expires"
	and target_1.getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4830
	and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable vcfs_b_4830, BlockStmt target_2) {
	target_2.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="runtime"
	and target_2.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4830
	and target_2.getStmt(0).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget().getType().hasName("s64")
	and target_2.getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="runtime"
	and target_2.getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfs_b_4830
	and target_2.getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(RelationalOperation).getLesserOperand().(FunctionCall).getTarget().hasName("sched_cfs_bandwidth_slice")
	and target_2.getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("list_empty")
	and target_2.getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="throttled_cfs_rq"
	and target_2.getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("start_cfs_slack_bandwidth")
	and target_2.getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vcfs_b_4830
}

from Function func, Parameter vcfs_rq_4828, Variable vcfs_b_4830, EqualityOperation target_0, LogicalAndExpr target_1, BlockStmt target_2
where
func_0(vcfs_b_4830, target_2, target_0)
and func_1(vcfs_rq_4828, vcfs_b_4830, target_2, target_1)
and func_2(vcfs_b_4830, target_2)
and vcfs_rq_4828.getType().hasName("cfs_rq *")
and vcfs_b_4830.getType().hasName("cfs_bandwidth *")
and vcfs_rq_4828.getFunction() = func
and vcfs_b_4830.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
