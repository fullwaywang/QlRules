/**
 * @name openssl-c6a876473cbff0fd323c8abcaace98ee2d21863d-ssl_cipher_list_to_bytes
 * @id cpp/openssl/c6a876473cbff0fd323c8abcaace98ee2d21863d/ssl-cipher-list-to-bytes
 * @description openssl-c6a876473cbff0fd323c8abcaace98ee2d21863d-ssl/ssl_lib.c-ssl_cipher_list_to_bytes CVE-2014-3566
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vs_1287, Parameter vput_cb_1288, LogicalAndExpr target_16, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vput_cb_1288
		and target_0.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vput_cb_1288
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="put_cipher_by_char"
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_1(Variable vj_1290, LogicalAndExpr target_16, ExprStmt target_10) {
	exists(IfStmt target_1 |
		target_1.getCondition() instanceof NotExpr
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_1290
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof VariableCall
		and target_1.getThen().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_1
		and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_1.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vs_1287, Parameter vp_1287, Parameter vput_cb_1288, Variable vj_1290, LogicalAndExpr target_16, ExprStmt target_22) {
	exists(IfStmt target_2 |
		target_2.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mode"
		and target_2.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_2.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="128"
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_1290
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(VariableAccess).getTarget()=vput_cb_1288
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0) instanceof AddressOfExpr
		and target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vp_1287
		and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vp_1287
		and target_2.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vj_1290
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_2
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_22.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getLocation().isBefore(target_2.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_3(Variable vscsv_1316, AddressOfExpr target_3) {
		target_3.getOperand().(VariableAccess).getTarget()=vscsv_1316
		and target_3.getParent().(VariableCall).getParent().(ConditionalExpr).getElse() instanceof VariableCall
}

predicate func_4(Parameter vp_1287, Parameter vput_cb_1288, Variable vc_1291, VariableCall target_4) {
		target_4.getExpr().(VariableAccess).getTarget()=vput_cb_1288
		and target_4.getArgument(0).(VariableAccess).getTarget()=vc_1291
		and target_4.getArgument(1).(VariableAccess).getTarget()=vp_1287
}

predicate func_5(Parameter vs_1287, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="put_cipher_by_char"
		and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
}

predicate func_6(Parameter vs_1287, Parameter vp_1287, Variable vq_1292, BlockStmt target_23, EqualityOperation target_6) {
		target_6.getAnOperand().(VariableAccess).getTarget()=vp_1287
		and target_6.getAnOperand().(VariableAccess).getTarget()=vq_1292
		and target_6.getParent().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="new_session"
		and target_6.getParent().(LogicalAndExpr).getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_6.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_23
}

/*predicate func_7(Parameter vs_1287, Parameter vp_1287, Variable vq_1292, BlockStmt target_23, NotExpr target_7) {
		target_7.getOperand().(PointerFieldAccess).getTarget().getName()="new_session"
		and target_7.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_7.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vp_1287
		and target_7.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vq_1292
		and target_7.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_23
}

*/
predicate func_8(LogicalAndExpr target_16, Function func, DeclStmt target_8) {
		target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vp_1287, Parameter vput_cb_1288, Variable vscsv_1316, VariableCall target_9) {
		target_9.getExpr().(VariableAccess).getTarget()=vput_cb_1288
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vscsv_1316
		and target_9.getArgument(1).(VariableAccess).getTarget()=vp_1287
}

predicate func_10(Parameter vp_1287, Variable vj_1290, LogicalAndExpr target_16, ExprStmt target_10) {
		target_10.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vp_1287
		and target_10.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vj_1290
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_11(Parameter vs_1287, VariableAccess target_11) {
		target_11.getTarget()=vs_1287
}

predicate func_12(Parameter vput_cb_1288, VariableAccess target_12) {
		target_12.getTarget()=vput_cb_1288
}

predicate func_13(Parameter vput_cb_1288, VariableAccess target_13) {
		target_13.getTarget()=vput_cb_1288
}

predicate func_14(Parameter vs_1287, Parameter vp_1287, Parameter vput_cb_1288, Variable vj_1290, Variable vc_1291, ConditionalExpr target_14) {
		target_14.getCondition().(VariableAccess).getTarget()=vput_cb_1288
		and target_14.getThen() instanceof VariableCall
		and target_14.getElse().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="put_cipher_by_char"
		and target_14.getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_14.getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_14.getElse().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vc_1291
		and target_14.getElse().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vp_1287
		and target_14.getParent().(AssignExpr).getRValue() = target_14
		and target_14.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_1290
}

/*predicate func_15(Parameter vs_1287, Parameter vp_1287, Variable vc_1291, LogicalAndExpr target_16, ExprStmt target_22, VariableAccess target_15) {
		target_15.getTarget()=vc_1291
		and target_15.getParent().(VariableCall).getParent().(ConditionalExpr).getElse().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="put_cipher_by_char"
		and target_15.getParent().(VariableCall).getParent().(ConditionalExpr).getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_15.getParent().(VariableCall).getParent().(ConditionalExpr).getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_15.getParent().(VariableCall).getParent().(ConditionalExpr).getElse().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vp_1287
		and target_15.getParent().(VariableCall).getParent().(ConditionalExpr).getElse().(VariableCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getLocation())
}

*/
predicate func_16(BlockStmt target_23, Function func, LogicalAndExpr target_16) {
		target_16.getAnOperand() instanceof EqualityOperation
		and target_16.getAnOperand() instanceof NotExpr
		and target_16.getParent().(IfStmt).getThen()=target_23
		and target_16.getEnclosingFunction() = func
}

predicate func_17(Parameter vs_1287, Parameter vp_1287, Parameter vput_cb_1288, Variable vj_1290, ConditionalExpr target_17) {
		target_17.getCondition().(VariableAccess).getTarget()=vput_cb_1288
		and target_17.getThen() instanceof VariableCall
		and target_17.getElse().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="put_cipher_by_char"
		and target_17.getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_17.getElse().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_1287
		and target_17.getElse().(VariableCall).getArgument(0) instanceof AddressOfExpr
		and target_17.getElse().(VariableCall).getArgument(1).(VariableAccess).getTarget()=vp_1287
		and target_17.getParent().(AssignExpr).getRValue() = target_17
		and target_17.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_1290
}

predicate func_22(Parameter vp_1287, Variable vj_1290, ExprStmt target_22) {
		target_22.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vp_1287
		and target_22.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vj_1290
}

predicate func_23(Variable vj_1290, BlockStmt target_23) {
		target_23.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_1290
		and target_23.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof ConditionalExpr
		and target_23.getStmt(2) instanceof ExprStmt
}

from Function func, Parameter vs_1287, Parameter vp_1287, Parameter vput_cb_1288, Variable vj_1290, Variable vc_1291, Variable vq_1292, Variable vscsv_1316, AddressOfExpr target_3, VariableCall target_4, PointerFieldAccess target_5, EqualityOperation target_6, DeclStmt target_8, VariableCall target_9, ExprStmt target_10, VariableAccess target_11, VariableAccess target_12, VariableAccess target_13, ConditionalExpr target_14, LogicalAndExpr target_16, ConditionalExpr target_17, ExprStmt target_22, BlockStmt target_23
where
not func_0(vs_1287, vput_cb_1288, target_16, func)
and not func_1(vj_1290, target_16, target_10)
and not func_2(vs_1287, vp_1287, vput_cb_1288, vj_1290, target_16, target_22)
and func_3(vscsv_1316, target_3)
and func_4(vp_1287, vput_cb_1288, vc_1291, target_4)
and func_5(vs_1287, target_5)
and func_6(vs_1287, vp_1287, vq_1292, target_23, target_6)
and func_8(target_16, func, target_8)
and func_9(vp_1287, vput_cb_1288, vscsv_1316, target_9)
and func_10(vp_1287, vj_1290, target_16, target_10)
and func_11(vs_1287, target_11)
and func_12(vput_cb_1288, target_12)
and func_13(vput_cb_1288, target_13)
and func_14(vs_1287, vp_1287, vput_cb_1288, vj_1290, vc_1291, target_14)
and func_16(target_23, func, target_16)
and func_17(vs_1287, vp_1287, vput_cb_1288, vj_1290, target_17)
and func_22(vp_1287, vj_1290, target_22)
and func_23(vj_1290, target_23)
and vs_1287.getType().hasName("SSL *")
and vp_1287.getType().hasName("unsigned char *")
and vput_cb_1288.getType().hasName("..(*)(..)")
and vj_1290.getType().hasName("int")
and vc_1291.getType().hasName("SSL_CIPHER *")
and vq_1292.getType().hasName("unsigned char *")
and vscsv_1316.getType().hasName("SSL_CIPHER")
and vs_1287.getFunction() = func
and vp_1287.getFunction() = func
and vput_cb_1288.getFunction() = func
and vj_1290.(LocalVariable).getFunction() = func
and vc_1291.(LocalVariable).getFunction() = func
and vq_1292.(LocalVariable).getFunction() = func
and vscsv_1316.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
