commit 1dd3ecbec5f606b2a526c47925c8634b1a6bb81e
Author: Tom Rix <trix@redhat.com>
Date:   Mon Feb 14 18:05:41 2022 -0800

    mctp: fix use after free
    
    commit 7e5b6a5c8c44310784c88c1c198dde79f6402f7b upstream.
    
    Clang static analysis reports this problem
    route.c:425:4: warning: Use of memory after it is freed
      trace_mctp_key_acquire(key);
      ^~~~~~~~~~~~~~~~~~~~~~~~~~~
    When mctp_key_add() fails, key is freed but then is later
    used in trace_mctp_key_acquire().  Add an else statement
    to use the key only when mctp_key_add() is successful.
    
    Fixes: 4f9e1ba6de45 ("mctp: Add tracepoints for tag/key handling")
    Signed-off-by: Tom Rix <trix@redhat.com>
    Signed-off-by: David S. Miller <davem@davemloft.net>
    Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>

diff --git a/net/mctp/route.c b/net/mctp/route.c
index cdf09c2a7007..f8c0cb2de98b 100644
--- a/net/mctp/route.c
+++ b/net/mctp/route.c
@@ -414,13 +414,14 @@ static int mctp_route_input(struct mctp_route *route, struct sk_buff *skb)
 			 * this function.
 			 */
 			rc = mctp_key_add(key, msk);
-			if (rc)
+			if (rc) {
 				kfree(key);
+			} else {
+				trace_mctp_key_acquire(key);
 
-			trace_mctp_key_acquire(key);
-
-			/* we don't need to release key->lock on exit */
-			mctp_key_unref(key);
+				/* we don't need to release key->lock on exit */
+				mctp_key_unref(key);
+			}
 			key = NULL;
 
 		} else {
