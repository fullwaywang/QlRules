/**
 * @name linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-expand_downwards
 * @id cpp/linux/1be7107fbe18eed3e319a6c3e83c78254b693acb/expand-downwards
 * @description linux-1be7107fbe18eed3e319a6c3e83c78254b693acb-mm/mmap.c-expand_downwards CVE-2017-1000379
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vaddress_2282, ExprStmt target_4, Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("unsigned long")
		and target_0.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vaddress_2282
		and target_0.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getType().hasName("unsigned long")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vaddress_2282, RelationalOperation target_5, Function func) {
	exists(IfStmt target_1 |
		target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vaddress_2282
		and target_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation().isBefore(target_5.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vvma_2281, NotExpr target_6, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("vm_area_struct *")
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="vm_prev"
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_2281
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
		and target_2.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(LogicalAndExpr).getAnOperand().(VariableAccess).getType().hasName("vm_area_struct *")
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("vm_area_struct *")
		and target_3.getCondition().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("vm_area_struct *")
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="256"
		and target_3.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Parameter vaddress_2282, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("security_mmap_addr")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vaddress_2282
}

predicate func_5(Parameter vaddress_2282, Parameter vvma_2281, RelationalOperation target_5) {
		 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
		and target_5.getLesserOperand().(VariableAccess).getTarget()=vaddress_2282
		and target_5.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="vm_start"
		and target_5.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_2281
}

predicate func_6(Parameter vvma_2281, NotExpr target_6) {
		target_6.getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("anon_vma_prepare")
		and target_6.getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvma_2281
}

from Function func, Parameter vaddress_2282, Parameter vvma_2281, ExprStmt target_4, RelationalOperation target_5, NotExpr target_6
where
not func_0(vaddress_2282, target_4, func)
and not func_1(vaddress_2282, target_5, func)
and not func_2(vvma_2281, target_6, func)
and not func_3(func)
and func_4(vaddress_2282, target_4)
and func_5(vaddress_2282, vvma_2281, target_5)
and func_6(vvma_2281, target_6)
and vaddress_2282.getType().hasName("unsigned long")
and vvma_2281.getType().hasName("vm_area_struct *")
and vaddress_2282.getFunction() = func
and vvma_2281.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
