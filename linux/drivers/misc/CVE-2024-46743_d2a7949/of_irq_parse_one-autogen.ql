/**
 * @name linux-d2a79494d8a5262949736fb2c3ac44d20a51b0d8-of_irq_parse_one
 * @id cpp/linux/d2a79494d8a5262949736fb2c3ac44d20a51b0d8/of-irq-parse-one
 * @description linux-d2a79494d8a5262949736fb2c3ac44d20a51b0d8-drivers/of/irq.c-of_irq_parse_one CVE-2024-46743
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vout_irq_287, Variable vaddr_290, ExprStmt target_17, IfStmt target_0) {
	exists(ReturnStmt obj_0 | obj_0=target_0.getThen() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getTarget().hasName("of_irq_parse_raw")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vaddr_290
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
		)
	)
	and target_0.getCondition() instanceof NotExpr
	and target_0.getLocation().isBefore(target_17.getLocation())
}

predicate func_2(Function func) {
exists(AddressOfExpr target_2 |
	exists(FunctionCall obj_0 | obj_0=target_2.getParent() |
		exists(AssignExpr obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getRValue() |
				obj_2.getTarget().hasName("of_get_property")
				and obj_2.getArgument(0).(VariableAccess).getTarget().getType().hasName("device_node *")
				and obj_2.getArgument(1).(StringLiteral).getValue()="reg"
				and obj_2.getArgument(2) instanceof Literal
			)
		)
	)
	and target_2.getOperand().(VariableAccess).getType().hasName("int")
	and target_2.getEnclosingFunction() = func
)
}

predicate func_3(ReturnStmt target_18, Function func) {
exists(RelationalOperation target_3 |
	 (target_3 instanceof GTExpr or target_3 instanceof LTExpr)
	and target_3.getGreaterOperand().(VariableAccess).getType().hasName("int")
	and target_3.getLesserOperand().(MulExpr).getValue()="12"
	and target_3.getParent().(IfStmt).getThen()=target_18
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(NotExpr target_12, Function func) {
exists(ExprStmt target_4 |
	exists(AssignExpr obj_0 | obj_0=target_4.getExpr() |
		obj_0.getLValue().(VariableAccess).getType().hasName("int")
		and obj_0.getRValue().(MulExpr).getValue()="12"
	)
	and target_4.getParent().(IfStmt).getCondition()=target_12
	and target_4.getEnclosingFunction() = func
)
}

/*predicate func_6(Variable vres_292) {
exists(MulExpr target_6 |
	exists(AssignExpr obj_0 | obj_0=target_6.getParent() |
		obj_0.getRValue() = target_6
		and obj_0.getLValue().(VariableAccess).getTarget()=vres_292
	)
	and target_6.getValue()="12"
)
}

*/
predicate func_7(Variable vaddr_290, ExprStmt target_17, Function func) {
exists(IfStmt target_7 |
	exists(ExprStmt obj_0 | obj_0=target_7.getThen() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getTarget().hasName("__memcpy")
			and obj_1.getArgument(0).(VariableAccess).getType().hasName("__be32[3]")
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vaddr_290
			and obj_1.getArgument(2).(VariableAccess).getType().hasName("int")
		)
	)
	and target_7.getCondition().(VariableAccess).getTarget()=vaddr_290
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getLocation().isBefore(target_17.getLocation())
)
}

predicate func_8(Parameter vout_irq_287, ExprStmt target_17, ExprStmt target_19, ExprStmt target_20, Function func) {
exists(IfStmt target_8 |
	exists(ReturnStmt obj_0 | obj_0=target_8.getThen() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getExpr() |
			obj_1.getTarget().hasName("of_irq_parse_raw")
			and obj_1.getArgument(0).(VariableAccess).getType().hasName("__be32[3]")
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
		)
	)
	and target_8.getCondition() instanceof NotExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
	and target_8.getLocation().isBefore(target_17.getLocation())
	and target_19.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
)
}

predicate func_10(Parameter vout_irq_287, Variable vres_292, PointerDereferenceExpr target_21, ReturnStmt target_22) {
exists(AssignExpr target_10 |
	exists(FunctionCall obj_0 | obj_0=target_10.getRValue() |
		obj_0.getTarget().hasName("of_irq_parse_raw")
		and obj_0.getArgument(0).(VariableAccess).getType().hasName("__be32[3]")
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
	)
	and target_10.getLValue().(VariableAccess).getTarget()=vres_292
	and target_21.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_10.getLValue().(VariableAccess).getLocation().isBefore(target_22.getExpr().(VariableAccess).getLocation())
)
}

predicate func_12(Variable vres_292, ReturnStmt target_18, NotExpr target_12) {
	target_12.getOperand().(VariableAccess).getTarget()=vres_292
	and target_12.getParent().(IfStmt).getThen()=target_18
}

predicate func_13(Parameter vout_irq_287, Variable vaddr_290, Variable vres_292, VariableAccess target_13) {
	exists(AssignExpr obj_0 | obj_0=target_13.getParent() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("of_irq_parse_raw")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vaddr_290
			and obj_1.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
		)
		and obj_0.getLValue() = target_13
	)
	and target_13.getTarget()=vres_292
}

predicate func_15(Parameter vout_irq_287, Variable vaddr_290, VariableAccess target_15) {
	exists(FunctionCall obj_0 | obj_0=target_15.getParent() |
		exists(ReturnStmt obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getExpr() |
				obj_2.getTarget().hasName("of_irq_parse_raw")
				and obj_2.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
			)
		)
	)
	and target_15.getTarget()=vaddr_290
}

/*predicate func_16(Parameter vout_irq_287, Variable vaddr_290, VariableAccess target_16) {
	exists(FunctionCall obj_0 | obj_0=target_16.getParent() |
		exists(AssignExpr obj_1 | obj_1=obj_0.getParent() |
			exists(FunctionCall obj_2 | obj_2=obj_1.getRValue() |
				obj_2.getTarget().hasName("of_irq_parse_raw")
				and obj_2.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
			)
		)
	)
	and target_16.getTarget()=vaddr_290
}

*/
predicate func_17(Function func, ExprStmt target_17) {
	exists(AssignExpr obj_0 | obj_0=target_17.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("of_irq_find_parent")
			and obj_1.getArgument(0).(VariableAccess).getTarget().getType().hasName("device_node *")
		)
		and obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("device_node *")
	)
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Parameter vout_irq_287, Variable vaddr_290, ReturnStmt target_18) {
	exists(FunctionCall obj_0 | obj_0=target_18.getExpr() |
		obj_0.getTarget().hasName("of_irq_parse_raw")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vaddr_290
		and obj_0.getArgument(1).(VariableAccess).getTarget()=vout_irq_287
	)
}

predicate func_19(Parameter vout_irq_287, Variable vres_292, ExprStmt target_19) {
	exists(AssignExpr obj_0 | obj_0=target_19.getExpr() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRValue() |
			obj_1.getTarget().hasName("of_parse_phandle_with_args")
			and obj_1.getArgument(0).(VariableAccess).getTarget().getType().hasName("device_node *")
			and obj_1.getArgument(1).(StringLiteral).getValue()="interrupts-extended"
			and obj_1.getArgument(2).(StringLiteral).getValue()="#interrupt-cells"
			and obj_1.getArgument(3).(VariableAccess).getTarget().getType().hasName("int")
			and obj_1.getArgument(4).(VariableAccess).getTarget()=vout_irq_287
		)
		and obj_0.getLValue().(VariableAccess).getTarget()=vres_292
	)
}

predicate func_20(Parameter vout_irq_287, ExprStmt target_20) {
	exists(AssignExpr obj_0 | obj_0=target_20.getExpr() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getLValue() |
			obj_1.getTarget().getName()="np"
			and obj_1.getQualifier().(VariableAccess).getTarget()=vout_irq_287
		)
		and obj_0.getRValue().(VariableAccess).getTarget().getType().hasName("device_node *")
	)
}

predicate func_21(Parameter vout_irq_287, PointerDereferenceExpr target_21) {
	exists(PointerFieldAccess obj_0 | obj_0=target_21.getOperand() |
		obj_0.getTarget().getName()="args"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vout_irq_287
	)
}

predicate func_22(Variable vres_292, ReturnStmt target_22) {
	target_22.getExpr().(VariableAccess).getTarget()=vres_292
}

from Function func, Parameter vout_irq_287, Variable vaddr_290, Variable vres_292, IfStmt target_0, NotExpr target_12, VariableAccess target_13, VariableAccess target_15, ExprStmt target_17, ReturnStmt target_18, ExprStmt target_19, ExprStmt target_20, PointerDereferenceExpr target_21, ReturnStmt target_22
where
func_0(vout_irq_287, vaddr_290, target_17, target_0)
and not func_2(func)
and not func_3(target_18, func)
and not func_4(target_12, func)
and not func_7(vaddr_290, target_17, func)
and not func_8(vout_irq_287, target_17, target_19, target_20, func)
and not func_10(vout_irq_287, vres_292, target_21, target_22)
and func_12(vres_292, target_18, target_12)
and func_13(vout_irq_287, vaddr_290, vres_292, target_13)
and func_15(vout_irq_287, vaddr_290, target_15)
and func_17(func, target_17)
and func_18(vout_irq_287, vaddr_290, target_18)
and func_19(vout_irq_287, vres_292, target_19)
and func_20(vout_irq_287, target_20)
and func_21(vout_irq_287, target_21)
and func_22(vres_292, target_22)
and vout_irq_287.getType().hasName("of_phandle_args *")
and vaddr_290.getType().hasName("const __be32 *")
and vres_292.getType().hasName("int")
and vout_irq_287.getFunction() = func
and vaddr_290.(LocalVariable).getFunction() = func
and vres_292.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
