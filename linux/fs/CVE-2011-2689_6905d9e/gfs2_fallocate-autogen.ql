/**
 * @name linux-6905d9e4dda6112f007e9090bca80507da158e63-gfs2_fallocate
 * @id cpp/linux/6905d9e4dda6112f007e9090bca80507da158e63/gfs2-fallocate
 * @description linux-6905d9e4dda6112f007e9090bca80507da158e63-fs/gfs2/file.c-gfs2_fallocate CVE-2011-2689
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsdp_813, ExprStmt target_11, ValueFieldAccess target_0) {
		target_0.getTarget().getName()="sb_bsize_shift"
		and target_0.getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_1(Variable vsdp_813, ExprStmt target_14, ValueFieldAccess target_1) {
		target_1.getTarget().getName()="sb_bsize_shift"
		and target_1.getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and target_1.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_2(Parameter voffset_809, VariableAccess target_2) {
		target_2.getTarget()=voffset_809
		and voffset_809.getIndex() = 2
}

predicate func_3(Parameter voffset_809, BinaryBitwiseOperation target_15) {
	exists(AssignAndExpr target_3 |
		target_3.getLValue().(VariableAccess).getTarget()=voffset_809
		and target_3.getRValue().(VariableAccess).getType().hasName("loff_t")
		and target_15.getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_3.getLValue().(VariableAccess).getLocation()))
}

predicate func_4(Variable vbytes_816, ExprStmt target_16, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_4.getExpr().(AssignAndExpr).getRValue().(VariableAccess).getType().hasName("loff_t")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_5(Variable vsdp_813, Variable vbytes_816, ExprStmt target_14, Function func) {
	exists(IfStmt target_5 |
		target_5.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vbytes_816
		and target_5.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="sb_bsize"
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_5.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_7(Variable vbytes_816, LogicalAndExpr target_18, ExprStmt target_19) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_7.getExpr().(AssignAndExpr).getRValue().(VariableAccess).getType().hasName("loff_t")
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_7
		and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
		and target_19.getExpr().(AssignRShiftExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_8(Variable vsdp_813, Variable vbytes_816, LogicalAndExpr target_18, ExprStmt target_20, ExprStmt target_21) {
	exists(IfStmt target_8 |
		target_8.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vbytes_816
		and target_8.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="sb_bsize"
		and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and target_8.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_8
		and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_18
		and target_8.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_8.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_21.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_9(Parameter voffset_809, VariableAccess target_9) {
		target_9.getTarget()=voffset_809
		and target_9.getParent().(AssignExpr).getLValue() = target_9
		and target_9.getParent().(AssignExpr).getRValue() instanceof BinaryBitwiseOperation
}

predicate func_10(Parameter voffset_809, BinaryBitwiseOperation target_10) {
		target_10.getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getTarget()=voffset_809
		and target_10.getLeftOperand().(BinaryBitwiseOperation).getRightOperand() instanceof ValueFieldAccess
		and target_10.getRightOperand() instanceof ValueFieldAccess
		and target_10.getParent().(AssignExpr).getRValue() = target_10
		and target_10.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_809
}

predicate func_11(Variable vsdp_813, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("loff_t")
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("loff_t")
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getAnOperand().(Literal).getValue()="1"
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(ValueFieldAccess).getTarget().getName()="sb_bsize_shift"
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_11.getExpr().(AssignExpr).getRValue().(BinaryBitwiseOperation).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
}

predicate func_14(Variable vsdp_813, Variable vbytes_816, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="sd_max_rg_data"
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="sb_bsize"
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
		and target_14.getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(Literal).getValue()="2"
}

predicate func_15(Parameter voffset_809, Variable vsdp_813, BinaryBitwiseOperation target_15) {
		target_15.getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=voffset_809
		and target_15.getLeftOperand().(SubExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget().getType().hasName("loff_t")
		and target_15.getLeftOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_15.getRightOperand().(ValueFieldAccess).getTarget().getName()="sb_bsize_shift"
		and target_15.getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_15.getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
}

predicate func_16(Variable vbytes_816, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_16.getExpr().(AssignExpr).getRValue().(ComplementExpr).getValue()="4294967295"
}

predicate func_18(Variable vsdp_813, Variable vbytes_816, LogicalAndExpr target_18) {
		target_18.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_18.getAnOperand().(EqualityOperation).getAnOperand().(UnaryMinusExpr).getValue()="-28"
		and target_18.getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vbytes_816
		and target_18.getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getTarget().getName()="sb_bsize"
		and target_18.getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_18.getAnOperand().(RelationalOperation).getLesserOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
}

predicate func_19(Variable vbytes_816, ExprStmt target_19) {
		target_19.getExpr().(AssignRShiftExpr).getLValue().(VariableAccess).getTarget()=vbytes_816
		and target_19.getExpr().(AssignRShiftExpr).getRValue().(Literal).getValue()="1"
}

predicate func_20(Variable vsdp_813, ExprStmt target_20) {
		target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("gfs2_trans_begin")
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsdp_813
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(DivExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(DivExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="sb_bsize"
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(DivExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sd_sb"
		and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(DivExpr).getRightOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsdp_813
}

predicate func_21(Variable vbytes_816, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("loff_t")
		and target_21.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vbytes_816
}

from Function func, Parameter voffset_809, Variable vsdp_813, Variable vbytes_816, ValueFieldAccess target_0, ValueFieldAccess target_1, VariableAccess target_2, VariableAccess target_9, BinaryBitwiseOperation target_10, ExprStmt target_11, ExprStmt target_14, BinaryBitwiseOperation target_15, ExprStmt target_16, LogicalAndExpr target_18, ExprStmt target_19, ExprStmt target_20, ExprStmt target_21
where
func_0(vsdp_813, target_11, target_0)
and func_1(vsdp_813, target_14, target_1)
and func_2(voffset_809, target_2)
and not func_3(voffset_809, target_15)
and not func_4(vbytes_816, target_16, func)
and not func_5(vsdp_813, vbytes_816, target_14, func)
and not func_7(vbytes_816, target_18, target_19)
and not func_8(vsdp_813, vbytes_816, target_18, target_20, target_21)
and func_9(voffset_809, target_9)
and func_10(voffset_809, target_10)
and func_11(vsdp_813, target_11)
and func_14(vsdp_813, vbytes_816, target_14)
and func_15(voffset_809, vsdp_813, target_15)
and func_16(vbytes_816, target_16)
and func_18(vsdp_813, vbytes_816, target_18)
and func_19(vbytes_816, target_19)
and func_20(vsdp_813, target_20)
and func_21(vbytes_816, target_21)
and voffset_809.getType().hasName("loff_t")
and vsdp_813.getType().hasName("gfs2_sbd *")
and vbytes_816.getType().hasName("loff_t")
and voffset_809.getFunction() = func
and vsdp_813.(LocalVariable).getFunction() = func
and vbytes_816.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
