commit 79ceaf827be0b070675d4cd0a55c3386542defd8	79ceaf827be0b070675d4cd0a55c3386542defd8
Author: Michael Niedermayer <michaelni@gmx.at>
Date:   Wed Nov 26 15:45:47 2014 +0100

    avcodec/pngdec: Check IHDR/IDAT order
    
    Fixes out of array access
    Fixes: asan_heap-oob_20a6c26_2690_cov_3434532168_mail.png
    Found-by: Mateusz "j00ru" Jurczyk and Gynvael Coldwind
    Signed-off-by: Michael Niedermayer <michaelni@gmx.at>

diff --git a/libavcodec/pngdec.c b/libavcodec/pngdec.c
index ee6a2baf9d..f80a3fe9d7 100644
--- a/libavcodec/pngdec.c
+++ b/libavcodec/pngdec.c
@@ -524,6 +524,12 @@ static int decode_ihdr_chunk(AVCodecContext *avctx, PNGDecContext *s,
 {
     if (length != 13)
         return AVERROR_INVALIDDATA;
+
+    if (s->state & PNG_IDAT) {
+        av_log(avctx, AV_LOG_ERROR, "IHDR after IDAT\n");
+        return AVERROR_INVALIDDATA;
+    }
+
     s->width  = bytestream2_get_be32(&s->gb);
     s->height = bytestream2_get_be32(&s->gb);
     if (av_image_check_size(s->width, s->height, 0, avctx)) {
