/**
 * @name linux-d467194018dd536fe6c65a2fd3aedfcdb1424903-detach_tasks
 * @id cpp/linux/d467194018dd536fe6c65a2fd3aedfcdb1424903/detach-tasks
 * @description linux-d467194018dd536fe6c65a2fd3aedfcdb1424903-kernel/sched/fair.c-detach_tasks CVE-2024-42245
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter venv_8452, RelationalOperation target_0) {
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getGreaterOperand() |
		obj_0.getTarget().getName()="loop"
		and obj_0.getQualifier().(VariableAccess).getTarget()=venv_8452
	)
	and exists(PointerFieldAccess obj_1 | obj_1=target_0.getLesserOperand() |
		obj_1.getTarget().getName()="loop_max"
		and obj_1.getQualifier().(VariableAccess).getTarget()=venv_8452
	)
	and exists(LogicalAndExpr obj_2 | obj_2=target_0.getParent() |
		obj_2.getRightOperand() instanceof NotExpr
		and obj_2.getParent().(IfStmt).getThen() instanceof BreakStmt
	)
	and  (target_0 instanceof GTExpr or target_0 instanceof LTExpr)
}

predicate func_1(Parameter venv_8452, LogicalAndExpr target_1) {
	exists(NotExpr obj_0 | obj_0=target_1.getRightOperand() |
		exists(BitwiseAndExpr obj_1 | obj_1=obj_0.getOperand() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLeftOperand() |
				obj_2.getTarget().getName()="flags"
				and obj_2.getQualifier().(VariableAccess).getTarget()=venv_8452
			)
			and obj_1.getRightOperand().(Literal).getValue()="1"
		)
	)
	and target_1.getLeftOperand() instanceof RelationalOperation
	and target_1.getParent().(IfStmt).getThen() instanceof BreakStmt
}

from Function func, Parameter venv_8452, RelationalOperation target_0, LogicalAndExpr target_1
where
func_0(venv_8452, target_0)
and func_1(venv_8452, target_1)
and venv_8452.getType().hasName("lb_env *")
and venv_8452.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
