/**
 * @name linux-786de92b3cb26012d3d0f00ee37adf14527f35c4-uas_find_uas_alt_setting
 * @id cpp/linux/786de92b3cb26012d3d0f00ee37adf14527f35c4/uas-find-uas-alt-setting
 * @description linux-786de92b3cb26012d3d0f00ee37adf14527f35c4-drivers/usb/storage/uas-detect.h-uas_find_uas_alt_setting CVE-2017-16530
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="19"
	and not target_0.getValue()="0"
	and target_0.getParent().(UnaryMinusExpr).getParent().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable valt_17, VariableAccess target_1) {
	target_1.getTarget()=valt_17
}

predicate func_2(Variable valt_17, ValueFieldAccess target_2) {
	target_2.getTarget().getName()="bAlternateSetting"
	and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="desc"
	and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valt_17
}

predicate func_3(Function func, UnaryMinusExpr target_3) {
	target_3.getValue()="-19"
	and target_3.getEnclosingFunction() = func
}

from Function func, Variable valt_17, Literal target_0, VariableAccess target_1, ValueFieldAccess target_2, UnaryMinusExpr target_3
where
func_0(func, target_0)
and func_1(valt_17, target_1)
and func_2(valt_17, target_2)
and func_3(func, target_3)
and valt_17.getType().hasName("usb_host_interface *")
and valt_17.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
