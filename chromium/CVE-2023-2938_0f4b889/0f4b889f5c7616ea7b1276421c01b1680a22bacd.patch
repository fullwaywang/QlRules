commit 0f4b889f5c7616ea7b1276421c01b1680a22bacd	0f4b889f5c7616ea7b1276421c01b1680a22bacd
Author: Tommy Steimel <steimel@chromium.org>
Date:   Mon Apr 10 23:47:55 2023 +0000

    pip2: Add browser-side check that non-topmost frames can't open PiP
    
    Only topmost frames are allowed to open document PiP windows. However,
    we currently only check this in the renderer, so a comprimised renderer
    could theoretically bypass that logic to open a PiP window. This CL
    adds a check in the browser side to ensure that only topmost frames can
    open document PiP windows.
    
    Bug: 1416350
    Change-Id: If3f9893a2ae0999ade1b39c1e25e8a2f60a04f76
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4408542
    Reviewed-by: Nasko Oskov <nasko@chromium.org>
    Commit-Queue: Tommy Steimel <steimel@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1128406}

diff --git a/content/browser/renderer_host/render_frame_host_impl.cc b/content/browser/renderer_host/render_frame_host_impl.cc
index 43c31d210e70f..0028134a08607 100644
--- a/content/browser/renderer_host/render_frame_host_impl.cc
+++ b/content/browser/renderer_host/render_frame_host_impl.cc
@@ -7678,6 +7678,14 @@ void RenderFrameHostImpl::CreateNewWindow(
   TRACE_EVENT2("navigation", "RenderFrameHostImpl::CreateNewWindow",
                "render_frame_host", this, "url", params->target_url);
 
+  // Only top-most frames can open picture-in-picture windows.
+  if (params->disposition == WindowOpenDisposition::NEW_PICTURE_IN_PICTURE &&
+      GetParentOrOuterDocumentOrEmbedder()) {
+    frame_host_associated_receiver_.ReportBadMessage(
+        "Only top-most frames can open picture-in-picture windows.");
+    return;
+  }
+
   bool no_javascript_access = false;
 
   // Filter out URLs to which navigation is disallowed from this context.
