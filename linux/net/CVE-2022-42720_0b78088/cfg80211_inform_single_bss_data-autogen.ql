/**
 * @name linux-0b7808818cb9df6680f98996b8e9a439fa7bcc2f-cfg80211_inform_single_bss_data
 * @id cpp/linux/0b7808818cb9df6680f98996b8e9a439fa7bcc2f/cfg80211-inform-single-bss-data
 * @description linux-0b7808818cb9df6680f98996b8e9a439fa7bcc2f-net/wireless/scan.c-cfg80211_inform_single_bss_data CVE-2022-42720
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vres_1939, FunctionCall target_3) {
exists(ExprStmt target_0 |
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vres_1939
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3)
}

predicate func_1(Variable vres_1939, VariableAccess target_4, AddressOfExpr target_5) {
exists(IfStmt target_1 |
	target_1.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vres_1939
	and target_1.getThen().(ReturnStmt).getExpr().(Literal).getValue()="0"
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_1
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
	and target_1.getCondition().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vrdev_1936, FunctionCall target_3, ExprStmt target_2) {
	target_2.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="bss_generation"
	and target_2.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrdev_1936
	and target_2.getParent().(IfStmt).getCondition()=target_3
}

predicate func_3(Variable vrdev_1936, Variable vres_1939, FunctionCall target_3) {
	target_3.getTarget().hasName("__cfg80211_unlink_bss")
	and target_3.getArgument(0).(VariableAccess).getTarget()=vrdev_1936
	and target_3.getArgument(1).(VariableAccess).getTarget()=vres_1939
}

predicate func_4(Parameter vnon_tx_data_1933, BlockStmt target_6, VariableAccess target_4) {
	target_4.getTarget()=vnon_tx_data_1933
	and target_4.getParent().(IfStmt).getThen()=target_6
}

predicate func_5(Variable vres_1939, AddressOfExpr target_5) {
	target_5.getOperand().(PointerFieldAccess).getTarget().getName()="pub"
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vres_1939
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("trace_cfg80211_return_bss")
}

predicate func_6(Parameter vnon_tx_data_1933, Variable vrdev_1936, Variable vres_1939, BlockStmt target_6) {
	target_6.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock_bh")
	and target_6.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="bss_lock"
	and target_6.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrdev_1936
	and target_6.getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("cfg80211_add_nontrans_list")
	and target_6.getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="tx_bss"
	and target_6.getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnon_tx_data_1933
	and target_6.getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pub"
	and target_6.getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vres_1939
	and target_6.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__cfg80211_unlink_bss")
	and target_6.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vrdev_1936
	and target_6.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vres_1939
	and target_6.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getThen() instanceof ExprStmt
}

from Function func, Parameter vnon_tx_data_1933, Variable vrdev_1936, Variable vres_1939, ExprStmt target_2, FunctionCall target_3, VariableAccess target_4, AddressOfExpr target_5, BlockStmt target_6
where
not func_0(vres_1939, target_3)
and not func_1(vres_1939, target_4, target_5)
and func_2(vrdev_1936, target_3, target_2)
and func_3(vrdev_1936, vres_1939, target_3)
and func_4(vnon_tx_data_1933, target_6, target_4)
and func_5(vres_1939, target_5)
and func_6(vnon_tx_data_1933, vrdev_1936, vres_1939, target_6)
and vnon_tx_data_1933.getType().hasName("cfg80211_non_tx_bss *")
and vrdev_1936.getType().hasName("cfg80211_registered_device *")
and vres_1939.getType().hasName("cfg80211_internal_bss *")
and vnon_tx_data_1933.getFunction() = func
and vrdev_1936.(LocalVariable).getFunction() = func
and vres_1939.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
