/**
 * @name linux-5df493a99fcf887133cf01d23cd4bebb6d385d3c-split_huge_page_to_list_to_order
 * @id cpp/linux/5df493a99fcf887133cf01d23cd4bebb6d385d3c/split-huge-page-to-list-to-order
 * @description linux-5df493a99fcf887133cf01d23cd4bebb6d385d3c-mm/huge_memory.c-split_huge_page_to_list_to_order CVE-2024-40950
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1682"
	and not target_0.getValue()="1686"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="1683"
	and not target_1.getValue()="1687"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="1684"
	and not target_2.getValue()="1696"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, Literal target_3) {
	target_3.getValue()="1685"
	and not target_3.getValue()="1697"
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, Literal target_4) {
	target_4.getValue()="1686"
	and not target_4.getValue()="1698"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Function func, Literal target_5) {
	target_5.getValue()="1687"
	and not target_5.getValue()="1699"
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Function func, Literal target_6) {
	target_6.getValue()="1688"
	and not target_6.getValue()="1692"
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Function func, Literal target_7) {
	target_7.getValue()="1689"
	and not target_7.getValue()="1693"
	and target_7.getEnclosingFunction() = func
}

predicate func_8(Function func, Literal target_8) {
	target_8.getValue()="1690"
	and not target_8.getValue()="1694"
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Function func, Literal target_9) {
	target_9.getValue()="1691"
	and not target_9.getValue()="1695"
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Parameter vnew_order_3043, LogicalAndExpr target_38, LogicalAndExpr target_39) {
exists(IfStmt target_10 |
	exists(BlockStmt obj_0 | obj_0=target_10.getThen() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				exists(ValueFieldAccess obj_3 | obj_3=obj_2.getArgument(0) |
					exists(ValueFieldAccess obj_4 | obj_4=obj_3.getQualifier() |
						obj_4.getTarget().getName()="(unknown field)"
						and obj_4.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
					)
					and obj_3.getTarget().getName()="mapping"
				)
				and obj_2.getTarget().hasName("shmem_mapping")
			)
			and obj_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		)
		and exists(IfStmt obj_5 | obj_5=obj_0.getStmt(1) |
			exists(LogicalAndExpr obj_6 | obj_6=obj_5.getCondition() |
				obj_6.getLeftOperand().(Literal).getValue()="1"
				and obj_6.getRightOperand() instanceof NotExpr
			)
			and obj_5.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		)
	)
	and target_10.getCondition().(VariableAccess).getTarget()=vnew_order_3043
	and target_10.getParent().(IfStmt).getCondition()=target_38
	and target_10.getCondition().(VariableAccess).getLocation().isBefore(target_39.getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getLocation())
)
}

/*predicate func_13(Variable v__already_done_1_3063, Variable v__ret_once_1_3063, ExprStmt target_40) {
exists(StmtExpr target_13 |
	exists(BlockStmt obj_0 | obj_0=target_13.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(3) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("__builtin_expect")
				and obj_2.getArgument(1) instanceof Literal
			)
			and exists(BlockStmt obj_3 | obj_3=obj_1.getThen() |
				obj_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_1_3063
				and obj_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_1_3063
			)
		)
		and exists(ExprStmt obj_4 | obj_4=obj_0.getStmt(4) |
			exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
				obj_5.getTarget().hasName("__builtin_expect")
				and obj_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_once_1_3063
				and obj_5.getArgument(1) instanceof Literal
			)
		)
	)
	and target_13.getParent().(IfStmt).getThen()=target_40
)
}

*/
/*predicate func_15(DoStmt target_41, Function func) {
exists(FunctionCall target_15 |
	target_15.getTarget().hasName("__builtin_expect")
	and target_15.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_15.getArgument(1) instanceof Literal
	and target_15.getParent().(IfStmt).getThen()=target_41
	and target_15.getEnclosingFunction() = func
)
}

*/
/*predicate func_16(Variable v__flags_1_3063, ExprStmt target_28) {
exists(DoStmt target_16 |
	exists(BlockStmt obj_0 | obj_0=target_16.getStmt() |
		exists(AsmStmt obj_1 | obj_1=obj_0.getStmt(0) |
			exists(SizeofTypeOperator obj_2 | obj_2=obj_1.getChild(3) |
				obj_2.getType() instanceof LongType
				and obj_2.getValue()="12"
			)
			and obj_1.getChild(0) instanceof StringLiteral
			and obj_1.getChild(1) instanceof Literal
			and obj_1.getChild(2).(VariableAccess).getTarget()=v__flags_1_3063
		)
	)
	and target_16.getCondition() instanceof Literal
	and target_16.getLocation().isBefore(target_28.getLocation())
)
}

*/
/*predicate func_17(Function func) {
exists(ExprStmt target_17 |
	target_17.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1698"
	and target_17.getEnclosingFunction() = func
)
}

*/
/*predicate func_18(Function func) {
exists(ExprStmt target_18 |
	target_18.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1699"
	and target_18.getEnclosingFunction() = func
)
}

*/
predicate func_22(Parameter vnew_order_3043, BlockStmt target_42, LogicalAndExpr target_38, IfStmt target_43) {
exists(LogicalAndExpr target_22 |
	target_22.getLeftOperand() instanceof FunctionCall
	and target_22.getRightOperand().(VariableAccess).getTarget()=vnew_order_3043
	and target_22.getParent().(IfStmt).getThen()=target_42
	and target_22.getRightOperand().(VariableAccess).getLocation().isBefore(target_43.getCondition().(VariableAccess).getLocation())
)
}

predicate func_24(Variable v__already_done_1_3063, Variable v__ret_once_1_3063, ExprStmt target_40, StmtExpr target_24) {
	exists(BlockStmt obj_0 | obj_0=target_24.getStmt() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(3) |
			exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
				obj_2.getTarget().hasName("__builtin_expect")
				and obj_2.getArgument(1) instanceof Literal
			)
			and exists(BlockStmt obj_3 | obj_3=obj_1.getThen() |
				obj_3.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__already_done_1_3063
				and obj_3.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__ret_once_1_3063
			)
		)
		and exists(ExprStmt obj_4 | obj_4=obj_0.getStmt(4) |
			exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
				obj_5.getTarget().hasName("__builtin_expect")
				and obj_5.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_once_1_3063
				and obj_5.getArgument(1) instanceof Literal
			)
		)
	)
	and target_24.getParent().(IfStmt).getThen()=target_40
}

predicate func_26(Variable v__ret_warn_on_1_3063, DoStmt target_41, FunctionCall target_26) {
	target_26.getTarget().hasName("__builtin_expect")
	and target_26.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1_3063
	and target_26.getArgument(1) instanceof Literal
	and target_26.getParent().(IfStmt).getThen()=target_41
}

predicate func_28(Function func, ExprStmt target_28) {
	target_28.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
	and target_28.getEnclosingFunction() = func
}

predicate func_29(Function func, ExprStmt target_29) {
	target_29.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
	and target_29.getEnclosingFunction() = func
}

predicate func_30(Variable v__ret_warn_on_1_3063, FunctionCall target_30) {
	target_30.getTarget().hasName("__builtin_expect")
	and target_30.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1_3063
	and target_30.getArgument(1) instanceof Literal
}

predicate func_31(Variable v__ret_do_once_1_3063, FunctionCall target_31) {
	target_31.getTarget().hasName("__builtin_expect")
	and target_31.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_do_once_1_3063
	and target_31.getArgument(1) instanceof Literal
}

predicate func_32(Function func, UnaryMinusExpr target_32) {
	target_32.getValue()="-22"
	and target_32.getEnclosingFunction() = func
}

predicate func_33(Parameter vnew_order_3043, Variable vfolio_3045, BlockStmt target_44, EqualityOperation target_33) {
	exists(LogicalAndExpr obj_0 | obj_0=target_33.getParent() |
		exists(FunctionCall obj_1 | obj_1=obj_0.getRightOperand() |
			obj_1.getTarget().hasName("folio_test_anon")
			and obj_1.getArgument(0).(VariableAccess).getTarget()=vfolio_3045
		)
		and obj_0.getParent().(IfStmt).getThen()=target_44
	)
	and target_33.getLeftOperand().(VariableAccess).getTarget()=vnew_order_3043
	and target_33.getRightOperand().(Literal).getValue()="1"
}

/*predicate func_34(Variable vfolio_3045, BlockStmt target_44, FunctionCall target_34) {
	target_34.getTarget().hasName("folio_test_anon")
	and target_34.getArgument(0).(VariableAccess).getTarget()=vfolio_3045
	and target_34.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_44
}

*/
predicate func_35(Variable vfolio_3045, ReturnStmt target_45, FunctionCall target_35) {
	target_35.getTarget().hasName("folio_test_swapcache")
	and target_35.getArgument(0).(VariableAccess).getTarget()=vfolio_3045
	and target_35.getParent().(IfStmt).getThen()=target_45
}

predicate func_36(Variable vfolio_3045, BlockStmt target_46, NotExpr target_36) {
	exists(FunctionCall obj_0 | obj_0=target_36.getOperand() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getArgument(0) |
			exists(ValueFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				exists(PointerFieldAccess obj_3 | obj_3=obj_2.getQualifier() |
					obj_3.getTarget().getName()="(unknown field)"
					and obj_3.getQualifier().(VariableAccess).getTarget()=vfolio_3045
				)
				and obj_2.getTarget().getName()="(unknown field)"
			)
			and obj_1.getTarget().getName()="mapping"
		)
		and obj_0.getTarget().hasName("mapping_large_folio_support")
	)
	and target_36.getParent().(IfStmt).getThen()=target_46
}

predicate func_37(Parameter vnew_order_3043, BlockStmt target_42, VariableAccess target_37) {
	target_37.getTarget()=vnew_order_3043
	and target_37.getParent().(IfStmt).getThen()=target_42
}

predicate func_38(Function func, LogicalAndExpr target_38) {
	target_38.getLeftOperand() instanceof EqualityOperation
	and target_38.getRightOperand() instanceof FunctionCall
	and target_38.getEnclosingFunction() = func
}

predicate func_39(Parameter vnew_order_3043, Variable vfolio_3045, LogicalAndExpr target_39) {
	exists(FunctionCall obj_0 | obj_0=target_39.getLeftOperand() |
		obj_0.getTarget().hasName("folio_test_pmd_mappable")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vfolio_3045
	)
	and exists(RelationalOperation obj_1 | obj_1=target_39.getRightOperand() |
		obj_1.getLesserOperand().(VariableAccess).getTarget()=vnew_order_3043
		and obj_1.getGreaterOperand().(SubExpr).getValue()="9"
	)
}

predicate func_40(Function func, ExprStmt target_40) {
	exists(StmtExpr obj_0 | obj_0=target_40.getExpr() |
		exists(BlockStmt obj_1 | obj_1=obj_0.getStmt() |
			exists(IfStmt obj_2 | obj_2=obj_1.getStmt(1) |
				exists(DoStmt obj_3 | obj_3=obj_2.getThen() |
					obj_3.getCondition() instanceof Literal
					and obj_3.getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
				)
				and obj_2.getCondition() instanceof FunctionCall
			)
			and obj_1.getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
		)
	)
	and target_40.getEnclosingFunction() = func
}

predicate func_41(Function func, DoStmt target_41) {
	exists(BlockStmt obj_0 | obj_0=target_41.getStmt() |
		exists(DoStmt obj_1 | obj_1=obj_0.getStmt(2) |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				obj_2.getStmt(2).(DoStmt).getCondition() instanceof Literal
				and obj_2.getStmt(3) instanceof ExprStmt
			)
			and obj_1.getCondition() instanceof Literal
		)
		and obj_0.getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof Literal
		and obj_0.getStmt(3) instanceof ExprStmt
	)
	and target_41.getCondition() instanceof Literal
	and target_41.getEnclosingFunction() = func
}

predicate func_42(Variable vfolio_3045, BlockStmt target_42) {
	exists(IfStmt obj_0 | obj_0=target_42.getStmt(0) |
		obj_0.getCondition() instanceof FunctionCall
		and obj_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	)
	and exists(IfStmt obj_1 | obj_1=target_42.getStmt(1) |
		exists(FunctionCall obj_2 | obj_2=obj_1.getCondition() |
			exists(ValueFieldAccess obj_3 | obj_3=obj_2.getArgument(0) |
				exists(ValueFieldAccess obj_4 | obj_4=obj_3.getQualifier() |
					exists(PointerFieldAccess obj_5 | obj_5=obj_4.getQualifier() |
						obj_5.getTarget().getName()="(unknown field)"
						and obj_5.getQualifier().(VariableAccess).getTarget()=vfolio_3045
					)
					and obj_4.getTarget().getName()="(unknown field)"
				)
				and obj_3.getTarget().getName()="mapping"
			)
			and obj_2.getTarget().hasName("shmem_mapping")
		)
		and obj_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	)
}

predicate func_43(Parameter vnew_order_3043, IfStmt target_43) {
	exists(BlockStmt obj_0 | obj_0=target_43.getThen() |
		exists(IfStmt obj_1 | obj_1=obj_0.getStmt(0) |
			obj_1.getCondition() instanceof FunctionCall
			and obj_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		)
		and exists(IfStmt obj_2 | obj_2=obj_0.getStmt(1) |
			exists(FunctionCall obj_3 | obj_3=obj_2.getCondition() |
				exists(ValueFieldAccess obj_4 | obj_4=obj_3.getArgument(0) |
					exists(ValueFieldAccess obj_5 | obj_5=obj_4.getQualifier() |
						obj_5.getTarget().getName()="(unknown field)"
						and obj_5.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
					)
					and obj_4.getTarget().getName()="mapping"
				)
				and obj_3.getTarget().hasName("shmem_mapping")
			)
			and obj_2.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		)
	)
	and target_43.getCondition().(VariableAccess).getTarget()=vnew_order_3043
}

predicate func_44(Function func, BlockStmt target_44) {
	exists(ExprStmt obj_0 | obj_0=target_44.getStmt(0) |
		exists(StmtExpr obj_1 | obj_1=obj_0.getExpr() |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				obj_2.getStmt(1).(IfStmt).getCondition() instanceof StmtExpr
				and obj_2.getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
			)
		)
	)
	and target_44.getStmt(1).(ReturnStmt).getExpr() instanceof UnaryMinusExpr
	and target_44.getEnclosingFunction() = func
}

predicate func_45(FunctionCall target_35, Function func, ReturnStmt target_45) {
	target_45.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_45.getParent().(IfStmt).getCondition()=target_35
	and target_45.getEnclosingFunction() = func
}

predicate func_46(Function func, BlockStmt target_46) {
	exists(ExprStmt obj_0 | obj_0=target_46.getStmt(0) |
		exists(StmtExpr obj_1 | obj_1=obj_0.getExpr() |
			exists(BlockStmt obj_2 | obj_2=obj_1.getStmt() |
				exists(ExprStmt obj_3 | obj_3=obj_2.getStmt(2) |
					exists(FunctionCall obj_4 | obj_4=obj_3.getExpr() |
						obj_4.getTarget().hasName("__builtin_expect")
						and obj_4.getArgument(1) instanceof Literal
					)
				)
			)
		)
	)
	and target_46.getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_46.getEnclosingFunction() = func
}

from Function func, Parameter vnew_order_3043, Variable vfolio_3045, Variable v__ret_do_once_1_3063, Variable v__already_done_1_3063, Variable v__ret_once_1_3063, Variable v__ret_warn_on_1_3063, Variable v__flags_1_3063, Literal target_0, Literal target_1, Literal target_2, Literal target_3, Literal target_4, Literal target_5, Literal target_6, Literal target_7, Literal target_8, Literal target_9, StmtExpr target_24, FunctionCall target_26, ExprStmt target_28, ExprStmt target_29, FunctionCall target_30, FunctionCall target_31, UnaryMinusExpr target_32, EqualityOperation target_33, FunctionCall target_35, NotExpr target_36, VariableAccess target_37, LogicalAndExpr target_38, LogicalAndExpr target_39, ExprStmt target_40, DoStmt target_41, BlockStmt target_42, IfStmt target_43, BlockStmt target_44, ReturnStmt target_45, BlockStmt target_46
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and func_5(func, target_5)
and func_6(func, target_6)
and func_7(func, target_7)
and func_8(func, target_8)
and func_9(func, target_9)
and not func_10(vnew_order_3043, target_38, target_39)
and not func_22(vnew_order_3043, target_42, target_38, target_43)
and func_24(v__already_done_1_3063, v__ret_once_1_3063, target_40, target_24)
and func_26(v__ret_warn_on_1_3063, target_41, target_26)
and func_28(func, target_28)
and func_29(func, target_29)
and func_30(v__ret_warn_on_1_3063, target_30)
and func_31(v__ret_do_once_1_3063, target_31)
and func_32(func, target_32)
and func_33(vnew_order_3043, vfolio_3045, target_44, target_33)
and func_35(vfolio_3045, target_45, target_35)
and func_36(vfolio_3045, target_46, target_36)
and func_37(vnew_order_3043, target_42, target_37)
and func_38(func, target_38)
and func_39(vnew_order_3043, vfolio_3045, target_39)
and func_40(func, target_40)
and func_41(func, target_41)
and func_42(vfolio_3045, target_42)
and func_43(vnew_order_3043, target_43)
and func_44(func, target_44)
and func_45(target_35, func, target_45)
and func_46(func, target_46)
and vnew_order_3043.getType().hasName("unsigned int")
and vfolio_3045.getType().hasName("folio *")
and v__ret_do_once_1_3063.getType().hasName("bool")
and v__already_done_1_3063.getType().hasName("bool")
and v__ret_once_1_3063.getType().hasName("bool")
and v__ret_warn_on_1_3063.getType().hasName("int")
and v__flags_1_3063.getType().hasName("int")
and vnew_order_3043.getFunction() = func
and vfolio_3045.(LocalVariable).getFunction() = func
and v__ret_do_once_1_3063.(LocalVariable).getFunction() = func
and v__already_done_1_3063.(LocalVariable).getFunction() = func
and v__ret_once_1_3063.(LocalVariable).getFunction() = func
and v__ret_warn_on_1_3063.(LocalVariable).getFunction() = func
and v__flags_1_3063.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
