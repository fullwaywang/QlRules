/**
 * @name linux-89e66809684485590ea0b32c3178e42cba36ac09-u_audio_set_volume
 * @id cpp/linux/89e66809684485590ea0b32c3178e42cba36ac09/u-audio-set-volume
 * @description linux-89e66809684485590ea0b32c3178e42cba36ac09-drivers/usb/gadget/function/u_audio.c-u_audio_set_volume CVE-2024-38628
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vprm_791, PointerFieldAccess target_0) {
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getQualifier() |
		obj_0.getTarget().getName()="snd_kctl_volume"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vprm_791
	)
	and target_0.getTarget().getName()="id"
}

predicate func_1(Variable vprm_791, VariableAccess target_1) {
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getParent() |
			exists(AddressOfExpr obj_2 | obj_2=obj_1.getParent() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getParent() |
					exists(ExprStmt obj_4 | obj_4=obj_3.getParent() |
						exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
							exists(PointerFieldAccess obj_6 | obj_6=obj_5.getArgument(0) |
								obj_6.getTarget().getName()="card"
								and obj_6.getQualifier().(VariableAccess).getTarget().getType().hasName("snd_uac_chip *")
							)
							and obj_5.getTarget().hasName("snd_ctl_notify")
							and obj_5.getArgument(1).(BinaryBitwiseOperation).getValue()="1"
							and obj_5.getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="id"
						)
					)
				)
			)
		)
	)
	and target_1.getTarget()=vprm_791
}

from Function func, Variable vprm_791, PointerFieldAccess target_0, VariableAccess target_1
where
func_0(vprm_791, target_0)
and func_1(vprm_791, target_1)
and vprm_791.getType().hasName("uac_rtd_params *")
and vprm_791.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
