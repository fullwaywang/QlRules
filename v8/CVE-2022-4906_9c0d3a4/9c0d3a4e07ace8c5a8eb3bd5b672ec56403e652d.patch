commit 9c0d3a4e07ace8c5a8eb3bd5b672ec56403e652d	9c0d3a4e07ace8c5a8eb3bd5b672ec56403e652d
Author: Thibaud Michaud <thibaudm@chromium.org>
Date:   Tue Nov 8 17:18:34 2022 +0100

    Check all store modes for COW backing store access
    
    R=jkummerow@chromium.org
    
    Bug: chromium:1382434
    Change-Id: I06d239a70eba125b1074542cb93def2b1f011f81
    Reviewed-on: https://chromium-review.googlesource.com/c/v8/v8/+/4013686
    Commit-Queue: Thibaud Michaud <thibaudm@chromium.org>
    Reviewed-by: Jakob Kummerow <jkummerow@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#84127}

diff --git a/src/compiler/heap-refs.h b/src/compiler/heap-refs.h
index b77fc71cec0..c3a502ab334 100644
--- a/src/compiler/heap-refs.h
+++ b/src/compiler/heap-refs.h
@@ -56,7 +56,8 @@ class PropertyAccessInfo;
 enum class AccessMode { kLoad, kStore, kStoreInLiteral, kHas, kDefine };
 
 inline bool IsAnyStore(AccessMode mode) {
-  return mode == AccessMode::kStore || mode == AccessMode::kStoreInLiteral;
+  return mode == AccessMode::kStore || mode == AccessMode::kStoreInLiteral ||
+         mode == AccessMode::kDefine;
 }
 
 enum class OddballType : uint8_t {
diff --git a/src/compiler/js-native-context-specialization.cc b/src/compiler/js-native-context-specialization.cc
index ad94729e685..e975867645d 100644
--- a/src/compiler/js-native-context-specialization.cc
+++ b/src/compiler/js-native-context-specialization.cc
@@ -3399,7 +3399,7 @@ JSNativeContextSpecialization::BuildElementAccess(
 
     // Don't try to store to a copy-on-write backing store (unless supported by
     // the store mode).
-    if (keyed_mode.access_mode() == AccessMode::kStore &&
+    if (IsAnyStore(keyed_mode.access_mode()) &&
         IsSmiOrObjectElementsKind(elements_kind) &&
         !IsCOWHandlingStoreMode(keyed_mode.store_mode())) {
       effect = graph()->NewNode(
