/**
 * @name linux-ca459dfa7d4ed9098fcf13e410963be6ae9b6bf3-scarlett2_usb_set_config
 * @id cpp/linux/ca459dfa7d4ed9098fcf13e410963be6ae9b6bf3/scarlett2-usb-set-config
 * @description linux-ca459dfa7d4ed9098fcf13e410963be6ae9b6bf3-sound/usb/mixer_scarlett2.c-scarlett2_usb_set_config CVE-2023-52692
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable verr_1559) {
exists(AssignExpr target_0 |
	target_0.getLValue().(VariableAccess).getTarget()=verr_1559
	and target_0.getRValue() instanceof FunctionCall)
}

predicate func_1(Variable verr_1559, RelationalOperation target_4) {
exists(IfStmt target_1 |
	target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=verr_1559
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_1.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=verr_1559
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(4)=target_1
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4)
}

predicate func_2(Variable voffset_1558, Variable vtmp_1575, Parameter vmixer_1545, FunctionCall target_2) {
	target_2.getTarget().hasName("scarlett2_usb_get")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vmixer_1545
	and target_2.getArgument(1).(VariableAccess).getTarget()=voffset_1558
	and target_2.getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtmp_1575
	and target_2.getArgument(3).(Literal).getValue()="1"
}

predicate func_4(Function func, RelationalOperation target_4) {
	 (target_4 instanceof GEExpr or target_4 instanceof LEExpr)
	and target_4.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="size"
	and target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("const scarlett2_config *")
	and target_4.getLesserOperand().(Literal).getValue()="8"
	and target_4.getEnclosingFunction() = func
}

from Function func, Variable voffset_1558, Variable verr_1559, Variable vtmp_1575, Parameter vmixer_1545, FunctionCall target_2, RelationalOperation target_4
where
not func_0(verr_1559)
and not func_1(verr_1559, target_4)
and func_2(voffset_1558, vtmp_1575, vmixer_1545, target_2)
and func_4(func, target_4)
and voffset_1558.getType().hasName("int")
and verr_1559.getType().hasName("int")
and vtmp_1575.getType().hasName("u8")
and vmixer_1545.getType().hasName("usb_mixer_interface *")
and voffset_1558.(LocalVariable).getFunction() = func
and verr_1559.(LocalVariable).getFunction() = func
and vtmp_1575.(LocalVariable).getFunction() = func
and vmixer_1545.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
