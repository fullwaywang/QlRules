/**
 * @name linux-2287a51ba822384834dafc1c798453375d1107c7-vt_k_ioctl
 * @id cpp/linux/2287a51ba822384834dafc1c798453375d1107c7/vt-k-ioctl
 * @description linux-2287a51ba822384834dafc1c798453375d1107c7-drivers/tty/vt/vt_ioctl.c-vt_k_ioctl CVE-2021-3753
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(VariableAccess target_5, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(FunctionCall).getTarget().hasName("console_lock")
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_5
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable vret_290, VariableAccess target_5, ReturnStmt target_6) {
exists(ExprStmt target_1 |
	target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_290
	and target_1.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_5
	and target_6.getExpr().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_2(VariableAccess target_5, Function func) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("console_unlock")
	and target_2.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_5
	and target_2.getEnclosingFunction() = func)
}

predicate func_4(Parameter varg_285, Variable vvc_287, FunctionCall target_4) {
	target_4.getTarget().hasName("vt_kdsetmode")
	and target_4.getArgument(0).(VariableAccess).getTarget()=vvc_287
	and target_4.getArgument(1).(VariableAccess).getTarget()=varg_285
}

predicate func_5(Parameter vcmd_284, VariableAccess target_5) {
	target_5.getTarget()=vcmd_284
}

predicate func_6(Variable vret_290, VariableAccess target_7, ReturnStmt target_6) {
	target_6.getExpr().(VariableAccess).getTarget()=vret_290
	and target_6.getParent().(IfStmt).getCondition()=target_7
}

predicate func_7(Variable vret_290, ReturnStmt target_6, VariableAccess target_7) {
	target_7.getTarget()=vret_290
	and target_7.getParent().(IfStmt).getThen()=target_6
}

from Function func, Parameter vcmd_284, Parameter varg_285, Variable vvc_287, Variable vret_290, FunctionCall target_4, VariableAccess target_5, ReturnStmt target_6, VariableAccess target_7
where
not func_0(target_5, func)
and not func_1(vret_290, target_5, target_6)
and not func_2(target_5, func)
and func_4(varg_285, vvc_287, target_4)
and func_5(vcmd_284, target_5)
and func_6(vret_290, target_7, target_6)
and func_7(vret_290, target_6, target_7)
and vcmd_284.getType().hasName("unsigned int")
and varg_285.getType().hasName("unsigned long")
and vvc_287.getType().hasName("vc_data *")
and vret_290.getType().hasName("int")
and vcmd_284.getFunction() = func
and varg_285.getFunction() = func
and vvc_287.(LocalVariable).getFunction() = func
and vret_290.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
