/**
 * @name linux-096cdc6f52225835ff503f987a0d68ef770bb78e-ec_device_ioctl_xcmd
 * @id cpp/linux/096cdc6f52225835ff503f987a0d68ef770bb78e/ec-device-ioctl-xcmd
 * @description linux-096cdc6f52225835ff503f987a0d68ef770bb78e-drivers/platform/chrome/cros_ec_dev.c-ec_device_ioctl_xcmd CVE-2016-6156
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vret_133, Variable vu_cmd_134, Variable vs_cmd_135, ExprStmt target_3, ExprStmt target_4, AddExpr target_5, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="outsize"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vu_cmd_134
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="outsize"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_cmd_135
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand() instanceof ValueFieldAccess
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="insize"
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_cmd_135
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_133
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-22"
	and target_0.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="exit"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_3.getLocation())
	and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_5.getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vs_cmd_135, ExprStmt target_8) {
exists(PointerFieldAccess target_1 |
	target_1.getTarget().getName()="insize"
	and target_1.getQualifier().(VariableAccess).getTarget()=vs_cmd_135
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Variable vu_cmd_134, ValueFieldAccess target_2) {
	target_2.getTarget().getName()="insize"
	and target_2.getQualifier().(VariableAccess).getTarget()=vu_cmd_134
}

predicate func_3(Variable vs_cmd_135, ExprStmt target_3) {
	target_3.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="command"
	and target_3.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_cmd_135
	and target_3.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getTarget().getName()="cmd_offset"
	and target_3.getExpr().(AssignAddExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("cros_ec_dev *")
}

predicate func_4(Variable vret_133, FunctionCall target_9, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_133
	and target_4.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-14"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_5(Variable vu_cmd_134, AddExpr target_5) {
	target_5.getLeftOperand().(SizeofExprOperator).getValue()="20"
	and target_5.getRightOperand().(ValueFieldAccess).getTarget().getName()="outsize"
	and target_5.getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vu_cmd_134
}

predicate func_8(Variable vs_cmd_135, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_cmd_135
}

predicate func_9(Variable vu_cmd_134, Variable vs_cmd_135, FunctionCall target_9) {
	target_9.getTarget().hasName("copy_from_user")
	and target_9.getArgument(0).(VariableAccess).getTarget()=vs_cmd_135
	and target_9.getArgument(1).(VariableAccess).getTarget().getType().hasName("void *")
	and target_9.getArgument(2).(AddExpr).getLeftOperand().(SizeofExprOperator).getValue()="20"
	and target_9.getArgument(2).(AddExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="outsize"
	and target_9.getArgument(2).(AddExpr).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vu_cmd_134
}

from Function func, Variable vret_133, Variable vu_cmd_134, Variable vs_cmd_135, ValueFieldAccess target_2, ExprStmt target_3, ExprStmt target_4, AddExpr target_5, ExprStmt target_8, FunctionCall target_9
where
not func_0(vret_133, vu_cmd_134, vs_cmd_135, target_3, target_4, target_5, func)
and not func_1(vs_cmd_135, target_8)
and func_2(vu_cmd_134, target_2)
and func_3(vs_cmd_135, target_3)
and func_4(vret_133, target_9, target_4)
and func_5(vu_cmd_134, target_5)
and func_8(vs_cmd_135, target_8)
and func_9(vu_cmd_134, vs_cmd_135, target_9)
and vret_133.getType().hasName("long")
and vu_cmd_134.getType().hasName("cros_ec_command")
and vs_cmd_135.getType().hasName("cros_ec_command *")
and vret_133.(LocalVariable).getFunction() = func
and vu_cmd_134.(LocalVariable).getFunction() = func
and vs_cmd_135.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
