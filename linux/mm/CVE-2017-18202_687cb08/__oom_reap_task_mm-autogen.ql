/**
 * @name linux-687cb0884a714ff484d038e9190edc874edcf146-__oom_reap_task_mm
 * @id cpp/linux/687cb0884a714ff484d038e9190edc874edcf146/--oom-reap-task-mm
 * @description linux-687cb0884a714ff484d038e9190edc874edcf146-mm/oom_kill.c-__oom_reap_task_mm CVE-2017-18202
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Variable vvma_491, ExprStmt target_6) {
	exists(PointerFieldAccess target_2 |
		target_2.getTarget().getName()="vm_start"
		and target_2.getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_2.getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_4(Variable vvma_491, Variable vtlb_490, PointerFieldAccess target_4) {
		target_4.getTarget().getName()="vm_start"
		and target_4.getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("unmap_page_range")
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_491
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

*/
/*predicate func_5(Variable vvma_491, Variable vtlb_490, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="vm_end"
		and target_5.getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("unmap_page_range")
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_491
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="vm_start"
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

*/
predicate func_6(Variable vvma_491, Variable vtlb_490, LogicalOrExpr target_11, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("unmap_page_range")
		and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_491
		and target_6.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="vm_start"
		and target_6.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_6.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_6.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_6.getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
		and target_6.getParent().(IfStmt).getCondition()=target_11
}

predicate func_8(Variable vtlb_490, AddressOfExpr target_13, UnaryMinusExpr target_8) {
		target_8.getValue()="18446744073709551615"
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("tlb_gather_mmu")
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("mm_struct *")
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(Literal).getValue()="0"
		and target_8.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_13.getOperand().(VariableAccess).getLocation())
}

predicate func_10(Variable vtlb_490, AddressOfExpr target_13, UnaryMinusExpr target_10) {
		target_10.getValue()="18446744073709551615"
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("tlb_finish_mmu")
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_13.getOperand().(VariableAccess).getLocation().isBefore(target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation())
}

predicate func_11(Variable vvma_491, LogicalOrExpr target_11) {
		target_11.getAnOperand().(FunctionCall).getTarget().hasName("vma_is_anonymous")
		and target_11.getAnOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvma_491
		and target_11.getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="vm_flags"
		and target_11.getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_11.getAnOperand().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="8"
}

predicate func_13(Variable vvma_491, Variable vtlb_490, AddressOfExpr target_13) {
		target_13.getOperand().(VariableAccess).getTarget()=vtlb_490
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("unmap_page_range")
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vvma_491
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="vm_start"
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvma_491
		and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(Literal).getValue()="0"
}

from Function func, Variable vvma_491, Variable vtlb_490, ExprStmt target_6, UnaryMinusExpr target_8, UnaryMinusExpr target_10, LogicalOrExpr target_11, AddressOfExpr target_13
where
not func_2(vvma_491, target_6)
and func_6(vvma_491, vtlb_490, target_11, target_6)
and func_8(vtlb_490, target_13, target_8)
and func_10(vtlb_490, target_13, target_10)
and func_11(vvma_491, target_11)
and func_13(vvma_491, vtlb_490, target_13)
and vvma_491.getType().hasName("vm_area_struct *")
and vtlb_490.getType().hasName("mmu_gather")
and vvma_491.(LocalVariable).getFunction() = func
and vtlb_490.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
