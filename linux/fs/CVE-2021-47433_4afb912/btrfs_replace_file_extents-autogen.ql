/**
 * @name linux-4afb912f439c4bc4e6a4f3e7547f2e69e354108f-btrfs_replace_file_extents
 * @id cpp/linux/4afb912f439c4bc4e6a4f3e7547f2e69e354108f/btrfs-replace-file-extents
 * @description linux-4afb912f439c4bc4e6a4f3e7547f2e69e354108f-fs/btrfs/file.c-btrfs_replace_file_extents CVE-2021-47433
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vextent_info_2644, Variable vret_2657, DoStmt target_7, LogicalAndExpr target_8) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand() instanceof EqualityOperation
	and target_0.getRightOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getTarget()=vextent_info_2644
	and target_0.getRightOperand().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="is_new_extent"
	and target_0.getRightOperand().(LogicalAndExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vextent_info_2644
	and target_0.getParent().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand() instanceof LogicalAndExpr
	and target_0.getParent().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget()=vret_2657
	and target_0.getParent().(LogicalAndExpr).getRightOperand() instanceof EqualityOperation
	and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_7
	and target_0.getRightOperand().(LogicalAndExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_8.getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(VariableAccess).getLocation()))
}

/*predicate func_1(Parameter vextent_info_2644, LogicalAndExpr target_8) {
exists(PointerFieldAccess target_1 |
	target_1.getTarget().getName()="is_new_extent"
	and target_1.getQualifier().(VariableAccess).getTarget()=vextent_info_2644
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_8.getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(VariableAccess).getLocation()))
}

*/
predicate func_2(Parameter vextent_info_2644, NotExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="is_new_extent"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vextent_info_2644
}

predicate func_3(Variable vret_2657, DoStmt target_7, EqualityOperation target_3) {
	target_3.getLeftOperand().(VariableAccess).getTarget()=vret_2657
	and target_3.getRightOperand().(UnaryMinusExpr).getValue()="-95"
	and target_3.getParent().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getLeftOperand() instanceof LogicalAndExpr
	and target_3.getParent().(LogicalAndExpr).getLeftOperand().(LogicalAndExpr).getRightOperand().(VariableAccess).getTarget()=vret_2657
	and target_3.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_7
}

predicate func_4(Parameter vextent_info_2644, VariableAccess target_4) {
	target_4.getTarget()=vextent_info_2644
}

/*predicate func_5(Variable vret_2657, VariableAccess target_5) {
	target_5.getTarget()=vret_2657
}

*/
predicate func_6(Parameter vextent_info_2644, LogicalAndExpr target_6) {
	target_6.getLeftOperand().(VariableAccess).getTarget()=vextent_info_2644
	and target_6.getRightOperand() instanceof NotExpr
}

predicate func_7(Variable vret_2657, DoStmt target_7) {
	target_7.getCondition() instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_and_set_bit")
	and target_7.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="fs_state"
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__btrfs_abort_transaction")
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("btrfs_trans_handle *")
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType() instanceof ArrayType
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2) instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vret_2657
}

predicate func_8(Parameter vextent_info_2644, LogicalAndExpr target_8) {
	target_8.getLeftOperand().(LogicalAndExpr).getLeftOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vextent_info_2644
	and target_8.getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("u64")
	and target_8.getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="drop_end"
	and target_8.getLeftOperand().(LogicalAndExpr).getRightOperand().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("btrfs_drop_extents_args")
	and target_8.getRightOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("u64")
	and target_8.getRightOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("u64")
}

from Function func, Parameter vextent_info_2644, Variable vret_2657, NotExpr target_2, EqualityOperation target_3, VariableAccess target_4, LogicalAndExpr target_6, DoStmt target_7, LogicalAndExpr target_8
where
not func_0(vextent_info_2644, vret_2657, target_7, target_8)
and func_2(vextent_info_2644, target_2)
and func_3(vret_2657, target_7, target_3)
and func_4(vextent_info_2644, target_4)
and func_6(vextent_info_2644, target_6)
and func_7(vret_2657, target_7)
and func_8(vextent_info_2644, target_8)
and vextent_info_2644.getType().hasName("btrfs_replace_extent_info *")
and vret_2657.getType().hasName("int")
and vextent_info_2644.getFunction() = func
and vret_2657.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
