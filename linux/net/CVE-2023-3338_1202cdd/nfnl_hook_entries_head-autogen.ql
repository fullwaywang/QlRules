/**
 * @name linux-1202cdd665315c525b5237e96e0bedc76d7e754f-nfnl_hook_entries_head
 * @id cpp/linux/1202cdd665315c525b5237e96e0bedc76d7e754f/nfnl-hook-entries-head
 * @description linux-1202cdd665315c525b5237e96e0bedc76d7e754f-net/netfilter/nfnetlink_hook.c-nfnl_hook_entries_head CVE-2023-3338
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
	target_0.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Variable v__UNIQUE_ID_rcu1166_197, VariableAccess target_1) {
	target_1.getTarget()=v__UNIQUE_ID_rcu1166_197
}

predicate func_2(Function func, Initializer target_2) {
	target_2.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_2.getExpr().getEnclosingFunction() = func
}

predicate func_3(Variable v__UNIQUE_ID_rcu1168_202, VariableAccess target_3) {
	target_3.getTarget()=v__UNIQUE_ID_rcu1168_202
}

predicate func_4(Function func, Initializer target_4) {
	target_4.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_4.getExpr().getEnclosingFunction() = func
}

predicate func_5(Variable v__UNIQUE_ID_rcu1170_208, VariableAccess target_5) {
	target_5.getTarget()=v__UNIQUE_ID_rcu1170_208
}

predicate func_6(Function func, Initializer target_6) {
	target_6.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_6.getExpr().getEnclosingFunction() = func
}

predicate func_7(Variable v__UNIQUE_ID_rcu1172_215, VariableAccess target_7) {
	target_7.getTarget()=v__UNIQUE_ID_rcu1172_215
}

predicate func_8(Function func, Initializer target_8) {
	target_8.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_8.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nf_hooks_ingress"
	and target_8.getExpr().getEnclosingFunction() = func
}

predicate func_9(Variable v__UNIQUE_ID_rcu1176_239, VariableAccess target_9) {
	target_9.getTarget()=v__UNIQUE_ID_rcu1176_239
}

predicate func_10(Function func, Initializer target_10) {
	target_10.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_10.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nf_hooks_egress"
	and target_10.getExpr().getEnclosingFunction() = func
}

predicate func_11(Variable v__UNIQUE_ID_rcu1178_243, VariableAccess target_11) {
	target_11.getTarget()=v__UNIQUE_ID_rcu1178_243
}

predicate func_13(Variable v__UNIQUE_ID_rcu1166_197, ExprStmt target_13) {
	target_13.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1166_197
}

predicate func_14(Variable v__UNIQUE_ID_rcu1168_202, ExprStmt target_14) {
	target_14.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1168_202
}

predicate func_15(Variable v__UNIQUE_ID_rcu1170_208, ExprStmt target_15) {
	target_15.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1170_208
}

predicate func_16(Variable v__UNIQUE_ID_rcu1172_215, ExprStmt target_16) {
	target_16.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1172_215
}

predicate func_18(Variable v__UNIQUE_ID_rcu1174_222, ExprStmt target_18) {
	target_18.getExpr().(VariableAccess).getTarget()=v__UNIQUE_ID_rcu1174_222
}

predicate func_20(Parameter vhook_186, VariableAccess target_28, IfStmt target_20) {
	target_20.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vhook_186
	and target_20.getCondition().(RelationalOperation).getLesserOperand().(AddExpr).getValue()="7"
	and target_20.getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("ERR_PTR")
	and target_20.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(UnaryMinusExpr).getValue()="-22"
	and target_20.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_28
}

predicate func_21(Variable vhook_head_188, AssignExpr target_21) {
	target_21.getLValue().(VariableAccess).getTarget()=vhook_head_188
	and target_21.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_21.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
}

predicate func_23(Function func, DoStmt target_23) {
	target_23.getCondition() instanceof Literal
	and target_23.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_23.getEnclosingFunction() = func
}

/*predicate func_24(Function func, IfStmt target_24) {
	target_24.getCondition().(NotExpr).getValue()="0"
	and target_24.getEnclosingFunction() = func
}

*/
predicate func_25(Parameter vnet_186, Parameter vhook_186, ExprStmt target_25) {
	target_25.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getTarget().getName()="hooks_decnet"
	and target_25.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="nf"
	and target_25.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_186
	and target_25.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vhook_186
}

predicate func_27(VariableAccess target_28, Function func, BreakStmt target_27) {
	target_27.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_28
	and target_27.getEnclosingFunction() = func
}

predicate func_28(Parameter vpf_186, VariableAccess target_28) {
	target_28.getTarget()=vpf_186
}

from Function func, Variable v__UNIQUE_ID_rcu1170_208, Variable v__UNIQUE_ID_rcu1172_215, Variable v__UNIQUE_ID_rcu1174_222, Variable v__UNIQUE_ID_rcu1176_239, Variable v__UNIQUE_ID_rcu1178_243, Parameter vnet_186, Variable vhook_head_188, Variable v__UNIQUE_ID_rcu1166_197, Variable v__UNIQUE_ID_rcu1168_202, Parameter vpf_186, Parameter vhook_186, Initializer target_0, VariableAccess target_1, Initializer target_2, VariableAccess target_3, Initializer target_4, VariableAccess target_5, Initializer target_6, VariableAccess target_7, Initializer target_8, VariableAccess target_9, Initializer target_10, VariableAccess target_11, ExprStmt target_13, ExprStmt target_14, ExprStmt target_15, ExprStmt target_16, ExprStmt target_18, IfStmt target_20, AssignExpr target_21, DoStmt target_23, ExprStmt target_25, BreakStmt target_27, VariableAccess target_28
where
func_0(func, target_0)
and func_1(v__UNIQUE_ID_rcu1166_197, target_1)
and func_2(func, target_2)
and func_3(v__UNIQUE_ID_rcu1168_202, target_3)
and func_4(func, target_4)
and func_5(v__UNIQUE_ID_rcu1170_208, target_5)
and func_6(func, target_6)
and func_7(v__UNIQUE_ID_rcu1172_215, target_7)
and func_8(func, target_8)
and func_9(v__UNIQUE_ID_rcu1176_239, target_9)
and func_10(func, target_10)
and func_11(v__UNIQUE_ID_rcu1178_243, target_11)
and func_13(v__UNIQUE_ID_rcu1166_197, target_13)
and func_14(v__UNIQUE_ID_rcu1168_202, target_14)
and func_15(v__UNIQUE_ID_rcu1170_208, target_15)
and func_16(v__UNIQUE_ID_rcu1172_215, target_16)
and func_18(v__UNIQUE_ID_rcu1174_222, target_18)
and func_20(vhook_186, target_28, target_20)
and func_21(vhook_head_188, target_21)
and func_23(func, target_23)
and func_25(vnet_186, vhook_186, target_25)
and func_27(target_28, func, target_27)
and func_28(vpf_186, target_28)
and v__UNIQUE_ID_rcu1170_208.getType().hasName("nf_hook_entries *")
and v__UNIQUE_ID_rcu1172_215.getType().hasName("nf_hook_entries *")
and v__UNIQUE_ID_rcu1174_222.getType().hasName("nf_hook_entries *")
and v__UNIQUE_ID_rcu1176_239.getType().hasName("nf_hook_entries *")
and v__UNIQUE_ID_rcu1178_243.getType().hasName("nf_hook_entries *")
and vnet_186.getType().hasName("net *")
and vhook_head_188.getType().hasName("const nf_hook_entries *")
and v__UNIQUE_ID_rcu1166_197.getType().hasName("nf_hook_entries *")
and v__UNIQUE_ID_rcu1168_202.getType().hasName("nf_hook_entries *")
and vpf_186.getType().hasName("u8")
and vhook_186.getType().hasName("unsigned int")
and v__UNIQUE_ID_rcu1170_208.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1172_215.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1174_222.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1176_239.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1178_243.(LocalVariable).getFunction() = func
and vnet_186.getFunction() = func
and vhook_head_188.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1166_197.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_rcu1168_202.(LocalVariable).getFunction() = func
and vpf_186.getFunction() = func
and vhook_186.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
