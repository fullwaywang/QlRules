/**
 * @name linux-fc739a058d99c9297ef6bfd923b809d85855b9a9-fastrpc_dma_buf_attach
 * @id cpp/linux/fc739a058d99c9297ef6bfd923b809d85855b9a9/fastrpc-dma-buf-attach
 * @description linux-fc739a058d99c9297ef6bfd923b809d85855b9a9-drivers/misc/fastrpc.c-fastrpc_dma_buf_attach CVE-2019-19069
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable va_518, RelationalOperation target_1, AddressOfExpr target_2, ExprStmt target_3) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(FunctionCall).getTarget().hasName("kfree")
		and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=va_518
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Function func, RelationalOperation target_1) {
		 (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
		and target_1.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_1.getGreaterOperand().(Literal).getValue()="0"
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable va_518, AddressOfExpr target_2) {
		target_2.getOperand().(PointerFieldAccess).getTarget().getName()="sgt"
		and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_518
}

predicate func_3(Variable va_518, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="dev"
		and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=va_518
		and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="dev"
		and target_3.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("dma_buf_attachment *")
}

from Function func, Variable va_518, RelationalOperation target_1, AddressOfExpr target_2, ExprStmt target_3
where
not func_0(va_518, target_1, target_2, target_3)
and func_1(func, target_1)
and func_2(va_518, target_2)
and func_3(va_518, target_3)
and va_518.getType().hasName("fastrpc_dma_buf_attachment *")
and va_518.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
