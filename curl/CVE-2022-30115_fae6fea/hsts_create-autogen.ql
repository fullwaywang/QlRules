/**
 * @name curl-fae6fea209a2d4d-hsts_create
 * @id cpp/curl/fae6fea209a2d4d/hsts-create
 * @description curl-fae6fea209a2d4d-lib/hsts.c-hsts_create CVE-2022-30115
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("char *")
		and target_0.getRValue() instanceof VariableCall
		and target_0.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("strlen")
		and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("char *")
		and (func.getEntryPoint().(BlockStmt).getStmt(6)=target_2 or func.getEntryPoint().(BlockStmt).getStmt(6).getFollowingStmt()=target_2))
}

predicate func_3(Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayBase().(VariableAccess).getType().hasName("char *")
		and target_3.getCondition().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(VariableAccess).getType().hasName("size_t")
		and target_3.getCondition().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_3.getCondition().(EqualityOperation).getAnOperand().(CharLiteral).getValue()="46"
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getType().hasName("char *")
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(PrefixDecrExpr).getOperand().(VariableAccess).getType().hasName("size_t")
		and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and (func.getEntryPoint().(BlockStmt).getStmt(7)=target_3 or func.getEntryPoint().(BlockStmt).getStmt(7).getFollowingStmt()=target_3))
}

predicate func_4(Variable vsts_116, ExprStmt target_8, NotExpr target_9, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="host"
		and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsts_116
		and target_4.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("char *")
		and (func.getEntryPoint().(BlockStmt).getStmt(8)=target_4 or func.getEntryPoint().(BlockStmt).getStmt(8).getFollowingStmt()=target_4)
		and target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vhostname_112, Variable vCurl_cstrdup, VariableCall target_6) {
		target_6.getExpr().(VariableAccess).getTarget()=vCurl_cstrdup
		and target_6.getArgument(0).(VariableAccess).getTarget()=vhostname_112
}

predicate func_7(Variable vsts_116, PointerFieldAccess target_7) {
		target_7.getTarget().getName()="host"
		and target_7.getQualifier().(VariableAccess).getTarget()=vsts_116
}

predicate func_8(Variable vsts_116, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="includeSubDomains"
		and target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsts_116
		and target_8.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("bool")
}

predicate func_9(Variable vsts_116, NotExpr target_9) {
		target_9.getOperand().(PointerFieldAccess).getTarget().getName()="host"
		and target_9.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsts_116
}

from Function func, Parameter vhostname_112, Variable vsts_116, Variable vCurl_cstrdup, VariableCall target_6, PointerFieldAccess target_7, ExprStmt target_8, NotExpr target_9
where
not func_0(func)
and not func_2(func)
and not func_3(func)
and not func_4(vsts_116, target_8, target_9, func)
and func_6(vhostname_112, vCurl_cstrdup, target_6)
and func_7(vsts_116, target_7)
and func_8(vsts_116, target_8)
and func_9(vsts_116, target_9)
and vhostname_112.getType().hasName("const char *")
and vsts_116.getType().hasName("stsentry *")
and vCurl_cstrdup.getType().hasName("curl_strdup_callback")
and vhostname_112.getFunction() = func
and vsts_116.(LocalVariable).getFunction() = func
and not vCurl_cstrdup.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
