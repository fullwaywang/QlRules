/**
 * @name linux-b9a532277938798b53178d5a66af6e2915cb27cf-newque
 * @id cpp/linux/b9a532277938798b53178d5a66af6e2915cb27cf/newque
 * @description linux-b9a532277938798b53178d5a66af6e2915cb27cf-ipc/msg.c-newque CVE-2015-7613
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmsq_121, Variable vid_122, Parameter vns_119, ExprStmt target_2, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vid_122
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ipc_addid")
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="ids"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vns_119
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="1"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="q_perm"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsq_121
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="msg_ctlmni"
	and target_0.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vns_119
	and target_0.getLocation().isBefore(target_2.getLocation())
}

predicate func_1(Variable vmsq_121, Variable vid_122, ExprStmt target_2, IfStmt target_1) {
	target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vid_122
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ipc_rcu_putref")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmsq_121
	and target_1.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(VariableAccess).getTarget()=vid_122
	and target_1.getLocation().isBefore(target_2.getLocation())
}

predicate func_2(Variable vmsq_121, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="q_stime"
	and target_2.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsq_121
	and target_2.getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="q_rtime"
	and target_2.getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsq_121
	and target_2.getExpr().(AssignExpr).getRValue().(AssignExpr).getRValue().(Literal).getValue()="0"
}

from Function func, Variable vmsq_121, Variable vid_122, Parameter vns_119, ExprStmt target_0, IfStmt target_1, ExprStmt target_2
where
func_0(vmsq_121, vid_122, vns_119, target_2, target_0)
and func_1(vmsq_121, vid_122, target_2, target_1)
and func_2(vmsq_121, target_2)
and vmsq_121.getType().hasName("msg_queue *")
and vid_122.getType().hasName("int")
and vns_119.getType().hasName("ipc_namespace *")
and vmsq_121.(LocalVariable).getFunction() = func
and vid_122.(LocalVariable).getFunction() = func
and vns_119.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
