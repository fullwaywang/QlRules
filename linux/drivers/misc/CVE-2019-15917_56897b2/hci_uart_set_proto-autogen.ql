/**
 * @name linux-56897b217a1d0a91c9920cb418d6b3fe922f590a-hci_uart_set_proto
 * @id cpp/linux/56897b217a1d0a91c9920cb418d6b3fe922f590a/hci-uart-set-proto
 * @description linux-56897b217a1d0a91c9920cb418d6b3fe922f590a-drivers/bluetooth/hci_ldisc.c-hci_uart_set_proto CVE-2019-15917
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhu_689, VariableAccess target_1, ExprStmt target_0) {
		target_0.getExpr().(FunctionCall).getTarget().hasName("clear_bit")
		and target_0.getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="2"
		and target_0.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="flags"
		and target_0.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhu_689
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
}

predicate func_1(Variable verr_692, BlockStmt target_2, VariableAccess target_1) {
		target_1.getTarget()=verr_692
		and target_1.getParent().(IfStmt).getThen()=target_2
}

predicate func_2(Variable verr_692, BlockStmt target_2) {
		target_2.getStmt(0) instanceof ExprStmt
		and target_2.getStmt(1).(ReturnStmt).getExpr().(VariableAccess).getTarget()=verr_692
}

from Function func, Parameter vhu_689, Variable verr_692, ExprStmt target_0, VariableAccess target_1, BlockStmt target_2
where
func_0(vhu_689, target_1, target_0)
and func_1(verr_692, target_2, target_1)
and func_2(verr_692, target_2)
and vhu_689.getType().hasName("hci_uart *")
and verr_692.getType().hasName("int")
and vhu_689.getFunction() = func
and verr_692.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
