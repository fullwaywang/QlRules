/**
 * @name linux-b9cb9c45583b911e0db71d09caa6b56469eb2bdf-vc_ioio_exitinfo
 * @id cpp/linux/b9cb9c45583b911e0db71d09caa6b56469eb2bdf/vc-ioio-exitinfo
 * @description linux-b9cb9c45583b911e0db71d09caa6b56469eb2bdf-vc_ioio_exitinfo CVE-2023-46813
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
		target_0.getValue()="16"
		and not target_0.getValue()="1"
		and target_0.getParent().(LShiftExpr).getParent().(AssignOrExpr).getRValue() instanceof BinaryBitwiseOperation
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="16"
		and not target_1.getValue()="2"
		and target_1.getParent().(LShiftExpr).getParent().(AssignOrExpr).getRValue() instanceof BinaryBitwiseOperation
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
		target_2.getValue()="16"
		and not target_2.getValue()="2"
		and target_2.getParent().(LShiftExpr).getParent().(AssignOrExpr).getRValue() instanceof BinaryBitwiseOperation
		and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, Literal target_3) {
		target_3.getValue()="16"
		and not target_3.getValue()="4"
		and target_3.getParent().(LShiftExpr).getParent().(AssignOrExpr).getRValue() instanceof BinaryBitwiseOperation
		and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func) {
	exists(AssignExpr target_4 |
		target_4.getLValue().(VariableAccess).getType().hasName("u64")
		and target_4.getRValue() instanceof BitwiseAndExpr
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Function func) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(VariableAccess).getType().hasName("u64")
		and target_5.getRValue() instanceof BitwiseAndExpr
		and target_5.getEnclosingFunction() = func)
}

predicate func_6(Function func) {
	exists(AssignExpr target_6 |
		target_6.getLValue().(VariableAccess).getType().hasName("u64")
		and target_6.getRValue().(BitwiseAndExpr).getLeftOperand() instanceof ValueFieldAccess
		and target_6.getRValue().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="65535"
		and target_6.getEnclosingFunction() = func)
}

predicate func_7(Function func) {
	exists(AssignExpr target_7 |
		target_7.getLValue().(VariableAccess).getType().hasName("u64")
		and target_7.getRValue().(BitwiseAndExpr).getLeftOperand() instanceof ValueFieldAccess
		and target_7.getRValue().(BitwiseAndExpr).getRightOperand().(HexLiteral).getValue()="65535"
		and target_7.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
	exists(AssignExpr target_8 |
		target_8.getLValue().(VariableAccess).getType().hasName("u64")
		and target_8.getRValue() instanceof BitwiseAndExpr
		and target_8.getEnclosingFunction() = func)
}

predicate func_9(Function func) {
	exists(AssignExpr target_9 |
		target_9.getLValue().(VariableAccess).getType().hasName("u64")
		and target_9.getRValue() instanceof BitwiseAndExpr
		and target_9.getEnclosingFunction() = func)
}

predicate func_10(Function func) {
	exists(ExprStmt target_10 |
		target_10.getExpr().(AssignOrExpr).getLValue() instanceof PointerDereferenceExpr
		and target_10.getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getLeftOperand().(VariableAccess).getType().hasName("u64")
		and target_10.getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10)
}

/*predicate func_11(Function func) {
	exists(BinaryBitwiseOperation target_11 |
		target_11.getLeftOperand().(VariableAccess).getType().hasName("u64")
		and target_11.getRightOperand() instanceof Literal
		and target_11.getEnclosingFunction() = func)
}

*/
predicate func_12(ArrayExpr target_35, Function func) {
	exists(ExprStmt target_12 |
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_12.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_35
		and target_12.getEnclosingFunction() = func)
}

predicate func_13(Variable vinsn_658, ArrayExpr target_35, ExprStmt target_36, SwitchStmt target_37) {
	exists(ExprStmt target_13 |
		target_13.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="opnd_bytes"
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="2"
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(Literal).getValue()="2"
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(Literal).getValue()="4"
		and target_13.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_35
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_13.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_37.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_14(Parameter vctxt_656) {
	exists(FunctionCall target_14 |
		target_14.getTarget().hasName("vc_ioio_check")
		and target_14.getArgument(0).(VariableAccess).getTarget()=vctxt_656
		and target_14.getArgument(1).(VariableAccess).getType().hasName("u64")
		and target_14.getArgument(2).(VariableAccess).getType().hasName("size_t"))
}

predicate func_15(Parameter vexitinfo_656, PointerDereferenceExpr target_15) {
		target_15.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_16(Parameter vexitinfo_656, PointerDereferenceExpr target_16) {
		target_16.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_17(Parameter vexitinfo_656, PointerDereferenceExpr target_17) {
		target_17.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_18(Parameter vexitinfo_656, PointerDereferenceExpr target_18) {
		target_18.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_19(Parameter vexitinfo_656, PointerDereferenceExpr target_19) {
		target_19.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_20(Parameter vexitinfo_656, PointerDereferenceExpr target_20) {
		target_20.getOperand().(VariableAccess).getTarget()=vexitinfo_656
}

predicate func_21(Parameter vctxt_656, BitwiseAndExpr target_21) {
		target_21.getLeftOperand().(PointerFieldAccess).getTarget().getName()="dx"
		and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="regs"
		and target_21.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_656
		and target_21.getRightOperand().(HexLiteral).getValue()="65535"
}

predicate func_22(Parameter vctxt_656, BitwiseAndExpr target_22) {
		target_22.getLeftOperand().(PointerFieldAccess).getTarget().getName()="dx"
		and target_22.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="regs"
		and target_22.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_656
		and target_22.getRightOperand().(HexLiteral).getValue()="65535"
}

predicate func_23(Variable vinsn_658, ValueFieldAccess target_23) {
		target_23.getTarget().getName()="value"
		and target_23.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_23.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="immediate"
		and target_23.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_23.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
}

predicate func_24(Variable vinsn_658, ValueFieldAccess target_24) {
		target_24.getTarget().getName()="value"
		and target_24.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_24.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="immediate"
		and target_24.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_24.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
}

predicate func_25(Parameter vctxt_656, BitwiseAndExpr target_25) {
		target_25.getLeftOperand().(PointerFieldAccess).getTarget().getName()="dx"
		and target_25.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="regs"
		and target_25.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_656
		and target_25.getRightOperand().(HexLiteral).getValue()="65535"
}

predicate func_26(Parameter vctxt_656, BitwiseAndExpr target_26) {
		target_26.getLeftOperand().(PointerFieldAccess).getTarget().getName()="dx"
		and target_26.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="regs"
		and target_26.getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_656
		and target_26.getRightOperand().(HexLiteral).getValue()="65535"
}

predicate func_28(Function func, BinaryBitwiseOperation target_28) {
		target_28.getLeftOperand() instanceof BitwiseAndExpr
		and target_28.getRightOperand() instanceof Literal
		and target_28.getEnclosingFunction() = func
}

predicate func_29(Function func, AssignOrExpr target_29) {
		target_29.getLValue() instanceof PointerDereferenceExpr
		and target_29.getRValue().(BinaryBitwiseOperation).getLeftOperand() instanceof BitwiseAndExpr
		and target_29.getRValue().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
		and target_29.getEnclosingFunction() = func
}

predicate func_30(Function func, AssignOrExpr target_30) {
		target_30.getLValue() instanceof PointerDereferenceExpr
		and target_30.getRValue().(BinaryBitwiseOperation).getLeftOperand() instanceof ValueFieldAccess
		and target_30.getRValue().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
		and target_30.getEnclosingFunction() = func
}

predicate func_31(Function func, AssignOrExpr target_31) {
		target_31.getLValue() instanceof PointerDereferenceExpr
		and target_31.getRValue().(BinaryBitwiseOperation).getLeftOperand() instanceof ValueFieldAccess
		and target_31.getRValue().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
		and target_31.getEnclosingFunction() = func
}

predicate func_32(Function func, AssignOrExpr target_32) {
		target_32.getLValue() instanceof PointerDereferenceExpr
		and target_32.getRValue().(BinaryBitwiseOperation).getLeftOperand() instanceof BitwiseAndExpr
		and target_32.getRValue().(BinaryBitwiseOperation).getRightOperand() instanceof Literal
		and target_32.getEnclosingFunction() = func
}

predicate func_33(Function func, AssignOrExpr target_33) {
		target_33.getLValue() instanceof PointerDereferenceExpr
		and target_33.getRValue().(BinaryBitwiseOperation).getLeftOperand() instanceof BitwiseAndExpr
		and target_33.getRValue().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="16"
		and target_33.getEnclosingFunction() = func
}

predicate func_35(Variable vinsn_658, ArrayExpr target_35) {
		target_35.getArrayBase().(ValueFieldAccess).getTarget().getName()="bytes"
		and target_35.getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
		and target_35.getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="opcode"
		and target_35.getArrayBase().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
		and target_35.getArrayOffset().(Literal).getValue()="0"
}

predicate func_36(Parameter vexitinfo_656, Variable vinsn_658, ExprStmt target_36) {
		target_36.getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vexitinfo_656
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="opnd_bytes"
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="2"
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getThen().(BinaryBitwiseOperation).getValue()="32"
		and target_36.getExpr().(AssignOrExpr).getRValue().(ConditionalExpr).getElse().(BinaryBitwiseOperation).getValue()="64"
}

predicate func_37(Parameter vexitinfo_656, Variable vinsn_658, SwitchStmt target_37) {
		target_37.getExpr().(PointerFieldAccess).getTarget().getName()="addr_bytes"
		and target_37.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vinsn_658
		and target_37.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="2"
		and target_37.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vexitinfo_656
		and target_37.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="128"
		and target_37.getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="4"
		and target_37.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vexitinfo_656
		and target_37.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignOrExpr).getRValue().(BinaryBitwiseOperation).getValue()="256"
}

from Function func, Parameter vctxt_656, Parameter vexitinfo_656, Variable vinsn_658, Literal target_0, Literal target_1, Literal target_2, Literal target_3, PointerDereferenceExpr target_15, PointerDereferenceExpr target_16, PointerDereferenceExpr target_17, PointerDereferenceExpr target_18, PointerDereferenceExpr target_19, PointerDereferenceExpr target_20, BitwiseAndExpr target_21, BitwiseAndExpr target_22, ValueFieldAccess target_23, ValueFieldAccess target_24, BitwiseAndExpr target_25, BitwiseAndExpr target_26, BinaryBitwiseOperation target_28, AssignOrExpr target_29, AssignOrExpr target_30, AssignOrExpr target_31, AssignOrExpr target_32, AssignOrExpr target_33, ArrayExpr target_35, ExprStmt target_36, SwitchStmt target_37
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and not func_4(func)
and not func_5(func)
and not func_6(func)
and not func_7(func)
and not func_8(func)
and not func_9(func)
and not func_10(func)
and not func_12(target_35, func)
and not func_13(vinsn_658, target_35, target_36, target_37)
and not func_14(vctxt_656)
and func_15(vexitinfo_656, target_15)
and func_16(vexitinfo_656, target_16)
and func_17(vexitinfo_656, target_17)
and func_18(vexitinfo_656, target_18)
and func_19(vexitinfo_656, target_19)
and func_20(vexitinfo_656, target_20)
and func_21(vctxt_656, target_21)
and func_22(vctxt_656, target_22)
and func_23(vinsn_658, target_23)
and func_24(vinsn_658, target_24)
and func_25(vctxt_656, target_25)
and func_26(vctxt_656, target_26)
and func_28(func, target_28)
and func_29(func, target_29)
and func_30(func, target_30)
and func_31(func, target_31)
and func_32(func, target_32)
and func_33(func, target_33)
and func_35(vinsn_658, target_35)
and func_36(vexitinfo_656, vinsn_658, target_36)
and func_37(vexitinfo_656, vinsn_658, target_37)
and vctxt_656.getType().hasName("es_em_ctxt *")
and vexitinfo_656.getType().hasName("u64 *")
and vinsn_658.getType().hasName("insn *")
and vctxt_656.getFunction() = func
and vexitinfo_656.getFunction() = func
and vinsn_658.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
