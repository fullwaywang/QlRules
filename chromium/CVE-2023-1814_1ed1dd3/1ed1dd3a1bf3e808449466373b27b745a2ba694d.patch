commit 1ed1dd3a1bf3e808449466373b27b745a2ba694d	1ed1dd3a1bf3e808449466373b27b745a2ba694d
Author: Daniel Rubery <drubery@chromium.org>
Date:   Tue Mar 7 02:04:15 2023 +0000

    Limit ability for downloads to generate large ClientDownloadRequests
    
    This can leads to timeouts in the network stack or the server rejecting
    the request.
    
    Bug: 1417325
    Change-Id: Ia159e9ba9235ff30ff29be2aa142c670336f5f5d
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4311341
    Commit-Queue: Daniel Rubery <drubery@chromium.org>
    Reviewed-by: Xinghui Lu <xinghuilu@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1113729}

diff --git a/chrome/browser/safe_browsing/download_protection/ppapi_download_request.cc b/chrome/browser/safe_browsing/download_protection/ppapi_download_request.cc
index 882503d295988..ce8b7245c176b 100644
--- a/chrome/browser/safe_browsing/download_protection/ppapi_download_request.cc
+++ b/chrome/browser/safe_browsing/download_protection/ppapi_download_request.cc
@@ -193,8 +193,8 @@ void PPAPIDownloadRequest::SendRequest() {
   request.set_download_type(ClientDownloadRequest::PPAPI_SAVE_REQUEST);
   ClientDownloadRequest::Resource* resource = request.add_resources();
   resource->set_type(ClientDownloadRequest::PPAPI_DOCUMENT);
-  resource->set_url(requestor_url_.spec());
-  request.set_url(requestor_url_.spec());
+  resource->set_url(ShortURLForReporting(requestor_url_));
+  request.set_url(ShortURLForReporting(requestor_url_));
   request.set_file_basename(supported_path_.BaseName().AsUTF8Unsafe());
   request.set_length(0);
   request.mutable_digests()->set_md5(std::string());
diff --git a/chrome/common/safe_browsing/binary_feature_extractor_win.cc b/chrome/common/safe_browsing/binary_feature_extractor_win.cc
index 104e4243f0f13..d44127e5f9fd3 100644
--- a/chrome/common/safe_browsing/binary_feature_extractor_win.cc
+++ b/chrome/common/safe_browsing/binary_feature_extractor_win.cc
@@ -12,6 +12,7 @@
 
 #include "base/files/file_path.h"
 #include "base/logging.h"
+#include "base/metrics/histogram_functions.h"
 #include "base/threading/scoped_thread_priority.h"
 #include "base/win/pe_image_reader.h"
 #include "components/safe_browsing/core/common/proto/csd.pb.h"
@@ -20,6 +21,9 @@ namespace safe_browsing {
 
 namespace {
 
+// Conservatively set at 1 MB.
+constexpr size_t kMaxDebugDataBytes = 1 * 1024 * 1024;
+
 // An EnumCertificatesCallback that collects each SignedData blob.
 bool OnCertificateEntry(uint16_t revision,
                         uint16_t certificate_type,
@@ -162,8 +166,12 @@ bool BinaryFeatureExtractor::ExtractImageFeaturesFromData(
           pe_headers->add_debug_data();
       debug_data->set_directory_entry(directory_entry,
                                       sizeof(*directory_entry));
-      if (raw_data)
+      if (raw_data) {
+        base::UmaHistogramMemoryKB("SBClientDownload.ImageDebugEntrySize",
+                                   raw_data_size / 1024);
+        raw_data_size = std::min(raw_data_size, kMaxDebugDataBytes);
         debug_data->set_raw_data(raw_data, raw_data_size);
+      }
     }
   }
 
diff --git a/tools/metrics/histograms/metadata/sb_client/histograms.xml b/tools/metrics/histograms/metadata/sb_client/histograms.xml
index 0ab479dd84fd1..3e79e9d19260a 100644
--- a/tools/metrics/histograms/metadata/sb_client/histograms.xml
+++ b/tools/metrics/histograms/metadata/sb_client/histograms.xml
@@ -347,6 +347,16 @@ chromium-metrics-reviews@google.com.
   </summary>
 </histogram>
 
+<histogram name="SBClientDownload.ImageDebugEntrySize" units="KB"
+    expires_after="2023-09-06">
+  <owner>drubery@chromium.org</owner>
+  <owner>chrome-counter-abuse-alerts@google.com</owner>
+  <summary>
+    Records the size of the image debug entry that is extracted from a
+    downloaded executable. This is recorded on executable downloads on Windows.
+  </summary>
+</histogram>
+
 <histogram name="SBClientDownload.MalwareDeepScanResult.{trigger}"
     enum="SBClientDownloadCheckResult" expires_after="2023-04-28">
   <owner>drubery@chromium.org</owner>
