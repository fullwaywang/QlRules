/**
 * @name linux-886e44c9298a6b428ae046e2fa092ca52e822e6a-netvsc_get_ethtool_stats
 * @id cpp/linux/886e44c9298a6b428ae046e2fa092ca52e822e6a/netvsc-get-ethtool-stats
 * @description linux-886e44c9298a6b428ae046e2fa092ca52e822e6a-netvsc_get_ethtool_stats CVE-2022-3107
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpcpu_sum_1548, ExprStmt target_1, ExprStmt target_2, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vpcpu_sum_1548
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getCondition().(NotExpr).getOperand().(VariableAccess).getLocation())
		and target_0.getCondition().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_1(Variable vpcpu_sum_1548, ExprStmt target_1) {
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpcpu_sum_1548
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kvmalloc_array")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("cpumask_weight")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("cpumask")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(SizeofTypeOperator).getType() instanceof LongType
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(SizeofTypeOperator).getValue()="64"
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(BitwiseOrExpr).getValue()="3264"
}

predicate func_2(Variable vpcpu_sum_1548, ExprStmt target_2) {
		target_2.getExpr().(FunctionCall).getTarget().hasName("netvsc_get_pcpu_stats")
		and target_2.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net_device *")
		and target_2.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpcpu_sum_1548
}

from Function func, Variable vpcpu_sum_1548, ExprStmt target_1, ExprStmt target_2
where
not func_0(vpcpu_sum_1548, target_1, target_2, func)
and func_1(vpcpu_sum_1548, target_1)
and func_2(vpcpu_sum_1548, target_2)
and vpcpu_sum_1548.getType().hasName("netvsc_ethtool_pcpu_stats *")
and vpcpu_sum_1548.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
