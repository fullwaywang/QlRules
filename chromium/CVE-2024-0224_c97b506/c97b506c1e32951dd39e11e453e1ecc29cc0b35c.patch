commit c97b506c1e32951dd39e11e453e1ecc29cc0b35c	c97b506c1e32951dd39e11e453e1ecc29cc0b35c
Author: Hongchan Choi <hongchan@chromium.org>
Date:   Fri Dec 8 15:34:25 2023 +0000

    Clamp the input value correctly before scheduling an AudioParam event
    
    When the AudioParam value is set via the setter, it internally calls
    the setValueAtTime() function to schedule the change. However, the
    current code does not correctly clamp the value within the nominal
    range. This CL fixes the problem.
    
    Bug: 1505086
    Test: Locally confirmed with both negative and positive param values.
    Change-Id: Ibb0aae168161af9ea95c5e11a929b3aa2c621c73
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5100625
    Reviewed-by: Michael Wilson <mjwilson@chromium.org>
    Commit-Queue: Hongchan Choi <hongchan@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1235028}

diff --git a/third_party/blink/renderer/modules/webaudio/audio_param.cc b/third_party/blink/renderer/modules/webaudio/audio_param.cc
index 04ba0f78bcd21..9b0241a07f523 100644
--- a/third_party/blink/renderer/modules/webaudio/audio_param.cc
+++ b/third_party/blink/renderer/modules/webaudio/audio_param.cc
@@ -114,12 +114,15 @@ void AudioParam::setValue(float value) {
 void AudioParam::setValue(float value, ExceptionState& exception_state) {
   WarnIfOutsideRange("value", value);
 
-  // This is to signal any errors, if necessary, about conflicting
-  // automations.
-  setValueAtTime(value, Context()->currentTime(), exception_state);
-  // This is to change the value so that an immediate query for the
-  // value returns the expected values.
+  // Change the intrinsic value so that an immediate query for the value
+  // returns the value that the user code provided. It also clamps the value
+  // to the nominal range.
   Handler().SetValue(value);
+
+  // Use the intrinsic value (after clamping) to schedule the actual
+  // automation event.
+  setValueAtTime(Handler().IntrinsicValue(), Context()->currentTime(),
+                 exception_state);
 }
 
 float AudioParam::defaultValue() const {
diff --git a/third_party/blink/web_tests/webaudio/AudioParam/worklet-warnings-expected.txt b/third_party/blink/web_tests/webaudio/AudioParam/worklet-warnings-expected.txt
index 81e4990275573..ac273714670c5 100644
--- a/third_party/blink/web_tests/webaudio/AudioParam/worklet-warnings-expected.txt
+++ b/third_party/blink/web_tests/webaudio/AudioParam/worklet-warnings-expected.txt
@@ -1,5 +1,4 @@
 CONSOLE WARNING: AudioWorkletNode("noise-generator").amplitude.value 99 outside nominal range [0, 1]; value will be clamped.
-CONSOLE WARNING: AudioWorkletNode("noise-generator").amplitude.setValueAtTime value 99 outside nominal range [0, 1]; value will be clamped.
 CONSOLE WARNING: AudioWorkletNode("noise-generator").amplitude.setValueAtTime value -1 outside nominal range [0, 1]; value will be clamped.
 CONSOLE WARNING: AudioWorkletNode("noise-generator").amplitude.linearRampToValueAtTime value 5 outside nominal range [0, 1]; value will be clamped.
 This is a testharness.js-based test.
