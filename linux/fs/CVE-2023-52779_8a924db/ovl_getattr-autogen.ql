/**
 * @name linux-8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf-ovl_getattr
 * @id cpp/linux/8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf/ovl-getattr
 * @description linux-8a924db2d7b5eb69ba08b1a0af46e9f1359a9bdf-fs/overlayfs/inode.c-ovl_getattr CVE-2023-52779
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vstat_158, Parameter vrequest_mask_158, Parameter vflags_158, Variable vrealpath_162, FunctionCall target_0) {
	target_0.getTarget().hasName("vfs_getattr")
	and not target_0.getTarget().hasName("ovl_do_getattr")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrealpath_162
	and target_0.getArgument(1).(VariableAccess).getTarget()=vstat_158
	and target_0.getArgument(2).(VariableAccess).getTarget()=vrequest_mask_158
	and target_0.getArgument(3).(VariableAccess).getTarget()=vflags_158
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_1(Variable vlowerstat_194, Variable vlowermask_195, Parameter vflags_158, Variable vrealpath_162, FunctionCall target_1) {
	target_1.getTarget().hasName("vfs_getattr")
	and not target_1.getTarget().hasName("ovl_do_getattr")
	and target_1.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrealpath_162
	and target_1.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlowerstat_194
	and target_1.getArgument(2).(VariableAccess).getTarget()=vlowermask_195
	and target_1.getArgument(3).(VariableAccess).getTarget()=vflags_158
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_2(Variable vlowerdatastat_247, Variable vlowermask_248, Parameter vflags_158, Variable vrealpath_162, FunctionCall target_2) {
	target_2.getTarget().hasName("vfs_getattr")
	and not target_2.getTarget().hasName("ovl_do_getattr")
	and target_2.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vrealpath_162
	and target_2.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vlowerdatastat_247
	and target_2.getArgument(2).(VariableAccess).getTarget()=vlowermask_248
	and target_2.getArgument(3).(VariableAccess).getTarget()=vflags_158
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
}

from Function func, Variable vlowerstat_194, Variable vlowermask_195, Variable vlowerdatastat_247, Variable vlowermask_248, Parameter vstat_158, Parameter vrequest_mask_158, Parameter vflags_158, Variable vrealpath_162, FunctionCall target_0, FunctionCall target_1, FunctionCall target_2
where
func_0(vstat_158, vrequest_mask_158, vflags_158, vrealpath_162, target_0)
and func_1(vlowerstat_194, vlowermask_195, vflags_158, vrealpath_162, target_1)
and func_2(vlowerdatastat_247, vlowermask_248, vflags_158, vrealpath_162, target_2)
and vlowerstat_194.getType().hasName("kstat")
and vlowermask_195.getType().hasName("u32")
and vlowerdatastat_247.getType().hasName("kstat")
and vlowermask_248.getType().hasName("u32")
and vstat_158.getType().hasName("kstat *")
and vrequest_mask_158.getType().hasName("u32")
and vflags_158.getType().hasName("unsigned int")
and vrealpath_162.getType().hasName("path")
and vlowerstat_194.(LocalVariable).getFunction() = func
and vlowermask_195.(LocalVariable).getFunction() = func
and vlowerdatastat_247.(LocalVariable).getFunction() = func
and vlowermask_248.(LocalVariable).getFunction() = func
and vstat_158.getFunction() = func
and vrequest_mask_158.getFunction() = func
and vflags_158.getFunction() = func
and vrealpath_162.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
