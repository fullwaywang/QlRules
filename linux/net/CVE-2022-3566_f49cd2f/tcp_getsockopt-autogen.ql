/**
 * @name linux-f49cd2f4d6170d27a2c61f1fecb03d8a70c91f57-tcp_getsockopt
 * @id cpp/linux/f49cd2f4d6170d27a2c61f1fecb03d8a70c91f57/tcp-getsockopt
 * @description linux-f49cd2f4d6170d27a2c61f1fecb03d8a70c91f57-net/ipv4/tcp.c-tcp_getsockopt CVE-2022-3566
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vicsk_4396, PointerFieldAccess target_3) {
exists(StmtExpr target_0 |
	target_0.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="icsk_af_ops"
	and target_0.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vicsk_4396
	and target_0.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vicsk_4396, VariableAccess target_1) {
	target_1.getTarget()=vicsk_4396
}

predicate func_2(Variable vicsk_4396, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="icsk_af_ops"
	and target_2.getQualifier().(VariableAccess).getTarget()=vicsk_4396
}

predicate func_3(Variable vicsk_4396, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="getsockopt"
	and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="icsk_af_ops"
	and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vicsk_4396
}

from Function func, Variable vicsk_4396, VariableAccess target_1, PointerFieldAccess target_2, PointerFieldAccess target_3
where
not func_0(vicsk_4396, target_3)
and func_1(vicsk_4396, target_1)
and func_2(vicsk_4396, target_2)
and func_3(vicsk_4396, target_3)
and vicsk_4396.getType().hasName("inet_connection_sock *")
and vicsk_4396.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
