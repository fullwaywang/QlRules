/**
 * @name linux-a85fb91e3d728bdfc80833167e8162cce8bc7004-hci_conn_del_sysfs
 * @id cpp/linux/a85fb91e3d728bdfc80833167e8162cce8bc7004/hci-conn-del-sysfs
 * @description linux-a85fb91e3d728bdfc80833167e8162cce8bc7004-net/bluetooth/hci_sysfs.c-hci_conn_del_sysfs CVE-2023-52830
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vconn_66, FunctionCall target_0) {
	target_0.getTarget().hasName("device_del")
	and not target_0.getTarget().hasName("put_device")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
}

predicate func_1(Variable vhdev_68, FunctionCall target_1) {
	target_1.getTarget().hasName("hci_dev_put")
	and not target_1.getTarget().hasName("__compiletime_assert")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vhdev_68
}

predicate func_2(Parameter vconn_66, Variable vhdev_68, IfStmt target_10, AddressOfExpr target_11, Function func) {
exists(DoStmt target_2 |
	target_2.getCondition() instanceof Literal
	and target_2.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_2.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("_ddebug")
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="%s: conn %p\n"
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getCondition().(VariableAccess).getTarget()=vhdev_68
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="name"
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ConditionalExpr).getElse().(StringLiteral).getValue()="null"
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vconn_66
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_10.getLocation())
	and target_2.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_3(Function func) {
exists(NotExpr target_3 |
	target_3.getValue()="0"
	and target_3.getParent().(IfStmt).getThen() instanceof ReturnStmt
	and target_3.getEnclosingFunction() = func)
}

*/
/*predicate func_4(NotExpr target_7, Function func) {
exists(ExprStmt target_4 |
	target_4.getParent().(IfStmt).getCondition()=target_7
	and target_4.getEnclosingFunction() = func)
}

*/
predicate func_5(Parameter vconn_66, IfStmt target_10, AddressOfExpr target_12, Function func) {
exists(IfStmt target_5 |
	target_5.getCondition() instanceof NotExpr
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("put_device")
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_5.getThen().(BlockStmt).getStmt(1) instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_10.getLocation())
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vconn_66, AddressOfExpr target_13) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("device_unregister")
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_7(Parameter vconn_66, NotExpr target_7) {
	target_7.getOperand().(FunctionCall).getTarget().hasName("device_is_registered")
	and target_7.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_7.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_7.getParent().(IfStmt).getThen() instanceof ReturnStmt
}

predicate func_8(NotExpr target_7, Function func, ReturnStmt target_8) {
	target_8.getParent().(IfStmt).getCondition()=target_7
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Variable vhdev_68, VariableAccess target_9) {
	target_9.getTarget()=vhdev_68
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_10(Function func, IfStmt target_10) {
	target_10.getCondition() instanceof NotExpr
	and target_10.getThen() instanceof ReturnStmt
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Parameter vconn_66, AddressOfExpr target_11) {
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("device_is_registered")
}

predicate func_12(Parameter vconn_66, AddressOfExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("device_find_child")
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_13(Parameter vconn_66, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_66
	and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Parameter vconn_66, Variable vhdev_68, FunctionCall target_0, FunctionCall target_1, NotExpr target_7, ReturnStmt target_8, VariableAccess target_9, IfStmt target_10, AddressOfExpr target_11, AddressOfExpr target_12, AddressOfExpr target_13
where
func_0(vconn_66, target_0)
and func_1(vhdev_68, target_1)
and not func_2(vconn_66, vhdev_68, target_10, target_11, func)
and not func_5(vconn_66, target_10, target_12, func)
and not func_6(vconn_66, target_13)
and func_7(vconn_66, target_7)
and func_8(target_7, func, target_8)
and func_9(vhdev_68, target_9)
and func_10(func, target_10)
and func_11(vconn_66, target_11)
and func_12(vconn_66, target_12)
and func_13(vconn_66, target_13)
and vconn_66.getType().hasName("hci_conn *")
and vhdev_68.getType().hasName("hci_dev *")
and vconn_66.getFunction() = func
and vhdev_68.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
