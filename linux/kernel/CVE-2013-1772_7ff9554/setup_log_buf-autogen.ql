/**
 * @name linux-7ff9554bb578ba02166071d2d487b7fc7d860d62-setup_log_buf
 * @id cpp/linux/7ff9554bb578ba02166071d2d487b7fc7d860d62/setup-log-buf
 * @description linux-7ff9554bb578ba02166071d2d487b7fc7d860d62-kernel/printk.c-setup_log_buf CVE-2013-1772
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vlog_buf) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("memcpy")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vlog_buf
	and target_1.getArgument(1).(VariableAccess).getType().hasName("char[131072]")
	and target_1.getArgument(2) instanceof BinaryBitwiseOperation)
}

predicate func_2(Function func, BinaryBitwiseOperation target_2) {
	target_2.getValue()="131072"
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vdest_idx_194, Variable vlog_buf, VariableAccess target_3) {
	target_3.getTarget()=vlog_buf
	and target_3.getParent().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vdest_idx_194
}

predicate func_4(Variable vlog_idx_mask_227, Variable v__log_buf, VariableAccess target_4) {
	target_4.getTarget()=v__log_buf
	and target_4.getParent().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vlog_idx_mask_227
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vlog_end, EqualityOperation target_21, VariableAccess target_6) {
	target_6.getTarget()=vlog_end
	and target_6.getLocation().isBefore(target_21.getRightOperand().(VariableAccess).getLocation())
}

predicate func_7(Variable vstart_194, Variable voffset_194, Function func, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_194
	and target_7.getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(VariableAccess).getTarget()=vstart_194
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

/*predicate func_10(Variable v_min1_224, Variable v_min2_224, ExprStmt target_10) {
	target_10.getExpr().(EqualityOperation).getLeftOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v_min1_224
	and target_10.getExpr().(EqualityOperation).getRightOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v_min2_224
}

*/
/*predicate func_11(Variable v_min1_224, Variable v_min2_224, ExprStmt target_11) {
	target_11.getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=v_min1_224
	and target_11.getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=v_min2_224
	and target_11.getExpr().(ConditionalExpr).getThen().(VariableAccess).getTarget()=v_min1_224
	and target_11.getExpr().(ConditionalExpr).getElse().(VariableAccess).getTarget()=v_min2_224
}

*/
predicate func_12(Variable vdest_idx_194, Function func, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdest_idx_194
	and target_12.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Variable vstart_194, Variable vdest_idx_194, Variable vlog_buf, Variable vlog_end, Variable vlog_idx_mask_227, Variable v__log_buf, Function func, WhileStmt target_13) {
	target_13.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vstart_194
	and target_13.getCondition().(EqualityOperation).getRightOperand().(VariableAccess).getTarget()=vlog_end
	and target_13.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlog_buf
	and target_13.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vdest_idx_194
	and target_13.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=v__log_buf
	and target_13.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vlog_idx_mask_227
	and target_13.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vstart_194
	and target_13.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdest_idx_194
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

/*predicate func_15(Variable vdest_idx_194, Variable vlog_buf, Variable vlog_idx_mask_227, Variable v__log_buf, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vlog_buf
	and target_15.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vdest_idx_194
	and target_15.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=v__log_buf
	and target_15.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vlog_idx_mask_227
}

*/
/*predicate func_16(Variable vstart_194, ExprStmt target_16) {
	target_16.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vstart_194
}

*/
/*predicate func_17(Variable vdest_idx_194, ExprStmt target_17) {
	target_17.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vdest_idx_194
}

*/
predicate func_18(Variable voffset_194, Variable vlog_start, Function func, ExprStmt target_18) {
	target_18.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlog_start
	and target_18.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=voffset_194
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

predicate func_19(Variable voffset_194, Variable vcon_start, Function func, ExprStmt target_19) {
	target_19.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vcon_start
	and target_19.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=voffset_194
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Variable voffset_194, Variable vlog_end, AssignSubExpr target_20) {
	target_20.getLValue().(VariableAccess).getTarget()=vlog_end
	and target_20.getRValue().(VariableAccess).getTarget()=voffset_194
}

predicate func_21(Variable vstart_194, Variable vlog_end, EqualityOperation target_21) {
	target_21.getLeftOperand().(VariableAccess).getTarget()=vstart_194
	and target_21.getRightOperand().(VariableAccess).getTarget()=vlog_end
}

from Function func, Variable vstart_194, Variable vdest_idx_194, Variable voffset_194, Variable vlog_buf, Variable vlog_end, Variable v_min1_224, Variable vcon_start, Variable v_min2_224, Variable vlog_start, Variable vlog_idx_mask_227, Variable v__log_buf, BinaryBitwiseOperation target_2, VariableAccess target_3, VariableAccess target_4, DeclStmt target_5, VariableAccess target_6, ExprStmt target_7, ExprStmt target_12, WhileStmt target_13, ExprStmt target_18, ExprStmt target_19, AssignSubExpr target_20, EqualityOperation target_21
where
not func_1(vlog_buf)
and func_2(func, target_2)
and func_3(vdest_idx_194, vlog_buf, target_3)
and func_4(vlog_idx_mask_227, v__log_buf, target_4)
and func_5(func, target_5)
and func_6(vlog_end, target_21, target_6)
and func_7(vstart_194, voffset_194, func, target_7)
and func_12(vdest_idx_194, func, target_12)
and func_13(vstart_194, vdest_idx_194, vlog_buf, vlog_end, vlog_idx_mask_227, v__log_buf, func, target_13)
and func_18(voffset_194, vlog_start, func, target_18)
and func_19(voffset_194, vcon_start, func, target_19)
and func_20(voffset_194, vlog_end, target_20)
and func_21(vstart_194, vlog_end, target_21)
and vstart_194.getType().hasName("unsigned int")
and vdest_idx_194.getType().hasName("unsigned int")
and voffset_194.getType().hasName("unsigned int")
and vlog_buf.getType().hasName("char *")
and vlog_end.getType().hasName("unsigned int")
and v_min1_224.getType().hasName("unsigned int")
and vcon_start.getType().hasName("unsigned int")
and v_min2_224.getType().hasName("unsigned int")
and vlog_start.getType().hasName("unsigned int")
and vlog_idx_mask_227.getType().hasName("unsigned int")
and v__log_buf.getType() instanceof ArrayType
and vstart_194.(LocalVariable).getFunction() = func
and vdest_idx_194.(LocalVariable).getFunction() = func
and voffset_194.(LocalVariable).getFunction() = func
and not vlog_buf.getParentScope+() = func
and not vlog_end.getParentScope+() = func
and v_min1_224.(LocalVariable).getFunction() = func
and not vcon_start.getParentScope+() = func
and v_min2_224.(LocalVariable).getFunction() = func
and not vlog_start.getParentScope+() = func
and vlog_idx_mask_227.(LocalVariable).getFunction() = func
and not v__log_buf.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
