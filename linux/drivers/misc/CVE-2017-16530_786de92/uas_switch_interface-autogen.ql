/**
 * @name linux-786de92b3cb26012d3d0f00ee37adf14527f35c4-uas_switch_interface
 * @id cpp/linux/786de92b3cb26012d3d0f00ee37adf14527f35c4/uas-switch-interface
 * @description linux-786de92b3cb26012d3d0f00ee37adf14527f35c4-drivers/usb/storage/uas.c-uas_switch_interface CVE-2017-16530
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="0"
	and not target_1.getValue()="19"
	and target_1.getParent().(LTExpr).getParent().(IfStmt).getCondition() instanceof RelationalOperation
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable valt_876, ReturnStmt target_10, ExprStmt target_11, RelationalOperation target_6) {
exists(NotExpr target_2 |
	target_2.getOperand().(VariableAccess).getTarget()=valt_876
	and target_2.getParent().(IfStmt).getThen()=target_10
	and target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_2.getOperand().(VariableAccess).getLocation())
	and target_2.getOperand().(VariableAccess).getLocation().isBefore(target_6.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
exists(UnaryMinusExpr target_3 |
	target_3.getValue()="-19"
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(Variable valt_876, ReturnStmt target_10) {
exists(PointerFieldAccess target_4 |
	target_4.getTarget().getName()="desc"
	and target_4.getQualifier().(VariableAccess).getTarget()=valt_876
	and target_10.getExpr().(VariableAccess).getLocation().isBefore(target_4.getQualifier().(VariableAccess).getLocation()))
}

predicate func_5(Variable valt_876, FunctionCall target_12) {
exists(ValueFieldAccess target_5 |
	target_5.getTarget().getName()="bAlternateSetting"
	and target_5.getQualifier().(PointerFieldAccess).getTarget().getName()="desc"
	and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valt_876
	and target_5.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getArgument(2).(VariableAccess).getLocation()))
}

predicate func_6(Variable valt_876, ReturnStmt target_10, RelationalOperation target_6) {
	 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
	and target_6.getLesserOperand().(VariableAccess).getTarget()=valt_876
	and target_6.getGreaterOperand() instanceof Literal
	and target_6.getParent().(IfStmt).getThen()=target_10
}

predicate func_7(Variable valt_876, RelationalOperation target_6, VariableAccess target_7) {
	target_7.getTarget()=valt_876
	and target_6.getLesserOperand().(VariableAccess).getLocation().isBefore(target_7.getLocation())
}

predicate func_8(Parameter vintf_874, Variable valt_876, ValueFieldAccess target_8) {
	target_8.getTarget().getName()="desc"
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="altsetting"
	and target_8.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vintf_874
	and target_8.getQualifier().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_8.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_set_interface")
	and target_8.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("usb_device *")
	and target_8.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="bInterfaceNumber"
	and target_8.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=valt_876
}

/*predicate func_9(Parameter vintf_874, Variable valt_876, ExprStmt target_11, VariableAccess target_9) {
	target_9.getTarget()=valt_876
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("usb_set_interface")
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("usb_device *")
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="bInterfaceNumber"
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="desc"
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="altsetting"
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vintf_874
	and target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getParent().(FunctionCall).getParent().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_10(Variable valt_876, ReturnStmt target_10) {
	target_10.getExpr().(VariableAccess).getTarget()=valt_876
}

predicate func_11(Parameter vintf_874, Variable valt_876, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=valt_876
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("uas_find_uas_alt_setting")
	and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vintf_874
}

predicate func_12(Variable valt_876, FunctionCall target_12) {
	target_12.getTarget().hasName("usb_set_interface")
	and target_12.getArgument(0).(VariableAccess).getTarget().getType().hasName("usb_device *")
	and target_12.getArgument(1).(ValueFieldAccess).getTarget().getName()="bInterfaceNumber"
	and target_12.getArgument(1).(ValueFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_12.getArgument(2).(VariableAccess).getTarget()=valt_876
}

from Function func, Parameter vintf_874, Variable valt_876, Literal target_1, RelationalOperation target_6, VariableAccess target_7, ValueFieldAccess target_8, ReturnStmt target_10, ExprStmt target_11, FunctionCall target_12
where
func_1(func, target_1)
and not func_2(valt_876, target_10, target_11, target_6)
and not func_3(func)
and not func_4(valt_876, target_10)
and not func_5(valt_876, target_12)
and func_6(valt_876, target_10, target_6)
and func_7(valt_876, target_6, target_7)
and func_8(vintf_874, valt_876, target_8)
and func_10(valt_876, target_10)
and func_11(vintf_874, valt_876, target_11)
and func_12(valt_876, target_12)
and vintf_874.getType().hasName("usb_interface *")
and valt_876.getType().hasName("int")
and vintf_874.getFunction() = func
and valt_876.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
