/**
 * @name linux-1871c6020d7308afb99127bba51f04548e7ca84e-kvm_read_guest_virt
 * @id cpp/linux/1871c6020d7308afb99127bba51f04548e7ca84e/kvm-read-guest-virt
 * @description linux-1871c6020d7308afb99127bba51f04548e7ca84e-arch/x86/kvm/x86.c-kvm_read_guest_virt CVE-2010-0298
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vval_3042, Initializer target_0) {
		target_0.getExpr().(VariableAccess).getTarget()=vval_3042
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="12"
		and not target_1.getValue()="3"
		and target_1.getParent().(LShiftExpr).getParent().(SubExpr).getLeftOperand() instanceof BinaryBitwiseOperation
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Parameter vvcpu_3043, Variable vdata_3045, Variable vgpa_3049, Variable vtoread_3051, Variable vret_3052, FunctionCall target_2) {
		target_2.getTarget().hasName("kvm_read_guest")
		and not target_2.getTarget().hasName("kvm_read_guest_virt_helper")
		and target_2.getArgument(0).(PointerFieldAccess).getTarget().getName()="kvm"
		and target_2.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_3043
		and target_2.getArgument(1).(VariableAccess).getTarget()=vgpa_3049
		and target_2.getArgument(2).(VariableAccess).getTarget()=vdata_3045
		and target_2.getArgument(3).(VariableAccess).getTarget()=vtoread_3051
		and target_2.getParent().(AssignExpr).getRValue() = target_2
		and target_2.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_3052
}

predicate func_4(Parameter vvcpu_3043, ValueFieldAccess target_43, ExprStmt target_34) {
	exists(VariableCall target_4 |
		target_4.getExpr().(PointerFieldAccess).getTarget().getName()="get_cpl"
		and target_4.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("kvm_x86_ops *")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vvcpu_3043
		and target_43.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(Function func) {
	exists(BinaryBitwiseOperation target_5 |
		target_5.getValue()="4"
		and target_5.getEnclosingFunction() = func)
}

predicate func_8(Parameter vvcpu_3043, VariableAccess target_8) {
		target_8.getTarget()=vvcpu_3043
		and target_8.getParent().(VariableCall).getParent().(Initializer).getExpr() instanceof VariableCall
}

predicate func_9(Parameter vval_3042, VariableAccess target_9) {
		target_9.getTarget()=vval_3042
}

predicate func_11(Parameter vbytes_3042, VariableAccess target_11) {
		target_11.getTarget()=vbytes_3042
}

predicate func_12(Parameter vvcpu_3043, VariableAccess target_12) {
		target_12.getTarget()=vvcpu_3043
}

predicate func_13(Parameter vaddr_3042, VariableAccess target_13) {
		target_13.getTarget()=vaddr_3042
		and target_13.getParent().(VariableCall).getParent().(Initializer).getExpr() instanceof VariableCall
}

predicate func_16(Function func, DeclStmt target_16) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

predicate func_17(Variable vdata_3045, Variable vr_3046, Variable vgpa_3049, Variable vtoread_3051, Variable vret_3052, Parameter vaddr_3042, Parameter vbytes_3042, Function func, WhileStmt target_17) {
		target_17.getCondition().(VariableAccess).getTarget()=vbytes_3042
		and target_17.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgpa_3049
		and target_17.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getAnOperand().(ComplementExpr).getValue()="18446744073709551615"
		and target_17.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_17.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_17.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_3052
		and target_17.getStmt().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and target_17.getStmt().(BlockStmt).getStmt(6).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vret_3052
		and target_17.getStmt().(BlockStmt).getStmt(6).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_17.getStmt().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_17.getStmt().(BlockStmt).getStmt(6).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_17.getStmt().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vbytes_3042
		and target_17.getStmt().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
		and target_17.getStmt().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vdata_3045
		and target_17.getStmt().(BlockStmt).getStmt(8).(ExprStmt).getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
		and target_17.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_3042
		and target_17.getStmt().(BlockStmt).getStmt(9).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

predicate func_23(Variable v_min1_3051, Variable v_min2_3051, ExprStmt target_23) {
		target_23.getExpr().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v_min1_3051
		and target_23.getExpr().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v_min2_3051
}

predicate func_24(Variable v_min1_3051, Variable v_min2_3051, ExprStmt target_24) {
		target_24.getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=v_min1_3051
		and target_24.getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=v_min2_3051
		and target_24.getExpr().(ConditionalExpr).getThen().(VariableAccess).getTarget()=v_min1_3051
		and target_24.getExpr().(ConditionalExpr).getElse().(VariableAccess).getTarget()=v_min2_3051
}

/*predicate func_25(Variable v_min1_3051, Variable v_min2_3051, RelationalOperation target_25) {
		 (target_25 instanceof GTExpr or target_25 instanceof LTExpr)
		and target_25.getLesserOperand().(VariableAccess).getTarget()=v_min1_3051
		and target_25.getGreaterOperand().(VariableAccess).getTarget()=v_min2_3051
}

*/
/*predicate func_26(Variable v_min1_3051, VariableAccess target_26) {
		target_26.getTarget()=v_min1_3051
}

*/
/*predicate func_27(Variable v_min2_3051, VariableAccess target_27) {
		target_27.getTarget()=v_min2_3051
}

*/
/*predicate func_29(Variable vr_3046, Variable vgpa_3049, IfStmt target_29) {
		target_29.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vgpa_3049
		and target_29.getCondition().(EqualityOperation).getAnOperand().(ComplementExpr).getValue()="18446744073709551615"
		and target_29.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_29.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
}

*/
/*predicate func_30(Variable vgpa_3049, BlockStmt target_44, DeclStmt target_18, ExprStmt target_34, VariableAccess target_30) {
		target_30.getTarget()=vgpa_3049
		and target_30.getParent().(EQExpr).getAnOperand().(ComplementExpr).getValue()="18446744073709551615"
		and target_30.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_44
}

*/
/*predicate func_31(BlockStmt target_44, Function func, ComplementExpr target_31) {
		target_31.getValue()="18446744073709551615"
		and target_31.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_44
		and target_31.getEnclosingFunction() = func
}

*/
/*predicate func_32(Variable vr_3046, EqualityOperation target_45, ExprStmt target_32) {
		target_32.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_32.getExpr().(AssignExpr).getRValue() instanceof Literal
		and target_32.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_45
}

*/
/*predicate func_33(EqualityOperation target_45, Function func, GotoStmt target_33) {
		target_33.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_45
		and target_33.getEnclosingFunction() = func
}

*/
predicate func_34(Variable vret_3052, ExprStmt target_34) {
		target_34.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_3052
		and target_34.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_35(Parameter vvcpu_3043, VariableCall target_46, VariableAccess target_35) {
		target_35.getTarget()=vvcpu_3043
		and target_35.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
		and target_46.getArgument(0).(VariableAccess).getLocation().isBefore(target_35.getLocation())
}

/*predicate func_36(Variable vr_3046, Variable vret_3052, IfStmt target_36) {
		target_36.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vret_3052
		and target_36.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_36.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_36.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
}

*/
/*predicate func_37(Variable vr_3046, RelationalOperation target_47, ExprStmt target_37) {
		target_37.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vr_3046
		and target_37.getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_37.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_47
}

*/
/*predicate func_38(RelationalOperation target_47, Function func, GotoStmt target_38) {
		target_38.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_47
		and target_38.getEnclosingFunction() = func
}

*/
/*predicate func_39(Variable vtoread_3051, Parameter vbytes_3042, ExprStmt target_39) {
		target_39.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vbytes_3042
		and target_39.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
}

*/
/*predicate func_40(Variable vdata_3045, Variable vtoread_3051, ExprStmt target_40) {
		target_40.getExpr().(AssignPointerAddExpr).getLValue().(VariableAccess).getTarget()=vdata_3045
		and target_40.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
}

*/
/*predicate func_41(Variable vtoread_3051, Parameter vaddr_3042, ExprStmt target_41) {
		target_41.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vaddr_3042
		and target_41.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vtoread_3051
}

*/
predicate func_42(Variable vr_3046, VariableAccess target_42) {
		target_42.getTarget()=vr_3046
}

predicate func_43(Parameter vvcpu_3043, ValueFieldAccess target_43) {
		target_43.getTarget().getName()="mmu"
		and target_43.getQualifier().(PointerFieldAccess).getTarget().getName()="arch"
		and target_43.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvcpu_3043
}

predicate func_44(Function func, BlockStmt target_44) {
		target_44.getStmt(0) instanceof ExprStmt
		and target_44.getStmt(1) instanceof GotoStmt
		and target_44.getEnclosingFunction() = func
}

predicate func_45(Variable vgpa_3049, EqualityOperation target_45) {
		target_45.getAnOperand().(VariableAccess).getTarget()=vgpa_3049
		and target_45.getAnOperand() instanceof ComplementExpr
}

predicate func_46(Parameter vvcpu_3043, Parameter vaddr_3042, VariableCall target_46) {
		target_46.getExpr() instanceof ValueFieldAccess
		and target_46.getArgument(0).(VariableAccess).getTarget()=vvcpu_3043
		and target_46.getArgument(1).(VariableAccess).getTarget()=vaddr_3042
}

predicate func_47(Variable vret_3052, RelationalOperation target_47) {
		 (target_47 instanceof GTExpr or target_47 instanceof LTExpr)
		and target_47.getLesserOperand().(VariableAccess).getTarget()=vret_3052
		and target_47.getGreaterOperand() instanceof Literal
}

from Function func, Parameter vval_3042, Parameter vvcpu_3043, Variable vdata_3045, Variable vr_3046, Variable vgpa_3049, Variable vtoread_3051, Variable v_min1_3051, Variable v_min2_3051, Variable vret_3052, Parameter vaddr_3042, Parameter vbytes_3042, Initializer target_0, Literal target_1, FunctionCall target_2, VariableAccess target_8, VariableAccess target_9, VariableAccess target_11, VariableAccess target_12, VariableAccess target_13, DeclStmt target_16, WhileStmt target_17, ExprStmt target_23, ExprStmt target_24, ExprStmt target_34, VariableAccess target_35, VariableAccess target_42, ValueFieldAccess target_43, BlockStmt target_44, EqualityOperation target_45, VariableCall target_46, RelationalOperation target_47
where
func_0(vval_3042, target_0)
and func_1(func, target_1)
and func_2(vvcpu_3043, vdata_3045, vgpa_3049, vtoread_3051, vret_3052, target_2)
and not func_4(vvcpu_3043, target_43, target_34)
and not func_5(func)
and func_8(vvcpu_3043, target_8)
and func_9(vval_3042, target_9)
and func_11(vbytes_3042, target_11)
and func_12(vvcpu_3043, target_12)
and func_13(vaddr_3042, target_13)
and func_16(func, target_16)
and func_17(vdata_3045, vr_3046, vgpa_3049, vtoread_3051, vret_3052, vaddr_3042, vbytes_3042, func, target_17)
and func_23(v_min1_3051, v_min2_3051, target_23)
and func_24(v_min1_3051, v_min2_3051, target_24)
and func_34(vret_3052, target_34)
and func_35(vvcpu_3043, target_46, target_35)
and func_42(vr_3046, target_42)
and func_43(vvcpu_3043, target_43)
and func_44(func, target_44)
and func_45(vgpa_3049, target_45)
and func_46(vvcpu_3043, vaddr_3042, target_46)
and func_47(vret_3052, target_47)
and vval_3042.getType().hasName("void *")
and vvcpu_3043.getType().hasName("kvm_vcpu *")
and vdata_3045.getType().hasName("void *")
and vr_3046.getType().hasName("int")
and vgpa_3049.getType().hasName("gpa_t")
and vtoread_3051.getType().hasName("unsigned int")
and v_min1_3051.getType().hasName("unsigned int")
and v_min2_3051.getType().hasName("unsigned int")
and vret_3052.getType().hasName("int")
and vaddr_3042.getType().hasName("gva_t")
and vbytes_3042.getType().hasName("unsigned int")
and vval_3042.getFunction() = func
and vvcpu_3043.getFunction() = func
and vdata_3045.(LocalVariable).getFunction() = func
and vr_3046.(LocalVariable).getFunction() = func
and vgpa_3049.(LocalVariable).getFunction() = func
and vtoread_3051.(LocalVariable).getFunction() = func
and v_min1_3051.(LocalVariable).getFunction() = func
and v_min2_3051.(LocalVariable).getFunction() = func
and vret_3052.(LocalVariable).getFunction() = func
and vaddr_3042.getFunction() = func
and vbytes_3042.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
