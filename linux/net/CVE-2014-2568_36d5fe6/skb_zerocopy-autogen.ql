/**
 * @name linux-36d5fe6a000790f56039afe26834265db0a3ad4c-skb_zerocopy
 * @id cpp/linux/36d5fe6a000790f56039afe26834265db0a3ad4c/skb-zerocopy
 * @description linux-36d5fe6a000790f56039afe26834265db0a3ad4c-net/core/skbuff.c-skb_zerocopy CVE-2014-2568
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlen_2132, Parameter vhlen_2132, ExprStmt target_13, IfStmt target_0) {
	target_0.getCondition().(VariableAccess).getTarget()=vhlen_2132
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_2132
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vhlen_2132
	and target_0.getElse() instanceof BlockStmt
	and target_0.getLocation().isBefore(target_13.getLocation())
}

predicate func_1(VariableAccess target_12, Function func) {
exists(ReturnStmt target_1 |
	target_1.getExpr() instanceof FunctionCall
	and target_1.getParent().(IfStmt).getCondition()=target_12
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("int")
	and target_2.getRValue() instanceof FunctionCall
	and target_2.getEnclosingFunction() = func)
}

predicate func_3(VariableAccess target_12, Function func) {
exists(IfStmt target_3 |
	target_3.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_3.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getThen().(ReturnStmt).getExpr().(VariableAccess).getType().hasName("int")
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_3
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
	and target_3.getEnclosingFunction() = func)
}

predicate func_4(Parameter vfrom_2132, ForStmt target_14, ExprStmt target_15, Function func) {
exists(IfStmt target_4 |
	target_4.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("skb_orphan_frags")
	and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfrom_2132
	and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(Literal).getValue()="32"
	and target_4.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("skb_tx_error")
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfrom_2132
	and target_4.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_14.getLocation())
	and target_15.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_5(Parameter vfrom_2132) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("skb_tx_error")
	and target_5.getArgument(0).(VariableAccess).getTarget()=vfrom_2132)
}

*/
/*predicate func_6(Function func) {
exists(UnaryMinusExpr target_6 |
	target_6.getValue()="-12"
	and target_6.getEnclosingFunction() = func)
}

*/
predicate func_8(Parameter vto_2132, Parameter vlen_2132, BlockStmt target_19, RelationalOperation target_8) {
	 (target_8 instanceof GEExpr or target_8 instanceof LEExpr)
	and target_8.getLesserOperand().(VariableAccess).getTarget()=vlen_2132
	and target_8.getGreaterOperand().(FunctionCall).getTarget().hasName("skb_tailroom")
	and target_8.getGreaterOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
	and target_8.getParent().(IfStmt).getThen()=target_19
}

predicate func_9(Parameter vto_2132, Parameter vfrom_2132, Parameter vlen_2132, FunctionCall target_9) {
	target_9.getTarget().hasName("skb_copy_bits")
	and target_9.getArgument(0).(VariableAccess).getTarget()=vfrom_2132
	and target_9.getArgument(1).(Literal).getValue()="0"
	and target_9.getArgument(2).(FunctionCall).getTarget().hasName("skb_put")
	and target_9.getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
	and target_9.getArgument(2).(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlen_2132
	and target_9.getArgument(3).(VariableAccess).getTarget()=vlen_2132
}

predicate func_10(Parameter vto_2132, Parameter vfrom_2132, Parameter vhlen_2132, FunctionCall target_10) {
	target_10.getTarget().hasName("skb_copy_bits")
	and target_10.getArgument(0).(VariableAccess).getTarget()=vfrom_2132
	and target_10.getArgument(1).(Literal).getValue()="0"
	and target_10.getArgument(2).(FunctionCall).getTarget().hasName("skb_put")
	and target_10.getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
	and target_10.getArgument(2).(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vhlen_2132
	and target_10.getArgument(3).(VariableAccess).getTarget()=vhlen_2132
}

predicate func_11(Parameter vto_2132, Parameter vlen_2132, Variable vj_2134, Variable vplen_2135, Variable vpage_2136, Variable voffset_2137, VariableAccess target_12, BlockStmt target_11) {
	target_11.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vplen_2135
	and target_11.getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vplen_2135
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpage_2136
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("virt_to_head_page")
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="head"
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_2137
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="data"
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getTarget().hasName("lowmem_page_address")
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__skb_fill_page_desc")
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpage_2136
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=voffset_2137
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vplen_2135
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_page")
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_2136
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_2134
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_2132
	and target_11.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vplen_2135
	and target_11.getParent().(IfStmt).getCondition()=target_12
}

predicate func_12(Parameter vhlen_2132, BlockStmt target_20, VariableAccess target_12) {
	target_12.getTarget()=vhlen_2132
	and target_12.getParent().(IfStmt).getThen()=target_20
}

predicate func_13(Parameter vto_2132, Parameter vlen_2132, Variable vplen_2135, ExprStmt target_13) {
	target_13.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getTarget().getName()="truesize"
	and target_13.getExpr().(AssignAddExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vto_2132
	and target_13.getExpr().(AssignAddExpr).getRValue().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vlen_2132
	and target_13.getExpr().(AssignAddExpr).getRValue().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vplen_2135
}

predicate func_14(Parameter vfrom_2132, Parameter vlen_2132, Variable vj_2134, ForStmt target_14) {
	target_14.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_14.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_14.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_14.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfrom_2132
	and target_14.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_14.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vlen_2132
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="frags"
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vj_2134
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="frags"
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_14.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_15(Parameter vfrom_2132, Variable vpage_2136, Variable voffset_2137, ExprStmt target_15) {
	target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_2137
	and target_15.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="data"
	and target_15.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfrom_2132
	and target_15.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getTarget().hasName("lowmem_page_address")
	and target_15.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_2136
}

predicate func_19(Function func, BlockStmt target_19) {
	target_19.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_19.getEnclosingFunction() = func
}

predicate func_20(Parameter vlen_2132, Parameter vhlen_2132, BlockStmt target_20) {
	target_20.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_20.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_2132
	and target_20.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vhlen_2132
}

from Function func, Parameter vto_2132, Parameter vfrom_2132, Parameter vlen_2132, Parameter vhlen_2132, Variable vj_2134, Variable vplen_2135, Variable vpage_2136, Variable voffset_2137, IfStmt target_0, RelationalOperation target_8, FunctionCall target_9, FunctionCall target_10, BlockStmt target_11, VariableAccess target_12, ExprStmt target_13, ForStmt target_14, ExprStmt target_15, BlockStmt target_19, BlockStmt target_20
where
func_0(vlen_2132, vhlen_2132, target_13, target_0)
and not func_1(target_12, func)
and not func_2(func)
and not func_3(target_12, func)
and not func_4(vfrom_2132, target_14, target_15, func)
and func_8(vto_2132, vlen_2132, target_19, target_8)
and func_9(vto_2132, vfrom_2132, vlen_2132, target_9)
and func_10(vto_2132, vfrom_2132, vhlen_2132, target_10)
and func_11(vto_2132, vlen_2132, vj_2134, vplen_2135, vpage_2136, voffset_2137, target_12, target_11)
and func_12(vhlen_2132, target_20, target_12)
and func_13(vto_2132, vlen_2132, vplen_2135, target_13)
and func_14(vfrom_2132, vlen_2132, vj_2134, target_14)
and func_15(vfrom_2132, vpage_2136, voffset_2137, target_15)
and func_19(func, target_19)
and func_20(vlen_2132, vhlen_2132, target_20)
and vto_2132.getType().hasName("sk_buff *")
and vfrom_2132.getType().hasName("const sk_buff *")
and vlen_2132.getType().hasName("int")
and vhlen_2132.getType().hasName("int")
and vj_2134.getType().hasName("int")
and vplen_2135.getType().hasName("int")
and vpage_2136.getType().hasName("page *")
and voffset_2137.getType().hasName("unsigned int")
and vto_2132.getFunction() = func
and vfrom_2132.getFunction() = func
and vlen_2132.getFunction() = func
and vhlen_2132.getFunction() = func
and vj_2134.(LocalVariable).getFunction() = func
and vplen_2135.(LocalVariable).getFunction() = func
and vpage_2136.(LocalVariable).getFunction() = func
and voffset_2137.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
