/**
 * @name linux-8acfe468b0384e834a303f08ebc4953d72fb690a-verify_iovec
 * @id cpp/linux/8acfe468b0384e834a303f08ebc4953d72fb690a/verify-iovec
 * @description linux-8acfe468b0384e834a303f08ebc4953d72fb690a-net/core/iovec.c-verify_iovec CVE-2010-4160
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
		target_0.getValue()="0"
		and not target_0.getValue()="1"
		and target_0.getParent().(LTExpr).getParent().(IfStmt).getCondition() instanceof RelationalOperation
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="90"
		and not target_1.getValue()="1"
		and target_1.getParent().(UnaryMinusExpr).getParent().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
		and target_1.getEnclosingFunction() = func
}

predicate func_4(Variable verr_1_41, ReturnStmt target_12, RelationalOperation target_11) {
	exists(RelationalOperation target_4 |
		 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
		and target_4.getGreaterOperand().(VariableAccess).getType().hasName("size_t")
		and target_4.getLesserOperand().(SubExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="2147483647"
		and target_4.getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=verr_1_41
		and target_4.getParent().(IfStmt).getThen()=target_12
		and target_4.getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_11.getLesserOperand().(VariableAccess).getLocation()))
}

predicate func_5(Variable verr_1_41, ExprStmt target_14) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(VariableAccess).getType().hasName("size_t")
		and target_5.getRValue().(SubExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="2147483647"
		and target_5.getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=verr_1_41
		and target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getRValue().(SubExpr).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_6(Parameter viov_38, Variable vct_40, RelationalOperation target_11, ArrayExpr target_16) {
	exists(ExprStmt target_6 |
		target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="iov_len"
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=viov_38
		and target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vct_40
		and target_6.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("size_t")
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_6
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
		and target_16.getArrayBase().(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getLocation()))
}

predicate func_7(Variable verr_1_41, RelationalOperation target_11, ReturnStmt target_17) {
	exists(ExprStmt target_7 |
		target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=verr_1_41
		and target_7.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getType().hasName("size_t")
		and target_11.getLesserOperand().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
		and target_7.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation().isBefore(target_17.getExpr().(VariableAccess).getLocation()))
}

predicate func_8(Parameter viov_38, Variable vct_40, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="iov_len"
		and target_8.getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=viov_38
		and target_8.getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vct_40
}

predicate func_10(Variable verr_1_41, AssignAddExpr target_10) {
		target_10.getLValue().(VariableAccess).getTarget()=verr_1_41
		and target_10.getRValue() instanceof ValueFieldAccess
}

predicate func_11(Variable verr_1_41, ReturnStmt target_12, RelationalOperation target_11) {
		 (target_11 instanceof GTExpr or target_11 instanceof LTExpr)
		and target_11.getLesserOperand().(VariableAccess).getTarget()=verr_1_41
		and target_11.getGreaterOperand() instanceof Literal
		and target_11.getParent().(IfStmt).getThen()=target_12
}

predicate func_12(RelationalOperation target_11, Function func, ReturnStmt target_12) {
		target_12.getExpr().(UnaryMinusExpr).getValue()="-90"
		and target_12.getParent().(IfStmt).getCondition()=target_11
		and target_12.getEnclosingFunction() = func
}

predicate func_14(Variable verr_1_41, ExprStmt target_14) {
		target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_1_41
		and target_14.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_16(Parameter viov_38, Variable vct_40, ArrayExpr target_16) {
		target_16.getArrayBase().(VariableAccess).getTarget()=viov_38
		and target_16.getArrayOffset().(VariableAccess).getTarget()=vct_40
}

predicate func_17(Variable verr_1_41, Function func, ReturnStmt target_17) {
		target_17.getExpr().(VariableAccess).getTarget()=verr_1_41
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

from Function func, Parameter viov_38, Variable vct_40, Variable verr_1_41, Literal target_0, Literal target_1, ValueFieldAccess target_8, AssignAddExpr target_10, RelationalOperation target_11, ReturnStmt target_12, ExprStmt target_14, ArrayExpr target_16, ReturnStmt target_17
where
func_0(func, target_0)
and func_1(func, target_1)
and not func_4(verr_1_41, target_12, target_11)
and not func_5(verr_1_41, target_14)
and not func_6(viov_38, vct_40, target_11, target_16)
and not func_7(verr_1_41, target_11, target_17)
and func_8(viov_38, vct_40, target_8)
and func_10(verr_1_41, target_10)
and func_11(verr_1_41, target_12, target_11)
and func_12(target_11, func, target_12)
and func_14(verr_1_41, target_14)
and func_16(viov_38, vct_40, target_16)
and func_17(verr_1_41, func, target_17)
and viov_38.getType().hasName("iovec *")
and vct_40.getType().hasName("int")
and verr_1_41.getType().hasName("long")
and viov_38.getFunction() = func
and vct_40.(LocalVariable).getFunction() = func
and verr_1_41.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
