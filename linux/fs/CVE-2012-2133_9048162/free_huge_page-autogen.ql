/**
 * @name linux-90481622d75715bfcb68501280a917dbfe516029-free_huge_page
 * @id cpp/linux/90481622d75715bfcb68501280a917dbfe516029/free-huge-page
 * @description linux-90481622d75715bfcb68501280a917dbfe516029-mm/hugetlb.c-free_huge_page CVE-2012-2133
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmapping_543, FunctionCall target_0) {
		target_0.getTarget().hasName("hugetlb_put_quota")
		and not target_0.getTarget().hasName("hugepage_subpool_put_pages")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vmapping_543
		and target_0.getArgument(1).(Literal).getValue()="1"
}

predicate func_3(Parameter vpage_535, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="private"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpage_535
}

predicate func_5(Variable vmapping_543, AssignExpr target_5) {
		target_5.getLValue().(VariableAccess).getTarget()=vmapping_543
		and target_5.getRValue() instanceof ValueFieldAccess
}

predicate func_6(Variable vmapping_543, Function func, IfStmt target_6) {
		target_6.getCondition().(VariableAccess).getTarget()=vmapping_543
		and target_6.getThen().(ExprStmt).getExpr() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

from Function func, Variable vmapping_543, Parameter vpage_535, FunctionCall target_0, ValueFieldAccess target_3, AssignExpr target_5, IfStmt target_6
where
func_0(vmapping_543, target_0)
and func_3(vpage_535, target_3)
and func_5(vmapping_543, target_5)
and func_6(vmapping_543, func, target_6)
and vmapping_543.getType().hasName("address_space *")
and vpage_535.getType().hasName("page *")
and vmapping_543.(LocalVariable).getFunction() = func
and vpage_535.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
