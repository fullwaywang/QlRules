/**
 * @name linux-313bbd1990b6ddfdaa7da098d0c56b098a833572-mac80211_hwsim_beacon
 * @id cpp/linux/313bbd1990b6ddfdaa7da098d0c56b098a833572/mac80211-hwsim-beacon
 * @description linux-313bbd1990b6ddfdaa7da098d0c56b098a833572-drivers/net/wireless/mac80211_hwsim.c-mac80211_hwsim_beacon CVE-2021-47396
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdata_1853, Variable vbcn_int_1856, Parameter vtimer_1851, FunctionCall target_0) {
	target_0.getTarget().hasName("hrtimer_forward")
	and not target_0.getTarget().hasName("hrtimer_forward_now")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="beacon_timer"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1853
	and target_0.getArgument(1).(FunctionCall).getTarget().hasName("hrtimer_get_expires")
	and target_0.getArgument(1).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtimer_1851
	and target_0.getArgument(2).(FunctionCall).getTarget().hasName("ns_to_ktime")
	and target_0.getArgument(2).(FunctionCall).getArgument(0).(MulExpr).getLeftOperand().(VariableAccess).getTarget()=vbcn_int_1856
	and target_0.getArgument(2).(FunctionCall).getArgument(0).(MulExpr).getRightOperand().(Literal).getValue()="1000"
}

predicate func_1(Parameter vtimer_1851, VariableAccess target_1) {
	target_1.getTarget()=vtimer_1851
	and target_1.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("hrtimer_get_expires")
}

from Function func, Variable vdata_1853, Variable vbcn_int_1856, Parameter vtimer_1851, FunctionCall target_0, VariableAccess target_1
where
func_0(vdata_1853, vbcn_int_1856, vtimer_1851, target_0)
and func_1(vtimer_1851, target_1)
and vdata_1853.getType().hasName("mac80211_hwsim_data *")
and vbcn_int_1856.getType().hasName("u64")
and vtimer_1851.getType().hasName("hrtimer *")
and vdata_1853.(LocalVariable).getFunction() = func
and vbcn_int_1856.(LocalVariable).getFunction() = func
and vtimer_1851.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
