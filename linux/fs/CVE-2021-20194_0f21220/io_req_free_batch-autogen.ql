/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_req_free_batch
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-req-free-batch
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_req_free_batch CVE-2021-20194
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vreq_1915, FunctionCall target_0) {
	target_0.getTarget().hasName("io_free_req")
	and not target_0.getTarget().hasName("io_req_init_async")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vreq_1915
}

predicate func_2(Parameter vreq_1915, FunctionCall target_2) {
	target_2.getTarget().hasName("io_queue_next")
	and not target_2.getTarget().hasName("spin_lock_irq")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vreq_1915
}

predicate func_3(Parameter vrb_1915, FunctionCall target_3) {
	target_3.getTarget().hasName("put_task_struct_many")
	and not target_3.getTarget().hasName("list_add")
	and target_3.getArgument(0).(PointerFieldAccess).getTarget().getName()="task"
	and target_3.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_3.getArgument(1).(PointerFieldAccess).getTarget().getName()="task_refs"
	and target_3.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
}

predicate func_4(Function func, Initializer target_4) {
	target_4.getExpr().(NotExpr).getOperand() instanceof NotExpr
	and target_4.getExpr().getEnclosingFunction() = func
}

predicate func_5(Parameter vreq_1915, Parameter vrb_1915, FunctionCall target_5) {
	target_5.getTarget().hasName("__io_req_free_batch_flush")
	and not target_5.getTarget().hasName("spin_unlock_irq")
	and target_5.getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_5.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_5.getArgument(1).(VariableAccess).getTarget()=vrb_1915
}

predicate func_7(Parameter vreq_1915, BlockStmt target_45) {
exists(LogicalOrExpr target_7 |
	target_7.getLeftOperand().(ValueFieldAccess).getTarget().getName()="files"
	and target_7.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_7.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_7.getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_7.getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_7.getParent().(IfStmt).getThen()=target_45)
}

predicate func_8(Parameter vreq_1915) {
exists(AssignExpr target_8 |
	target_8.getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_8.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_8.getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_8.getRValue().(FunctionCall).getTarget().hasName("get_files_struct")
	and target_8.getRValue().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("get_current"))
}

predicate func_9(Parameter vreq_1915) {
exists(AssignOrExpr target_9 |
	target_9.getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_9.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915)
}

predicate func_10(Function func) {
exists(AddressOfExpr target_10 |
	target_10.getOperand().(ValueFieldAccess).getTarget().getName()="inflight_lock"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_10.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_10.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(Parameter vreq_1915, EqualityOperation target_23) {
exists(AddressOfExpr target_11 |
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="inflight_entry"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_23.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_12(Function func) {
exists(AddressOfExpr target_12 |
	target_12.getOperand().(ValueFieldAccess).getTarget().getName()="inflight_list"
	and target_12.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_12.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_12.getEnclosingFunction() = func)
}

predicate func_13(Function func) {
exists(AddressOfExpr target_13 |
	target_13.getOperand().(ValueFieldAccess).getTarget().getName()="inflight_lock"
	and target_13.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_13.getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_ring_ctx *")
	and target_13.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_13.getEnclosingFunction() = func)
}

predicate func_14(Parameter vreq_1915, PointerFieldAccess target_14) {
	target_14.getTarget().getName()="ctx"
	and target_14.getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_14.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_15(Parameter vreq_1915, VariableAccess target_15) {
	target_15.getTarget()=vreq_1915
}

predicate func_16(Parameter vreq_1915, VariableAccess target_16) {
	target_16.getTarget()=vreq_1915
}

predicate func_17(Parameter vreq_1915, VariableAccess target_17) {
	target_17.getTarget()=vreq_1915
	and target_17.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_19(Parameter vreq_1915, VariableAccess target_19) {
	target_19.getTarget()=vreq_1915
	and target_19.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_21(Parameter vreq_1915, Function func, IfStmt target_21) {
	target_21.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_21.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("io_is_fallback_req")
	and target_21.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1915
	and target_21.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

predicate func_22(Parameter vreq_1915, Function func, IfStmt target_22) {
	target_22.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_22.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_22.getCondition().(BitwiseAndExpr).getRightOperand() instanceof EnumConstantAccess
	and target_22.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

predicate func_23(Parameter vreq_1915, Parameter vrb_1915, BlockStmt target_45, EqualityOperation target_23) {
	target_23.getLeftOperand().(PointerFieldAccess).getTarget().getName()="task"
	and target_23.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_23.getRightOperand().(PointerFieldAccess).getTarget().getName()="task"
	and target_23.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_23.getParent().(IfStmt).getThen()=target_45
}

predicate func_24(Parameter vrb_1915, EqualityOperation target_23, IfStmt target_24) {
	target_24.getCondition().(PointerFieldAccess).getTarget().getName()="task"
	and target_24.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_24.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and target_24.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

predicate func_25(Parameter vrb_1915, IfStmt target_24, VariableAccess target_25) {
	target_25.getTarget()=vrb_1915
	and target_25.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_24.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_25.getLocation())
}

predicate func_26(Parameter vrb_1915, ExprStmt target_27, VariableAccess target_26) {
	target_26.getTarget()=vrb_1915
	and target_26.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_26.getLocation().isBefore(target_27.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_27(Parameter vreq_1915, Parameter vrb_1915, EqualityOperation target_23, ExprStmt target_27) {
	target_27.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="task"
	and target_27.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="task"
	and target_27.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_1915
	and target_27.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

predicate func_28(Parameter vrb_1915, EqualityOperation target_23, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="task_refs"
	and target_28.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_28.getExpr().(AssignExpr).getRValue() instanceof Literal
	and target_28.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_23
}

predicate func_29(Parameter vrb_1915, PostfixIncrExpr target_29) {
	target_29.getOperand().(PointerFieldAccess).getTarget().getName()="task_refs"
	and target_29.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
}

predicate func_30(Variable v__ret_warn_on_1932, StmtExpr target_30) {
	target_30.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_30.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1932
	and target_30.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_30.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_30.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_30.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_30.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1932
	and target_30.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

predicate func_32(Parameter vreq_1915, NotExpr target_32) {
	target_32.getOperand().(FunctionCall).getTarget().hasName("io_dismantle_req")
	and target_32.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vreq_1915
}

/*predicate func_33(Variable v__ret_warn_on_1932, IfStmt target_33) {
	target_33.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_33.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1932
	and target_33.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_33.getThen().(DoStmt).getCondition() instanceof Literal
	and target_33.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_33.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_33.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_33.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_33.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
}

*/
/*predicate func_34(Function func, ExprStmt target_34) {
	target_34.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1694"
	and target_34.getEnclosingFunction() = func
}

*/
/*predicate func_35(Function func, AsmStmt target_35) {
	target_35.getChild(0).(Literal).getValue()="1694"
	and target_35.getEnclosingFunction() = func
}

*/
/*predicate func_36(Function func, DoStmt target_36) {
	target_36.getCondition() instanceof Literal
	and target_36.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_36.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_36.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2).(BitwiseOrExpr).getValue()="2307"
	and target_36.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_36.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_36.getEnclosingFunction() = func
}

*/
/*predicate func_37(Function func, AsmStmt target_37) {
	target_37.getChild(0) instanceof StringLiteral
	and target_37.getChild(1) instanceof Literal
	and target_37.getChild(2).(BitwiseOrExpr).getValue()="2307"
	and target_37.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_37.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_37.getEnclosingFunction() = func
}

*/
/*predicate func_38(Function func, ExprStmt target_38) {
	target_38.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1695"
	and target_38.getEnclosingFunction() = func
}

*/
/*predicate func_39(Function func, AsmStmt target_39) {
	target_39.getChild(0).(Literal).getValue()="1695"
	and target_39.getEnclosingFunction() = func
}

*/
/*predicate func_40(Function func, ExprStmt target_40) {
	target_40.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1696"
	and target_40.getEnclosingFunction() = func
}

*/
/*predicate func_41(Function func, AsmStmt target_41) {
	target_41.getChild(0).(Literal).getValue()="1696"
	and target_41.getEnclosingFunction() = func
}

*/
/*predicate func_42(Variable v__ret_warn_on_1932, ExprStmt target_42) {
	target_42.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_42.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_1932
	and target_42.getExpr().(FunctionCall).getArgument(1) instanceof Literal
}

*/
predicate func_43(Parameter vreq_1915, Parameter vrb_1915, AssignExpr target_43) {
	target_43.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="reqs"
	and target_43.getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_43.getLValue().(ArrayExpr).getArrayOffset().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="to_free"
	and target_43.getLValue().(ArrayExpr).getArrayOffset().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_43.getRValue().(VariableAccess).getTarget()=vreq_1915
}

predicate func_44(Parameter vrb_1915, Function func, IfStmt target_44) {
	target_44.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_44.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="to_free"
	and target_44.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrb_1915
	and target_44.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(EqualityOperation).getRightOperand().(AddExpr).getValue()="8"
	and target_44.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_44.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_44
}

predicate func_45(Function func, BlockStmt target_45) {
	target_45.getStmt(0) instanceof IfStmt
	and target_45.getStmt(1) instanceof ExprStmt
	and target_45.getStmt(2) instanceof ExprStmt
	and target_45.getEnclosingFunction() = func
}

from Function func, Parameter vreq_1915, Variable v__ret_warn_on_1932, Parameter vrb_1915, FunctionCall target_0, FunctionCall target_2, FunctionCall target_3, Initializer target_4, FunctionCall target_5, PointerFieldAccess target_14, VariableAccess target_15, VariableAccess target_16, VariableAccess target_17, VariableAccess target_19, IfStmt target_21, IfStmt target_22, EqualityOperation target_23, IfStmt target_24, VariableAccess target_25, VariableAccess target_26, ExprStmt target_27, ExprStmt target_28, PostfixIncrExpr target_29, StmtExpr target_30, NotExpr target_32, AssignExpr target_43, IfStmt target_44, BlockStmt target_45
where
func_0(vreq_1915, target_0)
and func_2(vreq_1915, target_2)
and func_3(vrb_1915, target_3)
and func_4(func, target_4)
and func_5(vreq_1915, vrb_1915, target_5)
and not func_7(vreq_1915, target_45)
and not func_8(vreq_1915)
and not func_9(vreq_1915)
and not func_10(func)
and not func_11(vreq_1915, target_23)
and not func_12(func)
and not func_13(func)
and func_14(vreq_1915, target_14)
and func_15(vreq_1915, target_15)
and func_16(vreq_1915, target_16)
and func_17(vreq_1915, target_17)
and func_19(vreq_1915, target_19)
and func_21(vreq_1915, func, target_21)
and func_22(vreq_1915, func, target_22)
and func_23(vreq_1915, vrb_1915, target_45, target_23)
and func_24(vrb_1915, target_23, target_24)
and func_25(vrb_1915, target_24, target_25)
and func_26(vrb_1915, target_27, target_26)
and func_27(vreq_1915, vrb_1915, target_23, target_27)
and func_28(vrb_1915, target_23, target_28)
and func_29(vrb_1915, target_29)
and func_30(v__ret_warn_on_1932, target_30)
and func_32(vreq_1915, target_32)
and func_43(vreq_1915, vrb_1915, target_43)
and func_44(vrb_1915, func, target_44)
and func_45(func, target_45)
and vreq_1915.getType().hasName("io_kiocb *")
and v__ret_warn_on_1932.getType().hasName("int")
and vrb_1915.getType().hasName("req_batch *")
and vreq_1915.getFunction() = func
and v__ret_warn_on_1932.(LocalVariable).getFunction() = func
and vrb_1915.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
