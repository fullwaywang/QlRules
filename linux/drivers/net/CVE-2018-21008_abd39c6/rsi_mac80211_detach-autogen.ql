/**
 * @name linux-abd39c6ded9db53aa44c2540092bdd5fb6590fa8-rsi_mac80211_detach
 * @id cpp/linux/abd39c6ded9db53aa44c2540092bdd5fb6590fa8/rsi-mac80211-detach
 * @description linux-abd39c6ded9db53aa44c2540092bdd5fb6590fa8-drivers/net/wireless/rsi/rsi_91x_mac80211.c-rsi_mac80211_detach CVE-2018-21008
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vadapter_239, VariableAccess target_1, AddressOfExpr target_2) {
exists(ExprStmt target_0 |
	target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="hw"
	and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vadapter_239
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
	and target_0.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vhw_241, BlockStmt target_3, VariableAccess target_1) {
	target_1.getTarget()=vhw_241
	and target_1.getParent().(IfStmt).getThen()=target_3
}

predicate func_2(Parameter vadapter_239, AddressOfExpr target_2) {
	target_2.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="sbands"
	and target_2.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vadapter_239
	and target_2.getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("nl80211_band")
}

predicate func_3(Variable vhw_241, BlockStmt target_3) {
	target_3.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ieee80211_stop_queues")
	and target_3.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhw_241
	and target_3.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ieee80211_unregister_hw")
	and target_3.getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhw_241
	and target_3.getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ieee80211_free_hw")
	and target_3.getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vhw_241
}

from Function func, Variable vhw_241, Parameter vadapter_239, VariableAccess target_1, AddressOfExpr target_2, BlockStmt target_3
where
not func_0(vadapter_239, target_1, target_2)
and func_1(vhw_241, target_3, target_1)
and func_2(vadapter_239, target_2)
and func_3(vhw_241, target_3)
and vhw_241.getType().hasName("ieee80211_hw *")
and vadapter_239.getType().hasName("rsi_hw *")
and vhw_241.(LocalVariable).getFunction() = func
and vadapter_239.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
