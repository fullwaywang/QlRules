/**
 * @name linux-0b7808818cb9df6680f98996b8e9a439fa7bcc2f-bss_ref_get
 * @id cpp/linux/0b7808818cb9df6680f98996b8e9a439fa7bcc2f/bss-ref-get
 * @description linux-0b7808818cb9df6680f98996b8e9a439fa7bcc2f-bss_ref_get CVE-2022-42720
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("bss_from_pub")
		and target_0.getArgument(0) instanceof ValueFieldAccess
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Function func) {
	exists(FunctionCall target_1 |
		target_1.getTarget().hasName("bss_from_pub")
		and target_1.getArgument(0) instanceof ValueFieldAccess
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(Parameter vbss_141, ValueFieldAccess target_2) {
		target_2.getTarget().getName()="hidden_beacon_bss"
		and target_2.getQualifier().(PointerFieldAccess).getTarget().getName()="pub"
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
}

predicate func_3(Parameter vbss_141, ValueFieldAccess target_3) {
		target_3.getTarget().getName()="transmitted_bss"
		and target_3.getQualifier().(PointerFieldAccess).getTarget().getName()="pub"
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
}

predicate func_4(Parameter vbss_141, Variable v__mptr_147, AssignExpr target_4) {
		target_4.getLValue().(VariableAccess).getTarget()=vbss_141
		and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_147
		and target_4.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="104"
}

/*predicate func_7(Variable v__mptr_147, PointerArithmeticOperation target_7) {
		target_7.getLeftOperand().(VariableAccess).getTarget()=v__mptr_147
		and target_7.getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="104"
}

*/
predicate func_8(Parameter vbss_141, ValueFieldAccess target_16, ValueFieldAccess target_2, ValueFieldAccess target_17, ExprStmt target_8) {
		target_8.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
		and target_8.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
		and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_8.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_8.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

/*predicate func_9(Parameter vbss_141, ValueFieldAccess target_2, ValueFieldAccess target_17, VariableAccess target_9) {
		target_9.getTarget()=vbss_141
		and target_2.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getLocation())
		and target_9.getLocation().isBefore(target_17.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_10(Parameter vbss_141, Variable v__mptr_153, ValueFieldAccess target_17, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbss_141
		and target_10.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_153
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
}

/*predicate func_13(Variable v__mptr_153, ExprStmt target_13) {
		target_13.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_153
		and target_13.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="104"
}

*/
predicate func_14(Parameter vbss_141, ValueFieldAccess target_17, ValueFieldAccess target_3, ExprStmt target_14) {
		target_14.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="refcount"
		and target_14.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_17
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_14.getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

/*predicate func_15(Parameter vbss_141, ValueFieldAccess target_3, VariableAccess target_15) {
		target_15.getTarget()=vbss_141
		and target_3.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getLocation())
}

*/
predicate func_16(Parameter vbss_141, ValueFieldAccess target_16) {
		target_16.getTarget().getName()="hidden_beacon_bss"
		and target_16.getQualifier().(PointerFieldAccess).getTarget().getName()="pub"
		and target_16.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
}

predicate func_17(Parameter vbss_141, ValueFieldAccess target_17) {
		target_17.getTarget().getName()="transmitted_bss"
		and target_17.getQualifier().(PointerFieldAccess).getTarget().getName()="pub"
		and target_17.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vbss_141
}

from Function func, Parameter vbss_141, Variable v__mptr_147, Variable v__mptr_153, ValueFieldAccess target_2, ValueFieldAccess target_3, AssignExpr target_4, ExprStmt target_8, ExprStmt target_10, ExprStmt target_14, ValueFieldAccess target_16, ValueFieldAccess target_17
where
not func_0(func)
and not func_1(func)
and func_2(vbss_141, target_2)
and func_3(vbss_141, target_3)
and func_4(vbss_141, v__mptr_147, target_4)
and func_8(vbss_141, target_16, target_2, target_17, target_8)
and func_10(vbss_141, v__mptr_153, target_17, target_10)
and func_14(vbss_141, target_17, target_3, target_14)
and func_16(vbss_141, target_16)
and func_17(vbss_141, target_17)
and vbss_141.getType().hasName("cfg80211_internal_bss *")
and v__mptr_147.getType().hasName("void *")
and v__mptr_153.getType().hasName("void *")
and vbss_141.getFunction() = func
and v__mptr_147.(LocalVariable).getFunction() = func
and v__mptr_153.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
