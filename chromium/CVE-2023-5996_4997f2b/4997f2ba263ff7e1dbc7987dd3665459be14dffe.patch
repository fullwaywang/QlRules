commit 4997f2ba263ff7e1dbc7987dd3665459be14dffe	4997f2ba263ff7e1dbc7987dd3665459be14dffe
Author: Hongchan Choi <hongchan@chromium.org>
Date:   Tue Oct 31 20:59:10 2023 +0000

    Check context status before recreating platform destination
    
    Changing the channel count in the RealtimeAudioDestinationHandler will
    trigger the recreation of the platform destination. This in turn can
    activate the audio rendering thread.
    
    This CL adds a check to prevent this from happening after the handler
    is garbage collected.
    
    Bug: 1497859
    Test: Locally confirmed with ASAN
    Change-Id: I5d2649f3fd3639779ae40b0ca4ef2fe305653421
    Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/4995928
    Commit-Queue: Hongchan Choi <hongchan@chromium.org>
    Reviewed-by: Michael Wilson <mjwilson@chromium.org>
    Cr-Commit-Position: refs/heads/main@{#1217868}

diff --git a/third_party/blink/renderer/modules/webaudio/realtime_audio_destination_handler.cc b/third_party/blink/renderer/modules/webaudio/realtime_audio_destination_handler.cc
index 6781dcff462db..2e4757d155800 100644
--- a/third_party/blink/renderer/modules/webaudio/realtime_audio_destination_handler.cc
+++ b/third_party/blink/renderer/modules/webaudio/realtime_audio_destination_handler.cc
@@ -118,12 +118,21 @@ void RealtimeAudioDestinationHandler::SetChannelCount(
   uint32_t old_channel_count = ChannelCount();
   AudioHandler::SetChannelCount(channel_count, exception_state);
 
-  // Stop, re-create and start the destination to apply the new channel count.
-  if (ChannelCount() != old_channel_count && !exception_state.HadException()) {
-    StopPlatformDestination();
-    CreatePlatformDestination();
-    StartPlatformDestination();
+  // After the context is closed, changing channel count will be ignored
+  // because it will trigger the recreation of the platform destination. This
+  // in turn can activate the audio rendering thread.
+  AudioContext* context = static_cast<AudioContext*>(Context());
+  CHECK(context);
+  if (context->ContextState() == AudioContext::kClosed ||
+      ChannelCount() == old_channel_count ||
+      exception_state.HadException()) {
+    return;
   }
+
+  // Stop, re-create and start the destination to apply the new channel count.
+  StopPlatformDestination();
+  CreatePlatformDestination();
+  StartPlatformDestination();
 }
 
 void RealtimeAudioDestinationHandler::StartRendering() {
