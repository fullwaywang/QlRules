/**
 * @name linux-b12fece4c64857e5fab4290bf01b2e0317a88456-hid_validate_values
 * @id cpp/linux/b12fece4c64857e5fab4290bf01b2e0317a88456/hid-validate-values
 * @description linux-b12fece4c64857e5fab4290bf01b2e0317a88456-hid_validate_values CVE-2023-1073
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_2(Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("list_head *")
		and target_2.getExpr().(ConditionalExpr).getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getType().hasName("list_head *")
		and target_2.getExpr().(ConditionalExpr).getThen().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
		and target_2.getExpr().(ConditionalExpr).getElse().(Literal).getValue()="0"
		and target_2.getEnclosingFunction() = func)
}

predicate func_4(Variable v__mptr_996, ExprStmt target_4) {
		target_4.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_996
		and target_4.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
}

predicate func_5(Parameter vhid_969, Parameter vtype_970, ValueFieldAccess target_5) {
		target_5.getTarget().getName()="report_list"
		and target_5.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="report_enum"
		and target_5.getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_969
		and target_5.getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vtype_970
}

predicate func_6(Function func, ValueFieldAccess target_6) {
		target_6.getTarget().getName()="next"
		and target_6.getQualifier() instanceof ValueFieldAccess
		and target_6.getEnclosingFunction() = func
}

from Function func, Parameter vhid_969, Parameter vtype_970, Variable v__mptr_996, ExprStmt target_4, ValueFieldAccess target_5, ValueFieldAccess target_6
where
not func_2(func)
and func_4(v__mptr_996, target_4)
and func_5(vhid_969, vtype_970, target_5)
and func_6(func, target_6)
and vhid_969.getType().hasName("hid_device *")
and vtype_970.getType().hasName("hid_report_type")
and v__mptr_996.getType().hasName("void *")
and vhid_969.getFunction() = func
and vtype_970.getFunction() = func
and v__mptr_996.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
