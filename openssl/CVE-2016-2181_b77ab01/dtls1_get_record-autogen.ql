/**
 * @name openssl-b77ab018b79a00f789b0fb85596b446b08be4c9d-dtls1_get_record
 * @id cpp/openssl/b77ab018b79a00f789b0fb85596b446b08be4c9d/dtls1-get-record
 * @description openssl-b77ab018b79a00f789b0fb85596b446b08be4c9d-ssl/d1_pkt.c-dtls1_get_record CVE-2016-2181
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vs_586, BlockStmt target_8, ExprStmt target_9, ExprStmt target_10, FunctionCall target_0) {
		target_0.getTarget().hasName("dtls1_process_record")
		and not target_0.getTarget().hasName("dtls1_process_buffered_records")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_0.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_8
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getArgument(0).(VariableAccess).getLocation())
		and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_1(Variable vbitmap_593, Parameter vs_586, BlockStmt target_8, LogicalAndExpr target_11, ExprStmt target_7, AddressOfExpr target_12, ExprStmt target_9) {
	exists(NotExpr target_1 |
		target_1.getOperand().(FunctionCall).getTarget().hasName("dtls1_process_record")
		and target_1.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_1.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbitmap_593
		and target_1.getParent().(IfStmt).getThen()=target_8
		and target_11.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_1.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_1.getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_1.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vs_586, ReturnStmt target_13, FunctionCall target_2) {
		target_2.getTarget().hasName("dtls1_process_buffered_records")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_2.getParent().(LTExpr).getGreaterOperand() instanceof Literal
		and target_2.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_13
}

predicate func_3(Parameter vs_586, VariableAccess target_3) {
		target_3.getTarget()=vs_586
		and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Variable vbitmap_593, VariableAccess target_4) {
		target_4.getTarget()=vbitmap_593
		and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(ReturnStmt target_13, Function func, RelationalOperation target_5) {
		 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
		and target_5.getLesserOperand() instanceof FunctionCall
		and target_5.getGreaterOperand().(Literal).getValue()="0"
		and target_5.getParent().(IfStmt).getThen()=target_13
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Variable vbitmap_593, Parameter vs_586, LogicalAndExpr target_14, LogicalAndExpr target_11, ExprStmt target_7, AddressOfExpr target_12, ExprStmt target_9, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("dtls1_record_bitmap_update")
		and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbitmap_593
		and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
		and target_11.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_7(Variable vbitmap_593, Parameter vs_586, ExprStmt target_6, ExprStmt target_10, Function func, ExprStmt target_7) {
		target_7.getExpr().(FunctionCall).getTarget().hasName("dtls1_record_bitmap_update")
		and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_7.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbitmap_593
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
		and target_6.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
		and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_8(Parameter vs_586, NotExpr target_15, BlockStmt target_8) {
		target_8.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="length"
		and target_8.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("SSL3_RECORD *")
		and target_8.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_8.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="packet_length"
		and target_8.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_8.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_8.getParent().(IfStmt).getCondition()=target_15
}

predicate func_9(Parameter vs_586, VariableAccess target_16, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="packet_length"
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_9.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_9.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
}

predicate func_10(Parameter vs_586, NotExpr target_15, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="packet_length"
		and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_10.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_11(Variable vbitmap_593, Parameter vs_586, LogicalAndExpr target_11) {
		target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="listen"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="type"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="22"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="packet_length"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(LogicalAndExpr).getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="13"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="packet"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="13"
		and target_11.getAnOperand().(NotExpr).getOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="1"
		and target_11.getAnOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("dtls1_record_replay_check")
		and target_11.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_11.getAnOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vbitmap_593
}

predicate func_12(Parameter vs_586, AddressOfExpr target_12) {
		target_12.getOperand().(PointerFieldAccess).getTarget().getName()="unprocessed_rcds"
		and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_12.getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
}

predicate func_13(RelationalOperation target_5, Function func, ReturnStmt target_13) {
		target_13.getExpr().(UnaryMinusExpr).getValue()="-1"
		and target_13.getParent().(IfStmt).getCondition()=target_5
		and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vs_586, LogicalAndExpr target_14) {
		target_14.getAnOperand().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("SSL_state")
		and target_14.getAnOperand().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vs_586
		and target_14.getAnOperand().(LogicalOrExpr).getAnOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="12288"
		and target_14.getAnOperand().(LogicalOrExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="in_handshake"
		and target_14.getAnOperand().(LogicalOrExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
		and target_14.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="listen"
		and target_14.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_14.getAnOperand().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vs_586
}

predicate func_15(Function func, NotExpr target_15) {
		target_15.getOperand() instanceof FunctionCall
		and target_15.getEnclosingFunction() = func
}

predicate func_16(Variable vis_next_epoch_594, VariableAccess target_16) {
		target_16.getTarget()=vis_next_epoch_594
}

from Function func, Variable vbitmap_593, Variable vis_next_epoch_594, Parameter vs_586, FunctionCall target_0, FunctionCall target_2, VariableAccess target_3, VariableAccess target_4, RelationalOperation target_5, ExprStmt target_6, ExprStmt target_7, BlockStmt target_8, ExprStmt target_9, ExprStmt target_10, LogicalAndExpr target_11, AddressOfExpr target_12, ReturnStmt target_13, LogicalAndExpr target_14, NotExpr target_15, VariableAccess target_16
where
func_0(vs_586, target_8, target_9, target_10, target_0)
and not func_1(vbitmap_593, vs_586, target_8, target_11, target_7, target_12, target_9)
and func_2(vs_586, target_13, target_2)
and func_3(vs_586, target_3)
and func_4(vbitmap_593, target_4)
and func_5(target_13, func, target_5)
and func_6(vbitmap_593, vs_586, target_14, target_11, target_7, target_12, target_9, target_6)
and func_7(vbitmap_593, vs_586, target_6, target_10, func, target_7)
and func_8(vs_586, target_15, target_8)
and func_9(vs_586, target_16, target_9)
and func_10(vs_586, target_15, target_10)
and func_11(vbitmap_593, vs_586, target_11)
and func_12(vs_586, target_12)
and func_13(target_5, func, target_13)
and func_14(vs_586, target_14)
and func_15(func, target_15)
and func_16(vis_next_epoch_594, target_16)
and vbitmap_593.getType().hasName("DTLS1_BITMAP *")
and vis_next_epoch_594.getType().hasName("unsigned int")
and vs_586.getType().hasName("SSL *")
and vbitmap_593.(LocalVariable).getFunction() = func
and vis_next_epoch_594.(LocalVariable).getFunction() = func
and vs_586.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
