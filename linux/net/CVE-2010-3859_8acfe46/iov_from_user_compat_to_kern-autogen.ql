/**
 * @name linux-8acfe468b0384e834a303f08ebc4953d72fb690a-iov_from_user_compat_to_kern
 * @id cpp/linux/8acfe468b0384e834a303f08ebc4953d72fb690a/iov-from-user-compat-to-kern
 * @description linux-8acfe468b0384e834a303f08ebc4953d72fb690a-net/compat.c-iov_from_user_compat_to_kern CVE-2010-4160
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(LogicalOrExpr target_6, Function func) {
	exists(ReturnStmt target_0 |
		target_0.getExpr() instanceof UnaryMinusExpr
		and target_0.getParent().(IfStmt).getCondition()=target_6
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable vtot_len_37, Variable vlen_41) {
	exists(IfStmt target_1 |
		target_1.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_41
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(SubExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="2147483647"
		and target_1.getCondition().(RelationalOperation).getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vtot_len_37
		and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_41
		and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="2147483647"
		and target_1.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vtot_len_37)
}

/*predicate func_2(Variable vtot_len_37, Variable vlen_41, ExprStmt target_9) {
	exists(AssignExpr target_2 |
		target_2.getLValue().(VariableAccess).getTarget()=vlen_41
		and target_2.getRValue().(SubExpr).getLeftOperand().(BinaryBitwiseOperation).getValue()="2147483647"
		and target_2.getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vtot_len_37
		and target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_2.getLValue().(VariableAccess).getLocation()))
}

*/
predicate func_3(Variable vtot_len_37, UnaryMinusExpr target_3) {
		target_3.getValue()="-14"
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtot_len_37
}

predicate func_4(Variable vtot_len_37, AssignExpr target_4) {
		target_4.getLValue().(VariableAccess).getTarget()=vtot_len_37
		and target_4.getRValue() instanceof UnaryMinusExpr
}

predicate func_5(LogicalOrExpr target_6, Function func, BreakStmt target_5) {
		target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_6
		and target_5.getEnclosingFunction() = func
}

predicate func_6(Function func, LogicalOrExpr target_6) {
		target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(Literal).getValue()="0"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("might_fault")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getExpr().(SizeofExprOperator).getValue()="4"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(0).(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="2"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(0).(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(Literal).getValue()="0"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("might_fault")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getExpr().(SizeofExprOperator).getValue()="4"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(0).(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(1).(AsmStmt).getChild(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="2"
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(0).(VariableAccess).getTarget().getType().hasName("int")
		and target_6.getAnOperand().(StmtExpr).getStmt().(BlockStmt).getStmt(4).(SwitchStmt).getStmt().(BlockStmt).getStmt(4).(AsmStmt).getChild(1).(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_6.getEnclosingFunction() = func
}

predicate func_9(Variable vlen_41, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_41
		and target_9.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("unsigned long")
}

from Function func, Variable vtot_len_37, Variable vlen_41, UnaryMinusExpr target_3, AssignExpr target_4, BreakStmt target_5, LogicalOrExpr target_6, ExprStmt target_9
where
not func_0(target_6, func)
and not func_1(vtot_len_37, vlen_41)
and func_3(vtot_len_37, target_3)
and func_4(vtot_len_37, target_4)
and func_5(target_6, func, target_5)
and func_6(func, target_6)
and func_9(vlen_41, target_9)
and vtot_len_37.getType().hasName("int")
and vlen_41.getType().hasName("compat_size_t")
and vtot_len_37.(LocalVariable).getFunction() = func
and vlen_41.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
