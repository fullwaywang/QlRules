commit 3fb61718bcbe309279205d1cc275a6435611dc77
Author: Abhinav Kumar <quic_abhinavk@quicinc.com>
Date:   Wed Jul 31 12:17:22 2024 -0700

    drm/msm/dpu: move dpu_encoder's connector assignment to atomic_enable()
    
    [ Upstream commit aedf02e46eb549dac8db4821a6b9f0c6bf6e3990 ]
    
    For cases where the crtc's connectors_changed was set without enable/active
    getting toggled , there is an atomic_enable() call followed by an
    atomic_disable() but without an atomic_mode_set().
    
    This results in a NULL ptr access for the dpu_encoder_get_drm_fmt() call in
    the atomic_enable() as the dpu_encoder's connector was cleared in the
    atomic_disable() but not re-assigned as there was no atomic_mode_set() call.
    
    Fix the NULL ptr access by moving the assignment for atomic_enable() and also
    use drm_atomic_get_new_connector_for_encoder() to get the connector from
    the atomic_state.
    
    Fixes: 25fdd5933e4c ("drm/msm: Add SDM845 DPU support")
    Reported-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
    Closes: https://gitlab.freedesktop.org/drm/msm/-/issues/59
    Suggested-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
    Reviewed-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org>
    Tested-by: Dmitry Baryshkov <dmitry.baryshkov@linaro.org> # SM8350-HDK
    Patchwork: https://patchwork.freedesktop.org/patch/606729/
    Link: https://lore.kernel.org/r/20240731191723.3050932-1-quic_abhinavk@quicinc.com
    Signed-off-by: Abhinav Kumar <quic_abhinavk@quicinc.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

diff --git a/drivers/gpu/drm/msm/disp/dpu1/dpu_encoder.c b/drivers/gpu/drm/msm/disp/dpu1/dpu_encoder.c
index 0c5758804464..6262ec5e4020 100644
--- a/drivers/gpu/drm/msm/disp/dpu1/dpu_encoder.c
+++ b/drivers/gpu/drm/msm/disp/dpu1/dpu_encoder.c
@@ -1119,8 +1119,6 @@ static void dpu_encoder_virt_atomic_mode_set(struct drm_encoder *drm_enc,
 
 	cstate->num_mixers = num_lm;
 
-	dpu_enc->connector = conn_state->connector;
-
 	for (i = 0; i < dpu_enc->num_phys_encs; i++) {
 		struct dpu_encoder_phys *phys = dpu_enc->phys_encs[i];
 
@@ -1216,6 +1214,8 @@ static void dpu_encoder_virt_atomic_enable(struct drm_encoder *drm_enc,
 
 	dpu_enc->commit_done_timedout = false;
 
+	dpu_enc->connector = drm_atomic_get_new_connector_for_encoder(state, drm_enc);
+
 	cur_mode = &dpu_enc->base.crtc->state->adjusted_mode;
 
 	trace_dpu_enc_enable(DRMID(drm_enc), cur_mode->hdisplay,
