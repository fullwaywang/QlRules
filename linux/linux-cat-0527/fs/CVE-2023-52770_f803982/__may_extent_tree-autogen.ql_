/**
 * @name linux-f803982190f0265fd36cf84670aa6daefc2b0768-__may_extent_tree
 * @id cpp/linux/f803982190f0265fd36cf84670aa6daefc2b0768/--may-extent-tree
 * @description linux-f803982190f0265fd36cf84670aa6daefc2b0768-fs/f2fs/extent_cache.c-__may_extent_tree CVE-2023-52770
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_2(Parameter vinode_114, Parameter vtype_114, AddressOfExpr target_5, FunctionCall target_4, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vtype_114
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("is_inode_flag_set")
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_114
	and target_2.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("is_inode_flag_set")
	and target_2.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_114
	and target_2.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("f2fs_sb_has_readonly")
	and target_2.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("F2FS_I_SB")
	and target_2.getElse().(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vtype_114
	and target_2.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("is_inode_flag_set")
	and target_2.getElse().(IfStmt).getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_114
	and target_2.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("is_file")
	and target_2.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_114
	and target_2.getElse().(IfStmt).getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="1"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getFollowingStmt() instanceof ReturnStmt
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_2.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
exists(ReturnStmt target_3 |
	func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_4(Parameter vinode_114, Parameter vtype_114, FunctionCall target_4) {
	target_4.getTarget().hasName("__init_may_extent_tree")
	and target_4.getArgument(0).(VariableAccess).getTarget()=vinode_114
	and target_4.getArgument(1).(VariableAccess).getTarget()=vtype_114
}

predicate func_5(Parameter vinode_114, AddressOfExpr target_5) {
	target_5.getOperand().(PointerFieldAccess).getTarget().getName()="s_list"
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("F2FS_I_SB")
	and target_5.getOperand().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vinode_114
}

from Function func, Parameter vinode_114, Parameter vtype_114, FunctionCall target_4, AddressOfExpr target_5
where
not func_0(func)
and not func_2(vinode_114, vtype_114, target_5, target_4, func)
and not func_3(func)
and func_4(vinode_114, vtype_114, target_4)
and func_5(vinode_114, target_5)
and vinode_114.getType().hasName("inode *")
and vtype_114.getType().hasName("extent_type")
and vinode_114.getFunction() = func
and vtype_114.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
