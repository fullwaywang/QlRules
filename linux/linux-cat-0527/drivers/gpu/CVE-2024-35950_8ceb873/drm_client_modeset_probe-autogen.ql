/**
 * @name linux-8ceb873d816786a7c8058f50d903574aff8d3764-drm_client_modeset_probe
 * @id cpp/linux/8ceb873d816786a7c8058f50d903574aff8d3764/drm-client-modeset-probe
 * @description linux-8ceb873d816786a7c8058f50d903574aff8d3764-drivers/gpu/drm/drm_client_modeset.c-drm_client_modeset_probe CVE-2024-35950
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdev_776, ExprStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="mutex"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="mode_config"
	and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_776
	and target_0.getLocation().isBefore(target_1.getLocation())
}

predicate func_1(Function func, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("drm_client_modeset_release")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("drm_client_dev *")
	and target_1.getEnclosingFunction() = func
}

from Function func, Variable vdev_776, ExprStmt target_0, ExprStmt target_1
where
func_0(vdev_776, target_1, target_0)
and func_1(func, target_1)
and vdev_776.getType().hasName("drm_device *")
and vdev_776.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
