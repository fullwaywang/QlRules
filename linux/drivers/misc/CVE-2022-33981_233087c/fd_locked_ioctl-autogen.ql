/**
 * @name linux-233087ca063686964a53c829d547c7571e3f67bf-fd_locked_ioctl
 * @id cpp/linux/233087ca063686964a53c829d547c7571e3f67bf/fd-locked-ioctl
 * @description linux-233087ca063686964a53c829d547c7571e3f67bf-drivers/block/floppy.c-fd_locked_ioctl CVE-2022-33981
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcmd_3367, Parameter vparam_3368, Variable vi_3372, FunctionCall target_0) {
	target_0.getTarget().hasName("raw_cmd_ioctl")
	and not target_0.getTarget().hasName("floppy_raw_cmd_ioctl")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vcmd_3367
	and target_0.getArgument(1).(VariableAccess).getTarget()=vparam_3368
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_3372
}

predicate func_1(Variable vdrive_3370, ExprStmt target_7, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("lock_fdc")
	and target_1.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdrive_3370
	and target_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-4"
	and target_1.getLocation().isBefore(target_7.getLocation())
}

predicate func_2(IfStmt target_9, Function func, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("process_fd_request")
	and target_9.getLocation().isBefore(target_2.getLocation())
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Variable vtype_3371, ReturnStmt target_13, VariableAccess target_3) {
	target_3.getTarget()=vtype_3371
	and target_3.getParent().(IfStmt).getThen()=target_13
}

predicate func_4(Variable vdrive_3370, VariableAccess target_4) {
	target_4.getTarget()=vdrive_3370
	and target_4.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vtype_3371, VariableAccess target_14, IfStmt target_6) {
	target_6.getCondition().(VariableAccess).getTarget()=vtype_3371
	and target_6.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_6.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
}

predicate func_7(Variable vdrive_3370, VariableAccess target_14, ExprStmt target_7) {
	target_7.getExpr().(FunctionCall).getTarget().hasName("set_floppy")
	and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdrive_3370
	and target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
}

predicate func_8(Variable vi_3372, VariableAccess target_14, ExprStmt target_8) {
	target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_3372
	and target_8.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_8.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
}

predicate func_9(Variable vi_3372, VariableAccess target_14, IfStmt target_9) {
	target_9.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vi_3372
	and target_9.getCondition().(EqualityOperation).getRightOperand().(UnaryMinusExpr).getValue()="-4"
	and target_9.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-4"
	and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
}

predicate func_10(Variable vi_3372, EqualityOperation target_15, VariableAccess target_10) {
	target_10.getTarget()=vi_3372
	and target_15.getLeftOperand().(VariableAccess).getLocation().isBefore(target_10.getLocation())
}

predicate func_11(Variable vdrive_3370, VariableAccess target_14, ExprStmt target_7, IfStmt target_11) {
	target_11.getCondition().(FunctionCall).getTarget().hasName("lock_fdc")
	and target_11.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdrive_3370
	and target_11.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-4"
	and target_11.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
	and target_7.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_11.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_12(VariableAccess target_14, Function func, ExprStmt target_12) {
	target_12.getExpr().(FunctionCall).getTarget().hasName("process_fd_request")
	and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_14
	and target_12.getEnclosingFunction() = func
}

predicate func_13(VariableAccess target_3, Function func, ReturnStmt target_13) {
	target_13.getExpr() instanceof UnaryMinusExpr
	and target_13.getParent().(IfStmt).getCondition()=target_3
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vcmd_3367, VariableAccess target_14) {
	target_14.getTarget()=vcmd_3367
}

predicate func_15(Variable vi_3372, EqualityOperation target_15) {
	target_15.getLeftOperand().(VariableAccess).getTarget()=vi_3372
	and target_15.getRightOperand() instanceof UnaryMinusExpr
}

from Function func, Parameter vcmd_3367, Parameter vparam_3368, Variable vdrive_3370, Variable vtype_3371, Variable vi_3372, FunctionCall target_0, IfStmt target_1, ExprStmt target_2, VariableAccess target_3, VariableAccess target_4, DeclStmt target_5, IfStmt target_6, ExprStmt target_7, ExprStmt target_8, IfStmt target_9, VariableAccess target_10, IfStmt target_11, ExprStmt target_12, ReturnStmt target_13, VariableAccess target_14, EqualityOperation target_15
where
func_0(vcmd_3367, vparam_3368, vi_3372, target_0)
and func_1(vdrive_3370, target_7, target_1)
and func_2(target_9, func, target_2)
and func_3(vtype_3371, target_13, target_3)
and func_4(vdrive_3370, target_4)
and func_5(func, target_5)
and func_6(vtype_3371, target_14, target_6)
and func_7(vdrive_3370, target_14, target_7)
and func_8(vi_3372, target_14, target_8)
and func_9(vi_3372, target_14, target_9)
and func_10(vi_3372, target_15, target_10)
and func_11(vdrive_3370, target_14, target_7, target_11)
and func_12(target_14, func, target_12)
and func_13(target_3, func, target_13)
and func_14(vcmd_3367, target_14)
and func_15(vi_3372, target_15)
and vcmd_3367.getType().hasName("unsigned int")
and vparam_3368.getType().hasName("unsigned long")
and vdrive_3370.getType().hasName("int")
and vtype_3371.getType().hasName("int")
and vi_3372.getType().hasName("int")
and vcmd_3367.getFunction() = func
and vparam_3368.getFunction() = func
and vdrive_3370.(LocalVariable).getFunction() = func
and vtype_3371.(LocalVariable).getFunction() = func
and vi_3372.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
