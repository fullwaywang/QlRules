/**
 * @name linux-f29fcfbf6067c0d8c83f84a045da9276c08deac5-__drm_fb_helper_initial_config_and_unlock
 * @id cpp/linux/f29fcfbf6067c0d8c83f84a045da9276c08deac5/--drm-fb-helper-initial-config-and-unlock
 * @description linux-f29fcfbf6067c0d8c83f84a045da9276c08deac5-drivers/gpu/drm/drm_fb_helper.c-__drm_fb_helper_initial_config_and_unlock CVE-2024-41094
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinfo_1838, Variable vdrm_leak_fbdev_smem, Function func, IfStmt target_0) {
	exists(ExprStmt obj_0 | obj_0=target_0.getThen() |
		exists(AssignOrExpr obj_1 | obj_1=obj_0.getExpr() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getLValue() |
				obj_2.getTarget().getName()="flags"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vinfo_1838
			)
			and obj_1.getRValue().(Literal).getValue()="2097152"
		)
	)
	and target_0.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vdrm_leak_fbdev_smem
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

from Function func, Variable vinfo_1838, Variable vdrm_leak_fbdev_smem, IfStmt target_0
where
func_0(vinfo_1838, vdrm_leak_fbdev_smem, func, target_0)
and vinfo_1838.getType().hasName("fb_info *")
and vdrm_leak_fbdev_smem.getType().hasName("bool")
and vinfo_1838.(LocalVariable).getFunction() = func
and not vdrm_leak_fbdev_smem.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
