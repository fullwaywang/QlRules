/**
 * @name linux-50b5d6ad63821cea324a5a7a19854d4de1a0a819-sctp_icmp_proto_unreachable
 * @id cpp/linux/50b5d6ad63821cea324a5a7a19854d4de1a0a819/sctp-icmp-proto-unreachable
 * @description linux-50b5d6ad63821cea324a5a7a19854d4de1a0a819-net/sctp/input.c-sctp_icmp_proto_unreachable CVE-2010-4526
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vsk_437, Parameter vasoc_438, Parameter vt_439, ExprStmt target_1, Function func) {
	exists(IfStmt target_0 |
		target_0.getCondition().(ValueFieldAccess).getTarget().getName()="owned"
		and target_0.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sk_lock"
		and target_0.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_437
		and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("timer_pending")
		and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="proto_unreach_timer"
		and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vt_439
		and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("mod_timer")
		and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sctp_association_hold")
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("timer_pending")
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="proto_unreach_timer"
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getTarget().hasName("del_timer")
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getCondition().(LogicalAndExpr).getAnOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="proto_unreach_timer"
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("sctp_association_put")
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vasoc_438
		and target_0.getElse().(BlockStmt).getStmt(1) instanceof ExprStmt
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
		and target_0.getElse().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vasoc_438, Parameter vt_439, Function func, ExprStmt target_1) {
		target_1.getExpr().(FunctionCall).getTarget().hasName("sctp_do_sm")
		and target_1.getExpr().(FunctionCall).getArgument(1).(FunctionCall).getTarget().hasName("SCTP_ST_OTHER")
		and target_1.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="state"
		and target_1.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vasoc_438
		and target_1.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="ep"
		and target_1.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vasoc_438
		and target_1.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vasoc_438
		and target_1.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vt_439
		and target_1.getExpr().(FunctionCall).getArgument(6).(Literal).getValue()="32"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
}

from Function func, Parameter vsk_437, Parameter vasoc_438, Parameter vt_439, ExprStmt target_1
where
not func_0(vsk_437, vasoc_438, vt_439, target_1, func)
and func_1(vasoc_438, vt_439, func, target_1)
and vsk_437.getType().hasName("sock *")
and vasoc_438.getType().hasName("sctp_association *")
and vt_439.getType().hasName("sctp_transport *")
and vsk_437.getFunction() = func
and vasoc_438.getFunction() = func
and vt_439.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
