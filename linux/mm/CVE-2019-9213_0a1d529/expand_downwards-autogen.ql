/**
 * @name linux-0a1d52994d440e21def1c2174932410b4f2a98a1-expand_downwards
 * @id cpp/linux/0a1d52994d440e21def1c2174932410b4f2a98a1/expand-downwards
 * @description linux-0a1d52994d440e21def1c2174932410b4f2a98a1-mm/mmap.c-expand_downwards CVE-2019-9213
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(Initializer target_0 |
		target_0.getExpr().(Literal).getValue()="0"
		and target_0.getExpr().getEnclosingFunction() = func)
}

predicate func_1(Parameter vaddress_2425, ReturnStmt target_7, ExprStmt target_8, RelationalOperation target_9) {
	exists(RelationalOperation target_1 |
		 (target_1 instanceof GTExpr or target_1 instanceof LTExpr)
		and target_1.getLesserOperand().(VariableAccess).getTarget()=vaddress_2425
		and target_1.getGreaterOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_1.getParent().(IfStmt).getThen()=target_7
		and target_8.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getLesserOperand().(VariableAccess).getLocation())
		and target_1.getLesserOperand().(VariableAccess).getLocation().isBefore(target_9.getLesserOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_2(Function func) {
	exists(UnaryMinusExpr target_2 |
		target_2.getValue()="-1"
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vaddress_2425, VariableAccess target_3) {
		target_3.getTarget()=vaddress_2425
		and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_4(Parameter vaddress_2425, Variable verror_2429, Function func, ExprStmt target_4) {
		target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verror_2429
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("security_mmap_addr")
		and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vaddress_2425
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable verror_2429, ReturnStmt target_7, ExprStmt target_4, VariableAccess target_5) {
		target_5.getTarget()=verror_2429
		and target_5.getParent().(IfStmt).getThen()=target_7
		and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_5.getLocation())
}

predicate func_6(Variable verror_2429, IfStmt target_10, VariableAccess target_6) {
		target_6.getTarget()=verror_2429
		and target_10.getCondition().(VariableAccess).getLocation().isBefore(target_6.getLocation())
}

predicate func_7(Variable verror_2429, ReturnStmt target_7) {
		target_7.getExpr().(VariableAccess).getTarget()=verror_2429
}

predicate func_8(Parameter vaddress_2425, ExprStmt target_8) {
		target_8.getExpr().(AssignAndExpr).getLValue().(VariableAccess).getTarget()=vaddress_2425
		and target_8.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="18446744073709547520"
}

predicate func_9(Parameter vaddress_2425, RelationalOperation target_9) {
		 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
		and target_9.getLesserOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vaddress_2425
		and target_9.getLesserOperand().(SubExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="vm_end"
		and target_9.getLesserOperand().(SubExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("vm_area_struct *")
		and target_9.getGreaterOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
}

predicate func_10(Variable verror_2429, IfStmt target_10) {
		target_10.getCondition().(VariableAccess).getTarget()=verror_2429
		and target_10.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=verror_2429
}

from Function func, Parameter vaddress_2425, Variable verror_2429, VariableAccess target_3, ExprStmt target_4, VariableAccess target_5, VariableAccess target_6, ReturnStmt target_7, ExprStmt target_8, RelationalOperation target_9, IfStmt target_10
where
not func_0(func)
and not func_1(vaddress_2425, target_7, target_8, target_9)
and not func_2(func)
and func_3(vaddress_2425, target_3)
and func_4(vaddress_2425, verror_2429, func, target_4)
and func_5(verror_2429, target_7, target_4, target_5)
and func_6(verror_2429, target_10, target_6)
and func_7(verror_2429, target_7)
and func_8(vaddress_2425, target_8)
and func_9(vaddress_2425, target_9)
and func_10(verror_2429, target_10)
and vaddress_2425.getType().hasName("unsigned long")
and verror_2429.getType().hasName("int")
and vaddress_2425.getFunction() = func
and verror_2429.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
