/**
 * @name libtiff-9a72a69e035ee70ff5c41541c8c61cd97990d018-ChopUpSingleUncompressedStrip
 * @id cpp/libtiff/9a72a69e035ee70ff5c41541c8c61cd97990d018/chopupsingleuncompressedstrip
 * @description libtiff-9a72a69e035ee70ff5c41541c8c61cd97990d018-libtiff/tif_dirread.c-ChopUpSingleUncompressedStrip CVE-2016-10270
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vnstrips32_5506, VariableAccess target_0) {
		target_0.getTarget()=vnstrips32_5506
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_TIFFCheckMalloc")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("TIFF *")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="8"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(StringLiteral).getValue()="for chopped \"StripByteCounts\" array"
}

predicate func_1(Variable vnstrips32_5506, VariableAccess target_1) {
		target_1.getTarget()=vnstrips32_5506
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_TIFFCheckMalloc")
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("TIFF *")
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="8"
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(StringLiteral).getValue()="for chopped \"StripOffsets\" array"
}

predicate func_2(Variable vstrip_5504, Variable vnstrips32_5506, BlockStmt target_20, VariableAccess target_2) {
		target_2.getTarget()=vnstrips32_5506
		and target_2.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vstrip_5504
		and target_2.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_20
}

predicate func_3(Variable vtd_5498, Variable vnstrips32_5506, VariableAccess target_3) {
		target_3.getTarget()=vnstrips32_5506
		and target_3.getParent().(AssignExpr).getRValue() = target_3
		and target_3.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="td_nstrips"
		and target_3.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
}

predicate func_4(Variable vnstrips64_5505, Variable vnstrips32_5506, VariableAccess target_4) {
		target_4.getTarget()=vnstrips32_5506
		and target_4.getParent().(AssignExpr).getLValue() = target_4
		and target_4.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnstrips64_5505
}

predicate func_5(Variable vtd_5498, Variable vnstrips32_5506, Variable vrowsperstrip_5507, RelationalOperation target_21, ExprStmt target_22, ExprStmt target_23) {
	exists(ConditionalExpr target_5 |
		target_5.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="td_imagelength"
		and target_5.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
		and target_5.getCondition().(RelationalOperation).getGreaterOperand().(SubExpr).getLeftOperand().(Literal).getValue()="4294967295"
		and target_5.getCondition().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vrowsperstrip_5507
		and target_5.getCondition().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(SubExpr).getRightOperand() instanceof Literal
		and target_5.getThen().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="td_imagelength"
		and target_5.getThen().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
		and target_5.getThen().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vrowsperstrip_5507
		and target_5.getThen().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
		and target_5.getThen().(DivExpr).getRightOperand().(VariableAccess).getTarget()=vrowsperstrip_5507
		and target_5.getElse().(Literal).getValue()="0"
		and target_5.getParent().(AssignExpr).getRValue() = target_5
		and target_5.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips32_5506
		and target_21.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_22.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_5.getCondition().(RelationalOperation).getGreaterOperand().(SubExpr).getRightOperand().(SubExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_23.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation()))
}

predicate func_7(Variable voffset_5500, Variable vstripbytes_5503, Variable vnstrips64_5505, ExprStmt target_24, ExprStmt target_25, ExprStmt target_26) {
	exists(ConditionalExpr target_7 |
		target_7.getCondition().(VariableAccess).getTarget()=vstripbytes_5503
		and target_7.getThen().(VariableAccess).getTarget()=voffset_5500
		and target_7.getElse().(Literal).getValue()="0"
		and target_7.getParent().(AssignExpr).getRValue() = target_7
		and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips64_5505
		and target_24.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getThen().(VariableAccess).getLocation())
		and target_7.getThen().(VariableAccess).getLocation().isBefore(target_25.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getLocation())
		and target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getCondition().(VariableAccess).getLocation()))
}

predicate func_8(Variable voffset_5500, Variable vstrip_5504, Variable vnewoffsets_5509, ArrayExpr target_8) {
		target_8.getArrayBase().(VariableAccess).getTarget()=vnewoffsets_5509
		and target_8.getArrayOffset().(VariableAccess).getTarget()=vstrip_5504
		and target_8.getParent().(AssignExpr).getLValue() = target_8
		and target_8.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=voffset_5500
}

predicate func_10(Variable vstripbytes_5503, VariableAccess target_10) {
		target_10.getTarget()=vstripbytes_5503
}

/*predicate func_11(Variable voffset_5500, Variable vstrip_5504, Variable vnewoffsets_5509, VariableAccess target_11) {
		target_11.getTarget()=voffset_5500
		and target_11.getParent().(AssignExpr).getRValue() = target_11
		and target_11.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnewoffsets_5509
		and target_11.getParent().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vstrip_5504
}

*/
predicate func_12(Function func, DeclStmt target_12) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Variable vbytecount_5499, Variable vstripbytes_5503, Variable vnstrips64_5505, VariableAccess target_13) {
		target_13.getTarget()=vnstrips64_5505
		and target_13.getParent().(AssignExpr).getLValue() = target_13
		and target_13.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vbytecount_5499
		and target_13.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vstripbytes_5503
		and target_13.getParent().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getRightOperand() instanceof Literal
		and target_13.getParent().(AssignExpr).getRValue().(DivExpr).getRightOperand().(VariableAccess).getTarget()=vstripbytes_5503
}

/*predicate func_14(Variable vbytecount_5499, Variable vstripbytes_5503, Variable vnstrips64_5505, DivExpr target_14) {
		target_14.getLeftOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vbytecount_5499
		and target_14.getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vstripbytes_5503
		and target_14.getLeftOperand().(AddExpr).getAnOperand().(SubExpr).getRightOperand() instanceof Literal
		and target_14.getRightOperand().(VariableAccess).getTarget()=vstripbytes_5503
		and target_14.getParent().(AssignExpr).getRValue() = target_14
		and target_14.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips64_5505
}

*/
predicate func_15(Variable vnstrips64_5505, LogicalOrExpr target_15) {
		target_15.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vnstrips64_5505
		and target_15.getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_15.getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vnstrips64_5505
		and target_15.getAnOperand().(RelationalOperation).getLesserOperand().(HexLiteral).getValue()="4294967295"
		and target_15.getParent().(IfStmt).getThen() instanceof ReturnStmt
}

/*predicate func_16(Variable vnstrips64_5505, ExprStmt target_27, VariableAccess target_16) {
		target_16.getTarget()=vnstrips64_5505
		and target_27.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_16.getLocation())
}

*/
predicate func_17(Variable vnstrips64_5505, Variable vnstrips32_5506, Function func, ExprStmt target_17) {
		target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips32_5506
		and target_17.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnstrips64_5505
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_17
}

/*predicate func_18(Variable vnstrips64_5505, Variable vnstrips32_5506, LogicalOrExpr target_15, ExprStmt target_29, VariableAccess target_18) {
		target_18.getTarget()=vnstrips64_5505
		and target_18.getParent().(AssignExpr).getRValue() = target_18
		and target_18.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips32_5506
		and target_15.getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_18.getLocation())
		and target_18.getParent().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
}

*/
predicate func_19(Variable voffset_5500, AssignExpr target_19) {
		target_19.getLValue() instanceof ArrayExpr
		and target_19.getRValue().(VariableAccess).getTarget()=voffset_5500
}

predicate func_20(Variable vbytecount_5499, Variable vstripbytes_5503, Variable vstrip_5504, BlockStmt target_20) {
		target_20.getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vstripbytes_5503
		and target_20.getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vbytecount_5499
		and target_20.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vstripbytes_5503
		and target_20.getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vbytecount_5499
		and target_20.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(VariableAccess).getTarget().getType().hasName("uint64 *")
		and target_20.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vstrip_5504
		and target_20.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vstripbytes_5503
}

predicate func_21(Variable vtd_5498, Variable vrowsperstrip_5507, RelationalOperation target_21) {
		 (target_21 instanceof GEExpr or target_21 instanceof LEExpr)
		and target_21.getGreaterOperand().(VariableAccess).getTarget()=vrowsperstrip_5507
		and target_21.getLesserOperand().(PointerFieldAccess).getTarget().getName()="td_rowsperstrip"
		and target_21.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
}

predicate func_22(Variable vtd_5498, Variable vnstrips32_5506, ExprStmt target_22) {
		target_22.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="td_stripsperimage"
		and target_22.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
		and target_22.getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="td_nstrips"
		and target_22.getExpr().(AssignExpr).getRValue().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
		and target_22.getExpr().(AssignExpr).getRValue().(AssignExpr).getRValue().(VariableAccess).getTarget()=vnstrips32_5506
}

predicate func_23(Variable vrowsperstrip_5507, ExprStmt target_23) {
		target_23.getExpr().(FunctionCall).getTarget().hasName("TIFFSetField")
		and target_23.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("TIFF *")
		and target_23.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="278"
		and target_23.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vrowsperstrip_5507
}

predicate func_24(Variable vtd_5498, Variable voffset_5500, ExprStmt target_24) {
		target_24.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_5500
		and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="td_stripoffset"
		and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtd_5498
		and target_24.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
}

predicate func_25(Variable voffset_5500, Variable vstripbytes_5503, ExprStmt target_25) {
		target_25.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=voffset_5500
		and target_25.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vstripbytes_5503
}

predicate func_26(Variable vstripbytes_5503, ExprStmt target_26) {
		target_26.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vstripbytes_5503
		and target_26.getExpr().(AssignExpr).getRValue().(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("uint32")
		and target_26.getExpr().(AssignExpr).getRValue().(MulExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("uint64")
}

predicate func_27(Variable vnstrips64_5505, ExprStmt target_27) {
		target_27.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnstrips64_5505
		and target_27.getExpr().(AssignExpr).getRValue() instanceof DivExpr
}

predicate func_29(Variable vnstrips32_5506, ExprStmt target_29) {
		target_29.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("uint64 *")
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("_TIFFCheckMalloc")
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("TIFF *")
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnstrips32_5506
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="8"
		and target_29.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(StringLiteral).getValue()="for chopped \"StripByteCounts\" array"
}

from Function func, Variable vtd_5498, Variable vbytecount_5499, Variable voffset_5500, Variable vstripbytes_5503, Variable vstrip_5504, Variable vnstrips64_5505, Variable vnstrips32_5506, Variable vrowsperstrip_5507, Variable vnewoffsets_5509, VariableAccess target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_4, ArrayExpr target_8, VariableAccess target_10, DeclStmt target_12, VariableAccess target_13, LogicalOrExpr target_15, ExprStmt target_17, AssignExpr target_19, BlockStmt target_20, RelationalOperation target_21, ExprStmt target_22, ExprStmt target_23, ExprStmt target_24, ExprStmt target_25, ExprStmt target_26, ExprStmt target_27, ExprStmt target_29
where
func_0(vnstrips32_5506, target_0)
and func_1(vnstrips32_5506, target_1)
and func_2(vstrip_5504, vnstrips32_5506, target_20, target_2)
and func_3(vtd_5498, vnstrips32_5506, target_3)
and func_4(vnstrips64_5505, vnstrips32_5506, target_4)
and not func_5(vtd_5498, vnstrips32_5506, vrowsperstrip_5507, target_21, target_22, target_23)
and not func_7(voffset_5500, vstripbytes_5503, vnstrips64_5505, target_24, target_25, target_26)
and func_8(voffset_5500, vstrip_5504, vnewoffsets_5509, target_8)
and func_10(vstripbytes_5503, target_10)
and func_12(func, target_12)
and func_13(vbytecount_5499, vstripbytes_5503, vnstrips64_5505, target_13)
and func_15(vnstrips64_5505, target_15)
and func_17(vnstrips64_5505, vnstrips32_5506, func, target_17)
and func_19(voffset_5500, target_19)
and func_20(vbytecount_5499, vstripbytes_5503, vstrip_5504, target_20)
and func_21(vtd_5498, vrowsperstrip_5507, target_21)
and func_22(vtd_5498, vnstrips32_5506, target_22)
and func_23(vrowsperstrip_5507, target_23)
and func_24(vtd_5498, voffset_5500, target_24)
and func_25(voffset_5500, vstripbytes_5503, target_25)
and func_26(vstripbytes_5503, target_26)
and func_27(vnstrips64_5505, target_27)
and func_29(vnstrips32_5506, target_29)
and vtd_5498.getType().hasName("TIFFDirectory *")
and vbytecount_5499.getType().hasName("uint64")
and voffset_5500.getType().hasName("uint64")
and vstripbytes_5503.getType().hasName("uint64")
and vstrip_5504.getType().hasName("uint32")
and vnstrips64_5505.getType().hasName("uint64")
and vnstrips32_5506.getType().hasName("uint32")
and vrowsperstrip_5507.getType().hasName("uint32")
and vnewoffsets_5509.getType().hasName("uint64 *")
and vtd_5498.(LocalVariable).getFunction() = func
and vbytecount_5499.(LocalVariable).getFunction() = func
and voffset_5500.(LocalVariable).getFunction() = func
and vstripbytes_5503.(LocalVariable).getFunction() = func
and vstrip_5504.(LocalVariable).getFunction() = func
and vnstrips64_5505.(LocalVariable).getFunction() = func
and vnstrips32_5506.(LocalVariable).getFunction() = func
and vrowsperstrip_5507.(LocalVariable).getFunction() = func
and vnewoffsets_5509.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
