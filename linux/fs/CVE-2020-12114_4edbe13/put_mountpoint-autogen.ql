/**
 * @name linux-4edbe133f851c9e3a2f2a1db367e826b01e72594-put_mountpoint
 * @id cpp/linux/4edbe133f851c9e3a2f2a1db367e826b01e72594/put-mountpoint
 * @description linux-4edbe133f851c9e3a2f2a1db367e826b01e72594-fs/namespace.c-put_mountpoint CVE-2020-12114
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("__builtin_unreachable")
	and not target_0.getTarget().hasName("__put_mountpoint")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func) {
exists(AddressOfExpr target_1 |
	target_1.getOperand().(VariableAccess).getType().hasName("list_head")
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Parameter vmp_755, VariableAccess target_2) {
	target_2.getTarget()=vmp_755
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_3(Variable vdentry_758, Parameter vmp_755, Function func, IfStmt target_3) {
	target_3.getCondition().(NotExpr).getOperand().(PrefixDecrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="m_count"
	and target_3.getCondition().(NotExpr).getOperand().(PrefixDecrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmp_755
	and target_3.getThen().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_3.getThen().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_3.getThen().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_3.getThen().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="lock"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getTarget().getName()="d_flags"
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdentry_758
	and target_3.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="4294901759"
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="lock"
	and target_3.getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("hlist_del")
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="m_hash"
	and target_3.getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmp_755
	and target_3.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_3.getThen().(BlockStmt).getStmt(6).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmp_755
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(NotExpr target_19, Function func, DeclStmt target_4) {
	target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_4.getEnclosingFunction() = func
}

/*predicate func_5(NotExpr target_19, Function func, DoStmt target_5) {
	target_5.getCondition() instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_5.getEnclosingFunction() = func
}

*/
/*predicate func_6(Function func, IfStmt target_6) {
	target_6.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_6.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("hlist_empty")
	and target_6.getCondition().(FunctionCall).getArgument(1) instanceof Literal
	and target_6.getThen().(DoStmt).getCondition() instanceof Literal
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
	and target_6.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_6.getEnclosingFunction() = func
}

*/
/*predicate func_7(Function func, DoStmt target_7) {
	target_7.getCondition() instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
	and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
	and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, AsmStmt target_8) {
	target_8.getChild(0) instanceof StringLiteral
	and target_8.getChild(1) instanceof Literal
	and target_8.getChild(2) instanceof Literal
	and target_8.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
	and target_8.getChild(3).(SizeofTypeOperator).getValue()="12"
	and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(Function func, DoStmt target_9) {
	target_9.getCondition() instanceof Literal
	and target_9.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="395"
	and target_9.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_9.getEnclosingFunction() = func
}

*/
/*predicate func_10(Function func, StmtExpr target_10) {
	target_10.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="395"
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Function func, AsmStmt target_11) {
	target_11.getChild(0).(Literal).getValue()="395"
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_13(Function func, ExprStmt target_13) {
	target_13.getExpr() instanceof FunctionCall
	and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(NotExpr target_19, Function func, ExprStmt target_14) {
	target_14.getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="lock"
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d_lockref"
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_15(Variable vdentry_758, NotExpr target_19, ExprStmt target_15) {
	target_15.getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getTarget().getName()="d_flags"
	and target_15.getExpr().(AssignAndExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdentry_758
	and target_15.getExpr().(AssignAndExpr).getRValue().(ComplementExpr).getValue()="4294901759"
	and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

*/
/*predicate func_16(NotExpr target_19, Function func, ExprStmt target_16) {
	target_16.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="lock"
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_16.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d_lockref"
	and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
	and target_16.getEnclosingFunction() = func
}

*/
/*predicate func_17(Parameter vmp_755, NotExpr target_19, ExprStmt target_17) {
	target_17.getExpr().(FunctionCall).getTarget().hasName("hlist_del")
	and target_17.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="m_hash"
	and target_17.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmp_755
	and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

*/
/*predicate func_18(Parameter vmp_755, NotExpr target_19, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmp_755
	and target_18.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
}

*/
predicate func_19(Function func, NotExpr target_19) {
	target_19.getOperand() instanceof PrefixDecrExpr
	and target_19.getEnclosingFunction() = func
}

from Function func, Variable vdentry_758, Parameter vmp_755, FunctionCall target_0, VariableAccess target_2, IfStmt target_3, DeclStmt target_4, NotExpr target_19
where
func_0(func, target_0)
and not func_1(func)
and func_2(vmp_755, target_2)
and func_3(vdentry_758, vmp_755, func, target_3)
and func_4(target_19, func, target_4)
and func_19(func, target_19)
and vdentry_758.getType().hasName("dentry *")
and vmp_755.getType().hasName("mountpoint *")
and vdentry_758.(LocalVariable).getFunction() = func
and vmp_755.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
