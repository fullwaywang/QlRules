/**
 * @name linux-10d2bb2e6b1d8c4576c56a748f697dbeb8388899-retrieve_ptr_limit
 * @id cpp/linux/10d2bb2e6b1d8c4576c56a748f697dbeb8388899/retrieve-ptr-limit
 * @description linux-10d2bb2e6b1d8c4576c56a748f697dbeb8388899-kernel/bpf/verifier.c-retrieve_ptr_limit CVE-2020-27171
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(AddExpr target_0 |
	target_0.getLeftOperand() instanceof AddExpr
	and target_0.getRightOperand().(Literal).getValue()="1"
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Function func) {
exists(AddExpr target_1 |
	target_1.getLeftOperand() instanceof AddExpr
	and target_1.getRightOperand().(Literal).getValue()="1"
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Variable voff_5864, AddExpr target_2) {
	target_2.getLeftOperand().(Literal).getValue()="512"
	and target_2.getRightOperand().(VariableAccess).getTarget()=voff_5864
	and target_2.getParent().(AssignExpr).getRValue() = target_2
	and target_2.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
}

predicate func_3(Parameter vptr_reg_5859, AddExpr target_3) {
	target_3.getLeftOperand().(PointerFieldAccess).getTarget().getName()="umax_value"
	and target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vptr_reg_5859
	and target_3.getRightOperand().(PointerFieldAccess).getTarget().getName()="off"
	and target_3.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vptr_reg_5859
	and target_3.getParent().(AssignExpr).getRValue() = target_3
	and target_3.getParent().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget().getType().hasName("u32 *")
}

from Function func, Parameter vptr_reg_5859, Variable voff_5864, AddExpr target_2, AddExpr target_3
where
not func_0(func)
and not func_1(func)
and func_2(voff_5864, target_2)
and func_3(vptr_reg_5859, target_3)
and vptr_reg_5859.getType().hasName("const bpf_reg_state *")
and voff_5864.getType().hasName("u32")
and vptr_reg_5859.getFunction() = func
and voff_5864.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
