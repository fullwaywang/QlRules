/**
 * @name linux-cfa73607eb21a4ce1d6294a2c5733628897b48a2-i915_hwmon_register
 * @id cpp/linux/cfa73607eb21a4ce1d6294a2c5733628897b48a2/i915-hwmon-register
 * @description linux-cfa73607eb21a4ce1d6294a2c5733628897b48a2-drivers/gpu/drm/i915/i915_hwmon.c-i915_hwmon_register CVE-2024-39479
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vdev_784, Variable vddat_787, Variable vhwm_chip_info, Variable vhwm_groups, FunctionCall target_0) {
	exists(PointerFieldAccess obj_0 | obj_0=target_0.getArgument(1) |
		obj_0.getTarget().getName()="name"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vddat_787
	)
	and exists(AssignExpr obj_1 | obj_1=target_0.getParent() |
		obj_1.getRValue() = target_0
		and obj_1.getLValue().(VariableAccess).getTarget().getType().hasName("device *")
	)
	and target_0.getTarget().hasName("devm_hwmon_device_register_with_info")
	and not target_0.getTarget().hasName("hwmon_device_register_with_info")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vdev_784
	and target_0.getArgument(2).(VariableAccess).getTarget()=vddat_787
	and target_0.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhwm_chip_info
	and target_0.getArgument(4).(VariableAccess).getTarget()=vhwm_groups
}

predicate func_1(Variable vdev_784, Variable vddat_gt_788, Variable vhwm_gt_chip_info, FunctionCall target_1) {
	exists(PointerFieldAccess obj_0 | obj_0=target_1.getArgument(1) |
		obj_0.getTarget().getName()="name"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vddat_gt_788
	)
	and exists(AssignExpr obj_1 | obj_1=target_1.getParent() |
		obj_1.getRValue() = target_1
		and obj_1.getLValue().(VariableAccess).getTarget().getType().hasName("device *")
	)
	and target_1.getTarget().hasName("devm_hwmon_device_register_with_info")
	and not target_1.getTarget().hasName("hwmon_device_register_with_info")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vdev_784
	and target_1.getArgument(2).(VariableAccess).getTarget()=vddat_gt_788
	and target_1.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhwm_gt_chip_info
	and target_1.getArgument(4).(Literal).getValue()="0"
}

predicate func_2(Variable vdev_784, FunctionCall target_2) {
	exists(AssignExpr obj_0 | obj_0=target_2.getParent() |
		obj_0.getRValue() = target_2
		and obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("i915_hwmon *")
	)
	and target_2.getTarget().hasName("devm_kzalloc")
	and not target_2.getTarget().hasName("kzalloc")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vdev_784
	and target_2.getArgument(1).(SizeofExprOperator).getValue()="656"
	and target_2.getArgument(2).(BitwiseOrExpr).getValue()="3264"
}

predicate func_3(FunctionCall target_8, Function func) {
exists(GotoStmt target_3 |
	target_3.getName() ="err"
	and target_3.getParent().(IfStmt).getCondition()=target_8
	and target_3.getEnclosingFunction() = func
)
}

predicate func_4(Parameter vi915_782, NotExpr target_9) {
exists(FunctionCall target_4 |
	exists(VariableAccess obj_0 | obj_0=target_4.getArgument(0) |
		obj_0.getTarget()=vi915_782
		and obj_0.getLocation().isBefore(target_9.getOperand().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	)
	and target_4.getTarget().hasName("i915_hwmon_unregister")
)
}

predicate func_5(Parameter vi915_782, VariableAccess target_5) {
	target_5.getTarget()=vi915_782
}

predicate func_6(FunctionCall target_8, Function func, ReturnStmt target_6) {
	target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_8
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Parameter vi915_782, AssignExpr target_7) {
	exists(PointerFieldAccess obj_0 | obj_0=target_7.getLValue() |
		obj_0.getTarget().getName()="hwmon"
		and obj_0.getQualifier().(VariableAccess).getTarget()=vi915_782
	)
	and target_7.getRValue().(Literal).getValue()="0"
}

predicate func_8(BlockStmt target_10, Function func, FunctionCall target_8) {
	target_8.getTarget().hasName("IS_ERR")
	and target_8.getArgument(0).(VariableAccess).getTarget().getType().hasName("device *")
	and target_8.getParent().(IfStmt).getThen()=target_10
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Parameter vi915_782, NotExpr target_9) {
	exists(AssignExpr obj_0 | obj_0=target_9.getOperand() |
		exists(ArrayExpr obj_1 | obj_1=obj_0.getRValue() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getArrayBase() |
				obj_2.getTarget().getName()="gt"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vi915_782
			)
			and obj_1.getArrayOffset().(VariableAccess).getTarget().getType().hasName("int")
		)
		and obj_0.getLValue().(VariableAccess).getTarget().getType().hasName("intel_gt *")
	)
	and target_9.getParent().(IfStmt).getThen() instanceof BlockStmt
}

predicate func_10(Function func, BlockStmt target_10) {
	target_10.getStmt(0).(ExprStmt).getExpr() instanceof AssignExpr
	and target_10.getStmt(1) instanceof ReturnStmt
	and target_10.getEnclosingFunction() = func
}

from Function func, Variable vdev_784, Variable vddat_787, Variable vddat_gt_788, Variable vhwm_chip_info, Variable vhwm_groups, Variable vhwm_gt_chip_info, Parameter vi915_782, FunctionCall target_0, FunctionCall target_1, FunctionCall target_2, VariableAccess target_5, ReturnStmt target_6, AssignExpr target_7, FunctionCall target_8, NotExpr target_9, BlockStmt target_10
where
func_0(vdev_784, vddat_787, vhwm_chip_info, vhwm_groups, target_0)
and func_1(vdev_784, vddat_gt_788, vhwm_gt_chip_info, target_1)
and func_2(vdev_784, target_2)
and not func_3(target_8, func)
and not func_4(vi915_782, target_9)
and func_5(vi915_782, target_5)
and func_6(target_8, func, target_6)
and func_7(vi915_782, target_7)
and func_8(target_10, func, target_8)
and func_9(vi915_782, target_9)
and func_10(func, target_10)
and vdev_784.getType().hasName("device *")
and vddat_787.getType().hasName("hwm_drvdata *")
and vddat_gt_788.getType().hasName("hwm_drvdata *")
and vhwm_chip_info.getType().hasName("const hwmon_chip_info")
and vhwm_groups.getType() instanceof ArrayType
and vhwm_gt_chip_info.getType().hasName("const hwmon_chip_info")
and vi915_782.getType().hasName("drm_i915_private *")
and vdev_784.(LocalVariable).getFunction() = func
and vddat_787.(LocalVariable).getFunction() = func
and vddat_gt_788.(LocalVariable).getFunction() = func
and not vhwm_chip_info.getParentScope+() = func
and not vhwm_groups.getParentScope+() = func
and not vhwm_gt_chip_info.getParentScope+() = func
and vi915_782.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
