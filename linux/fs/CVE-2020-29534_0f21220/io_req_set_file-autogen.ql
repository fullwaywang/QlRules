/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_req_set_file
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-req-set-file
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_req_set_file CVE-2020-29534
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, UnaryMinusExpr target_0) {
	target_0.getValue()="-9"
	and target_0.getEnclosingFunction() = func
}

predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("io_uring_task *")
	and target_2.getRValue().(FunctionCall).getTarget().hasName("kmalloc")
	and target_2.getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="256"
	and target_2.getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="3264"
	and target_2.getEnclosingFunction() = func)
}

predicate func_4(Function func) {
exists(ExprStmt target_4 |
	target_4.getExpr().(FunctionCall).getTarget().hasName("xa_init")
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="xa"
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_5(Function func) {
exists(DoStmt target_5 |
	target_5.getCondition() instanceof Literal
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__init_waitqueue_head")
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="wait"
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&tctx->wait"
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("lock_class_key")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_6(Function func) {
exists(ExprStmt target_6 |
	target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="last"
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_6.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_7(Function func) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="in_idle"
	and target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_7.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
	and target_7.getFollowingStmt() instanceof ReturnStmt)
}

/*predicate func_8(Function func) {
exists(PointerFieldAccess target_8 |
	target_8.getTarget().getName()="in_idle"
	and target_8.getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_8.getEnclosingFunction() = func)
}

*/
predicate func_10(Function func) {
exists(ExprStmt target_10 |
	target_10.getExpr().(FunctionCall).getTarget().hasName("atomic_long_set")
	and target_10.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="req_issue"
	and target_10.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_10.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_11(Function func) {
exists(ExprStmt target_11 |
	target_11.getExpr().(FunctionCall).getTarget().hasName("atomic_long_set")
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="req_complete"
	and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("io_uring_task *")
	and target_11.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
	and target_11.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_12(Function func) {
exists(ExprStmt target_12 |
	target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="io_uring"
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("task_struct *")
	and target_12.getExpr().(AssignExpr).getRValue().(VariableAccess).getType().hasName("io_uring_task *")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
	and target_12.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_16(Parameter vreq_6056, Variable vfixed_6059, VariableAccess target_16) {
	target_16.getTarget()=vfixed_6059
	and target_16.getParent().(AssignExpr).getLValue() = target_16
	and target_16.getParent().(AssignExpr).getRValue().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_16.getParent().(AssignExpr).getRValue().(EqualityOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6056
	and target_16.getParent().(AssignExpr).getRValue().(EqualityOperation).getRightOperand() instanceof Literal
}

/*predicate func_17(Parameter vreq_6056, Variable vfixed_6059, EqualityOperation target_17) {
	target_17.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_17.getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6056
	and target_17.getRightOperand() instanceof Literal
	and target_17.getParent().(AssignExpr).getRValue() = target_17
	and target_17.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfixed_6059
}

*/
/*predicate func_18(Parameter vreq_6056, Variable vfixed_6059, LogicalAndExpr target_18) {
	target_18.getLeftOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=vfixed_6059
	and target_18.getRightOperand().(FunctionCall).getTarget().hasName("io_async_submit")
	and target_18.getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="ctx"
	and target_18.getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6056
	and target_18.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_18.getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

*/
/*predicate func_19(Variable vfixed_6059, ExprStmt target_21, FunctionCall target_20, VariableAccess target_19) {
	target_19.getTarget()=vfixed_6059
	and target_19.getParent().(NotExpr).getParent().(LogicalAndExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_19.getParent().(NotExpr).getParent().(LogicalAndExpr).getParent().(NotExpr).getParent().(NotExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_19.getLocation())
	and target_19.getLocation().isBefore(target_20.getArgument(4).(VariableAccess).getLocation())
}

*/
predicate func_20(Parameter vstate_6056, Parameter vreq_6056, Parameter vfd_6057, Variable vfixed_6059, FunctionCall target_20) {
	target_20.getTarget().hasName("io_file_get")
	and target_20.getArgument(0).(VariableAccess).getTarget()=vstate_6056
	and target_20.getArgument(1).(VariableAccess).getTarget()=vreq_6056
	and target_20.getArgument(2).(VariableAccess).getTarget()=vfd_6057
	and target_20.getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="file"
	and target_20.getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_20.getArgument(3).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6056
	and target_20.getArgument(4).(VariableAccess).getTarget()=vfixed_6059
}

predicate func_21(Variable vfixed_6059, ExprStmt target_21) {
	target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfixed_6059
	and target_21.getExpr().(AssignExpr).getRValue() instanceof EqualityOperation
}

from Function func, Parameter vstate_6056, Parameter vreq_6056, Parameter vfd_6057, Variable vfixed_6059, UnaryMinusExpr target_0, VariableAccess target_16, FunctionCall target_20, ExprStmt target_21
where
func_0(func, target_0)
and not func_2(func)
and not func_4(func)
and not func_5(func)
and not func_6(func)
and not func_7(func)
and not func_10(func)
and not func_11(func)
and not func_12(func)
and func_16(vreq_6056, vfixed_6059, target_16)
and func_20(vstate_6056, vreq_6056, vfd_6057, vfixed_6059, target_20)
and func_21(vfixed_6059, target_21)
and vstate_6056.getType().hasName("io_submit_state *")
and vreq_6056.getType().hasName("io_kiocb *")
and vfd_6057.getType().hasName("int")
and vfixed_6059.getType().hasName("bool")
and vstate_6056.getFunction() = func
and vreq_6056.getFunction() = func
and vfd_6057.getFunction() = func
and vfixed_6059.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
