/**
 * @name linux-34beb21594519ce64a55a498c2fe7d567bc1ca20-geneve_xmit_skb
 * @id cpp/linux/34beb21594519ce64a55a498c2fe7d567bc1ca20/geneve-xmit-skb
 * @description linux-34beb21594519ce64a55a498c2fe7d567bc1ca20-geneve_xmit_skb CVE-2020-25645
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vgeneve_879, ExprStmt target_2, ExprStmt target_3) {
	exists(ValueFieldAccess target_0 |
		target_0.getTarget().getName()="tp_dst"
		and target_0.getQualifier().(ValueFieldAccess).getTarget().getName()="key"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="info"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cfg"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgeneve_879
		and target_2.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vgeneve_879, ExprStmt target_2) {
		target_2.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sock4"
		and target_2.getExpr().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgeneve_879
}

predicate func_3(Parameter vgeneve_879, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="protocol"
		and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("eth_type_trans")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("sk_buff *")
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="dev"
		and target_3.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgeneve_879
}

from Function func, Parameter vgeneve_879, ExprStmt target_2, ExprStmt target_3
where
not func_0(vgeneve_879, target_2, target_3)
and func_2(vgeneve_879, target_2)
and func_3(vgeneve_879, target_3)
and vgeneve_879.getType().hasName("geneve_dev *")
and vgeneve_879.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
