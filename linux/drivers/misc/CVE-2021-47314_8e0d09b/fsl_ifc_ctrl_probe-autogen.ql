/**
 * @name linux-8e0d09b1232d0538066c40ed4c13086faccbdff6-fsl_ifc_ctrl_probe
 * @id cpp/linux/8e0d09b1232d0538066c40ed4c13086faccbdff6/fsl-ifc-ctrl-probe
 * @description linux-8e0d09b1232d0538066c40ed4c13086faccbdff6-drivers/memory/fsl_ifc.c-fsl_ifc_ctrl_probe CVE-2021-47314
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("kzalloc")
	and not target_0.getTarget().hasName("devm_kzalloc")
	and target_0.getArgument(0).(SizeofExprOperator).getValue()="224"
	and target_0.getArgument(1).(BitwiseOrExpr).getValue()="3264"
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("fsl_ifc_ctrl *")
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Parameter vdev_204, AddressOfExpr target_2, AddressOfExpr target_3) {
exists(AddressOfExpr target_1 |
	target_1.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_204
	and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vdev_204, AddressOfExpr target_2) {
	target_2.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_2.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_204
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_info")
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="Freescale Integrated Flash Controller\n"
}

predicate func_3(Parameter vdev_204, AddressOfExpr target_3) {
	target_3.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_3.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_204
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_set_drvdata")
	and target_3.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("fsl_ifc_ctrl *")
}

from Function func, Parameter vdev_204, FunctionCall target_0, AddressOfExpr target_2, AddressOfExpr target_3
where
func_0(func, target_0)
and not func_1(vdev_204, target_2, target_3)
and func_2(vdev_204, target_2)
and func_3(vdev_204, target_3)
and vdev_204.getType().hasName("platform_device *")
and vdev_204.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
