/**
 * @name linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-iscsi_conn_stop
 * @id cpp/linux/ec29d0ac29be366450a7faffbcf8cba3a6a3b506/iscsi-conn-stop
 * @description linux-ec29d0ac29be366450a7faffbcf8cba3a6a3b506-drivers/scsi/libiscsi.c-iscsi_conn_stop CVE-2021-47328
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

/*predicate func_2(Variable vconn_3236, ExprStmt target_4, VariableAccess target_2) {
	target_2.getTarget()=vconn_3236
	and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memset")
	and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tmhdr"
	and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="48"
	and target_4.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_2.getLocation())
}

*/
predicate func_3(Variable vconn_3236, VariableAccess target_3) {
	target_3.getTarget()=vconn_3236
	and target_3.getParent().(PointerFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__memset")
	and target_3.getParent().(PointerFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="tmhdr"
	and target_3.getParent().(PointerFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_3236
	and target_3.getParent().(PointerFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_3.getParent().(PointerFieldAccess).getParent().(SizeofExprOperator).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="48"
}

predicate func_4(Variable vconn_3236, ExprStmt target_4) {
	target_4.getExpr().(FunctionCall).getTarget().hasName("fail_mgmt_tasks")
	and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("iscsi_session *")
	and target_4.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vconn_3236
}

from Function func, Variable vconn_3236, VariableAccess target_3, ExprStmt target_4
where
func_3(vconn_3236, target_3)
and func_4(vconn_3236, target_4)
and vconn_3236.getType().hasName("iscsi_conn *")
and vconn_3236.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
