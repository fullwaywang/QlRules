/**
 * @name linux-534fc31d09b706a16d83533e16b5dc855caf7576-xenvif_get_requests
 * @id cpp/linux/534fc31d09b706a16d83533e16b5dc855caf7576/xenvif-get-requests
 * @description linux-534fc31d09b706a16d83533e16b5dc855caf7576-drivers/net/xen-netback/netback.c-xenvif_get_requests CVE-2023-34319
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfrag_overflow_385, Variable vshinfo_390, BlockStmt target_13, VariableAccess target_0) {
	target_0.getTarget()=vfrag_overflow_385
	and vfrag_overflow_385.getIndex() = 6
	and target_0.getParent().(LTExpr).getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_0.getParent().(LTExpr).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_0.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_13
}

predicate func_1(Parameter vfrag_overflow_385, Variable vshinfo_390, Variable vnr_slots_394, RelationalOperation target_14, CommaExpr target_15) {
exists(AddExpr target_1 |
	target_1.getLeftOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_1.getLeftOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_1.getLeftOperand().(AddExpr).getRightOperand().(VariableAccess).getTarget()=vfrag_overflow_385
	and target_1.getRightOperand() instanceof Literal
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnr_slots_394
	and target_1.getLeftOperand().(AddExpr).getRightOperand().(VariableAccess).getLocation().isBefore(target_14.getGreaterOperand().(VariableAccess).getLocation())
	and target_1.getLeftOperand().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_15.getLeftOperand().(CommaExpr).getLeftOperand().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vshinfo_390, Variable vnr_slots_394, BlockStmt target_16, ExprStmt target_17, ExprStmt target_18) {
exists(LogicalAndExpr target_2 |
	target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vnr_slots_394
	and target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_2.getRightOperand().(RelationalOperation).getGreaterOperand().(Literal).getValue()="17"
	and target_2.getParent().(ForStmt).getStmt()=target_16
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_18.getExpr().(PostfixDecrExpr).getOperand().(VariableAccess).getLocation().isBefore(target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_3(Variable vnr_slots_394, RelationalOperation target_6) {
exists(CommaExpr target_3 |
	target_3.getLeftOperand() instanceof CommaExpr
	and target_3.getRightOperand().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vnr_slots_394
	and target_3.getRightOperand().(PostfixDecrExpr).getOperand().(VariableAccess).getLocation().isBefore(target_6.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_4(Variable vnr_slots_394, BlockStmt target_19, RelationalOperation target_6) {
exists(RelationalOperation target_4 |
	 (target_4 instanceof GTExpr or target_4 instanceof LTExpr)
	and target_4.getGreaterOperand().(VariableAccess).getTarget()=vnr_slots_394
	and target_4.getLesserOperand().(Literal).getValue()="0"
	and target_4.getParent().(IfStmt).getThen()=target_19
	and target_6.getGreaterOperand().(VariableAccess).getLocation().isBefore(target_4.getGreaterOperand().(VariableAccess).getLocation()))
}

predicate func_5(Parameter vnskb_386, VariableAccess target_11, ExprStmt target_20) {
exists(IfStmt target_5 |
	target_5.getCondition().(VariableAccess).getTarget()=vnskb_386
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree_skb")
	and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnskb_386
	and target_5.getParent().(IfStmt).getCondition()=target_11
	and target_5.getCondition().(VariableAccess).getLocation().isBefore(target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(Variable vshinfo_390, Variable vnr_slots_394, BlockStmt target_16, RelationalOperation target_6) {
	 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
	and target_6.getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_6.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_6.getGreaterOperand().(VariableAccess).getTarget()=vnr_slots_394
	and target_6.getParent().(ForStmt).getStmt()=target_16
}

predicate func_7(Parameter vfrag_overflow_385, Variable vshinfo_390, BlockStmt target_13, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="nr_frags"
	and target_7.getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_7.getParent().(LTExpr).getGreaterOperand().(VariableAccess).getTarget()=vfrag_overflow_385
	and target_7.getParent().(LTExpr).getParent().(ForStmt).getStmt()=target_13
}

predicate func_8(Variable vshinfo_390, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="nr_frags"
	and target_8.getQualifier().(VariableAccess).getTarget()=vshinfo_390
}

predicate func_9(Variable vshinfo_390, Variable vgop_396, CommaExpr target_9) {
	target_9.getLeftOperand().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_9.getLeftOperand().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_9.getRightOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vgop_396
}

predicate func_11(Parameter vfrag_overflow_385, BlockStmt target_19, VariableAccess target_11) {
	target_11.getTarget()=vfrag_overflow_385
	and target_11.getParent().(IfStmt).getThen()=target_19
}

predicate func_12(Variable vshinfo_390, Variable vnr_slots_394, AddExpr target_12) {
	target_12.getLeftOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_12.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_12.getRightOperand() instanceof Literal
	and target_12.getParent().(AssignExpr).getRValue() = target_12
	and target_12.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vnr_slots_394
}

predicate func_13(Function func, BlockStmt target_13) {
	target_13.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("pending_ring_idx_t")
	and target_13.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pending_index")
	and target_13.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pending_cons"
	and target_13.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xenvif_queue *")
	and target_13.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u16")
	and target_13.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="pending_ring"
	and target_13.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xenvif_queue *")
	and target_13.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("pending_ring_idx_t")
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vfrag_overflow_385, Variable vshinfo_390, RelationalOperation target_14) {
	 (target_14 instanceof GTExpr or target_14 instanceof LTExpr)
	and target_14.getLesserOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_14.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_14.getGreaterOperand().(VariableAccess).getTarget()=vfrag_overflow_385
}

predicate func_15(Variable vshinfo_390, Variable vgop_396, CommaExpr target_15) {
	target_15.getLeftOperand().(CommaExpr).getLeftOperand().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_15.getLeftOperand().(CommaExpr).getLeftOperand().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_15.getLeftOperand().(CommaExpr).getRightOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("xen_netif_tx_request *")
	and target_15.getRightOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vgop_396
}

predicate func_16(Function func, BlockStmt target_16) {
	target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("pending_ring_idx_t")
	and target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pending_index")
	and target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="pending_cons"
	and target_16.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xenvif_queue *")
	and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("u16")
	and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="pending_ring"
	and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("xenvif_queue *")
	and target_16.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("pending_ring_idx_t")
	and target_16.getEnclosingFunction() = func
}

predicate func_17(Variable vshinfo_390, ExprStmt target_17) {
	target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="nr_frags"
	and target_17.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
	and target_17.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_18(Variable vnr_slots_394, ExprStmt target_18) {
	target_18.getExpr().(PostfixDecrExpr).getOperand().(VariableAccess).getTarget()=vnr_slots_394
}

predicate func_19(Parameter vnskb_386, Variable vshinfo_390, BlockStmt target_19) {
	target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vshinfo_390
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_19.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnskb_386
	and target_19.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("skb_frag_t *")
	and target_19.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="frags"
	and target_19.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vshinfo_390
}

predicate func_20(Parameter vnskb_386, Variable vshinfo_390, ExprStmt target_20) {
	target_20.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vshinfo_390
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_end_pointer")
	and target_20.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnskb_386
}

from Function func, Parameter vfrag_overflow_385, Parameter vnskb_386, Variable vshinfo_390, Variable vnr_slots_394, Variable vgop_396, VariableAccess target_0, RelationalOperation target_6, PointerFieldAccess target_7, PointerFieldAccess target_8, CommaExpr target_9, VariableAccess target_11, AddExpr target_12, BlockStmt target_13, RelationalOperation target_14, CommaExpr target_15, BlockStmt target_16, ExprStmt target_17, ExprStmt target_18, BlockStmt target_19, ExprStmt target_20
where
func_0(vfrag_overflow_385, vshinfo_390, target_13, target_0)
and not func_1(vfrag_overflow_385, vshinfo_390, vnr_slots_394, target_14, target_15)
and not func_2(vshinfo_390, vnr_slots_394, target_16, target_17, target_18)
and not func_3(vnr_slots_394, target_6)
and not func_4(vnr_slots_394, target_19, target_6)
and not func_5(vnskb_386, target_11, target_20)
and func_6(vshinfo_390, vnr_slots_394, target_16, target_6)
and func_7(vfrag_overflow_385, vshinfo_390, target_13, target_7)
and func_8(vshinfo_390, target_8)
and func_9(vshinfo_390, vgop_396, target_9)
and func_11(vfrag_overflow_385, target_19, target_11)
and func_12(vshinfo_390, vnr_slots_394, target_12)
and func_13(func, target_13)
and func_14(vfrag_overflow_385, vshinfo_390, target_14)
and func_15(vshinfo_390, vgop_396, target_15)
and func_16(func, target_16)
and func_17(vshinfo_390, target_17)
and func_18(vnr_slots_394, target_18)
and func_19(vnskb_386, vshinfo_390, target_19)
and func_20(vnskb_386, vshinfo_390, target_20)
and vfrag_overflow_385.getType().hasName("unsigned int")
and vnskb_386.getType().hasName("sk_buff *")
and vshinfo_390.getType().hasName("skb_shared_info *")
and vnr_slots_394.getType().hasName("unsigned int")
and vgop_396.getType().hasName("gnttab_map_grant_ref *")
and vfrag_overflow_385.getFunction() = func
and vnskb_386.getFunction() = func
and vshinfo_390.(LocalVariable).getFunction() = func
and vnr_slots_394.(LocalVariable).getFunction() = func
and vgop_396.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
