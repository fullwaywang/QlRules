/**
 * @name linux-5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd-xen_9pfs_front_alloc_dataring
 * @id cpp/linux/5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd/xen-9pfs-front-alloc-dataring
 * @description linux-5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd-net/9p/trans_xen.c-xen_9pfs_front_alloc_dataring CVE-2022-23041
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vbytes_311, Parameter vring_306, FunctionCall target_0) {
	target_0.getTarget().hasName("free_pages")
	and not target_0.getTarget().hasName("free_pages_exact")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vbytes_311
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="ring_order"
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="intf"
	and target_0.getArgument(1).(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vring_306
	and target_0.getArgument(1).(SubExpr).getRightOperand() instanceof SubExpr
}

predicate func_1(Parameter vorder_307, Variable vbytes_311, RelationalOperation target_10) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("alloc_pages_exact")
	and target_1.getArgument(0).(BinaryBitwiseOperation).getLeftOperand().(Literal).getValue()="1"
	and target_1.getArgument(0).(BinaryBitwiseOperation).getRightOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vorder_307
	and target_1.getArgument(0).(BinaryBitwiseOperation).getRightOperand().(AddExpr).getRightOperand() instanceof Literal
	and target_1.getArgument(1) instanceof BitwiseOrExpr
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_311
	and target_1.getArgument(0).(BinaryBitwiseOperation).getRightOperand().(AddExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_10.getGreaterOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vorder_307, ExprStmt target_11) {
exists(BinaryBitwiseOperation target_2 |
	target_2.getLeftOperand().(Literal).getValue()="1"
	and target_2.getRightOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vorder_307
	and target_2.getRightOperand().(AddExpr).getRightOperand() instanceof Literal
	and target_2.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getLocation().isBefore(target_2.getRightOperand().(AddExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_3(Function func, BitwiseOrExpr target_3) {
	target_3.getValue()="3520"
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vorder_307, VariableAccess target_4) {
	target_4.getTarget()=vorder_307
	and target_4.getParent().(SubExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_7(Parameter vorder_307, Variable vbytes_311, FunctionCall target_7) {
	target_7.getTarget().hasName("__get_free_pages")
	and target_7.getArgument(0) instanceof BitwiseOrExpr
	and target_7.getArgument(1).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vorder_307
	and target_7.getArgument(1).(SubExpr).getRightOperand().(SubExpr).getValue()="0"
	and target_7.getParent().(AssignExpr).getRValue() = target_7
	and target_7.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_311
}

predicate func_8(Parameter vring_306, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="ring_order"
	and target_8.getQualifier().(PointerFieldAccess).getTarget().getName()="intf"
	and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vring_306
}

predicate func_9(Function func, SubExpr target_9) {
	target_9.getValue()="0"
	and target_9.getParent().(SubExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_9.getEnclosingFunction() = func
}

predicate func_10(Parameter vorder_307, RelationalOperation target_10) {
	 (target_10 instanceof GTExpr or target_10 instanceof LTExpr)
	and target_10.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
	and target_10.getGreaterOperand().(BinaryBitwiseOperation).getLeftOperand().(Literal).getValue()="1"
	and target_10.getGreaterOperand().(BinaryBitwiseOperation).getRightOperand().(VariableAccess).getTarget()=vorder_307
}

predicate func_11(Parameter vorder_307, Variable vbytes_311, Parameter vring_306, ExprStmt target_11) {
	target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="out"
	and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="data"
	and target_11.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vring_306
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vbytes_311
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(Literal).getValue()="1"
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(SubExpr).getLeftOperand().(AddExpr).getLeftOperand().(VariableAccess).getTarget()=vorder_307
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(SubExpr).getLeftOperand().(AddExpr).getRightOperand().(Literal).getValue()="12"
	and target_11.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(SubExpr).getRightOperand().(Literal).getValue()="1"
}

from Function func, Parameter vorder_307, Variable vbytes_311, Parameter vring_306, FunctionCall target_0, BitwiseOrExpr target_3, VariableAccess target_4, FunctionCall target_7, PointerFieldAccess target_8, SubExpr target_9, RelationalOperation target_10, ExprStmt target_11
where
func_0(vbytes_311, vring_306, target_0)
and not func_1(vorder_307, vbytes_311, target_10)
and not func_2(vorder_307, target_11)
and func_3(func, target_3)
and func_4(vorder_307, target_4)
and func_7(vorder_307, vbytes_311, target_7)
and func_8(vring_306, target_8)
and func_9(func, target_9)
and func_10(vorder_307, target_10)
and func_11(vorder_307, vbytes_311, vring_306, target_11)
and vorder_307.getType().hasName("unsigned int")
and vbytes_311.getType().hasName("void *")
and vring_306.getType().hasName("xen_9pfs_dataring *")
and vorder_307.getFunction() = func
and vbytes_311.(LocalVariable).getFunction() = func
and vring_306.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
