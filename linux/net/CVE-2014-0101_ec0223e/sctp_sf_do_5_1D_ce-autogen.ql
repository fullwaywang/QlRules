/**
 * @name linux-ec0223ec48a90cb605244b45f7c62de856403729-sctp_sf_do_5_1D_ce
 * @id cpp/linux/ec0223ec48a90cb605244b45f7c62de856403729/sctp-sf-do-5-1d-ce
 * @description linux-ec0223ec48a90cb605244b45f7c62de856403729-net/sctp/sm_statefuns.c-sctp_sf_do_5_1D_ce CVE-2014-0101
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtype_649, Parameter varg_649, Parameter vcommands_650, Variable vchunk_652, Variable vnew_asoc_653, Parameter vep_647, Parameter vasoc_648, Parameter vnet_646, PointerFieldAccess target_5, FunctionCall target_6, ExprStmt target_7, FunctionCall target_8, IfStmt target_9, ExprStmt target_10, ExprStmt target_11) {
	exists(IfStmt target_0 |
		target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="auth_enable"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sctp"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnet_646
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="auth_capable"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="peer"
		and target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_asoc_653
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("kfree_skb")
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="auth_chunk"
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_652
		and target_0.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("sctp_sf_pdiscard")
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_646
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vep_647
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vasoc_648
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtype_649
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=varg_649
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vcommands_650
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_0
		and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
		and target_6.getArgument(3).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(2).(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getLocation().isBefore(target_8.getArgument(4).(VariableAccess).getLocation())
		and target_9.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getAnOperand().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_3(Variable vnew_asoc_653, FunctionCall target_3) {
		target_3.getTarget().hasName("sctp_association_free")
		and target_3.getArgument(0).(VariableAccess).getTarget()=vnew_asoc_653
}

*/
predicate func_4(Variable vnew_asoc_653, Function func, ExprStmt target_4) {
		target_4.getExpr().(FunctionCall).getTarget().hasName("sctp_association_free")
		and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnew_asoc_653
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable vchunk_652, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="auth_chunk"
		and target_5.getQualifier().(VariableAccess).getTarget()=vchunk_652
}

predicate func_6(Parameter vtype_649, Parameter varg_649, Parameter vcommands_650, Parameter vep_647, Parameter vasoc_648, Parameter vnet_646, FunctionCall target_6) {
		target_6.getTarget().hasName("sctp_sf_pdiscard")
		and target_6.getArgument(0).(VariableAccess).getTarget()=vnet_646
		and target_6.getArgument(1).(VariableAccess).getTarget()=vep_647
		and target_6.getArgument(2).(VariableAccess).getTarget()=vasoc_648
		and target_6.getArgument(3).(VariableAccess).getTarget()=vtype_649
		and target_6.getArgument(4).(VariableAccess).getTarget()=varg_649
		and target_6.getArgument(5).(VariableAccess).getTarget()=vcommands_650
}

predicate func_7(Parameter vtype_649, Variable vnew_asoc_653, Parameter vep_647, Parameter vnet_646, ExprStmt target_7) {
		target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("sctp_ierror_t")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sctp_sf_authenticate")
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_646
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vep_647
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vnew_asoc_653
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtype_649
		and target_7.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("sctp_chunk")
}

predicate func_8(Parameter vtype_649, Parameter varg_649, Parameter vcommands_650, Parameter vep_647, Parameter vasoc_648, Parameter vnet_646, FunctionCall target_8) {
		target_8.getTarget().hasName("sctp_sf_pdiscard")
		and target_8.getArgument(0).(VariableAccess).getTarget()=vnet_646
		and target_8.getArgument(1).(VariableAccess).getTarget()=vep_647
		and target_8.getArgument(2).(VariableAccess).getTarget()=vasoc_648
		and target_8.getArgument(3).(VariableAccess).getTarget()=vtype_649
		and target_8.getArgument(4).(VariableAccess).getTarget()=varg_649
		and target_8.getArgument(5).(VariableAccess).getTarget()=vcommands_650
}

predicate func_9(Variable vchunk_652, IfStmt target_9) {
		target_9.getCondition().(PointerFieldAccess).getTarget().getName()="auth_chunk"
		and target_9.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_652
		and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skb"
		and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_chunk")
		and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="auth_chunk"
		and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_652
		and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="asoc"
		and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_chunk")
		and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="asoc"
		and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_652
}

predicate func_10(Variable vchunk_652, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="skb"
		and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_chunk")
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="auth_chunk"
		and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_652
}

predicate func_11(Variable vnew_asoc_653, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("sctp_auth_asoc_init_active_key")
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnew_asoc_653
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="32"
}

from Function func, Parameter vtype_649, Parameter varg_649, Parameter vcommands_650, Variable vchunk_652, Variable vnew_asoc_653, Parameter vep_647, Parameter vasoc_648, Parameter vnet_646, ExprStmt target_4, PointerFieldAccess target_5, FunctionCall target_6, ExprStmt target_7, FunctionCall target_8, IfStmt target_9, ExprStmt target_10, ExprStmt target_11
where
not func_0(vtype_649, varg_649, vcommands_650, vchunk_652, vnew_asoc_653, vep_647, vasoc_648, vnet_646, target_5, target_6, target_7, target_8, target_9, target_10, target_11)
and func_4(vnew_asoc_653, func, target_4)
and func_5(vchunk_652, target_5)
and func_6(vtype_649, varg_649, vcommands_650, vep_647, vasoc_648, vnet_646, target_6)
and func_7(vtype_649, vnew_asoc_653, vep_647, vnet_646, target_7)
and func_8(vtype_649, varg_649, vcommands_650, vep_647, vasoc_648, vnet_646, target_8)
and func_9(vchunk_652, target_9)
and func_10(vchunk_652, target_10)
and func_11(vnew_asoc_653, target_11)
and vtype_649.getType().hasName("const sctp_subtype_t")
and varg_649.getType().hasName("void *")
and vcommands_650.getType().hasName("sctp_cmd_seq_t *")
and vchunk_652.getType().hasName("sctp_chunk *")
and vnew_asoc_653.getType().hasName("sctp_association *")
and vep_647.getType().hasName("const sctp_endpoint *")
and vasoc_648.getType().hasName("const sctp_association *")
and vnet_646.getType().hasName("net *")
and vtype_649.getFunction() = func
and varg_649.getFunction() = func
and vcommands_650.getFunction() = func
and vchunk_652.(LocalVariable).getFunction() = func
and vnew_asoc_653.(LocalVariable).getFunction() = func
and vep_647.getFunction() = func
and vasoc_648.getFunction() = func
and vnet_646.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
