/**
 * @name linux-16ce101db85db694a91380aa4c89b25530871d33-migrate_folio
 * @id cpp/linux/16ce101db85db694a91380aa4c89b25530871d33/migrate-folio
 * @description linux-16ce101db85db694a91380aa4c89b25530871d33-migrate_folio CVE-2022-3523
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vmapping_640, Parameter vdst_640, Parameter vsrc_641, Variable vrc_643, FunctionCall target_0) {
		target_0.getTarget().hasName("folio_migrate_mapping")
		and not target_0.getTarget().hasName("migrate_folio_extra")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vmapping_640
		and target_0.getArgument(1).(VariableAccess).getTarget()=vdst_640
		and target_0.getArgument(2).(VariableAccess).getTarget()=vsrc_641
		and target_0.getArgument(3).(Literal).getValue()="0"
		and target_0.getParent().(AssignExpr).getRValue() = target_0
		and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_643
}

predicate func_1(Parameter vmode_641, ExprStmt target_15, VariableAccess target_1) {
		target_1.getTarget()=vmode_641
		and target_1.getParent().(NEExpr).getAnOperand() instanceof EnumConstantAccess
		and target_1.getParent().(NEExpr).getParent().(IfStmt).getThen()=target_15
}

predicate func_2(Function func, DeclStmt target_2) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Function func, DoStmt target_3) {
		target_3.getCondition() instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("folio_test_writeback")
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getCondition() instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
		and target_3.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

/*predicate func_4(Parameter vsrc_641, IfStmt target_4) {
		target_4.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("folio_test_writeback")
		and target_4.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsrc_641
		and target_4.getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_4.getThen().(DoStmt).getCondition() instanceof Literal
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition() instanceof Literal
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
		and target_4.getThen().(DoStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
}

*/
/*predicate func_5(Function func, ExprStmt target_5) {
		target_5.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0).(Literal).getValue()="1019"
		and target_5.getEnclosingFunction() = func
}

*/
/*predicate func_6(Function func, AsmStmt target_6) {
		target_6.getChild(0).(Literal).getValue()="1019"
		and target_6.getEnclosingFunction() = func
}

*/
/*predicate func_7(Function func, DoStmt target_7) {
		target_7.getCondition() instanceof Literal
		and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(0) instanceof StringLiteral
		and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(1) instanceof Literal
		and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(2) instanceof Literal
		and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getType() instanceof LongType
		and target_7.getStmt().(BlockStmt).getStmt(0).(AsmStmt).getChild(3).(SizeofTypeOperator).getValue()="12"
		and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, AsmStmt target_8) {
		target_8.getChild(0) instanceof StringLiteral
		and target_8.getChild(1) instanceof Literal
		and target_8.getChild(2) instanceof Literal
		and target_8.getChild(3).(SizeofTypeOperator).getType() instanceof LongType
		and target_8.getChild(3).(SizeofTypeOperator).getValue()="12"
		and target_8.getEnclosingFunction() = func
}

*/
/*predicate func_9(Function func, ExprStmt target_9) {
		target_9.getExpr().(FunctionCall).getTarget().hasName("__builtin_unreachable")
		and target_9.getEnclosingFunction() = func
}

*/
predicate func_10(Variable vrc_643, Function func, ExprStmt target_10) {
		target_10.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vrc_643
		and target_10.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vrc_643, Function func, IfStmt target_11) {
		target_11.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vrc_643
		and target_11.getCondition().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_11.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vrc_643
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

/*predicate func_12(Variable vrc_643, EqualityOperation target_16, VariableAccess target_12) {
		target_12.getTarget()=vrc_643
		and target_16.getAnOperand().(VariableAccess).getLocation().isBefore(target_12.getLocation())
}

*/
predicate func_13(Parameter vdst_640, Parameter vsrc_641, Parameter vmode_641, Function func, IfStmt target_13) {
		target_13.getCondition().(EqualityOperation).getAnOperand().(VariableAccess).getTarget()=vmode_641
		and target_13.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("folio_migrate_copy")
		and target_13.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdst_640
		and target_13.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsrc_641
		and target_13.getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("folio_migrate_flags")
		and target_13.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdst_640
		and target_13.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vsrc_641
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Function func, ReturnStmt target_14) {
		target_14.getExpr().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Function func, ExprStmt target_15) {
		target_15.getExpr() instanceof FunctionCall
		and target_15.getEnclosingFunction() = func
}

predicate func_16(Variable vrc_643, EqualityOperation target_16) {
		target_16.getAnOperand().(VariableAccess).getTarget()=vrc_643
		and target_16.getAnOperand() instanceof Literal
}

from Function func, Parameter vmapping_640, Parameter vdst_640, Parameter vsrc_641, Parameter vmode_641, Variable vrc_643, FunctionCall target_0, VariableAccess target_1, DeclStmt target_2, DoStmt target_3, ExprStmt target_10, IfStmt target_11, IfStmt target_13, ReturnStmt target_14, ExprStmt target_15, EqualityOperation target_16
where
func_0(vmapping_640, vdst_640, vsrc_641, vrc_643, target_0)
and func_1(vmode_641, target_15, target_1)
and func_2(func, target_2)
and func_3(func, target_3)
and func_10(vrc_643, func, target_10)
and func_11(vrc_643, func, target_11)
and func_13(vdst_640, vsrc_641, vmode_641, func, target_13)
and func_14(func, target_14)
and func_15(func, target_15)
and func_16(vrc_643, target_16)
and vmapping_640.getType().hasName("address_space *")
and vdst_640.getType().hasName("folio *")
and vsrc_641.getType().hasName("folio *")
and vmode_641.getType().hasName("migrate_mode")
and vrc_643.getType().hasName("int")
and vmapping_640.getFunction() = func
and vdst_640.getFunction() = func
and vsrc_641.getFunction() = func
and vmode_641.getFunction() = func
and vrc_643.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
