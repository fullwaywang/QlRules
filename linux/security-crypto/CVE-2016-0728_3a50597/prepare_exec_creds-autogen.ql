/**
 * @name linux-3a50597de8635cd05133bd12c95681c82fe7b878-prepare_exec_creds
 * @id cpp/linux/3a50597de8635cd05133bd12c95681c82fe7b878/prepare-exec-creds
 * @description linux-3a50597de8635cd05133bd12c95681c82fe7b878-kernel/cred.c-prepare_exec_creds CVE-2016-0728
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vtgcred_337, FunctionCall target_0) {
		target_0.getTarget().hasName("kfree")
		and not target_0.getTarget().hasName("key_put")
		and target_0.getArgument(0).(VariableAccess).getTarget()=vtgcred_337
}

predicate func_1(Variable vtgcred_337, PointerFieldAccess target_1) {
		target_1.getTarget().getName()="session_keyring"
		and target_1.getQualifier().(VariableAccess).getTarget()=vtgcred_337
}

predicate func_2(Variable vnew_338, NotExpr target_20, ReturnStmt target_2) {
		target_2.getExpr().(VariableAccess).getTarget()=vnew_338
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
}

predicate func_3(Variable vnew_338, VariableAccess target_3) {
		target_3.getTarget()=vnew_338
		and target_3.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Variable vnew_338, VariableAccess target_4) {
		target_4.getTarget()=vnew_338
}

predicate func_5(Function func, DeclStmt target_5) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vtgcred_337, Function func, ExprStmt target_6) {
		target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtgcred_337
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("kmalloc")
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(SizeofExprOperator).getValue()="112"
		and target_6.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(BitwiseOrExpr).getValue()="208"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vtgcred_337, Function func, IfStmt target_7) {
		target_7.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vtgcred_337
		and target_7.getThen().(ReturnStmt).getExpr().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vnew_338, Variable vtgcred_337, FunctionCall target_8) {
		target_8.getTarget().hasName("memcpy")
		and target_8.getArgument(0).(VariableAccess).getTarget()=vtgcred_337
		and target_8.getArgument(1).(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_8.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_338
		and target_8.getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_8.getArgument(2).(SizeofTypeOperator).getValue()="112"
}

predicate func_9(Variable vtgcred_337, Function func, ExprStmt target_9) {
		target_9.getExpr().(FunctionCall).getTarget().hasName("atomic_set")
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="usage"
		and target_9.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtgcred_337
		and target_9.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vtgcred_337, Function func, DoStmt target_10) {
		target_10.getCondition().(Literal).getValue()="0"
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spinlock_check")
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtgcred_337
		and target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
		and target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__raw_spin_lock_init")
		and target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&(&tgcred->lock)->rlock"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

/*predicate func_11(Variable vtgcred_337, ExprStmt target_11) {
		target_11.getExpr().(FunctionCall).getTarget().hasName("spinlock_check")
		and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_11.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtgcred_337
}

*/
/*predicate func_12(Variable v__key_362, DoStmt target_12) {
		target_12.getCondition().(Literal).getValue()="0"
		and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__raw_spin_lock_init")
		and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlock"
		and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&(&tgcred->lock)->rlock"
		and target_12.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_362
}

*/
/*predicate func_14(Variable v__key_362, ExprStmt target_14) {
		target_14.getExpr().(FunctionCall).getTarget().hasName("__raw_spin_lock_init")
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlock"
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_14.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&(&tgcred->lock)->rlock"
		and target_14.getExpr().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=v__key_362
}

*/
predicate func_15(Variable vtgcred_337, Function func, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("key_get")
		and target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="session_keyring"
		and target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtgcred_337
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Variable vtgcred_337, Function func, ExprStmt target_16) {
		target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="process_keyring"
		and target_16.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtgcred_337
		and target_16.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

/*predicate func_17(Variable vtgcred_337, ExprStmt target_15, ExprStmt target_19, VariableAccess target_17) {
		target_17.getTarget()=vtgcred_337
		and target_15.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_17.getLocation())
		and target_17.getLocation().isBefore(target_19.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
}

*/
predicate func_18(Variable vnew_338, Function func, ExprStmt target_18) {
		target_18.getExpr().(FunctionCall).getTarget().hasName("release_tgcred")
		and target_18.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnew_338
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

predicate func_19(Variable vnew_338, Variable vtgcred_337, Function func, ExprStmt target_19) {
		target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="tgcred"
		and target_19.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnew_338
		and target_19.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vtgcred_337
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Variable vnew_338, NotExpr target_20) {
		target_20.getOperand().(VariableAccess).getTarget()=vnew_338
}

from Function func, Variable vnew_338, Variable v__key_362, Variable vtgcred_337, FunctionCall target_0, PointerFieldAccess target_1, ReturnStmt target_2, VariableAccess target_3, VariableAccess target_4, DeclStmt target_5, ExprStmt target_6, IfStmt target_7, FunctionCall target_8, ExprStmt target_9, DoStmt target_10, ExprStmt target_15, ExprStmt target_16, ExprStmt target_18, ExprStmt target_19, NotExpr target_20
where
func_0(vtgcred_337, target_0)
and func_1(vtgcred_337, target_1)
and func_2(vnew_338, target_20, target_2)
and func_3(vnew_338, target_3)
and func_4(vnew_338, target_4)
and func_5(func, target_5)
and func_6(vtgcred_337, func, target_6)
and func_7(vtgcred_337, func, target_7)
and func_8(vnew_338, vtgcred_337, target_8)
and func_9(vtgcred_337, func, target_9)
and func_10(vtgcred_337, func, target_10)
and func_15(vtgcred_337, func, target_15)
and func_16(vtgcred_337, func, target_16)
and func_18(vnew_338, func, target_18)
and func_19(vnew_338, vtgcred_337, func, target_19)
and func_20(vnew_338, target_20)
and vnew_338.getType().hasName("cred *")
and v__key_362.getType().hasName("lock_class_key")
and vtgcred_337.getType().hasName("thread_group_cred *")
and vnew_338.(LocalVariable).getFunction() = func
and v__key_362.(LocalVariable).getFunction() = func
and vtgcred_337.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
