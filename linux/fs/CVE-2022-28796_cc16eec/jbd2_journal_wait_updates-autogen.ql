/**
 * @name linux-cc16eecae687912238ee6efbff71ad31e2bc414e-jbd2_journal_wait_updates
 * @id cpp/linux/cc16eecae687912238ee6efbff71ad31e2bc414e/jbd2-journal-wait-updates
 * @description linux-cc16eecae687912238ee6efbff71ad31e2bc414e-jbd2_journal_wait_updates CVE-2022-28796
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vjournal_843, Initializer target_0) {
		target_0.getExpr().(PointerFieldAccess).getTarget().getName()="j_running_transaction"
		and target_0.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
}

predicate func_1(Variable vcommit_transaction_845, VariableAccess target_1) {
		target_1.getTarget()=vcommit_transaction_845
		and target_1.getParent().(NotExpr).getParent().(IfStmt).getThen() instanceof ReturnStmt
}

predicate func_2(Variable vcommit_transaction_845, VariableAccess target_2) {
		target_2.getTarget()=vcommit_transaction_845
		and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
		and target_2.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
}

predicate func_3(Variable vcommit_transaction_845, VariableAccess target_3) {
		target_3.getTarget()=vcommit_transaction_845
		and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(WhileStmt).getCondition().(FunctionCall).getTarget().hasName("atomic_read")
		and target_3.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(WhileStmt).getCondition().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_updates"
}

predicate func_4(Variable vcommit_transaction_845, VariableAccess target_4) {
		target_4.getTarget()=vcommit_transaction_845
		and target_4.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
		and target_4.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
}

/*predicate func_5(Variable vcommit_transaction_845, VariableAccess target_5) {
		target_5.getTarget()=vcommit_transaction_845
		and target_5.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_lock")
		and target_5.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
}

*/
predicate func_6(Variable vcommit_transaction_845, FunctionCall target_6) {
		target_6.getTarget().hasName("spin_lock")
		and not target_6.getTarget().hasName("spin_unlock")
		and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
		and target_6.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
}

predicate func_7(Variable vcommit_transaction_845, AddressOfExpr target_23, FunctionCall target_7) {
		target_7.getTarget().hasName("spin_unlock")
		and not target_7.getTarget().hasName("finish_wait")
		and target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
		and target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_9(NotExpr target_24, Function func) {
	exists(BreakStmt target_9 |
		target_9.getParent().(IfStmt).getCondition()=target_24
		and target_9.getEnclosingFunction() = func)
}

predicate func_10(BlockStmt target_25, Function func) {
	exists(NotExpr target_10 |
		target_10.getOperand().(FunctionCall).getTarget().hasName("atomic_read")
		and target_10.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_updates"
		and target_10.getOperand().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("transaction_t *")
		and target_10.getParent().(IfStmt).getThen()=target_25
		and target_10.getEnclosingFunction() = func)
}

predicate func_11(FunctionCall target_20, Function func) {
	exists(BreakStmt target_11 |
		target_11.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(2)=target_11
		and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
		and target_11.getEnclosingFunction() = func)
}

predicate func_12(Parameter vjournal_843, AddressOfExpr target_26) {
	exists(AddressOfExpr target_12 |
		target_12.getOperand().(PointerFieldAccess).getTarget().getName()="j_wait_updates"
		and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
		and target_12.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
		and target_26.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_14(Parameter vjournal_843, FunctionCall target_20, ExprStmt target_14) {
		target_14.getExpr().(FunctionCall).getTarget().hasName("_raw_write_unlock")
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="j_state_lock"
		and target_14.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
}

predicate func_15(FunctionCall target_20, Function func, ExprStmt target_15) {
		target_15.getExpr().(FunctionCall).getTarget().hasName("schedule")
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
		and target_15.getEnclosingFunction() = func
}

predicate func_17(Parameter vjournal_843, FunctionCall target_20, ExprStmt target_17) {
		target_17.getExpr().(FunctionCall).getTarget().hasName("_raw_write_lock")
		and target_17.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="j_state_lock"
		and target_17.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
		and target_17.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_20
}

predicate func_18(Parameter vjournal_843, Variable vwait_852, ExprStmt target_18) {
		target_18.getExpr().(FunctionCall).getTarget().hasName("finish_wait")
		and target_18.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="j_wait_updates"
		and target_18.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
		and target_18.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwait_852
}

predicate func_19(NotExpr target_24, Function func, ReturnStmt target_19) {
		target_19.getParent().(IfStmt).getCondition()=target_24
		and target_19.getEnclosingFunction() = func
}

predicate func_20(Variable vcommit_transaction_845, BlockStmt target_25, AddressOfExpr target_27, AddressOfExpr target_28, FunctionCall target_20) {
		target_20.getTarget().hasName("atomic_read")
		and target_20.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_updates"
		and target_20.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_20.getParent().(IfStmt).getThen()=target_25
		and target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_20.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_21(Variable vcommit_transaction_845, AddressOfExpr target_23, PointerFieldAccess target_21) {
		target_21.getTarget().getName()="t_handle_lock"
		and target_21.getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_21.getQualifier().(VariableAccess).getLocation())
}

predicate func_22(Function func, ReturnStmt target_22) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_22
}

predicate func_23(Variable vcommit_transaction_845, AddressOfExpr target_23) {
		target_23.getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
		and target_23.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_23.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_24(Variable vcommit_transaction_845, NotExpr target_24) {
		target_24.getOperand().(VariableAccess).getTarget()=vcommit_transaction_845
}

predicate func_25(Variable vcommit_transaction_845, BlockStmt target_25) {
		target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
		and target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
		and target_25.getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_25.getStmt(1) instanceof ExprStmt
		and target_25.getStmt(2) instanceof ExprStmt
}

predicate func_26(Parameter vjournal_843, Variable vwait_852, AddressOfExpr target_26) {
		target_26.getOperand().(PointerFieldAccess).getTarget().getName()="j_wait_updates"
		and target_26.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjournal_843
		and target_26.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("finish_wait")
		and target_26.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vwait_852
}

predicate func_27(Variable vcommit_transaction_845, AddressOfExpr target_27) {
		target_27.getOperand().(PointerFieldAccess).getTarget().getName()="t_updates"
		and target_27.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
}

predicate func_28(Variable vcommit_transaction_845, AddressOfExpr target_28) {
		target_28.getOperand().(PointerFieldAccess).getTarget().getName()="t_handle_lock"
		and target_28.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcommit_transaction_845
		and target_28.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
}

from Function func, Parameter vjournal_843, Variable vcommit_transaction_845, Variable vwait_852, Initializer target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, VariableAccess target_4, FunctionCall target_6, FunctionCall target_7, ExprStmt target_14, ExprStmt target_15, ExprStmt target_17, ExprStmt target_18, ReturnStmt target_19, FunctionCall target_20, PointerFieldAccess target_21, ReturnStmt target_22, AddressOfExpr target_23, NotExpr target_24, BlockStmt target_25, AddressOfExpr target_26, AddressOfExpr target_27, AddressOfExpr target_28
where
func_0(vjournal_843, target_0)
and func_1(vcommit_transaction_845, target_1)
and func_2(vcommit_transaction_845, target_2)
and func_3(vcommit_transaction_845, target_3)
and func_4(vcommit_transaction_845, target_4)
and func_6(vcommit_transaction_845, target_6)
and func_7(vcommit_transaction_845, target_23, target_7)
and not func_9(target_24, func)
and not func_10(target_25, func)
and not func_11(target_20, func)
and not func_12(vjournal_843, target_26)
and func_14(vjournal_843, target_20, target_14)
and func_15(target_20, func, target_15)
and func_17(vjournal_843, target_20, target_17)
and func_18(vjournal_843, vwait_852, target_18)
and func_19(target_24, func, target_19)
and func_20(vcommit_transaction_845, target_25, target_27, target_28, target_20)
and func_21(vcommit_transaction_845, target_23, target_21)
and func_22(func, target_22)
and func_23(vcommit_transaction_845, target_23)
and func_24(vcommit_transaction_845, target_24)
and func_25(vcommit_transaction_845, target_25)
and func_26(vjournal_843, vwait_852, target_26)
and func_27(vcommit_transaction_845, target_27)
and func_28(vcommit_transaction_845, target_28)
and vjournal_843.getType().hasName("journal_t *")
and vcommit_transaction_845.getType().hasName("transaction_t *")
and vwait_852.getType().hasName("wait_queue_entry")
and vjournal_843.getFunction() = func
and vcommit_transaction_845.(LocalVariable).getFunction() = func
and vwait_852.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
