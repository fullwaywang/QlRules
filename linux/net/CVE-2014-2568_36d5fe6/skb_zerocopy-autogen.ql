/**
 * @name linux-36d5fe6a000790f56039afe26834265db0a3ad4c-skb_zerocopy
 * @id cpp/linux/36d5fe6a000790f56039afe26834265db0a3ad4c/skb-zerocopy
 * @description linux-36d5fe6a000790f56039afe26834265db0a3ad4c-net/core/skbuff.c-skb_zerocopy CVE-2014-2568
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(VariableAccess target_11, Function func) {
	exists(ReturnStmt target_0 |
		target_0.getExpr() instanceof FunctionCall
		and target_0.getParent().(IfStmt).getCondition()=target_11
		and target_0.getEnclosingFunction() = func)
}

predicate func_1(Function func) {
	exists(AssignExpr target_1 |
		target_1.getLValue().(VariableAccess).getType().hasName("int")
		and target_1.getRValue() instanceof FunctionCall
		and target_1.getEnclosingFunction() = func)
}

predicate func_2(VariableAccess target_11, Function func) {
	exists(IfStmt target_2 |
		target_2.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_2.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getType().hasName("int")
		and target_2.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_2.getThen().(ReturnStmt).getExpr().(VariableAccess).getType().hasName("int")
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_2
		and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Parameter vfrom_2132, ExprStmt target_12, Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("skb_orphan_frags")
		and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfrom_2132
		and target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(1).(Literal).getValue()="32"
		and target_3.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("skb_tx_error")
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfrom_2132
		and target_3.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-12"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
		and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_4(Parameter vfrom_2132) {
	exists(FunctionCall target_4 |
		target_4.getTarget().hasName("skb_tx_error")
		and target_4.getArgument(0).(VariableAccess).getTarget()=vfrom_2132)
}

*/
/*predicate func_5(Function func) {
	exists(UnaryMinusExpr target_5 |
		target_5.getValue()="-12"
		and target_5.getEnclosingFunction() = func)
}

*/
predicate func_7(Parameter vlen_2132, Parameter vto_2132, BlockStmt target_16, RelationalOperation target_7) {
		 (target_7 instanceof GEExpr or target_7 instanceof LEExpr)
		and target_7.getLesserOperand().(VariableAccess).getTarget()=vlen_2132
		and target_7.getGreaterOperand().(FunctionCall).getTarget().hasName("skb_tailroom")
		and target_7.getGreaterOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
		and target_7.getParent().(IfStmt).getThen()=target_16
}

predicate func_8(Parameter vfrom_2132, Parameter vlen_2132, Parameter vto_2132, FunctionCall target_8) {
		target_8.getTarget().hasName("skb_copy_bits")
		and target_8.getArgument(0).(VariableAccess).getTarget()=vfrom_2132
		and target_8.getArgument(1).(Literal).getValue()="0"
		and target_8.getArgument(2).(FunctionCall).getTarget().hasName("skb_put")
		and target_8.getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
		and target_8.getArgument(2).(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vlen_2132
		and target_8.getArgument(3).(VariableAccess).getTarget()=vlen_2132
}

predicate func_9(Parameter vfrom_2132, Parameter vhlen_2132, Parameter vto_2132, FunctionCall target_9) {
		target_9.getTarget().hasName("skb_copy_bits")
		and target_9.getArgument(0).(VariableAccess).getTarget()=vfrom_2132
		and target_9.getArgument(1).(Literal).getValue()="0"
		and target_9.getArgument(2).(FunctionCall).getTarget().hasName("skb_put")
		and target_9.getArgument(2).(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
		and target_9.getArgument(2).(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vhlen_2132
		and target_9.getArgument(3).(VariableAccess).getTarget()=vhlen_2132
}

predicate func_10(Parameter vlen_2132, Variable vj_2134, Variable vplen_2135, Variable vpage_2136, Variable voffset_2137, Parameter vto_2132, VariableAccess target_11, BlockStmt target_10) {
		target_10.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vplen_2135
		and target_10.getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vplen_2135
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vpage_2136
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("virt_to_head_page")
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="head"
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_2137
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="data"
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getTarget().hasName("lowmem_page_address")
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__skb_fill_page_desc")
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vto_2132
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vpage_2136
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=voffset_2137
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=vplen_2135
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("get_page")
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_2136
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vj_2134
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_2132
		and target_10.getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(5).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vplen_2135
		and target_10.getParent().(IfStmt).getCondition()=target_11
}

predicate func_11(Parameter vhlen_2132, BlockStmt target_17, VariableAccess target_11) {
		target_11.getTarget()=vhlen_2132
		and target_11.getParent().(IfStmt).getThen()=target_17
}

predicate func_12(Parameter vfrom_2132, Variable vpage_2136, Variable voffset_2137, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=voffset_2137
		and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="data"
		and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfrom_2132
		and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getTarget().hasName("lowmem_page_address")
		and target_12.getExpr().(AssignExpr).getRValue().(PointerArithmeticOperation).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpage_2136
}

predicate func_16(Function func, BlockStmt target_16) {
		target_16.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_16.getEnclosingFunction() = func
}

predicate func_17(Parameter vlen_2132, Parameter vhlen_2132, BlockStmt target_17) {
		target_17.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vlen_2132
		and target_17.getStmt(1).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vhlen_2132
}

from Function func, Parameter vfrom_2132, Parameter vlen_2132, Parameter vhlen_2132, Variable vj_2134, Variable vplen_2135, Variable vpage_2136, Variable voffset_2137, Parameter vto_2132, RelationalOperation target_7, FunctionCall target_8, FunctionCall target_9, BlockStmt target_10, VariableAccess target_11, ExprStmt target_12, BlockStmt target_16, BlockStmt target_17
where
not func_0(target_11, func)
and not func_1(func)
and not func_2(target_11, func)
and not func_3(vfrom_2132, target_12, func)
and func_7(vlen_2132, vto_2132, target_16, target_7)
and func_8(vfrom_2132, vlen_2132, vto_2132, target_8)
and func_9(vfrom_2132, vhlen_2132, vto_2132, target_9)
and func_10(vlen_2132, vj_2134, vplen_2135, vpage_2136, voffset_2137, vto_2132, target_11, target_10)
and func_11(vhlen_2132, target_17, target_11)
and func_12(vfrom_2132, vpage_2136, voffset_2137, target_12)
and func_16(func, target_16)
and func_17(vlen_2132, vhlen_2132, target_17)
and vfrom_2132.getType().hasName("const sk_buff *")
and vlen_2132.getType().hasName("int")
and vhlen_2132.getType().hasName("int")
and vj_2134.getType().hasName("int")
and vplen_2135.getType().hasName("int")
and vpage_2136.getType().hasName("page *")
and voffset_2137.getType().hasName("unsigned int")
and vto_2132.getType().hasName("sk_buff *")
and vfrom_2132.getFunction() = func
and vlen_2132.getFunction() = func
and vhlen_2132.getFunction() = func
and vj_2134.(LocalVariable).getFunction() = func
and vplen_2135.(LocalVariable).getFunction() = func
and vpage_2136.(LocalVariable).getFunction() = func
and voffset_2137.(LocalVariable).getFunction() = func
and vto_2132.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
