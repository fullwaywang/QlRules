/**
 * @name linux-8f363b77ee4fbf7c3bbcf5ec2c5ca482d396d664-tcp_illinois_info
 * @id cpp/linux/8f363b77ee4fbf7c3bbcf5ec2c5ca482d396d664/tcp-illinois-info
 * @description linux-8f363b77ee4fbf7c3bbcf5ec2c5ca482d396d664-net/ipv4/tcp_illinois.c-tcp_illinois_info CVE-2012-4565
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vinfo_311, BitwiseAndExpr target_9) {
exists(IfStmt target_0 |
	target_0.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getTarget().getName()="tcpv_rttcnt"
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_311
	and target_0.getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(4) instanceof ExprStmt
	and target_0.getThen().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_0
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9)
}

predicate func_1(Variable vinfo_311, ExprStmt target_7) {
exists(ValueFieldAccess target_1 |
	target_1.getTarget().getName()="tcpv_rttcnt"
	and target_1.getQualifier().(VariableAccess).getTarget()=vinfo_311
	and target_1.getQualifier().(VariableAccess).getLocation().isBefore(target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Variable vt_316, Variable v__base_318, Variable v__rem_318, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=v__rem_318
	and target_3.getExpr().(AssignExpr).getRValue().(RemExpr).getLeftOperand().(VariableAccess).getTarget()=vt_316
	and target_3.getExpr().(AssignExpr).getRValue().(RemExpr).getRightOperand().(VariableAccess).getTarget()=v__base_318
}

predicate func_4(Variable vt_316, Variable v__base_318, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vt_316
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(VariableAccess).getTarget()=vt_316
	and target_4.getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(VariableAccess).getTarget()=v__base_318
}

predicate func_5(Variable v__rem_318, ExprStmt target_5) {
	target_5.getExpr().(VariableAccess).getTarget()=v__rem_318
}

predicate func_6(BitwiseAndExpr target_9, Function func, DeclStmt target_6) {
	target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Variable vinfo_311, Variable vt_316, BitwiseAndExpr target_9, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="tcpv_rtt"
	and target_7.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vinfo_311
	and target_7.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vt_316
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

predicate func_8(Variable vca_308, PointerFieldAccess target_8) {
	target_8.getTarget().getName()="cnt_rtt"
	and target_8.getQualifier().(VariableAccess).getTarget()=vca_308
}

predicate func_9(Function func, BitwiseAndExpr target_9) {
	target_9.getLeftOperand().(VariableAccess).getTarget().getType().hasName("u32")
	and target_9.getRightOperand().(BinaryBitwiseOperation).getValue()="4"
	and target_9.getEnclosingFunction() = func
}

from Function func, Variable vca_308, Variable vinfo_311, Variable vt_316, Variable v__base_318, Variable v__rem_318, ExprStmt target_3, ExprStmt target_4, ExprStmt target_5, DeclStmt target_6, ExprStmt target_7, PointerFieldAccess target_8, BitwiseAndExpr target_9
where
not func_0(vinfo_311, target_9)
and not func_1(vinfo_311, target_7)
and func_3(vt_316, v__base_318, v__rem_318, target_3)
and func_4(vt_316, v__base_318, target_4)
and func_5(v__rem_318, target_5)
and func_6(target_9, func, target_6)
and func_7(vinfo_311, vt_316, target_9, target_7)
and func_8(vca_308, target_8)
and func_9(func, target_9)
and vca_308.getType().hasName("const illinois *")
and vinfo_311.getType().hasName("tcpvegas_info")
and vt_316.getType().hasName("u64")
and v__base_318.getType().hasName("uint32_t")
and v__rem_318.getType().hasName("uint32_t")
and vca_308.(LocalVariable).getFunction() = func
and vinfo_311.(LocalVariable).getFunction() = func
and vt_316.(LocalVariable).getFunction() = func
and v__base_318.(LocalVariable).getFunction() = func
and v__rem_318.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
