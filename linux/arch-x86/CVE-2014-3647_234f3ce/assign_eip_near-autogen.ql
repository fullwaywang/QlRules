/**
 * @name linux-234f3ce485d54017f15cf5e0699cff4100121601-assign_eip_near
 * @id cpp/linux/234f3ce485d54017f15cf5e0699cff4100121601/assign-eip-near
 * @description linux-234f3ce485d54017f15cf5e0699cff4100121601-arch/x86/kvm/emulate.c-assign_eip_near CVE-2014-3647
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vctxt_567, Parameter vdst_567, ExprStmt target_6, ExprStmt target_9) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("assign_eip_far")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vctxt_567
	and target_0.getArgument(1).(VariableAccess).getTarget()=vdst_567
	and target_0.getArgument(2).(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="mode"
	and target_0.getArgument(2).(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getArgument(1).(VariableAccess).getLocation().isBefore(target_9.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vctxt_567, VariableAccess target_1) {
	target_1.getTarget()=vctxt_567
}

/*predicate func_2(Parameter vctxt_567, VariableAccess target_2) {
	target_2.getTarget()=vctxt_567
}

*/
predicate func_3(Parameter vctxt_567, Parameter vdst_567, VariableAccess target_3) {
	target_3.getTarget()=vdst_567
	and target_3.getParent().(AssignExpr).getRValue() = target_3
	and target_3.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_3.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
}

predicate func_4(Parameter vctxt_567, Parameter vdst_567, Function func, SwitchStmt target_4) {
	target_4.getExpr().(PointerFieldAccess).getTarget().getName()="op_bytes"
	and target_4.getExpr().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_4.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="2"
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_4.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_4.getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="4"
	and target_4.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_4.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_4.getStmt().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_4.getStmt().(BlockStmt).getStmt(6).(SwitchCase).getExpr().(Literal).getValue()="8"
	and target_4.getStmt().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_4.getStmt().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_4.getStmt().(BlockStmt).getStmt(7).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_4.getStmt().(BlockStmt).getStmt(9).(SwitchCase).toString() = "default: "
	and target_4.getStmt().(BlockStmt).getStmt(10).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_4.getStmt().(BlockStmt).getStmt(10).(ExprStmt).getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

/*predicate func_5(Function func, SwitchCase target_5) {
	target_5.getExpr().(Literal).getValue()="2"
	and target_5.getEnclosingFunction() = func
}

*/
predicate func_6(Parameter vctxt_567, Parameter vdst_567, PointerFieldAccess target_19, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_6.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_6.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_6.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
}

/*predicate func_7(PointerFieldAccess target_19, Function func, BreakStmt target_7) {
	target_7.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
	and target_7.getEnclosingFunction() = func
}

*/
/*predicate func_8(Function func, SwitchCase target_8) {
	target_8.getExpr().(Literal).getValue()="4"
	and target_8.getEnclosingFunction() = func
}

*/
predicate func_9(Parameter vctxt_567, Parameter vdst_567, PointerFieldAccess target_19, ExprStmt target_9) {
	target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_9.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_9.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
}

/*predicate func_10(PointerFieldAccess target_19, Function func, BreakStmt target_10) {
	target_10.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
	and target_10.getEnclosingFunction() = func
}

*/
/*predicate func_11(Function func, SwitchCase target_11) {
	target_11.getExpr().(Literal).getValue()="8"
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_12(Parameter vctxt_567, Parameter vdst_567, PointerFieldAccess target_19, ExprStmt target_9, ExprStmt target_12) {
	target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="_eip"
	and target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctxt_567
	and target_12.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vdst_567
	and target_12.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
	and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
/*predicate func_13(PointerFieldAccess target_19, Function func, BreakStmt target_13) {
	target_13.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
	and target_13.getEnclosingFunction() = func
}

*/
/*predicate func_14(Function func, SwitchCase target_14) {
	target_14.toString() = "default: "
	and target_14.getEnclosingFunction() = func
}

*/
/*predicate func_15(PointerFieldAccess target_19, Function func, ExprStmt target_15) {
	target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("warn_slowpath_fmt")
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="unsupported eip assignment size\n"
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_15.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_15.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_19
	and target_15.getEnclosingFunction() = func
}

*/
/*predicate func_17(Variable v__ret_warn_on_580, IfStmt target_17) {
	target_17.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_17.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_580
	and target_17.getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("warn_slowpath_fmt")
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0) instanceof StringLiteral
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_17.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(StringLiteral).getValue()="unsupported eip assignment size\n"
}

*/
/*predicate func_18(Variable v__ret_warn_on_580, ExprStmt target_18) {
	target_18.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
	and target_18.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_on_580
	and target_18.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

*/
predicate func_19(Parameter vctxt_567, PointerFieldAccess target_19) {
	target_19.getTarget().getName()="op_bytes"
	and target_19.getQualifier().(VariableAccess).getTarget()=vctxt_567
}

from Function func, Parameter vctxt_567, Parameter vdst_567, Variable v__ret_warn_on_580, VariableAccess target_1, VariableAccess target_3, SwitchStmt target_4, ExprStmt target_6, ExprStmt target_9, PointerFieldAccess target_19
where
not func_0(vctxt_567, vdst_567, target_6, target_9)
and func_1(vctxt_567, target_1)
and func_3(vctxt_567, vdst_567, target_3)
and func_4(vctxt_567, vdst_567, func, target_4)
and func_6(vctxt_567, vdst_567, target_19, target_6)
and func_9(vctxt_567, vdst_567, target_19, target_9)
and func_19(vctxt_567, target_19)
and vctxt_567.getType().hasName("x86_emulate_ctxt *")
and vdst_567.getType().hasName("ulong")
and v__ret_warn_on_580.getType().hasName("int")
and vctxt_567.getFunction() = func
and vdst_567.getFunction() = func
and v__ret_warn_on_580.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
