/**
 * @name linux-74e7e1efdad45580cc3839f2a155174cf158f9b5-xenvif_rx_queue_tail
 * @id cpp/linux/74e7e1efdad45580cc3839f2a155174cf158f9b5/xenvif-rx-queue-tail
 * @description linux-74e7e1efdad45580cc3839f2a155174cf158f9b5-drivers/net/xen-netback/rx.c-xenvif_rx_queue_tail CVE-2022-42329
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(AssignExpr target_0 |
		target_0.getLValue().(VariableAccess).getType().hasName("bool")
		and target_0.getEnclosingFunction() = func)
}

predicate func_2(Parameter vskb_85, FunctionCall target_2) {
		target_2.getTarget().hasName("kfree_skb")
		and target_2.getArgument(0).(VariableAccess).getTarget()=vskb_85
}

predicate func_3(Parameter vqueue_85, RelationalOperation target_4, ExprStmt target_3) {
		target_3.getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rx_dropped"
		and target_3.getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="stats"
		and target_3.getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="dev"
		and target_3.getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
		and target_3.getExpr().(PostfixIncrExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_85
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
}

predicate func_4(Parameter vqueue_85, RelationalOperation target_4) {
		 (target_4 instanceof GEExpr or target_4 instanceof LEExpr)
		and target_4.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="rx_queue_len"
		and target_4.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_85
		and target_4.getLesserOperand().(PointerFieldAccess).getTarget().getName()="rx_queue_max"
		and target_4.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vqueue_85
}

from Function func, Parameter vqueue_85, Parameter vskb_85, FunctionCall target_2, ExprStmt target_3, RelationalOperation target_4
where
not func_0(func)
and func_2(vskb_85, target_2)
and func_3(vqueue_85, target_4, target_3)
and func_4(vqueue_85, target_4)
and vqueue_85.getType().hasName("xenvif_queue *")
and vskb_85.getType().hasName("sk_buff *")
and vqueue_85.getFunction() = func
and vskb_85.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
