/**
 * @name linux-b22f5126a24b3b2f15448c3f2a254fc10cbc2b92-dccp_new
 * @id cpp/linux/b22f5126a24b3b2f15448c3f2a254fc10cbc2b92/dccp-new
 * @description linux-b22f5126a24b3b2f15448c3f2a254fc10cbc2b92-net/netfilter/nf_conntrack_proto_dccp.c-dccp_new CVE-2014-2523
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable v_dh_427) {
	exists(AddressOfExpr target_0 |
		target_0.getOperand().(VariableAccess).getTarget()=v_dh_427
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_header_pointer")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("const sk_buff *")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="12"
		and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3) instanceof AddressOfExpr)
}

predicate func_1(Variable vdh_427, AddressOfExpr target_1) {
		target_1.getOperand().(VariableAccess).getTarget()=vdh_427
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("skb_header_pointer")
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("const sk_buff *")
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_1.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="12"
}

from Function func, Variable v_dh_427, Variable vdh_427, AddressOfExpr target_1
where
not func_0(v_dh_427)
and func_1(vdh_427, target_1)
and v_dh_427.getType().hasName("dccp_hdr")
and vdh_427.getType().hasName("dccp_hdr *")
and v_dh_427.(LocalVariable).getFunction() = func
and vdh_427.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
