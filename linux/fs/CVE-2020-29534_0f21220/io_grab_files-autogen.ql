/**
 * @name linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-io_grab_files
 * @id cpp/linux/0f2122045b946241a9e549c2a76cea54fa58a7ff/io-grab-files
 * @description linux-0f2122045b946241a9e549c2a76cea54fa58a7ff-fs/io_uring.c-io_grab_files CVE-2020-29534
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vreq_6068) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("get_files_struct")
	and target_0.getArgument(0) instanceof FunctionCall
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_0.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_0.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068)
}

predicate func_1(Variable vctx_6071, Parameter vreq_6068, EqualityOperation target_15, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("list_add")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="inflight_entry"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="inflight_list"
	and target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_2(Parameter vreq_6068, EqualityOperation target_15, ExprStmt target_2) {
	target_2.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="flags"
	and target_2.getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

predicate func_3(Function func, FunctionCall target_3) {
	target_3.getTarget().hasName("get_current")
	and target_3.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(EQExpr).getLeftOperand() instanceof FunctionCall
	and target_3.getEnclosingFunction() = func
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vctx_6071, Function func, IfStmt target_6) {
	target_6.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_6.getCondition().(NotExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_6.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-9"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

/*predicate func_7(Function func, UnaryMinusExpr target_7) {
	target_7.getValue()="-9"
	and target_7.getEnclosingFunction() = func
}

*/
predicate func_8(Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("rcu_read_lock")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Variable vret_6070, Variable vctx_6071, Parameter vreq_6068, Function func, IfStmt target_9) {
	target_9.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getTarget().hasName("fcheck_files")
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="files"
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier() instanceof FunctionCall
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="ring_fd"
	and target_9.getCondition().(EqualityOperation).getLeftOperand().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_9.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_9.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
	and target_9.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_9.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="files"
	and target_9.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_6070
	and target_9.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

/*predicate func_10(Parameter vreq_6068, EqualityOperation target_15, ExprStmt target_10) {
	target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="files"
	and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="work"
	and target_10.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_6068
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="files"
	and target_10.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_10.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
}

*/
/*predicate func_11(Function func, PointerFieldAccess target_11) {
	target_11.getTarget().getName()="files"
	and target_11.getQualifier().(FunctionCall).getTarget().hasName("get_current")
	and target_11.getEnclosingFunction() = func
}

*/
/*predicate func_12(Variable vret_6070, AssignExpr target_12) {
	target_12.getLValue().(VariableAccess).getTarget()=vret_6070
	and target_12.getRValue() instanceof Literal
}

*/
predicate func_13(Function func, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("rcu_read_unlock")
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

predicate func_14(Variable vret_6070, Function func, ReturnStmt target_14) {
	target_14.getExpr().(VariableAccess).getTarget()=vret_6070
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

predicate func_15(Variable vctx_6071, EqualityOperation target_15) {
	target_15.getLeftOperand() instanceof FunctionCall
	and target_15.getRightOperand().(PointerFieldAccess).getTarget().getName()="ring_file"
	and target_15.getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctx_6071
}

from Function func, Variable vret_6070, Variable vctx_6071, Parameter vreq_6068, ExprStmt target_1, ExprStmt target_2, FunctionCall target_3, DeclStmt target_5, IfStmt target_6, ExprStmt target_8, IfStmt target_9, ExprStmt target_13, ReturnStmt target_14, EqualityOperation target_15
where
not func_0(vreq_6068)
and func_1(vctx_6071, vreq_6068, target_15, target_1)
and func_2(vreq_6068, target_15, target_2)
and func_3(func, target_3)
and func_5(func, target_5)
and func_6(vctx_6071, func, target_6)
and func_8(func, target_8)
and func_9(vret_6070, vctx_6071, vreq_6068, func, target_9)
and func_13(func, target_13)
and func_14(vret_6070, func, target_14)
and func_15(vctx_6071, target_15)
and vret_6070.getType().hasName("int")
and vctx_6071.getType().hasName("io_ring_ctx *")
and vreq_6068.getType().hasName("io_kiocb *")
and vret_6070.(LocalVariable).getFunction() = func
and vctx_6071.(LocalVariable).getFunction() = func
and vreq_6068.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
