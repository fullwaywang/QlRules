/**
 * @name linux-8cc342508f9e7fdccd2e9758ae9d52aff72dab7f-srp_remove_one
 * @id cpp/linux/8cc342508f9e7fdccd2e9758ae9d52aff72dab7f/srp-remove-one
 * @description linux-8cc342508f9e7fdccd2e9758ae9d52aff72dab7f-drivers/infiniband/ulp/srp/ib_srp.c-srp_remove_one CVE-2022-48930
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vsystem_long_wq, ExprStmt target_0) {
	exists(FunctionCall obj_0 | obj_0=target_0.getExpr() |
		obj_0.getTarget().hasName("flush_workqueue")
		and obj_0.getArgument(0).(VariableAccess).getTarget()=vsystem_long_wq
	)
}

from Function func, Variable vsystem_long_wq, ExprStmt target_0
where
func_0(vsystem_long_wq, target_0)
and vsystem_long_wq.getType().hasName("workqueue_struct *")
and not vsystem_long_wq.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
