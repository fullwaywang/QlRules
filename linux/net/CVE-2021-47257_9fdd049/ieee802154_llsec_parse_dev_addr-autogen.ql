/**
 * @name linux-9fdd04918a452980631ecc499317881c1d120b70-ieee802154_llsec_parse_dev_addr
 * @id cpp/linux/9fdd04918a452980631ecc499317881c1d120b70/ieee802154-llsec-parse-dev-addr
 * @description linux-9fdd04918a452980631ecc499317881c1d120b70-net/ieee802154/nl802154.c-ieee802154_llsec_parse_dev_addr CVE-2021-47257
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(PointerFieldAccess target_7, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand() instanceof ArrayExpr
	and target_0.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_0.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_7
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(PointerFieldAccess target_7, Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(NotExpr).getOperand() instanceof ArrayExpr
	and target_1.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_1.getParent().(BlockStmt).getParent().(SwitchStmt).getExpr()=target_7
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Variable vattrs_1296, ReturnStmt target_8, LogicalOrExpr target_2) {
	target_2.getLeftOperand().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vattrs_1296
	and target_2.getRightOperand().(NotExpr).getOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vattrs_1296
	and target_2.getParent().(LogicalOrExpr).getRightOperand().(NotExpr).getOperand() instanceof LogicalOrExpr
	and target_2.getParent().(LogicalOrExpr).getParent().(IfStmt).getThen()=target_8
}

predicate func_3(Variable vattrs_1296, ArrayExpr target_3) {
	target_3.getArrayBase().(VariableAccess).getTarget()=vattrs_1296
}

predicate func_4(Variable vattrs_1296, ArrayExpr target_4) {
	target_4.getArrayBase().(VariableAccess).getTarget()=vattrs_1296
}

predicate func_5(ReturnStmt target_8, Function func, LogicalOrExpr target_5) {
	target_5.getLeftOperand() instanceof LogicalOrExpr
	and target_5.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getLeftOperand() instanceof ArrayExpr
	and target_5.getRightOperand().(NotExpr).getOperand().(LogicalOrExpr).getRightOperand() instanceof ArrayExpr
	and target_5.getParent().(IfStmt).getThen()=target_8
	and target_5.getEnclosingFunction() = func
}

/*predicate func_6(Function func, LogicalOrExpr target_6) {
	target_6.getLeftOperand() instanceof ArrayExpr
	and target_6.getRightOperand() instanceof ArrayExpr
	and target_6.getEnclosingFunction() = func
}

*/
predicate func_7(Function func, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="mode"
	and target_7.getQualifier().(VariableAccess).getTarget().getType().hasName("ieee802154_addr *")
	and target_7.getEnclosingFunction() = func
}

predicate func_8(LogicalOrExpr target_5, Function func, ReturnStmt target_8) {
	target_8.getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_8.getParent().(IfStmt).getCondition()=target_5
	and target_8.getEnclosingFunction() = func
}

from Function func, Variable vattrs_1296, LogicalOrExpr target_2, ArrayExpr target_3, ArrayExpr target_4, LogicalOrExpr target_5, PointerFieldAccess target_7, ReturnStmt target_8
where
not func_0(target_7, func)
and not func_1(target_7, func)
and func_2(vattrs_1296, target_8, target_2)
and func_3(vattrs_1296, target_3)
and func_4(vattrs_1296, target_4)
and func_5(target_8, func, target_5)
and func_7(func, target_7)
and func_8(target_5, func, target_8)
and vattrs_1296.getType().hasName("nlattr *[6]")
and vattrs_1296.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
