/**
 * @name linux-9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6-crypto_ahash_report
 * @id cpp/linux/9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6/crypto-ahash-report
 * @description linux-9a5467bf7b6e9e02ec9c3da4e23747c05faeaac6-crypto/ahash.c-crypto_ahash_report CVE-2013-2546
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vrhash_405, FunctionCall target_0) {
		target_0.getTarget().hasName("snprintf")
		and not target_0.getTarget().hasName("atomic_read")
		and target_0.getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
		and target_0.getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrhash_405
		and target_0.getArgument(1).(Literal).getValue()="64"
		and target_0.getArgument(2).(StringLiteral).getValue()="%s"
		and target_0.getArgument(3).(StringLiteral).getValue()="ahash"
}

predicate func_2(Function func, SizeofTypeOperator target_2) {
		target_2.getType() instanceof LongType
		and target_2.getValue()="72"
		and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter valg_403, Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(FunctionCall).getTarget().hasName("strncpy")
		and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_name"
		and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_3.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_name"
		and target_3.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_3.getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="64"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Parameter valg_403) {
	exists(FunctionCall target_4 |
		target_4.getTarget().hasName("strncpy")
		and target_4.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_driver_name"
		and target_4.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_4.getArgument(1).(PointerFieldAccess).getTarget().getName()="cra_driver_name"
		and target_4.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_4.getArgument(2).(SizeofExprOperator).getValue()="64")
}

predicate func_5(Function func) {
	exists(FunctionCall target_5 |
		target_5.getTarget().hasName("strncpy")
		and target_5.getArgument(0).(PointerFieldAccess).getTarget().getName()="cru_module_name"
		and target_5.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_5.getArgument(1).(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(VariableAccess).getType().hasName("module *")
		and target_5.getArgument(1).(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getThen().(PointerFieldAccess).getTarget().getName()="name"
		and target_5.getArgument(1).(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getThen().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("module *")
		and target_5.getArgument(1).(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(ConditionalExpr).getElse().(StringLiteral).getValue()="kernel"
		and target_5.getArgument(2).(SizeofExprOperator).getValue()="64"
		and target_5.getEnclosingFunction() = func)
}

predicate func_7(Function func) {
	exists(AssignExpr target_7 |
		target_7.getLValue().(PointerFieldAccess).getTarget().getName()="cru_type"
		and target_7.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_7.getRValue().(Literal).getValue()="0"
		and target_7.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cru_mask"
		and target_8.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_8.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

predicate func_9(Parameter valg_403, Function func) {
	exists(ExprStmt target_9 |
		target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cru_flags"
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="cra_flags"
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9)
}

predicate func_10(Parameter valg_403, Function func) {
	exists(ExprStmt target_10 |
		target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cru_refcnt"
		and target_10.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_user_alg *")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("atomic_read")
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="cra_refcnt"
		and target_10.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10)
}

/*predicate func_11(Parameter valg_403) {
	exists(AddressOfExpr target_11 |
		target_11.getOperand().(PointerFieldAccess).getTarget().getName()="cra_refcnt"
		and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_11.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall)
}

*/
predicate func_12(Parameter vskb_403, Parameter valg_403, Function func) {
	exists(IfStmt target_12 |
		target_12.getCondition().(FunctionCall).getTarget().hasName("nla_put_u32")
		and target_12.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_12.getCondition().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="cra_priority"
		and target_12.getCondition().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_12)
}

predicate func_13(Parameter vskb_403, Parameter valg_403, FunctionCall target_33, Function func) {
	exists(IfStmt target_13 |
		target_13.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cra_flags"
		and target_13.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_13.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="16"
		and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("strncpy")
		and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="type"
		and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(VariableAccess).getType().hasName("crypto_report_larval")
		and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="larval"
		and target_13.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="64"
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("nla_put")
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofTypeOperator).getType() instanceof LongType
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SizeofTypeOperator).getValue()="64"
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("crypto_report_larval")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
		and target_13.getThen().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_33.getArgument(0).(VariableAccess).getLocation()))
}

/*predicate func_17(Parameter vskb_403) {
	exists(AddressOfExpr target_17 |
		target_17.getOperand().(VariableAccess).getType().hasName("crypto_report_larval")
		and target_17.getParent().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_17.getParent().(FunctionCall).getArgument(1) instanceof EnumConstantAccess
		and target_17.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
		and target_17.getParent().(FunctionCall).getArgument(3) instanceof AddressOfExpr
		and target_17.getParent().(FunctionCall).getParent().(IfStmt).getThen() instanceof GotoStmt)
}

*/
predicate func_18(Parameter vskb_403, Parameter valg_403, Function func) {
	exists(IfStmt target_18 |
		target_18.getCondition().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="cra_type"
		and target_18.getCondition().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_18.getCondition().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="report"
		and target_18.getCondition().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_type"
		and target_18.getCondition().(LogicalAndExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="report"
		and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="cra_type"
		and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_18.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(VariableCall).getArgument(1).(VariableAccess).getTarget()=valg_403
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_18)
}

predicate func_19(Parameter vskb_403, Parameter valg_403, Function func) {
	exists(SwitchStmt target_19 |
		target_19.getExpr().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="cra_flags"
		and target_19.getExpr().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
		and target_19.getExpr().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="31"
		and target_19.getStmt().(BlockStmt).getStmt(0).(SwitchCase).getExpr().(Literal).getValue()="1"
		and target_19.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("crypto_report_cipher")
		and target_19.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_19.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=valg_403
		and target_19.getStmt().(BlockStmt).getStmt(3).(SwitchCase).getExpr().(Literal).getValue()="2"
		and target_19.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("crypto_report_comp")
		and target_19.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_19.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=valg_403
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_19)
}

/*predicate func_20(Parameter vskb_403, Parameter valg_403, FunctionCall target_34) {
	exists(FunctionCall target_20 |
		target_20.getTarget().hasName("crypto_report_comp")
		and target_20.getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_20.getArgument(1).(VariableAccess).getTarget()=valg_403
		and target_20.getParent().(IfStmt).getThen() instanceof GotoStmt
		and target_34.getArgument(0).(VariableAccess).getLocation().isBefore(target_20.getArgument(1).(VariableAccess).getLocation()))
}

*/
/*predicate func_21(FunctionCall target_33, Function func) {
	exists(GotoStmt target_21 |
		target_21.getParent().(IfStmt).getCondition()=target_33
		and target_21.getEnclosingFunction() = func)
}

*/
predicate func_22(Parameter valg_403, VariableAccess target_22) {
		target_22.getTarget()=valg_403
}

predicate func_23(Parameter vskb_403, VariableAccess target_23) {
		target_23.getTarget()=vskb_403
		and target_23.getParent().(FunctionCall).getArgument(1) instanceof EnumConstantAccess
		and target_23.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
		and target_23.getParent().(FunctionCall).getArgument(3) instanceof AddressOfExpr
		and target_23.getParent().(FunctionCall).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_24(Parameter valg_403, VariableAccess target_24) {
		target_24.getTarget()=valg_403
		and target_24.getParent().(FunctionCall).getParent().(PointerFieldAccess).getQualifier() instanceof FunctionCall
}

predicate func_26(Variable vrhash_405, VariableAccess target_26) {
		target_26.getTarget()=vrhash_405
		and target_26.getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_27(Parameter valg_403, Variable vrhash_405, AssignExpr target_27) {
		target_27.getLValue().(ValueFieldAccess).getTarget().getName()="blocksize"
		and target_27.getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrhash_405
		and target_27.getRValue().(PointerFieldAccess).getTarget().getName()="cra_blocksize"
		and target_27.getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=valg_403
}

predicate func_28(Parameter valg_403, Variable vrhash_405, AssignExpr target_28) {
		target_28.getLValue().(ValueFieldAccess).getTarget().getName()="digestsize"
		and target_28.getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vrhash_405
		and target_28.getRValue().(PointerFieldAccess).getTarget().getName()="digestsize"
		and target_28.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("__crypto_hash_alg_common")
		and target_28.getRValue().(PointerFieldAccess).getQualifier().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=valg_403
}

predicate func_29(Parameter vskb_403, Variable vrhash_405, AddressOfExpr target_29) {
		target_29.getOperand().(VariableAccess).getTarget()=vrhash_405
		and target_29.getParent().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_29.getParent().(FunctionCall).getArgument(1) instanceof EnumConstantAccess
		and target_29.getParent().(FunctionCall).getArgument(2) instanceof SizeofTypeOperator
		and target_29.getParent().(FunctionCall).getParent().(IfStmt).getThen() instanceof GotoStmt
}

predicate func_33(Parameter vskb_403, FunctionCall target_33) {
		target_33.getTarget().hasName("nla_put")
		and target_33.getArgument(0).(VariableAccess).getTarget()=vskb_403
		and target_33.getArgument(1) instanceof EnumConstantAccess
		and target_33.getArgument(2) instanceof SizeofTypeOperator
		and target_33.getArgument(3) instanceof AddressOfExpr
}

predicate func_34(Parameter valg_403, FunctionCall target_34) {
		target_34.getTarget().hasName("__crypto_hash_alg_common")
		and target_34.getArgument(0).(VariableAccess).getTarget()=valg_403
}

from Function func, Parameter vskb_403, Parameter valg_403, Variable vrhash_405, FunctionCall target_0, SizeofTypeOperator target_2, VariableAccess target_22, VariableAccess target_23, VariableAccess target_24, VariableAccess target_26, AssignExpr target_27, AssignExpr target_28, AddressOfExpr target_29, FunctionCall target_33, FunctionCall target_34
where
func_0(vrhash_405, target_0)
and func_2(func, target_2)
and not func_3(valg_403, func)
and not func_4(valg_403)
and not func_5(func)
and not func_7(func)
and not func_8(func)
and not func_9(valg_403, func)
and not func_10(valg_403, func)
and not func_12(vskb_403, valg_403, func)
and not func_13(vskb_403, valg_403, target_33, func)
and not func_18(vskb_403, valg_403, func)
and not func_19(vskb_403, valg_403, func)
and func_22(valg_403, target_22)
and func_23(vskb_403, target_23)
and func_24(valg_403, target_24)
and func_26(vrhash_405, target_26)
and func_27(valg_403, vrhash_405, target_27)
and func_28(valg_403, vrhash_405, target_28)
and func_29(vskb_403, vrhash_405, target_29)
and func_33(vskb_403, target_33)
and func_34(valg_403, target_34)
and vskb_403.getType().hasName("sk_buff *")
and valg_403.getType().hasName("crypto_alg *")
and vrhash_405.getType().hasName("crypto_report_hash")
and vskb_403.getFunction() = func
and valg_403.getFunction() = func
and vrhash_405.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
