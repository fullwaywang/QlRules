/**
 * @name linux-bcf85fcedfdd17911982a3e3564fcfec7b01eebd-romfs_dev_read
 * @id cpp/linux/bcf85fcedfdd17911982a3e3564fcfec7b01eebd/romfs-dev-read
 * @description linux-bcf85fcedfdd17911982a3e3564fcfec7b01eebd-fs/romfs/storage.c-romfs_dev_read CVE-2020-29371
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(ReturnStmt target_4, Function func) {
exists(LogicalOrExpr target_0 |
	target_0.getLeftOperand() instanceof RelationalOperation
	and target_0.getRightOperand() instanceof RelationalOperation
	and target_0.getParent().(IfStmt).getThen()=target_4
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Parameter vpos_214, Variable vlimit_217, ReturnStmt target_4, RelationalOperation target_1) {
	 (target_1 instanceof GEExpr or target_1 instanceof LEExpr)
	and target_1.getGreaterOperand().(VariableAccess).getTarget()=vpos_214
	and target_1.getLesserOperand().(VariableAccess).getTarget()=vlimit_217
	and target_1.getParent().(IfStmt).getThen()=target_4
}

predicate func_2(Parameter vpos_214, Parameter vbuflen_215, Variable vlimit_217, ExprStmt target_5, RelationalOperation target_2) {
	 (target_2 instanceof GTExpr or target_2 instanceof LTExpr)
	and target_2.getGreaterOperand().(VariableAccess).getTarget()=vbuflen_215
	and target_2.getLesserOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vlimit_217
	and target_2.getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vpos_214
	and target_2.getParent().(IfStmt).getThen()=target_5
}

predicate func_3(Parameter vpos_214, Parameter vbuflen_215, Variable vlimit_217, Function func, IfStmt target_3) {
	target_3.getCondition() instanceof RelationalOperation
	and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbuflen_215
	and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vlimit_217
	and target_3.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget()=vpos_214
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(RelationalOperation target_1, Function func, ReturnStmt target_4) {
	target_4.getExpr().(UnaryMinusExpr).getValue()="-5"
	and target_4.getParent().(IfStmt).getCondition()=target_1
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Function func, ExprStmt target_5) {
	target_5.getExpr() instanceof AssignExpr
	and target_5.getEnclosingFunction() = func
}

from Function func, Parameter vpos_214, Parameter vbuflen_215, Variable vlimit_217, RelationalOperation target_1, RelationalOperation target_2, IfStmt target_3, ReturnStmt target_4, ExprStmt target_5
where
not func_0(target_4, func)
and func_1(vpos_214, vlimit_217, target_4, target_1)
and func_2(vpos_214, vbuflen_215, vlimit_217, target_5, target_2)
and func_3(vpos_214, vbuflen_215, vlimit_217, func, target_3)
and func_4(target_1, func, target_4)
and func_5(func, target_5)
and vpos_214.getType().hasName("unsigned long")
and vbuflen_215.getType().hasName("size_t")
and vlimit_217.getType().hasName("size_t")
and vpos_214.getFunction() = func
and vbuflen_215.getFunction() = func
and vlimit_217.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
