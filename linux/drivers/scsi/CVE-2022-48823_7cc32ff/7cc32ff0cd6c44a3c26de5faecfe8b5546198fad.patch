commit 7cc32ff0cd6c44a3c26de5faecfe8b5546198fad
Author: Saurav Kashyap <skashyap@marvell.com>
Date:   Mon Jan 17 05:53:10 2022 -0800

    scsi: qedf: Fix refcount issue when LOGO is received during TMF
    
    [ Upstream commit 5239ab63f17cee643bd4bf6addfedebaa7d4f41e ]
    
    Hung task call trace was seen during LOGO processing.
    
    [  974.309060] [0000:00:00.0]:[qedf_eh_device_reset:868]: 1:0:2:0: LUN RESET Issued...
    [  974.309065] [0000:00:00.0]:[qedf_initiate_tmf:2422]: tm_flags 0x10 sc_cmd 00000000c16b930f op = 0x2a target_id = 0x2 lun=0
    [  974.309178] [0000:00:00.0]:[qedf_initiate_tmf:2431]: portid=016900 tm_flags =LUN RESET
    [  974.309222] [0000:00:00.0]:[qedf_initiate_tmf:2438]: orig io_req = 00000000ec78df8f xid = 0x180 ref_cnt = 1.
    [  974.309625] host1: rport 016900: Received LOGO request while in state Ready
    [  974.309627] host1: rport 016900: Delete port
    [  974.309642] host1: rport 016900: work event 3
    [  974.309644] host1: rport 016900: lld callback ev 3
    [  974.313243] [0000:61:00.2]:[qedf_execute_tmf:2383]:1: fcport is uploading, not executing flush.
    [  974.313295] [0000:61:00.2]:[qedf_execute_tmf:2400]:1: task mgmt command success...
    [  984.031088] INFO: task jbd2/dm-15-8:7645 blocked for more than 120 seconds.
    [  984.031136]       Not tainted 4.18.0-305.el8.x86_64 #1
    
    [  984.031166] "echo 0 > /proc/sys/kernel/hung_task_timeout_secs" disables this message.
    [  984.031209] jbd2/dm-15-8    D    0  7645      2 0x80004080
    [  984.031212] Call Trace:
    [  984.031222]  __schedule+0x2c4/0x700
    [  984.031230]  ? unfreeze_partials.isra.83+0x16e/0x1a0
    [  984.031233]  ? bit_wait_timeout+0x90/0x90
    [  984.031235]  schedule+0x38/0xa0
    [  984.031238]  io_schedule+0x12/0x40
    [  984.031240]  bit_wait_io+0xd/0x50
    [  984.031243]  __wait_on_bit+0x6c/0x80
    [  984.031248]  ? free_buffer_head+0x21/0x50
    [  984.031251]  out_of_line_wait_on_bit+0x91/0xb0
    [  984.031257]  ? init_wait_var_entry+0x50/0x50
    [  984.031268]  jbd2_journal_commit_transaction+0x112e/0x19f0 [jbd2]
    [  984.031280]  kjournald2+0xbd/0x270 [jbd2]
    [  984.031284]  ? finish_wait+0x80/0x80
    [  984.031291]  ? commit_timeout+0x10/0x10 [jbd2]
    [  984.031294]  kthread+0x116/0x130
    [  984.031300]  ? kthread_flush_work_fn+0x10/0x10
    [  984.031305]  ret_from_fork+0x1f/0x40
    
    There was a ref count issue when LOGO is received during TMF. This leads to
    one of the I/Os hanging with the driver. Fix the ref count.
    
    Link: https://lore.kernel.org/r/20220117135311.6256-3-njavali@marvell.com
    Signed-off-by: Saurav Kashyap <skashyap@marvell.com>
    Signed-off-by: Nilesh Javali <njavali@marvell.com>
    Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
    Signed-off-by: Sasha Levin <sashal@kernel.org>

diff --git a/drivers/scsi/qedf/qedf_io.c b/drivers/scsi/qedf/qedf_io.c
index 4e8a284e606c..d02d1ef0d011 100644
--- a/drivers/scsi/qedf/qedf_io.c
+++ b/drivers/scsi/qedf/qedf_io.c
@@ -2253,6 +2253,7 @@ int qedf_initiate_cleanup(struct qedf_ioreq *io_req,
 	    io_req->tm_flags == FCP_TMF_TGT_RESET) {
 		clear_bit(QEDF_CMD_OUTSTANDING, &io_req->flags);
 		io_req->sc_cmd = NULL;
+		kref_put(&io_req->refcount, qedf_release_cmd);
 		complete(&io_req->tm_done);
 	}
 
