/**
 * @name linux-a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8-ieee80211_frame_allowed
 * @id cpp/linux/a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8/ieee80211-frame-allowed
 * @description linux-a8c4d76a8dd4fb9666fc8919a703d85fb8f44ed8-net/mac80211/rx.c-ieee80211_frame_allowed CVE-2020-26139
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(ReturnStmt target_5, Function func) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("__builtin_expect")
	and target_0.getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand() instanceof EqualityOperation
	and target_0.getArgument(1).(Literal).getValue()="0"
	and target_0.getParent().(IfStmt).getThen()=target_5
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable vpae_group_addr_2529, Variable vehdr_2531, Parameter vrx_2527, ReturnStmt target_5, EqualityOperation target_1) {
	target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="h_proto"
	and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_1.getRightOperand().(PointerFieldAccess).getTarget().getName()="control_port_protocol"
	and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sdata"
	and target_1.getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrx_2527
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getTarget().hasName("ether_addr_equal")
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sdata"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(FunctionCall).getTarget().hasName("ether_addr_equal")
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_1.getParent().(LogicalAndExpr).getRightOperand().(LogicalOrExpr).getRightOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpae_group_addr_2529
	and target_1.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_5
}

/*predicate func_2(Variable vpae_group_addr_2529, Variable vehdr_2531, Parameter vrx_2527, ReturnStmt target_5, LogicalOrExpr target_2) {
	target_2.getLeftOperand().(FunctionCall).getTarget().hasName("ether_addr_equal")
	and target_2.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_2.getLeftOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_2.getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="addr"
	and target_2.getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="vif"
	and target_2.getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sdata"
	and target_2.getLeftOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrx_2527
	and target_2.getRightOperand().(FunctionCall).getTarget().hasName("ether_addr_equal")
	and target_2.getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="h_dest"
	and target_2.getRightOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_2.getRightOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpae_group_addr_2529
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="h_proto"
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vehdr_2531
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="control_port_protocol"
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="sdata"
	and target_2.getParent().(LogicalAndExpr).getLeftOperand().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vrx_2527
	and target_2.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_5
}

*/
predicate func_3(ReturnStmt target_5, Function func, LogicalAndExpr target_3) {
	target_3.getLeftOperand() instanceof EqualityOperation
	and target_3.getRightOperand() instanceof LogicalOrExpr
	and target_3.getParent().(IfStmt).getThen()=target_5
	and target_3.getEnclosingFunction() = func
}

predicate func_5(LogicalAndExpr target_3, Function func, ReturnStmt target_5) {
	target_5.getExpr() instanceof EnumConstantAccess
	and target_5.getParent().(IfStmt).getCondition()=target_3
	and target_5.getEnclosingFunction() = func
}

from Function func, Variable vpae_group_addr_2529, Variable vehdr_2531, Parameter vrx_2527, EqualityOperation target_1, LogicalAndExpr target_3, ReturnStmt target_5
where
not func_0(target_5, func)
and func_1(vpae_group_addr_2529, vehdr_2531, vrx_2527, target_5, target_1)
and func_3(target_5, func, target_3)
and func_5(target_3, func, target_5)
and vpae_group_addr_2529.getType().hasName("const u8[6]")
and vehdr_2531.getType().hasName("ethhdr *")
and vrx_2527.getType().hasName("ieee80211_rx_data *")
and vpae_group_addr_2529.(LocalVariable).getFunction() = func
and vehdr_2531.(LocalVariable).getFunction() = func
and vrx_2527.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
