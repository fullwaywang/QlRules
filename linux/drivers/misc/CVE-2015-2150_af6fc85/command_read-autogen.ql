/**
 * @name linux-af6fc858a35b90e89ea7a7ee58e66628c55c776b-command_read
 * @id cpp/linux/af6fc858a35b90e89ea7a7ee58e66628c55c776b/command-read
 * @description linux-af6fc858a35b90e89ea7a7ee58e66628c55c776b-drivers/xen/xen-pciback/conf_space_header.c-command_read CVE-2015-2150
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter voffset_23, Parameter vvalue_23, Parameter vdata_23, Variable vret_26, Parameter vdev_23, FunctionCall target_0) {
	target_0.getTarget().hasName("xen_pcibk_read_config_word")
	and not target_0.getTarget().hasName("pci_read_config_word")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vdev_23
	and target_0.getArgument(1).(VariableAccess).getTarget()=voffset_23
	and target_0.getArgument(2).(VariableAccess).getTarget()=vvalue_23
	and target_0.getArgument(3).(VariableAccess).getTarget()=vdata_23
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_26
}

predicate func_1(Function func, Literal target_1) {
	target_1.getValue()="0"
	and not target_1.getValue()="4"
	and target_1.getParent().(AssignExpr).getParent().(ExprStmt).getExpr() instanceof AssignExpr
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
	target_2.getValue()="256"
	and not target_2.getValue()="8"
	and target_2.getParent().(BitwiseAndExpr).getParent().(IfStmt).getCondition() instanceof BitwiseAndExpr
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vvalue_23, Literal target_3) {
	target_3.getValue()="1"
	and not target_3.getValue()="16"
	and target_3.getParent().(AssignOrExpr).getParent().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vvalue_23
}

predicate func_4(Function func, Literal target_4) {
	target_4.getValue()="2"
	and not target_4.getValue()="32"
	and target_4.getParent().(AssignOrExpr).getParent().(ExprStmt).getExpr() instanceof AssignOrExpr
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Parameter voffset_23, Parameter vvalue_23, Parameter vdev_23, ExprStmt target_21) {
exists(Initializer target_5 |
	target_5.getExpr().(FunctionCall).getTarget().hasName("pci_read_config_word")
	and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_23
	and target_5.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voffset_23
	and target_5.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vvalue_23
	and target_5.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getLocation().isBefore(target_21.getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation()))
}

predicate func_7(Function func) {
exists(AssignAndExpr target_7 |
	target_7.getLValue() instanceof PointerDereferenceExpr
	and target_7.getRValue().(BitwiseOrExpr).getValue()="700"
	and target_7.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
exists(BitwiseAndExpr target_8 |
	target_8.getLeftOperand().(PointerFieldAccess).getTarget().getName()="val"
	and target_8.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("const pci_cmd_info *")
	and target_8.getRightOperand().(ComplementExpr).getValue()="-701"
	and target_8.getEnclosingFunction() = func)
}

predicate func_9(Variable vret_26, NotExpr target_23, ReturnStmt target_9) {
	target_9.getExpr().(VariableAccess).getTarget()=vret_26
	and target_9.getParent().(IfStmt).getCondition()=target_23
}

predicate func_10(Parameter vvalue_23, PointerDereferenceExpr target_10) {
	target_10.getOperand().(VariableAccess).getTarget()=vvalue_23
}

predicate func_12(Parameter vdata_23, VariableAccess target_12) {
	target_12.getTarget()=vdata_23
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Variable vret_26, AssignExpr target_14) {
	target_14.getLValue().(VariableAccess).getTarget()=vret_26
	and target_14.getRValue() instanceof FunctionCall
}

predicate func_15(Parameter vdev_23, Function func, IfStmt target_15) {
	target_15.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("pci_is_enabled")
	and target_15.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdev_23
	and target_15.getThen() instanceof ReturnStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_15
}

predicate func_16(Parameter vvalue_23, Variable vi_25, Function func, ForStmt target_16) {
	target_16.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_25
	and target_16.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and target_16.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_25
	and target_16.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_25
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="resource"
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_25
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vvalue_23
	and target_16.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue() instanceof Literal
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="resource"
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_25
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue() instanceof PointerDereferenceExpr
	and target_16.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue() instanceof Literal
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_16
}

/*predicate func_17(Variable vi_25, AssignExpr target_17) {
	target_17.getLValue().(VariableAccess).getTarget()=vi_25
	and target_17.getRValue() instanceof Literal
}

*/
/*predicate func_18(Parameter vvalue_23, Variable vi_25, Parameter vdev_23, IfStmt target_18) {
	target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="resource"
	and target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_23
	and target_18.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_25
	and target_18.getCondition().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_18.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vvalue_23
	and target_18.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue() instanceof Literal
}

*/
/*predicate func_19(Variable vi_25, Parameter vdev_23, IfStmt target_19) {
	target_19.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_19.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="resource"
	and target_19.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_23
	and target_19.getCondition().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_25
	and target_19.getCondition().(BitwiseAndExpr).getRightOperand() instanceof Literal
	and target_19.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue() instanceof PointerDereferenceExpr
	and target_19.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue() instanceof Literal
}

*/
predicate func_20(Variable vret_26, Function func, ReturnStmt target_20) {
	target_20.getExpr().(VariableAccess).getTarget()=vret_26
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_20
}

predicate func_21(Parameter vvalue_23, ExprStmt target_21) {
	target_21.getExpr().(AssignOrExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vvalue_23
	and target_21.getExpr().(AssignOrExpr).getRValue() instanceof Literal
}

predicate func_23(Function func, NotExpr target_23) {
	target_23.getOperand() instanceof FunctionCall
	and target_23.getEnclosingFunction() = func
}

from Function func, Parameter voffset_23, Parameter vvalue_23, Parameter vdata_23, Variable vi_25, Variable vret_26, Parameter vdev_23, FunctionCall target_0, Literal target_1, Literal target_2, Literal target_3, Literal target_4, ReturnStmt target_9, PointerDereferenceExpr target_10, VariableAccess target_12, AssignExpr target_14, IfStmt target_15, ForStmt target_16, ReturnStmt target_20, ExprStmt target_21, NotExpr target_23
where
func_0(voffset_23, vvalue_23, vdata_23, vret_26, vdev_23, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and func_3(vvalue_23, target_3)
and func_4(func, target_4)
and not func_5(voffset_23, vvalue_23, vdev_23, target_21)
and not func_7(func)
and not func_8(func)
and func_9(vret_26, target_23, target_9)
and func_10(vvalue_23, target_10)
and func_12(vdata_23, target_12)
and func_14(vret_26, target_14)
and func_15(vdev_23, func, target_15)
and func_16(vvalue_23, vi_25, func, target_16)
and func_20(vret_26, func, target_20)
and func_21(vvalue_23, target_21)
and func_23(func, target_23)
and voffset_23.getType().hasName("int")
and vvalue_23.getType().hasName("u16 *")
and vdata_23.getType().hasName("void *")
and vi_25.getType().hasName("int")
and vret_26.getType().hasName("int")
and vdev_23.getType().hasName("pci_dev *")
and voffset_23.getFunction() = func
and vvalue_23.getFunction() = func
and vdata_23.getFunction() = func
and vi_25.(LocalVariable).getFunction() = func
and vret_26.(LocalVariable).getFunction() = func
and vdev_23.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
