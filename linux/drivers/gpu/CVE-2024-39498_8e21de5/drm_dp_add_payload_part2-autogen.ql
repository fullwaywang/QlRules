/**
 * @name linux-8e21de5f99b2368a5155037ce0aae8aaba3f5241-drm_dp_add_payload_part2
 * @id cpp/linux/8e21de5f99b2368a5155037ce0aae8aaba3f5241/drm-dp-add-payload-part2
 * @description linux-8e21de5f99b2368a5155037ce0aae8aaba3f5241-drivers/gpu/drm/display/drm_dp_mst_topology.c-drm_dp_add_payload_part2 CVE-2024-39498
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

/*predicate func_2(Parameter vstate_3433, VariableAccess target_2) {
	target_2.getTarget()=vstate_3433
}

*/
predicate func_3(Parameter vstate_3433, VariableAccess target_3) {
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getParent() |
		exists(PointerFieldAccess obj_1 | obj_1=obj_0.getParent() |
			exists(ConditionalExpr obj_2 | obj_2=obj_1.getParent() |
				exists(FunctionCall obj_3 | obj_3=obj_2.getParent() |
					exists(ExprStmt obj_4 | obj_4=obj_3.getParent() |
						exists(FunctionCall obj_5 | obj_5=obj_4.getExpr() |
							exists(ConditionalExpr obj_6 | obj_6=obj_5.getArgument(1) |
								obj_6.getCondition().(PointerFieldAccess).getTarget().getName()="dev"
								and obj_6.getThen().(PointerFieldAccess).getTarget().getName()="dev"
								and obj_6.getElse().(Literal).getValue()="0"
							)
							and exists(PointerFieldAccess obj_7 | obj_7=obj_5.getArgument(4) |
								obj_7.getTarget().getName()="name"
								and obj_7.getQualifier().(PointerFieldAccess).getTarget().getName()="connector"
							)
							and obj_5.getTarget().hasName("__drm_dev_dbg")
							and obj_5.getArgument(0).(Literal).getValue()="0"
							and obj_5.getArgument(3).(StringLiteral).getValue()="Part 1 of payload creation for %s failed, skipping part 2\n"
						)
					)
				)
			)
		)
	)
	and target_3.getTarget()=vstate_3433
}

from Function func, Parameter vstate_3433, VariableAccess target_3
where
func_3(vstate_3433, target_3)
and vstate_3433.getType().hasName("drm_atomic_state *")
and vstate_3433.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
