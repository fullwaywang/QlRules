/**
 * @name linux-6648e613226e18897231ab5e42ffc29e63fa3365-sk_psock_verdict_data_ready
 * @id cpp/linux/6648e613226e18897231ab5e42ffc29e63fa3365/sk-psock-verdict-data-ready
 * @description linux-6648e613226e18897231ab5e42ffc29e63fa3365-net/core/skmsg.c-sk_psock_verdict_data_ready CVE-2024-36938
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vpsock_1225, Parameter vsk_1210, VariableAccess target_3, ExprStmt target_0) {
	target_0.getExpr().(FunctionCall).getTarget().hasName("sk_psock_data_ready")
	and target_0.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsk_1210
	and target_0.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vpsock_1225
	and target_0.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_1(Parameter vsk_1210, VariableAccess target_3, ExprStmt target_1) {
	target_1.getExpr().(FunctionCall).getTarget().hasName("_raw_read_lock_bh")
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_callback_lock"
	and target_1.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1210
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_2(Parameter vsk_1210, VariableAccess target_3, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("_raw_read_unlock_bh")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="sk_callback_lock"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsk_1210
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_3
}

predicate func_3(Variable vpsock_1225, VariableAccess target_3) {
	target_3.getTarget()=vpsock_1225
}

from Function func, Variable vpsock_1225, Parameter vsk_1210, ExprStmt target_0, ExprStmt target_1, ExprStmt target_2, VariableAccess target_3
where
func_0(vpsock_1225, vsk_1210, target_3, target_0)
and func_1(vsk_1210, target_3, target_1)
and func_2(vsk_1210, target_3, target_2)
and func_3(vpsock_1225, target_3)
and vpsock_1225.getType().hasName("sk_psock *")
and vsk_1210.getType().hasName("sock *")
and vpsock_1225.(LocalVariable).getFunction() = func
and vsk_1210.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
