/**
 * @name linux-22f6b4d34fcf039c63a94e7670e0da24f8575a5a-aio_mount
 * @id cpp/linux/22f6b4d34fcf039c63a94e7670e0da24f8575a5a/aio-mount
 * @description linux-22f6b4d34fcf039c63a94e7670e0da24f8575a5a-fs/aio.c-aio_mount CVE-2016-10044
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_0.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getType().hasName("dentry *")
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getTarget().getName()="s_iflags"
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d_sb"
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("dentry *")
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="2"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getFollowingStmt() instanceof ReturnStmt)
}

predicate func_2(Variable vops_239, Parameter vfs_type_236, FunctionCall target_2) {
	target_2.getTarget().hasName("mount_pseudo")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vfs_type_236
	and target_2.getArgument(1).(StringLiteral).getValue()="aio:"
	and target_2.getArgument(2).(Literal).getValue()="0"
	and target_2.getArgument(3).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vops_239
	and target_2.getArgument(4).(Literal).getValue()="2701791393"
}

from Function func, Variable vops_239, Parameter vfs_type_236, FunctionCall target_2
where
not func_0(func)
and func_2(vops_239, vfs_type_236, target_2)
and vops_239.getType().hasName("const dentry_operations")
and vfs_type_236.getType().hasName("file_system_type *")
and vops_239.(LocalVariable).getFunction() = func
and vfs_type_236.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
