/**
 * @name linux-726bc6b092da4c093eb74d13c07184b18c1af0f1-sctp_getsockopt_assoc_stats
 * @id cpp/linux/726bc6b092da4c093eb74d13c07184b18c1af0f1/sctp-getsockopt-assoc-stats
 * @description linux-726bc6b092da4c093eb74d13c07184b18c1af0f1-net/sctp/socket.c-sctp_getsockopt_assoc_stats CVE-2013-1828
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vlen_5645, Variable v__min1_5690, Variable v__min2_5690, ExprStmt target_1, ExprStmt target_0) {
	target_0.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_5645
	and target_0.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getTarget()=v__min1_5690
	and target_0.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getTarget()=v__min2_5690
	and target_1.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Function func, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="max_obs_rto"
	and target_1.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="stats"
	and target_1.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_association *")
	and target_1.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="rto_min"
	and target_1.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("sctp_association *")
	and target_1.getEnclosingFunction() = func
}

from Function func, Parameter vlen_5645, Variable v__min1_5690, Variable v__min2_5690, ExprStmt target_0, ExprStmt target_1
where
func_0(vlen_5645, v__min1_5690, v__min2_5690, target_1, target_0)
and func_1(func, target_1)
and vlen_5645.getType().hasName("int")
and v__min1_5690.getType().hasName("size_t")
and v__min2_5690.getType().hasName("size_t")
and vlen_5645.getFunction() = func
and v__min1_5690.(LocalVariable).getFunction() = func
and v__min2_5690.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
