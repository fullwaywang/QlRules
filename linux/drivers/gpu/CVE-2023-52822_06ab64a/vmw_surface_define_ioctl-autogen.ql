/**
 * @name linux-06ab64a0d836ac430c5f94669710a78aa43942cb-vmw_surface_define_ioctl
 * @id cpp/linux/06ab64a0d836ac430c5f94669710a78aa43942cb/vmw-surface-define-ioctl
 * @description linux-06ab64a0d836ac430c5f94669710a78aa43942cb-drivers/gpu/drm/vmwgfx/vmwgfx_surface.c-vmw_surface_define_ioctl CVE-2023-52822
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vmetadata_727, Variable vreq_732, FunctionCall target_0) {
	target_0.getTarget().hasName("memdup_user")
	and not target_0.getTarget().hasName("memdup_array_user")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="size_addr"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreq_732
	and target_0.getArgument(1).(MulExpr).getLeftOperand() instanceof SizeofExprOperator
	and target_0.getArgument(1).(MulExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="num_sizes"
	and target_0.getArgument(1).(MulExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmetadata_727
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="sizes"
	and target_0.getParent().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmetadata_727
}

predicate func_1(Function func, SizeofExprOperator target_1) {
	target_1.getValue()="16"
	and target_1.getEnclosingFunction() = func
}

predicate func_2(Variable vmetadata_727, PointerFieldAccess target_2) {
	target_2.getTarget().getName()="num_sizes"
	and target_2.getQualifier().(VariableAccess).getTarget()=vmetadata_727
	and target_2.getParent().(MulExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

from Function func, Variable vmetadata_727, Variable vreq_732, FunctionCall target_0, SizeofExprOperator target_1, PointerFieldAccess target_2
where
func_0(vmetadata_727, vreq_732, target_0)
and func_1(func, target_1)
and func_2(vmetadata_727, target_2)
and vmetadata_727.getType().hasName("vmw_surface_metadata *")
and vreq_732.getType().hasName("drm_vmw_surface_create_req *")
and vmetadata_727.(LocalVariable).getFunction() = func
and vreq_732.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
