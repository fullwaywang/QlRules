/**
 * @name openssl-4c836c96c4ec507040ed9149acacddc40399155d-dtls1_process_out_of_seq_message
 * @id cpp/openssl/4c836c96c4ec507040ed9149acacddc40399155d/dtls1-process-out-of-seq-message
 * @description openssl-4c836c96c4ec507040ed9149acacddc40399155d-ssl/d1_both.c-dtls1_process_out_of_seq_message CVE-2014-3507
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vfrag_len_714, Parameter vmsg_hdr_708, ExprStmt target_8, RelationalOperation target_9, WhileStmt target_10, ExprStmt target_11, LogicalOrExpr target_12) {
	exists(EqualityOperation target_0 |
		target_0.getAnOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_0.getAnOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_0.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget().getType().hasName("pitem *")
		and target_0.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_0.getParent().(LogicalAndExpr).getAnOperand() instanceof RelationalOperation
		and target_0.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_8
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_0.getAnOperand().(VariableAccess).getLocation())
		and target_0.getAnOperand().(VariableAccess).getLocation().isBefore(target_10.getCondition().(VariableAccess).getLocation())
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_0.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable vfrag_len_714, Parameter vmsg_hdr_708, ReturnStmt target_13, ExprStmt target_14, RelationalOperation target_15, LogicalOrExpr target_12, FunctionCall target_16) {
	exists(EqualityOperation target_1 |
		target_1.getAnOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_1.getAnOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_1.getParent().(IfStmt).getThen()=target_13
		and target_14.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getAnOperand().(VariableAccess).getLocation())
		and target_1.getAnOperand().(VariableAccess).getLocation().isBefore(target_15.getGreaterOperand().(VariableAccess).getLocation())
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_1.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getArgument(1).(VariableAccess).getLocation()))
}

predicate func_2(Parameter vmsg_hdr_708, PointerFieldAccess target_2) {
		target_2.getTarget().getName()="msg_len"
		and target_2.getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
}

predicate func_3(Variable vfrag_len_714, Parameter vmsg_hdr_708, ReturnStmt target_13, PointerFieldAccess target_3) {
		target_3.getTarget().getName()="msg_len"
		and target_3.getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_3.getParent().(LTExpr).getLesserOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_3.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_13
}

predicate func_4(Variable vfrag_len_714, VariableAccess target_4) {
		target_4.getTarget()=vfrag_len_714
}

/*predicate func_5(Variable vfrag_len_714, Parameter vmsg_hdr_708, ReturnStmt target_13, VariableAccess target_5) {
		target_5.getTarget()=vfrag_len_714
		and target_5.getParent().(LTExpr).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_5.getParent().(LTExpr).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_5.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_13
}

*/
predicate func_6(Variable vfrag_len_714, Parameter vmsg_hdr_708, ExprStmt target_8, RelationalOperation target_9, WhileStmt target_10, ExprStmt target_11, LogicalOrExpr target_12, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getLesserOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_6.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_6.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget().getType().hasName("pitem *")
		and target_6.getParent().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_6.getParent().(LogicalAndExpr).getParent().(IfStmt).getThen()=target_8
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_6.getLesserOperand().(VariableAccess).getLocation())
		and target_6.getLesserOperand().(VariableAccess).getLocation().isBefore(target_10.getCondition().(VariableAccess).getLocation())
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_6.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_7(Variable vfrag_len_714, Parameter vmsg_hdr_708, ReturnStmt target_13, ExprStmt target_14, RelationalOperation target_15, LogicalOrExpr target_12, FunctionCall target_16, RelationalOperation target_7) {
		 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
		and target_7.getLesserOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_7.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_7.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_7.getParent().(IfStmt).getThen()=target_13
		and target_14.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getLocation().isBefore(target_7.getLesserOperand().(VariableAccess).getLocation())
		and target_7.getLesserOperand().(VariableAccess).getLocation().isBefore(target_15.getGreaterOperand().(VariableAccess).getLocation())
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_7.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_7.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getArgument(1).(VariableAccess).getLocation())
}

predicate func_8(Function func, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("pitem *")
		and target_8.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_8.getEnclosingFunction() = func
}

predicate func_9(Variable vfrag_len_714, Parameter vmsg_hdr_708, RelationalOperation target_9) {
		 (target_9 instanceof GTExpr or target_9 instanceof LTExpr)
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="frag_off"
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_9.getGreaterOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_9.getLesserOperand().(PointerFieldAccess).getTarget().getName()="msg_len"
		and target_9.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
}

predicate func_10(Variable vfrag_len_714, WhileStmt target_10) {
		target_10.getCondition().(VariableAccess).getTarget()=vfrag_len_714
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="ssl_read_bytes"
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="method"
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(1).(Literal).getValue()="22"
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("unsigned char[256]")
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(3).(ConditionalExpr).getElse().(VariableAccess).getTarget()=vfrag_len_714
		and target_10.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableCall).getArgument(4).(Literal).getValue()="0"
}

predicate func_11(Parameter vmsg_hdr_708, Function func, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="seq"
		and target_11.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Parameter vmsg_hdr_708, LogicalOrExpr target_12) {
		target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="seq"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="seq"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(LogicalOrExpr).getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(Literal).getValue()="10"
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(VariableAccess).getTarget().getType().hasName("pitem *")
		and target_12.getAnOperand().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="handshake_read_seq"
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="d1"
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="0"
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getTarget().getName()="type"
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vmsg_hdr_708
		and target_12.getAnOperand().(LogicalAndExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="20"
}

predicate func_13(Parameter vmsg_hdr_708, ReturnStmt target_13) {
		target_13.getExpr().(FunctionCall).getTarget().hasName("dtls1_reassemble_fragment")
		and target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_13.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vmsg_hdr_708
		and target_13.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("int *")
}

predicate func_14(Variable vfrag_len_714, ExprStmt target_14) {
		target_14.getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vfrag_len_714
		and target_14.getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_15(Variable vfrag_len_714, RelationalOperation target_15) {
		 (target_15 instanceof GTExpr or target_15 instanceof LTExpr)
		and target_15.getGreaterOperand().(VariableAccess).getTarget()=vfrag_len_714
		and target_15.getLesserOperand().(FunctionCall).getTarget().hasName("dtls1_max_handshake_message_len")
		and target_15.getLesserOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("SSL *")
}

predicate func_16(Parameter vmsg_hdr_708, FunctionCall target_16) {
		target_16.getTarget().hasName("dtls1_reassemble_fragment")
		and target_16.getArgument(0).(VariableAccess).getTarget().getType().hasName("SSL *")
		and target_16.getArgument(1).(VariableAccess).getTarget()=vmsg_hdr_708
		and target_16.getArgument(2).(VariableAccess).getTarget().getType().hasName("int *")
}

from Function func, Variable vfrag_len_714, Parameter vmsg_hdr_708, PointerFieldAccess target_2, PointerFieldAccess target_3, VariableAccess target_4, RelationalOperation target_6, RelationalOperation target_7, ExprStmt target_8, RelationalOperation target_9, WhileStmt target_10, ExprStmt target_11, LogicalOrExpr target_12, ReturnStmt target_13, ExprStmt target_14, RelationalOperation target_15, FunctionCall target_16
where
not func_0(vfrag_len_714, vmsg_hdr_708, target_8, target_9, target_10, target_11, target_12)
and not func_1(vfrag_len_714, vmsg_hdr_708, target_13, target_14, target_15, target_12, target_16)
and func_2(vmsg_hdr_708, target_2)
and func_3(vfrag_len_714, vmsg_hdr_708, target_13, target_3)
and func_4(vfrag_len_714, target_4)
and func_6(vfrag_len_714, vmsg_hdr_708, target_8, target_9, target_10, target_11, target_12, target_6)
and func_7(vfrag_len_714, vmsg_hdr_708, target_13, target_14, target_15, target_12, target_16, target_7)
and func_8(func, target_8)
and func_9(vfrag_len_714, vmsg_hdr_708, target_9)
and func_10(vfrag_len_714, target_10)
and func_11(vmsg_hdr_708, func, target_11)
and func_12(vmsg_hdr_708, target_12)
and func_13(vmsg_hdr_708, target_13)
and func_14(vfrag_len_714, target_14)
and func_15(vfrag_len_714, target_15)
and func_16(vmsg_hdr_708, target_16)
and vfrag_len_714.getType().hasName("unsigned long")
and vmsg_hdr_708.getType().hasName("hm_header_st *")
and vfrag_len_714.(LocalVariable).getFunction() = func
and vmsg_hdr_708.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
