/**
 * @name linux-50145474f6ef4a9c19205b173da6264a644c7489-fb_console_setup
 * @id cpp/linux/50145474f6ef4a9c19205b173da6264a644c7489/fb-console-setup
 * @description linux-50145474f6ef4a9c19205b173da6264a644c7489-drivers/video/fbdev/core/fbcon.c-fb_console_setup CVE-2020-14390
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("printk")
	and target_0.getArgument(0).(StringLiteral).getValue()="4Ignoring scrollback size option\n"
	and target_0.getEnclosingFunction() = func)
}

predicate func_1(Variable voptions_461, AssignPointerAddExpr target_1) {
	target_1.getLValue().(VariableAccess).getTarget()=voptions_461
	and target_1.getRValue().(Literal).getValue()="11"
}

predicate func_2(Variable voptions_461, BlockStmt target_8, PointerDereferenceExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=voptions_461
	and target_2.getParent().(IfStmt).getThen()=target_8
}

predicate func_3(Variable voptions_461, Variable vfbcon_softback_size, FunctionCall target_3) {
	target_3.getTarget().hasName("simple_strtoul")
	and target_3.getArgument(0).(VariableAccess).getTarget()=voptions_461
	and target_3.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=voptions_461
	and target_3.getArgument(2).(Literal).getValue()="0"
	and target_3.getParent().(AssignExpr).getRValue() = target_3
	and target_3.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
}

predicate func_4(Variable voptions_461, Variable vfbcon_softback_size, NotExpr target_9, IfStmt target_4) {
	target_4.getCondition() instanceof PointerDereferenceExpr
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
	and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=voptions_461
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(CharLiteral).getValue()="107"
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=voptions_461
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(CharLiteral).getValue()="75"
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignMulExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
	and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignMulExpr).getRValue().(Literal).getValue()="1024"
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
}

/*predicate func_5(Variable vfbcon_softback_size, PointerDereferenceExpr target_2, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
	and target_5.getExpr().(AssignExpr).getRValue() instanceof FunctionCall
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
}

*/
/*predicate func_6(Variable voptions_461, Variable vfbcon_softback_size, PointerDereferenceExpr target_2, IfStmt target_6) {
	target_6.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=voptions_461
	and target_6.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(CharLiteral).getValue()="107"
	and target_6.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=voptions_461
	and target_6.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(CharLiteral).getValue()="75"
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignMulExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignMulExpr).getRValue().(Literal).getValue()="1024"
	and target_6.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_2
}

*/
/*predicate func_7(Variable vfbcon_softback_size, LogicalOrExpr target_10, ExprStmt target_7) {
	target_7.getExpr().(AssignMulExpr).getLValue().(VariableAccess).getTarget()=vfbcon_softback_size
	and target_7.getExpr().(AssignMulExpr).getRValue().(Literal).getValue()="1024"
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

*/
predicate func_8(Function func, BlockStmt target_8) {
	target_8.getStmt(0) instanceof ExprStmt
	and target_8.getStmt(1) instanceof IfStmt
	and target_8.getEnclosingFunction() = func
}

predicate func_9(Variable voptions_461, NotExpr target_9) {
	target_9.getOperand().(FunctionCall).getTarget().hasName("strncmp")
	and target_9.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=voptions_461
	and target_9.getOperand().(FunctionCall).getArgument(1).(StringLiteral).getValue()="scrollback:"
	and target_9.getOperand().(FunctionCall).getArgument(2).(Literal).getValue()="11"
}

predicate func_10(Function func, LogicalOrExpr target_10) {
	target_10.getLeftOperand() instanceof EqualityOperation
	and target_10.getRightOperand() instanceof EqualityOperation
	and target_10.getEnclosingFunction() = func
}

from Function func, Variable voptions_461, Variable vfbcon_softback_size, AssignPointerAddExpr target_1, PointerDereferenceExpr target_2, FunctionCall target_3, IfStmt target_4, BlockStmt target_8, NotExpr target_9, LogicalOrExpr target_10
where
not func_0(func)
and func_1(voptions_461, target_1)
and func_2(voptions_461, target_8, target_2)
and func_3(voptions_461, vfbcon_softback_size, target_3)
and func_4(voptions_461, vfbcon_softback_size, target_9, target_4)
and func_8(func, target_8)
and func_9(voptions_461, target_9)
and func_10(func, target_10)
and voptions_461.getType().hasName("char *")
and vfbcon_softback_size.getType().hasName("int")
and voptions_461.(LocalVariable).getFunction() = func
and not vfbcon_softback_size.getParentScope+() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
