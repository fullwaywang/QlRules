/**
 * @name linux-abafbc551fddede3e0a08dee1dcde08fc0eb8476-vfio_pci_bar_rw
 * @id cpp/linux/abafbc551fddede3e0a08dee1dcde08fc0eb8476/vfio-pci-bar-rw
 * @description linux-abafbc551fddede3e0a08dee1dcde08fc0eb8476-drivers/vfio/pci/vfio_pci_rdwr.c-vfio_pci_bar_rw CVE-2020-12888
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, UnaryMinusExpr target_0) {
	target_0.getValue()="-12"
	and target_0.getEnclosingFunction() = func
}

predicate func_1(BlockStmt target_18, Function func) {
exists(BitwiseAndExpr target_1 |
	target_1.getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_1.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("resource *")
	and target_1.getRightOperand().(Literal).getValue()="512"
	and target_1.getParent().(IfStmt).getThen()=target_18
	and target_1.getEnclosingFunction() = func)
}

predicate func_2(Parameter vvdev_156, EqualityOperation target_10, FunctionCall target_19) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("down_read")
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="memory_lock"
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getElse().(BlockStmt).getStmt(0)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
	and target_2.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_19.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_3(Parameter vvdev_156, ReturnStmt target_20) {
exists(NotExpr target_3 |
	target_3.getOperand().(FunctionCall).getTarget().hasName("__vfio_pci_memory_enabled")
	and target_3.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vvdev_156
	and target_3.getParent().(IfStmt).getThen()=target_20)
}

predicate func_4(Parameter vvdev_156, NotExpr target_11) {
exists(ExprStmt target_4 |
	target_4.getExpr().(FunctionCall).getTarget().hasName("up_read")
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="memory_lock"
	and target_4.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_4
	and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_11)
}

predicate func_5(Function func) {
exists(UnaryMinusExpr target_5 |
	target_5.getValue()="-5"
	and target_5.getEnclosingFunction() = func)
}

predicate func_6(Variable vpdev_159, Variable vx_start_162, Variable vx_end_162, Variable vend_163, Variable vio_164, Variable vdone_165, Variable vret_191, IfStmt target_21, LogicalAndExpr target_22, ExprStmt target_23, SubExpr target_26, NotExpr target_11, Function func) {
exists(IfStmt target_6 |
	target_6.getCondition() instanceof EqualityOperation
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vio_164
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pci_map_rom")
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpdev_159
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vx_start_162
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition() instanceof NotExpr
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdone_165
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and target_6.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out"
	and target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vx_end_162
	and target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vend_163
	and target_6.getElse().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vret_191
	and target_6.getElse().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdone_165
	and target_6.getElse().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vret_191
	and target_6.getElse().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out"
	and target_6.getElse().(BlockStmt).getStmt(2) instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
	and target_6.getLocation().isBefore(target_21.getLocation())
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_23.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_26.getLeftOperand().(VariableAccess).getLocation().isBefore(target_6.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
	and target_6.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getOperand().(VariableAccess).getLocation()))
}

/*predicate func_7(Variable vdone_165, VariableAccess target_15) {
exists(ExprStmt target_7 |
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdone_165
	and target_7.getExpr().(AssignExpr).getRValue() instanceof UnaryMinusExpr
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(0)=target_7
	and target_7.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15)
}

*/
/*predicate func_8(VariableAccess target_15, Function func) {
exists(GotoStmt target_8 |
	target_8.getName() ="out"
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_8
	and target_8.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_15
	and target_8.getEnclosingFunction() = func)
}

*/
predicate func_9(Parameter vvdev_156, ExprStmt target_30, Function func) {
exists(IfStmt target_9 |
	target_9.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="flags"
	and target_9.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getType().hasName("resource *")
	and target_9.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="512"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("up_read")
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="memory_lock"
	and target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
	and target_9.getFollowingStmt() instanceof ReturnStmt
	and target_30.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_10(Variable vbar_161, BlockStmt target_18, EqualityOperation target_10) {
	target_10.getLeftOperand().(VariableAccess).getTarget()=vbar_161
	and target_10.getParent().(IfStmt).getThen()=target_18
}

predicate func_11(Variable vio_164, ReturnStmt target_20, NotExpr target_11) {
	target_11.getOperand().(VariableAccess).getTarget()=vio_164
	and target_11.getParent().(IfStmt).getThen()=target_20
}

/*predicate func_12(Function func, UnaryMinusExpr target_12) {
	target_12.getValue()="-12"
	and target_12.getEnclosingFunction() = func
}

*/
predicate func_13(EqualityOperation target_10, Function func, DeclStmt target_13) {
	target_13.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
	and target_13.getEnclosingFunction() = func
}

predicate func_14(Parameter vvdev_156, Variable vbar_161, Variable vio_164, EqualityOperation target_10, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vio_164
	and target_14.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="barmap"
	and target_14.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_14.getExpr().(AssignExpr).getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vbar_161
	and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
}

predicate func_15(Variable vret_191, ReturnStmt target_17, VariableAccess target_15) {
	target_15.getTarget()=vret_191
	and target_15.getParent().(IfStmt).getThen()=target_17
}

predicate func_16(Variable vret_191, VariableAccess target_16) {
	target_16.getTarget()=vret_191
}

predicate func_17(Variable vret_191, VariableAccess target_15, ReturnStmt target_17) {
	target_17.getExpr().(VariableAccess).getTarget()=vret_191
	and target_17.getParent().(IfStmt).getCondition()=target_15
}

predicate func_18(Variable vpdev_159, Variable vx_start_162, Variable vio_164, BlockStmt target_18) {
	target_18.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vio_164
	and target_18.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("pci_map_rom")
	and target_18.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpdev_159
	and target_18.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vx_start_162
	and target_18.getStmt(1).(IfStmt).getCondition() instanceof NotExpr
	and target_18.getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr() instanceof UnaryMinusExpr
}

predicate func_19(Parameter vvdev_156, Variable vbar_161, FunctionCall target_19) {
	target_19.getTarget().hasName("vfio_pci_setup_barmap")
	and target_19.getArgument(0).(VariableAccess).getTarget()=vvdev_156
	and target_19.getArgument(1).(VariableAccess).getTarget()=vbar_161
}

predicate func_20(Function func, ReturnStmt target_20) {
	target_20.getExpr() instanceof UnaryMinusExpr
	and target_20.getEnclosingFunction() = func
}

predicate func_21(Parameter vvdev_156, Variable vbar_161, Variable vx_start_162, Variable vx_end_162, IfStmt target_21) {
	target_21.getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vbar_161
	and target_21.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getTarget().getName()="msix_bar"
	and target_21.getCondition().(EqualityOperation).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vx_start_162
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="msix_offset"
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_21.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vx_end_162
	and target_21.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="msix_offset"
	and target_21.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_21.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="msix_size"
	and target_21.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
}

predicate func_22(Variable vpdev_159, Variable vbar_161, LogicalAndExpr target_22) {
	target_22.getLeftOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vbar_161
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="resource"
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vpdev_159
	and target_22.getRightOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vbar_161
	and target_22.getRightOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="2"
}

predicate func_23(Variable vpdev_159, Variable vio_164, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("pci_unmap_rom")
	and target_23.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpdev_159
	and target_23.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vio_164
}

predicate func_26(Variable vend_163, SubExpr target_26) {
	target_26.getLeftOperand().(VariableAccess).getTarget()=vend_163
	and target_26.getRightOperand().(VariableAccess).getTarget().getType().hasName("loff_t")
}

predicate func_30(Parameter vvdev_156, Variable vx_end_162, ExprStmt target_30) {
	target_30.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vx_end_162
	and target_30.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="msix_offset"
	and target_30.getExpr().(AssignExpr).getRValue().(AddExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
	and target_30.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="msix_size"
	and target_30.getExpr().(AssignExpr).getRValue().(AddExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvdev_156
}

from Function func, Parameter vvdev_156, Variable vpdev_159, Variable vbar_161, Variable vx_start_162, Variable vx_end_162, Variable vend_163, Variable vio_164, Variable vdone_165, Variable vret_191, UnaryMinusExpr target_0, EqualityOperation target_10, NotExpr target_11, DeclStmt target_13, ExprStmt target_14, VariableAccess target_15, VariableAccess target_16, ReturnStmt target_17, BlockStmt target_18, FunctionCall target_19, ReturnStmt target_20, IfStmt target_21, LogicalAndExpr target_22, ExprStmt target_23, SubExpr target_26, ExprStmt target_30
where
func_0(func, target_0)
and not func_1(target_18, func)
and not func_2(vvdev_156, target_10, target_19)
and not func_3(vvdev_156, target_20)
and not func_4(vvdev_156, target_11)
and not func_5(func)
and not func_6(vpdev_159, vx_start_162, vx_end_162, vend_163, vio_164, vdone_165, vret_191, target_21, target_22, target_23, target_26, target_11, func)
and not func_9(vvdev_156, target_30, func)
and func_10(vbar_161, target_18, target_10)
and func_11(vio_164, target_20, target_11)
and func_13(target_10, func, target_13)
and func_14(vvdev_156, vbar_161, vio_164, target_10, target_14)
and func_15(vret_191, target_17, target_15)
and func_16(vret_191, target_16)
and func_17(vret_191, target_15, target_17)
and func_18(vpdev_159, vx_start_162, vio_164, target_18)
and func_19(vvdev_156, vbar_161, target_19)
and func_20(func, target_20)
and func_21(vvdev_156, vbar_161, vx_start_162, vx_end_162, target_21)
and func_22(vpdev_159, vbar_161, target_22)
and func_23(vpdev_159, vio_164, target_23)
and func_26(vend_163, target_26)
and func_30(vvdev_156, vx_end_162, target_30)
and vvdev_156.getType().hasName("vfio_pci_device *")
and vpdev_159.getType().hasName("pci_dev *")
and vbar_161.getType().hasName("int")
and vx_start_162.getType().hasName("size_t")
and vx_end_162.getType().hasName("size_t")
and vend_163.getType().hasName("resource_size_t")
and vio_164.getType().hasName("void *")
and vdone_165.getType().hasName("ssize_t")
and vret_191.getType().hasName("int")
and vvdev_156.getFunction() = func
and vpdev_159.(LocalVariable).getFunction() = func
and vbar_161.(LocalVariable).getFunction() = func
and vx_start_162.(LocalVariable).getFunction() = func
and vx_end_162.(LocalVariable).getFunction() = func
and vend_163.(LocalVariable).getFunction() = func
and vio_164.(LocalVariable).getFunction() = func
and vdone_165.(LocalVariable).getFunction() = func
and vret_191.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
