/**
 * @name curl-53bcf55b4538067e6-parseurlandfillconn
 * @id cpp/curl/53bcf55b4538067e6/parseurlandfillconn
 * @description curl-53bcf55b4538067e6-lib/url.c-parseurlandfillconn CVE-2022-42916
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdata_1968, ValueFieldAccess target_0) {
		target_0.getTarget().getName()="hostname"
		and target_0.getQualifier().(ValueFieldAccess).getTarget().getName()="up"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="state"
		and target_0.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1968
}

predicate func_1(Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, ValueFieldAccess target_8, ExprStmt target_9, ReturnStmt target_10, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_1971
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_1968
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="host"
		and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_1969
		and (func.getEntryPoint().(BlockStmt).getStmt(19)=target_1 or func.getEntryPoint().(BlockStmt).getStmt(19).getFollowingStmt()=target_1)
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_10.getExpr().(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation()))
}

predicate func_3(Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, Function func) {
	exists(IfStmt target_3 |
		target_3.getCondition().(ValueFieldAccess).getTarget().getName()="conn_to_host"
		and target_3.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_3.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_1969
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_1971
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_1968
		and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="conn_to_host"
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_1971
		and target_3.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vresult_1971
		and (func.getEntryPoint().(BlockStmt).getStmt(21)=target_3 or func.getEntryPoint().(BlockStmt).getStmt(21).getFollowingStmt()=target_3))
}

predicate func_4(Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, Function func) {
	exists(IfStmt target_4 |
		target_4.getCondition().(ValueFieldAccess).getTarget().getName()="httpproxy"
		and target_4.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_4.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_1969
		and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_1971
		and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_1968
		and target_4.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_1971
		and target_4.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vresult_1971
		and (func.getEntryPoint().(BlockStmt).getStmt(22)=target_4 or func.getEntryPoint().(BlockStmt).getStmt(22).getFollowingStmt()=target_4))
}

predicate func_5(Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, ValueFieldAccess target_11, Function func) {
	exists(IfStmt target_5 |
		target_5.getCondition().(ValueFieldAccess).getTarget().getName()="socksproxy"
		and target_5.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="bits"
		and target_5.getCondition().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_1969
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_1971
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("Curl_idnconvert_hostname")
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_1968
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="host"
		and target_5.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(VariableAccess).getTarget()=vresult_1971
		and target_5.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget()=vresult_1971
		and (func.getEntryPoint().(BlockStmt).getStmt(23)=target_5 or func.getEntryPoint().(BlockStmt).getStmt(23).getFollowingStmt()=target_5)
		and target_5.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_6(Parameter vconn_1969, ExprStmt target_12) {
	exists(PointerFieldAccess target_6 |
		target_6.getTarget().getName()="host"
		and target_6.getQualifier().(VariableAccess).getTarget()=vconn_1969
		and target_6.getQualifier().(VariableAccess).getLocation().isBefore(target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation()))
}

predicate func_7(Parameter vdata_1968, PointerFieldAccess target_7) {
		target_7.getTarget().getName()="state"
		and target_7.getQualifier().(VariableAccess).getTarget()=vdata_1968
		and target_7.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getTarget().hasName("Curl_hsts")
		and target_7.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="hsts"
		and target_7.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1968
		and target_7.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof ValueFieldAccess
		and target_7.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(FunctionCall).getParent().(IfStmt).getCondition().(FunctionCall).getArgument(2).(Literal).getValue()="1"
}

predicate func_8(Parameter vdata_1968, ValueFieldAccess target_8) {
		target_8.getTarget().getName()="aptr"
		and target_8.getQualifier().(PointerFieldAccess).getTarget().getName()="state"
		and target_8.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1968
}

predicate func_9(Parameter vconn_1969, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="user"
		and target_9.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vconn_1969
		and target_9.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("char *")
}

predicate func_10(Variable vresult_1971, ReturnStmt target_10) {
		target_10.getExpr().(VariableAccess).getTarget()=vresult_1971
}

predicate func_11(Parameter vdata_1968, ValueFieldAccess target_11) {
		target_11.getTarget().getName()="up"
		and target_11.getQualifier().(PointerFieldAccess).getTarget().getName()="state"
		and target_11.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1968
}

predicate func_12(Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, ExprStmt target_12) {
		target_12.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vresult_1971
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("findprotocol")
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vdata_1968
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vconn_1969
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="scheme"
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="up"
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="state"
		and target_12.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdata_1968
}

from Function func, Parameter vdata_1968, Parameter vconn_1969, Variable vresult_1971, ValueFieldAccess target_0, PointerFieldAccess target_7, ValueFieldAccess target_8, ExprStmt target_9, ReturnStmt target_10, ValueFieldAccess target_11, ExprStmt target_12
where
func_0(vdata_1968, target_0)
and not func_1(vdata_1968, vconn_1969, vresult_1971, target_8, target_9, target_10, func)
and not func_3(vdata_1968, vconn_1969, vresult_1971, func)
and not func_4(vdata_1968, vconn_1969, vresult_1971, func)
and not func_5(vdata_1968, vconn_1969, vresult_1971, target_11, func)
and not func_6(vconn_1969, target_12)
and func_7(vdata_1968, target_7)
and func_8(vdata_1968, target_8)
and func_9(vconn_1969, target_9)
and func_10(vresult_1971, target_10)
and func_11(vdata_1968, target_11)
and func_12(vdata_1968, vconn_1969, vresult_1971, target_12)
and vdata_1968.getType().hasName("Curl_easy *")
and vconn_1969.getType().hasName("connectdata *")
and vresult_1971.getType().hasName("CURLcode")
and vdata_1968.getFunction() = func
and vconn_1969.getFunction() = func
and vresult_1971.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
