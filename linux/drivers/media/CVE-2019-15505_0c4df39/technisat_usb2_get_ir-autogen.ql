/**
 * @name linux-0c4df39e504bf925ab666132ac3c98d6cbbe380b-technisat_usb2_get_ir
 * @id cpp/linux/0c4df39e504bf925ab666132ac3c98d6cbbe380b/technisat-usb2-get-ir
 * @description linux-0c4df39e504bf925ab666132ac3c98d6cbbe380b-drivers/media/usb/dvb-usb/technisat-usb2.c-technisat_usb2_get_ir CVE-2019-15505
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1"
	and not target_0.getValue()="0"
	and target_0.getParent().(WhileStmt).getParent().(BlockStmt).getStmt(22) instanceof WhileStmt
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vb_612, ExprStmt target_23, VariableAccess target_1) {
	target_1.getTarget()=vb_612
	and target_1.getLocation().isBefore(target_23.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getLocation())
}

predicate func_2(DeclStmt target_19, Function func, DeclStmt target_2) {
	target_19.getLocation().isBefore(target_2.getLocation())
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Parameter vd_608, Variable vev_614, ExprStmt target_23, IfStmt target_3) {
	target_3.getCondition().(EqualityOperation).getLeftOperand() instanceof PointerDereferenceExpr
	and target_3.getCondition().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="255"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_3.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="duration"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_3.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(MulExpr).getValue()="1777776"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ir_raw_event_store")
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_608
	and target_3.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vev_614
	and target_23.getLocation().isBefore(target_3.getLocation())
}

predicate func_5(Parameter vd_608, Variable vbuf_611, Variable vev_614, ExprStmt target_26, ExprStmt target_27, ExprStmt target_28, Function func) {
exists(ForStmt target_5 |
	target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("int")
	and target_5.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue() instanceof Literal
	and target_5.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("int")
	and target_5.getCondition().(RelationalOperation).getGreaterOperand().(AddExpr).getValue()="64"
	and target_5.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getType().hasName("int")
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vbuf_611
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getType().hasName("int")
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="255"
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_5.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="duration"
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getRightOperand().(Literal).getValue()="83333"
	and target_5.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(Literal).getValue()="1000"
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ir_raw_event_store")
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_608
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vev_614
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
	and target_5.getLocation().isBefore(target_26.getLocation())
	and target_5.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_5.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_6(Function func) {
exists(AssignExpr target_6 |
	target_6.getLValue().(VariableAccess).getType().hasName("int")
	and target_6.getRValue() instanceof Literal
	and target_6.getEnclosingFunction() = func)
}

*/
/*predicate func_7(Variable vbuf_611, BlockStmt target_29) {
exists(ArrayExpr target_7 |
	target_7.getArrayBase().(VariableAccess).getTarget()=vbuf_611
	and target_7.getArrayOffset().(VariableAccess).getType().hasName("int")
	and target_7.getParent().(EQExpr).getLeftOperand() instanceof PointerDereferenceExpr
	and target_7.getParent().(EQExpr).getRightOperand().(HexLiteral).getValue()="255"
	and target_7.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_29)
}

*/
/*predicate func_9(Variable vev_614, ExprStmt target_30) {
exists(ValueFieldAccess target_9 |
	target_9.getTarget().getName()="duration"
	and target_9.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_9.getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_30.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_9.getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
/*predicate func_10(Function func) {
exists(ArrayExpr target_10 |
	target_10.getArrayBase().(VariableAccess).getType().hasName("u8 *")
	and target_10.getArrayOffset().(VariableAccess).getType().hasName("int")
	and target_10.getEnclosingFunction() = func)
}

*/
/*predicate func_11(Parameter vd_608, Variable vev_614, ExprStmt target_27, ExprStmt target_28) {
exists(FunctionCall target_11 |
	target_11.getTarget().hasName("ir_raw_event_store")
	and target_11.getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and target_11.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_608
	and target_11.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vev_614
	and target_11.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_11.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_28.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

*/
predicate func_12(Variable vev_614, ValueFieldAccess target_12) {
	target_12.getTarget().getName()="pulse"
	and target_12.getQualifier().(VariableAccess).getTarget()=vev_614
}

predicate func_13(Variable vev_614, ValueFieldAccess target_13) {
	target_13.getTarget().getName()="duration"
	and target_13.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_13.getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
}

predicate func_14(Parameter vd_608, Variable vev_614, FunctionCall target_14) {
	target_14.getTarget().hasName("ir_raw_event_store")
	and target_14.getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and target_14.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_608
	and target_14.getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vev_614
}

predicate func_16(Variable vbuf_611, VariableAccess target_16) {
	target_16.getTarget()=vbuf_611
}

predicate func_19(Function func, DeclStmt target_19) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

predicate func_20(Variable vbuf_611, Variable vb_612, AssignExpr target_20) {
	target_20.getLValue().(VariableAccess).getTarget()=vb_612
	and target_20.getRValue().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vbuf_611
	and target_20.getRValue().(PointerArithmeticOperation).getRightOperand() instanceof Literal
}

predicate func_21(Variable vb_612, Variable vev_614, Function func, WhileStmt target_21) {
	target_21.getCondition() instanceof Literal
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_21.getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_21.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_21.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(DivExpr).getLeftOperand().(MulExpr).getRightOperand().(Literal).getValue()="83333"
	and target_21.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(DivExpr).getRightOperand().(Literal).getValue()="1000"
	and target_21.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof FunctionCall
	and target_21.getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vb_612
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vb_612
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="255"
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="duration"
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ir_raw_event_store")
	and target_21.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

/*predicate func_22(Variable vb_612, PointerDereferenceExpr target_22) {
	target_22.getOperand().(VariableAccess).getTarget()=vb_612
}

*/
predicate func_23(Variable vb_612, ExprStmt target_23) {
	target_23.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vb_612
}

/*predicate func_24(Variable vb_612, BlockStmt target_29, ExprStmt target_23, PointerDereferenceExpr target_24) {
	target_24.getOperand().(VariableAccess).getTarget()=vb_612
	and target_24.getParent().(EQExpr).getRightOperand().(HexLiteral).getValue()="255"
	and target_24.getParent().(EQExpr).getParent().(IfStmt).getThen()=target_29
	and target_23.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getLocation().isBefore(target_24.getOperand().(VariableAccess).getLocation())
}

*/
predicate func_26(Function func, ExprStmt target_26) {
	target_26.getExpr() instanceof AssignExpr
	and target_26.getEnclosingFunction() = func
}

predicate func_27(Parameter vd_608, Variable vev_614, ExprStmt target_27) {
	target_27.getExpr().(FunctionCall).getTarget().hasName("ir_raw_event_store")
	and target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="rc_dev"
	and target_27.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vd_608
	and target_27.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vev_614
}

predicate func_28(Variable vev_614, EqualityOperation target_32, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_28.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_28.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_28.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_32
}

predicate func_29(Variable vev_614, BlockStmt target_29) {
	target_29.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_29.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_29.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_29.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="duration"
	and target_29.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_29.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
	and target_29.getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(MulExpr).getValue()="1777776"
}

predicate func_30(Variable vev_614, ExprStmt target_30) {
	target_30.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_30.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getTarget().getName()="pulse"
	and target_30.getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vev_614
}

predicate func_32(Function func, EqualityOperation target_32) {
	target_32.getLeftOperand() instanceof PointerDereferenceExpr
	and target_32.getRightOperand().(HexLiteral).getValue()="255"
	and target_32.getEnclosingFunction() = func
}

from Function func, Parameter vd_608, Variable vbuf_611, Variable vb_612, Variable vev_614, Literal target_0, VariableAccess target_1, DeclStmt target_2, IfStmt target_3, ValueFieldAccess target_12, ValueFieldAccess target_13, FunctionCall target_14, VariableAccess target_16, DeclStmt target_19, AssignExpr target_20, WhileStmt target_21, ExprStmt target_23, ExprStmt target_26, ExprStmt target_27, ExprStmt target_28, BlockStmt target_29, ExprStmt target_30, EqualityOperation target_32
where
func_0(func, target_0)
and func_1(vb_612, target_23, target_1)
and func_2(target_19, func, target_2)
and func_3(vd_608, vev_614, target_23, target_3)
and not func_5(vd_608, vbuf_611, vev_614, target_26, target_27, target_28, func)
and func_12(vev_614, target_12)
and func_13(vev_614, target_13)
and func_14(vd_608, vev_614, target_14)
and func_16(vbuf_611, target_16)
and func_19(func, target_19)
and func_20(vbuf_611, vb_612, target_20)
and func_21(vb_612, vev_614, func, target_21)
and func_23(vb_612, target_23)
and func_26(func, target_26)
and func_27(vd_608, vev_614, target_27)
and func_28(vev_614, target_32, target_28)
and func_29(vev_614, target_29)
and func_30(vev_614, target_30)
and func_32(func, target_32)
and vd_608.getType().hasName("dvb_usb_device *")
and vbuf_611.getType().hasName("u8 *")
and vb_612.getType().hasName("u8 *")
and vev_614.getType().hasName("ir_raw_event")
and vd_608.getFunction() = func
and vbuf_611.(LocalVariable).getFunction() = func
and vb_612.(LocalVariable).getFunction() = func
and vev_614.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
