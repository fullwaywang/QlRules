/**
 * @name linux-246c320a8cfe0b11d81a4af38fa9985ef0cc9a4c-__do_munmap
 * @id cpp/linux/246c320a8cfe0b11d81a4af38fa9985ef0cc9a4c/--do-munmap
 * @description linux-246c320a8cfe0b11d81a4af38fa9985ef0cc9a4c-mm/mmap.c-__do_munmap CVE-2020-29369
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vdowngrade_2733, ExprStmt target_3, IfStmt target_4, Function func) {
exists(IfStmt target_0 |
	target_0.getCondition().(NotExpr).getOperand() instanceof FunctionCall
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdowngrade_2733
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_3.getLocation())
	and target_0.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_4.getCondition().(VariableAccess).getLocation()))
}

/*predicate func_1(Parameter vdowngrade_2733, IfStmt target_4) {
exists(AssignExpr target_1 |
	target_1.getLValue().(VariableAccess).getTarget()=vdowngrade_2733
	and target_1.getLValue().(VariableAccess).getLocation().isBefore(target_4.getCondition().(VariableAccess).getLocation()))
}

*/
predicate func_2(Parameter vmm_2732, Variable vend_2735, Variable vvma_2736, Variable vprev_2736, FunctionCall target_2) {
	target_2.getTarget().hasName("detach_vmas_to_be_unmapped")
	and target_2.getArgument(0).(VariableAccess).getTarget()=vmm_2732
	and target_2.getArgument(1).(VariableAccess).getTarget()=vvma_2736
	and target_2.getArgument(2).(VariableAccess).getTarget()=vprev_2736
	and target_2.getArgument(3).(VariableAccess).getTarget()=vend_2735
}

predicate func_3(Function func, ExprStmt target_3) {
	target_3.getExpr() instanceof FunctionCall
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Parameter vmm_2732, Parameter vdowngrade_2733, IfStmt target_4) {
	target_4.getCondition().(VariableAccess).getTarget()=vdowngrade_2733
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("mmap_write_downgrade")
	and target_4.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmm_2732
}

from Function func, Parameter vmm_2732, Parameter vdowngrade_2733, Variable vend_2735, Variable vvma_2736, Variable vprev_2736, FunctionCall target_2, ExprStmt target_3, IfStmt target_4
where
not func_0(vdowngrade_2733, target_3, target_4, func)
and func_2(vmm_2732, vend_2735, vvma_2736, vprev_2736, target_2)
and func_3(func, target_3)
and func_4(vmm_2732, vdowngrade_2733, target_4)
and vmm_2732.getType().hasName("mm_struct *")
and vdowngrade_2733.getType().hasName("bool")
and vend_2735.getType().hasName("unsigned long")
and vvma_2736.getType().hasName("vm_area_struct *")
and vprev_2736.getType().hasName("vm_area_struct *")
and vmm_2732.getFunction() = func
and vdowngrade_2733.getFunction() = func
and vend_2735.(LocalVariable).getFunction() = func
and vvma_2736.(LocalVariable).getFunction() = func
and vprev_2736.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
