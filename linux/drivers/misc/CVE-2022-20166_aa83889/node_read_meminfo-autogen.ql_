/**
 * @name linux-aa838896d87af561a33ecefea1caa4c15a68bc47-node_read_meminfo
 * @id cpp/linux/aa838896d87af561a33ecefea1caa4c15a68bc47/node-read-meminfo
 * @description linux-aa838896d87af561a33ecefea1caa4c15a68bc47-drivers/base/node.c-node_read_meminfo CVE-2022-20166
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vbuf_362, Variable vnid_365, Variable vpgdat_366, Variable vi_367, FunctionCall target_0) {
	target_0.getTarget().hasName("sprintf")
	and not target_0.getTarget().hasName("sysfs_emit")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vbuf_362
	and target_0.getArgument(1).(StringLiteral).getValue()="Node %d MemTotal:       %8lu kB\nNode %d MemFree:        %8lu kB\nNode %d MemUsed:        %8lu kB\nNode %d Active:         %8lu kB\nNode %d Inactive:       %8lu kB\nNode %d Active(anon):   %8lu kB\nNode %d Inactive(anon): %8lu kB\nNode %d Active(file):   %8lu kB\nNode %d Inactive(file): %8lu kB\nNode %d Unevictable:    %8lu kB\nNode %d Mlocked:        %8lu kB\n"
	and target_0.getArgument(2).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(3).(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="totalram"
	and target_0.getArgument(3).(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vi_367
	and target_0.getArgument(3).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(4).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(5).(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="freeram"
	and target_0.getArgument(5).(BinaryBitwiseOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vi_367
	and target_0.getArgument(5).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(6).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(7).(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="totalram"
	and target_0.getArgument(7).(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vi_367
	and target_0.getArgument(7).(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(ValueFieldAccess).getTarget().getName()="freeram"
	and target_0.getArgument(7).(BinaryBitwiseOperation).getLeftOperand().(SubExpr).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vi_367
	and target_0.getArgument(7).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(8).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(9).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(9).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(9).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getRightOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(9).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(9).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(10).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(11).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(11).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(11).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getRightOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(11).(BinaryBitwiseOperation).getLeftOperand().(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(11).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(12).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(13).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(13).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(13).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(14).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(15).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(15).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(15).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(16).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(17).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(17).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(17).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(18).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(19).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(19).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(19).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(20).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(21).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("node_page_state")
	and target_0.getArgument(21).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vpgdat_366
	and target_0.getArgument(21).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getArgument(22).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(23).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getTarget().hasName("sum_zone_node_page_state")
	and target_0.getArgument(23).(BinaryBitwiseOperation).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnid_365
	and target_0.getArgument(23).(BinaryBitwiseOperation).getRightOperand().(SubExpr).getValue()="2"
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
}

from Function func, Parameter vbuf_362, Variable vnid_365, Variable vpgdat_366, Variable vi_367, FunctionCall target_0
where
func_0(vbuf_362, vnid_365, vpgdat_366, vi_367, target_0)
and vbuf_362.getType().hasName("char *")
and vnid_365.getType().hasName("int")
and vpgdat_366.getType().hasName("pglist_data *")
and vi_367.getType().hasName("sysinfo")
and vbuf_362.getFunction() = func
and vnid_365.(LocalVariable).getFunction() = func
and vpgdat_366.(LocalVariable).getFunction() = func
and vi_367.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
