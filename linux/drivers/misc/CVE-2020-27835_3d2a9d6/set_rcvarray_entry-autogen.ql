/**
 * @name linux-3d2a9d642512c21a12d19b9250e7a835dcb41a79-set_rcvarray_entry
 * @id cpp/linux/3d2a9d642512c21a12d19b9250e7a835dcb41a79/set-rcvarray-entry
 * @description linux-3d2a9d642512c21a12d19b9250e7a835dcb41a79-set_rcvarray_entry CVE-2020-27835
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfd_717) {
	exists(FunctionCall target_0 |
		target_0.getTarget().hasName("get_current")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("mmu_interval_notifier_insert")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="notifier"
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tid_rb_node *")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="mm"
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfd_717
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vaddr"
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tid_user_buf *")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u16")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(MulExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(MulExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_0.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("const mmu_interval_notifier_ops"))
}

predicate func_1(Parameter vfd_717, IfStmt target_2, ExprStmt target_3, VariableAccess target_1) {
		target_1.getTarget()=vfd_717
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("mmu_interval_notifier_insert")
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="notifier"
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tid_rb_node *")
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="mm"
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vaddr"
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tid_user_buf *")
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("u16")
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(MulExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(MulExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="4096"
		and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("const mmu_interval_notifier_ops")
		and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getLocation())
		and target_1.getLocation().isBefore(target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

predicate func_2(Parameter vfd_717, IfStmt target_2) {
		target_2.getCondition().(PointerFieldAccess).getTarget().getName()="use_mn"
		and target_2.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfd_717
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("int")
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("mmu_interval_notifier_insert")
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="notifier"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="mm"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfd_717
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddExpr).getAnOperand().(PointerFieldAccess).getTarget().getName()="vaddr"
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(MulExpr).getLeftOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
		and target_2.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget().getType().hasName("const mmu_interval_notifier_ops")
}

predicate func_3(Parameter vfd_717, ExprStmt target_3) {
		target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="entry_to_rb"
		and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfd_717
		and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="rcventry"
		and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("tid_rb_node *")
		and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(PointerFieldAccess).getTarget().getName()="expected_base"
		and target_3.getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("hfi1_ctxtdata *")
		and target_3.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget().getType().hasName("tid_rb_node *")
}

from Function func, Parameter vfd_717, VariableAccess target_1, IfStmt target_2, ExprStmt target_3
where
not func_0(vfd_717)
and func_1(vfd_717, target_2, target_3, target_1)
and func_2(vfd_717, target_2)
and func_3(vfd_717, target_3)
and vfd_717.getType().hasName("hfi1_filedata *")
and vfd_717.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
