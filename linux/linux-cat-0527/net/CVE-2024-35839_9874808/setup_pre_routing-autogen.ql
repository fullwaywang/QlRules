/**
 * @name linux-9874808878d9eed407e3977fd11fee49de1e1d86-setup_pre_routing
 * @id cpp/linux/9874808878d9eed407e3977fd11fee49de1e1d86/setup-pre-routing
 * @description linux-9874808878d9eed407e3977fd11fee49de1e1d86-net/bridge/br_netfilter_hooks.c-setup_pre_routing CVE-2024-35839
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vnf_bridge_451, ExprStmt target_4) {
exists(AssignExpr target_0 |
	target_0.getLValue().(PointerFieldAccess).getTarget().getName()="physinif"
	and target_0.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnf_bridge_451
	and target_0.getRValue().(PointerFieldAccess).getTarget().getName()="ifindex"
	and target_0.getRValue().(PointerFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_0.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Parameter vskb_449, ValueFieldAccess target_1) {
	target_1.getTarget().getName()="dev"
	and target_1.getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_1.getQualifier().(ValueFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vskb_449
}

predicate func_2(Variable vnf_bridge_451, VariableAccess target_2) {
	target_2.getTarget()=vnf_bridge_451
}

predicate func_3(Variable vnf_bridge_451, AssignExpr target_3) {
	target_3.getLValue().(PointerFieldAccess).getTarget().getName()="physindev"
	and target_3.getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnf_bridge_451
	and target_3.getRValue() instanceof ValueFieldAccess
}

predicate func_4(Variable vnf_bridge_451, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="orig_proto"
	and target_4.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnf_bridge_451
}

from Function func, Parameter vskb_449, Variable vnf_bridge_451, ValueFieldAccess target_1, VariableAccess target_2, AssignExpr target_3, ExprStmt target_4
where
not func_0(vnf_bridge_451, target_4)
and func_1(vskb_449, target_1)
and func_2(vnf_bridge_451, target_2)
and func_3(vnf_bridge_451, target_3)
and func_4(vnf_bridge_451, target_4)
and vskb_449.getType().hasName("sk_buff *")
and vnf_bridge_451.getType().hasName("nf_bridge_info *")
and vskb_449.getFunction() = func
and vnf_bridge_451.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
