/**
 * @name linux-de9f869616dd95e95c00bdd6b0fcd3421e8a4323-get_desc
 * @id cpp/linux/de9f869616dd95e95c00bdd6b0fcd3421e8a4323/get-desc
 * @description linux-de9f869616dd95e95c00bdd6b0fcd3421e8a4323-arch/x86/lib/insn-eval.c-get_desc CVE-2019-13233
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
		target_0.getExpr().(Literal).getValue()="0"
		and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Variable vdesc_579, VariableAccess target_1) {
		target_1.getTarget()=vdesc_579
}

predicate func_4(Variable vldt_580, Parameter vsel_572, LogicalAndExpr target_16, ExprStmt target_17) {
	exists(AssignExpr target_4 |
		target_4.getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getType().hasName("desc_struct *")
		and target_4.getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="entries"
		and target_4.getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vldt_580
		and target_4.getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vsel_572
		and target_16.getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getRValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_4.getRValue().(ArrayExpr).getArrayOffset().(VariableAccess).getLocation().isBefore(target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_5(LogicalAndExpr target_16, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("bool")
		and target_5.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_5
		and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_16
		and target_5.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(AssignExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getType().hasName("desc_struct *")
		and target_8.getExpr().(AssignExpr).getRValue().(PointerDereferenceExpr).getOperand() instanceof AddExpr
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

predicate func_10(Variable vldt_580, Parameter vsel_572, PointerFieldAccess target_10) {
		target_10.getTarget().getName()="entries"
		and target_10.getQualifier().(VariableAccess).getTarget()=vldt_580
		and target_10.getParent().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vsel_572
}

predicate func_11(Variable vgdt_desc_574, Variable vdesc_base_575, AddExpr target_11) {
		target_11.getAnOperand().(ValueFieldAccess).getTarget().getName()="address"
		and target_11.getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vgdt_desc_574
		and target_11.getAnOperand().(VariableAccess).getTarget()=vdesc_base_575
}

/*predicate func_12(Variable vldt_580, Parameter vsel_572, VariableAccess target_12) {
		target_12.getTarget()=vsel_572
		and target_12.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="entries"
		and target_12.getParent().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vldt_580
}

*/
predicate func_14(Variable vdesc_579, Variable vldt_580, Parameter vsel_572, AssignExpr target_14) {
		target_14.getLValue().(VariableAccess).getTarget()=vdesc_579
		and target_14.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="entries"
		and target_14.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vldt_580
		and target_14.getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vsel_572
}

predicate func_16(Variable vldt_580, Parameter vsel_572, LogicalAndExpr target_16) {
		target_16.getAnOperand().(VariableAccess).getTarget()=vldt_580
		and target_16.getAnOperand().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vsel_572
		and target_16.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="nr_entries"
		and target_16.getAnOperand().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vldt_580
}

predicate func_17(Variable vdesc_base_575, Parameter vsel_572, ExprStmt target_17) {
		target_17.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vdesc_base_575
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vsel_572
		and target_17.getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(ComplementExpr).getValue()="-8"
}

from Function func, Variable vgdt_desc_574, Variable vdesc_base_575, Variable vdesc_579, Variable vldt_580, Parameter vsel_572, Initializer target_0, VariableAccess target_1, PointerFieldAccess target_10, AddExpr target_11, AssignExpr target_14, LogicalAndExpr target_16, ExprStmt target_17
where
func_0(func, target_0)
and func_1(vdesc_579, target_1)
and not func_4(vldt_580, vsel_572, target_16, target_17)
and not func_5(target_16, func)
and not func_8(func)
and func_10(vldt_580, vsel_572, target_10)
and func_11(vgdt_desc_574, vdesc_base_575, target_11)
and func_14(vdesc_579, vldt_580, vsel_572, target_14)
and func_16(vldt_580, vsel_572, target_16)
and func_17(vdesc_base_575, vsel_572, target_17)
and vgdt_desc_574.getType().hasName("desc_ptr")
and vdesc_base_575.getType().hasName("unsigned long")
and vdesc_579.getType().hasName("desc_struct *")
and vldt_580.getType().hasName("ldt_struct *")
and vsel_572.getType().hasName("unsigned short")
and vgdt_desc_574.(LocalVariable).getFunction() = func
and vdesc_base_575.(LocalVariable).getFunction() = func
and vdesc_579.(LocalVariable).getFunction() = func
and vldt_580.(LocalVariable).getFunction() = func
and vsel_572.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
