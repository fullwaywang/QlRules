/**
 * @name linux-372e3147df7016ebeaa372939e8774a1292db558-binder_translate_binder
 * @id cpp/linux/372e3147df7016ebeaa372939e8774a1292db558/binder-translate-binder
 * @description linux-372e3147df7016ebeaa372939e8774a1292db558-drivers/android/binder.c-binder_translate_binder CVE-2018-20509
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Parameter vthread_1209, Variable vref_1212, Parameter vfp_1207, FunctionCall target_1) {
	target_1.getTarget().hasName("binder_inc_ref")
	and not target_1.getTarget().hasName("binder_inc_ref_for_node")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vref_1212
	and target_1.getArgument(1).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_1.getArgument(1).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="hdr"
	and target_1.getArgument(1).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1207
	and target_1.getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="todo"
	and target_1.getArgument(2).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthread_1209
}

predicate func_2(Function func, DeclStmt target_2) {
	target_2.getFollowingStmt() instanceof DeclStmt
	and target_2.getEnclosingFunction() = func
}

predicate func_4(Parameter vthread_1209, Variable vnode_1211, Variable vtarget_proc_1214, Parameter vfp_1207, ExprStmt target_23, ExprStmt target_19, ExprStmt target_24) {
exists(AssignExpr target_4 |
	target_4.getLValue().(VariableAccess).getType().hasName("int")
	and target_4.getRValue().(FunctionCall).getTarget().hasName("binder_inc_ref_for_node")
	and target_4.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtarget_proc_1214
	and target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnode_1211
	and target_4.getRValue().(FunctionCall).getArgument(2).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getTarget().getName()="type"
	and target_4.getRValue().(FunctionCall).getArgument(2).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="hdr"
	and target_4.getRValue().(FunctionCall).getArgument(2).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1207
	and target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="todo"
	and target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthread_1209
	and target_4.getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("binder_ref_data")
	and target_23.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(3).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_4.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_19.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation())
	and target_24.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getRValue().(FunctionCall).getArgument(2).(EqualityOperation).getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

/*predicate func_5(Function func) {
exists(AddressOfExpr target_5 |
	target_5.getOperand().(VariableAccess).getType().hasName("binder_ref_data")
	and target_5.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
	and target_5.getEnclosingFunction() = func)
}

*/
predicate func_8(Function func) {
exists(ValueFieldAccess target_8 |
	target_8.getTarget().getName()="desc"
	and target_8.getQualifier().(VariableAccess).getType().hasName("binder_ref_data")
	and target_8.getEnclosingFunction() = func)
}

predicate func_9(Parameter vt_1208, Variable vnode_1211, Variable vref_1212) {
exists(AddressOfExpr target_9 |
	target_9.getOperand().(VariableAccess).getType().hasName("binder_ref_data")
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("trace_binder_transaction_node_to_ref")
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vt_1208
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnode_1211
	and target_9.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vref_1212)
}

predicate func_10(Function func) {
exists(ValueFieldAccess target_10 |
	target_10.getTarget().getName()="debug_id"
	and target_10.getQualifier().(VariableAccess).getType().hasName("binder_ref_data")
	and target_10.getEnclosingFunction() = func)
}

predicate func_11(Function func) {
exists(ValueFieldAccess target_11 |
	target_11.getTarget().getName()="desc"
	and target_11.getQualifier().(VariableAccess).getType().hasName("binder_ref_data")
	and target_11.getEnclosingFunction() = func)
}

predicate func_12(Variable vtarget_proc_1214, VariableAccess target_12) {
	target_12.getTarget()=vtarget_proc_1214
	and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_13(Variable vnode_1211, VariableAccess target_13) {
	target_13.getTarget()=vnode_1211
	and target_13.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_15(Variable vnode_1211, Variable vref_1212, Variable vtarget_proc_1214, AssignExpr target_15) {
	target_15.getLValue().(VariableAccess).getTarget()=vref_1212
	and target_15.getRValue().(FunctionCall).getTarget().hasName("binder_get_ref_for_node")
	and target_15.getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtarget_proc_1214
	and target_15.getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnode_1211
}

predicate func_16(Variable vref_1212, ReturnStmt target_25, NotExpr target_16) {
	target_16.getOperand().(VariableAccess).getTarget()=vref_1212
	and target_16.getParent().(IfStmt).getThen()=target_25
}

predicate func_17(Function func, UnaryMinusExpr target_17) {
	target_17.getValue()="-12"
	and target_17.getEnclosingFunction() = func
}

predicate func_18(Variable vref_1212, NotExpr target_16, PointerFieldAccess target_18) {
	target_18.getTarget().getName()="desc"
	and target_18.getQualifier().(VariableAccess).getTarget()=vref_1212
	and target_16.getOperand().(VariableAccess).getLocation().isBefore(target_18.getQualifier().(VariableAccess).getLocation())
}

predicate func_19(Parameter vt_1208, Variable vnode_1211, Variable vref_1212, Function func, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("trace_binder_transaction_node_to_ref")
	and target_19.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vt_1208
	and target_19.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnode_1211
	and target_19.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vref_1212
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_19
}

/*predicate func_20(Parameter vt_1208, Variable vnode_1211, Variable vref_1212, ExprStmt target_28, VariableAccess target_20) {
	target_20.getTarget()=vref_1212
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("trace_binder_transaction_node_to_ref")
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vt_1208
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vnode_1211
	and target_20.getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getLocation().isBefore(target_28.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
}

*/
predicate func_21(Variable vref_1212, PointerFieldAccess target_21) {
	target_21.getTarget().getName()="debug_id"
	and target_21.getQualifier().(VariableAccess).getTarget()=vref_1212
}

predicate func_22(Variable vref_1212, PointerFieldAccess target_22) {
	target_22.getTarget().getName()="desc"
	and target_22.getQualifier().(VariableAccess).getTarget()=vref_1212
}

predicate func_23(Parameter vthread_1209, Variable vnode_1211, Parameter vfp_1207, ExprStmt target_23) {
	target_23.getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_23.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6binder: %d:%d sending u%016llx node %d, cookie mismatch %016llx != %016llx\n"
	and target_23.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="pid"
	and target_23.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("binder_proc *")
	and target_23.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="pid"
	and target_23.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vthread_1209
	and target_23.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="binder"
	and target_23.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_23.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1207
	and target_23.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="debug_id"
	and target_23.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnode_1211
	and target_23.getExpr().(FunctionCall).getArgument(5).(PointerFieldAccess).getTarget().getName()="cookie"
	and target_23.getExpr().(FunctionCall).getArgument(5).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1207
	and target_23.getExpr().(FunctionCall).getArgument(6).(PointerFieldAccess).getTarget().getName()="cookie"
	and target_23.getExpr().(FunctionCall).getArgument(6).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnode_1211
}

predicate func_24(Parameter vfp_1207, ExprStmt target_24) {
	target_24.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="cookie"
	and target_24.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vfp_1207
	and target_24.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
}

predicate func_25(Function func, ReturnStmt target_25) {
	target_25.getExpr() instanceof UnaryMinusExpr
	and target_25.getEnclosingFunction() = func
}

predicate func_28(Variable vnode_1211, Variable vref_1212, ExprStmt target_28) {
	target_28.getExpr().(FunctionCall).getTarget().hasName("printk")
	and target_28.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="6binder:         node %d u%016llx -> ref %d desc %d\n"
	and target_28.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="debug_id"
	and target_28.getExpr().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnode_1211
	and target_28.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getTarget().getName()="ptr"
	and target_28.getExpr().(FunctionCall).getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnode_1211
	and target_28.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="debug_id"
	and target_28.getExpr().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vref_1212
	and target_28.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="desc"
	and target_28.getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vref_1212
}

from Function func, Parameter vt_1208, Parameter vthread_1209, Variable vnode_1211, Variable vref_1212, Variable vtarget_proc_1214, Parameter vfp_1207, FunctionCall target_1, DeclStmt target_2, VariableAccess target_12, VariableAccess target_13, AssignExpr target_15, NotExpr target_16, UnaryMinusExpr target_17, PointerFieldAccess target_18, ExprStmt target_19, PointerFieldAccess target_21, PointerFieldAccess target_22, ExprStmt target_23, ExprStmt target_24, ReturnStmt target_25, ExprStmt target_28
where
func_1(vthread_1209, vref_1212, vfp_1207, target_1)
and func_2(func, target_2)
and not func_4(vthread_1209, vnode_1211, vtarget_proc_1214, vfp_1207, target_23, target_19, target_24)
and not func_8(func)
and not func_9(vt_1208, vnode_1211, vref_1212)
and not func_10(func)
and not func_11(func)
and func_12(vtarget_proc_1214, target_12)
and func_13(vnode_1211, target_13)
and func_15(vnode_1211, vref_1212, vtarget_proc_1214, target_15)
and func_16(vref_1212, target_25, target_16)
and func_17(func, target_17)
and func_18(vref_1212, target_16, target_18)
and func_19(vt_1208, vnode_1211, vref_1212, func, target_19)
and func_21(vref_1212, target_21)
and func_22(vref_1212, target_22)
and func_23(vthread_1209, vnode_1211, vfp_1207, target_23)
and func_24(vfp_1207, target_24)
and func_25(func, target_25)
and func_28(vnode_1211, vref_1212, target_28)
and vt_1208.getType().hasName("binder_transaction *")
and vthread_1209.getType().hasName("binder_thread *")
and vnode_1211.getType().hasName("binder_node *")
and vref_1212.getType().hasName("binder_ref *")
and vtarget_proc_1214.getType().hasName("binder_proc *")
and vfp_1207.getType().hasName("flat_binder_object *")
and vt_1208.getFunction() = func
and vthread_1209.getFunction() = func
and vnode_1211.(LocalVariable).getFunction() = func
and vref_1212.(LocalVariable).getFunction() = func
and vtarget_proc_1214.(LocalVariable).getFunction() = func
and vfp_1207.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
