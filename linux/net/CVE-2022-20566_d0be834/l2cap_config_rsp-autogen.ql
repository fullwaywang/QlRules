/**
 * @name linux-d0be8347c623e0ac4202a1d4e0373882821f56b0-l2cap_config_rsp
 * @id cpp/linux/d0be8347c623e0ac4202a1d4e0373882821f56b0/l2cap-config-rsp
 * @description linux-d0be8347c623e0ac4202a1d4e0373882821f56b0-l2cap_config_rsp CVE-2022-20566
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable v__UNIQUE_ID_ddebug1284_4486, VariableAccess target_1) {
		target_1.getTarget()=v__UNIQUE_ID_ddebug1284_4486
		and target_1.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch_jump")
}

predicate func_2(Variable v__UNIQUE_ID_ddebug1284_4486, VariableAccess target_2) {
		target_2.getTarget()=v__UNIQUE_ID_ddebug1284_4486
		and target_2.getParent().(ValueFieldAccess).getParent().(ValueFieldAccess).getParent().(AddressOfExpr).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("arch_static_branch")
}

predicate func_3(Variable v__UNIQUE_ID_ddebug1284_4486, VariableAccess target_3) {
		target_3.getTarget()=v__UNIQUE_ID_ddebug1284_4486
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__dynamic_pr_debug")
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="scid 0x%4.4x flags 0x%2.2x result 0x%2.2x len %d\n"
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget().getType().hasName("u16")
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("u16")
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget().getType().hasName("u16")
		and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_4(Variable vchan_4475, ExprStmt target_5, Function func) {
	exists(ExprStmt target_4 |
		target_4.getExpr().(FunctionCall).getTarget().hasName("l2cap_chan_put")
		and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vchan_4475
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_5(Variable vchan_4475, ExprStmt target_5) {
		target_5.getExpr().(FunctionCall).getTarget().hasName("l2cap_chan_unlock")
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vchan_4475
}

from Function func, Variable vchan_4475, Variable v__UNIQUE_ID_ddebug1284_4486, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, ExprStmt target_5
where
func_1(v__UNIQUE_ID_ddebug1284_4486, target_1)
and func_2(v__UNIQUE_ID_ddebug1284_4486, target_2)
and func_3(v__UNIQUE_ID_ddebug1284_4486, target_3)
and not func_4(vchan_4475, target_5, func)
and func_5(vchan_4475, target_5)
and vchan_4475.getType().hasName("l2cap_chan *")
and v__UNIQUE_ID_ddebug1284_4486.getType().hasName("_ddebug")
and vchan_4475.(LocalVariable).getFunction() = func
and v__UNIQUE_ID_ddebug1284_4486.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
