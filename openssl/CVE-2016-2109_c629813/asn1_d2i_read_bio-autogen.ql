/**
 * @name openssl-c62981390d6cf9e3d612c489b8b77c2913b25807-asn1_d2i_read_bio
 * @id cpp/openssl/c62981390d6cf9e3d612c489b8b77c2913b25807/asn1-d2i-read-bio
 * @description openssl-c62981390d6cf9e3d612c489b8b77c2913b25807-crypto/asn1/a_d2i_fp.c-asn1_d2i_read_bio CVE-2016-2109
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vb_143, Variable vwant_146, Variable vlen_149, VariableAccess target_0) {
		target_0.getTarget()=vwant_146
		and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("BUF_MEM_grow_clean")
		and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vb_143
		and target_0.getParent().(AddExpr).getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vlen_149
}

predicate func_1(Variable vwant_146, VariableAccess target_1) {
		target_1.getTarget()=vwant_146
		and target_1.getParent().(GTExpr).getLesserOperand().(Literal).getValue()="0"
}

predicate func_2(Variable vb_143, Variable vwant_146, Variable vlen_149, VariableAccess target_2) {
		target_2.getTarget()=vwant_146
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("BIO_read")
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("BIO *")
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="data"
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_143
		and target_2.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vlen_149
}

predicate func_3(Variable vi_145, Variable vwant_146, VariableAccess target_3) {
		target_3.getTarget()=vwant_146
		and target_3.getParent().(AssignSubExpr).getLValue() = target_3
		and target_3.getParent().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vi_145
}

predicate func_4(Variable vb_143, Variable vi_145, Variable vwant_146, Variable vlen_149, RelationalOperation target_7, ExprStmt target_8, AddressOfExpr target_9, ExprStmt target_10, AddExpr target_11, LogicalOrExpr target_12) {
	exists(WhileStmt target_4 |
		target_4.getCondition() instanceof RelationalOperation
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("BUF_MEM_grow_clean")
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vb_143
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getTarget()=vlen_149
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("ERR_put_error")
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(Literal).getValue()="13"
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="107"
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3) instanceof StringLiteral
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4) instanceof Literal
		and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getTarget()=vwant_146
		and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getCondition().(RelationalOperation).getLesserOperand().(Literal).getValue()="0"
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_145
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("BIO_read")
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_145
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="0"
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget()=vlen_149
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vi_145
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(AssignSubExpr).getRValue().(VariableAccess).getTarget()=vi_145
		and target_4.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(4).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(DivExpr).getValue()="1073741823"
		and target_4.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(ExprStmt).getExpr().(AssignMulExpr).getLValue().(VariableAccess).getType().hasName("size_t")
		and target_4.getStmt().(BlockStmt).getStmt(4).(IfStmt).getThen().(ExprStmt).getExpr().(AssignMulExpr).getRValue().(Literal).getValue()="2"
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(3)=target_4
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_7
		and target_8.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
		and target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_9.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_10.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getLocation().isBefore(target_4.getStmt().(BlockStmt).getStmt(3).(WhileStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
		and target_4.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignSubExpr).getLValue().(VariableAccess).getLocation().isBefore(target_11.getAnOperand().(VariableAccess).getLocation())
		and target_12.getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(VariableAccess).getLocation().isBefore(target_4.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1).(AddExpr).getAnOperand().(VariableAccess).getLocation()))
}

/*predicate func_5(Function func) {
	exists(RelationalOperation target_5 |
		 (target_5 instanceof GTExpr or target_5 instanceof LTExpr)
		and target_5.getGreaterOperand().(VariableAccess).getType().hasName("size_t")
		and target_5.getLesserOperand().(Literal).getValue()="0"
		and target_5.getEnclosingFunction() = func)
}

*/
predicate func_6(Variable vwant_146, RelationalOperation target_6) {
		 (target_6 instanceof GTExpr or target_6 instanceof LTExpr)
		and target_6.getGreaterOperand().(VariableAccess).getTarget()=vwant_146
		and target_6.getLesserOperand().(Literal).getValue()="0"
}

predicate func_7(Variable vwant_146, Variable vlen_149, RelationalOperation target_7) {
		 (target_7 instanceof GTExpr or target_7 instanceof LTExpr)
		and target_7.getGreaterOperand().(VariableAccess).getTarget()=vwant_146
		and target_7.getLesserOperand().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vlen_149
		and target_7.getLesserOperand().(SubExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("size_t")
}

predicate func_8(Variable vb_143, ExprStmt target_8) {
		target_8.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned char *")
		and target_8.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="data"
		and target_8.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_143
		and target_8.getExpr().(AssignExpr).getRValue().(AddressOfExpr).getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("size_t")
}

predicate func_9(Variable vb_143, Variable vwant_146, Variable vlen_149, AddressOfExpr target_9) {
		target_9.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="data"
		and target_9.getOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vb_143
		and target_9.getOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vlen_149
		and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("BIO_read")
		and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("BIO *")
		and target_9.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vwant_146
}

predicate func_10(Variable vi_145, ExprStmt target_10) {
		target_10.getExpr().(AssignAddExpr).getLValue().(VariableAccess).getTarget().getType().hasName("size_t")
		and target_10.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vi_145
}

predicate func_11(Variable vb_143, Variable vwant_146, Variable vlen_149, AddExpr target_11) {
		target_11.getAnOperand().(VariableAccess).getTarget()=vlen_149
		and target_11.getAnOperand().(VariableAccess).getTarget()=vwant_146
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("BUF_MEM_grow_clean")
		and target_11.getParent().(FunctionCall).getParent().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vb_143
}

predicate func_12(Variable vwant_146, Variable vlen_149, LogicalOrExpr target_12) {
		target_12.getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vwant_146
		and target_12.getAnOperand().(RelationalOperation).getLesserOperand().(Literal).getValue()="2147483647"
		and target_12.getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vlen_149
		and target_12.getAnOperand().(RelationalOperation).getLesserOperand().(AddExpr).getAnOperand().(VariableAccess).getTarget()=vwant_146
		and target_12.getAnOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vlen_149
}

from Function func, Variable vb_143, Variable vi_145, Variable vwant_146, Variable vlen_149, VariableAccess target_0, VariableAccess target_1, VariableAccess target_2, VariableAccess target_3, RelationalOperation target_6, RelationalOperation target_7, ExprStmt target_8, AddressOfExpr target_9, ExprStmt target_10, AddExpr target_11, LogicalOrExpr target_12
where
func_0(vb_143, vwant_146, vlen_149, target_0)
and func_1(vwant_146, target_1)
and func_2(vb_143, vwant_146, vlen_149, target_2)
and func_3(vi_145, vwant_146, target_3)
and not func_4(vb_143, vi_145, vwant_146, vlen_149, target_7, target_8, target_9, target_10, target_11, target_12)
and func_6(vwant_146, target_6)
and func_7(vwant_146, vlen_149, target_7)
and func_8(vb_143, target_8)
and func_9(vb_143, vwant_146, vlen_149, target_9)
and func_10(vi_145, target_10)
and func_11(vb_143, vwant_146, vlen_149, target_11)
and func_12(vwant_146, vlen_149, target_12)
and vb_143.getType().hasName("BUF_MEM *")
and vi_145.getType().hasName("int")
and vwant_146.getType().hasName("size_t")
and vlen_149.getType().hasName("size_t")
and vb_143.(LocalVariable).getFunction() = func
and vi_145.(LocalVariable).getFunction() = func
and vwant_146.(LocalVariable).getFunction() = func
and vlen_149.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
