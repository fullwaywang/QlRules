/**
 * @name linux-f0992098cadb4c9c6a00703b66cafe604e178fea-spk_ttyio_initialise_ldisc
 * @id cpp/linux/f0992098cadb4c9c6a00703b66cafe604e178fea/spk-ttyio-initialise-ldisc
 * @description linux-f0992098cadb4c9c6a00703b66cafe604e178fea-spk_ttyio_initialise_ldisc CVE-2020-27830
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
	exists(ExprStmt target_0 |
		target_0.getExpr().(FunctionCall).getTarget().hasName("mutex_lock_nested")
		and target_0.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mutex")
		and target_0.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_0)
}

predicate func_1(Variable vtty_154, ExprStmt target_10, ExprStmt target_11, Function func) {
	exists(ExprStmt target_1 |
		target_1.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("tty_struct *")
		and target_1.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vtty_154
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation())
		and target_1.getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation().isBefore(target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(VariableAccess target_12, Function func) {
	exists(ExprStmt target_2 |
		target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("tty_struct *")
		and target_2.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
		and target_2.getParent().(IfStmt).getCondition()=target_12
		and target_2.getEnclosingFunction() = func)
}

predicate func_3(Function func) {
	exists(ExprStmt target_3 |
		target_3.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
		and target_3.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("mutex")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_3)
}

predicate func_4(Variable vret_153, IfStmt target_13, ReturnStmt target_14, Function func) {
	exists(IfStmt target_4 |
		target_4.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vret_153
		and target_4.getThen().(ReturnStmt).getExpr().(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_13.getCondition().(VariableAccess).getLocation().isBefore(target_4.getCondition().(NotExpr).getOperand().(VariableAccess).getLocation())
		and target_4.getCondition().(NotExpr).getOperand().(VariableAccess).getLocation().isBefore(target_14.getExpr().(VariableAccess).getLocation()))
}

predicate func_5(Variable vtty_154, ExprStmt target_11, Function func) {
	exists(ExprStmt target_5 |
		target_5.getExpr().(FunctionCall).getTarget().hasName("tty_lock")
		and target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtty_154
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_6(Variable vtty_154, Function func) {
	exists(IfStmt target_6 |
		target_6.getCondition().(PointerFieldAccess).getTarget().getName()="close"
		and target_6.getCondition().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
		and target_6.getCondition().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtty_154
		and target_6.getThen().(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getTarget().getName()="close"
		and target_6.getThen().(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="ops"
		and target_6.getThen().(ExprStmt).getExpr().(VariableCall).getExpr().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vtty_154
		and target_6.getThen().(ExprStmt).getExpr().(VariableCall).getArgument(0).(VariableAccess).getTarget()=vtty_154
		and target_6.getThen().(ExprStmt).getExpr().(VariableCall).getArgument(1).(Literal).getValue()="0"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6)
}

predicate func_8(Variable vtty_154, Function func) {
	exists(ExprStmt target_8 |
		target_8.getExpr().(FunctionCall).getTarget().hasName("tty_kclose")
		and target_8.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtty_154
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_8)
}

predicate func_9(VariableAccess target_12, Function func, ExprStmt target_9) {
		target_9.getExpr().(FunctionCall).getTarget().hasName("printk")
		and target_9.getExpr().(FunctionCall).getArgument(0).(StringLiteral).getValue()="3speakup: Failed to set N_SPEAKUP on tty\n"
		and target_9.getParent().(IfStmt).getCondition()=target_12
		and target_9.getEnclosingFunction() = func
}

predicate func_10(Variable vtty_154, Function func, ExprStmt target_10) {
		target_10.getExpr().(FunctionCall).getTarget().hasName("tty_unlock")
		and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtty_154
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vret_153, Variable vtty_154, ExprStmt target_11) {
		target_11.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_153
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("tty_set_ldisc")
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtty_154
		and target_11.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="26"
}

predicate func_12(Variable vret_153, ExprStmt target_9, VariableAccess target_12) {
		target_12.getTarget()=vret_153
		and target_12.getParent().(IfStmt).getThen()=target_9
}

predicate func_13(Variable vret_153, IfStmt target_13) {
		target_13.getCondition().(VariableAccess).getTarget()=vret_153
		and target_13.getThen() instanceof ExprStmt
}

predicate func_14(Variable vret_153, Function func, ReturnStmt target_14) {
		target_14.getExpr().(VariableAccess).getTarget()=vret_153
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

from Function func, Variable vret_153, Variable vtty_154, ExprStmt target_9, ExprStmt target_10, ExprStmt target_11, VariableAccess target_12, IfStmt target_13, ReturnStmt target_14
where
not func_0(func)
and not func_1(vtty_154, target_10, target_11, func)
and not func_2(target_12, func)
and not func_3(func)
and not func_4(vret_153, target_13, target_14, func)
and not func_5(vtty_154, target_11, func)
and not func_6(vtty_154, func)
and not func_8(vtty_154, func)
and func_9(target_12, func, target_9)
and func_10(vtty_154, func, target_10)
and func_11(vret_153, vtty_154, target_11)
and func_12(vret_153, target_9, target_12)
and func_13(vret_153, target_13)
and func_14(vret_153, func, target_14)
and vret_153.getType().hasName("int")
and vtty_154.getType().hasName("tty_struct *")
and vret_153.(LocalVariable).getFunction() = func
and vtty_154.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
