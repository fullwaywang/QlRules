/**
 * @name linux-12ca6ad2e3a896256f086497a7c7406a547ee373-perf_swevent_add
 * @id cpp/linux/12ca6ad2e3a896256f086497a7c7406a547ee373/perf-swevent-add
 * @description linux-12ca6ad2e3a896256f086497a7c7406a547ee373-kernel/events/core.c-perf_swevent_add CVE-2015-8963
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable v__ret_warn_once_6756, ExprStmt target_0) {
		target_0.getExpr().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_0.getExpr().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(VariableAccess).getTarget()=v__ret_warn_once_6756
		and target_0.getExpr().(FunctionCall).getArgument(1).(Literal).getValue()="0"
}

predicate func_1(Variable vhead_6741, BlockStmt target_6, NotExpr target_1) {
		target_1.getOperand().(VariableAccess).getTarget()=vhead_6741
		and target_1.getParent().(IfStmt).getThen()=target_6
}

predicate func_3(NotExpr target_1, Function func, ReturnStmt target_3) {
		target_3.getExpr().(UnaryMinusExpr).getValue()="-22"
		and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
		and target_3.getEnclosingFunction() = func
}

predicate func_4(NotExpr target_1, Function func, ExprStmt target_4) {
		target_4.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_4.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(FunctionCall).getArgument(1).(Literal).getValue()="0"
		and target_4.getExpr().(StmtExpr).getStmt().(BlockStmt).getStmt(3) instanceof ExprStmt
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_1
		and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vswhash_6739, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="online"
		and target_5.getQualifier().(VariableAccess).getTarget()=vswhash_6739
}

predicate func_6(Function func, BlockStmt target_6) {
		target_6.getStmt(0) instanceof ExprStmt
		and target_6.getStmt(1) instanceof ReturnStmt
		and target_6.getEnclosingFunction() = func
}

from Function func, Variable vhead_6741, Variable v__ret_warn_once_6756, Variable vswhash_6739, ExprStmt target_0, NotExpr target_1, ReturnStmt target_3, ExprStmt target_4, PointerFieldAccess target_5, BlockStmt target_6
where
func_0(v__ret_warn_once_6756, target_0)
and func_1(vhead_6741, target_6, target_1)
and func_3(target_1, func, target_3)
and func_4(target_1, func, target_4)
and func_5(vswhash_6739, target_5)
and func_6(func, target_6)
and vhead_6741.getType().hasName("hlist_head *")
and v__ret_warn_once_6756.getType().hasName("int")
and vswhash_6739.getType().hasName("swevent_htable *")
and vhead_6741.(LocalVariable).getFunction() = func
and v__ret_warn_once_6756.(LocalVariable).getFunction() = func
and vswhash_6739.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
