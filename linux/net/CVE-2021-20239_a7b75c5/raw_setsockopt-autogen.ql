/**
 * @name linux-a7b75c5a8c41445f33efb663887ff5f5c3b4454b-raw_setsockopt
 * @id cpp/linux/a7b75c5a8c41445f33efb663887ff5f5c3b4454b/raw-setsockopt
 * @description linux-a7b75c5a8c41445f33efb663887ff5f5c3b4454b-net/can/raw.c-raw_setsockopt CVE-2021-20239
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter voptval_488, Parameter voptlen_488, FunctionCall target_0) {
	target_0.getTarget().hasName("memdup_user")
	and not target_0.getTarget().hasName("memdup_sockptr")
	and target_0.getArgument(0).(VariableAccess).getTarget()=voptval_488
	and target_0.getArgument(1).(VariableAccess).getTarget()=voptlen_488
	and target_0.getParent().(AssignExpr).getRValue() = target_0
	and target_0.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("can_filter *")
}

predicate func_2(Parameter voptval_488, ReturnStmt target_26, FunctionCall target_20) {
exists(FunctionCall target_2 |
	target_2.getTarget().hasName("copy_from_sockptr")
	and target_2.getArgument(0) instanceof AddressOfExpr
	and target_2.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_2.getArgument(2) instanceof SizeofExprOperator
	and target_2.getParent().(IfStmt).getThen()=target_26
	and target_2.getArgument(1).(VariableAccess).getLocation().isBefore(target_20.getArgument(1).(VariableAccess).getLocation()))
}

predicate func_3(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_28, FunctionCall target_20, FunctionCall target_21, EqualityOperation target_29) {
exists(FunctionCall target_3 |
	target_3.getTarget().hasName("copy_from_sockptr")
	and target_3.getArgument(0) instanceof AddressOfExpr
	and target_3.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_3.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_3.getParent().(IfStmt).getThen()=target_28
	and target_20.getArgument(1).(VariableAccess).getLocation().isBefore(target_3.getArgument(1).(VariableAccess).getLocation())
	and target_3.getArgument(1).(VariableAccess).getLocation().isBefore(target_21.getArgument(1).(VariableAccess).getLocation())
	and target_3.getArgument(2).(VariableAccess).getLocation().isBefore(target_29.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_4(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_30, FunctionCall target_21, FunctionCall target_22, EqualityOperation target_31) {
exists(FunctionCall target_4 |
	target_4.getTarget().hasName("copy_from_sockptr")
	and target_4.getArgument(0) instanceof AddressOfExpr
	and target_4.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_4.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_4.getParent().(IfStmt).getThen()=target_30
	and target_21.getArgument(1).(VariableAccess).getLocation().isBefore(target_4.getArgument(1).(VariableAccess).getLocation())
	and target_4.getArgument(1).(VariableAccess).getLocation().isBefore(target_22.getArgument(1).(VariableAccess).getLocation())
	and target_4.getArgument(2).(VariableAccess).getLocation().isBefore(target_31.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_5(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_32, FunctionCall target_22, FunctionCall target_23, EqualityOperation target_33) {
exists(FunctionCall target_5 |
	target_5.getTarget().hasName("copy_from_sockptr")
	and target_5.getArgument(0) instanceof AddressOfExpr
	and target_5.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_5.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_5.getParent().(IfStmt).getThen()=target_32
	and target_22.getArgument(1).(VariableAccess).getLocation().isBefore(target_5.getArgument(1).(VariableAccess).getLocation())
	and target_5.getArgument(1).(VariableAccess).getLocation().isBefore(target_23.getArgument(1).(VariableAccess).getLocation())
	and target_5.getArgument(2).(VariableAccess).getLocation().isBefore(target_33.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_6(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_34, FunctionCall target_23, FunctionCall target_24, EqualityOperation target_35) {
exists(FunctionCall target_6 |
	target_6.getTarget().hasName("copy_from_sockptr")
	and target_6.getArgument(0) instanceof AddressOfExpr
	and target_6.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_6.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_6.getParent().(IfStmt).getThen()=target_34
	and target_23.getArgument(1).(VariableAccess).getLocation().isBefore(target_6.getArgument(1).(VariableAccess).getLocation())
	and target_6.getArgument(1).(VariableAccess).getLocation().isBefore(target_24.getArgument(1).(VariableAccess).getLocation())
	and target_6.getArgument(2).(VariableAccess).getLocation().isBefore(target_35.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_7(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_36, FunctionCall target_24, FunctionCall target_25) {
exists(FunctionCall target_7 |
	target_7.getTarget().hasName("copy_from_sockptr")
	and target_7.getArgument(0) instanceof AddressOfExpr
	and target_7.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_7.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_7.getParent().(IfStmt).getThen()=target_36
	and target_24.getArgument(1).(VariableAccess).getLocation().isBefore(target_7.getArgument(1).(VariableAccess).getLocation())
	and target_7.getArgument(1).(VariableAccess).getLocation().isBefore(target_25.getArgument(1).(VariableAccess).getLocation()))
}

predicate func_8(Variable vsfilter_493, Parameter voptval_488, ReturnStmt target_26, AddressOfExpr target_8) {
	target_8.getOperand().(VariableAccess).getTarget()=vsfilter_493
	and target_8.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_8.getParent().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
	and target_8.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_26
}

/*predicate func_9(Function func, SizeofExprOperator target_9) {
	target_9.getValue()="8"
	and target_9.getEnclosingFunction() = func
}

*/
predicate func_10(Parameter voptval_488, Parameter voptlen_488, Variable verr_mask_495, ReturnStmt target_28, AddressOfExpr target_10) {
	target_10.getOperand().(VariableAccess).getTarget()=verr_mask_495
	and target_10.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_10.getParent().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_10.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_28
}

predicate func_11(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_30, AddressOfExpr target_11) {
	target_11.getOperand().(PointerFieldAccess).getTarget().getName()="loopback"
	and target_11.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_11.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_11.getParent().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_11.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_30
}

predicate func_12(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_32, AddressOfExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="recv_own_msgs"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_12.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_12.getParent().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_12.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_32
}

predicate func_13(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_34, AddressOfExpr target_13) {
	target_13.getOperand().(PointerFieldAccess).getTarget().getName()="fd_frames"
	and target_13.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_13.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_13.getParent().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_13.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_34
}

predicate func_14(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_36, AddressOfExpr target_14) {
	target_14.getOperand().(PointerFieldAccess).getTarget().getName()="join_filters"
	and target_14.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_14.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_14.getParent().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_14.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_36
}

/*predicate func_15(Parameter voptval_488, Parameter voptlen_488, Variable verr_mask_495, ReturnStmt target_28, VariableAccess target_15) {
	target_15.getTarget()=voptlen_488
	and target_15.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=verr_mask_495
	and target_15.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_15.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_28
}

*/
/*predicate func_16(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_30, VariableAccess target_16) {
	target_16.getTarget()=voptlen_488
	and target_16.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="loopback"
	and target_16.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_16.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_16.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_30
}

*/
/*predicate func_17(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_32, VariableAccess target_17) {
	target_17.getTarget()=voptlen_488
	and target_17.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="recv_own_msgs"
	and target_17.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_17.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_17.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_32
}

*/
/*predicate func_18(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_34, VariableAccess target_18) {
	target_18.getTarget()=voptlen_488
	and target_18.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="fd_frames"
	and target_18.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_18.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_18.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_34
}

*/
/*predicate func_19(Parameter voptval_488, Parameter voptlen_488, Variable vro_491, ReturnStmt target_36, VariableAccess target_19) {
	target_19.getTarget()=voptlen_488
	and target_19.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="join_filters"
	and target_19.getParent().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vro_491
	and target_19.getParent().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_19.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_36
}

*/
predicate func_20(Parameter voptval_488, ReturnStmt target_26, FunctionCall target_20) {
	target_20.getTarget().hasName("copy_from_user")
	and target_20.getArgument(0) instanceof AddressOfExpr
	and target_20.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_20.getArgument(2) instanceof SizeofExprOperator
	and target_20.getParent().(IfStmt).getThen()=target_26
}

predicate func_21(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_28, FunctionCall target_21) {
	target_21.getTarget().hasName("copy_from_user")
	and target_21.getArgument(0) instanceof AddressOfExpr
	and target_21.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_21.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_21.getParent().(IfStmt).getThen()=target_28
}

predicate func_22(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_30, FunctionCall target_22) {
	target_22.getTarget().hasName("copy_from_user")
	and target_22.getArgument(0) instanceof AddressOfExpr
	and target_22.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_22.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_22.getParent().(IfStmt).getThen()=target_30
}

predicate func_23(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_32, FunctionCall target_23) {
	target_23.getTarget().hasName("copy_from_user")
	and target_23.getArgument(0) instanceof AddressOfExpr
	and target_23.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_23.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_23.getParent().(IfStmt).getThen()=target_32
}

predicate func_24(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_34, FunctionCall target_24) {
	target_24.getTarget().hasName("copy_from_user")
	and target_24.getArgument(0) instanceof AddressOfExpr
	and target_24.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_24.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_24.getParent().(IfStmt).getThen()=target_34
}

predicate func_25(Parameter voptval_488, Parameter voptlen_488, ReturnStmt target_36, FunctionCall target_25) {
	target_25.getTarget().hasName("copy_from_user")
	and target_25.getArgument(0) instanceof AddressOfExpr
	and target_25.getArgument(1).(VariableAccess).getTarget()=voptval_488
	and target_25.getArgument(2).(VariableAccess).getTarget()=voptlen_488
	and target_25.getParent().(IfStmt).getThen()=target_36
}

predicate func_26(FunctionCall target_20, Function func, ReturnStmt target_26) {
	target_26.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_26.getParent().(IfStmt).getCondition()=target_20
	and target_26.getEnclosingFunction() = func
}

predicate func_28(FunctionCall target_21, Function func, ReturnStmt target_28) {
	target_28.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_28.getParent().(IfStmt).getCondition()=target_21
	and target_28.getEnclosingFunction() = func
}

predicate func_29(Parameter voptlen_488, EqualityOperation target_29) {
	target_29.getLeftOperand().(VariableAccess).getTarget()=voptlen_488
	and target_29.getRightOperand().(SizeofExprOperator).getValue()="4"
}

predicate func_30(FunctionCall target_22, Function func, ReturnStmt target_30) {
	target_30.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_30.getParent().(IfStmt).getCondition()=target_22
	and target_30.getEnclosingFunction() = func
}

predicate func_31(Parameter voptlen_488, EqualityOperation target_31) {
	target_31.getLeftOperand().(VariableAccess).getTarget()=voptlen_488
	and target_31.getRightOperand().(SizeofExprOperator).getValue()="4"
}

predicate func_32(FunctionCall target_23, Function func, ReturnStmt target_32) {
	target_32.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_32.getParent().(IfStmt).getCondition()=target_23
	and target_32.getEnclosingFunction() = func
}

predicate func_33(Parameter voptlen_488, EqualityOperation target_33) {
	target_33.getLeftOperand().(VariableAccess).getTarget()=voptlen_488
	and target_33.getRightOperand().(SizeofExprOperator).getValue()="4"
}

predicate func_34(FunctionCall target_24, Function func, ReturnStmt target_34) {
	target_34.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_34.getParent().(IfStmt).getCondition()=target_24
	and target_34.getEnclosingFunction() = func
}

predicate func_35(Parameter voptlen_488, EqualityOperation target_35) {
	target_35.getLeftOperand().(VariableAccess).getTarget()=voptlen_488
	and target_35.getRightOperand().(SizeofExprOperator).getValue()="4"
}

predicate func_36(FunctionCall target_25, Function func, ReturnStmt target_36) {
	target_36.getExpr().(UnaryMinusExpr).getValue()="-14"
	and target_36.getParent().(IfStmt).getCondition()=target_25
	and target_36.getEnclosingFunction() = func
}

from Function func, Variable vsfilter_493, Parameter voptval_488, Parameter voptlen_488, Variable vro_491, Variable verr_mask_495, FunctionCall target_0, AddressOfExpr target_8, AddressOfExpr target_10, AddressOfExpr target_11, AddressOfExpr target_12, AddressOfExpr target_13, AddressOfExpr target_14, FunctionCall target_20, FunctionCall target_21, FunctionCall target_22, FunctionCall target_23, FunctionCall target_24, FunctionCall target_25, ReturnStmt target_26, ReturnStmt target_28, EqualityOperation target_29, ReturnStmt target_30, EqualityOperation target_31, ReturnStmt target_32, EqualityOperation target_33, ReturnStmt target_34, EqualityOperation target_35, ReturnStmt target_36
where
func_0(voptval_488, voptlen_488, target_0)
and not func_2(voptval_488, target_26, target_20)
and not func_3(voptval_488, voptlen_488, target_28, target_20, target_21, target_29)
and not func_4(voptval_488, voptlen_488, target_30, target_21, target_22, target_31)
and not func_5(voptval_488, voptlen_488, target_32, target_22, target_23, target_33)
and not func_6(voptval_488, voptlen_488, target_34, target_23, target_24, target_35)
and not func_7(voptval_488, voptlen_488, target_36, target_24, target_25)
and func_8(vsfilter_493, voptval_488, target_26, target_8)
and func_10(voptval_488, voptlen_488, verr_mask_495, target_28, target_10)
and func_11(voptval_488, voptlen_488, vro_491, target_30, target_11)
and func_12(voptval_488, voptlen_488, vro_491, target_32, target_12)
and func_13(voptval_488, voptlen_488, vro_491, target_34, target_13)
and func_14(voptval_488, voptlen_488, vro_491, target_36, target_14)
and func_20(voptval_488, target_26, target_20)
and func_21(voptval_488, voptlen_488, target_28, target_21)
and func_22(voptval_488, voptlen_488, target_30, target_22)
and func_23(voptval_488, voptlen_488, target_32, target_23)
and func_24(voptval_488, voptlen_488, target_34, target_24)
and func_25(voptval_488, voptlen_488, target_36, target_25)
and func_26(target_20, func, target_26)
and func_28(target_21, func, target_28)
and func_29(voptlen_488, target_29)
and func_30(target_22, func, target_30)
and func_31(voptlen_488, target_31)
and func_32(target_23, func, target_32)
and func_33(voptlen_488, target_33)
and func_34(target_24, func, target_34)
and func_35(voptlen_488, target_35)
and func_36(target_25, func, target_36)
and vsfilter_493.getType().hasName("can_filter")
and voptval_488.getType().hasName("char *")
and voptlen_488.getType().hasName("unsigned int")
and vro_491.getType().hasName("raw_sock *")
and verr_mask_495.getType().hasName("can_err_mask_t")
and vsfilter_493.(LocalVariable).getFunction() = func
and voptval_488.getFunction() = func
and voptlen_488.getFunction() = func
and vro_491.(LocalVariable).getFunction() = func
and verr_mask_495.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
