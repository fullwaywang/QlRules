/**
 * @name linux-f1e255d60ae66a9f672ff9a207ee6cd8e33d2679-yurex_read
 * @id cpp/linux/f1e255d60ae66a9f672ff9a207ee6cd8e33d2679/yurex-read
 * @description linux-f1e255d60ae66a9f672ff9a207ee6cd8e33d2679-drivers/usb/misc/yurex.c-yurex_read CVE-2018-16276
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Initializer target_0) {
		target_0.getExpr().(Literal).getValue()="0"
		and target_0.getExpr().getEnclosingFunction() = func
}

predicate func_1(Variable vin_buffer_401, Variable vdev_398, Variable vbytes_read_400, VariableAccess target_1) {
		target_1.getTarget()=vbytes_read_400
		and target_1.getParent().(AssignExpr).getLValue() = target_1
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("snprintf")
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vin_buffer_401
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="20"
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%lld\n"
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="bbu"
		and target_1.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
}

predicate func_2(Variable vbytes_read_400, BlockStmt target_18, VariableAccess target_2) {
		target_2.getTarget()=vbytes_read_400
		and target_2.getParent().(LTExpr).getLesserOperand() instanceof PointerDereferenceExpr
		and target_2.getParent().(LTExpr).getParent().(IfStmt).getThen()=target_18
}

predicate func_3(Variable vdev_398, NotExpr target_19, AddressOfExpr target_20) {
	exists(FunctionCall target_3 |
		target_3.getTarget().hasName("mutex_unlock")
		and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="io_mutex"
		and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
		and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_3.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Variable vin_buffer_401, Parameter vcount_395, Parameter vppos_396, Parameter vbuffer_395, ExprStmt target_21, Function func) {
	exists(ReturnStmt target_4 |
		target_4.getExpr().(FunctionCall).getTarget().hasName("simple_read_from_buffer")
		and target_4.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_395
		and target_4.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vcount_395
		and target_4.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vppos_396
		and target_4.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vin_buffer_401
		and target_4.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getType().hasName("int")
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_4.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

predicate func_5(Variable vretval_399, UnaryMinusExpr target_5) {
		target_5.getValue()="-19"
		and target_5.getParent().(AssignExpr).getRValue() = target_5
		and target_5.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
}

predicate func_6(Variable vdev_398, Function func, ExprStmt target_6) {
		target_6.getExpr().(FunctionCall).getTarget().hasName("mutex_unlock")
		and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="io_mutex"
		and target_6.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Parameter vbuffer_395, ExprStmt target_23, VariableAccess target_7) {
		target_7.getTarget()=vbuffer_395
		and target_7.getParent().(FunctionCall).getArgument(1) instanceof PointerArithmeticOperation
		and target_7.getParent().(FunctionCall).getArgument(2) instanceof SubExpr
		and target_7.getParent().(FunctionCall).getParent().(IfStmt).getThen()=target_23
}

predicate func_8(Parameter vppos_396, VariableAccess target_8) {
		target_8.getTarget()=vppos_396
}

predicate func_9(Variable vin_buffer_401, VariableAccess target_9) {
		target_9.getTarget()=vin_buffer_401
		and target_9.getParent().(PointerAddExpr).getParent().(FunctionCall).getParent().(IfStmt).getCondition() instanceof FunctionCall
}

predicate func_10(Function func, DeclStmt target_10) {
		func.getEntryPoint().(BlockStmt).getAStmt()=target_10
}

predicate func_11(Variable vretval_399, AssignExpr target_11) {
		target_11.getLValue().(VariableAccess).getTarget()=vretval_399
		and target_11.getRValue() instanceof UnaryMinusExpr
}

predicate func_12(NotExpr target_19, Function func, GotoStmt target_12) {
		target_12.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_19
		and target_12.getEnclosingFunction() = func
}

predicate func_13(Variable vin_buffer_401, Parameter vppos_396, Variable vretval_399, Variable vbytes_read_400, Parameter vbuffer_395, Function func, IfStmt target_13) {
		target_13.getCondition().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_13.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget()=vbytes_read_400
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_395
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vin_buffer_401
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getAnOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vbytes_read_400
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2).(SubExpr).getRightOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-14"
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
		and target_13.getThen().(BlockStmt).getStmt(0).(IfStmt).getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vbytes_read_400
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_13
}

/*predicate func_14(Variable vin_buffer_401, Parameter vppos_396, Variable vretval_399, Variable vbytes_read_400, Parameter vbuffer_395, RelationalOperation target_24, IfStmt target_14) {
		target_14.getCondition().(FunctionCall).getTarget().hasName("copy_to_user")
		and target_14.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbuffer_395
		and target_14.getCondition().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vin_buffer_401
		and target_14.getCondition().(FunctionCall).getArgument(1).(PointerArithmeticOperation).getAnOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_14.getCondition().(FunctionCall).getArgument(2).(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vbytes_read_400
		and target_14.getCondition().(FunctionCall).getArgument(2).(SubExpr).getRightOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_14.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
		and target_14.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-14"
		and target_14.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
		and target_14.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vbytes_read_400
		and target_14.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_14.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_14.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vbytes_read_400
		and target_14.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_24
}

*/
/*predicate func_15(Parameter vppos_396, Variable vretval_399, Variable vbytes_read_400, FunctionCall target_25, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_399
		and target_15.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vbytes_read_400
		and target_15.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_15.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

*/
/*predicate func_16(Parameter vppos_396, Variable vbytes_read_400, FunctionCall target_25, ExprStmt target_16) {
		target_16.getExpr().(AssignAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vppos_396
		and target_16.getExpr().(AssignAddExpr).getRValue().(VariableAccess).getTarget()=vbytes_read_400
		and target_16.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_25
}

*/
predicate func_17(Variable vretval_399, VariableAccess target_17) {
		target_17.getTarget()=vretval_399
}

predicate func_18(Function func, BlockStmt target_18) {
		target_18.getStmt(0) instanceof IfStmt
		and target_18.getEnclosingFunction() = func
}

predicate func_19(Variable vdev_398, NotExpr target_19) {
		target_19.getOperand().(PointerFieldAccess).getTarget().getName()="interface"
		and target_19.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
}

predicate func_20(Variable vdev_398, AddressOfExpr target_20) {
		target_20.getOperand().(PointerFieldAccess).getTarget().getName()="lock"
		and target_20.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
		and target_20.getParent().(FunctionCall).getParent().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
}

predicate func_21(Variable vin_buffer_401, Variable vdev_398, Variable vbytes_read_400, ExprStmt target_21) {
		target_21.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbytes_read_400
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("snprintf")
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vin_buffer_401
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="20"
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(StringLiteral).getValue()="%lld\n"
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getTarget().getName()="bbu"
		and target_21.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdev_398
}

predicate func_23(Function func, ExprStmt target_23) {
		target_23.getExpr() instanceof AssignExpr
		and target_23.getEnclosingFunction() = func
}

predicate func_24(Variable vbytes_read_400, RelationalOperation target_24) {
		 (target_24 instanceof GTExpr or target_24 instanceof LTExpr)
		and target_24.getLesserOperand() instanceof PointerDereferenceExpr
		and target_24.getGreaterOperand().(VariableAccess).getTarget()=vbytes_read_400
}

predicate func_25(Parameter vbuffer_395, FunctionCall target_25) {
		target_25.getTarget().hasName("copy_to_user")
		and target_25.getArgument(0).(VariableAccess).getTarget()=vbuffer_395
		and target_25.getArgument(1) instanceof PointerArithmeticOperation
		and target_25.getArgument(2) instanceof SubExpr
}

from Function func, Variable vin_buffer_401, Parameter vcount_395, Parameter vppos_396, Variable vdev_398, Variable vretval_399, Variable vbytes_read_400, Parameter vbuffer_395, Initializer target_0, VariableAccess target_1, VariableAccess target_2, UnaryMinusExpr target_5, ExprStmt target_6, VariableAccess target_7, VariableAccess target_8, VariableAccess target_9, DeclStmt target_10, AssignExpr target_11, GotoStmt target_12, IfStmt target_13, VariableAccess target_17, BlockStmt target_18, NotExpr target_19, AddressOfExpr target_20, ExprStmt target_21, ExprStmt target_23, RelationalOperation target_24, FunctionCall target_25
where
func_0(func, target_0)
and func_1(vin_buffer_401, vdev_398, vbytes_read_400, target_1)
and func_2(vbytes_read_400, target_18, target_2)
and not func_3(vdev_398, target_19, target_20)
and not func_4(vin_buffer_401, vcount_395, vppos_396, vbuffer_395, target_21, func)
and func_5(vretval_399, target_5)
and func_6(vdev_398, func, target_6)
and func_7(vbuffer_395, target_23, target_7)
and func_8(vppos_396, target_8)
and func_9(vin_buffer_401, target_9)
and func_10(func, target_10)
and func_11(vretval_399, target_11)
and func_12(target_19, func, target_12)
and func_13(vin_buffer_401, vppos_396, vretval_399, vbytes_read_400, vbuffer_395, func, target_13)
and func_17(vretval_399, target_17)
and func_18(func, target_18)
and func_19(vdev_398, target_19)
and func_20(vdev_398, target_20)
and func_21(vin_buffer_401, vdev_398, vbytes_read_400, target_21)
and func_23(func, target_23)
and func_24(vbytes_read_400, target_24)
and func_25(vbuffer_395, target_25)
and vin_buffer_401.getType().hasName("char[20]")
and vcount_395.getType().hasName("size_t")
and vppos_396.getType().hasName("loff_t *")
and vdev_398.getType().hasName("usb_yurex *")
and vretval_399.getType().hasName("int")
and vbytes_read_400.getType().hasName("int")
and vbuffer_395.getType().hasName("char *")
and vin_buffer_401.(LocalVariable).getFunction() = func
and vcount_395.getFunction() = func
and vppos_396.getFunction() = func
and vdev_398.(LocalVariable).getFunction() = func
and vretval_399.(LocalVariable).getFunction() = func
and vbytes_read_400.(LocalVariable).getFunction() = func
and vbuffer_395.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
