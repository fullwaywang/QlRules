/**
 * @name linux-6de426f9276c448e2db7238911c97fb157cb23be-debugfs_init_v3_hw
 * @id cpp/linux/6de426f9276c448e2db7238911c97fb157cb23be/debugfs-init-v3-hw
 * @description linux-6de426f9276c448e2db7238911c97fb157cb23be-drivers/scsi/hisi_sas/hisi_sas_v3_hw.c-debugfs_init_v3_hw CVE-2023-52808
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vhisi_hba_4868, FunctionCall target_0) {
	target_0.getTarget().hasName("debugfs_remove")
	and not target_0.getTarget().hasName("debugfs_exit_v3_hw")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="debugfs_dir"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhisi_hba_4868
}

predicate func_1(Parameter vhisi_hba_4868, VariableAccess target_1) {
	target_1.getTarget()=vhisi_hba_4868
	and target_1.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

from Function func, Parameter vhisi_hba_4868, FunctionCall target_0, VariableAccess target_1
where
func_0(vhisi_hba_4868, target_0)
and func_1(vhisi_hba_4868, target_1)
and vhisi_hba_4868.getType().hasName("hisi_hba *")
and vhisi_hba_4868.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
