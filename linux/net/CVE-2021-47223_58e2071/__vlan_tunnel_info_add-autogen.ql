/**
 * @name linux-58e2071742e38f29f051b709a5cca014ba51166f-__vlan_tunnel_info_add
 * @id cpp/linux/58e2071742e38f29f051b709a5cca014ba51166f/--vlan-tunnel-info-add
 * @description linux-58e2071742e38f29f051b709a5cca014ba51166f-net/bridge/br_vlan_tunnel.c-__vlan_tunnel_info_add CVE-2021-47223
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, FunctionCall target_0) {
	target_0.getTarget().hasName("dst_release")
	and not target_0.getTarget().hasName("lockdep_rcu_suspicious")
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dst"
	and target_0.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier() instanceof ValueFieldAccess
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func) {
exists(StmtExpr target_1 |
	target_1.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition() instanceof Literal
	and target_1.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr() instanceof ValueFieldAccess
	and target_1.getEnclosingFunction() = func)
}

/*predicate func_2(Function func) {
exists(AssignExpr target_2 |
	target_2.getLValue().(VariableAccess).getType().hasName("bool")
	and target_2.getEnclosingFunction() = func)
}

*/
predicate func_4(Variable vmetadata_59, ExprStmt target_25, Function func) {
exists(DoStmt target_4 |
	target_4.getCondition() instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("__builtin_constant_p")
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getLeftOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vmetadata_59
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("uintptr_t")
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand() instanceof Literal
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(DoStmt).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getElse().(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getElse().(DoStmt).getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_4.getStmt().(BlockStmt).getStmt(2).(IfStmt).getElse().(DoStmt).getStmt().(BlockStmt).getStmt(2).(DoStmt).getCondition().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
	and target_4.getLocation().isBefore(target_25.getLocation()))
}

/*predicate func_6(Parameter vvlan_57, Variable vmetadata_59, ExprStmt target_25) {
exists(PointerDereferenceExpr target_6 |
	target_6.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="tunnel_dst"
	and target_6.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_6.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
	and target_6.getParent().(AssignExpr).getLValue() = target_6
	and target_6.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vmetadata_59)
}

*/
/*predicate func_8(Parameter vvlan_57) {
exists(PointerDereferenceExpr target_8 |
	target_8.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="tunnel_dst"
	and target_8.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_8.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
	and target_8.getParent().(AssignExpr).getLValue() = target_8
	and target_8.getParent().(AssignExpr).getRValue() instanceof Literal)
}

*/
predicate func_10(Variable vkey_60, ExprStmt target_25, ExprStmt target_28, Function func) {
exists(DoStmt target_10 |
	target_10.getCondition().(Literal).getValue()="0"
	and target_10.getStmt().(BlockStmt).getStmt(0).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_10.getStmt().(BlockStmt).getStmt(0).(DoStmt).getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(NotExpr).getValue()="0"
	and target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vkey_60
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_10
	and target_10.getLocation().isBefore(target_25.getLocation())
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getLocation().isBefore(target_10.getStmt().(BlockStmt).getStmt(1).(DoStmt).getStmt().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getLocation()))
}

/*predicate func_11(Parameter vvlan_57, Variable vkey_60, ExprStmt target_25) {
exists(PointerDereferenceExpr target_11 |
	target_11.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="tunnel_id"
	and target_11.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_11.getOperand().(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
	and target_11.getParent().(AssignExpr).getLValue() = target_11
	and target_11.getParent().(AssignExpr).getRValue().(VariableAccess).getTarget()=vkey_60)
}

*/
predicate func_12(Parameter vvlan_57, AddressOfExpr target_30) {
exists(FunctionCall target_12 |
	target_12.getTarget().hasName("vlan_tunnel_info_release")
	and target_12.getArgument(0).(VariableAccess).getTarget()=vvlan_57
	and target_30.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_12.getArgument(0).(VariableAccess).getLocation()))
}

predicate func_13(Parameter vvlan_57, ValueFieldAccess target_13) {
	target_13.getTarget().getName()="tunnel_dst"
	and target_13.getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_13.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

/*predicate func_14(Parameter vvlan_57, ValueFieldAccess target_14) {
	target_14.getTarget().getName()="tunnel_dst"
	and target_14.getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_14.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

*/
predicate func_15(Parameter vvlan_57, ValueFieldAccess target_15) {
	target_15.getTarget().getName()="tunnel_id"
	and target_15.getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_15.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

predicate func_16(Parameter vvlan_57, PointerFieldAccess target_16) {
	target_16.getTarget().getName()="tinfo"
	and target_16.getQualifier().(VariableAccess).getTarget()=vvlan_57
	and target_16.getParent().(ValueFieldAccess).getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_17(Parameter vvlan_57, ValueFieldAccess target_17) {
	target_17.getTarget().getName()="tunnel_dst"
	and target_17.getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_17.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

predicate func_18(Parameter vvlan_57, ValueFieldAccess target_18) {
	target_18.getTarget().getName()="tunnel_id"
	and target_18.getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_18.getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

predicate func_20(Parameter vvlan_57, Variable vmetadata_59, VariableAccess target_20) {
	target_20.getTarget()=vmetadata_59
	and target_20.getParent().(AssignExpr).getRValue() = target_20
	and target_20.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="tunnel_dst"
	and target_20.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_20.getParent().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

predicate func_23(Parameter vvlan_57, PointerFieldAccess target_23) {
	target_23.getTarget().getName()="dst"
	and target_23.getQualifier().(ValueFieldAccess).getTarget().getName()="tunnel_dst"
	and target_23.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="tinfo"
	and target_23.getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

predicate func_24(Function func, AssignExpr target_24) {
	target_24.getLValue() instanceof ValueFieldAccess
	and target_24.getRValue() instanceof Literal
	and target_24.getEnclosingFunction() = func
}

predicate func_25(Variable vmetadata_59, ExprStmt target_25) {
	target_25.getExpr().(AssignExpr).getLValue() instanceof ValueFieldAccess
	and target_25.getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vmetadata_59
}

predicate func_28(Variable vmetadata_59, Variable vkey_60, ExprStmt target_28) {
	target_28.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vmetadata_59
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("__ip_tun_set_dst")
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(Literal).getValue()="0"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(Literal).getValue()="0"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(Literal).getValue()="0"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(Literal).getValue()="0"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(FunctionCall).getTarget().hasName("__builtin_bswap16")
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(FunctionCall).getValue()="1024"
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vkey_60
	and target_28.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(7).(Literal).getValue()="0"
}

predicate func_30(Parameter vvlan_57, AddressOfExpr target_30) {
	target_30.getOperand().(PointerFieldAccess).getTarget().getName()="tnode"
	and target_30.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vvlan_57
}

from Function func, Parameter vvlan_57, Variable vmetadata_59, Variable vkey_60, FunctionCall target_0, ValueFieldAccess target_13, ValueFieldAccess target_15, PointerFieldAccess target_16, ValueFieldAccess target_17, ValueFieldAccess target_18, VariableAccess target_20, PointerFieldAccess target_23, AssignExpr target_24, ExprStmt target_25, ExprStmt target_28, AddressOfExpr target_30
where
func_0(func, target_0)
and not func_1(func)
and not func_4(vmetadata_59, target_25, func)
and not func_10(vkey_60, target_25, target_28, func)
and not func_12(vvlan_57, target_30)
and func_13(vvlan_57, target_13)
and func_15(vvlan_57, target_15)
and func_16(vvlan_57, target_16)
and func_17(vvlan_57, target_17)
and func_18(vvlan_57, target_18)
and func_20(vvlan_57, vmetadata_59, target_20)
and func_23(vvlan_57, target_23)
and func_24(func, target_24)
and func_25(vmetadata_59, target_25)
and func_28(vmetadata_59, vkey_60, target_28)
and func_30(vvlan_57, target_30)
and vvlan_57.getType().hasName("net_bridge_vlan *")
and vmetadata_59.getType().hasName("metadata_dst *")
and vkey_60.getType().hasName("__be64")
and vvlan_57.getFunction() = func
and vmetadata_59.(LocalVariable).getFunction() = func
and vkey_60.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
