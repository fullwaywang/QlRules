/**
 * @name linux-da029c11e6b12f321f36dac8771e833b65cec962-get_arg_page
 * @id cpp/linux/da029c11e6b12f321f36dac8771e833b65cec962/get-arg-page
 * @description linux-da029c11e6b12f321f36dac8771e833b65cec962-fs/exec.c-get_arg_page CVE-2018-14634
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
		target_0.getValue()="1"
		and not target_0.getValue()="8"
		and target_0.getParent().(IfStmt).getParent().(BlockStmt).getStmt(1) instanceof IfStmt
		and target_0.getEnclosingFunction() = func
}

predicate func_1(Function func, Literal target_1) {
		target_1.getValue()="3"
		and not target_1.getValue()="1024"
		and target_1.getParent().(ArrayExpr).getParent().(ValueFieldAccess).getQualifier() instanceof ArrayExpr
		and target_1.getEnclosingFunction() = func
}

predicate func_2(Function func, Literal target_2) {
		target_2.getValue()="3"
		and not target_2.getValue()="1024"
		and target_2.getParent().(ArrayExpr).getParent().(ValueFieldAccess).getQualifier() instanceof ArrayExpr
		and target_2.getEnclosingFunction() = func
}

predicate func_4(Function func) {
	exists(AssignExpr target_4 |
		target_4.getLValue().(VariableAccess).getType().hasName("unsigned long")
		and target_4.getRValue().(MulExpr).getValue()="6291456"
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Function func) {
	exists(AssignExpr target_5 |
		target_5.getLValue().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(EqualityOperation).getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getThen().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(ConditionalExpr).getElse().(VariableAccess).getType().hasName("unsigned long")
		and target_5.getEnclosingFunction() = func)
}

predicate func_8(Function func) {
	exists(FunctionCall target_8 |
		target_8.getTarget().hasName("rlimit")
		and target_8.getArgument(0) instanceof Literal
		and target_8.getEnclosingFunction() = func)
}

/*predicate func_10(Function func) {
	exists(EqualityOperation target_10 |
		target_10.getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_10.getAnOperand().(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_10.getEnclosingFunction() = func)
}

*/
/*predicate func_11(Function func) {
	exists(ConditionalExpr target_11 |
		target_11.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_11.getCondition().(RelationalOperation).getGreaterOperand().(VariableAccess).getType().hasName("unsigned long")
		and target_11.getThen().(VariableAccess).getType().hasName("unsigned long")
		and target_11.getElse().(VariableAccess).getType().hasName("unsigned long")
		and target_11.getEnclosingFunction() = func)
}

*/
predicate func_17(Variable vrlim_224, AssignExpr target_17) {
		target_17.getLValue().(VariableAccess).getTarget()=vrlim_224
		and target_17.getRValue().(PointerFieldAccess).getTarget().getName()="rlim"
		and target_17.getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="signal"
		and target_17.getRValue().(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(FunctionCall).getTarget().hasName("get_current")
}

predicate func_18(Variable v__u_260, StmtExpr target_18) {
		target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition() instanceof Literal
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size")
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size_nocheck")
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_18.getStmt().(BlockStmt).getStmt(1).(IfStmt).getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_18.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getTarget().getName()="__val"
		and target_18.getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
}

predicate func_19(Function func, TypeDeclarationEntry target_19) {
		target_19.getType() instanceof LocalUnion
		and target_19.getDeclaration().getEnclosingFunction() = func
}

/*predicate func_21(Variable vrlim_224, Variable v__u_260, IfStmt target_21) {
		target_21.getCondition() instanceof Literal
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size")
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vrlim_224
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_21.getThen().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__read_once_size_nocheck")
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vrlim_224
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_21.getElse().(ExprStmt).getExpr().(FunctionCall).getArgument(2).(SizeofExprOperator).getValue()="8"
}

*/
/*predicate func_22(Variable vrlim_224, Variable v__u_260, FunctionCall target_22) {
		target_22.getTarget().hasName("__read_once_size")
		and target_22.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_22.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vrlim_224
		and target_22.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
		and target_22.getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_22.getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_22.getArgument(2).(SizeofExprOperator).getValue()="8"
}

*/
/*predicate func_23(Variable vrlim_224, Variable v__u_260, FunctionCall target_23) {
		target_23.getTarget().hasName("__read_once_size_nocheck")
		and target_23.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getTarget().getName()="rlim_cur"
		and target_23.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vrlim_224
		and target_23.getArgument(0).(AddressOfExpr).getOperand().(ValueFieldAccess).getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
		and target_23.getArgument(1).(ValueFieldAccess).getTarget().getName()="__c"
		and target_23.getArgument(1).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=v__u_260
		and target_23.getArgument(2).(SizeofExprOperator).getValue()="8"
}

*/
/*predicate func_24(Variable v__u_260, ValueFieldAccess target_24) {
		target_24.getTarget().getName()="__val"
		and target_24.getQualifier().(VariableAccess).getTarget()=v__u_260
}

*/
from Function func, Variable vrlim_224, Variable v__u_260, Literal target_0, Literal target_1, Literal target_2, AssignExpr target_17, StmtExpr target_18, TypeDeclarationEntry target_19
where
func_0(func, target_0)
and func_1(func, target_1)
and func_2(func, target_2)
and not func_4(func)
and not func_5(func)
and not func_8(func)
and func_17(vrlim_224, target_17)
and func_18(v__u_260, target_18)
and func_19(func, target_19)
and vrlim_224.getType().hasName("rlimit *")
and v__u_260.getType().hasName("union <unnamed>")
and vrlim_224.(LocalVariable).getFunction() = func
and v__u_260.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
