/**
 * @name linux-0fb6bd06e06792469acc15bbe427361b56ada528-lg2ff_init
 * @id cpp/linux/0fb6bd06e06792469acc15bbe427361b56ada528/lg2ff-init
 * @description linux-0fb6bd06e06792469acc15bbe427361b56ada528-drivers/hid/hid-lg2ff.c-lg2ff_init CVE-2013-2893
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func, Literal target_0) {
	target_0.getValue()="1"
	and not target_0.getValue()="0"
	and target_0.getParent().(LTExpr).getParent().(IfStmt).getCondition() instanceof RelationalOperation
	and target_0.getEnclosingFunction() = func
}

predicate func_1(Variable vreport_64, Parameter vhid_61, AddressOfExpr target_24) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("hid_validate_values")
	and target_1.getArgument(0).(VariableAccess).getTarget()=vhid_61
	and target_1.getArgument(1) instanceof Literal
	and target_1.getArgument(2) instanceof Literal
	and target_1.getArgument(3).(Literal).getValue()="0"
	and target_1.getArgument(4) instanceof Literal
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreport_64
	and target_1.getArgument(0).(VariableAccess).getLocation().isBefore(target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vreport_64, BlockStmt target_25) {
exists(NotExpr target_2 |
	target_2.getOperand().(VariableAccess).getTarget()=vreport_64
	and target_2.getParent().(IfStmt).getThen()=target_25)
}

predicate func_3(Parameter vhid_61, PointerFieldAccess target_3) {
	target_3.getTarget().getName()="dev"
	and target_3.getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_3.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_4(Variable vreport_64, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="field"
	and target_4.getQualifier().(VariableAccess).getTarget()=vreport_64
	and target_4.getParent().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
}

predicate func_5(FunctionCall target_12, Function func, ReturnStmt target_5) {
	target_5.getExpr().(UnaryMinusExpr).getValue()="-19"
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_12
	and target_5.getEnclosingFunction() = func
}

predicate func_6(Parameter vhid_61, VariableAccess target_6) {
	target_6.getTarget()=vhid_61
}

predicate func_8(Variable vreport_64, VariableAccess target_8) {
	target_8.getTarget()=vreport_64
}

predicate func_11(Function func, DeclStmt target_11) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_11
}

predicate func_12(Variable vreport_list_67, BlockStmt target_25, FunctionCall target_12) {
	target_12.getTarget().hasName("list_empty")
	and target_12.getArgument(0).(VariableAccess).getTarget()=vreport_list_67
	and target_12.getParent().(IfStmt).getThen()=target_25
}

predicate func_13(Parameter vhid_61, FunctionCall target_13) {
	target_13.getTarget().hasName("dev_err")
	and target_13.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_13.getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_13.getArgument(1).(StringLiteral).getValue()="no output report found\n"
}

predicate func_14(Variable vreport_64, Variable v__mptr_77, Function func, ExprStmt target_14) {
	target_14.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreport_64
	and target_14.getExpr().(AssignExpr).getRValue().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_77
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_14
}

/*predicate func_15(Variable vreport_64, Variable v__mptr_77, StmtExpr target_15) {
	target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_77
	and target_15.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
	and target_15.getParent().(AssignExpr).getRValue() = target_15
	and target_15.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vreport_64
}

*/
/*predicate func_17(Variable v__mptr_77, ExprStmt target_17) {
	target_17.getExpr().(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=v__mptr_77
	and target_17.getExpr().(PointerArithmeticOperation).getRightOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="0"
}

*/
predicate func_18(Variable vreport_64, Parameter vhid_61, Function func, IfStmt target_18) {
	target_18.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="maxfield"
	and target_18.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreport_64
	and target_18.getCondition().(RelationalOperation).getGreaterOperand() instanceof Literal
	and target_18.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_18.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_18.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_18.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="output report is empty\n"
	and target_18.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-19"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_18
}

/*predicate func_19(Parameter vhid_61, RelationalOperation target_27, ExprStmt target_19) {
	target_19.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_19.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_19.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="output report is empty\n"
	and target_19.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
}

*/
/*predicate func_20(RelationalOperation target_27, Function func, ReturnStmt target_20) {
	target_20.getExpr().(UnaryMinusExpr).getValue()="-19"
	and target_20.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_27
	and target_20.getEnclosingFunction() = func
}

*/
predicate func_21(Variable vreport_64, Parameter vhid_61, Function func, IfStmt target_21) {
	target_21.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="report_count"
	and target_21.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="field"
	and target_21.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreport_64
	and target_21.getCondition().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(ArrayExpr).getArrayOffset() instanceof Literal
	and target_21.getCondition().(RelationalOperation).getGreaterOperand() instanceof Literal
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_21.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="not enough values in the field\n"
	and target_21.getThen().(BlockStmt).getStmt(1).(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-19"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

/*predicate func_22(Parameter vhid_61, RelationalOperation target_28, ExprStmt target_22) {
	target_22.getExpr().(FunctionCall).getTarget().hasName("dev_err")
	and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_22.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_22.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="not enough values in the field\n"
	and target_22.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_28
}

*/
/*predicate func_23(RelationalOperation target_28, Function func, ReturnStmt target_23) {
	target_23.getExpr().(UnaryMinusExpr).getValue()="-19"
	and target_23.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_28
	and target_23.getEnclosingFunction() = func
}

*/
predicate func_24(Parameter vhid_61, AddressOfExpr target_24) {
	target_24.getOperand().(PointerFieldAccess).getTarget().getName()="dev"
	and target_24.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhid_61
	and target_24.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_25(Function func, BlockStmt target_25) {
	target_25.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
	and target_25.getStmt(1) instanceof ReturnStmt
	and target_25.getEnclosingFunction() = func
}

predicate func_27(Variable vreport_64, RelationalOperation target_27) {
	 (target_27 instanceof GTExpr or target_27 instanceof LTExpr)
	and target_27.getLesserOperand().(PointerFieldAccess).getTarget().getName()="maxfield"
	and target_27.getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vreport_64
	and target_27.getGreaterOperand() instanceof Literal
}

predicate func_28(Function func, RelationalOperation target_28) {
	 (target_28 instanceof GTExpr or target_28 instanceof LTExpr)
	and target_28.getLesserOperand().(PointerFieldAccess).getTarget().getName()="report_count"
	and target_28.getLesserOperand().(PointerFieldAccess).getQualifier() instanceof ArrayExpr
	and target_28.getGreaterOperand() instanceof Literal
	and target_28.getEnclosingFunction() = func
}

from Function func, Variable vreport_64, Variable vreport_list_67, Variable v__mptr_77, Parameter vhid_61, Literal target_0, PointerFieldAccess target_3, PointerFieldAccess target_4, ReturnStmt target_5, VariableAccess target_6, VariableAccess target_8, DeclStmt target_11, FunctionCall target_12, FunctionCall target_13, ExprStmt target_14, IfStmt target_18, IfStmt target_21, AddressOfExpr target_24, BlockStmt target_25, RelationalOperation target_27, RelationalOperation target_28
where
func_0(func, target_0)
and not func_1(vreport_64, vhid_61, target_24)
and not func_2(vreport_64, target_25)
and func_3(vhid_61, target_3)
and func_4(vreport_64, target_4)
and func_5(target_12, func, target_5)
and func_6(vhid_61, target_6)
and func_8(vreport_64, target_8)
and func_11(func, target_11)
and func_12(vreport_list_67, target_25, target_12)
and func_13(vhid_61, target_13)
and func_14(vreport_64, v__mptr_77, func, target_14)
and func_18(vreport_64, vhid_61, func, target_18)
and func_21(vreport_64, vhid_61, func, target_21)
and func_24(vhid_61, target_24)
and func_25(func, target_25)
and func_27(vreport_64, target_27)
and func_28(func, target_28)
and vreport_64.getType().hasName("hid_report *")
and vreport_list_67.getType().hasName("list_head *")
and v__mptr_77.getType().hasName("const list_head *")
and vhid_61.getType().hasName("hid_device *")
and vreport_64.(LocalVariable).getFunction() = func
and vreport_list_67.(LocalVariable).getFunction() = func
and v__mptr_77.(LocalVariable).getFunction() = func
and vhid_61.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
