/**
 * @name linux-467324bcfe1a31ec65d0cf4aa59421d6b7a7d52b-ax25_kill_by_device
 * @id cpp/linux/467324bcfe1a31ec65d0cf4aa59421d6b7a7d52b/ax25-kill-by-device
 * @description linux-467324bcfe1a31ec65d0cf4aa59421d6b7a7d52b-net/ax25/af_ax25.c-ax25_kill_by_device CVE-2024-36009
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable vax25_dev_78, ExprStmt target_2, ExprStmt target_3, VariableAccess target_1) {
	target_1.getTarget()=vax25_dev_78
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("netdev_put")
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_dev_78
	and target_1.getParent().(PointerFieldAccess).getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev_tracker"
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getLocation())
	and target_1.getLocation().isBefore(target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
}

predicate func_2(Variable vax25_dev_78, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("netdev_put")
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_dev_78
	and target_2.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="dev_tracker"
	and target_2.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vax25_dev_78
}

predicate func_3(Variable vax25_dev_78, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("ax25_dev_put")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vax25_dev_78
}

from Function func, Variable vax25_dev_78, VariableAccess target_1, ExprStmt target_2, ExprStmt target_3
where
func_1(vax25_dev_78, target_2, target_3, target_1)
and func_2(vax25_dev_78, target_2)
and func_3(vax25_dev_78, target_3)
and vax25_dev_78.getType().hasName("ax25_dev *")
and vax25_dev_78.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
