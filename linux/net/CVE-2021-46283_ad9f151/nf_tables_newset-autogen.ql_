/**
 * @name linux-ad9f151e560b016b6ad3280b48e42fa11e1a5440-nf_tables_newset
 * @id cpp/linux/ad9f151e560b016b6ad3280b48e42fa11e1a5440/nf-tables-newset
 * @description linux-ad9f151e560b016b6ad3280b48e42fa11e1a5440-net/netfilter/nf_tables_api.c-nf_tables_newset CVE-2021-46283
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vnla_4190, Variable vflags_4193, Variable vexpr_4198, Variable vset_4203, Variable vctx_4204, Variable verr_4208, Variable vi_4208, Variable vtmp_4379, Variable vleft_4380, ExprStmt target_4, IfStmt target_0) {
	target_0.getCondition().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnla_4190
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vexpr_4198
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nft_set_elem_expr_alloc")
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vctx_4204
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vset_4203
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnla_4190
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vexpr_4198
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=verr_4208
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("PTR_ERR")
	and target_0.getThen().(BlockStmt).getStmt(1).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="err_set_alloc_name"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="exprs"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getLValue().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_0.getThen().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(AssignExpr).getRValue().(VariableAccess).getTarget()=vexpr_4198
	and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getTarget().getName()="num_exprs"
	and target_0.getThen().(BlockStmt).getStmt(3).(ExprStmt).getExpr().(PostfixIncrExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_0.getElse().(IfStmt).getCondition().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=vnla_4190
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(3).(IfStmt).getCondition().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vflags_4193
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(3).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="err_set_alloc_name"
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_4208
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(4).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getCondition().(FunctionCall).getTarget().hasName("nla_ok")
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtmp_4379
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getCondition().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vleft_4380
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getUpdate().(AssignExpr).getLValue().(VariableAccess).getTarget()=vtmp_4379
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getUpdate().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nla_next")
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getUpdate().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtmp_4379
	and target_0.getElse().(IfStmt).getThen().(BlockStmt).getStmt(5).(ForStmt).getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("IS_ERR")
	and target_0.getLocation().isBefore(target_4.getLocation())
}

predicate func_1(Variable vtable_4201, Variable vset_4203, ExprStmt target_5, ExprStmt target_1) {
	target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="handle"
	and target_1.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("nf_tables_alloc_handle")
	and target_1.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vtable_4201
	and target_1.getLocation().isBefore(target_5.getLocation())
}

predicate func_2(Variable vset_4203, Variable vctx_4204, Variable vi_4208, LabelStmt target_6, ForStmt target_2) {
	target_2.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_4208
	and target_2.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_2.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_4208
	and target_2.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getTarget().getName()="num_exprs"
	and target_2.getCondition().(RelationalOperation).getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_2.getUpdate().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_4208
	and target_2.getStmt().(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("nft_expr_destroy")
	and target_2.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vctx_4204
	and target_2.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="exprs"
	and target_2.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_2.getStmt().(ExprStmt).getExpr().(FunctionCall).getArgument(1).(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_4208
	and target_6.getLocation().isBefore(target_2.getLocation())
}

predicate func_3(Variable vset_4203, LabelStmt target_7, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="name"
	and target_3.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_7.getLocation().isBefore(target_3.getLocation())
}

predicate func_4(Function func, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned char *")
	and target_4.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vset_4203, ExprStmt target_5) {
	target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="field_count"
	and target_5.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vset_4203
	and target_5.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="field_count"
	and target_5.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("nft_set_desc")
}

predicate func_6(Function func, LabelStmt target_6) {
	target_6.getName() ="err_set_init"
	and target_6.getEnclosingFunction() = func
}

predicate func_7(Function func, LabelStmt target_7) {
	target_7.getName() ="err_set_alloc_name"
	and target_7.getEnclosingFunction() = func
}

from Function func, Parameter vnla_4190, Variable vflags_4193, Variable vexpr_4198, Variable vtable_4201, Variable vset_4203, Variable vctx_4204, Variable verr_4208, Variable vi_4208, Variable vtmp_4379, Variable vleft_4380, IfStmt target_0, ExprStmt target_1, ForStmt target_2, ExprStmt target_3, ExprStmt target_4, ExprStmt target_5, LabelStmt target_6, LabelStmt target_7
where
func_0(vnla_4190, vflags_4193, vexpr_4198, vset_4203, vctx_4204, verr_4208, vi_4208, vtmp_4379, vleft_4380, target_4, target_0)
and func_1(vtable_4201, vset_4203, target_5, target_1)
and func_2(vset_4203, vctx_4204, vi_4208, target_6, target_2)
and func_3(vset_4203, target_7, target_3)
and func_4(func, target_4)
and func_5(vset_4203, target_5)
and func_6(func, target_6)
and func_7(func, target_7)
and vnla_4190.getType().hasName("const nlattr *const[]")
and vflags_4193.getType().hasName("u32")
and vexpr_4198.getType().hasName("nft_expr *")
and vtable_4201.getType().hasName("nft_table *")
and vset_4203.getType().hasName("nft_set *")
and vctx_4204.getType().hasName("nft_ctx")
and verr_4208.getType().hasName("int")
and vi_4208.getType().hasName("int")
and vtmp_4379.getType().hasName("nlattr *")
and vleft_4380.getType().hasName("int")
and vnla_4190.getFunction() = func
and vflags_4193.(LocalVariable).getFunction() = func
and vexpr_4198.(LocalVariable).getFunction() = func
and vtable_4201.(LocalVariable).getFunction() = func
and vset_4203.(LocalVariable).getFunction() = func
and vctx_4204.(LocalVariable).getFunction() = func
and verr_4208.(LocalVariable).getFunction() = func
and vi_4208.(LocalVariable).getFunction() = func
and vtmp_4379.(LocalVariable).getFunction() = func
and vleft_4380.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
