/**
 * @name linux-09b1d5dc6ce1c9151777f6c4e128a59457704c97-cfg80211_init_wdev
 * @id cpp/linux/09b1d5dc6ce1c9151777f6c4e128a59457704c97/cfg80211-init-wdev
 * @description linux-09b1d5dc6ce1c9151777f6c4e128a59457704c97-net/wireless/core.c-cfg80211_init_wdev CVE-2021-47494
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_1(Variable v__key_1282, AddressOfExpr target_1) {
	target_1.getOperand().(VariableAccess).getTarget()=v__key_1282
	and target_1.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_2(Function func, DoStmt target_2) {
	target_2.getCondition().(Literal).getValue()="0"
	and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("__raw_spin_lock_init")
	and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mgmt_registrations_lock"
	and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&wdev->mgmt_registrations_lock"
	and target_2.getStmt().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(FunctionCall).getArgument(2) instanceof AddressOfExpr
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

/*predicate func_3(Parameter vwdev_1276, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("__raw_spin_lock_init")
	and target_3.getExpr().(FunctionCall).getArgument(0).(FunctionCall).getTarget().hasName("spinlock_check")
	and target_3.getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="mgmt_registrations_lock"
	and target_3.getExpr().(FunctionCall).getArgument(0).(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vwdev_1276
	and target_3.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="&wdev->mgmt_registrations_lock"
	and target_3.getExpr().(FunctionCall).getArgument(2) instanceof AddressOfExpr
}

*/
from Function func, Parameter vwdev_1276, Variable v__key_1282, AddressOfExpr target_1, DoStmt target_2
where
func_1(v__key_1282, target_1)
and func_2(func, target_2)
and vwdev_1276.getType().hasName("wireless_dev *")
and v__key_1282.getType().hasName("lock_class_key")
and vwdev_1276.getFunction() = func
and v__key_1282.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
