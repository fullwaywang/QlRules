/**
 * @name linux-eedeb787ebb53de5c5dcf7b7b39d01bf1b0f037d-call_usermodehelper_exec
 * @id cpp/linux/eedeb787ebb53de5c5dcf7b7b39d01bf1b0f037d/call-usermodehelper-exec
 * @description linux-eedeb787ebb53de5c5dcf7b7b39d01bf1b0f037d-kernel/umh.c-call_usermodehelper_exec CVE-2023-52704
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vwait_405, Variable vstate_407, IfStmt target_9, IfStmt target_0) {
	target_0.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwait_405
	and target_0.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="8"
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vstate_407
	and target_0.getThen().(ExprStmt).getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="8192"
	and target_9.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(Variable vstate_407, Variable vretval_409, ExprStmt target_10) {
exists(FunctionCall target_1 |
	target_1.getTarget().hasName("wait_for_completion_state")
	and target_1.getArgument(0) instanceof AddressOfExpr
	and target_1.getArgument(1).(BitwiseOrExpr).getLeftOperand().(VariableAccess).getTarget()=vstate_407
	and target_1.getArgument(1).(BitwiseOrExpr).getRightOperand() instanceof BitwiseOrExpr
	and target_1.getParent().(AssignExpr).getRValue() = target_1
	and target_1.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_409
	and target_10.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getLocation().isBefore(target_1.getArgument(1).(BitwiseOrExpr).getLeftOperand().(VariableAccess).getLocation()))
}

/*predicate func_3(Variable vstate_407, Variable vdone_408, AddressOfExpr target_3) {
	target_3.getOperand().(VariableAccess).getTarget()=vdone_408
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("wait_for_completion_state")
	and target_3.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vstate_407
}

*/
predicate func_4(Function func, BitwiseOrExpr target_4) {
	target_4.getValue()="258"
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vstate_407, Variable vdone_408, Variable vretval_409, FunctionCall target_5) {
	target_5.getTarget().hasName("wait_for_completion_state")
	and target_5.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdone_408
	and target_5.getArgument(1).(VariableAccess).getTarget()=vstate_407
	and target_5.getParent().(AssignExpr).getRValue() = target_5
	and target_5.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vretval_409
}

predicate func_6(Variable vretval_409, Function func, IfStmt target_6) {
	target_6.getCondition().(NotExpr).getOperand().(VariableAccess).getTarget()=vretval_409
	and target_6.getThen().(GotoStmt).getName() ="wait_done"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vstate_407, AssignOrExpr target_7) {
	target_7.getLValue().(VariableAccess).getTarget()=vstate_407
	and target_7.getRValue() instanceof BitwiseOrExpr
}

predicate func_8(Parameter vwait_405, Function func, IfStmt target_8) {
	target_8.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwait_405
	and target_8.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(1).(DoStmt).getCondition().(Literal).getValue()="0"
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(StmtExpr).getStmt().(BlockStmt).getStmt(2).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("instrument_atomic_write")
	and target_8.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(GotoStmt).getName() ="unlock"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vwait_405, IfStmt target_9) {
	target_9.getCondition().(BitwiseAndExpr).getLeftOperand().(VariableAccess).getTarget()=vwait_405
	and target_9.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="4"
	and target_9.getThen().(ExprStmt).getExpr() instanceof AssignOrExpr
}

predicate func_10(Variable vstate_407, ExprStmt target_10) {
	target_10.getExpr().(AssignOrExpr).getLValue().(VariableAccess).getTarget()=vstate_407
	and target_10.getExpr().(AssignOrExpr).getRValue().(Literal).getValue()="8192"
}

from Function func, Parameter vwait_405, Variable vstate_407, Variable vdone_408, Variable vretval_409, IfStmt target_0, BitwiseOrExpr target_4, FunctionCall target_5, IfStmt target_6, AssignOrExpr target_7, IfStmt target_8, IfStmt target_9, ExprStmt target_10
where
func_0(vwait_405, vstate_407, target_9, target_0)
and not func_1(vstate_407, vretval_409, target_10)
and func_4(func, target_4)
and func_5(vstate_407, vdone_408, vretval_409, target_5)
and func_6(vretval_409, func, target_6)
and func_7(vstate_407, target_7)
and func_8(vwait_405, func, target_8)
and func_9(vwait_405, target_9)
and func_10(vstate_407, target_10)
and vwait_405.getType().hasName("int")
and vstate_407.getType().hasName("unsigned int")
and vdone_408.getType().hasName("completion")
and vretval_409.getType().hasName("int")
and vwait_405.getFunction() = func
and vstate_407.(LocalVariable).getFunction() = func
and vdone_408.(LocalVariable).getFunction() = func
and vretval_409.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
