/**
 * @name linux-d3b6372c5881cb54925212abb62c521df8ba4809-__del_gref
 * @id cpp/linux/d3b6372c5881cb54925212abb62c521df8ba4809/--del-gref
 * @description linux-d3b6372c5881cb54925212abb62c521df8ba4809-drivers/xen/gntalloc.c-__del_gref CVE-2022-23039
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vgref_184, FunctionCall target_0) {
	target_0.getTarget().hasName("__free_pages")
	and not target_0.getTarget().hasName("gnttab_end_foreign_access")
	and target_0.getArgument(0).(PointerFieldAccess).getTarget().getName()="page"
	and target_0.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_0.getArgument(1).(Literal).getValue()="0"
}

predicate func_1(Parameter vgref_184, ExprStmt target_13) {
exists(AssignExpr target_1 |
	target_1.getLValue().(VariableAccess).getType().hasName("unsigned long")
	and target_1.getRValue().(AddExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="page"
	and target_1.getRValue().(AddExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_1.getRValue().(AddExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerArithmeticOperation).getRightOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_1.getRValue().(AddExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="12"
	and target_1.getRValue().(AddExpr).getRightOperand().(VariableAccess).getType().hasName("unsigned long")
	and target_1.getRValue().(AddExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(PointerArithmeticOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Parameter vgref_184, FunctionCall target_9, ExprStmt target_5) {
exists(ExprStmt target_2 |
	target_2.getExpr().(FunctionCall).getTarget().hasName("gnttab_end_foreign_access")
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="gref_id"
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_2.getExpr().(FunctionCall).getArgument(1) instanceof Literal
	and target_2.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getType().hasName("unsigned long")
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_2
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_9
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_5.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_4(Parameter vgref_184, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="gref_id"
	and target_4.getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_4.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_5(Parameter vgref_184, PointerFieldAccess target_14, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("gnttab_free_grant_reference")
	and target_5.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="gref_id"
	and target_5.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_5.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

predicate func_6(Parameter vgref_184, ExprStmt target_15, PointerFieldAccess target_6) {
	target_6.getTarget().getName()="page"
	and target_6.getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_6.getParent().(IfStmt).getThen()=target_15
}

predicate func_7(Parameter vgref_184, PointerFieldAccess target_7) {
	target_7.getTarget().getName()="page"
	and target_7.getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_7.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_9(Parameter vgref_184, FunctionCall target_9) {
	target_9.getTarget().hasName("gnttab_query_foreign_access")
	and target_9.getArgument(0).(PointerFieldAccess).getTarget().getName()="gref_id"
	and target_9.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_9.getParent().(IfStmt).getThen() instanceof ReturnStmt
}

predicate func_10(FunctionCall target_9, Function func, ReturnStmt target_10) {
	target_10.getParent().(IfStmt).getCondition()=target_9
	and target_10.getEnclosingFunction() = func
}

predicate func_11(Parameter vgref_184, PointerFieldAccess target_14, IfStmt target_11) {
	target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("gnttab_end_foreign_access_ref")
	and target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="gref_id"
	and target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_11.getCondition().(NotExpr).getOperand().(FunctionCall).getArgument(1) instanceof Literal
	and target_11.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_14
}

predicate func_12(Parameter vgref_184, Function func, IfStmt target_12) {
	target_12.getCondition().(PointerFieldAccess).getTarget().getName()="page"
	and target_12.getCondition().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vgref_184
	and target_12.getThen().(ExprStmt).getExpr() instanceof FunctionCall
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_12
}

predicate func_13(Parameter vgref_184, ExprStmt target_13) {
	target_13.getExpr().(FunctionCall).getTarget().hasName("kfree")
	and target_13.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vgref_184
}

predicate func_14(Parameter vgref_184, PointerFieldAccess target_14) {
	target_14.getTarget().getName()="gref_id"
	and target_14.getQualifier().(VariableAccess).getTarget()=vgref_184
}

predicate func_15(Function func, ExprStmt target_15) {
	target_15.getExpr() instanceof FunctionCall
	and target_15.getEnclosingFunction() = func
}

from Function func, Parameter vgref_184, FunctionCall target_0, PointerFieldAccess target_4, ExprStmt target_5, PointerFieldAccess target_6, PointerFieldAccess target_7, FunctionCall target_9, ReturnStmt target_10, IfStmt target_11, IfStmt target_12, ExprStmt target_13, PointerFieldAccess target_14, ExprStmt target_15
where
func_0(vgref_184, target_0)
and not func_1(vgref_184, target_13)
and not func_2(vgref_184, target_9, target_5)
and func_4(vgref_184, target_4)
and func_5(vgref_184, target_14, target_5)
and func_6(vgref_184, target_15, target_6)
and func_7(vgref_184, target_7)
and func_9(vgref_184, target_9)
and func_10(target_9, func, target_10)
and func_11(vgref_184, target_14, target_11)
and func_12(vgref_184, func, target_12)
and func_13(vgref_184, target_13)
and func_14(vgref_184, target_14)
and func_15(func, target_15)
and vgref_184.getType().hasName("gntalloc_gref *")
and vgref_184.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
