/**
 * @name linux-9de7922bc709eee2f609cd01d98aaedc4cf5ea74-sctp_sf_do_asconf
 * @id cpp/linux/9de7922bc709eee2f609cd01d98aaedc4cf5ea74/sctp-sf-do-asconf
 * @description linux-9de7922bc709eee2f609cd01d98aaedc4cf5ea74-net/sctp/sm_statefuns.c-sctp_sf_do_asconf CVE-2014-3673
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vasoc_3586, Variable vchunk_3590, ReturnStmt target_10, FunctionCall target_11, NotExpr target_12) {
exists(FunctionCall target_0 |
	target_0.getTarget().hasName("sctp_verify_asconf")
	and target_0.getArgument(0).(VariableAccess).getTarget()=vasoc_3586
	and target_0.getArgument(1).(VariableAccess).getTarget()=vchunk_3590
	and target_0.getArgument(3) instanceof AddressOfExpr
	and target_0.getParent().(NotExpr).getOperand() instanceof FunctionCall
	and target_0.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_10
	and target_0.getArgument(0).(VariableAccess).getLocation().isBefore(target_11.getArgument(2).(VariableAccess).getLocation())
	and target_0.getArgument(1).(VariableAccess).getLocation().isBefore(target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_1(Variable verr_param_3592, AddressOfExpr target_1) {
	target_1.getOperand().(VariableAccess).getTarget()=verr_param_3592
	and target_1.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_2(Parameter vasoc_3586, VariableAccess target_2) {
	target_2.getTarget()=vasoc_3586
	and target_2.getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_3(Variable vchunk_3590, VariableAccess target_3) {
	target_3.getTarget()=vchunk_3590
	and target_3.getParent().(PointerFieldAccess).getParent().(FunctionCall).getParent().(NotExpr).getOperand() instanceof FunctionCall
}

predicate func_4(Function func, DeclStmt target_4) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Function func, DeclStmt target_5) {
	func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vhdr_3593, Variable vaddr_param_3594, Function func, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vaddr_param_3594
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="params"
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vhdr_3593
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Variable vaddr_param_3594, Variable vlength_3596, Function func, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlength_3596
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getTarget().hasName("__builtin_constant_p")
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="length"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="p"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getCondition().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vaddr_param_3594
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="length"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="255"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getLeftOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="length"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getLeftOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="65280"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getThen().(BitwiseOrExpr).getRightOperand().(BinaryBitwiseOperation).getRightOperand().(Literal).getValue()="8"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(FunctionCall).getTarget().hasName("__fswab16")
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(ValueFieldAccess).getTarget().getName()="length"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="p"
	and target_7.getExpr().(AssignExpr).getRValue().(ConditionalExpr).getElse().(FunctionCall).getArgument(0).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vaddr_param_3594
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Parameter vnet_3584, Parameter vep_3585, Parameter vasoc_3586, Parameter vtype_3587, Parameter varg_3587, Parameter vcommands_3588, Variable vaddr_param_3594, Variable vlength_3596, Function func, IfStmt target_8) {
	target_8.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vlength_3596
	and target_8.getCondition().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getType() instanceof LongType
	and target_8.getCondition().(RelationalOperation).getGreaterOperand().(SizeofTypeOperator).getValue()="4"
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getTarget().hasName("sctp_sf_violation_paramlen")
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_3584
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vep_3585
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vasoc_3586
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtype_3587
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=varg_3587
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=vaddr_param_3594
	and target_8.getThen().(ReturnStmt).getExpr().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vcommands_3588
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vasoc_3586, Variable vchunk_3590, Variable vaddr_param_3594, Variable vlength_3596, ReturnStmt target_10, FunctionCall target_9) {
	target_9.getTarget().hasName("sctp_verify_asconf")
	and target_9.getArgument(0).(VariableAccess).getTarget()=vasoc_3586
	and target_9.getArgument(1).(PointerArithmeticOperation).getLeftOperand().(VariableAccess).getTarget()=vaddr_param_3594
	and target_9.getArgument(1).(PointerArithmeticOperation).getRightOperand().(VariableAccess).getTarget()=vlength_3596
	and target_9.getArgument(2).(PointerFieldAccess).getTarget().getName()="chunk_end"
	and target_9.getArgument(2).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_3590
	and target_9.getArgument(3) instanceof AddressOfExpr
	and target_9.getParent().(NotExpr).getParent().(IfStmt).getThen()=target_10
}

predicate func_10(Parameter vnet_3584, Parameter vep_3585, Parameter vasoc_3586, Parameter vtype_3587, Parameter varg_3587, Parameter vcommands_3588, Variable verr_param_3592, ReturnStmt target_10) {
	target_10.getExpr().(FunctionCall).getTarget().hasName("sctp_sf_violation_paramlen")
	and target_10.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnet_3584
	and target_10.getExpr().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vep_3585
	and target_10.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vasoc_3586
	and target_10.getExpr().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vtype_3587
	and target_10.getExpr().(FunctionCall).getArgument(4).(VariableAccess).getTarget()=varg_3587
	and target_10.getExpr().(FunctionCall).getArgument(5).(VariableAccess).getTarget()=verr_param_3592
	and target_10.getExpr().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vcommands_3588
}

predicate func_11(Parameter vnet_3584, Parameter vep_3585, Parameter vasoc_3586, Parameter vtype_3587, Parameter varg_3587, Parameter vcommands_3588, Variable verr_param_3592, FunctionCall target_11) {
	target_11.getTarget().hasName("sctp_sf_violation_paramlen")
	and target_11.getArgument(0).(VariableAccess).getTarget()=vnet_3584
	and target_11.getArgument(1).(VariableAccess).getTarget()=vep_3585
	and target_11.getArgument(2).(VariableAccess).getTarget()=vasoc_3586
	and target_11.getArgument(3).(VariableAccess).getTarget()=vtype_3587
	and target_11.getArgument(4).(VariableAccess).getTarget()=varg_3587
	and target_11.getArgument(5).(VariableAccess).getTarget()=verr_param_3592
	and target_11.getArgument(6).(VariableAccess).getTarget()=vcommands_3588
}

predicate func_12(Variable vchunk_3590, NotExpr target_12) {
	target_12.getOperand().(PointerFieldAccess).getTarget().getName()="has_asconf"
	and target_12.getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vchunk_3590
}

from Function func, Parameter vnet_3584, Parameter vep_3585, Parameter vasoc_3586, Parameter vtype_3587, Parameter varg_3587, Parameter vcommands_3588, Variable vchunk_3590, Variable verr_param_3592, Variable vhdr_3593, Variable vaddr_param_3594, Variable vlength_3596, AddressOfExpr target_1, VariableAccess target_2, VariableAccess target_3, DeclStmt target_4, DeclStmt target_5, ExprStmt target_6, ExprStmt target_7, IfStmt target_8, FunctionCall target_9, ReturnStmt target_10, FunctionCall target_11, NotExpr target_12
where
not func_0(vasoc_3586, vchunk_3590, target_10, target_11, target_12)
and func_1(verr_param_3592, target_1)
and func_2(vasoc_3586, target_2)
and func_3(vchunk_3590, target_3)
and func_4(func, target_4)
and func_5(func, target_5)
and func_6(vhdr_3593, vaddr_param_3594, func, target_6)
and func_7(vaddr_param_3594, vlength_3596, func, target_7)
and func_8(vnet_3584, vep_3585, vasoc_3586, vtype_3587, varg_3587, vcommands_3588, vaddr_param_3594, vlength_3596, func, target_8)
and func_9(vasoc_3586, vchunk_3590, vaddr_param_3594, vlength_3596, target_10, target_9)
and func_10(vnet_3584, vep_3585, vasoc_3586, vtype_3587, varg_3587, vcommands_3588, verr_param_3592, target_10)
and func_11(vnet_3584, vep_3585, vasoc_3586, vtype_3587, varg_3587, vcommands_3588, verr_param_3592, target_11)
and func_12(vchunk_3590, target_12)
and vnet_3584.getType().hasName("net *")
and vep_3585.getType().hasName("const sctp_endpoint *")
and vasoc_3586.getType().hasName("const sctp_association *")
and vtype_3587.getType().hasName("const sctp_subtype_t")
and varg_3587.getType().hasName("void *")
and vcommands_3588.getType().hasName("sctp_cmd_seq_t *")
and vchunk_3590.getType().hasName("sctp_chunk *")
and verr_param_3592.getType().hasName("sctp_paramhdr *")
and vhdr_3593.getType().hasName("sctp_addiphdr_t *")
and vaddr_param_3594.getType().hasName("sctp_addr_param *")
and vlength_3596.getType().hasName("int")
and vnet_3584.getFunction() = func
and vep_3585.getFunction() = func
and vasoc_3586.getFunction() = func
and vtype_3587.getFunction() = func
and varg_3587.getFunction() = func
and vcommands_3588.getFunction() = func
and vchunk_3590.(LocalVariable).getFunction() = func
and verr_param_3592.(LocalVariable).getFunction() = func
and vhdr_3593.(LocalVariable).getFunction() = func
and vaddr_param_3594.(LocalVariable).getFunction() = func
and vlength_3596.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
