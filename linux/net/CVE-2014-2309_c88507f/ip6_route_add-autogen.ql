/**
 * @name linux-c88507fbad8055297c1d1e21e599f46960cbee39-ip6_route_add
 * @id cpp/linux/c88507fbad8055297c1d1e21e599f46960cbee39/ip6-route-add
 * @description linux-c88507fbad8055297c1d1e21e599f46960cbee39-net/ipv6/route.c-ip6_route_add CVE-2014-2309
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vcfg_1472, ExprStmt target_2, BitwiseAndExpr target_3) {
exists(ConditionalExpr target_0 |
	target_0.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="fc_flags"
	and target_0.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_1472
	and target_0.getCondition().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="262144"
	and target_0.getThen().(Literal).getValue()="0"
	and target_0.getElse() instanceof Literal
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ip6_dst_alloc")
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net *")
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(Literal).getValue()="0"
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(2) instanceof Literal
	and target_0.getParent().(FunctionCall).getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget().getType().hasName("fib6_table *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_0.getCondition().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Parameter vcfg_1472, LogicalAndExpr target_4, ExprStmt target_2) {
	target_2.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("fib6_table *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("fib6_new_table")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("net *")
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="fc_table"
	and target_2.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_1472
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
}

predicate func_3(Parameter vcfg_1472, BitwiseAndExpr target_3) {
	target_3.getLeftOperand().(PointerFieldAccess).getTarget().getName()="fc_flags"
	and target_3.getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_1472
	and target_3.getRightOperand().(Literal).getValue()="4194304"
}

predicate func_4(Parameter vcfg_1472, LogicalAndExpr target_4) {
	target_4.getLeftOperand().(ValueFieldAccess).getTarget().getName()="nlh"
	and target_4.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="fc_nlinfo"
	and target_4.getLeftOperand().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_1472
	and target_4.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="nlmsg_flags"
	and target_4.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="nlh"
	and target_4.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="fc_nlinfo"
	and target_4.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vcfg_1472
	and target_4.getRightOperand().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(Literal).getValue()="1024"
}

from Function func, Parameter vcfg_1472, ExprStmt target_2, BitwiseAndExpr target_3, LogicalAndExpr target_4
where
not func_0(vcfg_1472, target_2, target_3)
and func_2(vcfg_1472, target_4, target_2)
and func_3(vcfg_1472, target_3)
and func_4(vcfg_1472, target_4)
and vcfg_1472.getType().hasName("fib6_config *")
and vcfg_1472.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
