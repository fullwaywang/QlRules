/**
 * @name linux-514c7dca85a0bf40be984dab0b477403a6db901f-find_first_block_group
 * @id cpp/linux/514c7dca85a0bf40be984dab0b477403a6db901f/find-first-block-group
 * @description linux-514c7dca85a0bf40be984dab0b477403a6db901f-fs/btrfs/extent-tree.c-find_first_block_group CVE-2018-14610
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vfs_info_9527, Variable vret_9532, Variable vfound_key_9533, Variable vleaf_9534, Variable vslot_9535, Variable vem_9557, NotExpr target_2, ExprStmt target_3, ExprStmt target_4, ValueFieldAccess target_5, ExprStmt target_6) {
exists(IfStmt target_0 |
	target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="start"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vem_9557
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(ValueFieldAccess).getTarget().getName()="objectid"
	and target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getTarget().getName()="len"
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vem_9557
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(ValueFieldAccess).getTarget().getName()="offset"
	and target_0.getCondition().(LogicalOrExpr).getRightOperand().(EqualityOperation).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("btrfs_printk")
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfs_info_9527
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="3block group %llu len %llu mismatch with chunk %llu len %llu"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="objectid"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="offset"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getTarget().getName()="start"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vem_9557
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(5).(PointerFieldAccess).getTarget().getName()="len"
	and target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(5).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vem_9557
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_9532
	and target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-117"
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("read_extent_buffer")
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vleaf_9534
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getType().hasName("btrfs_block_group_item")
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddExpr).getLeftOperand().(BuiltInOperationBuiltInOffsetOf).getValue()="101"
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(FunctionCall).getTarget().hasName("btrfs_item_offset_nr")
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vleaf_9534
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(AddExpr).getRightOperand().(FunctionCall).getArgument(1).(VariableAccess).getTarget()=vslot_9535
	and target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(SizeofExprOperator).getValue()="24"
	and target_0.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getType().hasName("u64")
	and target_0.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getLeftOperand().(FunctionCall).getTarget().hasName("btrfs_block_group_flags")
	and target_0.getElse().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getRValue().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="7"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getType().hasName("u64")
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="type"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(ValueFieldAccess).getTarget().getName()="map_lookup"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(BitwiseAndExpr).getRightOperand().(BitwiseOrExpr).getValue()="7"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("btrfs_printk")
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfs_info_9527
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="3block group %llu len %llu type flags 0x%llx mismatch with chunk type flags 0x%llx"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="objectid"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="offset"
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(4).(VariableAccess).getType().hasName("u64")
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_9532
	and target_0.getElse().(BlockStmt).getStmt(2).(IfStmt).getElse() instanceof BlockStmt
	and target_0.getParent().(IfStmt).getCondition()=target_2
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation())
	and target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation().isBefore(target_0.getThen().(BlockStmt).getStmt(1).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getLocation())
	and target_5.getQualifier().(VariableAccess).getLocation().isBefore(target_0.getCondition().(LogicalOrExpr).getLeftOperand().(EqualityOperation).getRightOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_0.getElse().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_1(Variable vret_9532, NotExpr target_2, BlockStmt target_1) {
	target_1.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_9532
	and target_1.getStmt(0).(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getParent().(IfStmt).getCondition()=target_2
}

predicate func_2(Variable vem_9557, NotExpr target_2) {
	target_2.getOperand().(VariableAccess).getTarget()=vem_9557
}

predicate func_3(Parameter vfs_info_9527, Variable vfound_key_9533, ExprStmt target_3) {
	target_3.getExpr().(FunctionCall).getTarget().hasName("btrfs_printk")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vfs_info_9527
	and target_3.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="3logical %llu len %llu found bg but no related chunk"
	and target_3.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getTarget().getName()="objectid"
	and target_3.getExpr().(FunctionCall).getArgument(2).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
	and target_3.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getTarget().getName()="offset"
	and target_3.getExpr().(FunctionCall).getArgument(3).(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vfound_key_9533
}

predicate func_4(Variable vret_9532, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_9532
	and target_4.getExpr().(AssignExpr).getRValue().(UnaryMinusExpr).getValue()="-2"
}

predicate func_5(Variable vfound_key_9533, ValueFieldAccess target_5) {
	target_5.getTarget().getName()="offset"
	and target_5.getQualifier().(VariableAccess).getTarget()=vfound_key_9533
}

predicate func_6(Variable vfound_key_9533, Variable vleaf_9534, Variable vslot_9535, ExprStmt target_6) {
	target_6.getExpr().(FunctionCall).getTarget().hasName("btrfs_item_key_to_cpu")
	and target_6.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vleaf_9534
	and target_6.getExpr().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vfound_key_9533
	and target_6.getExpr().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vslot_9535
}

from Function func, Parameter vfs_info_9527, Variable vret_9532, Variable vfound_key_9533, Variable vleaf_9534, Variable vslot_9535, Variable vem_9557, BlockStmt target_1, NotExpr target_2, ExprStmt target_3, ExprStmt target_4, ValueFieldAccess target_5, ExprStmt target_6
where
not func_0(vfs_info_9527, vret_9532, vfound_key_9533, vleaf_9534, vslot_9535, vem_9557, target_2, target_3, target_4, target_5, target_6)
and func_1(vret_9532, target_2, target_1)
and func_2(vem_9557, target_2)
and func_3(vfs_info_9527, vfound_key_9533, target_3)
and func_4(vret_9532, target_4)
and func_5(vfound_key_9533, target_5)
and func_6(vfound_key_9533, vleaf_9534, vslot_9535, target_6)
and vfs_info_9527.getType().hasName("btrfs_fs_info *")
and vret_9532.getType().hasName("int")
and vfound_key_9533.getType().hasName("btrfs_key")
and vleaf_9534.getType().hasName("extent_buffer *")
and vslot_9535.getType().hasName("int")
and vem_9557.getType().hasName("extent_map *")
and vfs_info_9527.getFunction() = func
and vret_9532.(LocalVariable).getFunction() = func
and vfound_key_9533.(LocalVariable).getFunction() = func
and vleaf_9534.(LocalVariable).getFunction() = func
and vslot_9535.(LocalVariable).getFunction() = func
and vem_9557.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
