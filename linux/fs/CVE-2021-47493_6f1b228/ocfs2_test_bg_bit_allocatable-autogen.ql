/**
 * @name linux-6f1b228529ae49b0f85ab89bcdb6c365df401558-ocfs2_test_bg_bit_allocatable
 * @id cpp/linux/6f1b228529ae49b0f85ab89bcdb6c365df401558/ocfs2-test-bg-bit-allocatable
 * @description linux-6f1b228529ae49b0f85ab89bcdb6c365df401558-fs/ocfs2/suballoc.c-ocfs2_test_bg_bit_allocatable CVE-2021-47493
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Function func) {
exists(Initializer target_0 |
	target_0.getExpr().(Literal).getValue()="1"
	and target_0.getExpr().getEnclosingFunction() = func)
}

predicate func_1(Parameter vbg_bh_1249, ExprStmt target_4, NotExpr target_9, Function func) {
exists(ExprStmt target_1 |
	target_1.getExpr().(FunctionCall).getTarget().hasName("jbd_lock_bh_journal_head")
	and target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbg_bh_1249
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_4.getLocation())
	and target_9.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getLocation().isBefore(target_1.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getLocation()))
}

predicate func_2(Parameter vbg_bh_1249, ExprStmt target_4, Function func) {
exists(IfStmt target_2 |
	target_2.getCondition().(FunctionCall).getTarget().hasName("buffer_jbd")
	and target_2.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbg_bh_1249
	and target_2.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_2.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
	and target_2.getThen().(BlockStmt).getStmt(2) instanceof ExprStmt
	and target_2.getThen().(BlockStmt).getStmt(3) instanceof IfStmt
	and target_2.getThen().(BlockStmt).getStmt(4) instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
	and target_2.getLocation().isBefore(target_4.getLocation()))
}

predicate func_3(Parameter vbg_bh_1249, ExprStmt target_4, Function func) {
exists(ExprStmt target_3 |
	target_3.getExpr().(FunctionCall).getTarget().hasName("jbd_unlock_bh_journal_head")
	and target_3.getExpr().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbg_bh_1249
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
	and target_3.getLocation().isBefore(target_4.getLocation()))
}

predicate func_4(Parameter vbg_bh_1249, Variable vjh_1253, Function func, ExprStmt target_4) {
	target_4.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vjh_1253
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("bh2jh")
	and target_4.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbg_bh_1249
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_4
}

predicate func_5(Variable vjh_1253, Function func, ExprStmt target_5) {
	target_5.getExpr().(FunctionCall).getTarget().hasName("spin_lock")
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="b_state_lock"
	and target_5.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjh_1253
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_5
}

predicate func_6(Variable vbg_1252, Variable vjh_1253, Function func, ExprStmt target_6) {
	target_6.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vbg_1252
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="b_committed_data"
	and target_6.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjh_1253
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_6
}

predicate func_7(Parameter vnr_1250, Variable vbg_1252, Variable vret_1254, Function func, IfStmt target_7) {
	target_7.getCondition().(VariableAccess).getTarget()=vbg_1252
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1254
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getTarget().hasName("test_bit_le")
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnr_1250
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getTarget().getName()="bg_bitmap"
	and target_7.getThen().(ExprStmt).getExpr().(AssignExpr).getRValue().(NotExpr).getOperand().(FunctionCall).getArgument(1).(ValueFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="(unknown field)"
	and target_7.getElse().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_1254
	and target_7.getElse().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="1"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_7
}

predicate func_8(Variable vjh_1253, Function func, ExprStmt target_8) {
	target_8.getExpr().(FunctionCall).getTarget().hasName("spin_unlock")
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getTarget().getName()="b_state_lock"
	and target_8.getExpr().(FunctionCall).getArgument(0).(AddressOfExpr).getOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vjh_1253
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_8
}

predicate func_9(Parameter vbg_bh_1249, NotExpr target_9) {
	target_9.getOperand().(FunctionCall).getTarget().hasName("buffer_jbd")
	and target_9.getOperand().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vbg_bh_1249
}

from Function func, Parameter vbg_bh_1249, Parameter vnr_1250, Variable vbg_1252, Variable vjh_1253, Variable vret_1254, ExprStmt target_4, ExprStmt target_5, ExprStmt target_6, IfStmt target_7, ExprStmt target_8, NotExpr target_9
where
not func_0(func)
and not func_1(vbg_bh_1249, target_4, target_9, func)
and not func_2(vbg_bh_1249, target_4, func)
and not func_3(vbg_bh_1249, target_4, func)
and func_4(vbg_bh_1249, vjh_1253, func, target_4)
and func_5(vjh_1253, func, target_5)
and func_6(vbg_1252, vjh_1253, func, target_6)
and func_7(vnr_1250, vbg_1252, vret_1254, func, target_7)
and func_8(vjh_1253, func, target_8)
and func_9(vbg_bh_1249, target_9)
and vbg_bh_1249.getType().hasName("buffer_head *")
and vnr_1250.getType().hasName("int")
and vbg_1252.getType().hasName("ocfs2_group_desc *")
and vjh_1253.getType().hasName("journal_head *")
and vret_1254.getType().hasName("int")
and vbg_bh_1249.getFunction() = func
and vnr_1250.getFunction() = func
and vbg_1252.(LocalVariable).getFunction() = func
and vjh_1253.(LocalVariable).getFunction() = func
and vret_1254.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
