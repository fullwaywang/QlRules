/**
 * @name linux-5f00110f7273f9ff04ac69a5f85bb535a4fd0987-shmem_remount_fs
 * @id cpp/linux/5f00110f7273f9ff04ac69a5f85bb535a4fd0987/shmem-remount-fs
 * @description linux-5f00110f7273f9ff04ac69a5f85bb535a4fd0987-mm/shmem.c-shmem_remount_fs CVE-2013-1767
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vconfig_2485, IfStmt target_4, AddressOfExpr target_6, Function func) {
exists(ExprStmt target_0 |
	target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getTarget().getName()="mpol"
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vconfig_2485
	and target_0.getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_4.getLocation())
	and target_0.getExpr().(AssignExpr).getLValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_6.getOperand().(VariableAccess).getLocation()))
}

predicate func_1(Variable vconfig_2485, ExprStmt target_2, ExprStmt target_7, ExprStmt target_3, Function func) {
exists(IfStmt target_1 |
	target_1.getCondition().(ValueFieldAccess).getTarget().getName()="mpol"
	and target_1.getCondition().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vconfig_2485
	and target_1.getThen().(BlockStmt).getStmt(0) instanceof ExprStmt
	and target_1.getThen().(BlockStmt).getStmt(1) instanceof ExprStmt
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_1
	and target_1.getLocation().isBefore(target_2.getLocation())
	and target_7.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_1.getCondition().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation())
	and target_1.getCondition().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_2(Variable vsbinfo_2484, Function func, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("mpol_put")
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="mpol"
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbinfo_2484
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_2
}

predicate func_3(Variable vsbinfo_2484, Variable vconfig_2485, Function func, ExprStmt target_3) {
	target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="mpol"
	and target_3.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbinfo_2484
	and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getTarget().getName()="mpol"
	and target_3.getExpr().(AssignExpr).getRValue().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vconfig_2485
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_3
}

predicate func_4(Variable vconfig_2485, IfStmt target_4) {
	target_4.getCondition().(FunctionCall).getTarget().hasName("shmem_parse_options")
	and target_4.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget().getType().hasName("char *")
	and target_4.getCondition().(FunctionCall).getArgument(1).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vconfig_2485
	and target_4.getThen().(ReturnStmt).getExpr().(VariableAccess).getTarget().getType().hasName("int")
}

predicate func_6(Variable vconfig_2485, AddressOfExpr target_6) {
	target_6.getOperand().(VariableAccess).getTarget()=vconfig_2485
}

predicate func_7(Variable vsbinfo_2484, Variable vconfig_2485, ExprStmt target_7) {
	target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="free_inodes"
	and target_7.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vsbinfo_2484
	and target_7.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="max_inodes"
	and target_7.getExpr().(AssignExpr).getRValue().(SubExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vconfig_2485
	and target_7.getExpr().(AssignExpr).getRValue().(SubExpr).getRightOperand().(VariableAccess).getTarget().getType().hasName("unsigned long")
}

from Function func, Variable vsbinfo_2484, Variable vconfig_2485, ExprStmt target_2, ExprStmt target_3, IfStmt target_4, AddressOfExpr target_6, ExprStmt target_7
where
not func_0(vconfig_2485, target_4, target_6, func)
and not func_1(vconfig_2485, target_2, target_7, target_3, func)
and func_2(vsbinfo_2484, func, target_2)
and func_3(vsbinfo_2484, vconfig_2485, func, target_3)
and func_4(vconfig_2485, target_4)
and func_6(vconfig_2485, target_6)
and func_7(vsbinfo_2484, vconfig_2485, target_7)
and vsbinfo_2484.getType().hasName("shmem_sb_info *")
and vconfig_2485.getType().hasName("shmem_sb_info")
and vsbinfo_2484.(LocalVariable).getFunction() = func
and vconfig_2485.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
