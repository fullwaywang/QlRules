/**
 * @name linux-b71812168571fa55e44cdd0254471331b9c4c4c6-size_entry_mwt
 * @id cpp/linux/b71812168571fa55e44cdd0254471331b9c4c4c6/size-entry-mwt
 * @description linux-b71812168571fa55e44cdd0254471331b9c4c4c6-net/bridge/netfilter/ebtables.c-size_entry_mwt CVE-2018-1068
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Parameter vtotal_2072, Variable vi_2075, Variable voffsets_2077, ForStmt target_1, LogicalOrExpr target_2, NotExpr target_3, PointerArithmeticOperation target_6, Function func) {
exists(ForStmt target_0 |
	target_0.getInitialization().(ExprStmt).getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_2075
	and target_0.getInitialization().(ExprStmt).getExpr().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_0.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vi_2075
	and target_0.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="4"
	and target_0.getUpdate().(PrefixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_2075
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_2075
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vtotal_2072
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and target_0.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getLeftOperand().(VariableAccess).getTarget()=vi_2075
	and target_0.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(EqualityOperation).getRightOperand().(Literal).getValue()="0"
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(SubExpr).getLeftOperand().(VariableAccess).getTarget()=vi_2075
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(SubExpr).getRightOperand().(Literal).getValue()="1"
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_2075
	and target_0.getStmt().(BlockStmt).getStmt(2).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
	and target_0.getLocation().isBefore(target_1.getLocation())
	and target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation().isBefore(target_3.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getLocation())
	and target_0.getStmt().(BlockStmt).getStmt(0).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(VariableAccess).getLocation().isBefore(target_6.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getLocation()))
}

predicate func_1(Variable vi_2075, Variable voffsets_2077, ForStmt target_1) {
	target_1.getInitialization().(ExprStmt).getExpr().(CommaExpr).getLeftOperand().(AssignExpr).getLValue().(VariableAccess).getTarget()=vi_2075
	and target_1.getInitialization().(ExprStmt).getExpr().(CommaExpr).getLeftOperand().(AssignExpr).getRValue().(Literal).getValue()="0"
	and target_1.getInitialization().(ExprStmt).getExpr().(CommaExpr).getRightOperand().(AssignExpr).getLValue().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_1.getInitialization().(ExprStmt).getExpr().(CommaExpr).getRightOperand().(AssignExpr).getRValue().(Literal).getValue()="1"
	and target_1.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_1.getCondition().(RelationalOperation).getGreaterOperand().(Literal).getValue()="4"
	and target_1.getUpdate().(CommaExpr).getLeftOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_1.getUpdate().(CommaExpr).getRightOperand().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vi_2075
	and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(RelationalOperation).getGreaterOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_2075
	and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getCondition().(RelationalOperation).getLesserOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget().getType().hasName("unsigned int")
	and target_1.getStmt().(BlockStmt).getStmt(3).(IfStmt).getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
}

predicate func_2(Parameter vtotal_2072, LogicalOrExpr target_2) {
	target_2.getLeftOperand().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vtotal_2072
	and target_2.getLeftOperand().(RelationalOperation).getGreaterOperand().(SizeofExprOperator).getValue()="112"
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getTarget().getName()="next_offset"
	and target_2.getRightOperand().(RelationalOperation).getLesserOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget().getType().hasName("ebt_entry *")
	and target_2.getRightOperand().(RelationalOperation).getGreaterOperand().(SizeofExprOperator).getValue()="112"
}

predicate func_3(Parameter vtotal_2072, NotExpr target_3) {
	target_3.getOperand().(NotExpr).getOperand().(RelationalOperation).getLesserOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vtotal_2072
	and target_3.getOperand().(NotExpr).getOperand().(RelationalOperation).getGreaterOperand().(VariableAccess).getTarget().getType().hasName("unsigned int")
}

predicate func_6(Variable vi_2075, Variable voffsets_2077, PointerArithmeticOperation target_6) {
	target_6.getLeftOperand().(VariableAccess).getTarget().getType().hasName("char *")
	and target_6.getRightOperand().(ArrayExpr).getArrayBase().(VariableAccess).getTarget()=voffsets_2077
	and target_6.getRightOperand().(ArrayExpr).getArrayOffset().(VariableAccess).getTarget()=vi_2075
}

from Function func, Parameter vtotal_2072, Variable vi_2075, Variable voffsets_2077, ForStmt target_1, LogicalOrExpr target_2, NotExpr target_3, PointerArithmeticOperation target_6
where
not func_0(vtotal_2072, vi_2075, voffsets_2077, target_1, target_2, target_3, target_6, func)
and func_1(vi_2075, voffsets_2077, target_1)
and func_2(vtotal_2072, target_2)
and func_3(vtotal_2072, target_3)
and func_6(vi_2075, voffsets_2077, target_6)
and vtotal_2072.getType().hasName("unsigned int *")
and vi_2075.getType().hasName("unsigned int")
and voffsets_2077.getType().hasName("unsigned int[4]")
and vtotal_2072.getFunction() = func
and vi_2075.(LocalVariable).getFunction() = func
and voffsets_2077.(LocalVariable).getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
