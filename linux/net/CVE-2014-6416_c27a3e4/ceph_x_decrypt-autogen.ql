/**
 * @name linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-ceph_x_decrypt
 * @id cpp/linux/c27a3e4d667fdcad3db7b104f75659478e0c68d8/ceph-x-decrypt
 * @description linux-c27a3e4d667fdcad3db7b104f75659478e0c68d8-net/ceph/auth_x.c-ceph_x_decrypt CVE-2014-6416
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vhead_len_70, VariableAccess target_0) {
		target_0.getTarget()=vhead_len_70
		and target_0.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_1(Function func, Initializer target_1) {
		target_1.getExpr() instanceof SizeofExprOperator
		and target_1.getExpr().getEnclosingFunction() = func
}

/*predicate func_2(Variable vlen_71, VariableAccess target_2) {
		target_2.getTarget()=vlen_71
}

*/
predicate func_3(Parameter vend_67, Variable vlen_71, ReturnStmt target_36, VariableAccess target_3) {
		target_3.getTarget()=vend_67
		and vend_67.getIndex() = 2
		and target_3.getParent().(GTExpr).getGreaterOperand().(PointerArithmeticOperation).getAnOperand() instanceof PointerDereferenceExpr
		and target_3.getParent().(GTExpr).getGreaterOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vlen_71
		and target_3.getParent().(GTExpr).getParent().(IfStmt).getThen()=target_36
}

predicate func_5(Variable vdescriptor_77, Variable vlen_71, FunctionCall target_5) {
		target_5.getTarget().hasName("__dynamic_pr_debug")
		and not target_5.getTarget().hasName("ceph_encrypt2")
		and target_5.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vdescriptor_77
		and target_5.getArgument(1).(StringLiteral).getValue()="libceph: %.*s %12.12s:%-4d : ceph_x_decrypt len %d\n"
		and target_5.getArgument(2).(SubExpr).getValue()="0"
		and target_5.getArgument(3).(StringLiteral).getValue()="    "
		and target_5.getArgument(4).(FunctionCall).getTarget().hasName("ceph_file_part")
		and target_5.getArgument(4).(FunctionCall).getArgument(0) instanceof StringLiteral
		and target_5.getArgument(4).(FunctionCall).getArgument(1) instanceof SizeofExprOperator
		and target_5.getArgument(5) instanceof Literal
		and target_5.getArgument(6).(VariableAccess).getTarget()=vlen_71
}

predicate func_7(Parameter volen_67, AddressOfExpr target_37) {
	exists(SubExpr target_7 |
		target_7.getLeftOperand().(VariableAccess).getTarget()=volen_67
		and target_7.getRightOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_7.getRightOperand().(SizeofTypeOperator).getValue()="4"
		and target_37.getOperand().(VariableAccess).getLocation().isBefore(target_7.getLeftOperand().(VariableAccess).getLocation()))
}

predicate func_8(Function func) {
	exists(SizeofTypeOperator target_8 |
		target_8.getType() instanceof LongType
		and target_8.getValue()="4"
		and target_8.getEnclosingFunction() = func)
}

predicate func_9(Parameter vobuf_67, Variable vlen_71, ExprStmt target_32) {
	exists(FunctionCall target_9 |
		target_9.getTarget().hasName("ceph_encode_32")
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vobuf_67
		and target_9.getArgument(1).(VariableAccess).getTarget()=vlen_71
		and target_9.getArgument(0).(AddressOfExpr).getOperand().(VariableAccess).getLocation().isBefore(target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getLocation()))
}

predicate func_10(Variable vlen_71, RelationalOperation target_39) {
	exists(AddExpr target_10 |
		target_10.getAnOperand().(VariableAccess).getTarget()=vlen_71
		and target_10.getAnOperand().(SizeofTypeOperator).getType() instanceof LongType
		and target_10.getAnOperand().(SizeofTypeOperator).getValue()="4"
		and target_39.getGreaterOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getLocation().isBefore(target_10.getAnOperand().(VariableAccess).getLocation()))
}

predicate func_11(Function func, SizeofExprOperator target_11) {
		target_11.getValue()="9"
		and target_11.getEnclosingFunction() = func
}

predicate func_12(Variable vhead_69, AddressOfExpr target_12) {
		target_12.getOperand().(VariableAccess).getTarget()=vhead_69
		and target_12.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_13(Variable vret_71, VariableAccess target_13) {
		target_13.getTarget()=vret_71
		and target_13.getParent().(AssignExpr).getLValue() = target_13
		and target_13.getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_14(Parameter vsecret_66, VariableAccess target_14) {
		target_14.getTarget()=vsecret_66
		and target_14.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_15(Parameter vobuf_67, VariableAccess target_15) {
		target_15.getTarget()=vobuf_67
		and target_15.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

predicate func_17(Parameter volen_67, VariableAccess target_17) {
		target_17.getTarget()=volen_67
}

predicate func_19(Variable vlen_71, Parameter vp_67, VariableAccess target_19) {
		target_19.getTarget()=vlen_71
		and target_19.getParent().(AssignExpr).getLValue() = target_19
		and target_19.getParent().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_decode_32")
		and target_19.getParent().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vp_67
}

/*predicate func_20(Variable vlen_71, Parameter vp_67, FunctionCall target_20) {
		target_20.getTarget().hasName("ceph_decode_32")
		and target_20.getArgument(0).(VariableAccess).getTarget()=vp_67
		and target_20.getParent().(AssignExpr).getRValue() = target_20
		and target_20.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vlen_71
}

*/
predicate func_21(Parameter vend_67, Variable vlen_71, Parameter vp_67, Function func, IfStmt target_21) {
		target_21.getCondition().(RelationalOperation).getGreaterOperand().(PointerArithmeticOperation).getAnOperand().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vp_67
		and target_21.getCondition().(RelationalOperation).getGreaterOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vlen_71
		and target_21.getCondition().(RelationalOperation).getLesserOperand().(VariableAccess).getTarget()=vend_67
		and target_21.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-22"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_21
}

/*predicate func_22(Parameter vp_67, PointerDereferenceExpr target_41, PointerDereferenceExpr target_22) {
		target_22.getOperand().(VariableAccess).getTarget()=vp_67
		and target_22.getOperand().(VariableAccess).getLocation().isBefore(target_41.getOperand().(VariableAccess).getLocation())
}

*/
/*predicate func_23(Function func, UnaryMinusExpr target_23) {
		target_23.getValue()="-22"
		and target_23.getEnclosingFunction() = func
}

*/
predicate func_24(Function func, DoStmt target_24) {
		target_24.getCondition() instanceof Literal
		and target_24.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_24.getStmt().(BlockStmt).getStmt(1).(IfStmt).getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_24.getStmt().(BlockStmt).getStmt(1).(IfStmt).getThen().(ExprStmt).getExpr() instanceof FunctionCall
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_24
}

/*predicate func_28(Variable vdescriptor_77, IfStmt target_28) {
		target_28.getCondition().(FunctionCall).getTarget().hasName("__builtin_expect")
		and target_28.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getTarget().getName()="flags"
		and target_28.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(BitwiseAndExpr).getLeftOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vdescriptor_77
		and target_28.getCondition().(FunctionCall).getArgument(0).(NotExpr).getOperand().(NotExpr).getOperand().(BitwiseAndExpr).getRightOperand().(BinaryBitwiseOperation).getValue()="1"
		and target_28.getCondition().(FunctionCall).getArgument(1) instanceof Literal
		and target_28.getThen().(ExprStmt).getExpr() instanceof FunctionCall
}

*/
predicate func_29(Variable vdescriptor_77, VariableAccess target_29) {
		target_29.getTarget()=vdescriptor_77
		and target_29.getParent().(AddressOfExpr).getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_30(Function func, SizeofExprOperator target_30) {
		target_30.getValue()="8"
		and target_30.getEnclosingFunction() = func
}

predicate func_31(Function func, SizeofExprOperator target_31) {
		target_31.getValue()="18"
		and target_31.getEnclosingFunction() = func
}

predicate func_32(Parameter vobuf_67, Parameter volen_67, Variable vhead_len_70, Variable vlen_71, Variable vret_71, Parameter vp_67, Parameter vsecret_66, Function func, ExprStmt target_32) {
		target_32.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vret_71
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("ceph_decrypt2")
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vsecret_66
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(1) instanceof AddressOfExpr
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(2).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=vhead_len_70
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(3).(VariableAccess).getTarget()=vobuf_67
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(4).(AddressOfExpr).getOperand().(VariableAccess).getTarget()=volen_67
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(5).(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vp_67
		and target_32.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(6).(VariableAccess).getTarget()=vlen_71
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_32
}

predicate func_33(Variable vhead_69, Function func, IfStmt target_33) {
		target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getTarget().getName()="struct_v"
		and target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vhead_69
		and target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(Literal).getValue()="1"
		and target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getTarget().getName()="magic"
		and target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget()=vhead_69
		and target_33.getCondition().(LogicalOrExpr).getAnOperand().(EqualityOperation).getAnOperand() instanceof Literal
		and target_33.getThen().(ReturnStmt).getExpr().(UnaryMinusExpr).getValue()="-1"
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_33
}

predicate func_34(Variable vlen_71, Parameter vp_67, Function func, ExprStmt target_34) {
		target_34.getExpr().(AssignPointerAddExpr).getLValue().(PointerDereferenceExpr).getOperand().(VariableAccess).getTarget()=vp_67
		and target_34.getExpr().(AssignPointerAddExpr).getRValue().(VariableAccess).getTarget()=vlen_71
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_34
}

predicate func_35(Parameter volen_67, Function func, ReturnStmt target_35) {
		target_35.getExpr().(VariableAccess).getTarget()=volen_67
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_35
}

predicate func_36(Function func, ReturnStmt target_36) {
		target_36.getExpr() instanceof UnaryMinusExpr
		and target_36.getEnclosingFunction() = func
}

predicate func_37(Parameter volen_67, AddressOfExpr target_37) {
		target_37.getOperand().(VariableAccess).getTarget()=volen_67
}

predicate func_39(Parameter vend_67, Variable vlen_71, RelationalOperation target_39) {
		 (target_39 instanceof GTExpr or target_39 instanceof LTExpr)
		and target_39.getGreaterOperand().(PointerArithmeticOperation).getAnOperand() instanceof PointerDereferenceExpr
		and target_39.getGreaterOperand().(PointerArithmeticOperation).getAnOperand().(VariableAccess).getTarget()=vlen_71
		and target_39.getLesserOperand().(VariableAccess).getTarget()=vend_67
}

predicate func_41(Parameter vp_67, PointerDereferenceExpr target_41) {
		target_41.getOperand().(VariableAccess).getTarget()=vp_67
		and target_41.getParent().(FunctionCall).getParent().(AssignExpr).getRValue() instanceof FunctionCall
}

from Function func, Variable vdescriptor_77, Parameter vend_67, Parameter vobuf_67, Parameter volen_67, Variable vhead_69, Variable vhead_len_70, Variable vlen_71, Variable vret_71, Parameter vp_67, Parameter vsecret_66, VariableAccess target_0, Initializer target_1, VariableAccess target_3, FunctionCall target_5, SizeofExprOperator target_11, AddressOfExpr target_12, VariableAccess target_13, VariableAccess target_14, VariableAccess target_15, VariableAccess target_17, VariableAccess target_19, IfStmt target_21, DoStmt target_24, VariableAccess target_29, SizeofExprOperator target_30, SizeofExprOperator target_31, ExprStmt target_32, IfStmt target_33, ExprStmt target_34, ReturnStmt target_35, ReturnStmt target_36, AddressOfExpr target_37, RelationalOperation target_39, PointerDereferenceExpr target_41
where
func_0(vhead_len_70, target_0)
and func_1(func, target_1)
and func_3(vend_67, vlen_71, target_36, target_3)
and func_5(vdescriptor_77, vlen_71, target_5)
and not func_7(volen_67, target_37)
and not func_8(func)
and not func_9(vobuf_67, vlen_71, target_32)
and not func_10(vlen_71, target_39)
and func_11(func, target_11)
and func_12(vhead_69, target_12)
and func_13(vret_71, target_13)
and func_14(vsecret_66, target_14)
and func_15(vobuf_67, target_15)
and func_17(volen_67, target_17)
and func_19(vlen_71, vp_67, target_19)
and func_21(vend_67, vlen_71, vp_67, func, target_21)
and func_24(func, target_24)
and func_29(vdescriptor_77, target_29)
and func_30(func, target_30)
and func_31(func, target_31)
and func_32(vobuf_67, volen_67, vhead_len_70, vlen_71, vret_71, vp_67, vsecret_66, func, target_32)
and func_33(vhead_69, func, target_33)
and func_34(vlen_71, vp_67, func, target_34)
and func_35(volen_67, func, target_35)
and func_36(func, target_36)
and func_37(volen_67, target_37)
and func_39(vend_67, vlen_71, target_39)
and func_41(vp_67, target_41)
and vdescriptor_77.getType().hasName("_ddebug")
and vend_67.getType().hasName("void *")
and vobuf_67.getType().hasName("void *")
and volen_67.getType().hasName("size_t")
and vhead_69.getType().hasName("ceph_x_encrypt_header")
and vhead_len_70.getType().hasName("size_t")
and vlen_71.getType().hasName("int")
and vret_71.getType().hasName("int")
and vp_67.getType().hasName("void **")
and vsecret_66.getType().hasName("ceph_crypto_key *")
and vdescriptor_77.(LocalVariable).getFunction() = func
and vend_67.getFunction() = func
and vobuf_67.getFunction() = func
and volen_67.getFunction() = func
and vhead_69.(LocalVariable).getFunction() = func
and vhead_len_70.(LocalVariable).getFunction() = func
and vlen_71.(LocalVariable).getFunction() = func
and vret_71.(LocalVariable).getFunction() = func
and vp_67.getFunction() = func
and vsecret_66.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
