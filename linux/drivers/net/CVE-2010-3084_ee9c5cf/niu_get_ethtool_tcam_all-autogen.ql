/**
 * @name linux-ee9c5cfad29c8a13199962614b9b16f1c4137ac9-niu_get_ethtool_tcam_all
 * @id cpp/linux/ee9c5cfad29c8a13199962614b9b16f1c4137ac9/niu-get-ethtool-tcam-all
 * @description linux-ee9c5cfad29c8a13199962614b9b16f1c4137ac9-drivers/net/niu.c-niu_get_ethtool_tcam_all CVE-2010-3084
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vcnt_7274, VariableAccess target_0) {
		target_0.getTarget()=vcnt_7274
		and target_0.getParent().(FunctionCall).getParent().(ExprStmt).getExpr() instanceof FunctionCall
}

predicate func_2(Variable vcnt_7274, Parameter vnfc_7269, BlockStmt target_12, ExprStmt target_13, ExprStmt target_15, RelationalOperation target_16) {
	exists(EqualityOperation target_2 |
		target_2.getAnOperand().(VariableAccess).getTarget()=vcnt_7274
		and target_2.getAnOperand().(PointerFieldAccess).getTarget().getName()="rule_cnt"
		and target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnfc_7269
		and target_2.getParent().(IfStmt).getThen()=target_12
		and target_13.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getLocation().isBefore(target_2.getAnOperand().(VariableAccess).getLocation())
		and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation())
		and target_2.getAnOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation().isBefore(target_16.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getLocation()))
}

predicate func_3(Function func) {
	exists(AssignExpr target_3 |
		target_3.getLValue().(VariableAccess).getType().hasName("int")
		and target_3.getRValue().(UnaryMinusExpr).getValue()="-90"
		and target_3.getEnclosingFunction() = func)
}

predicate func_4(EqualityOperation target_10, Function func) {
	exists(BreakStmt target_4 |
		target_4.getParent().(BlockStmt).getParent().(IfStmt).getThen().(BlockStmt).getStmt(1)=target_4
		and target_4.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_10
		and target_4.getEnclosingFunction() = func)
}

predicate func_5(Variable vn_entries_7275, Parameter vnfc_7269, PointerFieldAccess target_5) {
		target_5.getTarget().getName()="rule_cnt"
		and target_5.getQualifier().(VariableAccess).getTarget()=vnfc_7269
		and target_5.getParent().(AssignExpr).getRValue() = target_5
		and target_5.getParent().(AssignExpr).getLValue().(VariableAccess).getTarget()=vn_entries_7275
}

predicate func_7(Variable vn_entries_7275, Variable vcnt_7274, BlockStmt target_12, VariableAccess target_7) {
		target_7.getTarget()=vcnt_7274
		and target_7.getParent().(NEExpr).getAnOperand().(VariableAccess).getTarget()=vn_entries_7275
		and target_7.getParent().(NEExpr).getParent().(IfStmt).getThen()=target_12
}

predicate func_9(Variable vn_entries_7275, Parameter vnfc_7269, Function func, ExprStmt target_9) {
		target_9.getExpr().(AssignExpr).getLValue().(VariableAccess).getTarget()=vn_entries_7275
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getTarget().getName()="rule_cnt"
		and target_9.getExpr().(AssignExpr).getRValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnfc_7269
		and func.getEntryPoint().(BlockStmt).getAStmt()=target_9
}

predicate func_10(Variable vn_entries_7275, Variable vcnt_7274, BlockStmt target_12, EqualityOperation target_10) {
		target_10.getAnOperand().(VariableAccess).getTarget()=vn_entries_7275
		and target_10.getAnOperand().(VariableAccess).getTarget()=vcnt_7274
		and target_10.getParent().(IfStmt).getThen()=target_12
}

predicate func_11(Variable vn_entries_7275, Variable v__func__, Variable vcnt_7274, Parameter vnp_7268, FunctionCall target_11) {
		target_11.getTarget().hasName("netdev_info")
		and target_11.getArgument(0).(PointerFieldAccess).getTarget().getName()="dev"
		and target_11.getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_7268
		and target_11.getArgument(1).(StringLiteral).getValue()="niu%d: In %s(): n_entries[%d] != cnt[%d]!!!\n"
		and target_11.getArgument(2).(PointerFieldAccess).getTarget().getName()="index"
		and target_11.getArgument(2).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getTarget().getName()="parent"
		and target_11.getArgument(2).(PointerFieldAccess).getQualifier().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnp_7268
		and target_11.getArgument(3).(VariableAccess).getTarget()=v__func__
		and target_11.getArgument(4).(VariableAccess).getTarget()=vn_entries_7275
		and target_11.getArgument(5).(VariableAccess).getTarget()=vcnt_7274
}

predicate func_12(Function func, BlockStmt target_12) {
		target_12.getStmt(0).(ExprStmt).getExpr() instanceof FunctionCall
		and target_12.getEnclosingFunction() = func
}

predicate func_13(Variable vcnt_7274, ExprStmt target_13) {
		target_13.getExpr().(PostfixIncrExpr).getOperand().(VariableAccess).getTarget()=vcnt_7274
}

predicate func_15(Parameter vnfc_7269, Parameter vnp_7268, ExprStmt target_15) {
		target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getTarget().getName()="data"
		and target_15.getExpr().(AssignExpr).getLValue().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnfc_7269
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getTarget().hasName("tcam_get_size")
		and target_15.getExpr().(AssignExpr).getRValue().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vnp_7268
}

predicate func_16(Parameter vnfc_7269, RelationalOperation target_16) {
		 (target_16 instanceof GTExpr or target_16 instanceof LTExpr)
		and target_16.getLesserOperand().(VariableAccess).getTarget().getType().hasName("int")
		and target_16.getGreaterOperand().(PointerFieldAccess).getTarget().getName()="data"
		and target_16.getGreaterOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vnfc_7269
}

from Function func, Variable vn_entries_7275, Variable v__func__, Variable vcnt_7274, Parameter vnfc_7269, Parameter vnp_7268, VariableAccess target_0, PointerFieldAccess target_5, VariableAccess target_7, ExprStmt target_9, EqualityOperation target_10, FunctionCall target_11, BlockStmt target_12, ExprStmt target_13, ExprStmt target_15, RelationalOperation target_16
where
func_0(vcnt_7274, target_0)
and not func_2(vcnt_7274, vnfc_7269, target_12, target_13, target_15, target_16)
and not func_3(func)
and not func_4(target_10, func)
and func_5(vn_entries_7275, vnfc_7269, target_5)
and func_7(vn_entries_7275, vcnt_7274, target_12, target_7)
and func_9(vn_entries_7275, vnfc_7269, func, target_9)
and func_10(vn_entries_7275, vcnt_7274, target_12, target_10)
and func_11(vn_entries_7275, v__func__, vcnt_7274, vnp_7268, target_11)
and func_12(func, target_12)
and func_13(vcnt_7274, target_13)
and func_15(vnfc_7269, vnp_7268, target_15)
and func_16(vnfc_7269, target_16)
and vn_entries_7275.getType().hasName("u16")
and v__func__.getType() instanceof ArrayType
and vcnt_7274.getType().hasName("int")
and vnfc_7269.getType().hasName("ethtool_rxnfc *")
and vnp_7268.getType().hasName("niu *")
and vn_entries_7275.(LocalVariable).getFunction() = func
and not v__func__.getParentScope+() = func
and vcnt_7274.(LocalVariable).getFunction() = func
and vnfc_7269.getFunction() = func
and vnp_7268.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
