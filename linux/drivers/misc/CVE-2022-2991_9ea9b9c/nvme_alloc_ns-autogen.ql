/**
 * @name linux-9ea9b9c48387edc101d56349492ad9c0492ff78d-nvme_alloc_ns
 * @id cpp/linux/9ea9b9c48387edc101d56349492ad9c0492ff78d/nvme-alloc-ns
 * @description linux-9ea9b9c48387edc101d56349492ad9c0492ff78d-drivers/nvme/host/core.c-nvme_alloc_ns CVE-2022-2991
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vns_3720, Variable vdisk_3721, Variable vid_3722, Variable vnode_3723, Parameter vctrl_3717, Function func, IfStmt target_0) {
	target_0.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getTarget().getName()="quirks"
	and target_0.getCondition().(LogicalAndExpr).getLeftOperand().(BitwiseAndExpr).getLeftOperand().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctrl_3717
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getTarget().getName()="vs"
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ArrayExpr).getArrayBase().(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vid_3722
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getLeftOperand().(ArrayExpr).getArrayOffset().(Literal).getValue()="0"
	and target_0.getCondition().(LogicalAndExpr).getRightOperand().(EqualityOperation).getRightOperand().(HexLiteral).getValue()="1"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getTarget().hasName("nvme_nvm_register")
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vns_3720
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="disk_name"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdisk_3721
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getCondition().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vnode_3723
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_warn")
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="device"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="LightNVM init failure\n"
	and target_0.getThen().(BlockStmt).getStmt(0).(IfStmt).getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out_put_disk"
	and func.getEntryPoint().(BlockStmt).getAStmt()=target_0
}

/*predicate func_1(Variable vns_3720, Variable vdisk_3721, Variable vnode_3723, Parameter vctrl_3717, LogicalAndExpr target_4, IfStmt target_1) {
	target_1.getCondition().(FunctionCall).getTarget().hasName("nvme_nvm_register")
	and target_1.getCondition().(FunctionCall).getArgument(0).(VariableAccess).getTarget()=vns_3720
	and target_1.getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getTarget().getName()="disk_name"
	and target_1.getCondition().(FunctionCall).getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdisk_3721
	and target_1.getCondition().(FunctionCall).getArgument(2).(VariableAccess).getTarget()=vnode_3723
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getTarget().hasName("_dev_warn")
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="device"
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctrl_3717
	and target_1.getThen().(BlockStmt).getStmt(0).(ExprStmt).getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="LightNVM init failure\n"
	and target_1.getThen().(BlockStmt).getStmt(1).(GotoStmt).getName() ="out_put_disk"
	and target_1.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_4
}

*/
/*predicate func_2(Parameter vctrl_3717, FunctionCall target_5, ExprStmt target_2) {
	target_2.getExpr().(FunctionCall).getTarget().hasName("_dev_warn")
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getTarget().getName()="device"
	and target_2.getExpr().(FunctionCall).getArgument(0).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vctrl_3717
	and target_2.getExpr().(FunctionCall).getArgument(1).(StringLiteral).getValue()="LightNVM init failure\n"
	and target_2.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
}

*/
/*predicate func_3(FunctionCall target_5, Function func, GotoStmt target_3) {
	target_3.getName() ="out_put_disk"
	and target_3.getParent().(BlockStmt).getParent().(IfStmt).getCondition()=target_5
	and target_3.getEnclosingFunction() = func
}

*/
predicate func_4(Function func, LogicalAndExpr target_4) {
	target_4.getLeftOperand() instanceof BitwiseAndExpr
	and target_4.getRightOperand() instanceof EqualityOperation
	and target_4.getEnclosingFunction() = func
}

predicate func_5(Variable vns_3720, Variable vdisk_3721, Variable vnode_3723, FunctionCall target_5) {
	target_5.getTarget().hasName("nvme_nvm_register")
	and target_5.getArgument(0).(VariableAccess).getTarget()=vns_3720
	and target_5.getArgument(1).(PointerFieldAccess).getTarget().getName()="disk_name"
	and target_5.getArgument(1).(PointerFieldAccess).getQualifier().(VariableAccess).getTarget()=vdisk_3721
	and target_5.getArgument(2).(VariableAccess).getTarget()=vnode_3723
}

from Function func, Variable vns_3720, Variable vdisk_3721, Variable vid_3722, Variable vnode_3723, Parameter vctrl_3717, IfStmt target_0, LogicalAndExpr target_4, FunctionCall target_5
where
func_0(vns_3720, vdisk_3721, vid_3722, vnode_3723, vctrl_3717, func, target_0)
and func_4(func, target_4)
and func_5(vns_3720, vdisk_3721, vnode_3723, target_5)
and vns_3720.getType().hasName("nvme_ns *")
and vdisk_3721.getType().hasName("gendisk *")
and vid_3722.getType().hasName("nvme_id_ns *")
and vnode_3723.getType().hasName("int")
and vctrl_3717.getType().hasName("nvme_ctrl *")
and vns_3720.(LocalVariable).getFunction() = func
and vdisk_3721.(LocalVariable).getFunction() = func
and vid_3722.(LocalVariable).getFunction() = func
and vnode_3723.(LocalVariable).getFunction() = func
and vctrl_3717.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
