/**
 * @name linux-bb50a4e711ff95348ad53641acb1306d89eb4c3a-ath12k_qmi_m3_load
 * @id cpp/linux/bb50a4e711ff95348ad53641acb1306d89eb4c3a/ath12k-qmi-m3-load
 * @description linux-bb50a4e711ff95348ad53641acb1306d89eb4c3a-drivers/net/wireless/ath/ath12k/qmi.c-ath12k_qmi_m3_load CVE-2024-40979
 * @kind problem
 * @problem.severity error
 * @tags security
 */

import cpp

predicate func_0(Variable vfw_2672, Variable vm3_data_2673, Variable vpath_2674, Variable vm3_len_2675, Variable vret_2676, Parameter vab_2669, IfStmt target_3, IfStmt target_0) {
	exists(LogicalAndExpr obj_0 | obj_0=target_0.getCondition() |
		exists(ValueFieldAccess obj_1 | obj_1=obj_0.getLeftOperand() |
			exists(PointerFieldAccess obj_2 | obj_2=obj_1.getQualifier() |
				obj_2.getTarget().getName()="fw"
				and obj_2.getQualifier().(VariableAccess).getTarget()=vab_2669
			)
			and obj_1.getTarget().getName()="m3_data"
		)
		and exists(RelationalOperation obj_3 | obj_3=obj_0.getRightOperand() |
			exists(ValueFieldAccess obj_4 | obj_4=obj_3.getGreaterOperand() |
				exists(PointerFieldAccess obj_5 | obj_5=obj_4.getQualifier() |
					obj_5.getTarget().getName()="fw"
					and obj_5.getQualifier().(VariableAccess).getTarget()=vab_2669
				)
				and obj_4.getTarget().getName()="m3_len"
			)
			and obj_3.getLesserOperand().(Literal).getValue()="0"
		)
	)
	and exists(BlockStmt obj_6 | obj_6=target_0.getThen() |
		exists(ExprStmt obj_7 | obj_7=obj_6.getStmt(0) |
			exists(AssignExpr obj_8 | obj_8=obj_7.getExpr() |
				exists(ValueFieldAccess obj_9 | obj_9=obj_8.getRValue() |
					exists(PointerFieldAccess obj_10 | obj_10=obj_9.getQualifier() |
						obj_10.getTarget().getName()="fw"
						and obj_10.getQualifier().(VariableAccess).getTarget()=vab_2669
					)
					and obj_9.getTarget().getName()="m3_data"
				)
				and obj_8.getLValue().(VariableAccess).getTarget()=vm3_data_2673
			)
		)
		and exists(ExprStmt obj_11 | obj_11=obj_6.getStmt(1) |
			exists(AssignExpr obj_12 | obj_12=obj_11.getExpr() |
				exists(ValueFieldAccess obj_13 | obj_13=obj_12.getRValue() |
					exists(PointerFieldAccess obj_14 | obj_14=obj_13.getQualifier() |
						obj_14.getTarget().getName()="fw"
						and obj_14.getQualifier().(VariableAccess).getTarget()=vab_2669
					)
					and obj_13.getTarget().getName()="m3_len"
				)
				and obj_12.getLValue().(VariableAccess).getTarget()=vm3_len_2675
			)
		)
	)
	and exists(BlockStmt obj_15 | obj_15=target_0.getElse() |
		exists(ExprStmt obj_16 | obj_16=obj_15.getStmt(0) |
			exists(AssignExpr obj_17 | obj_17=obj_16.getExpr() |
				exists(FunctionCall obj_18 | obj_18=obj_17.getRValue() |
					obj_18.getTarget().hasName("ath12k_core_firmware_request")
					and obj_18.getArgument(0).(VariableAccess).getTarget()=vab_2669
					and obj_18.getArgument(1).(StringLiteral).getValue()="m3.bin"
				)
				and obj_17.getLValue().(VariableAccess).getTarget()=vfw_2672
			)
		)
		and exists(IfStmt obj_19 | obj_19=obj_15.getStmt(1) |
			exists(FunctionCall obj_20 | obj_20=obj_19.getCondition() |
				obj_20.getTarget().hasName("IS_ERR")
				and obj_20.getArgument(0).(VariableAccess).getTarget()=vfw_2672
			)
			and exists(BlockStmt obj_21 | obj_21=obj_19.getThen() |
				exists(ExprStmt obj_22 | obj_22=obj_21.getStmt(0) |
					exists(AssignExpr obj_23 | obj_23=obj_22.getExpr() |
						obj_23.getLValue().(VariableAccess).getTarget()=vret_2676
						and obj_23.getRValue().(FunctionCall).getTarget().hasName("PTR_ERR")
					)
				)
				and exists(ExprStmt obj_24 | obj_24=obj_21.getStmt(1) |
					exists(FunctionCall obj_25 | obj_25=obj_24.getExpr() |
						obj_25.getTarget().hasName("ath12k_core_create_firmware_path")
						and obj_25.getArgument(0).(VariableAccess).getTarget()=vab_2669
						and obj_25.getArgument(1).(StringLiteral).getValue()="m3.bin"
						and obj_25.getArgument(2).(VariableAccess).getTarget()=vpath_2674
					)
				)
				and exists(ExprStmt obj_26 | obj_26=obj_21.getStmt(2) |
					exists(FunctionCall obj_27 | obj_27=obj_26.getExpr() |
						obj_27.getTarget().hasName("ath12k_err")
						and obj_27.getArgument(0).(VariableAccess).getTarget()=vab_2669
						and obj_27.getArgument(1).(StringLiteral).getValue()="failed to load %s: %d\n"
						and obj_27.getArgument(2).(VariableAccess).getTarget()=vpath_2674
						and obj_27.getArgument(3).(VariableAccess).getTarget()=vret_2676
					)
				)
				and obj_21.getStmt(3).(ReturnStmt).getExpr().(VariableAccess).getTarget()=vret_2676
			)
		)
		and exists(ExprStmt obj_28 | obj_28=obj_15.getStmt(2) |
			exists(AssignExpr obj_29 | obj_29=obj_28.getExpr() |
				exists(PointerFieldAccess obj_30 | obj_30=obj_29.getRValue() |
					obj_30.getTarget().getName()="data"
					and obj_30.getQualifier().(VariableAccess).getTarget()=vfw_2672
				)
				and obj_29.getLValue().(VariableAccess).getTarget()=vm3_data_2673
			)
		)
		and exists(ExprStmt obj_31 | obj_31=obj_15.getStmt(3) |
			exists(AssignExpr obj_32 | obj_32=obj_31.getExpr() |
				exists(PointerFieldAccess obj_33 | obj_33=obj_32.getRValue() |
					obj_33.getTarget().getName()="size"
					and obj_33.getQualifier().(VariableAccess).getTarget()=vfw_2672
				)
				and obj_32.getLValue().(VariableAccess).getTarget()=vm3_len_2675
			)
		)
	)
	and target_3.getLocation().isBefore(target_0.getLocation())
}

predicate func_1(PointerFieldAccess target_4, Function func) {
exists(GotoStmt target_1 |
	target_1.getName() ="skip_m3_alloc"
	and target_1.getParent().(IfStmt).getCondition()=target_4
	and target_1.getEnclosingFunction() = func
)
}

predicate func_2(PointerFieldAccess target_4, Function func, ReturnStmt target_2) {
	target_2.getExpr().(Literal).getValue()="0"
	and target_2.getParent().(IfStmt).getCondition()=target_4
	and target_2.getEnclosingFunction() = func
}

predicate func_3(Function func, IfStmt target_3) {
	exists(PointerFieldAccess obj_0 | obj_0=target_3.getCondition() |
		obj_0.getTarget().getName()="vaddr"
		and obj_0.getQualifier().(VariableAccess).getTarget().getType().hasName("m3_mem_region *")
	)
	and target_3.getThen() instanceof ReturnStmt
	and target_3.getEnclosingFunction() = func
}

predicate func_4(Function func, PointerFieldAccess target_4) {
	target_4.getTarget().getName()="vaddr"
	and target_4.getQualifier().(VariableAccess).getTarget().getType().hasName("m3_mem_region *")
	and target_4.getEnclosingFunction() = func
}

from Function func, Variable vfw_2672, Variable vm3_data_2673, Variable vpath_2674, Variable vm3_len_2675, Variable vret_2676, Parameter vab_2669, IfStmt target_0, ReturnStmt target_2, IfStmt target_3, PointerFieldAccess target_4
where
func_0(vfw_2672, vm3_data_2673, vpath_2674, vm3_len_2675, vret_2676, vab_2669, target_3, target_0)
and not func_1(target_4, func)
and func_2(target_4, func, target_2)
and func_3(func, target_3)
and func_4(func, target_4)
and vfw_2672.getType().hasName("const firmware *")
and vm3_data_2673.getType().hasName("const void *")
and vpath_2674.getType().hasName("char[100]")
and vm3_len_2675.getType().hasName("size_t")
and vret_2676.getType().hasName("int")
and vab_2669.getType().hasName("ath12k_base *")
and vfw_2672.(LocalVariable).getFunction() = func
and vm3_data_2673.(LocalVariable).getFunction() = func
and vpath_2674.(LocalVariable).getFunction() = func
and vm3_len_2675.(LocalVariable).getFunction() = func
and vret_2676.(LocalVariable).getFunction() = func
and vab_2669.getFunction() = func
select func, func.getFile().toString() + ":" + func.getLocation().getStartLine().toString()
